This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitattributes
.gitignore
components.json
eslint.config.js
index.html
jsconfig.json
package.json
postcss.config.js
README.md
src/api/base44Client.js
src/App.jsx
src/components/AsyncSelect.jsx
src/components/AutoCalculadorLiquidaciones.jsx
src/components/configuracion/ABMContent.jsx
src/components/configuracion/CategoriasEmpleadoContent.jsx
src/components/configuracion/ImportesConfigContent.jsx
src/components/configuracion/MantenimientoContent.jsx
src/components/configuracion/modals/ABMModal.jsx
src/components/configuracion/modals/CategoriaEmpleadoModal.jsx
src/components/configuracion/modals/CuentaModal.jsx
src/components/configuracion/modals/DeleteConfirmModal.jsx
src/components/configuracion/modals/EmpleadoModal.jsx
src/components/configuracion/modals/ImportBancosModal.jsx
src/components/configuracion/modals/ImporteModal.jsx
src/components/configuracion/modals/ImportModal.jsx
src/components/configuracion/modals/InvitarUsuarioModal.jsx
src/components/configuracion/modals/PermisosModal.jsx
src/components/configuracion/modals/PrecioModal.jsx
src/components/configuracion/PermisosContent.jsx
src/components/configuracion/PlanCuentasContent.jsx
src/components/configuracion/PreciosContent.jsx
src/components/configuracion/SeguridadContent.jsx
src/components/configuracion/UsuariosContent.jsx
src/components/ConfirmDetalleModal.jsx
src/components/ConfirmEnvaseModal.jsx
src/components/ConfirmPesajeModal.jsx
src/components/DetalleLineItem.jsx
src/components/EditarMovimientoModal.jsx
src/components/EditarSalidaModal.jsx
src/components/empleados/FleteroModal.jsx
src/components/empleados/LegajoEmpleadoModal.jsx
src/components/empleados/LiquidacionFleteroModal.jsx
src/components/empleados/LiquidacionSueldoModal.jsx
src/components/EnvaseLineItem.jsx
src/components/EnvaseLineItemLlenos.jsx
src/components/EnvaseLineItemSimple.jsx
src/components/ExportarExcel.jsx
src/components/GenericQuickCreateModal.jsx
src/components/GenericSuccessModal.jsx
src/components/hooks/useCorreccionAutoRetroactiva.jsx
src/components/hooks/useCorreccionCuentaCorriente.jsx
src/components/hooks/useCorreccionEnvasesRetroactiva.jsx
src/components/hooks/useCorreccionPreciosSalidas.jsx
src/components/hooks/useCorreccionSegregacionEnvases.jsx
src/components/hooks/usePaginatedQuery.jsx
src/components/hooks/usePreciosCache.jsx
src/components/inventario/AjusteManualEnvaseModal.jsx
src/components/inventario/HistorialAjustesModal.jsx
src/components/LiquidacionPDFGenerator.jsx
src/components/MovimientoEnvasesPDFGenerator.jsx
src/components/PDFGenerator.jsx
src/components/PDFGeneratorIngresoFruta.jsx
src/components/PDFGeneratorMovimientoEnvases.jsx
src/components/PesajeLineItem.jsx
src/components/PINModal.jsx
src/components/QuickCreateModal.jsx
src/components/SalidaPDFGenerator.jsx
src/components/SearchableSelect.jsx
src/components/tesoreria/CambiarEstadoChequeModal.jsx
src/components/tesoreria/CobroConSalidasModal.jsx
src/components/tesoreria/EditarFechaMovimientoModal.jsx
src/components/tesoreria/ExportarMovimientosModal.jsx
src/components/tesoreria/ExportarMovimientosPDFModal.jsx
src/components/tesoreria/ImputarPagoModal.jsx
src/components/tesoreria/MediosPagoMixtosGrid.jsx
src/components/tesoreria/MultiplesChequesGrid.jsx
src/components/tesoreria/OrdenDePagoPDF.jsx
src/components/tesoreria/PagoConIngresosModal.jsx
src/components/ui/accordion.jsx
src/components/ui/alert-dialog.jsx
src/components/ui/alert.jsx
src/components/ui/aspect-ratio.jsx
src/components/ui/avatar.jsx
src/components/ui/badge.jsx
src/components/ui/breadcrumb.jsx
src/components/ui/button.jsx
src/components/ui/calendar.jsx
src/components/ui/card.jsx
src/components/ui/carousel.jsx
src/components/ui/chart.jsx
src/components/ui/checkbox.jsx
src/components/ui/collapsible.jsx
src/components/ui/command.jsx
src/components/ui/context-menu.jsx
src/components/ui/dialog.jsx
src/components/ui/drawer.jsx
src/components/ui/dropdown-menu.jsx
src/components/ui/form.jsx
src/components/ui/hover-card.jsx
src/components/ui/input-otp.jsx
src/components/ui/input.jsx
src/components/ui/label.jsx
src/components/ui/menubar.jsx
src/components/ui/navigation-menu.jsx
src/components/ui/pagination.jsx
src/components/ui/popover.jsx
src/components/ui/progress.jsx
src/components/ui/radio-group.jsx
src/components/ui/resizable.jsx
src/components/ui/scroll-area.jsx
src/components/ui/select.jsx
src/components/ui/separator.jsx
src/components/ui/sheet.jsx
src/components/ui/sidebar.jsx
src/components/ui/skeleton.jsx
src/components/ui/slider.jsx
src/components/ui/sonner.jsx
src/components/ui/switch.jsx
src/components/ui/table.jsx
src/components/ui/tabs.jsx
src/components/ui/textarea.jsx
src/components/ui/toast.jsx
src/components/ui/toaster.jsx
src/components/ui/toggle-group.jsx
src/components/ui/toggle.jsx
src/components/ui/tooltip.jsx
src/components/ui/use-toast.jsx
src/components/UserNotRegisteredError.jsx
src/components/utils/correccionRetroactivaEnvases.jsx
src/components/utils/correccionRetroactivaPerdidas.jsx
src/components/utils/precisionDecimal.jsx
src/components/ValidadorCambioPrecios.jsx
src/hooks/use-mobile.jsx
src/index.css
src/Layout.jsx
src/lib/app-params.js
src/lib/AuthContext.jsx
src/lib/NavigationTracker.jsx
src/lib/PageNotFound.jsx
src/lib/query-client.js
src/lib/utils.js
src/main.jsx
src/pages.config.js
src/pages/Bancos.jsx
src/pages/Cajas.jsx
src/pages/Cheques.jsx
src/pages/Cobros.jsx
src/pages/ConfiguracionUnificada.jsx
src/pages/ConfirmarSalida.jsx
src/pages/CuentaCorriente.jsx
src/pages/Egresos.jsx
src/pages/Empleados.jsx
src/pages/Historial.jsx
src/pages/Home.jsx
src/pages/Informes.jsx
src/pages/InformesContables.jsx
src/pages/IngresoFruta.jsx
src/pages/IngresosVarios.jsx
src/pages/Inventario.jsx
src/pages/MovimientoEnvases.jsx
src/pages/MovimientoFruta.jsx
src/pages/MovimientosTesoreria.jsx
src/pages/Pagos.jsx
src/pages/Perdidas.jsx
src/pages/SaldosEnvases.jsx
src/pages/SalidaFruta.jsx
src/pages/Tesoreria.jsx
src/services/CuentaCorrienteService.js
src/services/StockService.js
src/utils/contabilidad.js
src/utils/ejecutarCorreccionManual.js
src/utils/extraerMensajeError.js
src/utils/index.js
src/utils/index.ts
src/utils/parseCSV.js
src/utils/pdfStyles.js
src/utils/precioVigente.js
src/utils/queryHelpers.js
tailwind.config.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitattributes">
node_modules/ export-ignore
dist/ export-ignore
.next/ export-ignore
__pycache__/ export-ignore
.cache/ export-ignore
.turbo/ export-ignore
coverage/ export-ignore
.nyc_output/ export-ignore
</file>

<file path=".gitignore">
#env
.env
.env.*

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

.env
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": false,
  "tailwind": {
    "config": "tailwind.config.js",
    "css": "src/index.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "iconLibrary": "lucide"
}
</file>

<file path="eslint.config.js">
import globals from "globals";
import pluginJs from "@eslint/js";
import pluginReact from "eslint-plugin-react";
import pluginReactHooks from "eslint-plugin-react-hooks";
import pluginUnusedImports from "eslint-plugin-unused-imports";

export default [
  {
    files: [
      "src/components/**/*.{js,mjs,cjs,jsx}",
      "src/pages/**/*.{js,mjs,cjs,jsx}",
      "src/Layout.jsx",
    ],
    ignores: ["src/lib/**/*", "src/components/ui/**/*"],
    ...pluginJs.configs.recommended,
    ...pluginReact.configs.flat.recommended,
    languageOptions: {
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 2022,
        sourceType: "module",
        ecmaFeatures: {
          jsx: true,
        },
      },
    },
    settings: {
      react: {
        version: "detect",
      },
    },
    plugins: {
      react: pluginReact,
      "react-hooks": pluginReactHooks,
      "unused-imports": pluginUnusedImports,
    },
    rules: {
      "no-unused-vars": "off",
      "react/jsx-uses-vars": "error",
      "react/jsx-uses-react": "error",
      "unused-imports/no-unused-imports": "error",
      "unused-imports/no-unused-vars": [
        "warn",
        {
          vars: "all",
          varsIgnorePattern: "^_",
          args: "after-used",
          argsIgnorePattern: "^_",
        },
      ],
      "react/prop-types": "off",
      "react/react-in-jsx-scope": "off",
      "react/no-unknown-property": [
        "error",
        { ignore: ["cmdk-input-wrapper", "toast-close"] },
      ],
      "react-hooks/rules-of-hooks": "error",
    },
  },
];
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://base44.com/logo_v2.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="/manifest.json" />
    <title>Base44 APP</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="jsconfig.json">
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "jsx": "react-jsx",
    "module": "esnext",
    "moduleResolution": "bundler",
    "lib": ["esnext", "dom"],
    "target": "esnext",
    "checkJs": true,
    "skipLibCheck": true,
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "types": []
  },
  "include": ["src/components/**/*.js", "src/pages/**/*.jsx", "src/Layout.jsx"],
  "exclude": ["node_modules", "dist", "src/vite-plugins", "src/components/ui", "src/api", "src/lib"]
}
</file>

<file path="package.json">
{
  "name": "base44-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint . --quiet",
    "lint:fix": "eslint . --fix",
    "typecheck": "tsc -p ./jsconfig.json",
    "preview": "vite preview"
  },
  "dependencies": {
    "@base44/sdk": "^0.8.3",
    "@base44/vite-plugin": "^0.2.12",
    "@hello-pangea/dnd": "^17.0.0",
    "@hookform/resolvers": "^4.1.2",
    "@radix-ui/react-accordion": "^1.2.3",
    "@radix-ui/react-alert-dialog": "^1.1.6",
    "@radix-ui/react-aspect-ratio": "^1.1.2",
    "@radix-ui/react-avatar": "^1.1.3",
    "@radix-ui/react-checkbox": "^1.1.4",
    "@radix-ui/react-collapsible": "^1.1.3",
    "@radix-ui/react-context-menu": "^2.2.6",
    "@radix-ui/react-dialog": "^1.1.6",
    "@radix-ui/react-dropdown-menu": "^2.1.6",
    "@radix-ui/react-hover-card": "^1.1.6",
    "@radix-ui/react-label": "^2.1.2",
    "@radix-ui/react-menubar": "^1.1.6",
    "@radix-ui/react-navigation-menu": "^1.2.5",
    "@radix-ui/react-popover": "^1.1.6",
    "@radix-ui/react-progress": "^1.1.2",
    "@radix-ui/react-radio-group": "^1.2.3",
    "@radix-ui/react-scroll-area": "^1.2.3",
    "@radix-ui/react-select": "^2.1.6",
    "@radix-ui/react-separator": "^1.1.2",
    "@radix-ui/react-slider": "^1.2.3",
    "@radix-ui/react-slot": "^1.1.2",
    "@radix-ui/react-switch": "^1.1.3",
    "@radix-ui/react-tabs": "^1.1.3",
    "@radix-ui/react-toast": "^1.2.2",
    "@radix-ui/react-toggle": "^1.1.2",
    "@radix-ui/react-toggle-group": "^1.1.2",
    "@radix-ui/react-tooltip": "^1.1.8",
    "@stripe/react-stripe-js": "^3.0.0",
    "@stripe/stripe-js": "^5.2.0",
    "@tanstack/react-query": "^5.84.1",
    "canvas-confetti": "^1.9.4",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.0.0",
    "date-fns": "^3.6.0",
    "embla-carousel-react": "^8.5.2",
    "framer-motion": "^11.16.4",
    "html2canvas": "^1.4.1",
    "input-otp": "^1.4.2",
    "jspdf": "^2.5.2",
    "lodash": "^4.17.21",
    "lucide-react": "^0.475.0",
    "moment": "^2.30.1",
    "next-themes": "^0.4.4",
    "react": "^18.2.0",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.2.0",
    "react-hook-form": "^7.54.2",
    "react-hot-toast": "^2.6.0",
    "react-leaflet": "^4.2.1",
    "react-markdown": "^9.0.1",
    "react-quill": "^2.0.0",
    "react-resizable-panels": "^2.1.7",
    "react-router-dom": "^6.26.0",
    "recharts": "^2.15.4",
    "sonner": "^2.0.1",
    "tailwind-merge": "^3.0.2",
    "tailwindcss-animate": "^1.0.7",
    "three": "^0.171.0",
    "vaul": "^1.1.2",
    "zod": "^3.24.2",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@eslint/js": "^9.19.0",
    "@types/node": "^22.13.5",
    "@types/react": "^18.2.66",
    "@types/react-dom": "^18.2.22",
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "baseline-browser-mapping": "^2.8.32",
    "eslint": "^9.19.0",
    "eslint-plugin-react": "^7.37.4",
    "eslint-plugin-react-hooks": "^5.0.0",
    "eslint-plugin-react-refresh": "^0.4.18",
    "eslint-plugin-unused-imports": "^4.3.0",
    "globals": "^15.14.0",
    "postcss": "^8.5.3",
    "tailwindcss": "^3.4.17",
    "typescript": "^5.8.2",
    "vite": "^6.1.0"
  }
}
</file>

<file path="postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="README.md">
# Base44 App
## Actualizaci√≥n para forzar redespliegue - 11/02/2026
</file>

<file path="src/api/base44Client.js">
import { createClient } from '@base44/sdk';
import { appParams } from '@/lib/app-params';

const { appId, token, functionsVersion } = appParams;

//Create a client with authentication required
export const base44 = createClient({
  appId,
  token,
  functionsVersion,
  serverUrl: '',
  requiresAuth: false
});
</file>

<file path="src/App.jsx">
import { Toaster } from "@/components/ui/toaster"
import { QueryClientProvider } from '@tanstack/react-query'
import { queryClientInstance } from '@/lib/query-client'
import NavigationTracker from '@/lib/NavigationTracker'
import { pagesConfig } from './pages.config'
import { BrowserRouter as Router, Route, Routes } from 'react-router-dom';
import PageNotFound from './lib/PageNotFound';
import { AuthProvider, useAuth } from '@/lib/AuthContext';
import UserNotRegisteredError from '@/components/UserNotRegisteredError';
import Layout from './Layout';

const { Pages, mainPage } = pagesConfig;
const mainPageKey = mainPage ?? Object.keys(Pages)[0];
const MainPage = mainPageKey ? Pages[mainPageKey] : <></>;

const LayoutWrapper = ({ children, currentPageName }) => 
  <Layout currentPageName={currentPageName}>{children}</Layout>;

const AuthenticatedApp = () => {
  const { isLoadingAuth, isLoadingPublicSettings, authError, navigateToLogin } = useAuth();

  // Show loading spinner while checking app public settings or auth
  if (isLoadingPublicSettings || isLoadingAuth) {
    return (
      <div className="fixed inset-0 flex items-center justify-center">
        <div className="w-8 h-8 border-4 border-slate-200 border-t-slate-800 rounded-full animate-spin"></div>
      </div>
    );
  }

  // Handle authentication errors
  if (authError) {
    if (authError.type === 'user_not_registered') {
      return <UserNotRegisteredError />;
    } else if (authError.type === 'auth_required') {
      // Redirect to login automatically
      navigateToLogin();
      return null;
    }
  }

  // Render the main app
  return (
    <Routes>
      <Route path="/" element={
        <LayoutWrapper currentPageName={mainPageKey}>
          <MainPage />
        </LayoutWrapper>
      } />
      {Object.entries(Pages).map(([path, Page]) => (
        <Route
          key={path}
          path={`/${path}`}
          element={
            <LayoutWrapper currentPageName={path}>
              <Page />
            </LayoutWrapper>
          }
        />
      ))}
      <Route path="*" element={<PageNotFound />} />
    </Routes>
  );
};


function App() {

  return (
    <AuthProvider>
      <QueryClientProvider client={queryClientInstance}>
        <Router>
          <NavigationTracker />
          <AuthenticatedApp />
        </Router>
        <Toaster />
      </QueryClientProvider>
    </AuthProvider>
  )
}

export default App
</file>

<file path="src/components/AsyncSelect.jsx">
/**
 * Select con b√∫squeda as√≠ncrona en servidor.
 * NO carga la lista al inicio: hace .filter({ [searchField]: { $regex: term, $options: 'i' } }) mientras el usuario escribe.
 * M√°ximo 30 resultados por b√∫squeda para evitar 429.
 */
import React, { useState, useEffect, useMemo } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { escapeRegex } from '@/lib/utils';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Check, ChevronsUpDown, Plus, Search, Loader2 } from "lucide-react";
import { cn } from "@/lib/utils";

const LIMIT = 30;
const DEBOUNCE_MS = 350;

const entityConfig = {
  Cliente: { entity: 'Cliente', displayKey: 'nombre', valueKey: 'id', searchField: 'nombre', order: 'nombre' },
  Proveedor: { entity: 'Proveedor', displayKey: 'nombre', valueKey: 'id', searchField: 'nombre', order: 'nombre' },
  Producto: { entity: 'Producto', displayKey: 'nombre', valueKey: 'id', searchField: 'fruta', order: 'fruta' },
  Envase: { entity: 'Envase', displayKey: 'tipo', valueKey: 'id', searchField: 'tipo', order: 'tipo' },
  Fletero: { entity: 'Fletero', displayKey: 'nombre', valueKey: 'id', searchField: 'nombre', order: 'nombre' },
};

function buildQuery(entityKey, searchField, searchTerm) {
  const term = (searchTerm || '').trim();
  if (!term) return {};
  return { [searchField]: { $regex: escapeRegex(term), $options: 'i' } };
}

function normalizeOption(opt, entityKey) {
  if (entityKey === 'Producto' && (opt.fruta || opt.variedad)) {
    return { ...opt, nombre: `${opt.fruta || ''} - ${opt.variedad || ''}`.replace(/^ - | - $/g, '').trim() || opt.fruta || opt.variedad };
  }
  return opt;
}

export default function AsyncSelect({
  entityKey,
  value,
  onChange,
  placeholder = "Buscar...",
  displayKey: displayKeyProp,
  valueKey: valueKeyProp,
  onCreateNew,
  createNewLabel = "Crear nuevo",
  disabled = false,
  initialOption = null,
  className
}) {
  const [open, setOpen] = useState(false);
  const [search, setSearch] = useState("");
  const [debouncedSearch, setDebouncedSearch] = useState("");

  const config = entityConfig[entityKey] || { entity: entityKey, displayKey: 'nombre', valueKey: 'id', searchField: 'nombre', order: 'nombre' };
  const displayKey = displayKeyProp ?? config.displayKey;
  const valueKey = valueKeyProp ?? config.valueKey;
  const searchField = config.searchField;
  const order = config.order;
  const entityName = config.entity;

  useEffect(() => {
    const t = setTimeout(() => setDebouncedSearch(search.trim()), DEBOUNCE_MS);
    return () => clearTimeout(t);
  }, [search]);

  const query = useMemo(() => buildQuery(entityKey, searchField, debouncedSearch), [entityKey, searchField, debouncedSearch]);

  const { data: options = [], isLoading: loading } = useQuery({
    queryKey: ['async-select', entityName, debouncedSearch],
    queryFn: async () => {
      const raw = await base44.entities[entityName].filter(query, order, LIMIT, 0);
      const list = Array.isArray(raw) ? raw : [];
      return list.map(opt => normalizeOption(opt, entityKey));
    },
    enabled: open,
    staleTime: 2 * 60 * 1000,
  });

  const selectedOption = useMemo(() => {
    if (initialOption && (initialOption[valueKey] === value || initialOption.id === value)) return initialOption;
    return options.find(opt => opt[valueKey] === value || opt.id === value);
  }, [options, value, valueKey, initialOption]);

  const displayValue = selectedOption
    ? (selectedOption[displayKey] ?? selectedOption.nombre ?? selectedOption.tipo ?? String(value))
    : placeholder;

  const handleSelect = (option) => {
    const normalized = normalizeOption(option, entityKey);
    onChange(normalized[valueKey], normalized);
    setOpen(false);
    setSearch("");
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          disabled={disabled}
          className={cn("w-full justify-between font-normal", className)}
        >
          <span className={cn(!selectedOption && "text-muted-foreground")}>
            {displayValue}
          </span>
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-full p-0" align="start">
        <div className="p-2 border-b">
          <div className="flex items-center gap-2 px-2">
            <Search className="h-4 w-4 text-muted-foreground shrink-0" />
            <Input
              placeholder="Escriba para buscar..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="border-0 focus-visible:ring-0 p-0 h-8"
            />
          </div>
        </div>
        <div className="max-h-60 overflow-y-auto p-1">
          {loading ? (
            <div className="flex items-center justify-center py-6">
              <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
            </div>
          ) : options.length === 0 ? (
            <p className="text-sm text-muted-foreground text-center py-4">
              {debouncedSearch ? "No se encontraron resultados" : "Escriba para buscar"}
            </p>
          ) : (
            options.map((option) => {
              const norm = normalizeOption(option, entityKey);
              const label = norm[displayKey] ?? norm.nombre ?? norm.tipo ?? norm.id;
              const optValue = norm[valueKey] ?? norm.id;
              return (
                <button
                  key={optValue}
                  onClick={() => handleSelect(option)}
                  className={cn(
                    "w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent",
                    value === optValue && "bg-accent"
                  )}
                >
                  <Check className={cn("h-4 w-4", value === optValue ? "opacity-100" : "opacity-0")} />
                  {label}
                </button>
              );
            })
          )}
        </div>
        {onCreateNew && (
          <div className="p-2 border-t">
            <Button
              variant="ghost"
              className="w-full justify-start text-primary"
              onClick={() => {
                onCreateNew();
                setOpen(false);
              }}
            >
              <Plus className="h-4 w-4 mr-2" />
              {createNewLabel}
            </Button>
          </div>
        )}
      </PopoverContent>
    </Popover>
  );
}
</file>

<file path="src/components/AutoCalculadorLiquidaciones.jsx">
import { useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

// Hook que pre-calcula per√≠odos de liquidaci√≥n pendientes
export function useAutoCalculadorLiquidaciones() {
  const queryClient = useQueryClient();

  const { data: empleados = [] } = useQuery({
    queryKey: ['empleadosacopio_liquidador'],
    queryFn: () => base44.entities.EmpleadoAcopio.list(),
    staleTime: 10 * 60 * 1000,
  });

  const { data: liquidaciones = [] } = useQuery({
    queryKey: ['liquidaciones_calculador'],
    queryFn: () => base44.entities.LiquidacionSueldo.list('-fecha_liquidacion'),
    staleTime: 5 * 60 * 1000,
  });

  // Funci√≥n para obtener per√≠odos pendientes
  const obtenerPeriodosPendientes = () => {
    const empleadosActivos = empleados.filter(e => e.activo);
    const periodosGenerados = new Set(
      liquidaciones.map(l => `${l.empleado_id}_${l.periodo}`)
    );

    const hoy = new Date();
    const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;

    return empleadosActivos
      .filter(emp => {
        // No generar si ya existe liquidaci√≥n para este mes
        return !periodosGenerados.has(`${emp.id}_${mesActual}`);
      })
      .map(emp => ({
        empleado_id: emp.id,
        empleado_nombre: emp.nombre,
        periodo: mesActual,
        categoria: emp.categoria_empleado_nombre,
        sueldo_base: emp.sueldo_base || 0
      }));
  };

  return { 
    empleados, 
    liquidaciones, 
    periodosGenerados: obtenerPeriodosPendientes(),
    obtenerPeriodosPendientes 
  };
}
</file>

<file path="src/components/configuracion/ABMContent.jsx">
import React from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Plus, Edit, Trash2, Upload, Loader2 } from "lucide-react";

const ENTIDADES = [
  { key: 'proveedores', label: 'Proveedores', type: 'proveedor', displayKey: 'nombre' },
  { key: 'clientes', label: 'Clientes', type: 'cliente', displayKey: 'nombre' },
  { key: 'bancos', label: 'Bancos', type: 'banco', displayKey: 'nombre' },
  { key: 'envases', label: 'Envases', type: 'envase', displayKey: 'tipo' },
  { key: 'productos', label: 'Productos', type: 'producto', displayKey: 'nombre' },
  { key: 'fleteros', label: 'Fleteros', type: 'fletero', displayKey: 'nombre' }
];

export default function ABMContent({
  subTab,
  setSubTab,
  searchTerm,
  setSearchTerm,
  data,
  hasMore,
  onLoadMore,
  isLoading,
  isFetchingMore,
  displayKey = 'nombre',
  onEdit,
  onDelete,
  onImportarBancos
}) {
  const currentEntidad = ENTIDADES.find(e => e.key === subTab);
  const type = currentEntidad?.type ?? 'proveedor';
  const keyDisplay = currentEntidad?.displayKey ?? displayKey;

  return (
    <div className="flex flex-col lg:flex-row gap-6">
      <div className="lg:w-48 shrink-0">
        <div className="bg-slate-50 rounded-lg p-2 space-y-1">
          {ENTIDADES.map(ent => (
            <button
              key={ent.key}
              onClick={() => setSubTab(ent.key)}
              className={`w-full text-left px-4 py-2.5 rounded-md transition-colors text-sm ${
                subTab === ent.key
                  ? 'bg-blue-600 text-white font-medium'
                  : 'text-slate-700 hover:bg-slate-200'
              }`}
            >
              {ent.label}
            </button>
          ))}
        </div>
      </div>

      <div className="flex-1 min-w-0 space-y-2">
        <div className="flex gap-2 mb-4">
          <Button onClick={() => onEdit(type, null)}>
            <Plus className="h-4 w-4 mr-2" />
            Agregar
          </Button>
          {type === 'banco' && (
            <Button onClick={onImportarBancos} variant="outline">
              <Upload className="h-4 w-4 mr-2" />
              Importar CSV
            </Button>
          )}
          <Input
            placeholder="Buscar en servidor..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="max-w-xs"
          />
        </div>

        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-slate-400" />
          </div>
        ) : !data || data.length === 0 ? (
          <p className="text-center text-slate-500 py-8">
            {searchTerm ? 'No se encontraron resultados' : 'No hay registros'}
          </p>
        ) : (
          <>
            <div className="space-y-2">
              {data.map(item => (
                <div
                  key={item.id}
                  className="flex items-center justify-between p-3 bg-white rounded-lg border border-slate-200 hover:border-slate-300"
                >
                  <div className="flex-1">
                    <p className="font-medium text-slate-800">{item[keyDisplay]}</p>
                    {item.direccion && <p className="text-sm text-slate-600">{item.direccion}</p>}
                    {type === 'producto' && (
                      <div className="text-sm text-slate-600">
                        <span>Stock: {(item.stock || 0).toFixed(2)} kg</span>
                        {item.precio_kg > 0 && <span className="ml-3">‚Ä¢ Precio: ${item.precio_kg.toFixed(2)}/kg</span>}
                      </div>
                    )}
                    {type === 'envase' && <p className="text-sm text-slate-600">Tara: {item.tara} kg</p>}
                    {type === 'banco' && item.codigo && <p className="text-sm text-slate-600">C√≥digo: {item.codigo}</p>}
                  </div>
                  <div className="flex gap-2">
                    <Button variant="ghost" size="icon" onClick={() => onEdit(type, item)}>
                      <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="ghost" size="icon" onClick={() => onDelete(type, item)} className="text-red-500 hover:text-red-700">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              ))}
            </div>
            {hasMore && (
              <div className="flex justify-center pt-4">
                <Button
                  variant="outline"
                  onClick={() => onLoadMore()}
                  disabled={isFetchingMore}
                >
                  {isFetchingMore ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : null}
                  Cargar m√°s
                </Button>
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/configuracion/CategoriasEmpleadoContent.jsx">
import React from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Users, Plus, Edit, Trash2 } from "lucide-react";

export default function CategoriasEmpleadoContent({ categorias, onEdit, onDelete }) {
  return (
    <div className="space-y-4">
      <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p className="text-sm text-blue-900 font-medium mb-1">üíº Categor√≠as de Empleados</p>
        <p className="text-xs text-blue-800">
          Define categor√≠as laborales con tipos de liquidaci√≥n y conceptos predeterminados. Las categor√≠as con "Sueldo Fijo" permiten configurar conceptos que se aplicar√°n autom√°ticamente. Las de "Por Viaje" habilitan el registro de viajes detallados.
        </p>
      </div>

      <Button onClick={() => onEdit(null)} className="bg-indigo-600 hover:bg-indigo-700">
        <Plus className="h-4 w-4 mr-2" />
        Nueva Categor√≠a de Empleado
      </Button>

      {categorias.length === 0 ? (
        <div className="text-center py-12">
          <Users className="h-12 w-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">No hay categor√≠as de empleado definidas</p>
        </div>
      ) : (
        <div className="space-y-2">
          {categorias.map(cat => (
            <Card key={cat.id} className="border">
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <p className="font-semibold text-slate-800">{cat.nombre}</p>
                      <Badge variant={cat.activo ? 'default' : 'secondary'}>
                        {cat.activo ? 'Activa' : 'Inactiva'}
                      </Badge>
                      <Badge variant="outline">{cat.tipo_liquidacion}</Badge>
                    </div>
                    {cat.conceptos_predeterminados && cat.conceptos_predeterminados.length > 0 && (
                      <div className="mt-2">
                        <p className="text-xs text-slate-500 mb-1">Conceptos predeterminados:</p>
                        <div className="flex flex-wrap gap-1">
                          {cat.conceptos_predeterminados.map((c, idx) => (
                            <Badge key={idx} variant="outline" className="text-xs">
                              {c.nombre}: ${c.monto_default} ({c.tipo})
                            </Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="flex gap-2">
                    <Button variant="ghost" size="icon" onClick={() => onEdit(cat)}>
                      <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="ghost" size="icon" onClick={() => onDelete(cat.id)} className="text-red-500">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/configuracion/ImportesConfigContent.jsx">
import React from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { DollarSign, Plus, Edit, Trash2 } from "lucide-react";

export default function ImportesConfigContent({ importes, onEdit, onDelete }) {
  return (
    <div className="space-y-4">
      <div className="p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
        <p className="text-sm text-emerald-900 font-medium mb-1">üí∞ Importes Predeterminados para Viajes</p>
        <p className="text-xs text-emerald-800">
          Configure importes est√°ndar que se pueden aplicar r√°pidamente en liquidaciones de fleteros. √ötil para distintos tipos de viajes (cortos, medios, largos).
        </p>
      </div>

      <Button onClick={() => onEdit(null)} className="bg-emerald-600 hover:bg-emerald-700">
        <Plus className="h-4 w-4 mr-2" />
        Nuevo Importe Predeterminado
      </Button>

      {importes.length === 0 ? (
        <div className="text-center py-12">
          <DollarSign className="h-12 w-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">No hay importes configurados</p>
        </div>
      ) : (
        <div className="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
          {importes.map(imp => (
            <Card key={imp.id} className="border">
              <CardContent className="p-4">
                <div className="flex items-start justify-between gap-2">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-2">
                      <p className="font-semibold text-slate-800 truncate">{imp.concepto}</p>
                      <Badge variant={imp.activo ? 'default' : 'secondary'} className="shrink-0">
                        {imp.activo ? 'Activo' : 'Inactivo'}
                      </Badge>
                    </div>
                    <p className="text-2xl font-bold text-emerald-600">
                      ${imp.importe.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                    </p>
                  </div>
                  <div className="flex flex-col gap-1 shrink-0">
                    <Button variant="ghost" size="icon" onClick={() => onEdit(imp)} className="h-8 w-8">
                      <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="ghost" size="icon" onClick={() => onDelete(imp.id)} className="h-8 w-8 text-red-500">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/configuracion/MantenimientoContent.jsx">
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Wrench, Loader2, RefreshCw } from "lucide-react";

export default function MantenimientoContent({ ejecutandoCorreccion, onEjecutarCorreccion, progresoSincronizacion = '' }) {
  const correcciones = [
    {
      id: 'sincronizarSaldos',
      titulo: 'Sincronizar Saldos',
      descripcion: 'Recalcula saldo_actual de cada Proveedor y Cliente desde el historial de movimientos (por lotes, sin saturar la API).',
      tipo: 'sincronizarSaldos',
      icon: RefreshCw
    },
    {
      id: 'autoRetroactiva',
      titulo: 'Correcci√≥n Autom√°tica Retroactiva',
      descripcion: 'Corrige p√©rdidas de productos y stocks de envases desde el inicio',
      tipo: 'autoRetroactiva',
      icon: Wrench
    },
    {
      id: 'envasesRetroactiva',
      titulo: 'Correcci√≥n de Envases Retroactiva',
      descripcion: 'Recalcula stocks de envases ocupados y vac√≠os',
      tipo: 'envasesRetroactiva',
      icon: Wrench
    },
    {
      id: 'segregacionEnvases',
      titulo: 'Correcci√≥n de Segregaci√≥n de Envases',
      descripcion: 'Separa correctamente envases ocupados y vac√≠os',
      tipo: 'segregacionEnvases',
      icon: Wrench
    },
    {
      id: 'cuentaCorriente',
      titulo: 'Corregir Saldos de Cuenta Corriente',
      descripcion: 'Recalcula deudas y saldos de cuenta corriente',
      tipo: 'cuentaCorriente',
      icon: Wrench
    },
    {
      id: 'preciosSalidas',
      titulo: 'Correcci√≥n de Precios en Salidas',
      descripcion: 'Actualiza precios en salidas seg√∫n per√≠odos vigentes',
      tipo: 'preciosSalidas',
      icon: Wrench
    }
  ];

  return (
    <div className="space-y-6">
      <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg">
        <p className="text-sm text-amber-900 font-medium mb-1">üîß Mantenimiento y Correcciones</p>
        <p className="text-xs text-amber-800">
          Estas herramientas ejecutan procesos de correcci√≥n retroactiva sobre los datos hist√≥ricos del sistema. 
          √ösalas con precauci√≥n y solo cuando sea necesario corregir inconsistencias en los datos.
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Procesos de Correcci√≥n</CardTitle>
        </CardHeader>
        <CardContent>
          {progresoSincronizacion && ejecutandoCorreccion === 'sincronizarSaldos' && (
            <div className="mb-4 rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm text-blue-900">
              <p className="font-medium">Progreso:</p>
              <p className="mt-1">{progresoSincronizacion}</p>
            </div>
          )}
          <div className="grid gap-4 md:grid-cols-2">
            {correcciones.map((correccion) => {
              const Icon = correccion.icon || Wrench;
              const esSincronizar = correccion.tipo === 'sincronizarSaldos';
              return (
                <div
                  key={correccion.id}
                  className="p-4 border border-slate-200 rounded-lg hover:border-slate-300 transition-colors"
                >
                  <h3 className="font-semibold text-slate-800 mb-2">{correccion.titulo}</h3>
                  <p className="text-sm text-slate-600 mb-4">{correccion.descripcion}</p>
                  <Button
                    onClick={() => onEjecutarCorreccion(correccion.tipo)}
                    disabled={ejecutandoCorreccion !== null}
                    className="w-full"
                    variant={ejecutandoCorreccion === correccion.tipo ? 'secondary' : 'default'}
                  >
                    {ejecutandoCorreccion === correccion.tipo ? (
                      <>
                        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                        {esSincronizar ? 'Sincronizando...' : 'Ejecutando...'}
                      </>
                    ) : (
                      <>
                        <Icon className="h-4 w-4 mr-2" />
                        {esSincronizar ? 'Sincronizar Saldos' : 'Ejecutar Correcci√≥n'}
                      </>
                    )}
                  </Button>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="src/components/configuracion/modals/ABMModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";

export default function ABMModal({ modal, onClose, onSave, isLoading }) {
  const [formData, setFormData] = useState(modal.item || {});
  const isNew = !modal.item?.id;

  React.useEffect(() => {
    setFormData(modal.item || {});
  }, [modal.item]);

  const getFields = () => {
    switch (modal.type) {
      case 'proveedor':
        return [
          { key: 'nombre', label: 'Nombre', type: 'text', required: true },
          { key: 'direccion', label: 'Direcci√≥n', type: 'text' },
          { key: 'cuit', label: 'CUIT', type: 'text' },
          { key: 'whatsapp', label: 'WhatsApp', type: 'text' },
          { key: 'alias', label: 'Alias / CBU / CVU', type: 'text' },
          { key: 'banco', label: 'Banco', type: 'text' }
        ];
      case 'cliente':
        return [
          { key: 'nombre', label: 'Nombre', type: 'text', required: true },
          { key: 'direccion', label: 'Direcci√≥n', type: 'text' },
          { key: 'cuit', label: 'CUIT', type: 'text' },
          { key: 'whatsapp', label: 'WhatsApp', type: 'text' }
        ];
      case 'banco':
        return [
          { key: 'nombre', label: 'Nombre del Banco', type: 'text', required: true },
          { key: 'codigo', label: 'C√≥digo', type: 'text' }
        ];
      case 'envase':
        return [
          { key: 'tipo', label: 'Tipo de Envase', type: 'text', required: true },
          { key: 'tara', label: 'Tara (kg)', type: 'number', required: true }
        ];
      case 'producto':
        return [
          { key: 'fruta', label: 'Fruta', type: 'text', required: true },
          { key: 'variedad', label: 'Variedad', type: 'text', required: true },
          { key: 'stock', label: 'Stock Inicial (kg)', type: 'number' },
          { key: 'precio_kg', label: 'Precio por Kg', type: 'number' }
        ];
      case 'fletero':
        return [
          { key: 'nombre', label: 'Nombre', type: 'text', required: true },
          { key: 'direccion', label: 'Direcci√≥n', type: 'text' },
          { key: 'whatsapp', label: 'WhatsApp', type: 'text' }
        ];
      default:
        return [];
    }
  };

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{isNew ? 'Crear' : 'Editar'} {modal.type?.charAt(0).toUpperCase() + modal.type?.slice(1)}</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          {getFields().map(field => (
            <div key={field.key}>
              <Label>{field.label} {field.required && <span className="text-red-500">*</span>}</Label>
              <Input
                type={field.type}
                step={field.type === 'number' ? 'any' : undefined}
                value={formData[field.key] ?? ''}
                onChange={(e) => setFormData({
                  ...formData,
                  [field.key]: field.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value
                })}
                required={field.required}
                className="mt-1"
              />
            </div>
          ))}
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave({ type: modal.type, item: formData, isNew })} disabled={isLoading}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/CategoriaEmpleadoModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2, Plus, Trash2 } from "lucide-react";

export default function CategoriaEmpleadoModal({ modal, onClose, onSave, isLoading }) {
  const [formData, setFormData] = useState({
    nombre: '',
    tipo_liquidacion: 'Sueldo Fijo',
    conceptos_predeterminados: [],
    activo: true
  });

  React.useEffect(() => {
    setFormData(modal.item || {
      nombre: '',
      tipo_liquidacion: 'Sueldo Fijo',
      conceptos_predeterminados: [],
      activo: true
    });
  }, [modal.item, modal.open]);

  const agregarConcepto = () => {
    setFormData({
      ...formData,
      conceptos_predeterminados: [
        ...formData.conceptos_predeterminados,
        { nombre: '', tipo: 'suma', monto_default: 0 }
      ]
    });
  };

  const actualizarConcepto = (index, field, value) => {
    const nuevosConceptos = [...formData.conceptos_predeterminados];
    nuevosConceptos[index][field] = value;
    setFormData({ ...formData, conceptos_predeterminados: nuevosConceptos });
  };

  const eliminarConcepto = (index) => {
    setFormData({
      ...formData,
      conceptos_predeterminados: formData.conceptos_predeterminados.filter((_, i) => i !== index)
    });
  };

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>{formData.id ? 'Editar' : 'Nueva'} Categor√≠a de Empleado</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Nombre *</Label>
              <Input value={formData.nombre} onChange={(e) => setFormData({...formData, nombre: e.target.value})} className="mt-1" placeholder="Ej: Fletero, Administrativo" required />
            </div>
            <div>
              <Label>Tipo de Liquidaci√≥n *</Label>
              <select
                value={formData.tipo_liquidacion}
                onChange={(e) => setFormData({...formData, tipo_liquidacion: e.target.value})}
                className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm mt-1"
              >
                <option value="Sueldo Fijo">Sueldo Fijo</option>
                <option value="Por Viaje">Por Viaje</option>
              </select>
            </div>
          </div>

          {formData.tipo_liquidacion === 'Sueldo Fijo' && (
            <div>
              <div className="flex justify-between items-center mb-2">
                <Label>Conceptos Predeterminados</Label>
                <Button onClick={agregarConcepto} size="sm" variant="outline">
                  <Plus className="h-4 w-4 mr-1" />
                  Agregar
                </Button>
              </div>
              <div className="space-y-2">
                {formData.conceptos_predeterminados.map((concepto, idx) => (
                  <div key={idx} className="flex gap-2 p-3 bg-slate-50 rounded-lg">
                    <Input
                      value={concepto.nombre}
                      onChange={(e) => actualizarConcepto(idx, 'nombre', e.target.value)}
                      placeholder="Nombre concepto"
                      className="flex-1"
                    />
                    <select
                      value={concepto.tipo}
                      onChange={(e) => actualizarConcepto(idx, 'tipo', e.target.value)}
                      className="flex h-10 w-32 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                      <option value="suma">Suma</option>
                      <option value="descuento">Descuento</option>
                    </select>
                    <Input
                      type="number"
                      step="0.01"
                      value={concepto.monto_default}
                      onChange={(e) => actualizarConcepto(idx, 'monto_default', parseFloat(e.target.value) || 0)}
                      placeholder="$ Default"
                      className="w-28"
                    />
                    <Button variant="ghost" size="icon" onClick={() => eliminarConcepto(idx)} className="text-red-500">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                ))}
                {formData.conceptos_predeterminados.length === 0 && (
                  <p className="text-sm text-slate-500 text-center py-3">No hay conceptos definidos</p>
                )}
              </div>
            </div>
          )}

          <div className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={formData.activo}
              onChange={(e) => setFormData({...formData, activo: e.target.checked})}
              className="h-4 w-4 rounded border-slate-300"
            />
            <Label>Categor√≠a activa</Label>
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave(formData)} disabled={isLoading || !formData.nombre}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/CuentaModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Loader2 } from "lucide-react";

export default function CuentaModal({ modal, onClose, onSave, isLoading, cuentas }) {
  const [formData, setFormData] = useState(modal.item || {
    codigo: '',
    nombre: '',
    tipo: 'Activo',
    categoria: '',
    nivel: 1,
    cuenta_padre: '',
    imputable: true,
    activa: true
  });

  React.useEffect(() => {
    setFormData(modal.item || {
      codigo: '',
      nombre: '',
      tipo: 'Activo',
      categoria: '',
      nivel: 1,
      cuenta_padre: '',
      imputable: true,
      activa: true
    });
  }, [modal.item]);

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>{formData.id ? 'Editar' : 'Nueva'} Cuenta Contable</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>C√≥digo *</Label>
              <Input value={formData.codigo} onChange={(e) => setFormData({...formData, codigo: e.target.value})} className="mt-1" required />
            </div>
            <div>
              <Label>Tipo *</Label>
              <Select value={formData.tipo} onValueChange={(val) => setFormData({...formData, tipo: val})}>
                <SelectTrigger className="mt-1">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="Activo">Activo</SelectItem>
                  <SelectItem value="Pasivo">Pasivo</SelectItem>
                  <SelectItem value="Patrimonio Neto">Patrimonio Neto</SelectItem>
                  <SelectItem value="Ingresos">Ingresos</SelectItem>
                  <SelectItem value="Costos">Costos</SelectItem>
                  <SelectItem value="Gastos">Gastos</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div>
            <Label>Nombre *</Label>
            <Input value={formData.nombre} onChange={(e) => setFormData({...formData, nombre: e.target.value})} className="mt-1" required />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Categor√≠a</Label>
              <Input value={formData.categoria} onChange={(e) => setFormData({...formData, categoria: e.target.value})} className="mt-1" />
            </div>
            <div>
              <Label>Nivel</Label>
              <Input type="number" value={formData.nivel} onChange={(e) => setFormData({...formData, nivel: parseInt(e.target.value)})} className="mt-1" />
            </div>
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave(formData)} disabled={isLoading || !formData.codigo || !formData.nombre}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/DeleteConfirmModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Loader2 } from "lucide-react";

export default function DeleteConfirmModal({ modal, onClose, onConfirm, isLoading }) {
  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Confirmar Eliminaci√≥n</DialogTitle>
        </DialogHeader>
        <p className="py-4">
          ¬øEst√° seguro de eliminar <strong>{modal.item?.nombre || modal.item?.tipo || 'este registro'}</strong>?
          <br />
          <span className="text-sm text-red-600 mt-2 block">Esta acci√≥n no se puede deshacer.</span>
        </p>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button variant="destructive" onClick={onConfirm} disabled={isLoading}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Eliminar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/EmpleadoModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";

export default function EmpleadoModal({ modal, onClose, onSave, isLoading }) {
  const [formData, setFormData] = useState(modal.item || {
    nombre: '',
    email: '',
    usuario: '',
    contrasena: '',
    activo: true,
    permisos: {
      Home: true,
      MovimientoFruta: false,
      MovimientoEnvases: false,
      Inventario: false,
      Logistica: false,
      Historial: false,
      Perdidas: false,
      SaldosEnvases: false,
      Egresos: false,
      Tesoreria: false,
      Informes: false,
      InformesContables: false
    }
  });

  React.useEffect(() => {
    setFormData(modal.item || {
      nombre: '',
      email: '',
      usuario: '',
      contrasena: '',
      activo: true,
      permisos: {
        Home: true,
        MovimientoFruta: false,
        MovimientoEnvases: false,
        Inventario: false,
        Logistica: false,
        Historial: false,
        Perdidas: false,
        SaldosEnvases: false,
        Egresos: false,
        Tesoreria: false,
        Informes: false,
        InformesContables: false
      }
    });
  }, [modal.item]);

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>{formData.id ? 'Editar' : 'Nuevo'} Empleado</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4 max-h-[60vh] overflow-y-auto">
          <div>
            <Label>Nombre Completo *</Label>
            <Input value={formData.nombre} onChange={(e) => setFormData({...formData, nombre: e.target.value})} className="mt-1" required />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Email *</Label>
              <Input type="email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} className="mt-1" required />
            </div>
            <div>
              <Label>Usuario *</Label>
              <Input value={formData.usuario} onChange={(e) => setFormData({...formData, usuario: e.target.value})} className="mt-1" required />
            </div>
          </div>
          <div>
            <Label>Contrase√±a {!formData.id && '*'}</Label>
            <Input type="password" value={formData.contrasena} onChange={(e) => setFormData({...formData, contrasena: e.target.value})} className="mt-1" placeholder={formData.id ? "Dejar en blanco para no cambiar" : ""} />
          </div>
          <div className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={formData.activo}
              onChange={(e) => setFormData({...formData, activo: e.target.checked})}
              className="h-4 w-4 rounded border-slate-300"
            />
            <Label>Empleado activo</Label>
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave(formData)} disabled={isLoading || !formData.nombre || !formData.email || !formData.usuario || (!formData.id && !formData.contrasena)}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/ImportBancosModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

export default function ImportBancosModal({ open, onClose, onImport }) {
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Importar Bancos del Sistema</DialogTitle>
        </DialogHeader>
        <div className="py-4 space-y-4">
          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-900 font-medium mb-2">Formato del CSV:</p>
            <pre className="text-xs text-blue-800 bg-white p-2 rounded">
nombre,codigo,activo{'\n'}
Banco Naci√≥n,011,true{'\n'}
Banco Provincia,014,true{'\n'}
Banco Galicia,007,true{'\n'}
BBVA,017,true{'\n'}
Santander,072,true
            </pre>
          </div>

          <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg">
            <p className="text-xs text-amber-900">
              üí° <strong>Tip:</strong> Los bancos del sistema estar√°n disponibles en todo el m√≥dulo de Tesorer√≠a, Cheques, y cualquier operaci√≥n bancaria.
            </p>
          </div>

          <div>
            <Label>Seleccionar archivo CSV</Label>
            <Input type="file" accept=".csv" onChange={onImport} className="mt-2" />
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cerrar</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/ImporteModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";

export default function ImporteModal({ modal, onClose, onSave, isLoading }) {
  const [formData, setFormData] = useState({
    concepto: '',
    importe: 0,
    activo: true
  });

  React.useEffect(() => {
    setFormData(modal.item || {
      concepto: '',
      importe: 0,
      activo: true
    });
  }, [modal.item, modal.open]);

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{formData.id ? 'Editar' : 'Nuevo'} Importe Predeterminado</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          <div>
            <Label>Concepto *</Label>
            <Input 
              value={formData.concepto} 
              onChange={(e) => setFormData({...formData, concepto: e.target.value})} 
              className="mt-1"
              placeholder="Ej: Viaje Corto, Viaje Largo"
              required 
            />
          </div>
          <div>
            <Label>Importe *</Label>
            <Input 
              type="number"
              step="0.01"
              value={formData.importe} 
              onChange={(e) => setFormData({...formData, importe: parseFloat(e.target.value) || 0})} 
              className="mt-1"
              placeholder="0.00"
              required 
            />
          </div>
          <div className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={formData.activo}
              onChange={(e) => setFormData({...formData, activo: e.target.checked})}
              className="h-4 w-4 rounded border-slate-300"
            />
            <Label>Activo</Label>
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave(formData)} disabled={isLoading || !formData.concepto}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/ImportModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

export default function ImportModal({ open, onClose, onImport }) {
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Importar Plan de Cuentas</DialogTitle>
        </DialogHeader>
        <div className="py-4 space-y-4">
          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-900 font-medium mb-2">Formato del CSV:</p>
            <pre className="text-xs text-blue-800 bg-white p-2 rounded">
codigo,nombre,tipo,categoria,nivel,cuenta_padre,imputable,activa{'\n'}
1,Activo,Activo,,1,,true,true{'\n'}
1.1,Caja y Bancos,Activo,Disponibilidades,2,1,true,true
            </pre>
          </div>

          <div>
            <Label>Seleccionar archivo CSV</Label>
            <Input type="file" accept=".csv" onChange={onImport} className="mt-2" />
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cerrar</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/InvitarUsuarioModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Loader2 } from "lucide-react";

export default function InvitarUsuarioModal({ open, onClose, email, setEmail, rol, setRol, onInvitar, isLoading }) {
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Invitar Nuevo Usuario</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm text-blue-900 font-medium mb-1">üìß Proceso de Invitaci√≥n</p>
            <p className="text-xs text-blue-800">
              El usuario recibir√° un correo electr√≥nico con un enlace para crear su cuenta y establecer su contrase√±a.
            </p>
          </div>

          <div>
            <Label>Correo Electr√≥nico *</Label>
            <Input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="usuario@ejemplo.com"
              className="mt-1"
            />
          </div>

          <div>
            <Label>Rol del Usuario *</Label>
            <Select value={rol} onValueChange={setRol}>
              <SelectTrigger className="mt-1">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="user">Usuario Regular</SelectItem>
                <SelectItem value="admin">Administrador</SelectItem>
              </SelectContent>
            </Select>
            <p className="text-xs text-slate-500 mt-1">
              {rol === 'admin' 
                ? '‚ö†Ô∏è Los administradores tienen acceso completo al sistema' 
                : 'Los usuarios regulares solo acceden a m√≥dulos asignados'}
            </p>
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button 
            onClick={onInvitar} 
            disabled={isLoading || !email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)}
            className="bg-indigo-600 hover:bg-indigo-700"
          >
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Enviar Invitaci√≥n
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/PermisosModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Loader2 } from "lucide-react";

export default function PermisosModal({ modal, onClose, onSave, isLoading }) {
  const [permisos, setPermisos] = useState(modal.item?.permisos || {});

  React.useEffect(() => {
    setPermisos(modal.item?.permisos || {});
  }, [modal.item]);

  const modulos = [
    { 
      key: 'Home', 
      label: 'Inicio',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'ver', label: 'Ver dashboard' }
      ]
    },
    { 
      key: 'MovimientoFruta', 
      label: 'Movimiento de Fruta',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'crear', label: 'Crear ingresos/salidas' },
        { key: 'editar', label: 'Editar movimientos' },
        { key: 'eliminar', label: 'Eliminar movimientos' },
        { key: 'descargar_pdf', label: 'Descargar PDF' },
        { key: 'compartir_whatsapp', label: 'Compartir WhatsApp' }
      ]
    },
    { 
      key: 'Inventario', 
      label: 'Inventario',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'ver', label: 'Ver inventario' }
      ]
    },
    { 
      key: 'Logistica', 
      label: 'Log√≠stica',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'crear_lotes', label: 'Crear lotes' },
        { key: 'editar_lotes', label: 'Editar lotes' },
        { key: 'eliminar_lotes', label: 'Eliminar lotes' },
        { key: 'ver_trazabilidad', label: 'Ver trazabilidad' },
        { key: 'mov_envases', label: 'Movimiento envases' }
      ]
    },
    { 
      key: 'Historial', 
      label: 'Historial',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'ver', label: 'Ver historial' },
        { key: 'editar', label: 'Editar movimientos' },
        { key: 'eliminar', label: 'Eliminar movimientos' },
        { key: 'descargar_pdf', label: 'Descargar PDF' }
      ]
    },
    { 
      key: 'Perdidas', 
      label: 'P√©rdidas',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'ver', label: 'Ver p√©rdidas' }
      ]
    },
    { 
      key: 'SaldosEnvases', 
      label: 'Saldos de Envases',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'ver', label: 'Ver saldos' },
        { key: 'descargar_pdf', label: 'Descargar PDF' }
      ]
    },
    { 
      key: 'Egresos', 
      label: 'Egresos',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'crear', label: 'Crear egresos' },
        { key: 'editar', label: 'Editar egresos' },
        { key: 'eliminar', label: 'Eliminar egresos' }
      ]
    },
    { 
      key: 'Tesoreria', 
      label: 'Tesorer√≠a',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'crear', label: 'Crear registros' },
        { key: 'editar', label: 'Editar registros' },
        { key: 'eliminar', label: 'Eliminar registros' }
      ]
    },
    { 
      key: 'InformesContables', 
      label: 'Informes Contables',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' },
        { key: 'ver_estado_resultados', label: 'Ver estado de resultados' },
        { key: 'generar_informes', label: 'Generar informes' },
        { key: 'exportar', label: 'Exportar a PDF/CSV' }
      ]
    },
    { 
      key: 'ConfiguracionUnificada', 
      label: 'Configuraci√≥n',
      funciones: [
        { key: 'acceso', label: 'Acceso al m√≥dulo' }
      ]
    }
  ];

  const toggleModuloCompleto = (moduloKey) => {
    const modulo = modulos.find(m => m.key === moduloKey);
    if (!modulo) return;

    const permisosModulo = permisos[moduloKey] || {};
    const todasActivas = modulo.funciones.every(f => permisosModulo[f.key]);

    const nuevoEstado = {};
    modulo.funciones.forEach(f => {
      nuevoEstado[f.key] = !todasActivas;
    });

    setPermisos({
      ...permisos,
      [moduloKey]: nuevoEstado
    });
  };

  const toggleFuncion = (moduloKey, funcionKey) => {
    const permisosModulo = permisos[moduloKey] || {};
    setPermisos({
      ...permisos,
      [moduloKey]: {
        ...permisosModulo,
        [funcionKey]: !permisosModulo[funcionKey]
      }
    });
  };

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[85vh]">
        <DialogHeader>
          <DialogTitle>Configurar Permisos Detallados - {modal.item?.nombre}</DialogTitle>
        </DialogHeader>
        <div className="py-4 overflow-y-auto max-h-[calc(85vh-12rem)]">
          <p className="text-sm text-slate-600 mb-4">Configure el acceso y funciones permitidas en cada m√≥dulo:</p>
          <div className="space-y-4">
            {modulos.map(modulo => {
              const permisosModulo = permisos[modulo.key] || {};
              const todasActivas = modulo.funciones.every(f => permisosModulo[f.key]);
              const algunaActiva = modulo.funciones.some(f => permisosModulo[f.key]);
              
              return (
                <div key={modulo.key} className="border border-slate-200 rounded-lg overflow-hidden">
                  <div 
                    className="flex items-center gap-3 p-3 bg-slate-100 cursor-pointer hover:bg-slate-200 transition-colors"
                    onClick={() => toggleModuloCompleto(modulo.key)}
                  >
                    <input
                      type="checkbox"
                      checked={todasActivas}
                      ref={(el) => el && (el.indeterminate = algunaActiva && !todasActivas)}
                      onChange={() => {}}
                      className="h-5 w-5 rounded border-slate-300"
                    />
                    <span className="font-semibold text-slate-800">{modulo.label}</span>
                    <Badge variant={todasActivas ? 'default' : algunaActiva ? 'secondary' : 'outline'} className="ml-auto">
                      {todasActivas ? 'Completo' : algunaActiva ? 'Parcial' : 'Sin acceso'}
                    </Badge>
                  </div>
                  <div className="p-3 space-y-2 bg-white">
                    {modulo.funciones.map(funcion => (
                      <div 
                        key={funcion.key} 
                        className="flex items-center gap-3 p-2 rounded hover:bg-slate-50 cursor-pointer"
                        onClick={() => toggleFuncion(modulo.key, funcion.key)}
                      >
                        <input
                          type="checkbox"
                          checked={permisosModulo[funcion.key] || false}
                          onChange={() => {}}
                          className="h-4 w-4 rounded border-slate-300"
                        />
                        <span className="text-sm text-slate-700">{funcion.label}</span>
                        {funcion.key === 'acceso' && (
                          <Badge variant="outline" className="ml-auto text-xs">Requerido</Badge>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave({ id: modal.item.id, permisos })} disabled={isLoading}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar Permisos
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/modals/PrecioModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";
import SearchableSelect from '@/components/SearchableSelect';

export default function PrecioModal({ modal, onClose, onSave, isLoading, productos }) {
  const [formData, setFormData] = useState(modal.item || {
    producto_id: '',
    fecha_desde: '',
    fecha_hasta: '',
    precio_compra_kg: 0,
    precio_venta_kg: 0,
    activo: true
  });

  React.useEffect(() => {
    setFormData(modal.item || {
      producto_id: '',
      fecha_desde: '',
      fecha_hasta: '',
      precio_compra_kg: 0,
      precio_venta_kg: 0,
      activo: true
    });
  }, [modal.item]);

  return (
    <Dialog open={modal.open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{formData.id ? 'Editar' : 'Nuevo'} Per√≠odo de Precio</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          <div>
            <Label>Producto *</Label>
            <SearchableSelect
              options={productos}
              value={formData.producto_id}
              onChange={(id) => setFormData({...formData, producto_id: id})}
              displayKey="producto_completo"
              placeholder="Seleccionar producto..."
              onCreateNew={() => {}}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Fecha Desde *</Label>
              <Input type="date" value={formData.fecha_desde} onChange={(e) => setFormData({...formData, fecha_desde: e.target.value})} className="mt-1" required />
            </div>
            <div>
              <Label>Fecha Hasta (Opcional)</Label>
              <Input type="date" value={formData.fecha_hasta || ''} onChange={(e) => setFormData({...formData, fecha_hasta: e.target.value})} className="mt-1" />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Precio Compra ($/kg) *</Label>
              <Input type="number" step="0.01" value={formData.precio_compra_kg} onChange={(e) => setFormData({...formData, precio_compra_kg: parseFloat(e.target.value)})} className="mt-1" required />
            </div>
            <div>
              <Label>Precio Venta ($/kg) *</Label>
              <Input type="number" step="0.01" value={formData.precio_venta_kg} onChange={(e) => setFormData({...formData, precio_venta_kg: parseFloat(e.target.value)})} className="mt-1" required />
            </div>
          </div>

          {formData.precio_venta_kg > 0 && formData.precio_compra_kg > 0 && (
            <div className="p-3 bg-green-50 border border-green-200 rounded-lg">
              <p className="text-sm text-green-800">
                Margen de ganancia: <strong>${(formData.precio_venta_kg - formData.precio_compra_kg).toFixed(2)}/kg</strong>
              </p>
            </div>
          )}
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave(formData)} disabled={isLoading || !formData.producto_id || !formData.fecha_desde}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/configuracion/PermisosContent.jsx">
import React from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Shield } from "lucide-react";

export default function PermisosContent({ empleados, onEditPermisos }) {
  const empleadosActivos = empleados.filter(e => e.activo);

  const contarPermisosActivos = (permisos) => {
    if (!permisos) return 0;
    let count = 0;
    Object.values(permisos).forEach(modulo => {
      if (typeof modulo === 'object') {
        count += Object.values(modulo).filter(Boolean).length;
      }
    });
    return count;
  };

  return (
    <div className="space-y-4">
      <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg">
        <p className="text-sm text-amber-900 font-medium">‚ö†Ô∏è Solo Administradores</p>
        <p className="text-xs text-amber-800 mt-1">Configure permisos granulares para controlar exactamente qu√© puede hacer cada empleado en cada m√≥dulo.</p>
      </div>

      {empleadosActivos.length === 0 ? (
        <div className="text-center py-12">
          <Shield className="h-12 w-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">No hay empleados activos para configurar permisos</p>
        </div>
      ) : (
        <div className="space-y-2">
          {empleadosActivos.map(emp => {
            const totalPermisos = contarPermisosActivos(emp.permisos);
            const modulosConAcceso = Object.entries(emp.permisos || {}).filter(([_, perms]) => 
              typeof perms === 'object' && perms.acceso
            ).length;
            
            return (
              <Card key={emp.id} className="border">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between gap-4">
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-slate-800">{emp.nombre}</p>
                      <p className="text-sm text-slate-600">Usuario: {emp.usuario}</p>
                      <div className="flex flex-wrap gap-2 mt-2">
                        <Badge variant="outline" className="text-xs">
                          {modulosConAcceso} m√≥dulos con acceso
                        </Badge>
                        <Badge variant="secondary" className="text-xs">
                          {totalPermisos} funciones habilitadas
                        </Badge>
                      </div>
                    </div>
                    <Button onClick={() => onEditPermisos(emp)} className="shrink-0">
                      <Shield className="h-4 w-4 mr-2" />
                      <span className="hidden sm:inline">Configurar</span>
                    </Button>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/configuracion/PlanCuentasContent.jsx">
import React, { useState } from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { BookOpen, Plus, Edit, Trash2, Upload } from "lucide-react";

export default function PlanCuentasContent({ cuentas, onEdit, onDelete, onDeleteMultiple, onImportar, esAdmin }) {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedIds, setSelectedIds] = useState([]);
  const [confirmDeleteMultiple, setConfirmDeleteMultiple] = useState(false);

  const cuentasFiltradas = React.useMemo(() => {
    if (!searchTerm) return cuentas;
    const term = searchTerm.toLowerCase();
    return cuentas.filter(c => 
      c.codigo.toLowerCase().includes(term) || 
      c.nombre.toLowerCase().includes(term) ||
      c.tipo.toLowerCase().includes(term) ||
      (c.categoria && c.categoria.toLowerCase().includes(term))
    );
  }, [cuentas, searchTerm]);

  const handleToggleSelect = (id) => {
    setSelectedIds(prev => 
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const handleToggleSelectAll = () => {
    if (selectedIds.length === cuentasFiltradas.length) {
      setSelectedIds([]);
    } else {
      setSelectedIds(cuentasFiltradas.map(c => c.id));
    }
  };

  const handleDeleteSelected = () => {
    setConfirmDeleteMultiple(true);
  };

  const confirmDelete = () => {
    onDeleteMultiple(selectedIds);
    setSelectedIds([]);
    setConfirmDeleteMultiple(false);
  };

  return (
    <div className="space-y-4">
      <div className="flex gap-2 flex-wrap">
        <Button onClick={() => onEdit(null)} className="bg-blue-600 hover:bg-blue-700">
          <Plus className="h-4 w-4 mr-2" />
          Nueva Cuenta
        </Button>
        <Button onClick={onImportar} variant="outline">
          <Upload className="h-4 w-4 mr-2" />
          Importar CSV/XLSX
        </Button>
        {esAdmin && selectedIds.length > 0 && (
          <Button 
            onClick={handleDeleteSelected} 
            variant="destructive"
            className="ml-auto"
          >
            <Trash2 className="h-4 w-4 mr-2" />
            Eliminar {selectedIds.length} seleccionada{selectedIds.length > 1 ? 's' : ''}
          </Button>
        )}
      </div>

      <Input
        placeholder="Buscar por c√≥digo, nombre, tipo o categor√≠a..."
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
        className="max-w-md"
      />

      {cuentas.length === 0 ? (
        <div className="text-center py-12">
          <BookOpen className="h-12 w-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">No hay cuentas en el plan. Agregue o importe cuentas.</p>
        </div>
      ) : cuentasFiltradas.length === 0 ? (
        <div className="text-center py-8">
          <p className="text-slate-500">No se encontraron resultados para "{searchTerm}"</p>
        </div>
      ) : (
        <>
          {esAdmin && cuentasFiltradas.length > 0 && (
            <div className="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border">
              <input
                type="checkbox"
                checked={selectedIds.length === cuentasFiltradas.length && cuentasFiltradas.length > 0}
                onChange={handleToggleSelectAll}
                className="h-4 w-4 rounded border-slate-300"
              />
              <span className="text-sm text-slate-600">
                Seleccionar todas ({cuentasFiltradas.length})
              </span>
            </div>
          )}
          <div className="space-y-2">
            {cuentasFiltradas.map(cuenta => (
              <div key={cuenta.id} className="flex items-center gap-3 p-3 bg-white rounded-lg border">
                {esAdmin && (
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(cuenta.id)}
                    onChange={() => handleToggleSelect(cuenta.id)}
                    className="h-4 w-4 rounded border-slate-300"
                  />
                )}
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <code className="bg-slate-100 px-2 py-0.5 rounded text-sm font-mono">{cuenta.codigo}</code>
                    <span className="font-medium">{cuenta.nombre}</span>
                    <span className="text-xs text-slate-500">‚Ä¢ {cuenta.tipo}</span>
                  </div>
                  {cuenta.categoria && <p className="text-sm text-slate-600 mt-1">{cuenta.categoria}</p>}
                </div>
                <div className="flex gap-2">
                  <Button variant="ghost" size="icon" onClick={() => onEdit(cuenta)}>
                    <Edit className="h-4 w-4" />
                  </Button>
                  <Button variant="ghost" size="icon" onClick={() => onDelete(cuenta.id)} className="text-red-500">
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
              </div>
            ))}
          </div>
        </>
      )}

      {/* Modal de confirmaci√≥n para borrado m√∫ltiple */}
      <Dialog open={confirmDeleteMultiple} onOpenChange={setConfirmDeleteMultiple}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Confirmar Eliminaci√≥n M√∫ltiple</DialogTitle>
          </DialogHeader>
          <div className="py-4">
            <p className="text-slate-700 mb-3">
              ¬øEst√° seguro de eliminar <strong>{selectedIds.length}</strong> cuenta{selectedIds.length > 1 ? 's' : ''}?
            </p>
            <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-sm text-red-800 font-medium">‚ö†Ô∏è Advertencia</p>
              <p className="text-xs text-red-700 mt-1">Esta acci√≥n no se puede deshacer. Las cuentas con movimientos asociados no se eliminar√°n.</p>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setConfirmDeleteMultiple(false)}>
              Cancelar
            </Button>
            <Button variant="destructive" onClick={confirmDelete}>
              <Trash2 className="h-4 w-4 mr-2" />
              Confirmar Eliminaci√≥n
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
</file>

<file path="src/components/configuracion/PreciosContent.jsx">
import React, { useState } from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { DollarSign, Plus, Edit, Trash2 } from "lucide-react";

export default function PreciosContent({ periodosPrecios, onEdit, onDelete }) {
  const [searchTerm, setSearchTerm] = useState('');

  const periodosFiltrados = React.useMemo(() => {
    if (!searchTerm) return periodosPrecios;
    const term = searchTerm.toLowerCase();
    return periodosPrecios.filter(p => 
      (p.producto_nombre || '').toLowerCase().includes(term) ||
      (p.fecha_desde || '').includes(term) ||
      (p.fecha_hasta || '').includes(term)
    );
  }, [periodosPrecios, searchTerm]);

  return (
    <div className="space-y-4">
      <div className="flex gap-2">
        <Button onClick={() => onEdit(null)} className="bg-green-600 hover:bg-green-700">
          <Plus className="h-4 w-4 mr-2" />
          Nuevo Per√≠odo de Precio
        </Button>
        <Input
          placeholder="Buscar por producto o fecha..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="max-w-md"
        />
      </div>

      {periodosPrecios.length === 0 ? (
        <div className="text-center py-12">
          <DollarSign className="h-12 w-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">No hay per√≠odos de precio definidos.</p>
        </div>
      ) : periodosFiltrados.length === 0 ? (
        <div className="text-center py-8">
          <p className="text-slate-500">No se encontraron resultados para "{searchTerm}"</p>
        </div>
      ) : (
        <div className="space-y-2">
          {periodosFiltrados.map(periodo => (
            <div key={periodo.id} className="flex items-center justify-between p-4 bg-white rounded-lg border">
              <div className="flex-1">
                <p className="font-semibold text-slate-800">{periodo.producto_nombre}</p>
                <div className="flex gap-4 mt-2 text-sm text-slate-600">
                  <span>Desde: {periodo.fecha_desde}</span>
                  {periodo.fecha_hasta && <span>Hasta: {periodo.fecha_hasta}</span>}
                </div>
                <div className="flex gap-4 mt-1 text-sm">
                  <span className="text-blue-600">Compra: ${periodo.precio_compra_kg.toFixed(2)}/kg</span>
                  <span className="text-green-600">Venta: ${periodo.precio_venta_kg.toFixed(2)}/kg</span>
                  <span className="text-amber-600">Margen: ${(periodo.precio_venta_kg - periodo.precio_compra_kg).toFixed(2)}/kg</span>
                </div>
              </div>
              <div className="flex gap-2">
                <Button variant="ghost" size="icon" onClick={() => onEdit(periodo)}>
                  <Edit className="h-4 w-4" />
                </Button>
                <Button variant="ghost" size="icon" onClick={() => onDelete(periodo.id)} className="text-red-500">
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/configuracion/SeguridadContent.jsx">
import React from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Lock, Save, Loader2 } from "lucide-react";

export default function SeguridadContent({ esAdmin, pinActual, setPinActual, nuevoPin, setNuevoPin, confirmarPin, setConfirmarPin, onGuardar, isLoading }) {
  if (!esAdmin) {
    return (
      <div className="p-8 text-center bg-red-50 border border-red-200 rounded-lg">
        <Lock className="h-12 w-12 text-red-600 mx-auto mb-3" />
        <h3 className="text-lg font-semibold text-red-900 mb-2">Acceso Restringido</h3>
        <p className="text-red-800">Solo el administrador principal puede configurar el PIN de seguridad.</p>
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-2xl">
      <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p className="text-sm text-blue-900 font-medium mb-1">¬øPara qu√© se usa el PIN?</p>
        <ul className="text-xs text-blue-800 space-y-1 list-disc list-inside">
          <li>Proteger la edici√≥n de movimientos guardados</li>
          <li>Prevenir modificaciones accidentales de datos cr√≠ticos</li>
          <li>Mantener la integridad del sistema</li>
        </ul>
      </div>

      <div className="space-y-4">
        <div>
          <Label>PIN Actual</Label>
          <Input
            type="password"
            inputMode="numeric"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            value={pinActual}
            onChange={(e) => setPinActual(e.target.value.replace(/\D/g, ''))}
            maxLength={6}
            className="max-w-xs mt-1"
          />
          <p className="text-xs text-slate-500 mt-1">PIN por defecto: <code className="bg-slate-100 px-1 py-0.5 rounded">0000</code></p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <Label>Nuevo PIN (4-6 d√≠gitos)</Label>
            <Input
              type="password"
              inputMode="numeric"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              value={nuevoPin}
              onChange={(e) => setNuevoPin(e.target.value.replace(/\D/g, ''))}
              maxLength={6}
              className="mt-1"
            />
          </div>
          <div>
            <Label>Confirmar Nuevo PIN</Label>
            <Input
              type="password"
              inputMode="numeric"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              value={confirmarPin}
              onChange={(e) => setConfirmarPin(e.target.value.replace(/\D/g, ''))}
              maxLength={6}
              className="mt-1"
            />
          </div>
        </div>

        <Button onClick={onGuardar} disabled={!pinActual || !nuevoPin || !confirmarPin || isLoading} className={`bg-green-600 hover:bg-green-700 transition-all ${isLoading ? 'opacity-75 cursor-wait' : ''}`}>
          {isLoading ? <Loader2 className="h-4 w-4 mr-2 animate-spin" /> : <Save className="h-4 w-4 mr-2" />}
          {isLoading ? 'Actualizando PIN...' : 'Actualizar PIN'}
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/configuracion/UsuariosContent.jsx">
import React from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Users, Plus } from "lucide-react";

export default function UsuariosContent({ currentUser, usuarios, onInvitar }) {
  return (
    <div className="space-y-4">
      <div className="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
        <p className="text-sm text-indigo-900 font-medium mb-1">üë§ Sistema de Usuarios</p>
        <p className="text-xs text-indigo-800">
          Tu usuario actual es <strong>{currentUser?.email}</strong> con rol de <strong className="text-indigo-900">{currentUser?.role === 'admin' ? 'Administrador' : 'Usuario'}</strong>.
          {currentUser?.role === 'admin' ? ' Como administrador, puedes invitar otros usuarios al sistema.' : ''}
        </p>
      </div>

      {currentUser?.role === 'admin' && (
        <Button onClick={onInvitar} className="bg-indigo-600 hover:bg-indigo-700">
          <Plus className="h-4 w-4 mr-2" />
          Invitar Usuario
        </Button>
      )}

      <div className="space-y-2">
        <h3 className="font-semibold text-slate-700">Usuarios Registrados</h3>
        {!usuarios || usuarios.length === 0 ? (
          <div className="text-center py-12">
            <Users className="h-12 w-12 text-slate-300 mx-auto mb-4" />
            <p className="text-slate-500">No hay usuarios en el sistema</p>
          </div>
        ) : (
          <div className="space-y-2">
            {usuarios.map(user => (
              <Card key={user.id} className="border">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <p className="font-semibold text-slate-800">{user.full_name || user.email}</p>
                        <Badge variant={user.role === 'admin' ? 'default' : 'secondary'}>
                          {user.role === 'admin' ? 'Administrador' : 'Usuario'}
                        </Badge>
                        {user.id === currentUser?.id && (
                          <Badge className="bg-blue-100 text-blue-800">T√∫</Badge>
                        )}
                      </div>
                      <p className="text-sm text-slate-600">{user.email}</p>
                      <p className="text-xs text-slate-500 mt-1">
                        Registrado: {new Date(user.created_date).toLocaleDateString('es-AR', { 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric' 
                        })}
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </div>

      <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg mt-6">
        <p className="text-sm text-amber-900 font-medium mb-2">üîí Seguridad de Acceso</p>
        <ul className="text-xs text-amber-800 space-y-1 list-disc list-inside">
          <li>Solo usuarios invitados pueden acceder al sistema</li>
          <li>Los usuarios recibir√°n un email con un link para crear su contrase√±a</li>
          <li>Los administradores tienen acceso completo a todas las funciones</li>
          <li>Los usuarios regulares solo pueden acceder a los m√≥dulos que se les asignen</li>
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ConfirmDetalleModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { CheckCircle, Edit } from "lucide-react";

export default function ConfirmDetalleModal({ open, onClose, detalle, onConfirm, onEdit }) {
  if (!detalle) return null;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="text-lg font-semibold text-center">
            Confirmar Detalle de Salida
          </DialogTitle>
        </DialogHeader>
        
        <div className="py-4 space-y-3">
          <div className="bg-purple-50 p-4 rounded-lg space-y-2">
            <div className="flex justify-between">
              <span className="text-sm font-medium text-slate-600">Producto:</span>
              <span className="text-sm font-bold text-slate-800">
                {detalle.producto_nombre || 'Sin especificar'}
              </span>
            </div>
            
            <div className="flex justify-between pt-2 border-t border-purple-200">
              <span className="text-sm font-medium text-slate-600">Kilos a Salir:</span>
              <span className="text-lg font-bold text-purple-700">
                {(detalle.kilos_salida || 0).toFixed(2)} kg
              </span>
            </div>
            
            <div className="flex justify-between">
              <span className="text-sm font-medium text-slate-600">Stock Disponible:</span>
              <span className="text-sm font-bold text-slate-600">
                {(detalle.stock_disponible || 0).toFixed(2)} kg
              </span>
            </div>
            
            <div className="flex justify-between pt-2 border-t border-purple-200">
              <span className="text-sm font-medium text-slate-600">Stock Restante:</span>
              <span className={`text-sm font-bold ${
                (detalle.stock_disponible - detalle.kilos_salida) >= 0 ? 'text-green-600' : 'text-red-600'
              }`}>
                {((detalle.stock_disponible || 0) - (detalle.kilos_salida || 0)).toFixed(2)} kg
              </span>
            </div>
          </div>

          <p className="text-sm text-center text-slate-500">
            ¬øDeseas agregar este detalle a la salida?
          </p>
        </div>

        <DialogFooter className="flex-col sm:flex-row gap-2">
          <Button
            variant="outline"
            onClick={onEdit}
            className="w-full sm:w-auto"
          >
            <Edit className="h-4 w-4 mr-2" />
            No, Editar
          </Button>
          <Button
            onClick={onConfirm}
            className="w-full sm:w-auto bg-purple-600 hover:bg-purple-700"
          >
            <CheckCircle className="h-4 w-4 mr-2" />
            S√≠, Agregar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/ConfirmEnvaseModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { CheckCircle, Edit } from "lucide-react";

export default function ConfirmEnvaseModal({ open, onClose, envase, onConfirm, onEdit }) {
  if (!envase) return null;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="text-lg font-semibold text-center">
            Confirmar Movimiento de Envase
          </DialogTitle>
        </DialogHeader>
        
        <div className="py-4 space-y-3">
          <div className="bg-amber-50 p-4 rounded-lg space-y-2">
            <div className="flex justify-between">
              <span className="text-sm font-medium text-slate-600">Tipo de Envase:</span>
              <span className="text-sm font-bold text-slate-800">
                {envase.envase_tipo || 'Sin especificar'}
              </span>
            </div>
            
            <div className="flex justify-between pt-2 border-t border-amber-200">
              <span className="text-sm font-medium text-slate-600">Ingreso (Devoluci√≥n):</span>
              <span className="text-sm font-bold text-green-600">
                +{envase.cantidad_ingreso || 0} unidades
              </span>
            </div>
            
            <div className="flex justify-between">
              <span className="text-sm font-medium text-slate-600">Salida (Entrega):</span>
              <span className="text-sm font-bold text-red-600">
                -{envase.cantidad_salida || 0} unidades
              </span>
            </div>
          </div>

          <p className="text-sm text-center text-slate-500">
            ¬øDeseas agregar este movimiento de envase?
          </p>
        </div>

        <DialogFooter className="flex-col sm:flex-row gap-2">
          <Button
            variant="outline"
            onClick={onEdit}
            className="w-full sm:w-auto"
          >
            <Edit className="h-4 w-4 mr-2" />
            No, Editar
          </Button>
          <Button
            onClick={onConfirm}
            className="w-full sm:w-auto bg-amber-600 hover:bg-amber-700"
          >
            <CheckCircle className="h-4 w-4 mr-2" />
            S√≠, Agregar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/ConfirmPesajeModal.jsx">
import React from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { CheckCircle, Edit } from "lucide-react";

export default function ConfirmPesajeModal({ open, onClose, pesaje, onConfirm, onEdit }) {
  if (!pesaje) return null;

  const taraTotal = pesaje.modo === 'libre' 
    ? (pesaje.tara_manual || 0)
    : ((pesaje.tara_unitaria || 0) * (pesaje.cantidad || 1));

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="text-lg font-semibold text-center">
            Confirmar Pesaje
          </DialogTitle>
        </DialogHeader>
        
        <div className="py-4 space-y-3">
          <div className="bg-blue-50 p-4 rounded-lg space-y-2">
            <div className="flex justify-between">
              <span className="text-sm font-medium text-slate-600">Producto:</span>
              <span className="text-sm font-bold text-slate-800">
                {pesaje.producto_nombre || 'Sin especificar'}
              </span>
            </div>
            
            {pesaje.modo !== 'libre' && (
              <>
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-slate-600">Envase:</span>
                  <span className="text-sm font-bold text-slate-800">
                    {pesaje.envase_tipo || 'Sin especificar'}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-slate-600">Cantidad:</span>
                  <span className="text-sm font-bold text-slate-800">
                    {pesaje.cantidad || 1} bins
                  </span>
                </div>
              </>
            )}
            
            <div className="flex justify-between pt-2 border-t border-blue-200">
              <span className="text-sm font-medium text-slate-600">Peso Bruto:</span>
              <span className="text-sm font-bold text-blue-700">
                {(pesaje.peso_bruto || 0).toFixed(2)} kg
              </span>
            </div>
            
            <div className="flex justify-between">
              <span className="text-sm font-medium text-slate-600">Tara Total:</span>
              <span className="text-sm font-bold text-slate-600">
                {taraTotal.toFixed(2)} kg
              </span>
            </div>
            
            <div className="flex justify-between pt-2 border-t-2 border-blue-300">
              <span className="text-base font-semibold text-slate-700">Peso Neto:</span>
              <span className="text-lg font-bold text-green-700">
                {(pesaje.peso_neto || 0).toFixed(2)} kg
              </span>
            </div>
          </div>

          <p className="text-sm text-center text-slate-500">
            ¬øDeseas agregar este pesaje a la lista?
          </p>
        </div>

        <DialogFooter className="flex-col sm:flex-row gap-2">
          <Button
            variant="outline"
            onClick={onEdit}
            className="w-full sm:w-auto"
          >
            <Edit className="h-4 w-4 mr-2" />
            No, Editar
          </Button>
          <Button
            onClick={onConfirm}
            className="w-full sm:w-auto bg-green-600 hover:bg-green-700"
          >
            <CheckCircle className="h-4 w-4 mr-2" />
            S√≠, Agregar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/DetalleLineItem.jsx">
import React from 'react';
import { Input } from "@/components/ui/input";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { AlertCircle } from "lucide-react";
import SearchableSelect from "./SearchableSelect";

export default function DetalleLineItem({
  item,
  index,
  productos,
  onChange,
  onCreateProducto
}) {
  const handleChange = (field, value) => {
    onChange(index, { ...item, [field]: value });
  };

  const handleProductoSelect = (productoId, producto) => {
    onChange(index, {
      ...item,
      producto_id: productoId,
      producto_nombre: producto.producto_completo || producto.fruta,
      stock_disponible: producto.stock || 0
    });
  };

  const handleKilosChange = (value) => {
    const kilos = value === '' ? 0 : parseFloat(value) || 0;
    onChange(index, {
      ...item,
      kilos_salida: kilos
    });
  };

  const stockInsuficiente = (item.kilos_salida || 0) > (item.stock_disponible || 0);
  const stockRestante = (item.stock_disponible || 0) - (item.kilos_salida || 0);

  return (
    <div className="p-4 bg-white rounded-lg border border-slate-200 hover:border-slate-300 transition-colors space-y-3">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">Producto</label>
          <SearchableSelect
            options={productos}
            value={item.producto_id}
            onChange={handleProductoSelect}
            displayKey="producto_completo"
            placeholder="Seleccionar producto..."
            onCreateNew={onCreateProducto}
            createNewLabel="Crear nuevo producto"
          />
        </div>
        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">Kilos a Salir</label>
          <Input
            type="number"
            min="0"
            step="any"
            value={item.kilos_salida ?? 0}
            onChange={(e) => handleKilosChange(e.target.value)}
            onBlur={(e) => {
              if (e.target.value === '') {
                handleKilosChange(0);
              }
            }}
            inputMode="decimal"
            className={stockInsuficiente ? "border-red-500" : ""}
          />
        </div>
      </div>

      {item.producto_id && (
        <div className="flex items-center justify-between text-sm">
          <span className="text-slate-600">
            Stock disponible: <strong>{(item.stock_disponible || 0).toFixed(2)} kg</strong>
          </span>
          {item.kilos_salida > 0 && (
            <span className={stockRestante >= 0 ? "text-green-600 font-medium" : "text-red-600 font-medium"}>
              Stock restante: {stockRestante.toFixed(2)} kg
            </span>
          )}
        </div>
      )}

      {stockInsuficiente && (
        <Alert variant="destructive" className="py-2">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription className="text-xs">
            Stock insuficiente. Disponible: {(item.stock_disponible || 0).toFixed(2)} kg | Faltante: {Math.abs(stockRestante).toFixed(2)} kg
          </AlertDescription>
        </Alert>
      )}
    </div>
  );
}
</file>

<file path="src/components/EditarMovimientoModal.jsx">
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Loader2, Edit } from "lucide-react";
import { format } from 'date-fns';
import SearchableSelect from "./SearchableSelect";

export default function EditarMovimientoModal({ 
  open, 
  onClose, 
  movimiento, 
  onSave, 
  isLoading,
  proveedores = [],
  clientes = [],
  fleteros = []
}) {
  const [formData, setFormData] = useState({});
  const [envasesEditables, setEnvasesEditables] = useState([]);

  useEffect(() => {
    if (movimiento && open) {
      setFormData({
        fecha: movimiento.fecha ? format(new Date(movimiento.fecha), "yyyy-MM-dd'T'HH:mm") : '',
        notas: movimiento.notas || '',
        proveedor_id: movimiento.proveedor_id || '',
        cliente_id: movimiento.cliente_id || '',
        fletero_id: movimiento.fletero_id || '',
        numero_remito: movimiento.numero_remito || '',
        comprobante_cliente: movimiento.comprobante_cliente || ''
      });
      
      // Cargar envases editables si es movimiento de envases
      if (movimiento.movimiento_envases) {
        setEnvasesEditables(movimiento.movimiento_envases.map(e => ({ ...e })));
      } else {
        setEnvasesEditables([]);
      }
    }
  }, [movimiento, open]);

  const handleSave = () => {
    // Si hay envases editables, incluirlos en el formData
    const dataToSave = esMovEnvases 
      ? { ...formData, movimiento_envases: envasesEditables }
      : formData;
    onSave(dataToSave);
  };

  const toggleContabilizar = (index) => {
    const nuevosEnvases = [...envasesEditables];
    nuevosEnvases[index].contabilizar_viaje = !nuevosEnvases[index].contabilizar_viaje;
    setEnvasesEditables(nuevosEnvases);
  };

  if (!movimiento) return null;

  const esIngreso = movimiento.tipo === 'Ingreso de Fruta';
  const esSalida = movimiento.tipo === 'Salida de Fruta';
  const esMovEnvases = movimiento.tipo === 'Movimiento de Envases';

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Edit className="h-5 w-5 text-blue-600" />
            Editar {movimiento.tipo}
          </DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4 py-4">
          {/* Campos editables */}
          <div className="space-y-4">
            <div>
              <label className="text-sm font-medium mb-2 block">Fecha y Hora</label>
              <Input
                type="datetime-local"
                value={formData.fecha}
                onChange={(e) => setFormData({...formData, fecha: e.target.value})}
              />
            </div>

            {/* Proveedor (si aplica) */}
            {(esIngreso || (esMovEnvases && movimiento.proveedor_id)) && (
              <div>
                <label className="text-sm font-medium mb-2 block">Proveedor</label>
                <SearchableSelect
                  options={proveedores}
                  value={formData.proveedor_id}
                  onChange={(id) => setFormData({...formData, proveedor_id: id})}
                  displayKey="nombre"
                  placeholder="Seleccionar proveedor..."
                />
              </div>
            )}

            {/* Cliente (si aplica) */}
            {(esSalida || (esMovEnvases && movimiento.cliente_id)) && (
              <div>
                <label className="text-sm font-medium mb-2 block">Cliente</label>
                <SearchableSelect
                  options={clientes}
                  value={formData.cliente_id}
                  onChange={(id) => setFormData({...formData, cliente_id: id})}
                  displayKey="nombre"
                  placeholder="Seleccionar cliente..."
                />
              </div>
            )}

            {/* Fletero */}
            {movimiento.fletero_id && (
              <div>
                <label className="text-sm font-medium mb-2 block">Fletero</label>
                <SearchableSelect
                  options={fleteros}
                  value={formData.fletero_id}
                  onChange={(id) => setFormData({...formData, fletero_id: id})}
                  displayKey="nombre"
                  placeholder="Seleccionar fletero..."
                />
              </div>
            )}

            {/* N√∫mero de remito (si es salida) */}
            {esSalida && (
              <div>
                <label className="text-sm font-medium mb-2 block">N√∫mero de Remito</label>
                <Input
                  value={formData.numero_remito}
                  onChange={(e) => setFormData({...formData, numero_remito: e.target.value})}
                  placeholder="R00001-00000001"
                />
              </div>
            )}

            {/* Comprobante cliente (si es salida confirmada) */}
            {esSalida && movimiento.estado === 'Confirmada' && (
              <div>
                <label className="text-sm font-medium mb-2 block">Comprobante del Cliente</label>
                <Input
                  value={formData.comprobante_cliente}
                  onChange={(e) => setFormData({...formData, comprobante_cliente: e.target.value})}
                  placeholder="FAC-A-00001234"
                />
              </div>
            )}

            <div>
              <label className="text-sm font-medium mb-2 block">Notas</label>
              <Textarea
                value={formData.notas}
                onChange={(e) => setFormData({...formData, notas: e.target.value})}
                rows={3}
                placeholder="Notas adicionales..."
              />
            </div>
          </div>

          {/* Vista de datos del movimiento */}
          <div className="border-t pt-4 space-y-3">
            <h4 className="font-semibold text-sm text-slate-700">Resumen del Movimiento</h4>
            
            {esIngreso && movimiento.pesajes?.length > 0 && (
              <div className="text-xs bg-green-50 p-3 rounded">
                <p className="font-medium mb-1">Pesajes: {movimiento.pesajes.length}</p>
                <p>Total Neto: {movimiento.pesajes.reduce((s, p) => s + (p.peso_neto || 0), 0).toFixed(2)} kg</p>
              </div>
            )}

            {esSalida && movimiento.detalles?.length > 0 && (
              <div className="text-xs bg-purple-50 p-3 rounded">
                <p className="font-medium mb-1">Productos: {movimiento.detalles.length}</p>
                <p>Total: {movimiento.detalles.reduce((s, d) => s + (d.kilos_salida || 0), 0).toFixed(2)} kg</p>
              </div>
            )}

            {esMovEnvases && envasesEditables.length > 0 && (
              <div className="space-y-3">
                <h4 className="font-semibold text-sm text-slate-700">Movimientos de Envases</h4>
                {envasesEditables.map((env, idx) => (
                  <div key={idx} className="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <div className="flex items-start justify-between gap-3 mb-3">
                      <div className="flex-1">
                        <p className="font-semibold text-slate-800">{env.envase_tipo}</p>
                        <div className="flex gap-4 mt-1 text-sm">
                          {env.cantidad_ingreso > 0 && (
                            <span className="text-green-600">Ingreso: +{env.cantidad_ingreso}</span>
                          )}
                          {env.cantidad_salida > 0 && (
                            <span className="text-red-600">Salida: -{env.cantidad_salida}</span>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* Checkbox Contabilizar */}
                    {formData.fletero_id && (
                      <div className="pt-3 border-t border-amber-300">
                        <div className="flex items-start gap-3 p-2 bg-white rounded border border-amber-200">
                          <input
                            type="checkbox"
                            checked={env.contabilizar_viaje || false}
                            onChange={() => toggleContabilizar(idx)}
                            className="h-5 w-5 mt-0.5 rounded border-amber-300 text-amber-600 focus:ring-amber-500"
                          />
                          <div className="flex-1">
                            <label className="text-sm font-semibold text-amber-900 cursor-pointer">
                              Contabilizar viaje para pago
                            </label>
                            <p className="text-xs text-amber-700">
                              {env.contabilizar_viaje 
                                ? 'Este viaje est√° contabilizado y se pagar√° al fletero'
                                : 'Marque para incluir en el pago del fletero'
                              }
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="bg-amber-50 border border-amber-200 p-3 rounded-lg text-xs">
            <p className="font-medium text-amber-900">‚ö†Ô∏è Aviso Importante</p>
            <p className="text-amber-800 mt-1">
              Esta operaci√≥n requiere PIN de seguridad. Los stocks y saldos se recalcular√°n autom√°ticamente.
            </p>
            {!esMovEnvases && (
              <p className="text-amber-700 mt-1 font-medium">
                NOTA: Pesajes, detalles de productos y envases NO son editables por seguridad. Solo se pueden editar datos generales.
              </p>
            )}
            {esMovEnvases && formData.fletero_id && (
              <p className="text-amber-700 mt-1 font-medium">
                NOTA: Puede editar si los viajes se contabilizan o no para el pago del fletero. Esto afectar√° el monto a pagar en el m√≥dulo de Empleados.
              </p>
            )}
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={isLoading}>
            Cancelar
          </Button>
          <Button onClick={handleSave} disabled={isLoading}>
            {isLoading ? (
              <>
                <Loader2 className="h-4 w-4 animate-spin mr-2" />
                Guardando...
              </>
            ) : (
              'Guardar Cambios'
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/EditarSalidaModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";

export default function EditarSalidaModal({ open, onClose, salida, onSave, isLoading }) {
  const [formData, setFormData] = useState({
    comprobante_cliente: salida?.comprobante_cliente || '',
    detalles: salida?.detalles?.map(d => ({
      ...d,
      kilos_reales: d.kilos_reales ?? d.kilos_salida,
      descuento_kg: d.descuento_kg ?? 0
    })) || []
  });

  const handleDetalleChange = (index, field, value) => {
    const newDetalles = [...formData.detalles];
    newDetalles[index] = { ...newDetalles[index], [field]: value };
    setFormData({ ...formData, detalles: newDetalles });
  };

  const handleSave = () => {
    onSave(formData);
  };

  if (!salida) return null;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Confirmar Salida - {salida.numero_remito}</DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4 py-4">
          <div>
            <Label htmlFor="comprobante">Comprobante del Cliente</Label>
            <Input
              id="comprobante"
              value={formData.comprobante_cliente}
              onChange={(e) => setFormData({ ...formData, comprobante_cliente: e.target.value })}
              placeholder="Ej: FAC-A-00123"
            />
          </div>

          <div className="space-y-3">
            <h4 className="font-semibold text-slate-700">Ajustar Kilos por Producto</h4>
            {formData.detalles.map((detalle, index) => (
              <div key={index} className="p-3 bg-slate-50 rounded-lg space-y-2">
                <p className="font-medium text-slate-800">{detalle.producto_nombre}</p>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div>
                    <Label className="text-xs">Kilos Iniciales</Label>
                    <Input
                      type="number"
                      value={detalle.kilos_salida}
                      disabled
                      className="bg-slate-100"
                    />
                  </div>
                  <div>
                    <Label className="text-xs">Kilos Reales Recibidos</Label>
                    <Input
                      type="number"
                      min="0"
                      step="any"
                      value={detalle.kilos_reales ?? detalle.kilos_salida}
                      onChange={(e) => handleDetalleChange(index, 'kilos_reales', parseFloat(e.target.value) || 0)}
                      inputMode="decimal"
                    />
                  </div>
                  <div>
                    <Label className="text-xs">Descuento (kg)</Label>
                    <Input
                      type="number"
                      min="0"
                      step="any"
                      value={detalle.descuento_kg ?? 0}
                      onChange={(e) => handleDetalleChange(index, 'descuento_kg', parseFloat(e.target.value) || 0)}
                      inputMode="decimal"
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={isLoading}>
            Cancelar
          </Button>
          <Button onClick={handleSave} disabled={isLoading}>
            {isLoading ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : null}
            Confirmar Salida
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/empleados/FleteroModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Loader2, Truck } from "lucide-react";

export default function FleteroModal({ open, fletero, onClose, onSave, isLoading }) {
  const [formData, setFormData] = useState({
    nombre: '',
    direccion: '',
    whatsapp: '',
    frecuencia_pago: '',
    dia_vencimiento: '',
    precio_kg: 0,
    precio_por_viaje: 0,
    activo: true,
    notas: ''
  });

  React.useEffect(() => {
    if (fletero) {
      setFormData(fletero);
    } else {
      setFormData({
        nombre: '',
        direccion: '',
        whatsapp: '',
        frecuencia_pago: '',
        dia_vencimiento: '',
        precio_kg: 0,
        precio_por_viaje: 0,
        activo: true,
        notas: ''
      });
    }
  }, [fletero, open]);

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-xl flex items-center gap-2">
            <Truck className="h-5 w-5 text-orange-600" />
            {fletero ? 'Editar Fletero' : 'Nuevo Fletero'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-5 py-4">
          {/* Informaci√≥n B√°sica */}
          <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
            <h3 className="font-semibold text-slate-800 flex items-center gap-2">
              <Truck className="h-5 w-5" />
              Informaci√≥n B√°sica
            </h3>
            
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label>Nombre Completo *</Label>
                <Input 
                  value={formData.nombre} 
                  onChange={(e) => setFormData({...formData, nombre: e.target.value})} 
                  className="mt-1"
                  placeholder="Nombre del fletero"
                  required 
                />
              </div>
              <div>
                <Label>Direcci√≥n</Label>
                <Input 
                  value={formData.direccion} 
                  onChange={(e) => setFormData({...formData, direccion: e.target.value})} 
                  className="mt-1"
                  placeholder="Calle 123, Ciudad"
                />
              </div>
              <div>
                <Label>WhatsApp</Label>
                <Input 
                  value={formData.whatsapp} 
                  onChange={(e) => setFormData({...formData, whatsapp: e.target.value})} 
                  className="mt-1"
                  placeholder="+54 9 11 1234-5678"
                />
              </div>
            </div>
          </div>

          {/* Configuraci√≥n de Pagos */}
          <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
            <h3 className="font-semibold text-slate-800">Configuraci√≥n de Pagos</h3>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Frecuencia de Pago</Label>
                <Select 
                  value={formData.frecuencia_pago} 
                  onValueChange={(value) => setFormData({...formData, frecuencia_pago: value})}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="Seleccionar frecuencia..." />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="Semanal">Semanal</SelectItem>
                    <SelectItem value="Quincenal">Quincenal</SelectItem>
                    <SelectItem value="Mensual">Mensual</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>D√≠a de Vencimiento</Label>
                <Input 
                  type="number"
                  min="1"
                  max="31"
                  value={formData.dia_vencimiento} 
                  onChange={(e) => setFormData({...formData, dia_vencimiento: parseInt(e.target.value) || ''})} 
                  className="mt-1"
                  placeholder="Ej: 5, 15, 30"
                />
                <p className="text-xs text-slate-500 mt-1">
                  D√≠a del mes (1-31) o semana (1-7)
                </p>
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Precio por Kilogramo</Label>
                <div className="relative mt-1">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                  <Input 
                    type="number"
                    step="0.01"
                    value={formData.precio_kg} 
                    onChange={(e) => setFormData({...formData, precio_kg: parseFloat(e.target.value) || 0})} 
                    className="pl-7"
                    placeholder="0.00"
                  />
                </div>
                <p className="text-xs text-slate-500 mt-1">
                  Precio por kilogramo de fruta transportada
                </p>
              </div>
              
              <div>
                <Label>Precio por Viaje de Envases Vac√≠os</Label>
                <div className="relative mt-1">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                  <Input 
                    type="number"
                    step="0.01"
                    value={formData.precio_por_viaje} 
                    onChange={(e) => setFormData({...formData, precio_por_viaje: parseFloat(e.target.value) || 0})} 
                    className="pl-7"
                    placeholder="0.00"
                  />
                </div>
                <p className="text-xs text-amber-700 bg-amber-50 px-2 py-1.5 rounded mt-1 border border-amber-200">
                  ‚ö†Ô∏è Solo para viajes de <strong>envases vac√≠os</strong> contabilizados. Los envases llenos (con fruta) usan el precio por kilogramo.
                </p>
              </div>
            </div>
          </div>

          {/* Notas */}
          <div>
            <Label>Notas Adicionales</Label>
            <Textarea 
              value={formData.notas} 
              onChange={(e) => setFormData({...formData, notas: e.target.value})} 
              className="mt-1"
              placeholder="Informaci√≥n adicional sobre el fletero..."
              rows={3}
            />
          </div>

          {/* Estado */}
          <div className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={formData.activo}
              onChange={(e) => setFormData({...formData, activo: e.target.checked})}
              className="h-4 w-4 rounded border-slate-300"
            />
            <Label>Fletero Activo</Label>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button 
            onClick={() => onSave(formData)} 
            disabled={isLoading || !formData.nombre}
            className="bg-orange-600 hover:bg-orange-700"
          >
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar Fletero
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/empleados/LegajoEmpleadoModal.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Loader2, Upload, FileText, Users } from "lucide-react";
import { format } from 'date-fns';
import { toast } from "sonner";
import SearchableSelect from '@/components/SearchableSelect';

export default function LegajoEmpleadoModal({ open, empleado, categorias, onClose, onSave, isLoading }) {
  const [formData, setFormData] = useState({
    nombre: '',
    cuit_dni: '',
    direccion: '',
    whatsapp: '',
    categoria_empleado_id: '',
    fecha_alta: format(new Date(), 'yyyy-MM-dd'),
    sueldo_base: 0,
    jornadas: '',
    contrato_url: '',
    activo: true,
    notas: ''
  });
  const [uploadingContract, setUploadingContract] = useState(false);

  React.useEffect(() => {
    if (empleado) {
      setFormData(empleado);
    } else {
      setFormData({
        nombre: '',
        cuit_dni: '',
        direccion: '',
        whatsapp: '',
        categoria_empleado_id: '',
        fecha_alta: format(new Date(), 'yyyy-MM-dd'),
        sueldo_base: 0,
        jornadas: '',
        contrato_url: '',
        activo: true,
        notas: ''
      });
    }
  }, [empleado, open]);

  const handleUploadContract = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setUploadingContract(true);
    try {
      const result = await base44.integrations.Core.UploadFile({ file });
      setFormData({ ...formData, contrato_url: result.file_url });
      toast.success('Contrato subido exitosamente');
    } catch (error) {
      toast.error('Error al subir contrato');
    } finally {
      setUploadingContract(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-xl">
            {empleado ? 'Editar Legajo' : 'Nuevo Legajo de Empleado'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-5 py-4">
          {/* Informaci√≥n Personal */}
          <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
            <h3 className="font-semibold text-slate-800 flex items-center gap-2">
              <Users className="h-5 w-5" />
              Informaci√≥n Personal
            </h3>
            
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2 md:col-span-1">
                <Label>Nombre Completo *</Label>
                <Input 
                  value={formData.nombre} 
                  onChange={(e) => setFormData({...formData, nombre: e.target.value})} 
                  className="mt-1"
                  placeholder="Juan P√©rez"
                  required 
                />
              </div>
              <div>
                <Label>CUIL/DNI *</Label>
                <Input 
                  value={formData.cuit_dni} 
                  onChange={(e) => setFormData({...formData, cuit_dni: e.target.value})} 
                  className="mt-1"
                  placeholder="20-12345678-9"
                  required 
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Direcci√≥n</Label>
                <Input 
                  value={formData.direccion} 
                  onChange={(e) => setFormData({...formData, direccion: e.target.value})} 
                  className="mt-1"
                  placeholder="Calle 123, Ciudad"
                />
              </div>
              <div>
                <Label>WhatsApp</Label>
                <Input 
                  value={formData.whatsapp} 
                  onChange={(e) => setFormData({...formData, whatsapp: e.target.value})} 
                  className="mt-1"
                  placeholder="+54 9 11 1234-5678"
                />
              </div>
            </div>
          </div>

          {/* Informaci√≥n Laboral */}
          <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
            <h3 className="font-semibold text-slate-800 flex items-center gap-2">
              <FileText className="h-5 w-5" />
              Informaci√≥n Laboral
            </h3>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Categor√≠a de Empleado *</Label>
                <SearchableSelect
                  options={categorias.filter(c => c.activo)}
                  value={formData.categoria_empleado_id}
                  onChange={(id) => setFormData({...formData, categoria_empleado_id: id})}
                  displayKey="nombre"
                  placeholder="Seleccionar categor√≠a..."
                />
              </div>
              <div>
                <Label>Fecha de Alta *</Label>
                <Input 
                  type="date"
                  value={formData.fecha_alta} 
                  onChange={(e) => setFormData({...formData, fecha_alta: e.target.value})} 
                  className="mt-1"
                  required 
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Sueldo Base Mensual</Label>
                <Input 
                  type="number"
                  step="0.01"
                  value={formData.sueldo_base} 
                  onChange={(e) => setFormData({...formData, sueldo_base: parseFloat(e.target.value) || 0})} 
                  className="mt-1"
                  placeholder="0.00"
                />
              </div>
            </div>

            <div>
              <Label>Jornadas Laborales (Horarios/Semanas)</Label>
              <Textarea 
                value={formData.jornadas} 
                onChange={(e) => setFormData({...formData, jornadas: e.target.value})} 
                className="mt-1"
                placeholder="Ej: Lunes a Viernes 8:00 a 17:00"
                rows={2}
              />
            </div>

            <div>
              <Label>Contrato (PDF/Word)</Label>
              <div className="mt-1 space-y-2">
                <Input
                  type="file"
                  accept=".pdf,.doc,.docx"
                  onChange={handleUploadContract}
                  disabled={uploadingContract}
                />
                {uploadingContract && (
                  <p className="text-sm text-blue-600 flex items-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Subiendo contrato...
                  </p>
                )}
                {formData.contrato_url && (
                  <a 
                    href={formData.contrato_url} 
                    target="_blank" 
                    rel="noopener noreferrer" 
                    className="text-sm text-blue-600 hover:underline flex items-center gap-1"
                  >
                    <FileText className="h-4 w-4" />
                    Ver contrato subido
                  </a>
                )}
              </div>
            </div>
          </div>

          {/* Notas y Estado */}
          <div className="space-y-4">
            <div>
              <Label>Notas Adicionales</Label>
              <Textarea 
                value={formData.notas} 
                onChange={(e) => setFormData({...formData, notas: e.target.value})} 
                className="mt-1"
                placeholder="Informaci√≥n adicional sobre el empleado..."
                rows={3}
              />
            </div>

            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={formData.activo}
                onChange={(e) => setFormData({...formData, activo: e.target.checked})}
                className="h-4 w-4 rounded border-slate-300"
              />
              <Label>Empleado Activo</Label>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button 
            onClick={() => onSave(formData)} 
            disabled={isLoading || !formData.nombre || !formData.cuit_dni || !formData.categoria_empleado_id}
            className="bg-purple-600 hover:bg-purple-700"
          >
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar Legajo
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/empleados/LiquidacionFleteroModal.jsx">
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import SearchableSelect from '@/components/SearchableSelect';
import { Loader2, Truck, Package, Calendar, DollarSign, CheckCircle2, Minus, Plus } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function LiquidacionFleteroModal({
  open,
  fleteros,
  historialPrecios,
  movimientos,
  salidas,
  onClose,
  onSave,
  isLoading,
  bancos,
  cajas,
  cheques
}) {
  const [selectedFletero, setSelectedFletero] = useState(null);
  const [paso, setPaso] = useState(1);
  const [pagarAhora, setPagarAhora] = useState(false);
  
  const [formData, setFormData] = useState({
    periodo: format(new Date(), 'MMMM yyyy', { locale: es }),
    fecha_liquidacion: format(new Date(), 'yyyy-MM-dd'),
    fecha_pago: format(new Date(), 'yyyy-MM-dd'),
    salidas_fruta: [],
    viajes_envases: [],
    total_salidas_fruta: 0,
    total_viajes_envases: 0,
    otros_conceptos: 0,
    descuentos: 0,
    total_liquidacion: 0,
    forma_pago: 'Efectivo',
    origen_tipo: 'Caja',
    origen_id: '',
    cheque_id: '',
    notas: ''
  });

  const [salidasDisponibles, setSalidasDisponibles] = useState([]);
  const [viajesDisponibles, setViajesDisponibles] = useState([]);
  const [salidasSeleccionadas, setSalidasSeleccionadas] = useState(new Set());
  const [viajesSeleccionados, setViajesSeleccionados] = useState(new Set());

  useEffect(() => {
    if (!open) {
      setPaso(1);
      setSelectedFletero(null);
      setSalidasSeleccionadas(new Set());
      setViajesSeleccionados(new Set());
      setPagarAhora(false);
      setFormData({
        periodo: format(new Date(), 'MMMM yyyy', { locale: es }),
        fecha_liquidacion: format(new Date(), 'yyyy-MM-dd'),
        fecha_pago: format(new Date(), 'yyyy-MM-dd'),
        salidas_fruta: [],
        viajes_envases: [],
        total_salidas_fruta: 0,
        total_viajes_envases: 0,
        otros_conceptos: 0,
        descuentos: 0,
        total_liquidacion: 0,
        forma_pago: 'Efectivo',
        origen_tipo: 'Caja',
        origen_id: '',
        cheque_id: '',
        notas: ''
      });
    }
  }, [open]);

  useEffect(() => {
    if (selectedFletero) {
      // Obtener salidas de fruta del fletero
      const salidasFletero = salidas.filter(s => s.fletero_id === selectedFletero.id);
      setSalidasDisponibles(salidasFletero.map(s => {
        const kilosSalida = (s.detalles || []).reduce((total, d) => 
          total + (d.kilos_reales || d.kilos_salida || 0), 0
        );
        const precioKgVigente = obtenerPrecioVigente(selectedFletero.id, s.fecha, 'kg');
        const montoCalculado = kilosSalida * precioKgVigente;
        const montoFinal = s.monto_flete_ajustado !== undefined && s.monto_flete_ajustado !== null
          ? s.monto_flete_ajustado
          : montoCalculado;

        return {
          id: s.id,
          numero_remito: s.numero_remito,
          cliente_nombre: s.cliente_nombre,
          fecha: s.fecha,
          kilos: kilosSalida,
          precio_kg: precioKgVigente,
          monto: montoFinal
        };
      }));

      // Obtener viajes de envases contabilizados
      const movimientosEnvases = movimientos.filter(
        m => m.fletero_id === selectedFletero.id && m.tipo_movimiento === 'Movimiento de Envases'
      );
      
      const viajes = [];
      movimientosEnvases.forEach(m => {
        if (m.movimiento_envases) {
          m.movimiento_envases
            .filter(env => env.contabilizar_viaje === true)
            .forEach(env => {
              const precioViajeVigente = obtenerPrecioVigente(selectedFletero.id, m.fecha, 'viaje');
              viajes.push({
                movimiento_id: m.id,
                fecha: m.fecha,
                descripcion: `${m.proveedor_nombre || m.cliente_nombre} - ${env.envase_tipo}`,
                precio_viaje: precioViajeVigente,
                monto: precioViajeVigente
              });
            });
        }
      });
      setViajesDisponibles(viajes);
    }
  }, [selectedFletero, movimientos, salidas]);

  const obtenerPrecioVigente = (fleteroId, fecha, tipoPrecio = 'kg') => {
    const preciosOrdenados = historialPrecios
      .filter(hp => hp.fletero_id === fleteroId)
      .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
    
    const fechaMovimiento = new Date(fecha);
    const precioVigente = preciosOrdenados.find(hp => new Date(hp.fecha_desde) <= fechaMovimiento);
    
    if (precioVigente) {
      return tipoPrecio === 'kg' ? precioVigente.precio_kg : precioVigente.precio_por_viaje;
    }
    
    const fletero = fleteros.find(f => f.id === fleteroId);
    return tipoPrecio === 'kg' ? (fletero?.precio_kg || 0) : (fletero?.precio_por_viaje || 0);
  };

  const toggleSalida = (salida) => {
    const newSet = new Set(salidasSeleccionadas);
    if (newSet.has(salida.id)) {
      newSet.delete(salida.id);
    } else {
      newSet.add(salida.id);
    }
    setSalidasSeleccionadas(newSet);
  };

  const toggleViaje = (index) => {
    const newSet = new Set(viajesSeleccionados);
    if (newSet.has(index)) {
      newSet.delete(index);
    } else {
      newSet.add(index);
    }
    setViajesSeleccionados(newSet);
  };

  const calcularTotales = () => {
    const salidasArray = salidasDisponibles.filter(s => salidasSeleccionadas.has(s.id));
    const viajesArray = viajesDisponibles.filter((_, idx) => viajesSeleccionados.has(idx));

    const totalSalidas = salidasArray.reduce((sum, s) => sum + s.monto, 0);
    const totalViajes = viajesArray.reduce((sum, v) => sum + v.monto, 0);
    const total = totalSalidas + totalViajes + (formData.otros_conceptos || 0) - (formData.descuentos || 0);

    return {
      salidasArray,
      viajesArray,
      totalSalidas,
      totalViajes,
      total
    };
  };

  const handleGuardar = () => {
    const { salidasArray, viajesArray, totalSalidas, totalViajes, total } = calcularTotales();
    
    const liquidacion = {
      fletero_id: selectedFletero.id,
      fletero_nombre: selectedFletero.nombre,
      periodo: formData.periodo,
      fecha_liquidacion: new Date(formData.fecha_liquidacion).toISOString(),
      fecha_pago: new Date(formData.fecha_pago).toISOString(),
      salidas_fruta: salidasArray,
      viajes_envases: viajesArray,
      total_salidas_fruta: totalSalidas,
      total_viajes_envases: totalViajes,
      otros_conceptos: formData.otros_conceptos || 0,
      descuentos: formData.descuentos || 0,
      total_liquidacion: total,
      estado: pagarAhora ? 'Pagada' : 'Pendiente',
      monto_pagado: pagarAhora ? total : 0,
      forma_pago: pagarAhora ? formData.forma_pago : undefined,
      origen_tipo: pagarAhora ? formData.origen_tipo : undefined,
      origen_id: pagarAhora ? formData.origen_id : undefined,
      origen_nombre: pagarAhora ? getOrigenNombre() : undefined,
      cheque_id: pagarAhora && formData.forma_pago === 'Cheque' ? formData.cheque_id : undefined,
      notas: formData.notas,
      _pagarAhora: pagarAhora
    };

    onSave(liquidacion);
  };

  const getOrigenNombre = () => {
    if (formData.origen_tipo === 'Banco') {
      return bancos.find(b => b.id === formData.origen_id)?.nombre || '';
    }
    return cajas.find(c => c.id === formData.origen_id)?.nombre || '';
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Truck className="h-6 w-6 text-orange-600" />
            Liquidar Sueldo de Fletero
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-6 py-4">
          {paso === 1 && (
            <div className="space-y-4">
              <div>
                <Label>Fletero *</Label>
                <SearchableSelect
                  options={fleteros.filter(f => f.activo)}
                  value={selectedFletero?.id}
                  onChange={(id, fletero) => setSelectedFletero(fletero)}
                  displayKey="nombre"
                  placeholder="Seleccionar fletero..."
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Per√≠odo *</Label>
                  <Input
                    value={formData.periodo}
                    onChange={(e) => setFormData({...formData, periodo: e.target.value})}
                    placeholder="Ej: Enero 2026"
                  />
                </div>
                <div>
                  <Label>Fecha de Liquidaci√≥n *</Label>
                  <Input
                    type="date"
                    value={formData.fecha_liquidacion}
                    onChange={(e) => setFormData({...formData, fecha_liquidacion: e.target.value})}
                  />
                </div>
              </div>

              <Button 
                onClick={() => setPaso(2)} 
                disabled={!selectedFletero}
                className="w-full"
              >
                Siguiente: Seleccionar Trabajos
              </Button>
            </div>
          )}

          {paso === 2 && (
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="font-semibold text-lg">Seleccionar Trabajos a Liquidar</h3>
                <Button variant="outline" size="sm" onClick={() => setPaso(1)}>
                  Atr√°s
                </Button>
              </div>

              {/* Salidas de Fruta */}
              <Card>
                <CardContent className="p-4">
                  <h4 className="font-semibold mb-3 flex items-center gap-2">
                    <Package className="h-5 w-5 text-blue-600" />
                    Salidas de Fruta ({salidasDisponibles.length})
                  </h4>
                  {salidasDisponibles.length === 0 ? (
                    <p className="text-sm text-slate-500 text-center py-8">
                      No hay salidas de fruta para este fletero
                    </p>
                  ) : (
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                      {salidasDisponibles.map(salida => (
                        <button
                          key={salida.id}
                          onClick={() => toggleSalida(salida)}
                          className={`w-full p-3 rounded-lg border text-left transition-all ${
                            salidasSeleccionadas.has(salida.id)
                              ? 'bg-blue-50 border-blue-300 shadow-sm'
                              : 'bg-white border-slate-200 hover:border-slate-300'
                          }`}
                        >
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 mb-1">
                                <Badge variant="outline">{salida.numero_remito}</Badge>
                                {salidasSeleccionadas.has(salida.id) && (
                                  <CheckCircle2 className="h-4 w-4 text-blue-600" />
                                )}
                              </div>
                              <p className="font-medium text-slate-800 truncate">{salida.cliente_nombre}</p>
                              <p className="text-xs text-slate-500 mt-1">
                                {format(new Date(salida.fecha), 'dd/MM/yyyy', { locale: es })} ‚Ä¢ {salida.kilos.toFixed(0)} kg
                              </p>
                            </div>
                            <div className="text-right shrink-0">
                              <p className="text-lg font-bold text-green-600">
                                ${salida.monto.toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                              </p>
                              <p className="text-xs text-slate-500">
                                ${salida.precio_kg.toFixed(2)}/kg
                              </p>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Viajes de Envases */}
              <Card>
                <CardContent className="p-4">
                  <h4 className="font-semibold mb-3 flex items-center gap-2">
                    <Truck className="h-5 w-5 text-amber-600" />
                    Viajes de Envases Contabilizados ({viajesDisponibles.length})
                  </h4>
                  {viajesDisponibles.length === 0 ? (
                    <p className="text-sm text-slate-500 text-center py-8">
                      No hay viajes de envases contabilizados para este fletero
                    </p>
                  ) : (
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                      {viajesDisponibles.map((viaje, idx) => (
                        <button
                          key={idx}
                          onClick={() => toggleViaje(idx)}
                          className={`w-full p-3 rounded-lg border text-left transition-all ${
                            viajesSeleccionados.has(idx)
                              ? 'bg-amber-50 border-amber-300 shadow-sm'
                              : 'bg-white border-slate-200 hover:border-slate-300'
                          }`}
                        >
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 mb-1">
                                <Badge variant="outline" className="bg-amber-50">Viaje</Badge>
                                {viajesSeleccionados.has(idx) && (
                                  <CheckCircle2 className="h-4 w-4 text-amber-600" />
                                )}
                              </div>
                              <p className="font-medium text-slate-800 truncate">{viaje.descripcion}</p>
                              <p className="text-xs text-slate-500 mt-1">
                                {format(new Date(viaje.fecha), 'dd/MM/yyyy', { locale: es })}
                              </p>
                            </div>
                            <div className="text-right shrink-0">
                              <p className="text-lg font-bold text-orange-600">
                                ${viaje.monto.toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                              </p>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              <div className="flex gap-2">
                <Button variant="outline" onClick={() => setPaso(1)} className="flex-1">
                  Atr√°s
                </Button>
                <Button 
                  onClick={() => setPaso(3)} 
                  disabled={salidasSeleccionadas.size === 0 && viajesSeleccionados.size === 0}
                  className="flex-1"
                >
                  Siguiente: Ajustes y Pago
                </Button>
              </div>
            </div>
          )}

          {paso === 3 && (
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="font-semibold text-lg">Ajustes y Forma de Pago</h3>
                <Button variant="outline" size="sm" onClick={() => setPaso(2)}>
                  Atr√°s
                </Button>
              </div>

              {/* Resumen */}
              {(() => {
                const { totalSalidas, totalViajes, total } = calcularTotales();
                return (
                  <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                    <CardContent className="p-4">
                      <h4 className="font-semibold text-green-900 mb-3">Resumen de Liquidaci√≥n</h4>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                          <span className="text-green-700">Salidas de fruta ({salidasSeleccionadas.size}):</span>
                          <span className="font-bold text-green-900">${totalSalidas.toLocaleString('es-AR')}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-green-700">Viajes de envases ({viajesSeleccionados.size}):</span>
                          <span className="font-bold text-green-900">${totalViajes.toLocaleString('es-AR')}</span>
                        </div>
                        <div className="flex justify-between pt-2 border-t border-green-300">
                          <span className="text-green-700 font-semibold">TOTAL A PAGAR:</span>
                          <span className="font-bold text-green-900 text-lg">${total.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                );
              })()}

              {/* Ajustes */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Otros Conceptos (+)</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={formData.otros_conceptos}
                    onChange={(e) => setFormData({...formData, otros_conceptos: parseFloat(e.target.value) || 0})}
                  />
                </div>
                <div>
                  <Label>Descuentos (-)</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={formData.descuentos}
                    onChange={(e) => setFormData({...formData, descuentos: parseFloat(e.target.value) || 0})}
                  />
                </div>
              </div>

              <div>
                <Label>Fecha de Pago</Label>
                <Input
                  type="date"
                  value={formData.fecha_pago}
                  onChange={(e) => setFormData({...formData, fecha_pago: e.target.value})}
                />
              </div>

              <div>
                <Label>Notas</Label>
                <textarea
                  value={formData.notas}
                  onChange={(e) => setFormData({...formData, notas: e.target.value})}
                  className="flex w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm min-h-20"
                  placeholder="Notas adicionales..."
                />
              </div>

              {/* Pagar Ahora */}
              <Card className="border-2 border-purple-200 bg-purple-50">
                <CardContent className="p-4">
                  <div className="flex items-center gap-3 mb-3">
                    <input
                      type="checkbox"
                      id="pagar-ahora"
                      checked={pagarAhora}
                      onChange={(e) => setPagarAhora(e.target.checked)}
                      className="h-4 w-4 rounded border-purple-300"
                    />
                    <label htmlFor="pagar-ahora" className="font-semibold text-purple-900 cursor-pointer">
                      Pagar Ahora
                    </label>
                  </div>

                  {pagarAhora && (
                    <div className="space-y-3 pt-3 border-t border-purple-300">
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <Label>Forma de Pago *</Label>
                          <select
                            value={formData.forma_pago}
                            onChange={(e) => setFormData({...formData, forma_pago: e.target.value})}
                            className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                          >
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Tarjeta">Tarjeta</option>
                          </select>
                        </div>
                        <div>
                          <Label>Origen *</Label>
                          <select
                            value={formData.origen_tipo}
                            onChange={(e) => {
                              setFormData({...formData, origen_tipo: e.target.value, origen_id: ''});
                            }}
                            className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                          >
                            <option value="Banco">Banco</option>
                            <option value="Caja">Caja</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <Label>Cuenta Origen *</Label>
                        <SearchableSelect
                          options={formData.origen_tipo === 'Banco' ? bancos : cajas}
                          value={formData.origen_id}
                          onChange={(id) => setFormData({...formData, origen_id: id})}
                          displayKey="nombre"
                          placeholder={`Seleccionar ${formData.origen_tipo.toLowerCase()}...`}
                        />
                      </div>

                      {formData.forma_pago === 'Cheque' && (
                        <div>
                          <Label>Cheque *</Label>
                          <SearchableSelect
                            options={cheques.filter(ch => ch.estado === 'Pendiente')}
                            value={formData.cheque_id}
                            onChange={(id) => setFormData({...formData, cheque_id: id})}
                            displayKey="numero_cheque"
                            placeholder="Seleccionar cheque..."
                          />
                        </div>
                      )}
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Cancelar
          </Button>
          {paso === 3 && (
            <Button
              onClick={handleGuardar}
              disabled={isLoading || (pagarAhora && !formData.origen_id)}
              className="bg-orange-600 hover:bg-orange-700"
            >
              {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
              {pagarAhora ? 'Liquidar y Pagar' : 'Guardar Liquidaci√≥n'}
            </Button>
          )}
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/empleados/LiquidacionSueldoModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Loader2, Plus, Trash2, DollarSign, Truck, Users, CreditCard, Wallet } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { toast } from "sonner";
import SearchableSelect from '@/components/SearchableSelect';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';

export default function LiquidacionSueldoModal({ open, empleados, categorias, onClose, onSave, isLoading }) {
  const [empleadoSeleccionado, setEmpleadoSeleccionado] = useState(null);
  const [categoriaEmpleado, setCategoriaEmpleado] = useState(null);
  const [pagarAhora, setPagarAhora] = useState(false);
  const [formData, setFormData] = useState({
    periodo: format(new Date(), 'MMMM yyyy', { locale: es }),
    fecha_liquidacion: format(new Date(), 'yyyy-MM-dd'),
    fecha_pago: format(new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), 'yyyy-MM-dd'),
    viajes: [],
    conceptos: [],
    sueldo_base: 0,
    otros_conceptos: 0,
    descuentos: 0,
    notas: '',
    forma_pago: 'Transferencia',
    origen_tipo: 'Banco',
    origen_id: '',
    cheque_id: ''
  });

  const { data: importesConfig = [] } = useQuery({
    queryKey: ['importesconfig'],
    queryFn: () => base44.entities.ConfiguracionImportes.list()
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list('nombre')
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list('nombre')
  });

  const { data: cheques = [] } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_emision')
  });

  const chequesDisponibles = cheques.filter(ch => ch.estado === 'Pendiente');

  React.useEffect(() => {
    if (open) {
      setEmpleadoSeleccionado(null);
      setCategoriaEmpleado(null);
      setPagarAhora(false);
      setFormData({
        periodo: format(new Date(), 'MMMM yyyy', { locale: es }),
        fecha_liquidacion: format(new Date(), 'yyyy-MM-dd'),
        fecha_pago: format(new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), 'yyyy-MM-dd'),
        viajes: [],
        conceptos: [],
        sueldo_base: 0,
        otros_conceptos: 0,
        descuentos: 0,
        notas: '',
        forma_pago: 'Transferencia',
        origen_tipo: 'Banco',
        origen_id: bancos.length > 0 ? bancos[0].id : '',
        cheque_id: ''
      });
    }
  }, [open, bancos]);

  const handleSelectEmpleado = (empleadoId) => {
    const empleado = empleados.find(e => e.id === empleadoId);
    if (!empleado) return;

    const categoria = categorias.find(c => c.id === empleado.categoria_empleado_id);
    setEmpleadoSeleccionado(empleado);
    setCategoriaEmpleado(categoria);

    // Inicializar seg√∫n tipo de liquidaci√≥n
    if (categoria?.tipo_liquidacion === 'Sueldo Fijo') {
      const conceptosIniciales = categoria?.conceptos_predeterminados?.map(c => ({
        nombre: c.nombre,
        tipo: c.tipo,
        monto: c.monto_default || 0
      })) || [];

      setFormData({
        ...formData,
        sueldo_base: empleado.sueldo_base || 0,
        conceptos: conceptosIniciales,
        viajes: []
      });
    } else {
      setFormData({
        ...formData,
        sueldo_base: empleado.sueldo_base || 0,
        conceptos: [],
        viajes: []
      });
    }
  };

  // Viajes (Para Por Viaje)
  const agregarViaje = () => {
    setFormData({
      ...formData,
      viajes: [...formData.viajes, {
        fecha_viaje: format(new Date(), 'yyyy-MM-dd'),
        ida_opcion1: '',
        ida_cantidad1: 0,
        ida_opcion2: '',
        ida_cantidad2: 0,
        vuelta_opcion1: '',
        vuelta_cantidad1: 0,
        vuelta_opcion2: '',
        vuelta_cantidad2: 0,
        importe_viaje: importesConfig[0]?.importe || 0,
        kilos_llevados: 0
      }]
    });
  };

  const actualizarViaje = (index, field, value) => {
    const nuevosViajes = [...formData.viajes];
    nuevosViajes[index][field] = value;
    setFormData({ ...formData, viajes: nuevosViajes });
  };

  const eliminarViaje = (index) => {
    setFormData({
      ...formData,
      viajes: formData.viajes.filter((_, i) => i !== index)
    });
  };

  // Conceptos (Para Sueldo Fijo)
  const actualizarConcepto = (index, monto) => {
    const nuevosConceptos = [...formData.conceptos];
    nuevosConceptos[index].monto = monto;
    setFormData({ ...formData, conceptos: nuevosConceptos });
  };

  // C√°lculos
  const calcularTotales = () => {
    const totalViajes = formData.viajes.reduce((sum, v) => sum + (parseFloat(v.importe_viaje) || 0), 0);
    
    let totalConceptosSuma = 0;
    let totalConceptosDescuento = 0;
    formData.conceptos.forEach(c => {
      const monto = parseFloat(c.monto) || 0;
      if (c.tipo === 'suma') {
        totalConceptosSuma += monto;
      } else {
        totalConceptosDescuento += monto;
      }
    });

    const total = (parseFloat(formData.sueldo_base) || 0) 
                  + totalViajes 
                  + totalConceptosSuma
                  + (parseFloat(formData.otros_conceptos) || 0) 
                  - totalConceptosDescuento
                  - (parseFloat(formData.descuentos) || 0);
    
    return { totalViajes, totalConceptosSuma, totalConceptosDescuento, total };
  };

  const handleGuardar = () => {
    if (!empleadoSeleccionado) {
      toast.error('Debe seleccionar un empleado');
      return;
    }

    if (pagarAhora) {
      if (!formData.origen_id) {
        toast.error('Debe seleccionar un banco o caja para el pago');
        return;
      }
      if (formData.forma_pago === 'Cheque' && !formData.cheque_id) {
        toast.error('Debe seleccionar un cheque');
        return;
      }
    }

    const { totalViajes, total } = calcularTotales();

    let origen;
    if (pagarAhora) {
      if (formData.origen_tipo === 'Banco') {
        origen = bancos.find(b => b.id === formData.origen_id);
      } else {
        origen = cajas.find(c => c.id === formData.origen_id);
      }
    }

    const liquidacion = {
      empleado_id: empleadoSeleccionado.id,
      empleado_nombre: empleadoSeleccionado.nombre,
      periodo: formData.periodo,
      fecha_liquidacion: formData.fecha_liquidacion,
      fecha_pago: formData.fecha_pago,
      tipo_flete: categoriaEmpleado?.tipo_liquidacion === 'Por Viaje' ? 'Ida/Vuelta' : '',
      viajes: formData.viajes,
      sueldo_base: parseFloat(formData.sueldo_base) || 0,
      total_viajes: totalViajes,
      otros_conceptos: parseFloat(formData.otros_conceptos) || 0,
      descuentos: parseFloat(formData.descuentos) || 0,
      total_liquidacion: total,
      estado: pagarAhora ? 'Pagada' : 'Pendiente',
      monto_pagado: pagarAhora ? total : 0,
      forma_pago: pagarAhora ? formData.forma_pago : undefined,
      origen_tipo: pagarAhora ? formData.origen_tipo : undefined,
      origen_id: pagarAhora ? formData.origen_id : undefined,
      origen_nombre: pagarAhora ? origen?.nombre : undefined,
      cheque_id: pagarAhora && formData.forma_pago === 'Cheque' ? formData.cheque_id : undefined,
      notas: formData.notas,
      _pagarAhora: pagarAhora
    };

    onSave(liquidacion);
  };

  const { totalViajes, totalConceptosSuma, totalConceptosDescuento, total } = calcularTotales();
  const esLiquidacionPorViaje = categoriaEmpleado?.tipo_liquidacion === 'Por Viaje';

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-xl">
            {empleadoSeleccionado ? `Liquidar Sueldo - ${empleadoSeleccionado.nombre}` : 'Nueva Liquidaci√≥n de Sueldo'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-5 py-4">
          {/* Selector de Empleado */}
          {!empleadoSeleccionado ? (
            <div className="p-6 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">
              <Label className="text-base font-semibold mb-3 block">Seleccionar Empleado *</Label>
              <SearchableSelect
                options={empleados}
                value=""
                onChange={handleSelectEmpleado}
                displayKey="nombre"
                placeholder="Buscar empleado por nombre..."
              />
            </div>
          ) : (
            <>
              {/* Info Empleado Seleccionado */}
              <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="font-bold text-lg text-blue-900">{empleadoSeleccionado.nombre}</p>
                      <div className="flex gap-2 mt-1">
                        <Badge variant="outline" className="bg-white">
                          {categoriaEmpleado?.nombre}
                        </Badge>
                        <Badge variant="outline" className="bg-white">
                          Tipo: {categoriaEmpleado?.tipo_liquidacion}
                        </Badge>
                      </div>
                    </div>
                    <Button variant="ghost" size="sm" onClick={() => setEmpleadoSeleccionado(null)}>
                      Cambiar Empleado
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* Datos B√°sicos de Liquidaci√≥n */}
              <div className="grid grid-cols-3 gap-4">
                <div>
                  <Label>Per√≠odo *</Label>
                  <Input 
                    value={formData.periodo} 
                    onChange={(e) => setFormData({...formData, periodo: e.target.value})} 
                    className="mt-1"
                    placeholder="Enero 2026"
                  />
                </div>
                <div>
                  <Label>Fecha Liquidaci√≥n *</Label>
                  <Input 
                    type="date"
                    value={formData.fecha_liquidacion} 
                    onChange={(e) => setFormData({...formData, fecha_liquidacion: e.target.value})} 
                    className="mt-1"
                  />
                </div>
                <div>
                  <Label>Fecha de Pago *</Label>
                  <Input 
                    type="date"
                    value={formData.fecha_pago} 
                    onChange={(e) => setFormData({...formData, fecha_pago: e.target.value})} 
                    className="mt-1"
                  />
                </div>
              </div>

              {/* LIQUIDACI√ìN POR VIAJE (Fleteros) */}
              {esLiquidacionPorViaje && (
                <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
                  <div className="flex justify-between items-center">
                    <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                      <Truck className="h-5 w-5" />
                      Viajes Realizados
                    </h3>
                    <Button onClick={agregarViaje} size="sm" variant="outline">
                      <Plus className="h-4 w-4 mr-1" />
                      Agregar Viaje
                    </Button>
                  </div>

                  {importesConfig.length > 0 && (
                    <div className="p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                      <p className="text-xs text-emerald-900 font-medium mb-2">‚ö° Accesos R√°pidos - Importes Predeterminados:</p>
                      <div className="flex flex-wrap gap-2">
                        {importesConfig.filter(ic => ic.activo).map(ic => (
                          <Button
                            key={ic.id}
                            type="button"
                            size="sm"
                            variant="outline"
                            onClick={() => {
                              const nuevoViaje = {
                                fecha_viaje: format(new Date(), 'yyyy-MM-dd'),
                                ida_opcion1: '',
                                ida_cantidad1: 0,
                                ida_opcion2: '',
                                ida_cantidad2: 0,
                                vuelta_opcion1: '',
                                vuelta_cantidad1: 0,
                                vuelta_opcion2: '',
                                vuelta_cantidad2: 0,
                                importe_viaje: ic.importe,
                                kilos_llevados: 0
                              };
                              setFormData({
                                ...formData,
                                viajes: [...formData.viajes, nuevoViaje]
                              });
                              toast.success(`Viaje agregado con ${ic.concepto}: $${ic.importe.toLocaleString('es-AR')}`);
                            }}
                            className="bg-white hover:bg-emerald-50"
                          >
                            {ic.concepto}: <strong className="ml-1">${ic.importe.toLocaleString('es-AR')}</strong>
                          </Button>
                        ))}
                      </div>
                    </div>
                  )}

                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {formData.viajes.map((viaje, idx) => (
                      <Card key={idx} className="bg-white">
                        <CardContent className="p-4">
                          <div className="flex justify-between items-start mb-3">
                            <h4 className="font-semibold text-sm text-slate-700">Viaje #{idx + 1}</h4>
                            <Button variant="ghost" size="icon" onClick={() => eliminarViaje(idx)} className="text-red-500 h-8 w-8">
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </div>

                          <div className="grid grid-cols-2 gap-3 mb-3">
                            <div>
                              <Label className="text-xs">Fecha del Viaje</Label>
                              <Input 
                                type="date" 
                                value={viaje.fecha_viaje} 
                                onChange={(e) => actualizarViaje(idx, 'fecha_viaje', e.target.value)} 
                                className="mt-1 h-9 text-sm"
                              />
                            </div>
                            <div>
                              <Label className="text-xs">Kilos Transportados</Label>
                              <Input 
                                type="number" 
                                step="0.01"
                                value={viaje.kilos_llevados} 
                                onChange={(e) => actualizarViaje(idx, 'kilos_llevados', parseFloat(e.target.value) || 0)} 
                                className="mt-1 h-9 text-sm"
                                placeholder="0.00"
                              />
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4 mb-3">
                            {/* IDA */}
                            <div className="space-y-2 p-3 bg-blue-50 rounded-lg">
                              <Label className="text-xs font-semibold text-blue-900">Ida (Opci√≥n 1)</Label>
                              <div className="grid grid-cols-2 gap-2">
                                <select 
                                  value={viaje.ida_opcion1}
                                  onChange={(e) => actualizarViaje(idx, 'ida_opcion1', e.target.value)}
                                  className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs"
                                >
                                  <option value="">Ninguno</option>
                                  <option value="Envases Vac√≠os">Envases Vac√≠os</option>
                                  <option value="Envases Llenos">Envases Llenos</option>
                                </select>
                                <Input 
                                  type="number"
                                  placeholder="Cantidad"
                                  value={viaje.ida_cantidad1}
                                  onChange={(e) => actualizarViaje(idx, 'ida_cantidad1', parseInt(e.target.value) || 0)}
                                  className="h-9 text-xs"
                                />
                              </div>
                              
                              <Label className="text-xs font-semibold text-blue-900">Ida (Opci√≥n 2)</Label>
                              <div className="grid grid-cols-2 gap-2">
                                <select 
                                  value={viaje.ida_opcion2}
                                  onChange={(e) => actualizarViaje(idx, 'ida_opcion2', e.target.value)}
                                  className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs"
                                >
                                  <option value="">Ninguno</option>
                                  <option value="Envases Vac√≠os">Envases Vac√≠os</option>
                                  <option value="Envases Llenos">Envases Llenos</option>
                                </select>
                                <Input 
                                  type="number"
                                  placeholder="Cantidad"
                                  value={viaje.ida_cantidad2}
                                  onChange={(e) => actualizarViaje(idx, 'ida_cantidad2', parseInt(e.target.value) || 0)}
                                  className="h-9 text-xs"
                                />
                              </div>
                            </div>

                            {/* VUELTA */}
                            <div className="space-y-2 p-3 bg-green-50 rounded-lg">
                              <Label className="text-xs font-semibold text-green-900">Vuelta (Opci√≥n 1)</Label>
                              <div className="grid grid-cols-2 gap-2">
                                <select 
                                  value={viaje.vuelta_opcion1}
                                  onChange={(e) => actualizarViaje(idx, 'vuelta_opcion1', e.target.value)}
                                  className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs"
                                >
                                  <option value="">Ninguno</option>
                                  <option value="Envases Vac√≠os">Envases Vac√≠os</option>
                                  <option value="Envases Llenos">Envases Llenos</option>
                                </select>
                                <Input 
                                  type="number"
                                  placeholder="Cantidad"
                                  value={viaje.vuelta_cantidad1}
                                  onChange={(e) => actualizarViaje(idx, 'vuelta_cantidad1', parseInt(e.target.value) || 0)}
                                  className="h-9 text-xs"
                                />
                              </div>
                              
                              <Label className="text-xs font-semibold text-green-900">Vuelta (Opci√≥n 2)</Label>
                              <div className="grid grid-cols-2 gap-2">
                                <select 
                                  value={viaje.vuelta_opcion2}
                                  onChange={(e) => actualizarViaje(idx, 'vuelta_opcion2', e.target.value)}
                                  className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-xs"
                                >
                                  <option value="">Ninguno</option>
                                  <option value="Envases Vac√≠os">Envases Vac√≠os</option>
                                  <option value="Envases Llenos">Envases Llenos</option>
                                </select>
                                <Input 
                                  type="number"
                                  placeholder="Cantidad"
                                  value={viaje.vuelta_cantidad2}
                                  onChange={(e) => actualizarViaje(idx, 'vuelta_cantidad2', parseInt(e.target.value) || 0)}
                                  className="h-9 text-xs"
                                />
                              </div>
                            </div>
                          </div>

                          {/* Importe del Viaje */}
                          <div>
                            <Label className="text-xs">Importe del Viaje</Label>
                            <div className="flex gap-2 mt-1">
                              <select 
                                value={viaje.importe_viaje}
                                onChange={(e) => actualizarViaje(idx, 'importe_viaje', parseFloat(e.target.value) || 0)}
                                className="flex h-9 flex-1 rounded-md border border-slate-200 bg-white px-3 py-1 text-sm"
                              >
                                <option value="">Personalizado</option>
                                {importesConfig.filter(ic => ic.activo).map(ic => (
                                  <option key={ic.id} value={ic.importe}>
                                    {ic.concepto} - ${ic.importe.toLocaleString('es-AR')}
                                  </option>
                                ))}
                              </select>
                              <Input 
                                type="number" 
                                step="0.01" 
                                value={viaje.importe_viaje} 
                                onChange={(e) => actualizarViaje(idx, 'importe_viaje', parseFloat(e.target.value) || 0)} 
                                className="w-36 h-9 text-sm font-semibold"
                                placeholder="$ Monto"
                              />
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}

                    {formData.viajes.length === 0 && (
                      <p className="text-center text-slate-500 py-6 text-sm">
                        No hay viajes agregados. Haga clic en "Agregar Viaje" para comenzar.
                      </p>
                    )}
                  </div>
                </div>
              )}

              {/* LIQUIDACI√ìN SUELDO FIJO (Administrativos, etc.) */}
              {!esLiquidacionPorViaje && formData.conceptos.length > 0 && (
                <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
                  <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                    <DollarSign className="h-5 w-5" />
                    Conceptos de Liquidaci√≥n
                  </h3>
                  <div className="space-y-2">
                    {formData.conceptos.map((concepto, idx) => (
                      <div key={idx} className="flex items-center gap-3 p-3 bg-white rounded-lg border">
                        <span className="flex-1 text-sm font-medium text-slate-700">{concepto.nombre}</span>
                        <Badge variant={concepto.tipo === 'suma' ? 'default' : 'destructive'} className="text-xs">
                          {concepto.tipo === 'suma' ? 'Suma' : 'Descuento'}
                        </Badge>
                        <Input
                          type="number"
                          step="0.01"
                          value={concepto.monto}
                          onChange={(e) => actualizarConcepto(idx, parseFloat(e.target.value) || 0)}
                          className="w-40"
                          placeholder="$ Monto"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Campos Adicionales */}
              <div className="grid grid-cols-3 gap-4">
                <div>
                  <Label>Sueldo Base</Label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.sueldo_base} 
                    onChange={(e) => setFormData({...formData, sueldo_base: parseFloat(e.target.value) || 0})} 
                    className="mt-1"
                  />
                </div>
                <div>
                  <Label>Otros Conceptos (+)</Label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.otros_conceptos} 
                    onChange={(e) => setFormData({...formData, otros_conceptos: parseFloat(e.target.value) || 0})} 
                    className="mt-1"
                    placeholder="Bonos, extras..."
                  />
                </div>
                <div>
                  <Label>Descuentos (-)</Label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.descuentos} 
                    onChange={(e) => setFormData({...formData, descuentos: parseFloat(e.target.value) || 0})} 
                    className="mt-1"
                    placeholder="Adelantos, otros..."
                  />
                </div>
              </div>

              <div>
                <Label>Observaciones</Label>
                <Textarea 
                  value={formData.notas} 
                  onChange={(e) => setFormData({...formData, notas: e.target.value})} 
                  className="mt-1"
                  rows={2}
                  placeholder="Notas adicionales sobre esta liquidaci√≥n..."
                />
              </div>

              {/* Opciones de Pago */}
              <Card className="border-2 border-blue-200 bg-blue-50">
                <CardContent className="p-5">
                  <div className="flex items-center gap-2 mb-4">
                    <input
                      type="checkbox"
                      checked={pagarAhora}
                      onChange={(e) => setPagarAhora(e.target.checked)}
                      className="h-5 w-5 rounded border-blue-300 text-blue-600"
                    />
                    <Label className="text-base font-semibold text-blue-900 cursor-pointer" onClick={() => setPagarAhora(!pagarAhora)}>
                      üí∞ Pagar Ahora (Registrar pago en Tesorer√≠a)
                    </Label>
                  </div>

                  {pagarAhora && (
                    <div className="space-y-4 pl-7">
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <Label className="text-sm">Forma de Pago *</Label>
                          <select
                            value={formData.forma_pago}
                            onChange={(e) => setFormData({...formData, forma_pago: e.target.value})}
                            className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm mt-1"
                          >
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Tarjeta">Tarjeta</option>
                          </select>
                        </div>
                        <div>
                          <Label className="text-sm">Origen *</Label>
                          <select
                            value={formData.origen_tipo}
                            onChange={(e) => {
                              setFormData({
                                ...formData, 
                                origen_tipo: e.target.value,
                                origen_id: e.target.value === 'Banco' ? (bancos[0]?.id || '') : (cajas[0]?.id || '')
                              });
                            }}
                            className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm mt-1"
                          >
                            <option value="Banco">Banco</option>
                            <option value="Caja">Caja</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <Label className="text-sm">
                          {formData.origen_tipo === 'Banco' ? 'Banco *' : 'Caja *'}
                        </Label>
                        <SearchableSelect
                          options={formData.origen_tipo === 'Banco' ? bancos : cajas}
                          value={formData.origen_id}
                          onChange={(id) => setFormData({...formData, origen_id: id})}
                          displayKey="nombre"
                          placeholder={`Seleccionar ${formData.origen_tipo.toLowerCase()}...`}
                        />
                      </div>

                      {formData.forma_pago === 'Cheque' && (
                        <div>
                          <Label className="text-sm">Cheque Disponible *</Label>
                          <SearchableSelect
                            options={chequesDisponibles}
                            value={formData.cheque_id}
                            onChange={(id) => setFormData({...formData, cheque_id: id})}
                            displayKey={(ch) => `${ch.numero_cheque} - ${ch.banco_nombre} - $${ch.monto.toLocaleString('es-AR')}`}
                            placeholder="Seleccionar cheque..."
                          />
                          {chequesDisponibles.length === 0 && (
                            <p className="text-xs text-amber-700 mt-1">
                              No hay cheques disponibles. Puede crear uno en el m√≥dulo de Tesorer√≠a.
                            </p>
                          )}
                        </div>
                      )}

                      <div className="p-3 bg-blue-100 border border-blue-300 rounded-lg">
                        <p className="text-xs text-blue-900">
                          <strong>‚ÑπÔ∏è Nota:</strong> Al marcar esta opci√≥n, se crear√° autom√°ticamente un registro de pago en el m√≥dulo de Tesorer√≠a y se actualizar√° el saldo del {formData.origen_tipo.toLowerCase()} seleccionado.
                        </p>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Resumen de Totales */}
              <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                <CardContent className="p-5">
                  <h3 className="font-bold text-green-900 mb-3">Resumen de Liquidaci√≥n</h3>
                  <div className="space-y-2">
                    {formData.sueldo_base > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Sueldo Base:</span>
                        <span className="font-semibold">${formData.sueldo_base.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                      </div>
                    )}
                    {esLiquidacionPorViaje && totalViajes > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Total Viajes ({formData.viajes.length}):</span>
                        <span className="font-semibold">${totalViajes.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                      </div>
                    )}
                    {totalConceptosSuma > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Conceptos (Sumas):</span>
                        <span className="font-semibold text-green-600">+${totalConceptosSuma.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                      </div>
                    )}
                    {totalConceptosDescuento > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Conceptos (Descuentos):</span>
                        <span className="font-semibold text-red-600">-${totalConceptosDescuento.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                      </div>
                    )}
                    {formData.otros_conceptos > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Otros Conceptos:</span>
                        <span className="font-semibold">${formData.otros_conceptos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                      </div>
                    )}
                    {formData.descuentos > 0 && (
                      <div className="flex justify-between text-sm text-red-600">
                        <span>Descuentos:</span>
                        <span className="font-semibold">-${formData.descuentos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                      </div>
                    )}
                    
                    <div className="flex justify-between pt-3 mt-3 border-t-2 border-green-300">
                      <span className="font-bold text-base">TOTAL A PAGAR:</span>
                      <span className="font-bold text-2xl text-green-700">${total.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button 
            onClick={handleGuardar} 
            disabled={isLoading || !empleadoSeleccionado} 
            className="bg-green-600 hover:bg-green-700"
          >
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar Liquidaci√≥n
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/EnvaseLineItem.jsx">
import React from 'react';
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import SearchableSelect from "./SearchableSelect";

export default function EnvaseLineItem({
  item,
  index,
  envases,
  onChange,
  onCreateEnvase,
  tipoEntidad = 'Proveedor'
}) {
  const handleChange = (field, value) => {
    // Convertir valores vac√≠os a 0 para evitar strings en estado
    const finalValue = (field === 'cantidad_ingreso' || field === 'cantidad_salida') 
      ? (value === '' || value === null || value === undefined ? 0 : parseInt(value) || 0)
      : value;
    onChange(index, { ...item, [field]: finalValue });
  };

  const handleEnvaseSelect = (envaseId, envase) => {
    onChange(index, {
      ...item,
      envase_id: envaseId,
      envase_tipo: envase.tipo,
      tara: envase.tara
    });
  };

  return (
    <div className="space-y-3 p-4 bg-white rounded-lg border border-slate-200 hover:border-slate-300 transition-colors">
      <div>
        <label className="text-xs font-medium text-slate-500 mb-1 block">Tipo de Envase</label>
        <SearchableSelect
          options={envases}
          value={item.envase_id}
          onChange={handleEnvaseSelect}
          displayKey="tipo"
          placeholder="Seleccionar envase..."
          onCreateNew={onCreateEnvase}
          createNewLabel="Crear nuevo envase"
        />
      </div>
      
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {/* Ingreso - CHECKBOX INDEPENDIENTE */}
        <div className="space-y-2">
          <label className="text-xs font-medium text-slate-500 mb-1 block">Ingreso (Devoluci√≥n)</label>
          <Input
            type="number"
            min="0"
            step="1"
            value={item.cantidad_ingreso ?? 0}
            placeholder="0"
            onChange={(e) => {
              const val = e.target.value;
              const cantidad = val === '' ? 0 : parseInt(val) || 0;
              handleChange('cantidad_ingreso', cantidad);
              // Si cantidad es 0, resetear checkbox a valor por defecto (tildado para ingreso)
              if (cantidad === 0) {
                handleChange('ingreso_con_fruta', true);
              }
            }}
            onFocus={(e) => e.target.select()}
            className="text-center"
            inputMode="numeric"
          />
          {(item.cantidad_ingreso ?? 0) > 0 && (
            <label className="flex items-center gap-2 text-xs cursor-pointer">
              <input
                type="checkbox"
                checked={item.ingreso_con_fruta === true}
                onChange={(e) => {
                  // INDEPENDIENTE: Solo afecta el estado del INGRESO
                  handleChange('ingreso_con_fruta', e.target.checked);
                  console.log(`‚úÖ INGRESO Independiente - ${item.envase_tipo || 'Envase'}: ${e.target.checked ? 'OCUPADO (con fruta)' : 'VAC√çO (sin fruta)'}`);
                }}
                className="w-3 h-3 rounded"
              />
              <span className={item.ingreso_con_fruta === true ? "text-amber-700 font-medium" : "text-blue-600 font-medium"}>
                {item.ingreso_con_fruta === true ? 'Con fruta (Ocupados)' : 'Vac√≠os (sin fruta)'}
              </span>
            </label>
          )}
        </div>

        {/* Salida - CHECKBOX INDEPENDIENTE (DESTILDADO POR DEFECTO) */}
        <div className="space-y-2">
          <label className="text-xs font-medium text-slate-500 mb-1 block">Salida (Entrega)</label>
          <Input
            type="number"
            min="0"
            step="1"
            value={item.cantidad_salida ?? 0}
            placeholder="0"
            onChange={(e) => {
              const val = e.target.value;
              const cantidad = val === '' ? 0 : parseInt(val) || 0;
              handleChange('cantidad_salida', cantidad);
              // CORRECCI√ìN: Si cantidad es 0, resetear checkbox a DESTILDADO (false) - vac√≠os
              if (cantidad === 0) {
                handleChange('salida_con_fruta', false);
              }
            }}
            onFocus={(e) => e.target.select()}
            className="text-center"
            inputMode="numeric"
          />
          {(item.cantidad_salida ?? 0) > 0 && (
            <label className="flex items-center gap-2 text-xs cursor-pointer">
              <input
                type="checkbox"
                checked={item.salida_con_fruta === true}
                onChange={(e) => {
                  // INDEPENDIENTE: Solo afecta el estado de la SALIDA
                  handleChange('salida_con_fruta', e.target.checked);
                  console.log(`‚úÖ SALIDA Independiente - ${item.envase_tipo || 'Envase'}: ${e.target.checked ? 'OCUPADO (con fruta)' : 'VAC√çO (sin fruta)'}`);
                }}
                className="w-3 h-3 rounded"
              />
              <span className={item.salida_con_fruta === true ? "text-amber-700 font-medium" : "text-blue-600 font-medium"}>
                {item.salida_con_fruta === true ? 'Con fruta (Ocupados)' : 'Vac√≠os (sin fruta)'}
              </span>
            </label>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/EnvaseLineItemLlenos.jsx">
import React from 'react';
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import SearchableSelect from "./SearchableSelect";
import { Trash2 } from "lucide-react";

export default function EnvaseLineItemLlenos({
  item,
  index,
  envases,
  onChange,
  onRemove,
  onCreateEnvase,
  showRemove = true
}) {
  const handleChange = (field, value) => {
    const finalValue = field === 'cantidad' 
      ? (value === '' || value === null || value === undefined ? 0 : parseInt(value) || 0)
      : value;
    onChange(index, { ...item, [field]: finalValue });
  };

  const handleEnvaseSelect = (envaseId, envase) => {
    onChange(index, {
      ...item,
      envase_id: envaseId,
      envase_tipo: envase.tipo
    });
  };

  return (
    <div className="space-y-3 p-4 bg-white rounded-lg border border-slate-200 hover:border-slate-300 transition-colors">
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">Tipo de Envase</label>
          <SearchableSelect
            options={envases}
            value={item.envase_id}
            onChange={handleEnvaseSelect}
            displayKey="tipo"
            placeholder="Seleccionar envase..."
            onCreateNew={onCreateEnvase}
            createNewLabel="Crear nuevo envase"
          />
        </div>
        
        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">
            Cantidad de Envases Llenos
          </label>
          <Input
            type="number"
            min="0"
            step="1"
            value={item.cantidad ?? 0}
            placeholder="0"
            onChange={(e) => {
              const val = e.target.value;
              const cantidad = val === '' ? 0 : parseInt(val) || 0;
              handleChange('cantidad', cantidad);
            }}
            onFocus={(e) => e.target.select()}
            className="text-center"
            inputMode="numeric"
          />
        </div>
      </div>

      {showRemove && (
        <div className="flex justify-end">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => onRemove(index)}
            className="text-red-500 hover:text-red-700 hover:bg-red-50"
          >
            <Trash2 className="h-4 w-4 mr-1" />
            Eliminar
          </Button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/EnvaseLineItemSimple.jsx">
import React from 'react';
import { Input } from "@/components/ui/input";
import SearchableSelect from "./SearchableSelect";

export default function EnvaseLineItemSimple({
  item,
  index,
  envases,
  onChange,
  onCreateEnvase,
  mostrarContabilizar = false,
  fleteroData = null
}) {
  const handleChange = (field, value) => {
    const finalValue = (field === 'cantidad_ingreso' || field === 'cantidad_salida') 
      ? (value === '' || value === null || value === undefined ? 0 : parseInt(value) || 0)
      : value;
    onChange(index, { ...item, [field]: finalValue });
  };

  const handleEnvaseSelect = (envaseId, envase) => {
    onChange(index, {
      ...item,
      envase_id: envaseId,
      envase_tipo: envase.tipo,
      tara: envase.tara
    });
  };

  return (
    <div className="space-y-3 p-4 bg-white rounded-lg border border-slate-200 hover:border-slate-300 transition-colors">
      <div>
        <label className="text-xs font-medium text-slate-500 mb-1 block">Tipo de Envase</label>
        <SearchableSelect
          options={envases}
          value={item.envase_id}
          onChange={handleEnvaseSelect}
          displayKey="tipo"
          placeholder="Seleccionar envase..."
          onCreateNew={onCreateEnvase}
          createNewLabel="Crear nuevo envase"
        />
      </div>
      
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">
            Ingreso (Devoluci√≥n Vac√≠os)
          </label>
          <Input
            type="number"
            min="0"
            step="1"
            value={item.cantidad_ingreso ?? 0}
            placeholder="0"
            onChange={(e) => {
              const val = e.target.value;
              const cantidad = val === '' ? 0 : parseInt(val) || 0;
              handleChange('cantidad_ingreso', cantidad);
            }}
            onFocus={(e) => e.target.select()}
            className="text-center"
            inputMode="numeric"
          />
          <p className="text-xs text-slate-500 mt-1">Envases vac√≠os devueltos</p>
        </div>

        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">
            Salida (Entrega Vac√≠os)
          </label>
          <Input
            type="number"
            min="0"
            step="1"
            value={item.cantidad_salida ?? 0}
            placeholder="0"
            onChange={(e) => {
              const val = e.target.value;
              const cantidad = val === '' ? 0 : parseInt(val) || 0;
              handleChange('cantidad_salida', cantidad);
            }}
            onFocus={(e) => e.target.select()}
            className="text-center"
            inputMode="numeric"
          />
          <p className="text-xs text-slate-500 mt-1">Envases vac√≠os entregados</p>
        </div>
      </div>

      {/* Checkbox Contabilizar Viaje */}
      {mostrarContabilizar && fleteroData && (
        <div className="pt-3 border-t border-slate-200">
          <div className="flex items-start gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
            <input
              type="checkbox"
              checked={item.contabilizar_viaje || false}
              onChange={(e) => handleChange('contabilizar_viaje', e.target.checked)}
              className="h-5 w-5 mt-0.5 rounded border-amber-300 text-amber-600 focus:ring-amber-500"
            />
            <div className="flex-1">
              <label className="text-sm font-semibold text-amber-900 block mb-1 cursor-pointer">
                Contabilizar viaje para {fleteroData.nombre}
              </label>
              <p className="text-xs text-amber-700">
                {fleteroData.precio_kg > 0 
                  ? `Se pagar√° $${fleteroData.precio_kg}/kg transportado`
                  : 'Configure precio/kg del fletero en Empleados'
                }
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/ExportarExcel.jsx">
import { Button } from "@/components/ui/button";
import { Download } from 'lucide-react';
import * as XLSX from 'xlsx';

export function exportarExcel(datos, nombreArchivo) {
  if (!datos || datos.length === 0) {
    alert('No hay datos para exportar');
    return;
  }

  // Crear workbook y worksheet
  const ws = XLSX.utils.json_to_sheet(datos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Datos');

  // Descargar archivo XLSX
  XLSX.writeFile(wb, `${nombreArchivo}.xlsx`);
}

export function BotonExportarExcel({ datos, nombreArchivo = 'reporte' }) {
  return (
    <Button
      onClick={() => exportarExcel(datos, nombreArchivo)}
      variant="outline"
      size="sm"
      className="gap-2"
    >
      <Download className="h-4 w-4" />
      Exportar Excel
    </Button>
  );
}
</file>

<file path="src/components/GenericQuickCreateModal.jsx">
import React, { useState, useEffect } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";

/**
 * Componente gen√©rico para crear entidades r√°pidamente
 * @param {boolean} open - Controla si el modal est√° abierto
 * @param {function} onClose - Callback cuando se cierra el modal
 * @param {function} onCreated - Callback cuando se crea exitosamente (recibe los datos)
 * @param {string} title - T√≠tulo del modal
 * @param {Array} fields - Array de objetos con la configuraci√≥n de cada campo:
 *   - name: string (nombre del campo en formData)
 *   - label: string (etiqueta del campo)
 *   - placeholder: string (placeholder del input)
 *   - type: string (tipo de input: 'text', 'number', etc.)
 *   - required: boolean (si el campo es obligatorio)
 *   - defaultValue: any (valor por defecto)
 * @param {function} validate - Funci√≥n opcional de validaci√≥n personalizada (recibe formData, retorna boolean)
 */
export default function GenericQuickCreateModal({ 
  open, 
  onClose, 
  onCreated, 
  title,
  fields = [],
  validate
}) {
  // Inicializar formData con valores por defecto
  const getInitialFormData = () => {
    const initial = {};
    fields.forEach(field => {
      initial[field.name] = field.defaultValue !== undefined ? field.defaultValue : (field.type === 'number' ? 0 : '');
    });
    return initial;
  };

  const [formData, setFormData] = useState(getInitialFormData());
  const [saving, setSaving] = useState(false);

  // Resetear formData cuando se abre el modal
  useEffect(() => {
    if (open) {
      setFormData(getInitialFormData());
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  // Validaci√≥n por defecto: verificar campos requeridos
  const defaultValidate = (data) => {
    for (const field of fields) {
      if (field.required) {
        const value = data[field.name];
        if (field.type === 'number') {
          if (value === undefined || value === null || value <= 0) {
            return false;
          }
        } else {
          if (!value || !String(value).trim()) {
            return false;
          }
        }
      }
    }
    return true;
  };

  const isValid = validate ? validate(formData) : defaultValidate(formData);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!isValid) return;
    
    setSaving(true);
    try {
      await onCreated(formData);
      setFormData(getInitialFormData());
      onClose();
    } catch (error) {
      console.error('Error al crear:', error);
    } finally {
      setSaving(false);
    }
  };

  const handleChange = (fieldName, value) => {
    setFormData(prev => ({ ...prev, [fieldName]: value }));
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
        </DialogHeader>
        <form onSubmit={handleSubmit}>
          <div className="space-y-4 py-4">
            {fields.map((field) => (
              <div key={field.name}>
                <Label>
                  {field.label}
                  {field.required && ' *'}
                </Label>
                <Input
                  type={field.type || 'text'}
                  step={field.type === 'number' ? (field.step || '0.01') : undefined}
                  value={formData[field.name] ?? ''}
                  onChange={(e) => {
                    const value = field.type === 'number' 
                      ? (parseFloat(e.target.value) || 0)
                      : e.target.value;
                    handleChange(field.name, value);
                  }}
                  placeholder={field.placeholder}
                  className="mt-1"
                  required={field.required}
                />
              </div>
            ))}
          </div>
          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>
              Cancelar
            </Button>
            <Button type="submit" disabled={saving || !isValid}>
              {saving && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
              Crear
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/GenericSuccessModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { CheckCircle, FileDown, MessageCircle, FileText } from "lucide-react";

/**
 * Modal gen√©rico de √©xito que unifica SuccessModal y SuccessModalEnvases
 * @param {boolean} open - Controla si el modal est√° abierto
 * @param {function} onClose - Callback cuando se cierra el modal
 * @param {string} title - T√≠tulo del modal (ej: "¬°Movimiento Registrado!")
 * @param {string} message - Mensaje opcional personalizado (por defecto: "El movimiento se ha registrado correctamente")
 * @param {function} onDownloadPDF - Callback para descargar PDF (opcional)
 * @param {function} onShareWhatsApp - Callback para compartir por WhatsApp (opcional)
 * @param {boolean} isGenerating - Indica si se est√° generando el PDF (opcional)
 * @param {boolean} requireWhatsAppNumber - Si es true, muestra un input para ingresar n√∫mero de WhatsApp antes de compartir
 */
export default function GenericSuccessModal({
  open,
  onClose,
  title = "¬°Operaci√≥n Exitosa!",
  message = "El movimiento se ha registrado correctamente",
  onDownloadPDF,
  onShareWhatsApp,
  isGenerating = false,
  requireWhatsAppNumber = false
}) {
  const [whatsappNumber, setWhatsappNumber] = useState('');

  const handleShareWhatsApp = () => {
    if (requireWhatsAppNumber) {
      if (!whatsappNumber.trim()) {
        alert('Por favor ingrese un n√∫mero de WhatsApp');
        return;
      }
      // Si requiere n√∫mero, el callback debe recibirlo
      if (onShareWhatsApp) {
        onShareWhatsApp(whatsappNumber);
      }
    } else {
      // Si no requiere n√∫mero, llamar directamente
      if (onShareWhatsApp) {
        onShareWhatsApp();
      }
    }
  };

  const hasActions = onDownloadPDF || onShareWhatsApp;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className={requireWhatsAppNumber ? "max-w-md" : "sm:max-w-md"}>
        <DialogHeader>
          <div className="flex flex-col items-center text-center">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
              <CheckCircle className="h-8 w-8 text-green-600" />
            </div>
            <DialogTitle className="text-xl">{title}</DialogTitle>
            <p className="text-sm text-slate-500 mt-2">
              {message}
            </p>
          </div>
        </DialogHeader>
        
        {hasActions && (
          <div className="space-y-4 mt-6">
            {onDownloadPDF && (
              <Button
                size="lg"
                variant="outline"
                onClick={onDownloadPDF}
                disabled={isGenerating}
                className={`w-full ${requireWhatsAppNumber ? 'h-auto py-3 justify-start' : 'h-20 flex-col'} flex items-center gap-2`}
              >
                {requireWhatsAppNumber ? (
                  <>
                    <FileText className="h-5 w-5 text-red-600" />
                    <div className="text-left">
                      <div className="font-medium">Descargar PDF</div>
                      <div className="text-xs text-slate-500">Imprimir o guardar el comprobante</div>
                    </div>
                  </>
                ) : (
                  <>
                    <FileDown className="h-6 w-6 text-blue-600" />
                    <span className="text-sm font-medium">Descargar PDF</span>
                  </>
                )}
              </Button>
            )}

            {onShareWhatsApp && (
              <div className="space-y-2">
                {requireWhatsAppNumber && (
                  <>
                    <Label className="text-sm font-medium">Compartir por WhatsApp</Label>
                    <div className="flex gap-2">
                      <Input
                        type="tel"
                        placeholder="+54 9 11 1234-5678"
                        value={whatsappNumber}
                        onChange={(e) => setWhatsappNumber(e.target.value)}
                        className="flex-1"
                      />
                      <Button 
                        onClick={handleShareWhatsApp}
                        className="bg-green-600 hover:bg-green-700"
                        disabled={isGenerating}
                      >
                        <MessageCircle className="h-4 w-4 mr-2" />
                        Enviar
                      </Button>
                    </div>
                  </>
                )}
                {!requireWhatsAppNumber && (
                  <Button
                    size="lg"
                    variant="outline"
                    onClick={handleShareWhatsApp}
                    disabled={isGenerating}
                    className="w-full h-20 flex flex-col items-center justify-center gap-2 hover:bg-green-50 hover:border-green-300"
                  >
                    <MessageCircle className="h-6 w-6 text-green-600" />
                    <span className="text-sm font-medium">Compartir WhatsApp</span>
                  </Button>
                )}
              </div>
            )}
          </div>
        )}

        <Button
          variant="ghost"
          onClick={onClose}
          className="mt-4 w-full"
        >
          Cerrar
        </Button>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/hooks/useCorreccionAutoRetroactiva.jsx">
import { useEffect, useRef } from 'react';
import { base44 } from '@/api/base44Client';
import { useQueryClient } from '@tanstack/react-query';
import { correccionRetroactivaPerdidas } from '../utils/correccionRetroactivaPerdidas';
import { correccionRetroactivaEnvases } from '../utils/correccionRetroactivaEnvases';

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * HOOK DE CORRECCI√ìN RETROACTIVA AUTOM√ÅTICA - √öNICA EJECUCI√ìN
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Este hook se ejecuta autom√°ticamente UNA SOLA VEZ al cargar la app
 * para corregir todos los stocks eliminando sumas err√≥neas de p√©rdidas
 * en registros hist√≥ricos previos.
 * 
 * Usa localStorage para evitar re-ejecuciones innecesarias.
 */
export function useCorreccionAutoRetroactiva() {
  const queryClient = useQueryClient();
  const ejecutadoRef = useRef(false);
  const STORAGE_KEY = 'acopio_correccion_perdidas_v1_ejecutada';
  
  useEffect(() => {
    // Evitar m√∫ltiples ejecuciones en desarrollo (React StrictMode)
    if (ejecutadoRef.current) return;
    ejecutadoRef.current = true;

    // Verificar si ya se ejecut√≥ anteriormente
    const yaEjecutado = localStorage.getItem(STORAGE_KEY);
    
    if (yaEjecutado === 'true') {
      console.log('‚úì Correcci√≥n retroactiva ya ejecutada previamente');
      return;
    }

    // Ejecutar correcci√≥n autom√°tica en background
    const ejecutarCorreccion = async () => {
      try {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë  üöÄ CORRECCI√ìN RETROACTIVA AUTOM√ÅTICA - INICIANDO...            ‚ïë');
        console.log('‚ïë     ‚Ä¢ P√©rdidas de Productos (B√°scula/Calidad)                   ‚ïë');
        console.log('‚ïë     ‚Ä¢ Stocks de Envases (Ocupados/Vac√≠os)                       ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

        // Ejecutar AMBAS correcciones en paralelo
        const [resultadoPerdidas, resultadoEnvases] = await Promise.all([
          correccionRetroactivaPerdidas(base44),
          correccionRetroactivaEnvases(base44)
        ]);

        // Marcar como ejecutado en localStorage
        localStorage.setItem(STORAGE_KEY, 'true');
        localStorage.setItem(STORAGE_KEY + '_fecha', new Date().toISOString());
        localStorage.setItem(STORAGE_KEY + '_resultado', JSON.stringify({
          productos: {
            corregidos: resultadoPerdidas.corregidos,
            perdidasTotales: resultadoPerdidas.perdidasTotales,
            kgAjustados: resultadoPerdidas.kgAjustados
          },
          envases: {
            corregidos: resultadoEnvases.corregidos,
            unidadesAjustadas: resultadoEnvases.unidadesAjustadas
          }
        }));

        // Invalidar queries para refrescar datos en toda la app
        queryClient.invalidateQueries({ queryKey: ['productos'] });
        queryClient.invalidateQueries({ queryKey: ['movimientos'] });
        queryClient.invalidateQueries({ queryKey: ['salidas'] });
        queryClient.invalidateQueries({ queryKey: ['envases'] });

        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë  ‚úÖ CORRECCI√ìN RETROACTIVA AUTOM√ÅTICA COMPLETADA                 ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log(`   üì¶ PRODUCTOS:`);
        console.log(`      ‚Ä¢ Corregidos: ${resultadoPerdidas.corregidos}`);
        console.log(`      ‚Ä¢ P√©rdidas Definitivas: ${resultadoPerdidas.perdidasTotales?.toFixed(2)} kg`);
        console.log(`      ‚Ä¢ Kg Ajustados: ${resultadoPerdidas.kgAjustados?.toFixed(2)} kg`);
        console.log(`   `);
        console.log(`   üì¶ ENVASES:`);
        console.log(`      ‚Ä¢ Corregidos: ${resultadoEnvases.corregidos}`);
        console.log(`      ‚Ä¢ Unidades Ajustadas: ${resultadoEnvases.unidadesAjustadas}`);
        console.log(`   `);
        console.log(`   üìÖ Fecha: ${new Date().toLocaleString()}`);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

      } catch (error) {
        console.error('\n‚ùå ERROR EN CORRECCI√ìN RETROACTIVA AUTOM√ÅTICA:', error);
        // No marcar como ejecutado si fall√≥, para que reintente en pr√≥xima carga
      }
    };

    // Ejecutar despu√©s de un peque√±o delay para no bloquear renderizado inicial
    const timer = setTimeout(() => {
      ejecutarCorreccion();
    }, 2000);

    return () => clearTimeout(timer);
  }, [queryClient]);
}

/**
 * Funci√≥n para resetear la correcci√≥n (solo para testing/debugging)
 * No usar en producci√≥n
 */
export function resetCorreccionRetroactiva() {
  const STORAGE_KEY = 'acopio_correccion_perdidas_v1_ejecutada';
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(STORAGE_KEY + '_fecha');
  localStorage.removeItem(STORAGE_KEY + '_resultado');
  console.log('üîÑ Correcci√≥n retroactiva reseteada - se ejecutar√° en pr√≥xima carga');
}

/**
 * Funci√≥n para verificar el estado de la correcci√≥n
 */
export function obtenerEstadoCorreccion() {
  const STORAGE_KEY = 'acopio_correccion_perdidas_v1_ejecutada';
  const ejecutada = localStorage.getItem(STORAGE_KEY) === 'true';
  const fecha = localStorage.getItem(STORAGE_KEY + '_fecha');
  const resultadoStr = localStorage.getItem(STORAGE_KEY + '_resultado');
  
  let resultado = null;
  if (resultadoStr) {
    try {
      resultado = JSON.parse(resultadoStr);
    } catch (e) {
      // Ignorar error de parsing
    }
  }

  return {
    ejecutada,
    fecha: fecha ? new Date(fecha) : null,
    resultado
  };
}
</file>

<file path="src/components/hooks/useCorreccionCuentaCorriente.jsx">
import { useEffect, useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';

export function useCorreccionCuentaCorriente() {
  const [ejecutado, setEjecutado] = useState(false);

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-created_date', 1000),
    enabled: true,
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-created_date', 1000),
    enabled: true,
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios'],
    queryFn: () => base44.entities.PeriodoPrecio.list('-created_date', 100),
    enabled: true,
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  useEffect(() => {
    // Verificar localStorage primero
    const STORAGE_KEY = 'correccion_cuenta_corriente_completa_v2';
    const yaEjecutado = localStorage.getItem(STORAGE_KEY);
    if (yaEjecutado) {
      setEjecutado(true);
      return;
    }

    // Esperar a que todos los datos est√©n disponibles
    if (ejecutado) return;
    if (!movimientos || !salidas || !periodosPrecios) return;
    
    // Ejecutar incluso si no hay precios, para setear estados
    const hayDatos = movimientos.length > 0 || salidas.length > 0;
    if (!hayDatos) return;

    const corregirCuentaCorriente = async () => {
      console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üîÑ CORRECCI√ìN RETROACTIVA - CUENTA CORRIENTE');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

      try {
        // Funci√≥n para obtener precio vigente en una fecha
        const obtenerPrecioVigente = (productoId, fecha, tipoPrecio) => {
          const preciosOrdenados = periodosPrecios
            .filter(pp => pp.producto_id === productoId && pp.activo)
            .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
          
          const fechaMovimiento = new Date(fecha);
          const precioVigente = preciosOrdenados.find(pp => new Date(pp.fecha_desde) <= fechaMovimiento);
          
          if (precioVigente) {
            return tipoPrecio === 'compra' ? precioVigente.precio_compra_kg : precioVigente.precio_venta_kg;
          }
          
          // Si no hay precio vigente, usar el m√°s reciente
          const precioMasReciente = preciosOrdenados[0];
          return precioMasReciente ? 
            (tipoPrecio === 'compra' ? precioMasReciente.precio_compra_kg : precioMasReciente.precio_venta_kg) : 0;
        };

        let ingresosActualizados = 0;
        let salidasActualizadas = 0;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PROCESAR INGRESOS DE FRUTA (Deudas con proveedores)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        console.log('üì• Procesando Ingresos de Fruta...\n');
        
        for (const movimiento of movimientos) {
          if (movimiento.tipo_movimiento === 'Ingreso de Fruta' && movimiento.pesajes && movimiento.pesajes.length > 0) {
            // Verificar si ya tiene deuda_total calculada
            if (movimiento.deuda_total && movimiento.deuda_total > 0) {
              console.log(`   ‚è≠Ô∏è  ${movimiento.proveedor_nombre}: Ya tiene deuda calculada = $${movimiento.deuda_total.toFixed(2)}\n`);
              continue;
            }

            let deudaTotal = 0;
            
            movimiento.pesajes.forEach(pesaje => {
              const precioCompra = obtenerPrecioVigente(pesaje.producto_id, movimiento.fecha, 'compra');
              const deudaPesaje = pesaje.peso_neto * precioCompra;
              deudaTotal += deudaPesaje;
              
              console.log(`   ${pesaje.producto_nombre}: ${pesaje.peso_neto.toFixed(2)} kg √ó $${precioCompra.toFixed(2)} = $${deudaPesaje.toFixed(2)}`);
            });

            // Actualizar movimiento con deuda total y estado
            await base44.entities.Movimiento.update(movimiento.id, {
              deuda_total: deudaTotal,
              estado_pago: movimiento.estado_pago || 'Pendiente',
              monto_pagado: movimiento.monto_pagado || 0
            });
            
            console.log(`   ‚úÖ ${movimiento.proveedor_nombre}: Deuda Total = $${deudaTotal.toFixed(2)}\n`);
            ingresosActualizados++;
          }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PROCESAR SALIDAS DE FRUTA (Deudas de clientes)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        console.log('\nüì§ Procesando Salidas de Fruta...\n');
        
        for (const salida of salidas) {
          if (salida.estado === 'Confirmada' && salida.detalles && salida.detalles.length > 0) {
            // Verificar si ya tiene deuda_total calculada
            if (salida.deuda_total && salida.deuda_total > 0) {
              console.log(`   ‚è≠Ô∏è  ${salida.cliente_nombre} - ${salida.numero_remito}: Ya tiene deuda calculada = $${salida.deuda_total.toFixed(2)}\n`);
              continue;
            }

            let deudaTotal = 0;
            
            salida.detalles.forEach(detalle => {
              const kilosEfectivos = (detalle.kilos_reales || detalle.kilos_salida || 0) - (detalle.descuento_kg || 0);
              const precioVenta = detalle.precio_kg || obtenerPrecioVigente(detalle.producto_id, salida.fecha, 'venta');
              const deudaDetalle = kilosEfectivos * precioVenta;
              deudaTotal += deudaDetalle;
              
              console.log(`   ${detalle.producto_nombre}: ${kilosEfectivos.toFixed(2)} kg √ó $${precioVenta.toFixed(2)} = $${deudaDetalle.toFixed(2)}`);
            });

            // Actualizar salida con deuda total y estado
            const updates = {
              deuda_total: deudaTotal,
              estado_cobro: salida.estado_cobro || 'Pendiente',
              monto_cobrado: salida.monto_cobrado || 0
            };

            await base44.entities.SalidaFruta.update(salida.id, updates);
            
            console.log(`   ‚úÖ ${salida.cliente_nombre} - ${salida.numero_remito}: Deuda Total = $${deudaTotal.toFixed(2)}\n`);
            salidasActualizadas++;
          }
        }

        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úÖ CORRECCI√ìN COMPLETADA');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`   Ingresos actualizados: ${ingresosActualizados}`);
        console.log(`   Salidas actualizadas: ${salidasActualizadas}`);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PASO 2: CREAR MOVIMIENTOS EN CUENTA CORRIENTE RETROACTIVAMENTE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        console.log('\nüîÑ GENERANDO MOVIMIENTOS DE CUENTA CORRIENTE RETROACTIVOS...\n');

        // Obtener movimientos de CC existentes
        const movimientosCC = await base44.entities.CuentaCorriente.list();
        let movimientosCCCreados = 0;

        // INGRESOS DE FRUTA ‚Üí CUENTA CORRIENTE PROVEEDORES
        for (const movimiento of movimientos.filter(m => m.tipo_movimiento === 'Ingreso de Fruta')) {
          if (!movimiento.proveedor_id || !movimiento.deuda_total || movimiento.deuda_total <= 0) continue;

          // Verificar si ya existe un movimiento de CC para este ingreso
          const yaExiste = movimientosCC.some(
            cc => cc.comprobante_tipo === 'IngresoFruta' && cc.comprobante_id === movimiento.id
          );

          if (!yaExiste) {
            await base44.entities.CuentaCorriente.create({
              fecha: movimiento.fecha,
              tipo_movimiento: 'Haber',
              entidad_tipo: 'Proveedor',
              entidad_id: movimiento.proveedor_id,
              entidad_nombre: movimiento.proveedor_nombre,
              monto: movimiento.deuda_total,
              saldo_resultante: 0,
              concepto: `Ingreso de fruta - ${new Date(movimiento.fecha).toLocaleDateString('es-AR')}`,
              comprobante_id: movimiento.id,
              comprobante_tipo: 'IngresoFruta'
            });
            movimientosCCCreados++;
            console.log(`‚úÖ CC Proveedor: ${movimiento.proveedor_nombre} - $${movimiento.deuda_total.toFixed(2)}`);
          }
        }

        // SALIDAS DE FRUTA ‚Üí CUENTA CORRIENTE CLIENTES
        for (const salida of salidas) {
          if (!salida.cliente_id || !salida.deuda_total || salida.deuda_total <= 0) continue;

          // Verificar si ya existe un movimiento de CC para esta salida
          const yaExiste = movimientosCC.some(
            cc => cc.comprobante_tipo === 'SalidaFruta' && cc.comprobante_id === salida.id
          );

          if (!yaExiste) {
            await base44.entities.CuentaCorriente.create({
              fecha: salida.fecha,
              tipo_movimiento: 'Haber',
              entidad_tipo: 'Cliente',
              entidad_id: salida.cliente_id,
              entidad_nombre: salida.cliente_nombre,
              monto: salida.deuda_total,
              saldo_resultante: 0,
              concepto: `Salida de fruta - ${salida.numero_remito}`,
              comprobante_id: salida.id,
              comprobante_tipo: 'SalidaFruta'
            });
            movimientosCCCreados++;
            console.log(`‚úÖ CC Cliente: ${salida.cliente_nombre} - $${salida.deuda_total.toFixed(2)}`);
          }
        }

        console.log(`\nüìä Movimientos de CC creados: ${movimientosCCCreados}`);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PASO 3: RECALCULAR SALDOS RESULTANTES EN ORDEN CRONOL√ìGICO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        console.log('\nüßÆ RECALCULANDO SALDOS RESULTANTES...\n');

        const todosLosMovCC = await base44.entities.CuentaCorriente.list();
        
        // Agrupar por entidad (proveedor o cliente)
        const porEntidad = {};
        todosLosMovCC.forEach(mov => {
          const key = `${mov.entidad_tipo}-${mov.entidad_id}`;
          if (!porEntidad[key]) {
            porEntidad[key] = [];
          }
          porEntidad[key].push(mov);
        });

        // Recalcular saldos para cada entidad
        for (const [key, movs] of Object.entries(porEntidad)) {
          // Ordenar por fecha
          const movsOrdenados = movs.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
          
          let saldoAcumulado = 0;
          for (const mov of movsOrdenados) {
            if (mov.tipo_movimiento === 'Haber') {
              saldoAcumulado += mov.monto;
            } else {
              saldoAcumulado -= mov.monto;
            }
            
            await base44.entities.CuentaCorriente.update(mov.id, {
              saldo_resultante: saldoAcumulado
            });
          }
          
          console.log(`‚úÖ ${key}: Saldo final = $${saldoAcumulado.toFixed(2)}`);
        }

        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

        // Guardar en localStorage
        localStorage.setItem('correccion_cuenta_corriente_completa_v2', JSON.stringify({
          fecha: new Date().toISOString(),
          ingresosActualizados,
          salidasActualizadas,
          movimientosCCCreados
        }));

        setEjecutado(true);
      } catch (error) {
        console.error('‚ùå Error en correcci√≥n de cuenta corriente:', error);
      }
    };

    corregirCuentaCorriente();
  }, [movimientos, salidas, periodosPrecios, ejecutado]);

  return ejecutado;
}
</file>

<file path="src/components/hooks/useCorreccionEnvasesRetroactiva.jsx">
import { useEffect, useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQueryClient } from '@tanstack/react-query';
import { correccionRetroactivaEnvases } from '../utils/correccionRetroactivaEnvases';

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * HOOK: CORRECCI√ìN AUTOM√ÅTICA RETROACTIVA DE ENVASES (EJECUCI√ìN √öNICA)
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Ejecuta correcci√≥n retroactiva de stocks de envases al cargar la app,
 * asegurando que TODOS los registros hist√≥ricos se procesen correctamente
 * seg√∫n l√≥gica de checkboxes independientes (tildado=ocupados, destildado=vac√≠os)
 */
export function useCorreccionEnvasesRetroactiva() {
  const queryClient = useQueryClient();
  const [ejecutando, setEjecutando] = useState(false);
  const [ejecutado, setEjecutado] = useState(false);

  useEffect(() => {
    const STORAGE_KEY = 'correccion_envases_retroactiva_v4';
    
    const ejecutarCorreccion = async () => {
      // Verificar si ya se ejecut√≥
      const yaEjecutado = localStorage.getItem(STORAGE_KEY);
      if (yaEjecutado) {
        console.log('‚úÖ Correcci√≥n retroactiva de envases ya ejecutada anteriormente');
        setEjecutado(true);
        return;
      }

      setEjecutando(true);
      console.log('üîÑ Iniciando correcci√≥n retroactiva de envases...');

      try {
        const resultado = await correccionRetroactivaEnvases(base44);
        
        // Marcar como ejecutado con timestamp y resultado
        const infoEjecucion = {
          fecha: new Date().toISOString(),
          envasesCorregidos: resultado.corregidos,
          unidadesAjustadas: resultado.unidadesAjustadas,
          version: 'v4'
        };
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(infoEjecucion));
        
        // Invalidar queries para refrescar datos en toda la app
        queryClient.invalidateQueries({ queryKey: ['envases'] });
        queryClient.invalidateQueries({ queryKey: ['movimientos'] });
        queryClient.invalidateQueries({ queryKey: ['salidas'] });
        
        console.log('‚úÖ Correcci√≥n retroactiva de envases completada exitosamente');
        setEjecutado(true);
      } catch (error) {
        console.error('‚ùå Error en correcci√≥n retroactiva de envases:', error);
        // No marcar como ejecutado para reintentar en pr√≥xima carga
      } finally {
        setEjecutando(false);
      }
    };

    ejecutarCorreccion();
  }, [queryClient]);

  return { ejecutando, ejecutado };
}

/**
 * Resetea el flag de ejecuci√≥n (√∫til para testing o re-ejecutar manualmente)
 */
export function resetCorreccionEnvasesRetroactiva() {
  localStorage.removeItem('correccion_envases_retroactiva_v2');
  localStorage.removeItem('correccion_envases_retroactiva_v3');
  localStorage.removeItem('correccion_envases_retroactiva_v4');
  console.log('üîÑ Flag de correcci√≥n retroactiva de envases reseteado');
}

/**
 * Obtiene el estado actual de la correcci√≥n retroactiva
 */
export function obtenerEstadoCorreccionEnvases() {
  const info = localStorage.getItem('correccion_envases_retroactiva_v4');
  if (!info) {
    return { ejecutado: false, detalles: null };
  }
  
  try {
    const detalles = JSON.parse(info);
    return { ejecutado: true, detalles };
  } catch {
    return { ejecutado: false, detalles: null };
  }
}
</file>

<file path="src/components/hooks/useCorreccionPreciosSalidas.jsx">
import { useEffect, useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';

export function useCorreccionPreciosSalidas() {
  const [ejecutado, setEjecutado] = useState(false);

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-created_date', 1000),
    enabled: true,
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios'],
    queryFn: () => base44.entities.PeriodoPrecio.list('-created_date', 100),
    enabled: true,
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  useEffect(() => {
    const STORAGE_KEY = 'correccion_precios_salidas_v1';
    const yaEjecutado = localStorage.getItem(STORAGE_KEY);
    if (yaEjecutado) {
      setEjecutado(true);
      return;
    }

    if (ejecutado) return;
    if (!salidas || salidas.length === 0 || !periodosPrecios) return;

    const corregirPreciosSalidas = async () => {
      console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üí∞ CORRECCI√ìN RETROACTIVA - PRECIOS EN SALIDAS Y CUENTA CORRIENTE');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

      try {
        const obtenerPrecioVigente = (productoId, fecha) => {
          const preciosOrdenados = periodosPrecios
            .filter(pp => pp.producto_id === productoId && pp.activo)
            .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
          
          const fechaSalida = new Date(fecha);
          const precioVigente = preciosOrdenados.find(pp => {
            const desde = new Date(pp.fecha_desde);
            const hasta = pp.fecha_hasta ? new Date(pp.fecha_hasta) : new Date('2099-12-31');
            return fechaSalida >= desde && fechaSalida <= hasta;
          });
          
          return precioVigente?.precio_venta_kg || 0;
        };

        let salidasActualizadas = 0;
        let movimientosCCActualizados = 0;

        // Procesar solo salidas confirmadas
        const salidasConfirmadas = salidas.filter(s => s.estado === 'Confirmada');

        for (const salida of salidasConfirmadas) {
          if (!salida.detalles || salida.detalles.length === 0) continue;

          let deudaTotalNueva = 0;
          let necesitaActualizacion = false;
          
          const detallesActualizados = salida.detalles.map(d => {
            const precioVigente = obtenerPrecioVigente(d.producto_id, salida.fecha);
            const kilosEfectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
            const deuda = kilosEfectivos * precioVigente;
            deudaTotalNueva += deuda;

            // Verificar si el precio cambi√≥
            if (d.precio_kg !== precioVigente) {
              necesitaActualizacion = true;
              console.log(`   ${salida.numero_remito} - ${d.producto_nombre}:`);
              console.log(`      Precio anterior: $${(d.precio_kg || 0).toFixed(2)}/kg`);
              console.log(`      Precio vigente: $${precioVigente.toFixed(2)}/kg`);
              console.log(`      Kilos efectivos: ${kilosEfectivos.toFixed(2)} kg`);
              console.log(`      Deuda: $${deuda.toFixed(2)}\n`);
            }

            return {
              ...d,
              precio_kg: precioVigente
            };
          });

          if (necesitaActualizacion || salida.deuda_total !== deudaTotalNueva) {
            // Actualizar salida con nuevos precios y deuda
            await base44.entities.SalidaFruta.update(salida.id, {
              detalles: detallesActualizados,
              deuda_total: deudaTotalNueva
            });

            console.log(`   ‚úÖ ${salida.numero_remito}: Deuda actualizada de $${(salida.deuda_total || 0).toFixed(2)} ‚Üí $${deudaTotalNueva.toFixed(2)}\n`);
            salidasActualizadas++;

            // Actualizar movimiento de cuenta corriente si existe
            const movimientosCC = await base44.entities.CuentaCorriente.filter({
              comprobante_tipo: 'SalidaFruta',
              comprobante_id: salida.id
            });

            if (movimientosCC.length > 0) {
              const movCC = movimientosCC[0];
              const diferencia = deudaTotalNueva - (movCC.monto || 0);
              
              if (Math.abs(diferencia) > 0.01) {
                await base44.entities.CuentaCorriente.update(movCC.id, {
                  monto: deudaTotalNueva,
                  saldo_resultante: (movCC.saldo_resultante || 0) + diferencia
                });
                
                console.log(`   ‚úÖ Cuenta Corriente actualizada: ${salida.cliente_nombre} - $${deudaTotalNueva.toFixed(2)}`);
                movimientosCCActualizados++;
              }
            }
          }
        }

        // ELIMINAR DUPLICADOS Y RECALCULAR SALDOS
        console.log('\nüóëÔ∏è LIMPIANDO DUPLICADOS EN CUENTA CORRIENTE...\n');

        const todosLosMovCC = await base44.entities.CuentaCorriente.list();
        
        // Detectar y eliminar duplicados (mismo comprobante_id + comprobante_tipo)
        const movimientosUnicos = new Map();
        const duplicadosAEliminar = [];

        for (const mov of todosLosMovCC) {
          if (mov.comprobante_id && mov.comprobante_tipo === 'SalidaFruta') {
            const key = `${mov.comprobante_tipo}-${mov.comprobante_id}`;
            if (movimientosUnicos.has(key)) {
              // Ya existe, este es un duplicado
              duplicadosAEliminar.push(mov.id);
              console.log(`   üóëÔ∏è Duplicado detectado: ${mov.concepto} (${mov.id})`);
            } else {
              movimientosUnicos.set(key, mov);
            }
          } else {
            // Movimientos sin comprobante o de otro tipo, conservar
            movimientosUnicos.set(mov.id, mov);
          }
        }

        // Eliminar duplicados
        for (const id of duplicadosAEliminar) {
          await base44.entities.CuentaCorriente.delete(id);
          console.log(`   ‚úÖ Eliminado duplicado: ${id}`);
        }

        console.log(`\nüìä Total duplicados eliminados: ${duplicadosAEliminar.length}\n`);

        // Obtener movimientos limpios
        const movimientosLimpios = await base44.entities.CuentaCorriente.list();
        
        // Agrupar por cliente y recalcular saldos
        console.log('üßÆ RECALCULANDO SALDOS RESULTANTES...\n');
        
        const porCliente = {};
        movimientosLimpios.forEach(mov => {
          if (mov.entidad_tipo === 'Cliente') {
            const key = mov.entidad_id;
            if (!porCliente[key]) {
              porCliente[key] = [];
            }
            porCliente[key].push(mov);
          }
        });

        for (const [clienteId, movs] of Object.entries(porCliente)) {
          const movsOrdenados = movs.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
          
          let saldoAcumulado = 0;
          for (const mov of movsOrdenados) {
            if (mov.tipo_movimiento === 'Haber') {
              saldoAcumulado += mov.monto;
            } else {
              saldoAcumulado -= mov.monto;
            }
            
            await base44.entities.CuentaCorriente.update(mov.id, {
              saldo_resultante: saldoAcumulado
            });
          }
          
          const nombreCliente = movsOrdenados[0]?.entidad_nombre || 'Desconocido';
          console.log(`‚úÖ ${nombreCliente}: Saldo final = $${saldoAcumulado.toFixed(2)}`);
        }

        console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úÖ CORRECCI√ìN COMPLETADA');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`   Salidas actualizadas: ${salidasActualizadas}`);
        console.log(`   Movimientos CC actualizados: ${movimientosCCActualizados}`);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          fecha: new Date().toISOString(),
          salidasActualizadas,
          movimientosCCActualizados
        }));

        setEjecutado(true);
      } catch (error) {
        console.error('‚ùå Error en correcci√≥n de precios:', error);
      }
    };

    corregirPreciosSalidas();
  }, [salidas, periodosPrecios, ejecutado]);

  return ejecutado;
}
</file>

<file path="src/components/hooks/useCorreccionSegregacionEnvases.jsx">
import { useEffect, useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQueryClient } from '@tanstack/react-query';

/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * CORRECCI√ìN RETROACTIVA - SEGREGACI√ìN COMPLETA DE ENVASES
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * NUEVA L√ìGICA IMPLEMENTADA:
 * 
 * 1. ENVASES OCUPADOS (con fruta):
 *    - Ingreso de Fruta: campo "cantidad_envases_llenos" ‚Üí SUMA a stock_ocupados
 *    - Salida de Fruta: campo "cantidad_envases_llenos" ‚Üí RESTA de stock_ocupados
 * 
 * 2. ENVASES VAC√çOS (sin fruta):
 *    - Movimiento de Envases: movimiento_envases[] con ingreso/salida ‚Üí SUMA/RESTA stock_vacios
 * 
 * 3. SEPARACI√ìN TOTAL:
 *    - Ya NO hay checkboxes mezclados
 *    - Movimiento de Envases solo maneja vac√≠os
 *    - Ingreso/Salida de Fruta solo maneja llenos
 * 
 * Este script recalcula TODOS los stocks desde cero aplicando la nueva l√≥gica.
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 */

export function useCorreccionSegregacionEnvases() {
  const [ejecutando, setEjecutando] = useState(false);
  const [ejecutado, setEjecutado] = useState(false);
  const queryClient = useQueryClient();

  useEffect(() => {
    const ejecutarCorreccion = async () => {
      const STORAGE_KEY = 'correccion_segregacion_envases_ejecutada_v1';
      
      // Verificar si ya se ejecut√≥
      const yaEjecutado = localStorage.getItem(STORAGE_KEY);
      if (yaEjecutado) {
        setEjecutado(true);
        return;
      }

      // Solo ejecutar una vez
      if (ejecutando || ejecutado) return;

      setEjecutando(true);
      console.log('\nüîß INICIANDO CORRECCI√ìN RETROACTIVA - SEGREGACI√ìN DE ENVASES\n');

      try {
        // Obtener todos los datos necesarios
        const [envases, movimientos, salidas] = await Promise.all([
          base44.entities.Envase.list(),
          base44.entities.Movimiento.list(),
          base44.entities.SalidaFruta.list()
        ]);

        // Crear mapa de stocks recalculados
        const stocksRecalculados = {};
        envases.forEach(env => {
          stocksRecalculados[env.id] = {
            tipo: env.tipo,
            ocupados: 0,
            vacios: 0
          };
        });

        // Combinar y ordenar cronol√≥gicamente
        const todosLosRegistros = [
          ...movimientos.map(m => ({ ...m, tipo_registro: 'movimiento', fecha: new Date(m.fecha) })),
          ...salidas.map(s => ({ ...s, tipo_registro: 'salida', fecha: new Date(s.fecha) }))
        ].sort((a, b) => a.fecha - b.fecha);

        console.log(`üìä Total registros a procesar: ${todosLosRegistros.length}`);
        console.log(`üì¶ Total envases: ${envases.length}\n`);

        // Procesar cronol√≥gicamente
        todosLosRegistros.forEach((registro) => {
          if (registro.tipo_registro === 'movimiento') {
            if (registro.tipo_movimiento === 'Ingreso de Fruta') {
              // INGRESO DE FRUTA: cantidad_envases_llenos ‚Üí stock_ocupados
              const cantLlenos = parseInt(registro.cantidad_envases_llenos) || 0;
              if (cantLlenos > 0) {
                // Distribuir proporcionalmente entre los envases usados en pesajes
                const envasesUsados = {};
                registro.pesajes?.forEach(p => {
                  if (p.envase_id) {
                    envasesUsados[p.envase_id] = (envasesUsados[p.envase_id] || 0) + (p.cantidad || 1);
                  }
                });
                
                const totalUnidades = Object.values(envasesUsados).reduce((sum, cant) => sum + cant, 0);
                
                if (totalUnidades > 0) {
                  Object.entries(envasesUsados).forEach(([envaseId, unidades]) => {
                    if (stocksRecalculados[envaseId]) {
                      const proporcion = unidades / totalUnidades;
                      const asignados = Math.round(cantLlenos * proporcion);
                      stocksRecalculados[envaseId].ocupados += asignados;
                    }
                  });
                }
              }
            } else if (registro.tipo_movimiento === 'Movimiento de Envases') {
              // MOVIMIENTO DE ENVASES: solo afecta stock_vacios
              registro.movimiento_envases?.forEach(mv => {
                if (stocksRecalculados[mv.envase_id]) {
                  const ingreso = parseInt(mv.cantidad_ingreso) || 0;
                  const salida = parseInt(mv.cantidad_salida) || 0;
                  stocksRecalculados[mv.envase_id].vacios += ingreso - salida;
                }
              });
            }
          } else if (registro.tipo_registro === 'salida') {
            // SALIDA DE FRUTA: cantidad_envases_llenos ‚Üí resta stock_ocupados
            const cantLlenos = parseInt(registro.cantidad_envases_llenos) || 0;
            if (cantLlenos > 0) {
              // Distribuir proporcionalmente
              const productosEnSalida = registro.detalles?.length || 1;
              const porProducto = Math.floor(cantLlenos / productosEnSalida);
              
              // Simplificaci√≥n: restar del primer envase usado (o distribuir)
              // En producci√≥n real, ser√≠a mejor tener tracking expl√≠cito
              const primerEnvase = envases[0];
              if (primerEnvase && stocksRecalculados[primerEnvase.id]) {
                stocksRecalculados[primerEnvase.id].ocupados -= cantLlenos;
              }
            }
          }
        });

        // Aplicar correcciones solo donde haya diferencias
        let corregidos = 0;
        const detalleCorrecciones = [];

        for (const envase of envases) {
          const recalculado = stocksRecalculados[envase.id];
          const stockOcupadosActual = parseInt(envase.stock_ocupados) || 0;
          const stockVaciosActual = parseInt(envase.stock_vacios) || 0;

          // Prevenir negativos
          const nuevoOcupados = Math.max(0, recalculado.ocupados);
          const nuevoVacios = Math.max(0, recalculado.vacios);

          if (stockOcupadosActual !== nuevoOcupados || stockVaciosActual !== nuevoVacios) {
            await base44.entities.Envase.update(envase.id, {
              stock_ocupados: nuevoOcupados,
              stock_vacios: nuevoVacios
            });

            corregidos++;
            detalleCorrecciones.push({
              tipo: envase.tipo,
              antes: { ocupados: stockOcupadosActual, vacios: stockVaciosActual },
              despues: { ocupados: nuevoOcupados, vacios: nuevoVacios }
            });

            console.log(`‚úÖ ${envase.tipo}:`);
            console.log(`   Ocupados: ${stockOcupadosActual} ‚Üí ${nuevoOcupados} (${nuevoOcupados - stockOcupadosActual >= 0 ? '+' : ''}${nuevoOcupados - stockOcupadosActual})`);
            console.log(`   Vac√≠os: ${stockVaciosActual} ‚Üí ${nuevoVacios} (${nuevoVacios - stockVaciosActual >= 0 ? '+' : ''}${nuevoVacios - stockVaciosActual})\n`);
          }
        }

        console.log(`\n‚úÖ CORRECCI√ìN COMPLETADA`);
        console.log(`üì¶ Envases corregidos: ${corregidos}/${envases.length}`);
        console.log(`üìä Registros procesados: ${todosLosRegistros.length}\n`);

        // Guardar resultados en localStorage
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          fecha: new Date().toISOString(),
          corregidos,
          total: envases.length,
          detalles: detalleCorrecciones
        }));

        setEjecutado(true);

        // Invalidar queries
        queryClient.invalidateQueries(['envases']);
        queryClient.invalidateQueries(['movimientos']);
        queryClient.invalidateQueries(['salidas']);

      } catch (error) {
        console.error('‚ùå Error en correcci√≥n retroactiva:', error);
      } finally {
        setEjecutando(false);
      }
    };

    // Solo ejecutar una vez al montar
    ejecutarCorreccion();
  }, []); // Dependencias vac√≠as - solo ejecutar una vez

  return { ejecutando, ejecutado };
}

/**
 * Funci√≥n para resetear la correcci√≥n (solo desarrollo/testing)
 */
export function resetCorreccionSegregacion() {
  localStorage.removeItem('correccion_segregacion_envases_ejecutada_v1');
  console.log('üîÑ Correcci√≥n de segregaci√≥n reseteada');
}

/**
 * Obtener estado de la correcci√≥n
 */
export function obtenerEstadoCorreccionSegregacion() {
  const data = localStorage.getItem('correccion_segregacion_envases_ejecutada_v1');
  return data ? JSON.parse(data) : null;
}
</file>

<file path="src/components/hooks/usePaginatedQuery.jsx">
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';

// Hook para paginaci√≥n autom√°tica
export function usePaginatedQuery(queryKey, queryFn, pageSize = 50) {
  const [page, setPage] = useState(1);
  
  const { data, isLoading, error } = useQuery({
    queryKey: [...queryKey, page],
    queryFn: async () => {
      const skip = (page - 1) * pageSize;
      return queryFn(skip, pageSize);
    },
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  return {
    data: data || [],
    isLoading,
    error,
    page,
    setPage,
    pageSize,
    hasNextPage: data?.length === pageSize,
    hasPreviousPage: page > 1
  };
}
</file>

<file path="src/components/hooks/usePreciosCache.jsx">
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';

// Hook centralizado para cach√© de precios
export function usePreciosCache() {
  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios_cache'],
    queryFn: () => base44.entities.PeriodoPrecio.list('-fecha_desde', 500),
    staleTime: 30 * 60 * 1000, // 30 minutos
    refetchOnWindowFocus: false,
    refetchOnReconnect: true
  });

  const obtenerPrecioVigente = (productoId, fecha, tipoPrecio = 'compra') => {
    if (!productoId || !fecha) return 0;

    const preciosOrdenados = periodosPrecios
      .filter(pp => pp.producto_id === productoId && pp.activo)
      .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
    
    const fechaMovimiento = new Date(fecha);
    const precioVigente = preciosOrdenados.find(pp => new Date(pp.fecha_desde) <= fechaMovimiento);
    
    if (precioVigente) {
      return tipoPrecio === 'compra' ? precioVigente.precio_compra_kg : precioVigente.precio_venta_kg;
    }
    
    const precioMasReciente = preciosOrdenados[0];
    return precioMasReciente ? 
      (tipoPrecio === 'compra' ? precioMasReciente.precio_compra_kg : precioMasReciente.precio_venta_kg) : 0;
  };

  return { periodosPrecios, obtenerPrecioVigente };
}
</file>

<file path="src/components/inventario/AjusteManualEnvaseModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { AlertTriangle } from "lucide-react";
import { base44 } from '@/api/base44Client';
import { ajustarStockEnvase } from '@/services/StockService';

export default function AjusteManualEnvaseModal({ 
  open, 
  onClose, 
  envase, 
  tipoAjuste, 
  stockActual,
  onSuccess 
}) {
  const [stockNuevo, setStockNuevo] = useState(stockActual || 0);
  const [motivo, setMotivo] = useState('');
  const [notas, setNotas] = useState('');
  const [pin, setPin] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const diferencia = stockNuevo - stockActual;

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');

    if (!motivo.trim()) {
      setError('Debe ingresar un motivo para el ajuste');
      return;
    }

    if (!pin) {
      setError('Debe ingresar el PIN de seguridad');
      return;
    }

    setLoading(true);

    try {
      // Verificar PIN
      const configs = await base44.entities.Configuracion.filter({ clave: 'pin_seguridad' });
      
      if (!configs || configs.length === 0) {
        setError('No se ha configurado un PIN de seguridad. Por favor configure uno en Configuraci√≥n.');
        setLoading(false);
        return;
      }

      const pinCorrecto = configs[0].valor;
      
      if (pin !== pinCorrecto) {
        setError('PIN incorrecto');
        setLoading(false);
        return;
      }

      // Obtener usuario actual
      const user = await base44.auth.me();

      // Registrar ajuste manual en historial
      const ajuste = {
        fecha: new Date().toISOString(),
        envase_id: envase.id,
        envase_tipo: envase.tipo,
        tipo_ajuste: tipoAjuste,
        stock_anterior: stockActual,
        stock_nuevo: stockNuevo,
        diferencia: diferencia,
        motivo: motivo.trim(),
        usuario_email: user.email,
        notas: notas.trim() || null
      };

      await base44.entities.AjusteManualEnvase.create(ajuste);

      // Actualizar stock vivo del envase (incremental)
      const deltaOcupados = tipoAjuste === 'ocupados' ? diferencia : 0;
      const deltaVacios = tipoAjuste === 'vacios' ? diferencia : 0;
      if (deltaOcupados !== 0 || deltaVacios !== 0) {
        await ajustarStockEnvase(base44, envase.id, deltaOcupados, deltaVacios);
      }

      onSuccess();
      onClose();
    } catch (err) {
      console.error('Error al realizar ajuste:', err);
      setError('Error al realizar el ajuste. Intente nuevamente.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-amber-600" />
            Ajuste Manual de Envases
          </DialogTitle>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="p-4 bg-slate-100 rounded-lg space-y-2">
            <div className="flex justify-between">
              <span className="text-sm text-slate-600">Envase:</span>
              <span className="font-semibold">{envase?.tipo}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm text-slate-600">Tipo de Ajuste:</span>
              <span className={`font-semibold ${tipoAjuste === 'vacios' ? 'text-teal-600' : 'text-orange-600'}`}>
                {tipoAjuste === 'vacios' ? 'Envases Vac√≠os' : 'Envases Ocupados'}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm text-slate-600">Stock Actual:</span>
              <span className="font-bold">{stockActual}</span>
            </div>
          </div>

          <div className="space-y-2">
            <Label>Nuevo Stock *</Label>
            <Input
              type="number"
              value={stockNuevo}
              onChange={(e) => setStockNuevo(parseInt(e.target.value) || 0)}
              min="0"
              required
            />
            {diferencia !== 0 && (
              <p className={`text-sm ${diferencia > 0 ? 'text-green-600' : 'text-red-600'}`}>
                Diferencia: {diferencia > 0 ? '+' : ''}{diferencia} envases
              </p>
            )}
          </div>

          <div className="space-y-2">
            <Label>Motivo del Ajuste *</Label>
            <Input
              type="text"
              placeholder="Ej: Conteo f√≠sico, envases rotos, etc."
              value={motivo}
              onChange={(e) => setMotivo(e.target.value)}
              required
            />
          </div>

          <div className="space-y-2">
            <Label>Notas Adicionales</Label>
            <Textarea
              placeholder="Detalles adicionales del ajuste..."
              value={notas}
              onChange={(e) => setNotas(e.target.value)}
              rows={3}
            />
          </div>

          <div className="space-y-2">
            <Label>PIN de Seguridad *</Label>
            <Input
              type="password"
              placeholder="Ingrese el PIN"
              value={pin}
              onChange={(e) => setPin(e.target.value)}
              required
            />
          </div>

          {error && (
            <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-sm text-red-700">{error}</p>
            </div>
          )}

          <div className="flex gap-3 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              disabled={loading}
              className="flex-1"
            >
              Cancelar
            </Button>
            <Button
              type="submit"
              disabled={loading || diferencia === 0}
              className="flex-1 bg-indigo-600 hover:bg-indigo-700"
            >
              {loading ? 'Guardando...' : 'Confirmar Ajuste'}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/inventario/HistorialAjustesModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { TrendingUp, TrendingDown, Calendar, User, Trash2 } from 'lucide-react';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';
import { ajustarStockEnvase } from '@/services/StockService';

export default function HistorialAjustesModal({ open, onClose, ajustes = [], onDelete }) {
  const [eliminandoId, setEliminandoId] = useState(null);
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');

  const handleEliminar = async (ajuste) => {
    if (!pin) {
      setError('Debe ingresar el PIN de seguridad');
      return;
    }

    try {
      // Verificar PIN
      const configs = await base44.entities.Configuracion.filter({ clave: 'pin_seguridad' });
      
      if (!configs || configs.length === 0) {
        setError('No se ha configurado un PIN de seguridad');
        return;
      }

      if (pin !== configs[0].valor) {
        setError('PIN incorrecto');
        return;
      }

      // Revertir stock del envase (incremental inverso)
      const deltaOcupados = ajuste.tipo_ajuste === 'ocupados' ? -ajuste.diferencia : 0;
      const deltaVacios = ajuste.tipo_ajuste === 'vacios' ? -ajuste.diferencia : 0;
      if (deltaOcupados !== 0 || deltaVacios !== 0) {
        await ajustarStockEnvase(base44, ajuste.envase_id, deltaOcupados, deltaVacios);
      }

      await base44.entities.AjusteManualEnvase.delete(ajuste.id);
      
      toast.success('Ajuste eliminado correctamente');
      setEliminandoId(null);
      setPin('');
      setError('');
      
      if (onDelete) {
        onDelete();
      }
    } catch (err) {
      console.error('Error al eliminar ajuste:', err);
      setError('Error al eliminar el ajuste');
    }
  };

  const cancelarEliminacion = () => {
    setEliminandoId(null);
    setPin('');
    setError('');
  };
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Historial de Ajustes Manuales</DialogTitle>
        </DialogHeader>

        <div className="space-y-3">
          {ajustes.length === 0 ? (
            <div className="text-center py-8 text-slate-500">
              No hay ajustes manuales registrados
            </div>
          ) : (
            ajustes.map((ajuste) => (
              <div 
                key={ajuste.id} 
                className="p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors"
              >
                {eliminandoId === ajuste.id ? (
                  <div className="space-y-3">
                    <div className="p-3 bg-amber-50 border border-amber-200 rounded">
                      <p className="text-sm font-medium text-amber-900">
                        ¬øConfirmar eliminaci√≥n de este ajuste?
                      </p>
                      <p className="text-xs text-amber-700 mt-1">
                        Esto revertir√° el cambio de stock registrado
                      </p>
                    </div>
                    
                    <div>
                      <Input
                        type="password"
                        placeholder="Ingrese PIN de seguridad"
                        value={pin}
                        onChange={(e) => {
                          setPin(e.target.value);
                          setError('');
                        }}
                        className="text-sm"
                      />
                      {error && (
                        <p className="text-xs text-red-600 mt-1">{error}</p>
                      )}
                    </div>

                    <div className="flex gap-2">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={cancelarEliminacion}
                        className="flex-1"
                      >
                        Cancelar
                      </Button>
                      <Button
                        size="sm"
                        onClick={() => handleEliminar(ajuste)}
                        className="flex-1 bg-red-600 hover:bg-red-700"
                      >
                        Confirmar Eliminaci√≥n
                      </Button>
                    </div>
                  </div>
                ) : (
                  <>
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="font-semibold text-slate-800">
                            {ajuste.envase_tipo}
                          </span>
                          <span className={`px-2 py-0.5 text-xs rounded ${
                            ajuste.tipo_ajuste === 'vacios' 
                              ? 'bg-teal-100 text-teal-700' 
                              : 'bg-orange-100 text-orange-700'
                          }`}>
                            {ajuste.tipo_ajuste === 'vacios' ? 'Vac√≠os' : 'Ocupados'}
                          </span>
                        </div>

                        <div className="space-y-1 text-sm">
                          <div className="flex items-center gap-2 text-slate-600">
                            <Calendar className="h-3 w-3" />
                            {format(new Date(ajuste.fecha), "dd/MM/yyyy HH:mm", { locale: es })}
                          </div>
                          <div className="flex items-center gap-2 text-slate-600">
                            <User className="h-3 w-3" />
                            {ajuste.usuario_email}
                          </div>
                        </div>

                        <div className="mt-2 p-2 bg-slate-50 rounded text-sm">
                          <span className="text-slate-600">Motivo:</span>{' '}
                          <span className="font-medium">{ajuste.motivo}</span>
                        </div>

                        {ajuste.notas && (
                          <div className="mt-2 text-xs text-slate-600">
                            <span className="font-medium">Notas:</span> {ajuste.notas}
                          </div>
                        )}
                      </div>

                      <div className="flex flex-col items-end gap-2">
                        <div className="text-right">
                          <div className="text-xs text-slate-500 mb-1">Stock</div>
                          <div className="flex flex-col gap-1">
                            <div className="text-sm">
                              <span className="text-slate-600">Anterior:</span>{' '}
                              <span className="font-semibold">{ajuste.stock_anterior}</span>
                            </div>
                            <div className="flex items-center gap-1">
                              {ajuste.diferencia > 0 ? (
                                <TrendingUp className="h-4 w-4 text-green-600" />
                              ) : (
                                <TrendingDown className="h-4 w-4 text-red-600" />
                              )}
                              <span className={`font-bold ${
                                ajuste.diferencia > 0 ? 'text-green-600' : 'text-red-600'
                              }`}>
                                {ajuste.diferencia > 0 ? '+' : ''}{ajuste.diferencia}
                              </span>
                            </div>
                            <div className="text-sm">
                              <span className="text-slate-600">Nuevo:</span>{' '}
                              <span className="font-bold text-indigo-600">{ajuste.stock_nuevo}</span>
                            </div>
                          </div>
                        </div>

                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => setEliminandoId(ajuste.id)}
                          className="text-red-600 hover:text-red-700 hover:bg-red-50"
                        >
                          <Trash2 className="h-3 w-3 mr-1" />
                          Eliminar
                        </Button>
                      </div>
                    </div>
                  </>
                )}
              </div>
            ))
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/LiquidacionPDFGenerator.jsx">
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { commonPdfStyles, getLogoHTML } from '@/utils/pdfStyles';

/**
 * Genera el contenido HTML para el PDF de liquidaci√≥n de sueldo
 */
function generarHTMLLiquidacion(liquidacion, empleado) {
  const totalViajes = liquidacion.viajes?.length || 0;
  const totalKilos = liquidacion.viajes?.reduce((sum, v) => sum + (v.kilos_llevados || 0), 0) || 0;

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        ${commonPdfStyles}
        body { padding: 30px; max-width: 900px; }
        .header { border-bottom: 3px solid #3b82f6; }
        .header h1 { color: #1e293b; font-size: 28px; }
        .header h2 { color: #64748b; font-size: 18px; }
        .info-section { background: #f8fafc; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .section-title { font-size: 18px; color: #1e293b; margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
        th { background: #3b82f6; color: white; }
        .totals-box { background: #f1f5f9; }
        .total-row.final { margin-top: 15px; padding-top: 15px; border-top: 2px solid #cbd5e1; font-size: 20px; }
        .total-row.final .amount { color: #16a34a; }
      </style>
    </head>
    <body>
      <div class="header">
        ${getLogoHTML(80)}
        <h1>LIQUIDACI√ìN DE SUELDO</h1>
        <h2>Per√≠odo: ${liquidacion.periodo}</h2>
      </div>

      <div class="info-section">
        <div class="info-row">
          <span class="info-label">Empleado:</span>
          <span class="info-value">${liquidacion.empleado_nombre}</span>
        </div>
        <div class="info-row">
          <span class="info-label">CUIT/DNI:</span>
          <span class="info-value">${empleado?.cuit_dni || '-'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Fecha Liquidaci√≥n:</span>
          <span class="info-value">${format(new Date(liquidacion.fecha_liquidacion), 'dd/MM/yyyy', { locale: es })}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Fecha de Pago:</span>
          <span class="info-value">${format(new Date(liquidacion.fecha_pago), 'dd/MM/yyyy', { locale: es })}</span>
        </div>
      </div>

      ${liquidacion.viajes && liquidacion.viajes.length > 0 ? `
        <div class="section-title">Detalle de Viajes</div>
        <table>
          <thead>
            <tr>
              <th style="width: 12%;">Fecha</th>
              <th style="width: 28%;">Ida</th>
              <th style="width: 28%;">Vuelta</th>
              <th style="width: 12%; text-align: right;">Kilos</th>
              <th style="width: 20%; text-align: right;">Importe</th>
            </tr>
          </thead>
          <tbody>
            ${liquidacion.viajes.map(viaje => {
              let idaTexto = '';
              if (viaje.ida_opcion1 && viaje.ida_cantidad1) {
                idaTexto += `${viaje.ida_opcion1}: ${viaje.ida_cantidad1}`;
              }
              if (viaje.ida_opcion2 && viaje.ida_cantidad2) {
                idaTexto += (idaTexto ? '<br/>' : '') + `${viaje.ida_opcion2}: ${viaje.ida_cantidad2}`;
              }
              if (!idaTexto) idaTexto = '-';

              let vueltaTexto = '';
              if (viaje.vuelta_opcion1 && viaje.vuelta_cantidad1) {
                vueltaTexto += `${viaje.vuelta_opcion1}: ${viaje.vuelta_cantidad1}`;
              }
              if (viaje.vuelta_opcion2 && viaje.vuelta_cantidad2) {
                vueltaTexto += (vueltaTexto ? '<br/>' : '') + `${viaje.vuelta_opcion2}: ${viaje.vuelta_cantidad2}`;
              }
              if (!vueltaTexto) vueltaTexto = '-';

              return `
                <tr>
                  <td>${format(new Date(viaje.fecha_viaje), 'dd/MM/yyyy', { locale: es })}</td>
                  <td>${idaTexto}</td>
                  <td>${vueltaTexto}</td>
                  <td style="text-align: right;">${viaje.kilos_llevados || 0} kg</td>
                  <td style="text-align: right; font-weight: 600;">$${viaje.importe_viaje.toFixed(2)}</td>
                </tr>
              `;
            }).join('')}
            <tr style="background: #e0f2fe; font-weight: bold;">
              <td colspan="3">TOTALES</td>
              <td style="text-align: right;">${totalKilos.toFixed(2)} kg</td>
              <td style="text-align: right;">$${liquidacion.total_viajes.toFixed(2)}</td>
            </tr>
          </tbody>
        </table>
      ` : ''}

      <div class="totals-box">
        ${liquidacion.sueldo_base > 0 ? `
          <div class="total-row">
            <span>Sueldo Base:</span>
            <span class="amount">$${liquidacion.sueldo_base.toFixed(2)}</span>
          </div>
        ` : ''}
        ${liquidacion.total_viajes > 0 ? `
          <div class="total-row">
            <span>Total Viajes (${totalViajes} viajes):</span>
            <span class="amount">$${liquidacion.total_viajes.toFixed(2)}</span>
          </div>
        ` : ''}
        ${liquidacion.otros_conceptos > 0 ? `
          <div class="total-row">
            <span>Otros Conceptos:</span>
            <span class="amount">$${liquidacion.otros_conceptos.toFixed(2)}</span>
          </div>
        ` : ''}
        ${liquidacion.descuentos > 0 ? `
          <div class="total-row" style="color: #dc2626;">
            <span>Descuentos:</span>
            <span class="amount">-$${liquidacion.descuentos.toFixed(2)}</span>
          </div>
        ` : ''}
        <div class="total-row final">
          <span>TOTAL A PAGAR:</span>
          <span class="amount">$${liquidacion.total_liquidacion.toFixed(2)}</span>
        </div>
      </div>

      ${liquidacion.notas ? `
        <div class="section-title">Observaciones</div>
        <p style="color: #64748b; font-size: 14px; line-height: 1.6;">${liquidacion.notas}</p>
      ` : ''}

      <div class="footer">
        <p>Documento generado el ${format(new Date(), 'dd/MM/yyyy HH:mm', { locale: es })}</p>
      </div>
    </body>
    </html>
  `;
}

/**
 * Descarga el PDF de la liquidaci√≥n
 */
export function descargarPDFLiquidacion(liquidacion, empleado) {
  const html = generarHTMLLiquidacion(liquidacion, empleado);
  const ventana = window.open('', '_blank');
  ventana.document.write(html);
  ventana.document.close();
  
  setTimeout(() => {
    ventana.print();
  }, 250);
}

/**
 * Genera un resumen de texto para WhatsApp
 */
function generarTextoWhatsApp(liquidacion, empleado) {
  const totalViajes = liquidacion.viajes?.length || 0;
  const totalKilos = liquidacion.viajes?.reduce((sum, v) => sum + (v.kilos_llevados || 0), 0) || 0;

  let texto = `*LIQUIDACI√ìN DE SUELDO*\n\n`;
  texto += `üë§ Empleado: ${liquidacion.empleado_nombre}\n`;
  texto += `üìÖ Per√≠odo: ${liquidacion.periodo}\n`;
  texto += `üí∞ Fecha de Pago: ${format(new Date(liquidacion.fecha_pago), 'dd/MM/yyyy', { locale: es })}\n\n`;

  if (liquidacion.viajes && liquidacion.viajes.length > 0) {
    texto += `*DETALLE DE VIAJES:*\n`;
    texto += `Total viajes: ${totalViajes}\n`;
    texto += `Total kilos: ${totalKilos.toFixed(2)} kg\n`;
    texto += `Importe viajes: $${liquidacion.total_viajes.toFixed(2)}\n\n`;
  }

  texto += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  texto += `*LIQUIDACI√ìN:*\n`;
  
  if (liquidacion.sueldo_base > 0) {
    texto += `Sueldo Base: $${liquidacion.sueldo_base.toFixed(2)}\n`;
  }
  if (liquidacion.total_viajes > 0) {
    texto += `Total Viajes: $${liquidacion.total_viajes.toFixed(2)}\n`;
  }
  if (liquidacion.otros_conceptos > 0) {
    texto += `Otros Conceptos: $${liquidacion.otros_conceptos.toFixed(2)}\n`;
  }
  if (liquidacion.descuentos > 0) {
    texto += `Descuentos: -$${liquidacion.descuentos.toFixed(2)}\n`;
  }
  
  texto += `\n*TOTAL A PAGAR: $${liquidacion.total_liquidacion.toFixed(2)}*\n`;

  if (liquidacion.notas) {
    texto += `\nüìù Observaciones: ${liquidacion.notas}`;
  }

  return texto;
}

/**
 * Comparte la liquidaci√≥n por WhatsApp
 */
export function compartirWhatsAppLiquidacion(liquidacion, empleado, numero) {
  const texto = generarTextoWhatsApp(liquidacion, empleado);
  const textoEncoded = encodeURIComponent(texto);
  const url = `https://wa.me/${numero}?text=${textoEncoded}`;
  window.open(url, '_blank');
}
</file>

<file path="src/components/MovimientoEnvasesPDFGenerator.jsx">
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { commonPdfStyles, getLogoHTML } from '@/utils/pdfStyles';

/**
 * Genera el contenido HTML para el PDF de movimiento de envases
 */
function generarHTMLMovimientoEnvases(movimiento, entidad, fletero, saldos = []) {
  const tipoEntidad = movimiento.tipo_entidad || 'Proveedor';
  const nombreEntidad = entidad?.nombre || movimiento.proveedor_nombre || movimiento.cliente_nombre || 'Sin especificar';
  const nombreFletero = fletero?.nombre || movimiento.fletero_nombre || '-';

  const esIngreso = movimiento.movimiento_envases?.some(e => (e.cantidad_ingreso || 0) > 0);
  const esSalida = movimiento.movimiento_envases?.some(e => (e.cantidad_salida || 0) > 0);
  
  let tipoMovimiento = '';
  if (esIngreso && esSalida) tipoMovimiento = 'Ingreso y Salida de Envases Vac√≠os';
  else if (esIngreso) tipoMovimiento = 'Ingreso de Envases Vac√≠os';
  else if (esSalida) tipoMovimiento = 'Salida de Envases Vac√≠os';
  else tipoMovimiento = 'Movimiento de Envases';

  const totalIngreso = movimiento.movimiento_envases?.reduce((sum, e) => sum + (e.cantidad_ingreso || 0), 0) || 0;
  const totalSalida = movimiento.movimiento_envases?.reduce((sum, e) => sum + (e.cantidad_salida || 0), 0) || 0;

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        ${commonPdfStyles}
        .header { border-bottom: 3px solid #6366f1; }
        .header h1 { color: #1e293b; }
        .header h2 { color: #64748b; }
        .info-section { background: #f8fafc; }
        th { background: #6366f1; color: white; }
        .totals { background: #f1f5f9; }
        .notas { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .notas-title { color: #92400e; }
        .notas-text { color: #78350f; }
      </style>
    </head>
    <body>
      <div class="header">
        ${getLogoHTML(80)}
        <h1>MOVIMIENTO DE ENVASES</h1>
        <h2>${tipoMovimiento}</h2>
      </div>

      <div class="info-section">
        <div class="info-row">
          <span class="info-label">Fecha:</span>
          <span class="info-value">${format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es })}</span>
        </div>
        <div class="info-row">
          <span class="info-label">${tipoEntidad}:</span>
          <span class="info-value">${nombreEntidad}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Fletero:</span>
          <span class="info-value">${nombreFletero}</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 40%;">Tipo de Envase</th>
            <th style="width: 30%; text-align: right;">Ingreso (Vac√≠os)</th>
            <th style="width: 30%; text-align: right;">Salida (Vac√≠os)</th>
          </tr>
        </thead>
        <tbody>
          ${(movimiento.movimiento_envases || []).map(env => `
            <tr>
              <td><strong>${env.envase_tipo}</strong></td>
              <td style="text-align: right;">
                ${env.cantidad_ingreso > 0 ? `<span class="ingreso">+${env.cantidad_ingreso}</span>` : '-'}
              </td>
              <td style="text-align: right;">
                ${env.cantidad_salida > 0 ? `<span class="salida">-${env.cantidad_salida}</span>` : '-'}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <div class="totals">
        <div class="total-row">
          <span>Total Ingreso:</span>
          <span class="ingreso">+${totalIngreso} envases</span>
        </div>
        <div class="total-row">
          <span>Total Salida:</span>
          <span class="salida">-${totalSalida} envases</span>
        </div>
        <div class="total-row">
          <span>Balance Neto:</span>
          <span>${totalIngreso - totalSalida > 0 ? '+' : ''}${totalIngreso - totalSalida} envases</span>
        </div>
      </div>

      ${movimiento.notas ? `
        <div class="notas">
          <div class="notas-title">Notas:</div>
          <div class="notas-text">${movimiento.notas}</div>
        </div>
      ` : ''}

      ${saldos.length > 0 ? `
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #10b981;">
          <h3 style="color: #065f46; font-weight: 600; margin-bottom: 12px; font-size: 16px;">Saldo Actual de Envases - ${nombreEntidad}</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            ${saldos.map(s => `
              <div style="background: ${s.saldo > 0 ? '#fee2e2' : '#dcfce7'}; padding: 12px; border-radius: 6px; border: 1px solid ${s.saldo > 0 ? '#fca5a5' : '#86efac'};">
                <p style="font-size: 14px; color: ${s.saldo > 0 ? '#991b1b' : '#065f46'};">
                  <strong>${s.envase_tipo}:</strong><br>
                  ${s.saldo > 0 ? `Adeuda <strong>${s.saldo}</strong> envases` : '<strong>Sin deuda</strong>'}
                </p>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <div class="firma-section">
        <div class="firma-linea">
          <div></div>
          <p><strong>Firma y Aclaraci√≥n</strong></p>
          <p>${nombreEntidad}</p>
        </div>
      </div>

      <div class="footer">
        Comprobante generado el ${format(new Date(), 'dd/MM/yyyy HH:mm', { locale: es })}<br>
        Sistema de Gesti√≥n de Acopio
      </div>
    </body>
    </html>
  `;
}

/**
 * Descarga el PDF del movimiento de envases
 */
export function descargarPDFMovimientoEnvases(movimiento, entidad, fletero, saldos = []) {
  const html = generarHTMLMovimientoEnvases(movimiento, entidad, fletero, saldos);
  const ventana = window.open('', '_blank');
  ventana.document.write(html);
  ventana.document.close();
  
  setTimeout(() => {
    ventana.print();
  }, 250);
}

/**
 * Genera un resumen de texto para WhatsApp
 */
function generarTextoWhatsApp(movimiento, entidad) {
  const tipoEntidad = movimiento.tipo_entidad || 'Proveedor';
  const nombreEntidad = entidad?.nombre || movimiento.proveedor_nombre || movimiento.cliente_nombre || 'Sin especificar';
  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });

  const esIngreso = movimiento.movimiento_envases?.some(e => (e.cantidad_ingreso || 0) > 0);
  const esSalida = movimiento.movimiento_envases?.some(e => (e.cantidad_salida || 0) > 0);
  
  let tipoMovimiento = '';
  if (esIngreso && esSalida) tipoMovimiento = 'INGRESO Y SALIDA DE ENVASES VAC√çOS';
  else if (esIngreso) tipoMovimiento = 'INGRESO DE ENVASES VAC√çOS';
  else if (esSalida) tipoMovimiento = 'SALIDA DE ENVASES VAC√çOS';
  else tipoMovimiento = 'MOVIMIENTO DE ENVASES';

  let texto = `*${tipoMovimiento}*\n\n`;
  texto += `üìÖ Fecha: ${fecha}\n`;
  texto += `üë§ ${tipoEntidad}: ${nombreEntidad}\n\n`;
  texto += `*DETALLE DE ENVASES:*\n`;

  (movimiento.movimiento_envases || []).forEach(env => {
    texto += `\nüì¶ ${env.envase_tipo}\n`;
    if (env.cantidad_ingreso > 0) {
      texto += `   ‚úÖ Ingreso: +${env.cantidad_ingreso} vac√≠os\n`;
    }
    if (env.cantidad_salida > 0) {
      texto += `   ‚ùå Salida: -${env.cantidad_salida} vac√≠os\n`;
    }
  });

  const totalIngreso = movimiento.movimiento_envases?.reduce((sum, e) => sum + (e.cantidad_ingreso || 0), 0) || 0;
  const totalSalida = movimiento.movimiento_envases?.reduce((sum, e) => sum + (e.cantidad_salida || 0), 0) || 0;
  const balance = totalIngreso - totalSalida;

  texto += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  texto += `*TOTALES:*\n`;
  texto += `‚úÖ Total Ingreso: +${totalIngreso} envases\n`;
  texto += `‚ùå Total Salida: -${totalSalida} envases\n`;
  texto += `üìä Balance Neto: ${balance > 0 ? '+' : ''}${balance} envases\n`;

  if (movimiento.notas) {
    texto += `\nüìù Notas: ${movimiento.notas}`;
  }

  return texto;
}

/**
 * Comparte el movimiento de envases por WhatsApp
 */
export function compartirWhatsAppMovimientoEnvases(movimiento, entidad, numero, saldos = []) {
  let texto = generarTextoWhatsApp(movimiento, entidad);
  
  // Agregar saldos si existen
  if (saldos.length > 0) {
    texto += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    texto += `*SALDO ACTUAL - ${entidad?.nombre || movimiento.proveedor_nombre || movimiento.cliente_nombre}*\n`;
    saldos.forEach(s => {
      texto += `üì¶ ${s.envase_tipo}: ${s.saldo > 0 ? `Adeuda ${s.saldo} envases` : 'Sin deuda'}\n`;
    });
  }
  
  const textoEncoded = encodeURIComponent(texto);
  const url = `https://wa.me/${numero}?text=${textoEncoded}`;
  window.open(url, '_blank');
}
</file>

<file path="src/components/PDFGenerator.jsx">
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { getCompleteStyles, getLogoHTML, themes } from '@/utils/pdfStyles';

export function generateMovimientoPDF(movimiento, saldos) {
  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  const fechaGeneracion = format(new Date(), "dd/MM/yyyy HH:mm:ss", { locale: es });
  
  const esIngreso = movimiento.tipo_movimiento === "Ingreso de Fruta";
  
  let pesajesHTML = '';
  let resumenHTML = '';
  
  if (esIngreso && movimiento.pesajes?.length > 0) {
    // Agrupar pesajes por producto y envase
    const resumen = {};
    movimiento.pesajes.forEach(p => {
      const key = `${p.producto_nombre || 'Sin producto'}_${p.envase_tipo || 'Sin envase'}`;
      if (!resumen[key]) {
        resumen[key] = {
          producto: p.producto_nombre || 'Sin producto',
          envase: p.envase_tipo || '-',
          cantidad: 0,
          pesoBruto: 0,
          tara: 0,
          pesoNeto: 0
        };
      }
      resumen[key].cantidad += p.cantidad || 1;
      resumen[key].pesoBruto += p.peso_bruto || 0;
      resumen[key].tara += p.modo === 'libre' ? (p.tara_manual || 0) : ((p.tara_unitaria || 0) * (p.cantidad || 1));
      resumen[key].pesoNeto += p.peso_neto || 0;
    });

    pesajesHTML = `
      <div class="section">
        <h3>Detalle de Pesajes</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Envase</th>
              <th>Cant.</th>
              <th>P. Bruto</th>
              <th>Tara</th>
              <th>P. Neto</th>
            </tr>
          </thead>
          <tbody>
            ${movimiento.pesajes.map(p => `
              <tr>
                <td>${p.producto_nombre || '-'}</td>
                <td>${p.envase_tipo || '-'}</td>
                <td>${p.cantidad || 1}</td>
                <td>${(p.peso_bruto || 0).toFixed(2)} kg</td>
                <td>${p.modo === 'libre' ? (p.tara_manual || 0).toFixed(2) : ((p.tara_unitaria || 0) * (p.cantidad || 1)).toFixed(2)} kg</td>
                <td><strong>${(p.peso_neto || 0).toFixed(2)} kg</strong></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div class="section">
        <h3>Resumen por Producto</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Envase</th>
              <th>Cantidad</th>
              <th>P. Bruto Total</th>
              <th>Tara Total</th>
              <th>P. Neto Total</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(resumen).map(r => `
              <tr>
                <td>${r.producto}</td>
                <td>${r.envase}</td>
                <td>${r.cantidad}</td>
                <td>${r.pesoBruto.toFixed(2)} kg</td>
                <td>${r.tara.toFixed(2)} kg</td>
                <td><strong>${r.pesoNeto.toFixed(2)} kg</strong></td>
              </tr>
            `).join('')}
            <tr class="total-row">
              <td colspan="3"><strong>TOTAL</strong></td>
              <td><strong>${Object.values(resumen).reduce((s, r) => s + r.pesoBruto, 0).toFixed(2)} kg</strong></td>
              <td><strong>${Object.values(resumen).reduce((s, r) => s + r.tara, 0).toFixed(2)} kg</strong></td>
              <td><strong>${Object.values(resumen).reduce((s, r) => s + r.pesoNeto, 0).toFixed(2)} kg</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
  }

  let envasesHTML = '';
  if (esIngreso && movimiento.cantidad_envases_llenos > 0) {
    envasesHTML = `
      <div class="section">
        <h3>Envases Llenos con Fruta</h3>
        <div style="padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #78350f; font-weight: 600;">Cantidad de Envases Llenos:</span>
            <span style="font-size: 18px; font-weight: bold; color: #92400e;">${movimiento.cantidad_envases_llenos} unidades</span>
          </div>
          <p style="font-size: 10px; color: #78350f; margin-top: 6px;">
            Envases que ingresaron ocupados con fruta ‚Üí Stock Ocupados
          </p>
        </div>
      </div>
    `;
  }
  
  // Movimientos de envases VAC√çOS (Movimiento de Envases Y historial)
  let envasesVaciosHTML = '';
  if (movimiento.tipo_movimiento === 'Movimiento de Envases' && movimiento.movimiento_envases?.length > 0) {
    const envConMov = movimiento.movimiento_envases.filter(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0);
    if (envConMov.length > 0) {
      const totalIngreso = envConMov.reduce((sum, e) => sum + (e.cantidad_ingreso || 0), 0);
      const totalSalida = envConMov.reduce((sum, e) => sum + (e.cantidad_salida || 0), 0);
      const balanceNeto = totalIngreso - totalSalida;
      
      envasesVaciosHTML = `
        <div class="section">
          <h3>Movimiento de Envases Vac√≠os</h3>
          <table>
            <thead>
              <tr>
                <th style="width: 40%;">Tipo de Envase</th>
                <th style="width: 30%; text-align: right;">Ingreso (Vac√≠os)</th>
                <th style="width: 30%; text-align: right;">Salida (Vac√≠os)</th>
              </tr>
            </thead>
            <tbody>
              ${envConMov.map(e => `
                <tr>
                  <td><strong>${e.envase_tipo}</strong></td>
                  <td style="text-align: right;">
                    ${e.cantidad_ingreso > 0 ? `<span class="ingreso">+${e.cantidad_ingreso}</span>` : '-'}
                  </td>
                  <td style="text-align: right;">
                    ${e.cantidad_salida > 0 ? `<span class="salida">-${e.cantidad_salida}</span>` : '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Total Ingreso:</span>
              <span class="ingreso" style="font-weight: 600;">+${totalIngreso} envases</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Total Salida:</span>
              <span class="salida" style="font-weight: 600;">-${totalSalida} envases</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 2px solid #cbd5e1; font-weight: bold; font-size: 16px;">
              <span>Balance Neto:</span>
              <span>${balanceNeto > 0 ? '+' : ''}${balanceNeto} envases</span>
            </div>
          </div>
        </div>
      `;
    }
  }

  const nombreEntidad = movimiento.proveedor_nombre || movimiento.cliente_nombre || 'Sin especificar';
  
  const saldosHTML = saldos?.length > 0 ? `
    <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #10b981;">
      <h3 style="color: #065f46; font-weight: 600; margin-bottom: 12px; font-size: 16px;">Saldo Actual de Envases - ${nombreEntidad}</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        ${saldos.map(s => `
          <div style="background: ${s.saldo > 0 ? '#fee2e2' : '#dcfce7'}; padding: 12px; border-radius: 6px; border: 1px solid ${s.saldo > 0 ? '#fca5a5' : '#86efac'};">
            <p style="font-size: 14px; color: ${s.saldo > 0 ? '#991b1b' : '#065f46'};">
              <strong>${s.envase_tipo}:</strong><br>
              ${s.saldo > 0 ? `Adeuda <strong>${s.saldo}</strong> envases` : '<strong>Sin deuda</strong>'}
            </p>
          </div>
        `).join('')}
      </div>
    </div>
  ` : '';

  const styles = getCompleteStyles(themes.default);
  const logoHTML = getLogoHTML(80);

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Comprobante - ${movimiento.tipo_movimiento}</title>
      <style>
        ${styles}
        .saldos { 
          background: #fef3c7;
          padding: 15px;
          border-radius: 8px;
        }
        .saldos h3 { border-bottom-color: #fbbf24; }
      </style>
    </head>
    <body>
      <div class="header">
        ${logoHTML}
        <div class="title">ACOPIO DE FRUTAS</div>
        <div class="subtitle">${movimiento.tipo_movimiento}</div>
      </div>
      
      <div class="info-grid">
        <div class="info-item">
          <label>Fecha</label>
          <p>${fecha}</p>
        </div>
        <div class="info-item">
          <label>${movimiento.tipo_entidad || 'Proveedor'}</label>
          <p>${movimiento.proveedor_nombre || movimiento.cliente_nombre || ''}</p>
        </div>
        ${movimiento.fletero_nombre ? `
          <div class="info-item">
            <label>Fletero</label>
            <p>${movimiento.fletero_nombre}</p>
          </div>
        ` : ''}
      </div>

      ${pesajesHTML}
      ${envasesHTML}
      ${envasesVaciosHTML}
      ${saldosHTML}

      <div class="footer">
        <p>Comprobante generado el ${fechaGeneracion}</p>
        <p>Sistema de Gesti√≥n de Acopio</p>
      </div>
    </body>
    </html>
  `;

  return html;
}

export function downloadPDF(html, filename) {
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = () => {
    printWindow.print();
  };
}

async function htmlToPDFBlob(html, filename) {
  return new Promise((resolve) => {
    const iframe = document.createElement('iframe');
    iframe.style.position = 'absolute';
    iframe.style.top = '-10000px';
    document.body.appendChild(iframe);
    
    iframe.contentDocument.write(html);
    iframe.contentDocument.close();
    
    setTimeout(async () => {
      try {
        const canvas = await window.html2canvas(iframe.contentDocument.body, {
          scale: 2,
          useCORS: true,
          logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        const blob = pdf.output('blob');
        
        document.body.removeChild(iframe);
        resolve(blob);
      } catch (error) {
        console.error('Error generating PDF:', error);
        document.body.removeChild(iframe);
        resolve(null);
      }
    }, 500);
  });
}

export function generateResumenSaldosPDF(entidades, filtroTipo) {
  const fechaGeneracion = format(new Date(), "dd/MM/yyyy HH:mm:ss", { locale: es });
  
  const totalProveedores = entidades.filter(e => e.tipo === 'Proveedor').length;
  const totalClientes = entidades.filter(e => e.tipo === 'Cliente').length;
  const totalEnvasesProveedores = entidades
    .filter(e => e.tipo === 'Proveedor')
    .reduce((sum, e) => sum + e.totalAdeudado, 0);
  const totalEnvasesClientes = entidades
    .filter(e => e.tipo === 'Cliente')
    .reduce((sum, e) => sum + e.totalAdeudado, 0);
  
  const proveedoresHTML = entidades.filter(e => e.tipo === 'Proveedor').length > 0 ? `
    <div class="section">
      <h3>Proveedores que Adeudan Envases</h3>
      <table>
        <thead>
          <tr>
            <th>Proveedor</th>
            <th>Envases por Tipo</th>
            <th>Total Adeudado</th>
          </tr>
        </thead>
        <tbody>
          ${entidades.filter(e => e.tipo === 'Proveedor').map(e => `
            <tr>
              <td><strong>${e.nombre}</strong></td>
              <td>
                ${e.envases.filter(env => env.saldo > 0).map(env => `${env.tipo}: ${env.saldo}`).join(' ‚Ä¢ ')}
              </td>
              <td class="total-cell">${e.totalAdeudado}</td>
            </tr>
          `).join('')}
          <tr class="total-row">
            <td colspan="2"><strong>TOTAL PROVEEDORES</strong></td>
            <td><strong>${totalEnvasesProveedores}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  ` : '';
  
  const clientesHTML = entidades.filter(e => e.tipo === 'Cliente').length > 0 ? `
    <div class="section">
      <h3>Clientes (Acopio Debe Envases)</h3>
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Envases por Tipo</th>
            <th>Total Adeudado</th>
          </tr>
        </thead>
        <tbody>
          ${entidades.filter(e => e.tipo === 'Cliente').map(e => `
            <tr>
              <td><strong>${e.nombre}</strong></td>
              <td>
                ${e.envases.filter(env => env.saldo > 0).map(env => `${env.tipo}: ${env.saldo}`).join(' ‚Ä¢ ')}
              </td>
              <td class="total-cell">${e.totalAdeudado}</td>
            </tr>
          `).join('')}
          <tr class="total-row">
            <td colspan="2"><strong>TOTAL CLIENTES</strong></td>
            <td><strong>${totalEnvasesClientes}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  ` : '';
  
  const resumenTheme = {
    primaryColor: '#dc2626',
    titleColor: '#991b1b',
    bgColor: '#fef2f2',
    borderColor: '#fecaca',
    headerBg: '#fef2f2',
    headerColor: '#991b1b'
  };
  const resumenStyles = getCompleteStyles(resumenTheme);

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Resumen de Saldos de Envases</title>
      <style>
        ${resumenStyles}
        .summary-cards {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
          margin-bottom: 20px;
          padding: 15px;
          background: #fef2f2;
          border-radius: 8px;
        }
        .card {
          background: white;
          padding: 12px;
          border-radius: 6px;
          border-left: 4px solid #dc2626;
        }
        .card-label {
          font-size: 10px;
          color: #666;
          text-transform: uppercase;
        }
        .card-value {
          font-size: 20px;
          font-weight: bold;
          color: #991b1b;
          margin-top: 4px;
        }
        .total-cell {
          font-weight: bold;
          color: #dc2626;
          font-size: 14px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        ${getLogoHTML(80)}
        <div class="title">ACOPIO DE FRUTAS</div>
        <div class="subtitle">Resumen de Saldos de Envases</div>
      </div>
      
      <div class="summary-cards">
        <div class="card">
          <div class="card-label">Proveedores con Deuda</div>
          <div class="card-value">${totalProveedores}</div>
          <div style="font-size: 9px; color: #666; margin-top: 4px;">
            Total: ${totalEnvasesProveedores} envases
          </div>
        </div>
        <div class="card">
          <div class="card-label">Clientes (Acopio Debe)</div>
          <div class="card-value">${totalClientes}</div>
          <div style="font-size: 9px; color: #666; margin-top: 4px;">
            Total: ${totalEnvasesClientes} envases
          </div>
        </div>
      </div>

      ${proveedoresHTML}
      ${clientesHTML}

      <div class="footer">
        <p>Resumen generado el ${fechaGeneracion}</p>
        <p>Sistema de Gesti√≥n de Acopio</p>
      </div>
    </body>
    </html>
  `;

  return html;
}

export function downloadResumenSaldosPDF(entidades, filtroTipo) {
  const html = generateResumenSaldosPDF(entidades, filtroTipo);
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = () => {
    printWindow.print();
  };
}

export async function shareWhatsApp(movimiento, saldos, whatsappNumber) {
  if (!whatsappNumber || !whatsappNumber.trim()) {
    alert('No hay n√∫mero de WhatsApp registrado para esta entidad');
    return;
  }

  // Crear mensaje de texto con resumen
  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  let mensaje = `üçé *COMPROBANTE DE ${movimiento.tipo_movimiento.toUpperCase()}*\n\n`;
  mensaje += `üìÖ Fecha: ${fecha}\n`;
  mensaje += `üë§ ${movimiento.tipo_entidad || 'Proveedor'}: ${movimiento.proveedor_nombre || movimiento.cliente_nombre}\n`;
  
  if (movimiento.fletero_nombre) {
    mensaje += `üöö Fletero: ${movimiento.fletero_nombre}\n`;
  }
  
  if (movimiento.pesajes?.length > 0) {
    const totalNeto = movimiento.pesajes.reduce((s, p) => s + (p.peso_neto || 0), 0);
    mensaje += `\n‚öñÔ∏è *PESAJES*\n`;
    mensaje += `Total Peso Neto: ${totalNeto.toFixed(2)} kg\n`;
  }
  
  if (movimiento.movimiento_envases?.length > 0) {
    const envConMov = movimiento.movimiento_envases.filter(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0);
    if (envConMov.length > 0) {
      mensaje += `\nüì¶ *ENVASES VAC√çOS*\n`;
      envConMov.forEach(e => {
        if (e.cantidad_ingreso > 0) mensaje += `‚úÖ ${e.envase_tipo}: +${e.cantidad_ingreso} vac√≠os (devueltos)\n`;
        if (e.cantidad_salida > 0) mensaje += `üî¥ ${e.envase_tipo}: -${e.cantidad_salida} vac√≠os (entregados)\n`;
      });
    }
  }

  // Limpiar n√∫mero y abrir WhatsApp PRIMERO
  const cleanNumber = whatsappNumber.replace(/\D/g, '');
  const mensajeConInstruccion = mensaje + '\n\nüìÑ *Imprime o guarda el PDF desde la ventana que se abri√≥, luego adj√∫ntalo aqu√≠*';
  const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(mensajeConInstruccion)}`;
  window.open(whatsappUrl, '_blank');
  
  // Generar HTML del PDF y abrirlo DESPU√âS
  const html = generateMovimientoPDF(movimiento, saldos);
  
  setTimeout(() => {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
  }, 300);
}
</file>

<file path="src/components/PDFGeneratorIngresoFruta.jsx">
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { commonPdfStyles, getLogoHTML } from '@/utils/pdfStyles';

/**
 * Genera el HTML del PDF para INGRESO DE FRUTA
 * SIN saldos de envases - solo informaci√≥n de fruta, kilos y pesajes
 */
export function generarPDFIngresoFruta(movimiento) {
  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  const fechaGeneracion = format(new Date(), "dd/MM/yyyy HH:mm:ss", { locale: es });
  
  // Agrupar pesajes por producto y envase
  const resumen = {};
  (movimiento.pesajes || []).forEach(p => {
    const key = `${p.producto_nombre || 'Sin producto'}_${p.envase_tipo || 'Sin envase'}`;
    if (!resumen[key]) {
      resumen[key] = {
        producto: p.producto_nombre || 'Sin producto',
        envase: p.envase_tipo || '-',
        cantidad: 0,
        pesoBruto: 0,
        tara: 0,
        pesoNeto: 0
      };
    }
    resumen[key].cantidad += p.cantidad || 1;
    resumen[key].pesoBruto += p.peso_bruto || 0;
    resumen[key].tara += p.modo === 'libre' ? (p.tara_manual || 0) : ((p.tara_unitaria || 0) * (p.cantidad || 1));
    resumen[key].pesoNeto += p.peso_neto || 0;
  });

  const totalPesoBruto = Object.values(resumen).reduce((s, r) => s + r.pesoBruto, 0);
  const totalTara = Object.values(resumen).reduce((s, r) => s + r.tara, 0);
  const totalPesoNeto = Object.values(resumen).reduce((s, r) => s + r.pesoNeto, 0);

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Ingreso de Fruta</title>
      <style>
        ${commonPdfStyles}
        .header { border-bottom: 3px solid #22c55e; }
        .title { color: #166534; }
        .info-section { background: #f0fdf4; }
        .info-row { border-bottom: 1px solid #bbf7d0; }
        .info-value { color: #166534; }
        .section h3 { color: #166534; border-bottom-color: #bbf7d0; }
        th { background: #f0fdf4; color: #166534; }
        .total-row { background: #dcfce7; }
        .envases-llenos { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .envases-llenos h3 { color: #92400e; border-bottom-color: #fde68a; }
        .envase-tipo { color: #92400e; }
        .envase-cantidad { color: #d97706; }
      </style>
    </head>
    <body>
      <div class="header">
        ${getLogoHTML(80)}
        <div class="title">ACOPIO DE FRUTAS</div>
        <div class="subtitle">Ingreso de Fruta</div>
      </div>
      
      <div class="info-section">
        <div class="info-row">
          <span class="info-label">Fecha:</span>
          <span class="info-value">${fecha}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Proveedor:</span>
          <span class="info-value">${movimiento.proveedor_nombre || 'Sin especificar'}</span>
        </div>
        ${movimiento.fletero_nombre ? `
          <div class="info-row">
            <span class="info-label">Fletero:</span>
            <span class="info-value">${movimiento.fletero_nombre}</span>
          </div>
        ` : ''}
      </div>

      <div class="section">
        <h3>Detalle de Pesajes</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Envase</th>
              <th style="text-align: right;">Cant.</th>
              <th style="text-align: right;">P. Bruto</th>
              <th style="text-align: right;">Tara</th>
              <th style="text-align: right;">P. Neto</th>
            </tr>
          </thead>
          <tbody>
            ${(movimiento.pesajes || []).map(p => `
              <tr>
                <td><strong>${p.producto_nombre || '-'}</strong></td>
                <td>${p.envase_tipo || '-'}</td>
                <td style="text-align: right;">${p.cantidad || 1}</td>
                <td style="text-align: right;">${(p.peso_bruto || 0).toFixed(2)} kg</td>
                <td style="text-align: right;">${p.modo === 'libre' ? (p.tara_manual || 0).toFixed(2) : ((p.tara_unitaria || 0) * (p.cantidad || 1)).toFixed(2)} kg</td>
                <td style="text-align: right;"><strong>${(p.peso_neto || 0).toFixed(2)} kg</strong></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div class="section">
        <h3>Resumen por Producto</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Envase</th>
              <th style="text-align: right;">Cantidad</th>
              <th style="text-align: right;">P. Bruto Total</th>
              <th style="text-align: right;">Tara Total</th>
              <th style="text-align: right;">P. Neto Total</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(resumen).map(r => `
              <tr>
                <td><strong>${r.producto}</strong></td>
                <td>${r.envase}</td>
                <td style="text-align: right;">${r.cantidad}</td>
                <td style="text-align: right;">${r.pesoBruto.toFixed(2)} kg</td>
                <td style="text-align: right;">${r.tara.toFixed(2)} kg</td>
                <td style="text-align: right;"><strong>${r.pesoNeto.toFixed(2)} kg</strong></td>
              </tr>
            `).join('')}
            <tr class="total-row">
              <td colspan="3"><strong>TOTAL</strong></td>
              <td style="text-align: right;"><strong>${totalPesoBruto.toFixed(2)} kg</strong></td>
              <td style="text-align: right;"><strong>${totalTara.toFixed(2)} kg</strong></td>
              <td style="text-align: right;"><strong>${totalPesoNeto.toFixed(2)} kg</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      ${(movimiento.envases_llenos && movimiento.envases_llenos.length > 0) ? `
        <div class="envases-llenos">
          <h3>Envases Llenos con Fruta</h3>
          <div class="envases-grid">
            ${movimiento.envases_llenos.map(e => `
              <div class="envase-item">
                <div class="envase-tipo">${e.envase_tipo}</div>
                <div class="envase-cantidad">${e.cantidad} unidades</div>
              </div>
            `).join('')}
          </div>
          <p style="font-size: 10px; color: #78350f; margin-top: 12px;">
            * Envases que ingresaron llenos con fruta
          </p>
        </div>
      ` : ''}

      ${movimiento.notas ? `
        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #3b82f6;">
          <h4 style="color: #1e40af; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Notas:</h4>
          <p style="color: #1e3a8a; font-size: 12px; line-height: 1.6;">${movimiento.notas}</p>
        </div>
      ` : ''}

      <div class="footer">
        <p>Comprobante generado el ${fechaGeneracion}</p>
        <p>Sistema de Gesti√≥n de Acopio</p>
      </div>
    </body>
    </html>
  `;
}

/**
 * Descarga el PDF de ingreso de fruta
 */
export function descargarPDFIngresoFruta(movimiento) {
  const html = generarPDFIngresoFruta(movimiento);
  const ventana = window.open('', '_blank');
  ventana.document.write(html);
  ventana.document.close();
  
  setTimeout(() => {
    ventana.print();
  }, 250);
}

/**
 * Comparte ingreso de fruta por WhatsApp
 */
export function compartirWhatsAppIngresoFruta(movimiento, whatsappNumber) {
  if (!whatsappNumber || !whatsappNumber.trim()) {
    alert('No hay n√∫mero de WhatsApp registrado para este proveedor');
    return;
  }

  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  const totalNeto = (movimiento.pesajes || []).reduce((s, p) => s + (p.peso_neto || 0), 0);
  
  let texto = `üçé *INGRESO DE FRUTA*\n\n`;
  texto += `üìÖ Fecha: ${fecha}\n`;
  texto += `üë§ Proveedor: ${movimiento.proveedor_nombre || 'Sin especificar'}\n`;
  if (movimiento.fletero_nombre) {
    texto += `üöö Fletero: ${movimiento.fletero_nombre}\n`;
  }
  texto += `\n‚öñÔ∏è *RESUMEN*\n`;
  texto += `Total Peso Neto: *${totalNeto.toFixed(2)} kg*\n`;
  
  if (movimiento.pesajes && movimiento.pesajes.length > 0) {
    texto += `\nüì¶ *DETALLE POR PRODUCTO*\n`;
    const resumenProductos = {};
    movimiento.pesajes.forEach(p => {
      if (!resumenProductos[p.producto_nombre]) {
        resumenProductos[p.producto_nombre] = 0;
      }
      resumenProductos[p.producto_nombre] += p.peso_neto || 0;
    });
    Object.entries(resumenProductos).forEach(([prod, kg]) => {
      texto += `‚Ä¢ ${prod}: ${kg.toFixed(2)} kg\n`;
    });
  }
  
  if (movimiento.envases_llenos && movimiento.envases_llenos.length > 0) {
    texto += `\nüì¶ *ENVASES LLENOS CON FRUTA*\n`;
    movimiento.envases_llenos.forEach(e => {
      texto += `‚Ä¢ ${e.envase_tipo}: ${e.cantidad} unidades\n`;
    });
  }

  if (movimiento.notas) {
    texto += `\nüìù Notas: ${movimiento.notas}`;
  }
  
  const textoEncoded = encodeURIComponent(texto);
  const cleanNumber = whatsappNumber.replace(/\D/g, '');
  const url = `https://wa.me/${cleanNumber}?text=${textoEncoded}`;
  window.open(url, '_blank');
  
  // Abrir PDF despu√©s
  setTimeout(() => {
    descargarPDFIngresoFruta(movimiento);
  }, 300);
}
</file>

<file path="src/components/PDFGeneratorMovimientoEnvases.jsx">
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { commonPdfStyles, getLogoHTML } from '@/utils/pdfStyles';

/**
 * Calcula los saldos de envases ACTUALIZADOS despu√©s de aplicar el movimiento
 */
export function calcularSaldosActualizados(movimiento, saldosAnteriores) {
  const saldosActualizados = {};
  
  // Copiar saldos anteriores
  saldosAnteriores.forEach(s => {
    saldosActualizados[s.envase_tipo] = s.saldo || 0;
  });
  
  // Aplicar movimiento actual
  (movimiento.movimiento_envases || []).forEach(e => {
    if (!saldosActualizados[e.envase_tipo]) {
      saldosActualizados[e.envase_tipo] = 0;
    }
    
    // SALIDA = le doy envases = aumenta deuda
    // INGRESO = me devuelve envases = reduce deuda
    const cambio = (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
    saldosActualizados[e.envase_tipo] += cambio;
  });
  
  return Object.entries(saldosActualizados).map(([tipo, saldo]) => ({
    envase_tipo: tipo,
    saldo: saldo
  }));
}

/**
 * Genera el HTML del PDF para MOVIMIENTO DE ENVASES
 * CON saldos actualizados despu√©s del movimiento
 */
export function generarPDFMovimientoEnvases(movimiento, entidad, fletero, saldosActualizados = []) {
  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  const fechaGeneracion = format(new Date(), "dd/MM/yyyy HH:mm:ss", { locale: es });
  
  const tipoEntidad = movimiento.tipo_entidad || 'Proveedor';
  const nombreEntidad = entidad?.nombre || movimiento.proveedor_nombre || movimiento.cliente_nombre || 'Sin especificar';
  const nombreFletero = fletero?.nombre || movimiento.fletero_nombre || '-';

  const esIngreso = (movimiento.movimiento_envases || []).some(e => (e.cantidad_ingreso || 0) > 0);
  const esSalida = (movimiento.movimiento_envases || []).some(e => (e.cantidad_salida || 0) > 0);
  
  let tipoMovimiento = '';
  if (esIngreso && esSalida) tipoMovimiento = 'Ingreso y Salida de Envases Vac√≠os';
  else if (esIngreso) tipoMovimiento = 'Ingreso de Envases Vac√≠os';
  else if (esSalida) tipoMovimiento = 'Salida de Envases Vac√≠os';
  else tipoMovimiento = 'Movimiento de Envases';

  const totalIngreso = (movimiento.movimiento_envases || []).reduce((sum, e) => sum + (e.cantidad_ingreso || 0), 0);
  const totalSalida = (movimiento.movimiento_envases || []).reduce((sum, e) => sum + (e.cantidad_salida || 0), 0);
  const balanceNeto = totalIngreso - totalSalida;

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Movimiento de Envases</title>
      <style>
        ${commonPdfStyles}
        .header { border-bottom: 3px solid #6366f1; }
        .title { color: #4338ca; }
        .info-section { background: #f0f9ff; }
        .info-row { border-bottom: 1px solid #bfdbfe; }
        .info-value { color: #1e40af; }
        th { background: #dbeafe; color: #1e40af; }
        .totales { background: #f1f5f9; }
        .saldos-section { background: #f0fdf4; border-left: 4px solid #10b981; }
        .saldos-section h3 { color: #065f46; }
        .saldo-debe { background: #fee2e2; border-color: #fca5a5; }
        .saldo-ok { background: #dcfce7; border-color: #86efac; }
        .debe { color: #991b1b; }
        .ok { color: #065f46; }
      </style>
    </head>
    <body>
      <div class="header">
        ${getLogoHTML(80)}
        <div class="title">MOVIMIENTO DE ENVASES</div>
        <div class="subtitle">${tipoMovimiento}</div>
      </div>

      <div class="info-section">
        <div class="info-row">
          <span class="info-label">Fecha:</span>
          <span class="info-value">${fecha}</span>
        </div>
        <div class="info-row">
          <span class="info-label">${tipoEntidad}:</span>
          <span class="info-value">${nombreEntidad}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Fletero:</span>
          <span class="info-value">${nombreFletero}</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 40%;">Tipo de Envase</th>
            <th style="width: 30%; text-align: right;">Ingreso (Vac√≠os)</th>
            <th style="width: 30%; text-align: right;">Salida (Vac√≠os)</th>
          </tr>
        </thead>
        <tbody>
          ${(movimiento.movimiento_envases || []).map(env => `
            <tr>
              <td><strong>${env.envase_tipo}</strong></td>
              <td style="text-align: right;">
                ${env.cantidad_ingreso > 0 ? `<span class="ingreso">+${env.cantidad_ingreso}</span>` : '-'}
              </td>
              <td style="text-align: right;">
                ${env.cantidad_salida > 0 ? `<span class="salida">-${env.cantidad_salida}</span>` : '-'}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <div class="totales">
        <div class="total-row">
          <span>Total Ingreso:</span>
          <span class="ingreso">+${totalIngreso} envases</span>
        </div>
        <div class="total-row">
          <span>Total Salida:</span>
          <span class="salida">-${totalSalida} envases</span>
        </div>
        <div class="total-row">
          <span>Balance Neto:</span>
          <span>${balanceNeto > 0 ? '+' : ''}${balanceNeto} envases</span>
        </div>
      </div>

      ${movimiento.notas ? `
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b;">
          <h4 style="color: #92400e; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Notas:</h4>
          <p style="color: #78350f; font-size: 12px; line-height: 1.6;">${movimiento.notas}</p>
        </div>
      ` : ''}

      ${saldosActualizados.length > 0 ? `
        <div class="saldos-section">
          <h3>Saldo Actual de Envases - ${nombreEntidad}</h3>
          <div class="saldos-grid">
            ${saldosActualizados.map(s => `
              <div class="saldo-item ${s.saldo > 0 ? 'saldo-debe' : 'saldo-ok'}">
                <div class="saldo-tipo ${s.saldo > 0 ? 'debe' : 'ok'}">${s.envase_tipo}</div>
                <div class="saldo-valor ${s.saldo > 0 ? 'debe' : 'ok'}">
                  ${s.saldo > 0 ? `Adeuda ${s.saldo}` : 'Sin deuda'}
                </div>
              </div>
            `).join('')}
          </div>
          <p style="font-size: 11px; color: #065f46; margin-top: 12px;">
            * Saldo actualizado al ${fecha}
          </p>
        </div>
      ` : ''}

      <div class="firma-section">
        <div class="firma-linea">
          <div></div>
          <p><strong>Firma y Aclaraci√≥n</strong></p>
          <p>${nombreEntidad}</p>
        </div>
      </div>

      <div class="footer">
        Comprobante generado el ${fechaGeneracion}<br>
        Sistema de Gesti√≥n de Acopio
      </div>
    </body>
    </html>
  `;
}

/**
 * Descarga el PDF del movimiento de envases
 */
export function descargarPDFMovimientoEnvases(movimiento, entidad, fletero, saldosActualizados = []) {
  const html = generarPDFMovimientoEnvases(movimiento, entidad, fletero, saldosActualizados);
  const ventana = window.open('', '_blank');
  ventana.document.write(html);
  ventana.document.close();
  
  setTimeout(() => {
    ventana.print();
  }, 250);
}

/**
 * Comparte movimiento de envases por WhatsApp
 */
export function compartirWhatsAppMovimientoEnvases(movimiento, entidad, whatsappNumber, saldosActualizados = []) {
  if (!whatsappNumber || !whatsappNumber.trim()) {
    alert('No hay n√∫mero de WhatsApp registrado para esta entidad');
    return;
  }

  const tipoEntidad = movimiento.tipo_entidad || 'Proveedor';
  const nombreEntidad = entidad?.nombre || movimiento.proveedor_nombre || movimiento.cliente_nombre || 'Sin especificar';
  const fecha = format(new Date(movimiento.fecha), "dd/MM/yyyy HH:mm", { locale: es });

  const esIngreso = (movimiento.movimiento_envases || []).some(e => (e.cantidad_ingreso || 0) > 0);
  const esSalida = (movimiento.movimiento_envases || []).some(e => (e.cantidad_salida || 0) > 0);
  
  let tipoMovimiento = '';
  if (esIngreso && esSalida) tipoMovimiento = 'INGRESO Y SALIDA DE ENVASES VAC√çOS';
  else if (esIngreso) tipoMovimiento = 'INGRESO DE ENVASES VAC√çOS';
  else if (esSalida) tipoMovimiento = 'SALIDA DE ENVASES VAC√çOS';
  else tipoMovimiento = 'MOVIMIENTO DE ENVASES';

  let texto = `üì¶ *${tipoMovimiento}*\n\n`;
  texto += `üìÖ Fecha: ${fecha}\n`;
  texto += `üë§ ${tipoEntidad}: ${nombreEntidad}\n\n`;
  texto += `*DETALLE DE ENVASES:*\n`;

  (movimiento.movimiento_envases || []).forEach(env => {
    texto += `\nüì¶ ${env.envase_tipo}\n`;
    if (env.cantidad_ingreso > 0) {
      texto += `   ‚úÖ Ingreso: +${env.cantidad_ingreso} vac√≠os\n`;
    }
    if (env.cantidad_salida > 0) {
      texto += `   ‚ùå Salida: -${env.cantidad_salida} vac√≠os\n`;
    }
  });

  const totalIngreso = (movimiento.movimiento_envases || []).reduce((sum, e) => sum + (e.cantidad_ingreso || 0), 0);
  const totalSalida = (movimiento.movimiento_envases || []).reduce((sum, e) => sum + (e.cantidad_salida || 0), 0);
  const balance = totalIngreso - totalSalida;

  texto += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
  texto += `*TOTALES:*\n`;
  texto += `‚úÖ Total Ingreso: +${totalIngreso} envases\n`;
  texto += `‚ùå Total Salida: -${totalSalida} envases\n`;
  texto += `üìä Balance Neto: ${balance > 0 ? '+' : ''}${balance} envases\n`;

  if (saldosActualizados.length > 0) {
    texto += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    texto += `*SALDO ACTUAL - ${nombreEntidad}*\n`;
    saldosActualizados.forEach(s => {
      if (s.saldo > 0) {
        texto += `üì¶ ${s.envase_tipo}: Adeuda ${s.saldo} envases\n`;
      } else if (s.saldo < 0) {
        texto += `üì¶ ${s.envase_tipo}: A favor ${Math.abs(s.saldo)} envases\n`;
      } else {
        texto += `üì¶ ${s.envase_tipo}: Sin deuda\n`;
      }
    });
  }

  if (movimiento.notas) {
    texto += `\nüìù Notas: ${movimiento.notas}`;
  }
  
  const textoEncoded = encodeURIComponent(texto);
  const cleanNumber = whatsappNumber.replace(/\D/g, '');
  const url = `https://wa.me/${cleanNumber}?text=${textoEncoded}`;
  window.open(url, '_blank');
  
  // Abrir PDF despu√©s
  setTimeout(() => {
    descargarPDFMovimientoEnvases(movimiento, entidad, null, saldosActualizados);
  }, 300);
}
</file>

<file path="src/components/PesajeLineItem.jsx">
import React from 'react';
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { Trash2 } from "lucide-react";
import SearchableSelect from "./SearchableSelect";
import { calcularPesoNeto, multiplicaExacta } from "./utils/precisionDecimal";

export default function PesajeLineItem({
  item,
  index,
  envases,
  productos,
  onChange,
  onRemove,
  onCreateEnvase,
  onCreateProducto
}) {
  const handleChange = (field, value) => {
    const updated = { ...item, [field]: value };
    
    // Recalcular peso neto con precisi√≥n decimal exacta
    if (updated.modo === 'libre') {
      updated.peso_neto = calcularPesoNeto(updated.peso_bruto || 0, updated.tara_manual || 0);
    } else {
      const taraTotal = multiplicaExacta(updated.tara_unitaria || 0, updated.cantidad || 0);
      updated.peso_neto = calcularPesoNeto(updated.peso_bruto || 0, taraTotal);
    }
    
    onChange(index, updated);
  };

  const handleEnvaseSelect = (envaseId, envase) => {
    const updated = {
      ...item,
      envase_id: envaseId,
      envase_tipo: envase.tipo,
      tara_unitaria: envase.tara
    };
    const taraTotal = multiplicaExacta(envase.tara, updated.cantidad || 0);
    updated.peso_neto = calcularPesoNeto(updated.peso_bruto || 0, taraTotal);
    onChange(index, updated);
  };

  const handleProductoSelect = (productoId, producto) => {
    handleChange('producto_id', productoId);
    onChange(index, {
      ...item,
      producto_id: productoId,
      producto_nombre: producto.producto_completo || `${producto.fruta} - ${producto.variedad}`
    });
  };

  const handleModoChange = (checked) => {
    const modo = checked ? 'libre' : 'estandar';
    const updated = { ...item, modo };
    if (modo === 'libre') {
      updated.peso_neto = calcularPesoNeto(updated.peso_bruto || 0, updated.tara_manual || 0);
    } else {
      const taraTotal = multiplicaExacta(updated.tara_unitaria || 0, updated.cantidad || 0);
      updated.peso_neto = calcularPesoNeto(updated.peso_bruto || 0, taraTotal);
    }
    onChange(index, updated);
  };

  const taraTotal = item.modo === 'libre' 
    ? (item.tara_manual || 0)
    : multiplicaExacta(item.tara_unitaria || 0, item.cantidad || 0);

  return (
    <div className="p-4 bg-white rounded-lg border border-slate-200 hover:border-slate-300 transition-colors space-y-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <Switch
            id={`modo-${index}`}
            checked={item.modo === 'libre'}
            onCheckedChange={handleModoChange}
          />
          <Label htmlFor={`modo-${index}`} className="text-sm font-medium cursor-pointer">
            {item.modo === 'libre' ? 'Modo Libre (Tara Manual)' : 'Modo Est√°ndar'}
          </Label>
        </div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">Producto</label>
          <SearchableSelect
            options={productos}
            value={item.producto_id}
            onChange={handleProductoSelect}
            displayKey="producto_completo"
            placeholder="Seleccionar producto..."
            onCreateNew={onCreateProducto}
            createNewLabel="Crear nuevo producto"
          />
        </div>

        {item.modo !== 'libre' && (
          <>
            <div>
              <label className="text-xs font-medium text-slate-500 mb-1 block">Tipo de Envase</label>
              <SearchableSelect
                options={envases}
                value={item.envase_id}
                onChange={handleEnvaseSelect}
                displayKey="tipo"
                placeholder="Seleccionar envase..."
                onCreateNew={onCreateEnvase}
                createNewLabel="Crear nuevo envase"
              />
            </div>
            <div>
              <label className="text-xs font-medium text-slate-500 mb-1 block">Cantidad</label>
              <Input
                type="number"
                min="0"
                step="1"
                value={item.cantidad ?? ''}
                onChange={(e) => {
                  const val = e.target.value;
                  handleChange('cantidad', val === '' ? 1 : parseInt(val) || 1);
                }}
                onFocus={(e) => e.target.select()}
                placeholder="1"
                className="text-center"
                inputMode="numeric"
              />
            </div>
          </>
        )}

        {item.modo === 'libre' && (
          <div>
            <label className="text-xs font-medium text-slate-500 mb-1 block">Tara Manual (kg)</label>
            <Input
              type="number"
              min="0"
              step="any"
              value={item.tara_manual ?? ''}
              placeholder="0.00"
              onChange={(e) => {
                const val = e.target.value;
                handleChange('tara_manual', val === '' ? 0 : parseFloat(val) || 0);
              }}
              onFocus={(e) => e.target.select()}
              className="text-center font-semibold"
              inputMode="decimal"
            />
          </div>
        )}

        <div>
          <label className="text-xs font-medium text-slate-500 mb-1 block">Peso Bruto (kg)</label>
          <Input
            type="number"
            min="0"
            step="any"
            value={item.peso_bruto ?? ''}
            placeholder="0.00"
            onChange={(e) => {
              const val = e.target.value;
              handleChange('peso_bruto', val === '' ? 0 : parseFloat(val) || 0);
            }}
            onFocus={(e) => e.target.select()}
            className="text-center font-semibold"
            inputMode="decimal"
          />
        </div>
      </div>

      <div className="flex flex-wrap items-center gap-4 pt-2 border-t border-slate-100">
        <div className="text-sm">
          <span className="text-slate-500">Tara Total:</span>
          <span className="ml-1 font-medium">{taraTotal.toFixed(2)} kg</span>
        </div>
        <div className="text-sm">
          <span className="text-slate-500">Peso Neto:</span>
          <span className="ml-1 font-bold text-green-700 text-lg">{(item.peso_neto || 0).toFixed(2)} kg</span>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/PINModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Lock, Loader2 } from "lucide-react";

export default function PINModal({ open, onClose, onConfirm, isLoading, title = "Confirmar con PIN" }) {
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = async () => {
    if (!pin || pin.length < 4) {
      setError('Por favor ingrese un PIN v√°lido (m√≠nimo 4 d√≠gitos)');
      return;
    }
    
    setError('');
    const result = await onConfirm(pin);
    
    if (result === false) {
      setError('PIN incorrecto. Intente nuevamente.');
      setPin('');
    } else {
      setPin('');
      onClose();
    }
  };

  const handleClose = () => {
    setPin('');
    setError('');
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Lock className="h-5 w-5 text-amber-600" />
            {title}
          </DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <label className="text-sm font-medium">Ingrese PIN de Seguridad</label>
            <Input
              type="password"
              inputMode="numeric"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              value={pin}
              onChange={(e) => {
                setPin(e.target.value.replace(/\D/g, ''));
                setError('');
              }}
              onKeyDown={(e) => {
                if (e.key === 'Enter') handleSubmit();
              }}
              maxLength={6}
              className="text-center text-2xl tracking-widest"
              autoFocus
            />
            {error && (
              <p className="text-sm text-red-600">{error}</p>
            )}
          </div>
          
          <div className="text-xs text-slate-500 bg-slate-50 p-3 rounded">
            <p>El PIN de seguridad protege las modificaciones cr√≠ticas.</p>
            <p className="mt-1">PIN por defecto: <code className="bg-white px-1 py-0.5 rounded">0000</code></p>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={handleClose} disabled={isLoading}>
            Cancelar
          </Button>
          <Button onClick={handleSubmit} disabled={isLoading || !pin}>
            {isLoading ? (
              <>
                <Loader2 className="h-4 w-4 animate-spin mr-2" />
                Verificando...
              </>
            ) : (
              'Confirmar'
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/QuickCreateModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Loader2 } from "lucide-react";

export default function QuickCreateModal({ 
  open, 
  onClose, 
  onSave, 
  title, 
  fields,
  isLoading 
}) {
  const [formData, setFormData] = useState({});

  const handleSave = async () => {
    await onSave(formData);
    setFormData({});
  };

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
        </DialogHeader>
        <div className="space-y-4 py-4">
          {fields.map((field) => (
            <div key={field.name} className="space-y-2">
              <Label htmlFor={field.name}>{field.label}</Label>
              <Input
                id={field.name}
                type={field.type || "text"}
                step={field.type === "number" ? "any" : undefined}
                placeholder={field.placeholder}
                value={formData[field.name] || ""}
                onChange={(e) => handleChange(
                  field.name, 
                  field.type === "number" ? parseFloat(e.target.value) || 0 : e.target.value
                )}
              />
            </div>
          ))}
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={isLoading}>
            Cancelar
          </Button>
          <Button onClick={handleSave} disabled={isLoading}>
            {isLoading ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : null}
            Guardar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/SalidaPDFGenerator.jsx">
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { getCompleteStyles, getLogoHTML, themes } from '@/utils/pdfStyles';

export function generateSalidaPDF(salida) {
  const fecha = format(new Date(salida.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  const fechaGeneracion = format(new Date(), "dd/MM/yyyy HH:mm:ss", { locale: es });
  
  const esConfirmada = salida.estado === 'Confirmada';
  
  let detallesHTML = '';
  let totalKilosSalida = 0;
  let totalKilosReales = 0;
  let totalDescuento = 0;
  let totalEfectivos = 0;
  let deudaTotal = 0;

  if (salida.detalles?.length > 0) {
    salida.detalles.forEach(d => {
      const kilosSalida = d.kilos_salida || 0;
      const kilosReales = d.kilos_reales || kilosSalida;
      const descuento = d.descuento_kg || 0;
      const efectivos = kilosReales - descuento;
      const precioKg = d.precio_kg || 0;
      const deuda = efectivos * precioKg;

      totalKilosSalida += kilosSalida;
      totalKilosReales += kilosReales;
      totalDescuento += descuento;
      totalEfectivos += efectivos;
      deudaTotal += deuda;

      detallesHTML += `
        <tr>
          <td>${d.producto_nombre}</td>
          <td class="text-right">${kilosSalida.toFixed(2)} kg</td>
          ${esConfirmada ? `
            <td class="text-right">${kilosReales.toFixed(2)} kg</td>
            <td class="text-right text-red-600">${descuento.toFixed(2)} kg</td>
            <td class="text-right"><strong>${efectivos.toFixed(2)} kg</strong></td>
            ${precioKg > 0 ? `<td class="text-right">$${precioKg.toFixed(2)}</td>` : '<td>-</td>'}
            ${precioKg > 0 ? `<td class="text-right"><strong>$${deuda.toFixed(2)}</strong></td>` : '<td>-</td>'}
          ` : ''}
        </tr>
        ${esConfirmada && d.motivo_ajuste ? `
          <tr>
            <td colspan="${precioKg > 0 ? '7' : '5'}" class="text-xs text-slate-600 italic">
              Motivo: ${d.motivo_ajuste}
            </td>
          </tr>
        ` : ''}
      `;
    });
  }

  let envasesHTML = '';
  if (salida.cantidad_envases_llenos > 0) {
    envasesHTML = `
      <div class="section">
        <h3>Envases Llenos con Fruta</h3>
        <div style="padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #78350f; font-weight: 600;">Cantidad de Envases Llenos:</span>
            <span style="font-size: 18px; font-weight: bold; color: #92400e;">${salida.cantidad_envases_llenos} unidades</span>
          </div>
          <p style="font-size: 10px; color: #78350f; margin-top: 6px;">
            Envases que salieron ocupados con fruta ‚Üí Stock Ocupados
          </p>
        </div>
      </div>
    `;
  }

  const styles = getCompleteStyles(themes.purple);
  const logoHTML = getLogoHTML(70);

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Remito ${salida.numero_remito}</title>
      <style>
        ${styles}
        .estado-badge { 
          ${esConfirmada ? 'background: #22c55e;' : 'background: #f59e0b;'} 
          color: white; 
          padding: 6px 16px; 
          border-radius: 20px; 
          display: inline-block; 
          margin-top: 8px; 
          font-weight: 600; 
        }
        .text-red-600 { color: #dc2626; }
        .alert-box {
          background: #fef3c7;
          border-left: 4px solid #f59e0b;
          padding: 12px;
          margin: 15px 0;
          border-radius: 4px;
        }
        .alert-box h4 {
          color: #92400e;
          font-size: 11px;
          font-weight: 600;
          margin-bottom: 4px;
        }
        .alert-box p {
          color: #78350f;
          font-size: 10px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        ${logoHTML}
        <div class="title">ACOPIO DE FRUTAS</div>
        <div class="subtitle">Remito de Salida</div>
        <div class="estado-badge">${salida.estado}</div>
      </div>
      
      <div class="info-grid">
        <div class="info-item">
          <label>Comprobante Asociado (Remito R)</label>
          <p>${salida.numero_remito}</p>
        </div>
        <div class="info-item">
          <label>Fecha</label>
          <p>${fecha}</p>
        </div>
        <div class="info-item">
          <label>Cliente</label>
          <p>${salida.cliente_nombre}</p>
        </div>
        ${salida.fletero_nombre ? `
          <div class="info-item">
            <label>Fletero</label>
            <p>${salida.fletero_nombre}</p>
          </div>
        ` : ''}
        ${esConfirmada && salida.comprobante_cliente ? `
          <div class="info-item">
            <label>Comprobante de Cliente</label>
            <p>${salida.comprobante_cliente}</p>
          </div>
        ` : ''}
      </div>

      ${!esConfirmada ? `
        <div class="alert-box">
          <h4>‚ö†Ô∏è Salida Pendiente de Confirmaci√≥n</h4>
          <p>Los kilos mostrados son provisionales. Se actualizar√°n al confirmar recepci√≥n con el cliente.</p>
        </div>
      ` : ''}

      <div class="section">
        <h3>${esConfirmada ? 'Detalle de Productos - Ajustado' : 'Detalle de Productos'}</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th class="text-right">Kilos Salida Original</th>
              ${esConfirmada ? `
                <th class="text-right">Kilos Reales</th>
                <th class="text-right">Descuento</th>
                <th class="text-right">Kilos Efectivos</th>
                <th class="text-right">Precio/Kg</th>
                <th class="text-right">Deuda</th>
              ` : ''}
            </tr>
          </thead>
          <tbody>
            ${detallesHTML}
            <tr class="total-row">
              <td><strong>TOTALES</strong></td>
              <td class="text-right"><strong>${totalKilosSalida.toFixed(2)} kg</strong></td>
              ${esConfirmada ? `
                <td class="text-right"><strong>${totalKilosReales.toFixed(2)} kg</strong></td>
                <td class="text-right text-red-600"><strong>${totalDescuento.toFixed(2)} kg</strong></td>
                <td class="text-right"><strong>${totalEfectivos.toFixed(2)} kg</strong></td>
                <td></td>
                <td class="text-right"><strong>${deudaTotal > 0 ? '$' + deudaTotal.toFixed(2) : '-'}</strong></td>
              ` : ''}
            </tr>
          </tbody>
        </table>
      </div>

      ${envasesHTML}

      ${esConfirmada && deudaTotal > 0 ? `
        <div class="section" style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 2px solid #fbbf24;">
          <h3 style="border: none; color: #92400e; margin-bottom: 8px;">üí∞ Resumen de Deuda</h3>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #78350f;">Deuda Total del Cliente:</span>
            <span style="font-size: 20px; font-weight: bold; color: #92400e;">$${deudaTotal.toFixed(2)}</span>
          </div>
          <p style="font-size: 9px; color: #78350f; margin-top: 6px;">
            Calculado sobre ${totalEfectivos.toFixed(2)} kg efectivos (descontando clasificaci√≥n/p√©rdidas)
          </p>
        </div>
      ` : ''}

      ${salida.notas ? `
        <div class="section">
          <h3>Notas Adicionales</h3>
          <p style="color: #666; font-size: 10px;">${salida.notas}</p>
        </div>
      ` : ''}

      <div class="footer">
        <p>Comprobante generado el ${fechaGeneracion}</p>
        <p>Sistema de Gesti√≥n de Acopio</p>
      </div>
    </body>
    </html>
  `;

  return html;
}

export function downloadSalidaPDF(html, numero_remito) {
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.onload = () => {
    printWindow.print();
  };
}

async function htmlToPDFBlob(html, filename) {
  return new Promise((resolve) => {
    const iframe = document.createElement('iframe');
    iframe.style.position = 'absolute';
    iframe.style.top = '-10000px';
    document.body.appendChild(iframe);
    
    iframe.contentDocument.write(html);
    iframe.contentDocument.close();
    
    setTimeout(async () => {
      try {
        const canvas = await window.html2canvas(iframe.contentDocument.body, {
          scale: 2,
          useCORS: true,
          logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        const blob = pdf.output('blob');
        
        document.body.removeChild(iframe);
        resolve(blob);
      } catch (error) {
        console.error('Error generating PDF:', error);
        document.body.removeChild(iframe);
        resolve(null);
      }
    }, 500);
  });
}

export async function shareSalidaWhatsApp(salida, whatsappNumber) {
  if (!whatsappNumber || !whatsappNumber.trim()) {
    alert('No hay n√∫mero de WhatsApp registrado para este cliente');
    return;
  }

  // Generar PDF
  const html = generateSalidaPDF(salida);
  const pdfBlob = await htmlToPDFBlob(html, `remito_${salida.numero_remito}.pdf`);
  
  if (!pdfBlob) {
    alert('Error al generar el PDF');
    return;
  }

  const fecha = format(new Date(salida.fecha), "dd/MM/yyyy HH:mm", { locale: es });
  const esConfirmada = salida.estado === 'Confirmada';
  
  let mensaje = `üßæ *REMITO DE SALIDA ${esConfirmada ? '- CONFIRMADO' : '- PENDIENTE'}*\n\n`;
  mensaje += `üìã Remito: ${salida.numero_remito}\n`;
  if (esConfirmada && salida.comprobante_cliente) {
    mensaje += `üìÑ Comprobante Cliente: ${salida.comprobante_cliente}\n`;
  }
  mensaje += `üìÖ Fecha: ${fecha}\n`;
  mensaje += `üë§ Cliente: ${salida.cliente_nombre}\n`;
  if (salida.fletero_nombre) {
    mensaje += `üöö Fletero: ${salida.fletero_nombre}\n`;
  }
  
  mensaje += `\nüì¶ *PRODUCTOS*\n`;
  let totalEfectivos = 0;
  let deudaTotal = 0;
  
  salida.detalles?.forEach(d => {
    const kilosReales = d.kilos_reales || d.kilos_salida;
    const descuento = d.descuento_kg || 0;
    const efectivos = kilosReales - descuento;
    const precioKg = d.precio_kg || 0;
    const deuda = efectivos * precioKg;
    
    totalEfectivos += efectivos;
    deudaTotal += deuda;
    
    mensaje += `‚Ä¢ ${d.producto_nombre}\n`;
    if (esConfirmada) {
      mensaje += `  Original: ${d.kilos_salida.toFixed(2)} kg\n`;
      mensaje += `  Real: ${kilosReales.toFixed(2)} kg\n`;
      if (descuento > 0) {
        mensaje += `  Descuento: -${descuento.toFixed(2)} kg\n`;
      }
      mensaje += `  Efectivos: ${efectivos.toFixed(2)} kg\n`;
      if (precioKg > 0) {
        mensaje += `  Deuda: $${deuda.toFixed(2)}\n`;
      }
    } else {
      mensaje += `  ${d.kilos_salida.toFixed(2)} kg\n`;
    }
  });
  
  if (esConfirmada) {
    mensaje += `\n‚öñÔ∏è *Total Kilos Efectivos:* ${totalEfectivos.toFixed(2)} kg`;
    if (deudaTotal > 0) {
      mensaje += `\nüí∞ *DEUDA TOTAL: $${deudaTotal.toFixed(2)}*`;
    }
  } else {
    const totalProvisional = salida.detalles?.reduce((sum, d) => sum + (d.kilos_salida || 0), 0) || 0;
    mensaje += `\n‚öñÔ∏è Total Provisorio: ${totalProvisional.toFixed(2)} kg`;
  }
  
  if (salida.cantidad_envases_llenos > 0) {
    mensaje += `\n\nüì¶ *ENVASES LLENOS*\n`;
    mensaje += `üü† Envases con fruta: ${salida.cantidad_envases_llenos} unidades\n`;
  }
  
  // Intentar usar Web Share API para adjuntar PDF
  if (navigator.share && navigator.canShare) {
    const file = new File([pdfBlob], `remito_${salida.numero_remito}.pdf`, { type: 'application/pdf' });
    const shareData = {
      title: `Remito de Salida - ${salida.numero_remito}`,
      text: mensaje,
      files: [file]
    };

    try {
      if (navigator.canShare(shareData)) {
        await navigator.share(shareData);
        return;
      }
    } catch (error) {
      console.log('Web Share API no disponible o cancelado');
    }
  }

  // Fallback: descargar PDF y abrir WhatsApp
  const url = URL.createObjectURL(pdfBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `remito_${salida.numero_remito}.pdf`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  // Abrir WhatsApp con mensaje
  setTimeout(() => {
    const cleanNumber = whatsappNumber.replace(/\D/g, '');
    const mensajeConInstruccion = mensaje + '\n\nüìé *PDF descargado - por favor adj√∫ntalo manualmente*';
    const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(mensajeConInstruccion)}`;
    window.open(whatsappUrl, '_blank');
  }, 500);
}
</file>

<file path="src/components/SearchableSelect.jsx">
import React, { useState, useMemo } from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Check, ChevronsUpDown, Plus, Search } from "lucide-react";
import { cn } from "@/lib/utils";

export default function SearchableSelect({
  options = [],
  value,
  onChange,
  placeholder = "Seleccionar...",
  displayKey = "nombre",
  valueKey = "id",
  onCreateNew,
  createNewLabel = "Crear nuevo",
  disabled = false
}) {
  const [open, setOpen] = useState(false);
  const [search, setSearch] = useState("");

  const filteredOptions = useMemo(() => {
    if (!search) return options;
    const searchLower = search.toLowerCase();
    return options.filter(opt => 
      String(opt[displayKey] || "").toLowerCase().includes(searchLower)
    );
  }, [options, search, displayKey]);

  const selectedOption = options.find(opt => opt[valueKey] === value);
  const displayValue = selectedOption ? selectedOption[displayKey] : placeholder;

  const handleSelect = (option) => {
    onChange(option[valueKey], option);
    setOpen(false);
    setSearch("");
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          disabled={disabled}
          className="w-full justify-between font-normal"
        >
          <span className={cn(!selectedOption && "text-muted-foreground")}>
            {displayValue}
          </span>
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-full p-0" align="start">
        <div className="p-2 border-b">
          <div className="flex items-center gap-2 px-2">
            <Search className="h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Buscar..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="border-0 focus-visible:ring-0 p-0 h-8"
            />
          </div>
        </div>
        <div className="max-h-60 overflow-y-auto p-1">
          {filteredOptions.length === 0 ? (
            <p className="text-sm text-muted-foreground text-center py-4">
              No se encontraron resultados
            </p>
          ) : (
            filteredOptions.map((option) => (
              <button
                key={option[valueKey]}
                onClick={() => handleSelect(option)}
                className={cn(
                  "w-full flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-accent",
                  value === option[valueKey] && "bg-accent"
                )}
              >
                <Check className={cn(
                  "h-4 w-4",
                  value === option[valueKey] ? "opacity-100" : "opacity-0"
                )} />
                {option[displayKey]}
              </button>
            ))
          )}
        </div>
        {onCreateNew && (
          <div className="p-2 border-t">
            <Button
              variant="ghost"
              className="w-full justify-start text-primary"
              onClick={() => {
                onCreateNew();
                setOpen(false);
              }}
            >
              <Plus className="h-4 w-4 mr-2" />
              {createNewLabel}
            </Button>
          </div>
        )}
      </PopoverContent>
    </Popover>
  );
}
</file>

<file path="src/components/tesoreria/CambiarEstadoChequeModal.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import SearchableSelect from '@/components/SearchableSelect';
import { Loader2, AlertTriangle } from 'lucide-react';
import { toast } from 'sonner';

export default function CambiarEstadoChequeModal({ open, cheque, bancos, onClose }) {
  const queryClient = useQueryClient();
  const [nuevoEstado, setNuevoEstado] = useState('');
  const [bancoId, setBancoId] = useState('');

  if (!cheque || !cheque.id) return null;

  const cambiarEstadoMutation = useMutation({
    mutationFn: async ({ chequeId, estado, bancoDestinoId }) => {
      // Actualizar estado del cheque
      await base44.entities.Cheque.update(chequeId, { estado });

      // Si es dep√≥sito, actualizar saldo del banco
      if (estado === 'Depositado' && bancoDestinoId) {
        const banco = bancos.find(b => b.id === bancoDestinoId);
        if (banco) {
          await base44.entities.Banco.update(bancoDestinoId, {
            saldo: (banco.saldo || 0) + cheque.monto
          });

          // Registrar movimiento de tesorer√≠a
          await base44.entities.MovimientoTesoreria.create({
            fecha: new Date().toISOString(),
            tipo_movimiento: 'Cr√©dito Bancario',
            destino_tipo: 'Banco',
            destino_id: bancoDestinoId,
            destino_nombre: banco.nombre,
            origen_tipo: 'Cheque',
            origen_id: chequeId,
            monto: cheque.monto,
            concepto: `Dep√≥sito de cheque N¬∞ ${cheque.numero_cheque}`,
            comprobante: cheque.numero_cheque
          });
        }
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cheques'] });
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
      toast.success('Estado del cheque actualizado');
      onClose();
    },
    onError: () => toast.error('Error al cambiar estado del cheque')
  });

  const handleCambiarEstado = () => {
    if (!nuevoEstado) {
      toast.error('Seleccione un estado');
      return;
    }

    if (nuevoEstado === 'Depositado' && !bancoId) {
      toast.error('Seleccione el banco de destino');
      return;
    }

    cambiarEstadoMutation.mutate({
      chequeId: cheque.id,
      estado: nuevoEstado,
      bancoDestinoId: bancoId
    });
  };

  const estadosDisponibles = () => {
    if (cheque.tipo === 'Terceros') {
      if (cheque.estado === 'En Cartera') {
        return ['Depositado', 'Endosado', 'Rechazado'];
      }
    } else {
      // Cheque Propio
      if (cheque.estado === 'En Cartera') {
        return ['Entregado'];
      }
    }
    return [];
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Cambiar Estado del Cheque</DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="bg-slate-100 rounded-lg p-4 space-y-2">
            <div className="flex justify-between">
              <span className="text-sm text-slate-600">Cheque N¬∞:</span>
              <span className="font-bold">{cheque.numero_cheque}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm text-slate-600">Estado Actual:</span>
              <span className="font-bold text-blue-600">{cheque.estado}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-sm text-slate-600">Monto:</span>
              <span className="font-bold text-green-600">
                ${(cheque.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
              </span>
            </div>
          </div>

          {estadosDisponibles().length === 0 ? (
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3">
              <AlertTriangle className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
              <p className="text-sm text-amber-700">
                No hay cambios de estado disponibles para este cheque en su estado actual.
              </p>
            </div>
          ) : (
            <>
              <div>
                <Label>Nuevo Estado *</Label>
                <select
                  value={nuevoEstado}
                  onChange={(e) => setNuevoEstado(e.target.value)}
                  className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                >
                  <option value="">Seleccionar estado...</option>
                  {estadosDisponibles().map(estado => (
                    <option key={estado} value={estado}>{estado}</option>
                  ))}
                </select>
              </div>

              {nuevoEstado === 'Depositado' && (
                <div>
                  <Label>Banco de Destino *</Label>
                  <SearchableSelect
                    options={bancos.filter(b => b.activa !== false)}
                    value={bancoId}
                    onChange={(id) => setBancoId(id)}
                    displayKey="nombre"
                    placeholder="Seleccionar banco..."
                  />
                  <p className="text-xs text-slate-500 mt-1">
                    El saldo del banco se actualizar√° autom√°ticamente
                  </p>
                </div>
              )}

              {nuevoEstado === 'Rechazado' && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <p className="text-sm text-red-700">
                    ‚ö†Ô∏è Al marcar como rechazado, se generar√° un ajuste en la cuenta corriente correspondiente.
                  </p>
                </div>
              )}
            </>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Cancelar
          </Button>
          {estadosDisponibles().length > 0 && (
            <Button
              onClick={handleCambiarEstado}
              disabled={cambiarEstadoMutation.isPending || !nuevoEstado}
              className="bg-purple-600 hover:bg-purple-700"
            >
              {cambiarEstadoMutation.isPending && (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              )}
              Confirmar Cambio
            </Button>
          )}
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/tesoreria/CobroConSalidasModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { Loader2, CheckCircle, Info } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { toast } from 'sonner';
import SearchableSelect from '@/components/SearchableSelect';
import AsyncSelect from '@/components/AsyncSelect';
import MediosPagoMixtosGrid from '@/components/tesoreria/MediosPagoMixtosGrid';
import MultiplesChequesGrid from '@/components/tesoreria/MultiplesChequesGrid';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';

export default function CobroConSalidasModal({ open, onClose, onSave, isLoading, clientes, bancos, cajas, salidas, cheques }) {
  const { data: bancosSistema = [] } = useQuery({
    queryKey: ['bancossistema'],
    queryFn: () => base44.entities.BancoSistema.list('nombre')
  });

  const { data: cuentasContables = [] } = useQuery({
    queryKey: ['plandecuentas'],
    queryFn: () => base44.entities.PlanDeCuentas.filter({ activa: true, imputable: true }, 'codigo')
  });
  const [tipoCobro, setTipoCobro] = useState('Aplicado'); // 'Aplicado' o 'A Cuenta'
  const [formData, setFormData] = useState({
    fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
    cliente_id: '',
    forma_cobro: 'Efectivo',
    destino_tipo: 'Caja',
    destino_id: '',
    cheque_id: '',
    monto: 0,
    concepto: '',
    comprobante: '',
    notas: '',
    cuenta_contable_id: '',
    cuenta_contable_codigo: '',
    cuenta_contable_nombre: ''
  });
  
  const [mediosMixtos, setMediosMixtos] = useState([]);
  const [chequesSeleccionados, setChequesSeleccionados] = useState([]);

  const [salidasSeleccionadas, setSalidasSeleccionadas] = useState([]);

  React.useEffect(() => {
    if (open) {
      setTipoCobro('Aplicado');
      setFormData({
        fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
        cliente_id: '',
        forma_cobro: 'Efectivo',
        destino_tipo: 'Caja',
        destino_id: '',
        cheque_id: '',
        monto: 0,
        concepto: '',
        comprobante: '',
        notas: '',
        cuenta_contable_id: '',
        cuenta_contable_codigo: '',
        cuenta_contable_nombre: ''
      });
      setSalidasSeleccionadas([]);
      setMediosMixtos([]);
      setChequesSeleccionados([]);
    }
  }, [open]);

  const salidasDelCliente = formData.cliente_id 
    ? salidas.filter(s => 
        s.cliente_id === formData.cliente_id && 
        s.estado === 'Confirmada' &&
        s.estado_cobro !== 'Cobrado'
      )
    : [];

  const toggleSalida = (salida) => {
    const existe = salidasSeleccionadas.find(s => s.salida_id === salida.id);
    if (existe) {
      setSalidasSeleccionadas(salidasSeleccionadas.filter(s => s.salida_id !== salida.id));
    } else {
      const pendiente = (salida.deuda_total || 0) - (salida.monto_cobrado || 0);
      setSalidasSeleccionadas([...salidasSeleccionadas, {
        salida_id: salida.id,
        monto_aplicado: pendiente,
        deuda_total: salida.deuda_total || 0,
        monto_cobrado: salida.monto_cobrado || 0,
        numero_remito: salida.numero_remito
      }]);
    }
  };

  const actualizarMontoSalida = (salidaId, nuevoMonto) => {
    setSalidasSeleccionadas(salidasSeleccionadas.map(s => 
      s.salida_id === salidaId ? { ...s, monto_aplicado: nuevoMonto } : s
    ));
  };

  const totalAPagar = salidasSeleccionadas.reduce((sum, s) => sum + s.monto_aplicado, 0);
  
  const totalCheques = chequesSeleccionados.reduce((sum, ch) => {
    if (ch.tipo === 'existente' && ch.cheque_id) {
      const chequeData = chequesDisponibles.find(c => c.id === ch.cheque_id);
      return sum + (chequeData?.monto || 0);
    } else if (ch.tipo === 'nuevo') {
      return sum + (ch.monto || 0);
    }
    return sum;
  }, 0);

  const handleGuardar = async () => {
    if (isLoading) return; // Prevenir clics m√∫ltiples
    
    if (!formData.cuenta_contable_id) {
      alert('Por favor seleccione una cuenta contable');
      return;
    }
    
    // Preparar medios de cobro detallados
    let mediosCobro = [];
    
    if (formData.forma_cobro === 'Mixta') {
      mediosCobro = mediosMixtos;
    } else if (formData.forma_cobro === 'Cheque') {
      // Procesar cheques: crear nuevos si es necesario
      for (const ch of chequesSeleccionados) {
        if (ch.tipo === 'nuevo') {
          // Crear el cheque nuevo
          const nuevoCheque = await base44.entities.Cheque.create({
            numero_cheque: ch.numero_cheque,
            tipo: 'Terceros',
            banco_id: ch.banco_id,
            banco_nombre: ch.banco_nombre,
            fecha_emision: ch.fecha_emision || format(new Date(), 'yyyy-MM-dd'),
            fecha_pago: ch.fecha_pago || format(new Date(), 'yyyy-MM-dd'),
            monto: ch.monto,
            emisor: ch.emisor || formData.cliente_nombre,
            titular: ch.titular || formData.cliente_nombre,
            estado: 'En Cartera'
          });
          
          mediosCobro.push({
            tipo: 'Cheque',
            destino_tipo: 'Cheque',
            destino_id: null,
            destino_nombre: 'Cheque',
            cheque_id: nuevoCheque.id,
            monto: ch.monto
          });
        } else if (ch.tipo === 'existente') {
          const chequeData = chequesDisponibles.find(c => c.id === ch.cheque_id);
          mediosCobro.push({
            tipo: 'Cheque',
            destino_tipo: 'Cheque',
            destino_id: null,
            destino_nombre: 'Cheque',
            cheque_id: ch.cheque_id,
            monto: chequeData?.monto || 0
          });
        }
      }
    } else {
      // Efectivo o Transferencia simple
      const destino = destinosDisponibles.find(d => d.id === formData.destino_id);
      mediosCobro.push({
        tipo: formData.forma_cobro,
        destino_tipo: formData.destino_tipo,
        destino_id: formData.destino_id,
        destino_nombre: destino?.nombre || '',
        monto: tipoCobro === 'A Cuenta' ? formData.monto : totalAPagar
      });
    }
    
    if (tipoCobro === 'A Cuenta') {
      const montoTotal = mediosCobro.reduce((sum, m) => sum + (m.monto || 0), 0);
      
      const cobroData = {
        fecha: formData.fecha,
        cliente_id: formData.cliente_id,
        cliente_nombre: clientes.find(c => c.id === formData.cliente_id)?.nombre || '',
        monto_total: montoTotal,
        concepto: formData.concepto,
        comprobante: formData.comprobante,
        notas: formData.notas,
        tipo_cobro: 'A Cuenta',
        monto_disponible: montoTotal,
        salidas_aplicadas: [],
        medios_cobro_detalles: mediosCobro,
        retenciones: []
      };
      onSave(cobroData);
    } else {
      if (salidasSeleccionadas.length === 0) return;

      const cobroData = {
        fecha: formData.fecha,
        cliente_id: formData.cliente_id,
        cliente_nombre: clientes.find(c => c.id === formData.cliente_id)?.nombre || '',
        monto_total: totalAPagar,
        concepto: formData.concepto || `Cobro de ${salidasSeleccionadas.length} salida(s)`,
        comprobante: formData.comprobante,
        notas: formData.notas,
        tipo_cobro: 'Aplicado',
        salidas_aplicadas: salidasSeleccionadas.map(s => ({
          salida_id: s.salida_id,
          monto_aplicado: s.monto_aplicado
        })),
        medios_cobro_detalles: mediosCobro,
        retenciones: []
      };

      onSave(cobroData);
    }
  };

  const destinosDisponibles = formData.destino_tipo === 'Banco' ? bancos : cajas;
  const chequesDisponibles = cheques?.filter(ch => ch.estado === 'Pendiente' && ch.origen === 'Terceros') || [];

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Nuevo Cobro</DialogTitle>
        </DialogHeader>
        <div className="space-y-5 py-4">
          {/* Tipo de Cobro */}
          <Card className="border-2 border-purple-200 bg-purple-50">
            <CardContent className="p-4">
              <h3 className="font-semibold text-purple-900 mb-3 flex items-center gap-2">
                <Info className="h-5 w-5" />
                Tipo de Cobro
              </h3>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => {
                    setTipoCobro('Aplicado');
                    setSalidasSeleccionadas([]);
                  }}
                  className={`p-4 rounded-lg border-2 transition-all ${
                    tipoCobro === 'Aplicado'
                      ? 'bg-green-100 border-green-500 shadow-md'
                      : 'bg-white border-slate-200 hover:border-slate-300'
                  }`}
                >
                  <p className="font-semibold text-slate-800 mb-1">Aplicar a Salidas</p>
                  <p className="text-xs text-slate-600">Asignar el cobro a salidas de fruta espec√≠ficas</p>
                </button>
                <button
                  onClick={() => {
                    setTipoCobro('A Cuenta');
                    setSalidasSeleccionadas([]);
                  }}
                  className={`p-4 rounded-lg border-2 transition-all ${
                    tipoCobro === 'A Cuenta'
                      ? 'bg-amber-100 border-amber-500 shadow-md'
                      : 'bg-white border-slate-200 hover:border-slate-300'
                  }`}
                >
                  <p className="font-semibold text-slate-800 mb-1">Cobro a Cuenta</p>
                  <p className="text-xs text-slate-600">Dinero adelantado sin asignar a movimientos (precios no confirmados)</p>
                </button>
              </div>
              {tipoCobro === 'A Cuenta' && (
                <div className="mt-3 p-3 bg-amber-50 border border-amber-300 rounded-lg">
                  <p className="text-xs text-amber-900">
                    üí° <strong>Cobro a Cuenta:</strong> √ösalo cuando recibas dinero pero los precios finales a√∫n no est√©n confirmados. 
                    Podr√°s aplicar este dinero a salidas espec√≠ficas m√°s adelante.
                  </p>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Cuenta Contable */}
          <div>
            <label className="text-sm font-medium">Cuenta Contable *</label>
            <SearchableSelect
              options={cuentasContables.filter(c => c.activa !== false && c.imputable !== false)}
              value={formData.cuenta_contable_id}
              onChange={(id, cuenta) => {
                setFormData({
                  ...formData,
                  cuenta_contable_id: id,
                  cuenta_contable_codigo: cuenta?.codigo || '',
                  cuenta_contable_nombre: cuenta?.nombre || ''
                });
              }}
              displayKey="nombre"
              placeholder="Seleccionar cuenta contable..."
            />
            {formData.cuenta_contable_codigo && (
              <p className="text-xs text-slate-500 mt-1">C√≥digo: {formData.cuenta_contable_codigo}</p>
            )}
            <p className="text-xs text-slate-500 mt-1">Este cobro se registrar√° en el Estado de Resultados</p>
          </div>

          {/* Selecci√≥n de Cliente (b√∫squeda as√≠ncrona) */}
          <div>
            <label className="text-sm font-medium">Cliente *</label>
            <AsyncSelect
              entityKey="Cliente"
              value={formData.cliente_id}
              onChange={(id) => {
                setFormData({...formData, cliente_id: id});
                setSalidasSeleccionadas([]);
              }}
              placeholder="Buscar cliente..."
            />
          </div>

          {/* Salidas Pendientes - SOLO si es tipo "Aplicado" */}
          {tipoCobro === 'Aplicado' && formData.cliente_id && (
            <div className="space-y-3">
              <h3 className="font-semibold text-slate-800">Salidas Pendientes de Cobro</h3>
              {salidasDelCliente.length === 0 ? (
                <Card className="bg-slate-50">
                  <CardContent className="p-6 text-center">
                    <CheckCircle className="h-12 w-12 text-slate-300 mx-auto mb-2" />
                    <p className="text-slate-500">No hay salidas pendientes de cobro para este cliente</p>
                  </CardContent>
                </Card>
              ) : (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {salidasDelCliente.map(salida => {
                    const seleccionada = salidasSeleccionadas.find(s => s.salida_id === salida.id);
                    const pendiente = (salida.deuda_total || 0) - (salida.monto_cobrado || 0);
                    
                    return (
                      <Card key={salida.id} className={`border cursor-pointer transition-all ${
                        seleccionada ? 'bg-green-50 border-green-300 shadow-sm' : 'hover:border-slate-300'
                      }`}>
                        <CardContent className="p-3">
                          <div className="flex items-start gap-3">
                            <input
                              type="checkbox"
                              checked={!!seleccionada}
                              onChange={() => toggleSalida(salida)}
                              className="h-4 w-4 mt-1 rounded border-slate-300"
                            />
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <p className="font-semibold text-slate-800">{salida.numero_remito}</p>
                                <Badge variant="outline" className="text-xs">
                                  {format(new Date(salida.fecha), 'dd/MM/yyyy', { locale: es })}
                                </Badge>
                                {salida.estado_cobro === 'Pago Parcial' && (
                                  <Badge className="bg-amber-100 text-amber-800 text-xs">
                                    Pago Parcial
                                  </Badge>
                                )}
                              </div>
                              <div className="grid grid-cols-3 gap-2 text-xs text-slate-600">
                                <div>
                                  <span className="text-slate-500">Total:</span>
                                  <p className="font-semibold">${salida.deuda_total?.toLocaleString('es-AR')}</p>
                                </div>
                                <div>
                                  <span className="text-slate-500">Cobrado:</span>
                                  <p className="font-semibold text-green-600">${(salida.monto_cobrado || 0).toLocaleString('es-AR')}</p>
                                </div>
                                <div>
                                  <span className="text-slate-500">Pendiente:</span>
                                  <p className="font-bold text-red-600">${pendiente.toLocaleString('es-AR')}</p>
                                </div>
                              </div>
                            </div>
                            {seleccionada && (
                              <div className="w-32">
                                <label className="text-xs text-slate-500">Cobrar ahora:</label>
                                <Input
                                  type="number"
                                  step="0.01"
                                  value={seleccionada.monto_aplicado}
                                  onChange={(e) => actualizarMontoSalida(salida.id, parseFloat(e.target.value) || 0)}
                                  className="h-8 text-sm mt-1"
                                />
                              </div>
                            )}
                          </div>
                        </CardContent>
                      </Card>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* Resumen de Cobro - SOLO si es tipo "Aplicado" */}
          {tipoCobro === 'Aplicado' && salidasSeleccionadas.length > 0 && (
            <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
              <CardContent className="p-4">
                <h4 className="font-semibold text-green-900 mb-3">Resumen del Cobro</h4>
                <div className="space-y-2 text-sm">
                  {salidasSeleccionadas.map(s => (
                    <div key={s.salida_id} className="flex justify-between">
                      <span className="text-slate-700">{s.numero_remito}:</span>
                      <span className="font-semibold">${s.monto_aplicado.toLocaleString('es-AR')}</span>
                    </div>
                  ))}
                  <div className="flex justify-between pt-2 mt-2 border-t-2 border-green-300">
                    <span className="font-bold">TOTAL A COBRAR:</span>
                    <span className="font-bold text-xl text-green-700">${totalAPagar.toLocaleString('es-AR')}</span>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Detalles del Cobro */}
          {(tipoCobro === 'A Cuenta' || salidasSeleccionadas.length > 0) && (
            <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
              <h4 className="font-semibold text-slate-800">Detalles del Cobro</h4>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium">Fecha *</label>
                  <Input type="datetime-local" value={formData.fecha} onChange={(e) => setFormData({...formData, fecha: e.target.value})} className="mt-1" />
                </div>
                <div>
                  <label className="text-sm font-medium">Forma de Cobro *</label>
                  <select
                    value={formData.forma_cobro}
                    onChange={(e) => {
                      const nuevaForma = e.target.value;
                      let nuevoDestinoTipo = formData.destino_tipo;
                      
                      // Determinar autom√°ticamente el tipo de cuenta seg√∫n la forma
                      if (nuevaForma === 'Efectivo') nuevoDestinoTipo = 'Caja';
                      else if (nuevaForma === 'Transferencia') nuevoDestinoTipo = 'Banco';
                      else if (nuevaForma === 'Cheque') nuevoDestinoTipo = 'Cheque';
                      
                      setFormData({
                        ...formData, 
                        forma_cobro: nuevaForma,
                        destino_tipo: nuevoDestinoTipo,
                        destino_id: ''
                      });
                    }}
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm mt-1"
                  >
                    <option value="Efectivo">üíµ Efectivo ‚Üí Caja</option>
                    <option value="Transferencia">üè¶ Transferencia ‚Üí Banco</option>
                    <option value="Cheque">üìÑ Cheque</option>
                    <option value="Mixta">üí≥ Mixta (varios medios)</option>
                  </select>
                </div>
              </div>

              {/* Forma MIXTA: mostrar grilla de medios */}
              {formData.forma_cobro === 'Mixta' ? (
                <MediosPagoMixtosGrid
                  montoTotal={tipoCobro === 'A Cuenta' ? formData.monto : totalAPagar}
                  medios={mediosMixtos}
                  onChange={setMediosMixtos}
                  bancos={bancos}
                  cajas={cajas}
                  cheques={cheques}
                  esIngreso={true}
                  onCrearCheque={(callback) => {
                    const numero_cheque = prompt('N√∫mero de cheque:');
                    const banco_id = bancosSistema[0]?.id;
                    if (numero_cheque && banco_id) {
                      const banco = bancosSistema.find(b => b.id === banco_id);
                      base44.entities.Cheque.create({
                        numero_cheque,
                        tipo: 'F√≠sico',
                        origen: 'Terceros',
                        banco_id,
                        banco_nombre: banco?.nombre || '',
                        fecha_emision: format(new Date(), 'yyyy-MM-dd'),
                        fecha_pago: format(new Date(), 'yyyy-MM-dd'),
                        monto: 0,
                        estado: 'Pendiente',
                        origen_modulo: 'Cobro'
                      }).then((nuevoCheque) => {
                        callback(nuevoCheque.id);
                        toast.success('Cheque registrado');
                      });
                    }
                  }}
                />
              ) : (
                <>
                  {formData.forma_cobro !== 'Cheque' && (
                    <div>
                      <label className="text-sm font-medium">
                        {formData.forma_cobro === 'Efectivo' && 'Caja Destino *'}
                        {formData.forma_cobro === 'Transferencia' && 'Banco Destino *'}
                        {formData.forma_cobro === 'Tarjeta' && 'Cuenta Destino *'}
                      </label>
                      <SearchableSelect
                        options={destinosDisponibles}
                        value={formData.destino_id}
                        onChange={(id) => setFormData({...formData, destino_id: id})}
                        displayKey="nombre"
                        placeholder={`Seleccionar ${formData.destino_tipo === 'Banco' ? 'banco' : 'caja'}...`}
                      />
                    </div>
                  )}
                </>
              )}

              {/* Monto - Solo para A Cuenta */}
              {tipoCobro === 'A Cuenta' && (
                <div>
                  <label className="text-sm font-medium">Monto *</label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.monto} 
                    onChange={(e) => setFormData({...formData, monto: parseFloat(e.target.value) || 0})} 
                    className="mt-1" 
                  />
                </div>
              )}

              <div>
                <label className="text-sm font-medium">Concepto {tipoCobro === 'A Cuenta' ? '*' : ''}</label>
                <Input 
                  value={formData.concepto} 
                  onChange={(e) => setFormData({...formData, concepto: e.target.value})} 
                  className="mt-1" 
                  placeholder={tipoCobro === 'A Cuenta' ? 'Ej: Adelanto por futuras salidas' : 'Opcional, se genera autom√°tico'} 
                />
              </div>

              <div>
                <label className="text-sm font-medium">Comprobante</label>
                <Input value={formData.comprobante} onChange={(e) => setFormData({...formData, comprobante: e.target.value})} className="mt-1" />
              </div>

              {/* Datos de Cheques - Solo si forma_cobro es Cheque */}
              {formData.forma_cobro === 'Cheque' && (
                <Card className="border-2 border-purple-200 bg-purple-50">
                  <CardContent className="p-4">
                    <h4 className="font-semibold text-purple-900 mb-3">Cheques de Terceros</h4>
                    <MultiplesChequesGrid
                      cheques={chequesSeleccionados}
                      onChange={setChequesSeleccionados}
                      chequesDisponibles={chequesDisponibles}
                      bancosSistema={bancosSistema}
                      esTerceros={true}
                    />
                    <p className="text-xs text-purple-700 mt-3">
                      üí° Puedes seleccionar cheques existentes o crear nuevos cheques de terceros
                    </p>
                  </CardContent>
                </Card>
              )}
            </div>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button 
            onClick={handleGuardar} 
            disabled={
              isLoading || 
              !formData.cliente_id || 
              (formData.forma_cobro !== 'Mixta' && formData.forma_cobro !== 'Cheque' && !formData.destino_id) ||
              (formData.forma_cobro === 'Mixta' && mediosMixtos.length === 0) ||
              (tipoCobro === 'Aplicado' && salidasSeleccionadas.length === 0) ||
              (tipoCobro === 'A Cuenta' && formData.forma_cobro !== 'Cheque' && formData.forma_cobro !== 'Mixta' && (formData.monto <= 0 || !formData.concepto)) ||
              (tipoCobro === 'A Cuenta' && !formData.concepto) ||
              (formData.forma_cobro === 'Cheque' && chequesSeleccionados.length === 0) ||
              (formData.forma_cobro === 'Cheque' && chequesSeleccionados.some(ch => 
                (ch.tipo === 'existente' && !ch.cheque_id) ||
                (ch.tipo === 'nuevo' && (!ch.numero_cheque || !ch.banco_id || ch.monto <= 0))
              ))
            }
            className={tipoCobro === 'A Cuenta' ? 'bg-amber-600 hover:bg-amber-700' : 'bg-green-600 hover:bg-green-700'}
          >
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            {tipoCobro === 'A Cuenta' 
              ? `Guardar Cobro a Cuenta ($${(formData.forma_cobro === 'Cheque' ? totalCheques : formData.forma_cobro === 'Mixta' ? mediosMixtos.reduce((s, m) => s + (m.importe || 0), 0) : formData.monto).toLocaleString('es-AR')})`
              : `Guardar Cobro ($${totalAPagar.toLocaleString('es-AR')})`
            }
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/tesoreria/EditarFechaMovimientoModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { AlertTriangle, Calendar, Loader2, Lock } from 'lucide-react';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function EditarFechaMovimientoModal({ open, onClose, movimiento, onGuardar }) {
  const [nuevaFecha, setNuevaFecha] = useState('');
  const [motivo, setMotivo] = useState('');
  const [pin, setPin] = useState('');
  const [guardando, setGuardando] = useState(false);
  const [error, setError] = useState('');

  React.useEffect(() => {
    if (open && movimiento) {
      // Establecer la fecha actual del movimiento como valor inicial
      const fecha = new Date(movimiento.fecha);
      setNuevaFecha(format(fecha, 'yyyy-MM-dd'));
      setMotivo('');
      setPin('');
      setError('');
    }
  }, [open, movimiento]);

  const validarYGuardar = async () => {
    // Validaciones
    if (!nuevaFecha) {
      setError('Debes seleccionar una fecha');
      return;
    }

    if (!pin || pin.trim() === '') {
      setError('Debes ingresar el PIN de seguridad');
      return;
    }

    // Verificar que la fecha haya cambiado
    const fechaOriginal = format(new Date(movimiento.fecha), 'yyyy-MM-dd');
    if (nuevaFecha === fechaOriginal) {
      setError('La fecha seleccionada es igual a la fecha actual');
      return;
    }

    setGuardando(true);
    setError('');

    try {
      await onGuardar({
        movimiento,
        nuevaFecha,
        motivo,
        pin
      });

      // Limpiar y cerrar
      handleClose();
    } catch (err) {
      console.error('Error al guardar:', err);
      setError(err.message || 'Error al guardar el cambio de fecha');
      setGuardando(false);
    }
  };

  const handleClose = () => {
    if (!guardando) {
      setNuevaFecha('');
      setMotivo('');
      setPin('');
      setError('');
      onClose();
    }
  };

  if (!movimiento) return null;

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Calendar className="h-5 w-5 text-teal-600" />
            Editar Fecha de Movimiento
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <Alert className="bg-amber-50 border-amber-200">
            <AlertTriangle className="h-4 w-4 text-amber-600" />
            <AlertDescription className="text-sm text-amber-800">
              <strong>Atenci√≥n:</strong> Solo se modificar√° la fecha. Los montos y saldos no cambiar√°n.
            </AlertDescription>
          </Alert>

          <div className="bg-slate-50 p-3 rounded-lg text-sm space-y-1">
            <p><strong>Movimiento:</strong> {movimiento.concepto}</p>
            <p><strong>Fecha actual:</strong> {format(new Date(movimiento.fecha), 'dd/MM/yyyy HH:mm', { locale: es })}</p>
            <p><strong>Monto:</strong> ${(movimiento.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}</p>
          </div>

          <div>
            <Label htmlFor="nuevaFecha">Nueva Fecha *</Label>
            <Input
              id="nuevaFecha"
              type="date"
              value={nuevaFecha}
              onChange={(e) => setNuevaFecha(e.target.value)}
              disabled={guardando}
            />
          </div>

          <div>
            <Label htmlFor="motivo">Motivo del Cambio (opcional)</Label>
            <Textarea
              id="motivo"
              value={motivo}
              onChange={(e) => setMotivo(e.target.value)}
              placeholder="Ej: Error en registro original, ajuste contable..."
              rows={3}
              disabled={guardando}
            />
          </div>

          <div>
            <Label htmlFor="pin" className="flex items-center gap-2">
              <Lock className="h-4 w-4" />
              PIN de Seguridad *
            </Label>
            <Input
              id="pin"
              type="password"
              value={pin}
              onChange={(e) => setPin(e.target.value)}
              placeholder="Ingresa tu PIN"
              disabled={guardando}
              autoComplete="off"
            />
            <p className="text-xs text-slate-500 mt-1">
              Se requiere PIN para autorizar el cambio de fecha
            </p>
          </div>

          {error && (
            <Alert variant="destructive">
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}
        </div>

        <DialogFooter>
          <Button 
            variant="outline" 
            onClick={handleClose}
            disabled={guardando}
          >
            Cancelar
          </Button>
          <Button
            onClick={validarYGuardar}
            disabled={guardando}
            className="bg-teal-600 hover:bg-teal-700"
          >
            {guardando ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Guardando...
              </>
            ) : (
              <>
                <Calendar className="h-4 w-4 mr-2" />
                Confirmar Cambio
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/tesoreria/ExportarMovimientosModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { AlertTriangle, FileDown, Loader2 } from 'lucide-react';
import { format, differenceInMonths } from 'date-fns';
import * as XLSX from 'xlsx';

export default function ExportarMovimientosModal({ open, onClose, movimientos }) {
  const [fechaDesde, setFechaDesde] = useState('');
  const [fechaHasta, setFechaHasta] = useState('');
  const [exporting, setExporting] = useState(false);
  const [error, setError] = useState('');

  const validarFechas = () => {
    if (!fechaDesde || !fechaHasta) {
      setError('Debes seleccionar ambas fechas');
      return false;
    }

    const desde = new Date(fechaDesde);
    const hasta = new Date(fechaHasta);

    if (desde > hasta) {
      setError('La fecha "Desde" no puede ser posterior a la fecha "Hasta"');
      return false;
    }

    const mesesDiferencia = differenceInMonths(hasta, desde);
    if (mesesDiferencia > 3) {
      setError('El rango m√°ximo permitido es de 3 meses');
      return false;
    }

    setError('');
    return true;
  };

  const exportarExcel = async () => {
    if (!validarFechas()) return;

    setExporting(true);
    
    try {
      // Filtrar movimientos por rango de fechas
      const desde = new Date(fechaDesde);
      desde.setHours(0, 0, 0, 0);
      const hasta = new Date(fechaHasta);
      hasta.setHours(23, 59, 59, 999);

      const movimientosFiltrados = movimientos.filter(mov => {
        const fechaMov = new Date(mov.fecha);
        return fechaMov >= desde && fechaMov <= hasta;
      });

      if (movimientosFiltrados.length === 0) {
        setError('No hay movimientos en el rango de fechas seleccionado');
        setExporting(false);
        return;
      }

      // Preparar datos para Excel
      const datosExcel = movimientosFiltrados.map(mov => ({
        'Fecha': mov.fecha ? format(new Date(mov.fecha), 'dd/MM/yyyy HH:mm') : '',
        'Tipo Movimiento': mov.tipo_movimiento || '',
        'Origen': mov.origen_nombre || '',
        'Tipo Origen': mov.origen_tipo || '',
        'Destino': mov.destino_nombre || '',
        'Tipo Destino': mov.destino_tipo || '',
        'Monto': mov.monto || 0,
        'Concepto': mov.concepto || '',
        'Comprobante': mov.comprobante || '',
        'Referencia Tipo': mov.referencia_origen_tipo || '',
        'Referencia ID': mov.referencia_origen_id || ''
      }));

      // Calcular totales
      const totalIngresos = movimientosFiltrados
        .filter(m => ['Ingreso Manual', 'Cr√©dito Bancario'].includes(m.tipo_movimiento))
        .reduce((sum, m) => sum + (m.monto || 0), 0);

      const totalEgresos = movimientosFiltrados
        .filter(m => ['Egreso Manual', 'D√©bito Bancario'].includes(m.tipo_movimiento))
        .reduce((sum, m) => sum + (m.monto || 0), 0);

      const totalTransferencias = movimientosFiltrados
        .filter(m => m.tipo_movimiento === 'Transferencia Interna')
        .reduce((sum, m) => sum + (m.monto || 0), 0);

      // Crear hoja de c√°lculo
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(datosExcel);

      // Agregar encabezado antes de los datos
      XLSX.utils.sheet_add_aoa(ws, [
        ['SISTEMA DE GESTI√ìN DE ACOPIO'],
        ['EXPORTACI√ìN DE MOVIMIENTOS DE TESORER√çA'],
        ['Fecha de generaci√≥n: ' + format(new Date(), 'dd/MM/yyyy HH:mm')],
        ['Per√≠odo: ' + format(desde, 'dd/MM/yyyy') + ' al ' + format(hasta, 'dd/MM/yyyy')],
        [''],
        ['Total de movimientos: ' + movimientosFiltrados.length],
        [''],
      ], { origin: 'A1' });

      // Agregar totales al final
      const lastRow = datosExcel.length + 9; // 7 l√≠neas de encabezado + 1 l√≠nea de datos + 1 para totales
      XLSX.utils.sheet_add_aoa(ws, [
        [''],
        ['RESUMEN'],
        ['Total Ingresos:', totalIngresos.toFixed(2)],
        ['Total Egresos:', totalEgresos.toFixed(2)],
        ['Total Transferencias:', totalTransferencias.toFixed(2)],
        ['Resultado Neto (Ingresos - Egresos):', (totalIngresos - totalEgresos).toFixed(2)]
      ], { origin: `A${lastRow}` });

      // Ajustar anchos de columnas
      const columnWidths = [
        { wch: 18 }, // Fecha
        { wch: 20 }, // Tipo Movimiento
        { wch: 25 }, // Origen
        { wch: 12 }, // Tipo Origen
        { wch: 25 }, // Destino
        { wch: 12 }, // Tipo Destino
        { wch: 15 }, // Monto
        { wch: 40 }, // Concepto
        { wch: 20 }, // Comprobante
        { wch: 15 }, // Referencia Tipo
        { wch: 30 }  // Referencia ID
      ];
      ws['!cols'] = columnWidths;

      // Agregar hoja al libro
      XLSX.utils.book_append_sheet(wb, ws, 'Movimientos Tesorer√≠a');

      // Generar archivo y descargar
      const nombreArchivo = `MovimientosTesoreria_${format(desde, 'yyyyMMdd')}_${format(hasta, 'yyyyMMdd')}.xlsx`;
      XLSX.writeFile(wb, nombreArchivo);

      // Cerrar modal y resetear
      setTimeout(() => {
        setExporting(false);
        onClose();
        setFechaDesde('');
        setFechaHasta('');
        setError('');
      }, 500);

    } catch (err) {
      console.error('Error al exportar:', err);
      setError('Error al generar el archivo. Por favor, intenta nuevamente.');
      setExporting(false);
    }
  };

  const handleClose = () => {
    if (!exporting) {
      setFechaDesde('');
      setFechaHasta('');
      setError('');
      onClose();
    }
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <FileDown className="h-5 w-5 text-teal-600" />
            Exportar Movimientos de Tesorer√≠a
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <Alert className="bg-blue-50 border-blue-200">
            <AlertTriangle className="h-4 w-4 text-blue-600" />
            <AlertDescription className="text-sm text-blue-800">
              El rango de fechas es obligatorio. M√°ximo permitido: 3 meses.
            </AlertDescription>
          </Alert>

          <div className="space-y-3">
            <div>
              <Label htmlFor="fechaDesde">Fecha Desde *</Label>
              <Input
                id="fechaDesde"
                type="date"
                value={fechaDesde}
                onChange={(e) => setFechaDesde(e.target.value)}
                disabled={exporting}
              />
            </div>

            <div>
              <Label htmlFor="fechaHasta">Fecha Hasta *</Label>
              <Input
                id="fechaHasta"
                type="date"
                value={fechaHasta}
                onChange={(e) => setFechaHasta(e.target.value)}
                disabled={exporting}
              />
            </div>
          </div>

          {error && (
            <Alert variant="destructive">
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          <div className="text-xs text-slate-500 bg-slate-50 p-3 rounded-lg">
            <p className="font-semibold mb-1">Campos incluidos en el archivo:</p>
            <ul className="list-disc list-inside space-y-0.5">
              <li>Fecha, Tipo de Movimiento, Origen/Destino</li>
              <li>Monto, Concepto, Comprobante</li>
              <li>Referencia (tipo y ID de origen)</li>
            </ul>
          </div>
        </div>

        <DialogFooter>
          <Button 
            variant="outline" 
            onClick={handleClose}
            disabled={exporting}
          >
            Cancelar
          </Button>
          <Button
            onClick={exportarExcel}
            disabled={exporting || !fechaDesde || !fechaHasta}
            className="bg-teal-600 hover:bg-teal-700"
          >
            {exporting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Generando...
              </>
            ) : (
              <>
                <FileDown className="h-4 w-4 mr-2" />
                Exportar Excel
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/tesoreria/ExportarMovimientosPDFModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { AlertTriangle, FileText, Loader2 } from 'lucide-react';
import { format, differenceInMonths } from 'date-fns';
import { es } from 'date-fns/locale';

export default function ExportarMovimientosPDFModal({ open, onClose, onExportar }) {
  const [fechaDesde, setFechaDesde] = useState('');
  const [fechaHasta, setFechaHasta] = useState('');
  const [exporting, setExporting] = useState(false);
  const [error, setError] = useState('');

  const validarFechas = () => {
    if (!fechaDesde || !fechaHasta) {
      setError('Debes seleccionar ambas fechas para exportar');
      return false;
    }

    const desde = new Date(fechaDesde);
    const hasta = new Date(fechaHasta);

    if (desde > hasta) {
      setError('La fecha "Desde" no puede ser posterior a la fecha "Hasta"');
      return false;
    }

    const mesesDiferencia = differenceInMonths(hasta, desde);
    if (mesesDiferencia > 6) {
      setError('El rango m√°ximo permitido es de 6 meses');
      return false;
    }

    setError('');
    return true;
  };

  const handleExportar = async () => {
    if (!validarFechas()) return;

    setExporting(true);
    
    try {
      await onExportar(fechaDesde, fechaHasta);
      
      setTimeout(() => {
        setExporting(false);
        handleClose();
      }, 500);
    } catch (err) {
      console.error('Error al exportar PDF:', err);
      setError('Error al generar el PDF. Por favor, intenta nuevamente.');
      setExporting(false);
    }
  };

  const handleClose = () => {
    if (!exporting) {
      setFechaDesde('');
      setFechaHasta('');
      setError('');
      onClose();
    }
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <FileText className="h-5 w-5 text-teal-600" />
            Exportar PDF - Movimientos de Tesorer√≠a
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <Alert className="bg-amber-50 border-amber-200">
            <AlertTriangle className="h-4 w-4 text-amber-600" />
            <AlertDescription className="text-sm text-amber-800">
              <strong>Obligatorio:</strong> Debes seleccionar un rango de fechas. M√°ximo: 6 meses.
            </AlertDescription>
          </Alert>

          <div className="space-y-3">
            <div>
              <Label htmlFor="fechaDesde">Fecha Desde *</Label>
              <Input
                id="fechaDesde"
                type="date"
                value={fechaDesde}
                onChange={(e) => setFechaDesde(e.target.value)}
                disabled={exporting}
              />
            </div>

            <div>
              <Label htmlFor="fechaHasta">Fecha Hasta *</Label>
              <Input
                id="fechaHasta"
                type="date"
                value={fechaHasta}
                onChange={(e) => setFechaHasta(e.target.value)}
                disabled={exporting}
              />
            </div>
          </div>

          {error && (
            <Alert variant="destructive">
              <AlertTriangle className="h-4 w-4" />
              <AlertDescription>{error}</AlertDescription>
            </Alert>
          )}

          <div className="text-xs text-slate-500 bg-slate-50 p-3 rounded-lg">
            <p className="font-semibold mb-1">El PDF incluir√°:</p>
            <ul className="list-disc list-inside space-y-0.5">
              <li>Fecha, Tipo, Descripci√≥n</li>
              <li>Origen, Cuenta, Monto</li>
              <li>Totales: Ingresos, Egresos, Resultado Neto</li>
            </ul>
          </div>
        </div>

        <DialogFooter>
          <Button 
            variant="outline" 
            onClick={handleClose}
            disabled={exporting}
          >
            Cancelar
          </Button>
          <Button
            onClick={handleExportar}
            disabled={exporting || !fechaDesde || !fechaHasta}
            className="bg-teal-600 hover:bg-teal-700"
          >
            {exporting ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Generando PDF...
              </>
            ) : (
              <>
                <FileText className="h-4 w-4 mr-2" />
                Generar PDF
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/tesoreria/ImputarPagoModal.jsx">
import React, { useState, useMemo } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Loader2, FileText, CheckCircle2 } from 'lucide-react';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function ImputarPagoModal({ open, onClose, pago, movimientos, onImputar, isLoading }) {
  const [seleccionados, setSeleccionados] = useState([]);

  // Filtrar movimientos del proveedor que tienen deuda pendiente
  const movimientosPendientes = useMemo(() => {
    if (!pago) return [];
    return movimientos.filter(m => 
      m.proveedor_id === pago.proveedor_id &&
      m.tipo_movimiento === 'Ingreso de Fruta' &&
      (m.deuda_total || 0) > (m.monto_pagado || 0)
    );
  }, [movimientos, pago]);

  const montoDisponible = pago?.monto_disponible || 0;
  const montoAsignado = seleccionados.reduce((sum, s) => sum + (s.monto || 0), 0);
  const montoRestante = (montoDisponible || 0) - (montoAsignado || 0);

  const toggleSeleccion = (movimiento) => {
    const yaSeleccionado = seleccionados.find(s => s.movimiento_id === movimiento.id);
    
    if (yaSeleccionado) {
      setSeleccionados(seleccionados.filter(s => s.movimiento_id !== movimiento.id));
    } else {
      const deudaPendiente = (movimiento.deuda_total || 0) - (movimiento.monto_pagado || 0);
      const montoAAplicar = Math.min(deudaPendiente, montoRestante);
      
      if (montoAAplicar > 0) {
        setSeleccionados([...seleccionados, {
          movimiento_id: movimiento.id,
          monto: montoAAplicar
        }]);
      }
    }
  };

  const actualizarMonto = (movimientoId, nuevoMonto) => {
    const movimiento = movimientosPendientes.find(m => m.id === movimientoId);
    if (!movimiento) return;

    const deudaPendiente = (movimiento.deuda_total || 0) - (movimiento.monto_pagado || 0);
    const otrosMontos = seleccionados.filter(s => s.movimiento_id !== movimientoId).reduce((sum, s) => sum + (s.monto || 0), 0);
    const disponibleParaEste = montoDisponible - otrosMontos;
    
    const montoValido = Math.max(0, Math.min(nuevoMonto, deudaPendiente, disponibleParaEste));
    
    setSeleccionados(seleccionados.map(s => 
      s.movimiento_id === movimientoId ? { ...s, monto: montoValido } : s
    ));
  };

  const handleImputar = () => {
    if (seleccionados.length === 0) return;
    onImputar(seleccionados);
  };

  if (!pago) return null;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Imputar Pago a Comprobantes</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* Info del pago */}
          <div className="bg-slate-50 rounded-lg p-4">
            <div className="grid grid-cols-2 gap-3 text-sm">
              <div>
                <span className="text-slate-500">Proveedor:</span>
                <p className="font-semibold">{pago.proveedor_nombre}</p>
              </div>
              <div>
                <span className="text-slate-500">Fecha:</span>
                <p className="font-semibold">{format(new Date(pago.fecha), 'dd/MM/yyyy', { locale: es })}</p>
              </div>
              <div>
                <span className="text-slate-500">Monto Disponible:</span>
                <p className="font-semibold text-blue-600">
                  ${(montoDisponible || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                </p>
              </div>
              <div>
                <span className="text-slate-500">Monto Restante:</span>
                <p className="font-semibold text-orange-600">
                  ${(montoRestante || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                </p>
              </div>
            </div>
          </div>

          {/* Lista de movimientos pendientes */}
          <div>
            <h3 className="font-semibold mb-3">Comprobantes de Compra con Deuda Pendiente</h3>
            
            {movimientosPendientes.length === 0 ? (
              <div className="text-center py-8 text-slate-500">
                <FileText className="h-12 w-12 mx-auto mb-2 text-slate-300" />
                <p>No hay comprobantes pendientes de este proveedor</p>
              </div>
            ) : (
              <div className="space-y-2">
                {movimientosPendientes.map(mov => {
                  const deudaPendiente = (mov.deuda_total || 0) - (mov.monto_pagado || 0);
                  const seleccionado = seleccionados.find(s => s.movimiento_id === mov.id);
                  
                  return (
                    <div
                      key={mov.id}
                      className={`border rounded-lg p-4 transition-all ${
                        seleccionado ? 'border-green-300 bg-green-50' : 'border-slate-200 hover:border-slate-300'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-sm font-medium">
                              {format(new Date(mov.fecha), 'dd/MM/yyyy', { locale: es })}
                            </span>
                            <Badge variant="outline">Ingreso de Fruta</Badge>
                          </div>
                          
                          <div className="text-sm text-slate-600">
                            <span>Deuda Total: ${(mov.deuda_total || 0).toLocaleString('es-AR')}</span>
                            <span className="mx-2">‚Ä¢</span>
                            <span>Pagado: ${(mov.monto_pagado || 0).toLocaleString('es-AR')}</span>
                            <span className="mx-2">‚Ä¢</span>
                            <span className="font-semibold text-orange-600">
                              Pendiente: ${(deudaPendiente || 0).toLocaleString('es-AR')}
                            </span>
                          </div>
                        </div>

                        <div className="flex items-center gap-3">
                          {seleccionado && (
                            <div className="flex items-center gap-2">
                              <Input
                                type="number"
                                value={seleccionado.monto}
                                onChange={(e) => actualizarMonto(mov.id, parseFloat(e.target.value) || 0)}
                                className="w-32"
                                min="0"
                                max={deudaPendiente}
                                step="0.01"
                              />
                            </div>
                          )}
                          
                          <Button
                            variant={seleccionado ? "default" : "outline"}
                            size="sm"
                            onClick={() => toggleSeleccion(mov)}
                            disabled={!seleccionado && montoRestante <= 0}
                          >
                            {seleccionado ? (
                              <>
                                <CheckCircle2 className="h-4 w-4 mr-1" />
                                Seleccionado
                              </>
                            ) : (
                              'Seleccionar'
                            )}
                          </Button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Resumen */}
          {seleccionados.length > 0 && (
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-600">
                    {seleccionados.length} comprobante(s) seleccionado(s)
                  </p>
                  <p className="text-lg font-bold text-green-700">
                    Total a Imputar: ${(montoAsignado || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Acciones */}
          <div className="flex justify-end gap-2 pt-4 border-t">
            <Button variant="outline" onClick={onClose} disabled={isLoading}>
              Cancelar
            </Button>
            <Button
              onClick={handleImputar}
              disabled={seleccionados.length === 0 || isLoading}
              className="bg-green-600 hover:bg-green-700"
            >
              {isLoading ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Imputando...
                </>
              ) : (
                'Imputar Pago'
              )}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/tesoreria/MediosPagoMixtosGrid.jsx">
import React, { useState, useEffect } from 'react';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import SearchableSelect from '@/components/SearchableSelect';
import { Plus, Trash2, AlertCircle, CheckCircle } from "lucide-react";
import { toast } from "sonner";

export default function MediosPagoMixtosGrid({ 
  montoTotal, 
  medios, 
  onChange, 
  bancos, 
  cajas, 
  cheques,
  esIngreso = false,
  onCrearCheque 
}) {
  const [filas, setFilas] = useState(medios || []);

  useEffect(() => {
    onChange(filas);
  }, [filas]);

  const agregarFila = () => {
    setFilas([...filas, {
      forma: 'Efectivo',
      tipo_cuenta: 'Caja',
      cuenta_id: '',
      importe: 0,
      cheque_datos: null
    }]);
  };

  const eliminarFila = (index) => {
    const nuevasFilas = filas.filter((_, i) => i !== index);
    setFilas(nuevasFilas);
  };

  const actualizarFila = (index, campo, valor) => {
    const nuevasFilas = [...filas];
    nuevasFilas[index] = { ...nuevasFilas[index], [campo]: valor };
    
    // Actualizar tipo_cuenta autom√°ticamente seg√∫n forma
    if (campo === 'forma') {
      if (valor === 'Efectivo') {
        nuevasFilas[index].tipo_cuenta = 'Caja';
        nuevasFilas[index].cuenta_id = '';
      } else if (valor === 'Transferencia') {
        nuevasFilas[index].tipo_cuenta = 'Banco';
        nuevasFilas[index].cuenta_id = '';
      } else if (valor === 'Cheque') {
        nuevasFilas[index].tipo_cuenta = 'Cheque';
        nuevasFilas[index].cuenta_id = '';
        nuevasFilas[index].cheque_datos = null;
      }
    }
    
    setFilas(nuevasFilas);
  };

  const totalParcial = filas.reduce((sum, f) => sum + (f.importe || 0), 0);
  const diferencia = montoTotal - totalParcial;
  const esValido = Math.abs(diferencia) < 0.01;

  const getCuentasDisponibles = (forma) => {
    if (forma === 'Efectivo') return cajas;
    if (forma === 'Transferencia') return bancos;
    if (forma === 'Cheque') {
      return esIngreso 
        ? cheques.filter(ch => ch.estado === 'Pendiente' && ch.origen === 'Terceros')
        : cheques.filter(ch => ch.estado === 'Pendiente' && ch.origen === 'Propio');
    }
    return [];
  };

  return (
    <Card className="border-2 border-purple-200 bg-purple-50">
      <CardContent className="p-4">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h5 className="font-semibold text-purple-900">üí≥ Medios de Pago/Cobro</h5>
            <p className="text-xs text-purple-700 mt-1">Distribuya el monto total entre diferentes medios</p>
          </div>
          <Button size="sm" onClick={agregarFila} className="bg-purple-600 hover:bg-purple-700">
            <Plus className="h-4 w-4 mr-1" />
            Agregar Medio
          </Button>
        </div>

        {/* Resumen */}
        <div className="grid grid-cols-3 gap-2 mb-4 p-3 bg-white rounded-lg border">
          <div>
            <p className="text-xs text-slate-500">Total a cobrar/pagar</p>
            <p className="font-bold text-slate-800">${montoTotal.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</p>
          </div>
          <div>
            <p className="text-xs text-slate-500">Total distribuido</p>
            <p className={`font-bold ${esValido ? 'text-green-600' : 'text-red-600'}`}>
              ${totalParcial.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
            </p>
          </div>
          <div>
            <p className="text-xs text-slate-500">Diferencia</p>
            <p className={`font-bold ${esValido ? 'text-green-600' : 'text-red-600'}`}>
              ${Math.abs(diferencia).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
            </p>
          </div>
        </div>

        {!esValido && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
            <AlertCircle className="h-5 w-5 text-red-600 shrink-0 mt-0.5" />
            <div>
              <p className="text-sm font-medium text-red-900">La suma no coincide con el total</p>
              <p className="text-xs text-red-700 mt-1">
                {diferencia > 0 
                  ? `Faltan $${diferencia.toLocaleString('es-AR', { minimumFractionDigits: 2 })} por distribuir`
                  : `Hay $${Math.abs(diferencia).toLocaleString('es-AR', { minimumFractionDigits: 2 })} de m√°s`
                }
              </p>
            </div>
          </div>
        )}

        {esValido && filas.length > 0 && (
          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2">
            <CheckCircle className="h-5 w-5 text-green-600" />
            <p className="text-sm font-medium text-green-900">‚úì La distribuci√≥n es correcta</p>
          </div>
        )}

        {/* Grilla de medios */}
        <div className="space-y-3">
          {filas.map((fila, index) => (
            <Card key={index} className="bg-white border-2">
              <CardContent className="p-4">
                <div className="flex items-start gap-3">
                  <Badge className="mt-2 bg-purple-600">#{index + 1}</Badge>
                  
                  <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                    {/* Forma de Pago/Cobro */}
                    <div>
                      <label className="text-xs font-medium text-slate-700">Forma *</label>
                      <select
                        value={fila.forma}
                        onChange={(e) => actualizarFila(index, 'forma', e.target.value)}
                        className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-sm mt-1"
                      >
                        <option value="Efectivo">üíµ Efectivo</option>
                        <option value="Transferencia">üè¶ Transferencia</option>
                        <option value="Cheque">üìÑ Cheque</option>
                      </select>
                    </div>

                    {/* Cuenta */}
                    <div>
                      <label className="text-xs font-medium text-slate-700">
                        {fila.forma === 'Efectivo' && 'Caja *'}
                        {fila.forma === 'Transferencia' && 'Banco *'}
                        {fila.forma === 'Cheque' && 'Cheque *'}
                      </label>
                      {fila.forma === 'Cheque' ? (
                        <select
                          value={fila.cuenta_id}
                          onChange={(e) => {
                            if (e.target.value === 'nuevo') {
                              onCrearCheque((nuevoChequeId) => {
                                actualizarFila(index, 'cuenta_id', nuevoChequeId);
                              });
                            } else {
                              actualizarFila(index, 'cuenta_id', e.target.value);
                            }
                          }}
                          className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-sm mt-1"
                        >
                          <option value="">Seleccionar...</option>
                          <option value="nuevo">‚ûï Registrar Nuevo Cheque</option>
                          {getCuentasDisponibles(fila.forma).map(ch => (
                            <option key={ch.id} value={ch.id}>
                              {ch.numero_cheque} - ${ch.monto.toLocaleString('es-AR')}
                            </option>
                          ))}
                        </select>
                      ) : (
                        <SearchableSelect
                          options={getCuentasDisponibles(fila.forma)}
                          value={fila.cuenta_id}
                          onChange={(id) => actualizarFila(index, 'cuenta_id', id)}
                          displayKey="nombre"
                          placeholder="Seleccionar..."
                        />
                      )}
                    </div>

                    {/* Importe */}
                    <div>
                      <label className="text-xs font-medium text-slate-700">Importe *</label>
                      <Input
                        type="number"
                        step="0.01"
                        value={fila.importe || ''}
                        onChange={(e) => actualizarFila(index, 'importe', parseFloat(e.target.value) || 0)}
                        className="h-9 mt-1"
                        placeholder="0.00"
                      />
                    </div>
                  </div>

                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => eliminarFila(index)}
                    className="text-red-500 hover:text-red-700 hover:bg-red-50 mt-7"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}

          {filas.length === 0 && (
            <div className="text-center py-8 bg-white rounded-lg border-2 border-dashed border-slate-200">
              <p className="text-slate-500 text-sm mb-3">No hay medios agregados</p>
              <Button size="sm" onClick={agregarFila} variant="outline">
                <Plus className="h-4 w-4 mr-2" />
                Agregar Primer Medio
              </Button>
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/tesoreria/MultiplesChequesGrid.jsx">
import React from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";
import { Trash2, Plus } from "lucide-react";
import SearchableSelect from '@/components/SearchableSelect';
import { format } from 'date-fns';

export default function MultiplesChequesGrid({ 
  cheques, 
  onChange, 
  chequesDisponibles, 
  bancosSistema,
  esTerceros = true // true para cobros (terceros), false para pagos (propios)
}) {
  const agregarCheque = () => {
    onChange([...cheques, {
      id: `temp_${Date.now()}`,
      tipo: 'existente',
      cheque_id: '',
      // Datos para nuevo cheque
      numero_cheque: '',
      tipo_cheque: 'F√≠sico',
      banco_id: '',
      fecha_emision: format(new Date(), 'yyyy-MM-dd'),
      fecha_pago: format(new Date(), 'yyyy-MM-dd'),
      monto: 0,
      emisor: '',
      beneficiario: '',
      titular: '',
      notas: ''
    }]);
  };

  const eliminarCheque = (id) => {
    onChange(cheques.filter(ch => ch.id !== id));
  };

  const actualizarCheque = (id, campo, valor) => {
    onChange(cheques.map(ch => 
      ch.id === id ? { ...ch, [campo]: valor } : ch
    ));
  };

  const totalCheques = cheques.reduce((sum, ch) => {
    if (ch.tipo === 'existente' && ch.cheque_id) {
      const chequeData = chequesDisponibles.find(c => c.id === ch.cheque_id);
      return sum + (chequeData?.monto || 0);
    } else if (ch.tipo === 'nuevo') {
      return sum + (ch.monto || 0);
    }
    return sum;
  }, 0);

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <h5 className="font-semibold text-amber-900">Cheques</h5>
        <Button 
          type="button"
          size="sm" 
          onClick={agregarCheque}
          className="bg-amber-600 hover:bg-amber-700"
        >
          <Plus className="h-4 w-4 mr-1" />
          Agregar Cheque
        </Button>
      </div>

      {cheques.length === 0 ? (
        <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg text-center text-sm text-amber-700">
          No hay cheques agregados. Haz clic en "Agregar Cheque" para comenzar.
        </div>
      ) : (
        <div className="space-y-2">
          {cheques.map((cheque, index) => (
            <Card key={cheque.id} className="border-2 border-amber-200 bg-amber-50">
              <CardContent className="p-3">
                <div className="flex items-start gap-3">
                  <div className="flex-1 space-y-3">
                    <div className="flex items-center justify-between">
                      <span className="font-semibold text-slate-700">Cheque #{index + 1}</span>
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => eliminarCheque(cheque.id)}
                        className="text-red-600 hover:text-red-700 hover:bg-red-50"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>

                    <div>
                      <label className="text-xs font-medium">Tipo de Cheque</label>
                      <select
                        value={cheque.tipo}
                        onChange={(e) => {
                          actualizarCheque(cheque.id, 'tipo', e.target.value);
                          if (e.target.value === 'existente') {
                            actualizarCheque(cheque.id, 'cheque_id', '');
                          }
                        }}
                        className="flex h-9 w-full rounded-md border border-amber-300 bg-white px-2 py-1 text-sm mt-1"
                      >
                        <option value="existente">Cheque Existente</option>
                        <option value="nuevo">Registrar Nuevo Cheque</option>
                      </select>
                    </div>

                    {cheque.tipo === 'existente' ? (
                      <div>
                        <label className="text-xs font-medium">Seleccionar Cheque *</label>
                        <select
                          value={cheque.cheque_id}
                          onChange={(e) => actualizarCheque(cheque.id, 'cheque_id', e.target.value)}
                          className="flex h-9 w-full rounded-md border border-amber-300 bg-white px-2 py-1 text-sm mt-1"
                        >
                          <option value="">Seleccionar...</option>
                          {chequesDisponibles
                            .filter(ch => !cheques.some(c => c.tipo === 'existente' && c.cheque_id === ch.id && c.id !== cheque.id))
                            .map(ch => (
                              <option key={ch.id} value={ch.id}>
                                {ch.numero_cheque} - {ch.banco_nombre} - ${ch.monto.toLocaleString('es-AR')}
                              </option>
                            ))}
                        </select>
                        {cheque.cheque_id && chequesDisponibles.find(ch => ch.id === cheque.cheque_id) && (
                          <p className="text-xs text-green-700 mt-1 font-semibold">
                            Monto: ${chequesDisponibles.find(ch => ch.id === cheque.cheque_id)?.monto.toLocaleString('es-AR')}
                          </p>
                        )}
                      </div>
                    ) : (
                      <div className="space-y-2">
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="text-xs font-medium">N√∫mero de Cheque *</label>
                            <Input
                              value={cheque.numero_cheque}
                              onChange={(e) => actualizarCheque(cheque.id, 'numero_cheque', e.target.value)}
                              className="h-9 text-sm mt-1"
                              placeholder="12345678"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-medium">Tipo *</label>
                            <select
                              value={cheque.tipo_cheque}
                              onChange={(e) => actualizarCheque(cheque.id, 'tipo_cheque', e.target.value)}
                              className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-2 py-1 text-sm mt-1"
                            >
                              <option value="F√≠sico">F√≠sico</option>
                              <option value="Electr√≥nico">Electr√≥nico</option>
                            </select>
                          </div>
                        </div>

                        <div>
                          <label className="text-xs font-medium">Banco Emisor *</label>
                          <SearchableSelect
                            options={bancosSistema}
                            value={cheque.banco_id}
                            onChange={(id) => actualizarCheque(cheque.id, 'banco_id', id)}
                            displayKey="nombre"
                            placeholder="Seleccionar banco..."
                          />
                        </div>

                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="text-xs font-medium">Fecha Emisi√≥n *</label>
                            <Input
                              type="date"
                              value={cheque.fecha_emision}
                              onChange={(e) => actualizarCheque(cheque.id, 'fecha_emision', e.target.value)}
                              className="h-9 text-sm mt-1"
                            />
                          </div>
                          <div>
                            <label className="text-xs font-medium">Fecha Vencimiento *</label>
                            <Input
                              type="date"
                              value={cheque.fecha_pago}
                              onChange={(e) => actualizarCheque(cheque.id, 'fecha_pago', e.target.value)}
                              className="h-9 text-sm mt-1"
                            />
                          </div>
                        </div>

                        <div>
                          <label className="text-xs font-medium">Monto *</label>
                          <Input
                            type="number"
                            step="0.01"
                            value={cheque.monto}
                            onChange={(e) => actualizarCheque(cheque.id, 'monto', parseFloat(e.target.value) || 0)}
                            className="h-9 text-sm mt-1"
                          />
                        </div>

                        {esTerceros ? (
                          <div>
                            <label className="text-xs font-medium">Emisor</label>
                            <Input
                              value={cheque.emisor}
                              onChange={(e) => actualizarCheque(cheque.id, 'emisor', e.target.value)}
                              className="h-9 text-sm mt-1"
                              placeholder="Nombre del emisor"
                            />
                          </div>
                        ) : (
                          <div>
                            <label className="text-xs font-medium">Beneficiario *</label>
                            <Input
                              value={cheque.beneficiario}
                              onChange={(e) => actualizarCheque(cheque.id, 'beneficiario', e.target.value)}
                              className="h-9 text-sm mt-1"
                              placeholder="A favor de..."
                            />
                          </div>
                        )}

                        <div>
                          <label className="text-xs font-medium">CUIT del Emisor</label>
                          <Input
                            value={cheque.titular}
                            onChange={(e) => actualizarCheque(cheque.id, 'titular', e.target.value)}
                            className="h-9 text-sm mt-1"
                            placeholder="CUIT del emisor"
                          />
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}

          <Card className="border-2 border-green-300 bg-green-50">
            <CardContent className="p-3">
              <div className="flex justify-between items-center">
                <span className="font-bold text-slate-700">TOTAL CHEQUES:</span>
                <span className="font-bold text-xl text-green-700">${totalCheques.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/tesoreria/OrdenDePagoPDF.jsx">
import jsPDF from 'jspdf';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export const generarOrdenDePagoPDF = (pago, proveedor) => {
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.width;
  let y = 20;

  // T√≠tulo
  doc.setFontSize(20);
  doc.setFont('helvetica', 'bold');
  doc.text('ORDEN DE PAGO', pageWidth / 2, y, { align: 'center' });
  y += 15;

  // Informaci√≥n de la empresa (ajustar seg√∫n corresponda)
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('Sistema de Acopio', pageWidth / 2, y, { align: 'center' });
  y += 5;
  doc.text('Gesti√≥n de Frutas', pageWidth / 2, y, { align: 'center' });
  y += 15;

  // N√∫mero y fecha
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.text(`Orden N¬∞: ${pago.id.substring(0, 8).toUpperCase()}`, 20, y);
  doc.text(`Fecha: ${format(new Date(pago.fecha), 'dd/MM/yyyy', { locale: es })}`, pageWidth - 70, y);
  y += 15;

  // Datos del proveedor
  doc.setFillColor(240, 240, 240);
  doc.rect(15, y - 5, pageWidth - 30, 35, 'F');
  
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('DATOS DEL PROVEEDOR', 20, y);
  y += 8;
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`Nombre: ${proveedor.nombre || pago.proveedor_nombre}`, 20, y);
  y += 6;
  if (proveedor.cuit) {
    doc.text(`CUIT: ${proveedor.cuit}`, 20, y);
    y += 6;
  }
  if (proveedor.direccion) {
    doc.text(`Direcci√≥n: ${proveedor.direccion}`, 20, y);
    y += 6;
  }
  if (proveedor.whatsapp) {
    doc.text(`WhatsApp: ${proveedor.whatsapp}`, 20, y);
    y += 6;
  }
  y += 10;

  // Detalles del pago
  doc.setFillColor(240, 240, 240);
  doc.rect(15, y - 5, pageWidth - 30, 10, 'F');
  
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('DETALLES DEL PAGO', 20, y);
  y += 12;

  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`Concepto: ${pago.concepto}`, 20, y);
  y += 7;
  
  if (pago.comprobante) {
    doc.text(`Comprobante: ${pago.comprobante}`, 20, y);
    y += 7;
  }

  doc.setFont('helvetica', 'bold');
  doc.text(`Tipo de Pago: ${pago.tipo_pago}`, 20, y);
  y += 10;

  // Medios de pago
  if (pago.medios_pago_detalles && pago.medios_pago_detalles.length > 0) {
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Medios de Pago:', 20, y);
    y += 7;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    pago.medios_pago_detalles.forEach(medio => {
      doc.text(
        `‚Ä¢ ${medio.tipo} - ${medio.origen_nombre}: $${(medio.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}`,
        25,
        y
      );
      y += 6;
    });
    y += 5;
  }

  // Comprobantes aplicados
  if (pago.ingresos_aplicados && pago.ingresos_aplicados.length > 0) {
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Comprobantes de Compra Aplicados:', 20, y);
    y += 7;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    pago.ingresos_aplicados.forEach((aplicado, idx) => {
      // Soportar tanto monto_aplicado (creaci√≥n) como monto (imputaci√≥n)
      const montoReal = aplicado.monto_aplicado || aplicado.monto || 0;
      doc.text(
        `${idx + 1}. Ingreso de Fruta - $${montoReal.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`,
        25,
        y
      );
      y += 6;
    });
    y += 5;
  }

  // Notas
  if (pago.notas) {
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Observaciones:', 20, y);
    y += 7;
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    const notasLines = doc.splitTextToSize(pago.notas, pageWidth - 50);
    doc.text(notasLines, 20, y);
    y += notasLines.length * 6 + 10;
  }

  // Total
  y = Math.max(y, 230);
  doc.setFillColor(50, 50, 50);
  doc.rect(15, y - 5, pageWidth - 30, 15, 'F');
  
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(255, 255, 255);
  doc.text('TOTAL A PAGAR:', 20, y + 5);
  doc.text(
    `$ ${(pago.monto_total || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}`,
    pageWidth - 20,
    y + 5,
    { align: 'right' }
  );
  doc.setTextColor(0, 0, 0);
  y += 25;

  // Firmas
  y = doc.internal.pageSize.height - 40;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  
  const firmaY = y + 15;
  doc.line(30, firmaY, 80, firmaY);
  doc.text('Autorizado por', 55, firmaY + 5, { align: 'center' });
  
  doc.line(pageWidth - 80, firmaY, pageWidth - 30, firmaY);
  doc.text('Recib√≠ conforme', pageWidth - 55, firmaY + 5, { align: 'center' });

  // Pie de p√°gina
  doc.setFontSize(8);
  doc.setTextColor(150, 150, 150);
  doc.text(
    `Documento generado el ${format(new Date(), 'dd/MM/yyyy HH:mm', { locale: es })}`,
    pageWidth / 2,
    doc.internal.pageSize.height - 10,
    { align: 'center' }
  );

  // Descargar
  doc.save(`orden-pago-${pago.id.substring(0, 8)}-${proveedor.nombre.replace(/\s+/g, '-')}.pdf`);
};
</file>

<file path="src/components/tesoreria/PagoConIngresosModal.jsx">
import React, { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import { Loader2, CheckCircle, Info } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import SearchableSelect from '@/components/SearchableSelect';
import AsyncSelect from '@/components/AsyncSelect';
import MediosPagoMixtosGrid from '@/components/tesoreria/MediosPagoMixtosGrid';
import MultiplesChequesGrid from '@/components/tesoreria/MultiplesChequesGrid';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { usePreciosCache } from '@/components/hooks/usePreciosCache';

export default function PagoConIngresosModal({ open, onClose, onSave, isLoading, proveedores, bancos, cajas, movimientos, cheques }) {
  const { data: bancosSistema = [] } = useQuery({
    queryKey: ['bancossistema'],
    queryFn: () => base44.entities.BancoSistema.list('nombre')
  });

  const { data: cuentasContables = [] } = useQuery({
    queryKey: ['plandecuentas'],
    queryFn: () => base44.entities.PlanDeCuentas.filter({ activa: true, imputable: true }, 'codigo'),
    staleTime: 10 * 60 * 1000
  });

  const { data: movimientosCC = [] } = useQuery({
    queryKey: ['cuentacorriente'],
    queryFn: () => base44.entities.CuentaCorriente.list('-fecha', 500),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const [tipoPago, setTipoPago] = useState('Aplicado'); // 'Aplicado' o 'A Cuenta'
  const [formData, setFormData] = useState({
    fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
    proveedor_id: '',
    forma_pago: 'Efectivo',
    origen_tipo: 'Caja',
    origen_id: '',
    cheque_id: '',
    monto: 0,
    concepto: '',
    comprobante: '',
    notas: '',
    cuenta_contable_id: '',
    cuenta_contable_nombre: ''
  });
  
  const [mediosMixtos, setMediosMixtos] = useState([]);
  const [chequesSeleccionados, setChequesSeleccionados] = useState([]);

  const [ingresosSeleccionados, setIngresosSeleccionados] = useState([]);

  React.useEffect(() => {
    if (open) {
      setTipoPago('Aplicado');
      setFormData({
        fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
        proveedor_id: '',
        forma_pago: 'Efectivo',
        origen_tipo: 'Caja',
        origen_id: '',
        cheque_id: '',
        monto: 0,
        concepto: '',
        comprobante: '',
        notas: '',
        cuenta_contable_id: '',
        cuenta_contable_codigo: '',
        cuenta_contable_nombre: ''
      });
      setIngresosSeleccionados([]);
      setMediosMixtos([]);
      setChequesSeleccionados([]);
    }
  }, [open]);

  const ingresosDelProveedor = formData.proveedor_id 
    ? movimientos.filter(m => 
        m.tipo_movimiento === 'Ingreso de Fruta' &&
        m.proveedor_id === formData.proveedor_id && 
        m.estado_pago !== 'Pagado'
      )
    : [];

  const toggleIngreso = (ingreso) => {
    const existe = ingresosSeleccionados.find(i => i.movimiento_id === ingreso.id);
    if (existe) {
      setIngresosSeleccionados(ingresosSeleccionados.filter(i => i.movimiento_id !== ingreso.id));
    } else {
      const pendiente = (ingreso.deuda_total || 0) - (ingreso.monto_pagado || 0);
      setIngresosSeleccionados([...ingresosSeleccionados, {
        movimiento_id: ingreso.id,
        monto_aplicado: pendiente,
        deuda_total: ingreso.deuda_total || 0,
        monto_pagado: ingreso.monto_pagado || 0,
        fecha_ingreso: ingreso.fecha
      }]);
    }
  };

  const actualizarMontoIngreso = (ingresoId, nuevoMonto) => {
    setIngresosSeleccionados(ingresosSeleccionados.map(i => 
      i.movimiento_id === ingresoId ? { ...i, monto_aplicado: nuevoMonto } : i
    ));
  };

  const totalAPagar = ingresosSeleccionados.reduce((sum, i) => sum + i.monto_aplicado, 0);
  
  const totalCheques = chequesSeleccionados.reduce((sum, ch) => {
    if (ch.tipo === 'existente' && ch.cheque_id) {
      const chequeData = chequesDisponibles.find(c => c.id === ch.cheque_id);
      return sum + (chequeData?.monto || 0);
    } else if (ch.tipo === 'nuevo') {
      return sum + (ch.monto || 0);
    }
    return sum;
  }, 0);

  const handleGuardar = () => {
    if (isLoading) return; // Prevenir clics m√∫ltiples
    
    if (!formData.cuenta_contable_id) {
      alert('Por favor seleccione una cuenta contable');
      return;
    }
    
    if (tipoPago === 'A Cuenta') {
      // Pago a cuenta: sin seleccionar ingresos
      // Calcular monto seg√∫n forma de pago
      let montoTotal = formData.monto;
      if (formData.forma_pago === 'Cheque') {
        montoTotal = totalCheques;
      } else if (formData.forma_pago === 'Mixta') {
        montoTotal = mediosMixtos.reduce((s, m) => s + (m.importe || 0), 0);
      }
      
      const pagoData = {
        ...formData,
        monto_total: montoTotal,
        tipo_pago: 'A Cuenta',
        monto_disponible: montoTotal,
        ingresos_aplicados: [],
        _mediosMixtos: formData.forma_pago === 'Mixta' ? mediosMixtos : null,
        _chequesSeleccionados: formData.forma_pago === 'Cheque' ? chequesSeleccionados : null
      };
      onSave(pagoData);
    } else {
      // Pago aplicado: con ingresos seleccionados
      if (ingresosSeleccionados.length === 0) {
        return;
      }

      const pagoData = {
        ...formData,
        tipo_pago: 'Aplicado',
        monto_total: totalAPagar,
        concepto: formData.concepto || `Pago de ${ingresosSeleccionados.length} ingreso(s)`,
        ingresos_aplicados: ingresosSeleccionados.map(i => ({
          movimiento_id: i.movimiento_id,
          monto_aplicado: i.monto_aplicado
        })),
        _mediosMixtos: formData.forma_pago === 'Mixta' ? mediosMixtos : null,
        _chequesSeleccionados: formData.forma_pago === 'Cheque' ? chequesSeleccionados : null
      };

      onSave(pagoData);
    }
  };

  const origenesDisponibles = formData.origen_tipo === 'Banco' ? bancos : cajas;
  const chequesDisponibles = cheques?.filter(ch => ch.estado === 'Pendiente' && ch.origen === 'Propio') || [];

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Nuevo Pago</DialogTitle>
        </DialogHeader>
        <div className="space-y-5 py-4">
          {/* Tipo de Pago */}
          <Card className="border-2 border-purple-200 bg-purple-50">
            <CardContent className="p-4">
              <h3 className="font-semibold text-purple-900 mb-3 flex items-center gap-2">
                <Info className="h-5 w-5" />
                Tipo de Pago
              </h3>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => {
                    setTipoPago('Aplicado');
                    setIngresosSeleccionados([]);
                  }}
                  className={`p-4 rounded-lg border-2 transition-all ${
                    tipoPago === 'Aplicado'
                      ? 'bg-red-100 border-red-500 shadow-md'
                      : 'bg-white border-slate-200 hover:border-slate-300'
                  }`}
                >
                  <p className="font-semibold text-slate-800 mb-1">Aplicar a Ingresos</p>
                  <p className="text-xs text-slate-600">Asignar el pago a ingresos de fruta espec√≠ficos</p>
                </button>
                <button
                  onClick={() => {
                    setTipoPago('A Cuenta');
                    setIngresosSeleccionados([]);
                  }}
                  className={`p-4 rounded-lg border-2 transition-all ${
                    tipoPago === 'A Cuenta'
                      ? 'bg-amber-100 border-amber-500 shadow-md'
                      : 'bg-white border-slate-200 hover:border-slate-300'
                  }`}
                >
                  <p className="font-semibold text-slate-800 mb-1">Pago a Cuenta</p>
                  <p className="text-xs text-slate-600">Dinero adelantado sin asignar a movimientos (precios no confirmados)</p>
                </button>
              </div>
              {tipoPago === 'A Cuenta' && (
                <div className="mt-3 p-3 bg-amber-50 border border-amber-300 rounded-lg">
                  <p className="text-xs text-amber-900">
                    üí° <strong>Pago a Cuenta:</strong> √ösalo cuando adelantes dinero pero los precios finales a√∫n no est√©n confirmados. 
                    Podr√°s aplicar este dinero a ingresos espec√≠ficos m√°s adelante.
                  </p>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Cuenta Contable */}
          <div>
            <label className="text-sm font-medium">Cuenta Contable *</label>
            <SearchableSelect
              options={cuentasContables.filter(c => c.activa !== false && c.imputable !== false)}
              value={formData.cuenta_contable_id}
              onChange={(id, cuenta) => {
                setFormData({
                  ...formData,
                  cuenta_contable_id: id,
                  cuenta_contable_codigo: cuenta?.codigo || '',
                  cuenta_contable_nombre: cuenta?.nombre || ''
                });
              }}
              displayKey="nombre"
              placeholder="Seleccionar cuenta contable..."
            />
            {formData.cuenta_contable_codigo && (
              <p className="text-xs text-slate-500 mt-1">C√≥digo: {formData.cuenta_contable_codigo}</p>
            )}
            <p className="text-xs text-slate-500 mt-1">Este pago se registrar√° en el Estado de Resultados</p>
          </div>

          {/* Selecci√≥n de Proveedor */}
          <div>
            <label className="text-sm font-medium">Proveedor *</label>
            <AsyncSelect
              entityKey="Proveedor"
              value={formData.proveedor_id}
              onChange={(id) => {
                setFormData({...formData, proveedor_id: id});
                setIngresosSeleccionados([]);
              }}
              placeholder="Buscar proveedor..."
            />
          </div>

          {/* Ingresos Pendientes - SOLO si es tipo "Aplicado" */}
          {tipoPago === 'Aplicado' && formData.proveedor_id && (
            <div className="space-y-3">
              <h3 className="font-semibold text-slate-800">Ingresos Pendientes de Pago</h3>
              {ingresosDelProveedor.length === 0 ? (
                <Card className="bg-slate-50">
                  <CardContent className="p-6 text-center">
                    <CheckCircle className="h-12 w-12 text-slate-300 mx-auto mb-2" />
                    <p className="text-slate-500">No hay ingresos pendientes de pago para este proveedor</p>
                  </CardContent>
                </Card>
              ) : (
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {ingresosDelProveedor.map(ingreso => {
                    const seleccionado = ingresosSeleccionados.find(i => i.movimiento_id === ingreso.id);
                    // Obtener el saldo del proveedor desde Cuenta Corriente (m√°s reciente)
                    const movimientosCCProveedor = movimientosCC.filter(m => m.entidad_id === formData.proveedor_id && m.entidad_tipo === 'Proveedor').sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    const pendiente = movimientosCCProveedor.length > 0 ? movimientosCCProveedor[0].saldo_resultante || 0 : 0;
                    
                    return (
                      <Card key={ingreso.id} className={`border cursor-pointer transition-all ${
                        seleccionado ? 'bg-red-50 border-red-300 shadow-sm' : 'hover:border-slate-300'
                      }`}>
                        <CardContent className="p-3">
                          <div className="flex items-start gap-3">
                            <input
                              type="checkbox"
                              checked={!!seleccionado}
                              onChange={() => toggleIngreso(ingreso)}
                              className="h-4 w-4 mt-1 rounded border-slate-300"
                            />
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <p className="font-semibold text-slate-800">Ingreso {format(new Date(ingreso.fecha), 'dd/MM/yyyy HH:mm', { locale: es })}</p>
                                {ingreso.estado_pago === 'Pago Parcial' && (
                                  <Badge className="bg-amber-100 text-amber-800 text-xs">
                                    Pago Parcial
                                  </Badge>
                                )}
                              </div>
                              <div className="grid grid-cols-3 gap-2 text-xs text-slate-600">
                                <div>
                                 <span className="text-slate-500">Total:</span>
                                 <p className="font-semibold">${(ingreso.deuda_total || 0).toLocaleString('es-AR')}</p>
                                </div>
                                <div>
                                 <span className="text-slate-500">Pagado:</span>
                                 <p className="font-semibold text-green-600">${(ingreso.monto_pagado || 0).toLocaleString('es-AR')}</p>
                                </div>
                                <div>
                                 <span className="text-slate-500">Pendiente:</span>
                                 <p className="font-bold text-red-600">${(pendiente || 0).toLocaleString('es-AR')}</p>
                                </div>
                              </div>
                            </div>
                            {seleccionado && (
                              <div className="w-32">
                                <label className="text-xs text-slate-500">Pagar ahora:</label>
                                <Input
                                  type="number"
                                  step="0.01"
                                  value={seleccionado.monto_aplicado}
                                  onChange={(e) => actualizarMontoIngreso(ingreso.id, parseFloat(e.target.value) || 0)}
                                  className="h-8 text-sm mt-1"
                                />
                              </div>
                            )}
                          </div>
                        </CardContent>
                      </Card>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* Resumen de Pago - SOLO si es tipo "Aplicado" */}
          {tipoPago === 'Aplicado' && ingresosSeleccionados.length > 0 && (
            <Card className="bg-gradient-to-br from-red-50 to-red-100 border-red-200">
              <CardContent className="p-4">
                <h4 className="font-semibold text-red-900 mb-3">Resumen del Pago</h4>
                <div className="space-y-2 text-sm">
                  {ingresosSeleccionados.map(i => (
                   <div key={i.movimiento_id} className="flex justify-between">
                     <span className="text-slate-700">Ingreso {format(new Date(i.fecha_ingreso), 'dd/MM', { locale: es })}:</span>
                     <span className="font-semibold">${(i.monto_aplicado || 0).toLocaleString('es-AR')}</span>
                   </div>
                  ))}
                  <div className="flex justify-between pt-2 mt-2 border-t-2 border-red-300">
                   <span className="font-bold">TOTAL A PAGAR:</span>
                   <span className="font-bold text-xl text-red-700">${(totalAPagar || 0).toLocaleString('es-AR')}</span>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Detalles del Pago */}
          {(tipoPago === 'A Cuenta' || ingresosSeleccionados.length > 0) && (
            <div className="space-y-4 p-4 bg-slate-50 rounded-lg">
              <h4 className="font-semibold text-slate-800">Detalles del Pago</h4>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium">Fecha *</label>
                  <Input type="datetime-local" value={formData.fecha} onChange={(e) => setFormData({...formData, fecha: e.target.value})} className="mt-1" />
                </div>
                <div>
                  <label className="text-sm font-medium">Forma de Pago *</label>
                  <select
                    value={formData.forma_pago}
                    onChange={(e) => {
                      const nuevaForma = e.target.value;
                      let nuevoOrigenTipo = formData.origen_tipo;
                      
                      // Determinar autom√°ticamente el tipo de cuenta seg√∫n la forma
                      if (nuevaForma === 'Efectivo') nuevoOrigenTipo = 'Caja';
                      else if (nuevaForma === 'Transferencia') nuevoOrigenTipo = 'Banco';
                      else if (nuevaForma === 'Cheque') nuevoOrigenTipo = 'Cheque';
                      
                      setFormData({
                        ...formData, 
                        forma_pago: nuevaForma,
                        origen_tipo: nuevoOrigenTipo,
                        origen_id: ''
                      });
                    }}
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm mt-1"
                  >
                    <option value="Efectivo">üíµ Efectivo ‚Üí Caja</option>
                    <option value="Transferencia">üè¶ Transferencia ‚Üí Banco</option>
                    <option value="Cheque">üìÑ Cheque</option>
                    <option value="Mixta">üí≥ Mixta (varios medios)</option>
                  </select>
                </div>
              </div>

              {/* Forma MIXTA: mostrar grilla de medios */}
              {formData.forma_pago === 'Mixta' ? (
                <MediosPagoMixtosGrid
                  montoTotal={tipoPago === 'A Cuenta' ? formData.monto : totalAPagar}
                  medios={mediosMixtos}
                  onChange={setMediosMixtos}
                  bancos={bancos}
                  cajas={cajas}
                  cheques={cheques}
                  esIngreso={false}
                  onCrearCheque={(callback) => {
                    const numero_cheque = prompt('N√∫mero de cheque:');
                    const banco_id = bancosSistema[0]?.id;
                    if (numero_cheque && banco_id) {
                      const banco = bancosSistema.find(b => b.id === banco_id);
                      base44.entities.Cheque.create({
                        numero_cheque,
                        tipo: 'F√≠sico',
                        origen: 'Propio',
                        banco_id,
                        banco_nombre: banco?.nombre || '',
                        fecha_emision: format(new Date(), 'yyyy-MM-dd'),
                        fecha_pago: format(new Date(), 'yyyy-MM-dd'),
                        monto: 0,
                        estado: 'Pendiente',
                        origen_modulo: 'Pago',
                        emisor: 'Empresa'
                      }).then((nuevoCheque) => {
                        callback(nuevoCheque.id);
                        toast.success('Cheque registrado');
                      });
                    }
                  }}
                />
              ) : (
                <>
                  {formData.forma_pago !== 'Cheque' && (
                    <div>
                      <label className="text-sm font-medium">
                        {formData.forma_pago === 'Efectivo' && 'Caja Origen *'}
                        {formData.forma_pago === 'Transferencia' && 'Banco Origen *'}
                        {formData.forma_pago === 'Tarjeta' && 'Cuenta Origen *'}
                      </label>
                      <SearchableSelect
                        options={origenesDisponibles}
                        value={formData.origen_id}
                        onChange={(id) => setFormData({...formData, origen_id: id})}
                        displayKey="nombre"
                        placeholder={`Seleccionar ${formData.origen_tipo === 'Banco' ? 'banco' : 'caja'}...`}
                      />
                    </div>
                  )}
                </>
              )}

              {/* Monto - Solo para A Cuenta */}
              {tipoPago === 'A Cuenta' && (
                <div>
                  <label className="text-sm font-medium">Monto *</label>
                  <Input 
                    type="number" 
                    step="0.01" 
                    value={formData.monto} 
                    onChange={(e) => setFormData({...formData, monto: parseFloat(e.target.value) || 0})} 
                    className="mt-1" 
                  />
                </div>
              )}

              <div>
                <label className="text-sm font-medium">Concepto {tipoPago === 'A Cuenta' ? '*' : ''}</label>
                <Input 
                  value={formData.concepto} 
                  onChange={(e) => setFormData({...formData, concepto: e.target.value})} 
                  className="mt-1" 
                  placeholder={tipoPago === 'A Cuenta' ? 'Ej: Adelanto por futuros ingresos' : 'Opcional, se genera autom√°tico'} 
                />
              </div>

              <div>
                <label className="text-sm font-medium">Comprobante</label>
                <Input value={formData.comprobante} onChange={(e) => setFormData({...formData, comprobante: e.target.value})} className="mt-1" />
              </div>

              {/* Datos de Cheques - Solo si forma_pago es Cheque */}
              {formData.forma_pago === 'Cheque' && (
                <Card className="border-2 border-amber-200 bg-amber-50">
                  <CardContent className="p-4">
                    <MultiplesChequesGrid
                      cheques={chequesSeleccionados}
                      onChange={setChequesSeleccionados}
                      chequesDisponibles={chequesDisponibles}
                      bancosSistema={bancosSistema}
                      esTerceros={false}
                    />
                  </CardContent>
                </Card>
              )}
            </div>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button 
            onClick={handleGuardar} 
            disabled={
              isLoading || 
              !formData.proveedor_id ||
              !formData.cuenta_contable_id ||
              (formData.forma_pago !== 'Mixta' && formData.forma_pago !== 'Cheque' && !formData.origen_id) ||
              (formData.forma_pago === 'Mixta' && (mediosMixtos.length === 0 || Math.abs((tipoPago === 'A Cuenta' ? formData.monto : totalAPagar) - mediosMixtos.reduce((s, m) => s + (m.importe || 0), 0)) >= 0.01)) ||
              (tipoPago === 'Aplicado' && ingresosSeleccionados.length === 0) ||
              (tipoPago === 'A Cuenta' && (formData.monto <= 0 || !formData.concepto)) ||
              (formData.forma_pago === 'Cheque' && (chequesSeleccionados.length === 0 || Math.abs((tipoPago === 'A Cuenta' ? formData.monto : totalAPagar) - totalCheques) >= 0.01)) ||
              (formData.forma_pago === 'Cheque' && chequesSeleccionados.some(ch => 
                (ch.tipo === 'existente' && !ch.cheque_id) ||
                (ch.tipo === 'nuevo' && (!ch.numero_cheque || !ch.banco_id || ch.monto <= 0 || !ch.beneficiario))
              ))
            }
            className={tipoPago === 'A Cuenta' ? 'bg-amber-600 hover:bg-amber-700' : 'bg-red-600 hover:bg-red-700'}
          >
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            {tipoPago === 'A Cuenta' 
              ? `Guardar Pago a Cuenta ($${(formData.forma_pago === 'Cheque' ? totalCheques : formData.forma_pago === 'Mixta' ? mediosMixtos.reduce((s, m) => s + (m.importe || 0), 0) : formData.monto || 0).toLocaleString('es-AR')})`
              : `Guardar Pago ($${(totalAPagar || 0).toLocaleString('es-AR')})`
            }
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/ui/accordion.jsx">
import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item ref={ref} className={cn("border-b", className)} {...props} />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}>
      {children}
      <ChevronDown
        className="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}>
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))
AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
</file>

<file path="src/components/ui/alert-dialog.jsx">
import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref} />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props} />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}) => (
  <div
    className={cn("flex flex-col space-y-2 text-center sm:text-left", className)}
    {...props} />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}) => (
  <div
    className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)}
    {...props} />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title ref={ref} className={cn("text-lg font-semibold", className)} {...props} />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props} />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action ref={ref} className={cn(buttonVariants(), className)} {...props} />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(buttonVariants({ variant: "outline" }), "mt-2 sm:mt-0", className)}
    {...props} />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="src/components/ui/alert.jsx">
import * as React from "react"
import { cva } from "class-variance-authority";

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props} />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props} />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props} />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/components/ui/aspect-ratio.jsx">
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"

const AspectRatio = AspectRatioPrimitive.Root

export { AspectRatio }
</file>

<file path="src/components/ui/avatar.jsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full", className)}
    {...props} />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props} />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props} />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="src/components/ui/badge.jsx">
import * as React from "react"
import { cva } from "class-variance-authority";

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  ...props
}) {
  return (<div className={cn(badgeVariants({ variant }), className)} {...props} />);
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/breadcrumb.jsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

const Breadcrumb = React.forwardRef(
  ({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />
)
Breadcrumb.displayName = "Breadcrumb"

const BreadcrumbList = React.forwardRef(({ className, ...props }, ref) => (
  <ol
    ref={ref}
    className={cn(
      "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
      className
    )}
    {...props} />
))
BreadcrumbList.displayName = "BreadcrumbList"

const BreadcrumbItem = React.forwardRef(({ className, ...props }, ref) => (
  <li
    ref={ref}
    className={cn("inline-flex items-center gap-1.5", className)}
    {...props} />
))
BreadcrumbItem.displayName = "BreadcrumbItem"

const BreadcrumbLink = React.forwardRef(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    (<Comp
      ref={ref}
      className={cn("transition-colors hover:text-foreground", className)}
      {...props} />)
  );
})
BreadcrumbLink.displayName = "BreadcrumbLink"

const BreadcrumbPage = React.forwardRef(({ className, ...props }, ref) => (
  <span
    ref={ref}
    role="link"
    aria-disabled="true"
    aria-current="page"
    className={cn("font-normal text-foreground", className)}
    {...props} />
))
BreadcrumbPage.displayName = "BreadcrumbPage"

const BreadcrumbSeparator = ({
  children,
  className,
  ...props
}) => (
  <li
    role="presentation"
    aria-hidden="true"
    className={cn("[&>svg]:w-3.5 [&>svg]:h-3.5", className)}
    {...props}>
    {children ?? <ChevronRight />}
  </li>
)
BreadcrumbSeparator.displayName = "BreadcrumbSeparator"

const BreadcrumbEllipsis = ({
  className,
  ...props
}) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}>
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
)
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}
</file>

<file path="src/components/ui/button.jsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva } from "class-variance-authority";

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Button = React.forwardRef(({ className, variant, size, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"
  return (
    (<Comp
      className={cn(buttonVariants({ variant, size, className }))}
      ref={ref}
      {...props} />)
  );
})
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/calendar.jsx">
import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}) {
  return (
    (<DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-8 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: cn(
          "relative p-0 text-center text-sm focus-within:relative focus-within:z-20 [&:has([aria-selected])]:bg-accent [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected].day-range-end)]:rounded-r-md",
          props.mode === "range"
            ? "[&:has(>.day-range-end)]:rounded-r-md [&:has(>.day-range-start)]:rounded-l-md first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md"
            : "[&:has([aria-selected])]:rounded-md"
        ),
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-8 w-8 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_start: "day-range-start",
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ className, ...props }) => (
          <ChevronLeft className={cn("h-4 w-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }) => (
          <ChevronRight className={cn("h-4 w-4", className)} {...props} />
        ),
      }}
      {...props} />)
  );
}
Calendar.displayName = "Calendar"

export { Calendar }
</file>

<file path="src/components/ui/card.jsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("rounded-xl border bg-card text-card-foreground shadow", className)}
    {...props} />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props} />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props} />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props} />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props} />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/components/ui/carousel.jsx">
import * as React from "react"
import useEmblaCarousel from "embla-carousel-react";
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

const CarouselContext = React.createContext(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef((
  {
    orientation = "horizontal",
    opts,
    setApi,
    plugins,
    className,
    children,
    ...props
  },
  ref
) => {
  const [carouselRef, api] = useEmblaCarousel({
    ...opts,
    axis: orientation === "horizontal" ? "x" : "y",
  }, plugins)
  const [canScrollPrev, setCanScrollPrev] = React.useState(false)
  const [canScrollNext, setCanScrollNext] = React.useState(false)

  const onSelect = React.useCallback((api) => {
    if (!api) {
      return
    }

    setCanScrollPrev(api.canScrollPrev())
    setCanScrollNext(api.canScrollNext())
  }, [])

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev()
  }, [api])

  const scrollNext = React.useCallback(() => {
    api?.scrollNext()
  }, [api])

  const handleKeyDown = React.useCallback((event) => {
    if (event.key === "ArrowLeft") {
      event.preventDefault()
      scrollPrev()
    } else if (event.key === "ArrowRight") {
      event.preventDefault()
      scrollNext()
    }
  }, [scrollPrev, scrollNext])

  React.useEffect(() => {
    if (!api || !setApi) {
      return
    }

    setApi(api)
  }, [api, setApi])

  React.useEffect(() => {
    if (!api) {
      return
    }

    onSelect(api)
    api.on("reInit", onSelect)
    api.on("select", onSelect)

    return () => {
      api?.off("select", onSelect)
    };
  }, [api, onSelect])

  return (
    (<CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}>
      <div
        ref={ref}
        onKeyDownCapture={handleKeyDown}
        className={cn("relative", className)}
        role="region"
        aria-roledescription="carousel"
        {...props}>
        {children}
      </div>
    </CarouselContext.Provider>)
  );
})
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    (<div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props} />
    </div>)
  );
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    (<div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props} />)
  );
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    (<Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn("absolute  h-8 w-8 rounded-full", orientation === "horizontal"
        ? "-left-12 top-1/2 -translate-y-1/2"
        : "-top-12 left-1/2 -translate-x-1/2 rotate-90", className)}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}>
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>)
  );
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    (<Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn("absolute h-8 w-8 rounded-full", orientation === "horizontal"
        ? "-right-12 top-1/2 -translate-y-1/2"
        : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90", className)}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}>
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>)
  );
})
CarouselNext.displayName = "CarouselNext"

export { Carousel, CarouselContent, CarouselItem, CarouselPrevious, CarouselNext };
</file>

<file path="src/components/ui/chart.jsx">
"use client";
import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = {
  light: "",
  dark: ".dark"
}

const ChartContext = React.createContext(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    (<ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}>
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>)
  );
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({
  id,
  config
}) => {
  const colorConfig = Object.entries(config).filter(([, config]) => config.theme || config.color)

  if (!colorConfig.length) {
    return null
  }

  return (
    (<style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
.map(([key, itemConfig]) => {
const color =
  itemConfig.theme?.[theme] ||
  itemConfig.color
return color ? `  --color-${key}: ${color};` : null
})
.join("\n")}
}
`)
          .join("\n"),
      }} />)
  );
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef((
  {
    active,
    payload,
    className,
    indicator = "dot",
    hideLabel = false,
    hideIndicator = false,
    label,
    labelFormatter,
    labelClassName,
    formatter,
    color,
    nameKey,
    labelKey,
  },
  ref
) => {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item.dataKey || item.name || "value"}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === "string"
        ? config[label]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        (<div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>)
      );
    }

    if (!value) {
      return null
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>;
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== "dot"

  return (
    (<div
      ref={ref}
      className={cn(
        "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
        className
      )}>
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload.map((item, index) => {
          const key = `${nameKey || item.name || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)
          const indicatorColor = color || item.payload.fill || item.color

          return (
            (<div
              key={item.dataKey}
              className={cn(
                "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                indicator === "dot" && "items-center"
              )}>
              {formatter && item?.value !== undefined && item.name ? (
                formatter(item.value, item.name, item, index, item.payload)
              ) : (
                <>
                  {itemConfig?.icon ? (
                    <itemConfig.icon />
                  ) : (
                    !hideIndicator && (
                      <div
                        className={cn("shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]", {
                          "h-2.5 w-2.5": indicator === "dot",
                          "w-1": indicator === "line",
                          "w-0 border-[1.5px] border-dashed bg-transparent":
                            indicator === "dashed",
                          "my-0.5": nestLabel && indicator === "dashed",
                        })}
                        style={
                          {
                            "--color-bg": indicatorColor,
                            "--color-border": indicatorColor
                          }
                        } />
                    )
                  )}
                  <div
                    className={cn(
                      "flex flex-1 justify-between leading-none",
                      nestLabel ? "items-end" : "items-center"
                    )}>
                    <div className="grid gap-1.5">
                      {nestLabel ? tooltipLabel : null}
                      <span className="text-muted-foreground">
                        {itemConfig?.label || item.name}
                      </span>
                    </div>
                    {item.value && (
                      <span className="font-mono font-medium tabular-nums text-foreground">
                        {item.value.toLocaleString()}
                      </span>
                    )}
                  </div>
                </>
              )}
            </div>)
          );
        })}
      </div>
    </div>)
  );
})
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef((
  { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
  ref
) => {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    (<div
      ref={ref}
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className
      )}>
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || "value"}`
        const itemConfig = getPayloadConfigFromPayload(config, item, key)

        return (
          (<div
            key={item.value}
            className={cn(
              "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
            )}>
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }} />
            )}
            {itemConfig?.label}
          </div>)
        );
      })}
    </div>)
  );
})
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config,
  payload,
  key
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey = key

  if (
    key in payload &&
    typeof payload[key] === "string"
  ) {
    configLabelKey = payload[key]
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key] === "string"
  ) {
    configLabelKey = payloadPayload[key]
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key];
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="src/components/ui/checkbox.jsx">
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}>
    <CheckboxPrimitive.Indicator className={cn("flex items-center justify-center text-current")}>
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
</file>

<file path="src/components/ui/collapsible.jsx">
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
</file>

<file path="src/components/ui/command.jsx">
import * as React from "react"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props} />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({
  children,
  ...props
}) => {
  return (
    (<Dialog {...props}>
      <DialogContent className="overflow-hidden p-0">
        <Command
          className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>)
  );
}

const CommandInput = React.forwardRef(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props} />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props} />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef((props, ref) => (
  <CommandPrimitive.Empty ref={ref} className="py-6 text-center text-sm" {...props} />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props} />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator ref={ref} className={cn("-mx-1 h-px bg-border", className)} {...props} />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      className
    )}
    {...props} />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}) => {
  return (
    (<span
      className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)}
      {...props} />)
  );
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
</file>

<file path="src/components/ui/context-menu.jsx">
import * as React from "react"
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const ContextMenu = ContextMenuPrimitive.Root

const ContextMenuTrigger = ContextMenuPrimitive.Trigger

const ContextMenuGroup = ContextMenuPrimitive.Group

const ContextMenuPortal = ContextMenuPrimitive.Portal

const ContextMenuSub = ContextMenuPrimitive.Sub

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup

const ContextMenuSubTrigger = React.forwardRef(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}>
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
))
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName

const ContextMenuSubContent = React.forwardRef(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props} />
))
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName

const ContextMenuContent = React.forwardRef(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} />
  </ContextMenuPrimitive.Portal>
))
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName

const ContextMenuItem = React.forwardRef(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props} />
))
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName

const ContextMenuCheckboxItem = React.forwardRef(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}>
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
))
ContextMenuCheckboxItem.displayName =
  ContextMenuPrimitive.CheckboxItem.displayName

const ContextMenuRadioItem = React.forwardRef(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}>
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-4 w-4 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
))
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName

const ContextMenuLabel = React.forwardRef(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold text-foreground",
      inset && "pl-8",
      className
    )}
    {...props} />
))
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName

const ContextMenuSeparator = React.forwardRef(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-border", className)}
    {...props} />
))
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName

const ContextMenuShortcut = ({
  className,
  ...props
}) => {
  return (
    (<span
      className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)}
      {...props} />)
  );
}
ContextMenuShortcut.displayName = "ContextMenuShortcut"

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}
</file>

<file path="src/components/ui/dialog.jsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props} />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}>
      {children}
      <DialogPrimitive.Close
        className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}) => (
  <div
    className={cn("flex flex-col space-y-1.5 text-center sm:text-left", className)}
    {...props} />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}) => (
  <div
    className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)}
    {...props} />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold leading-none tracking-tight", className)}
    {...props} />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props} />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="src/components/ui/drawer.jsx">
"use client"

import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils"

const Drawer = ({
  shouldScaleBackground = true,
  ...props
}) => (
  <DrawerPrimitive.Root shouldScaleBackground={shouldScaleBackground} {...props} />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay
    ref={ref}
    className={cn("fixed inset-0 z-50 bg-black/80", className)}
    {...props} />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className
      )}
      {...props}>
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
  className,
  ...props
}) => (
  <div
    className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
    {...props} />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
  className,
  ...props
}) => (
  <div className={cn("mt-auto flex flex-col gap-2 p-4", className)} {...props} />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold leading-none tracking-tight", className)}
    {...props} />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props} />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}
</file>

<file path="src/components/ui/dropdown-menu.jsx">
import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}>
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props} />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props} />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}>
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}>
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", inset && "pl-8", className)}
    {...props} />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props} />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}) => {
  return (
    (<span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props} />)
  );
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}
</file>

<file path="src/components/ui/form.jsx">
"use client";
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { Controller, FormProvider, useFormContext } from "react-hook-form";

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

const FormFieldContext = React.createContext({})

const FormField = (
  {
    ...props
  }
) => {
  return (
    (<FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>)
  );
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

const FormItemContext = React.createContext({})

const FormItem = React.forwardRef(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    (<FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>)
  );
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    (<Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props} />)
  );
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    (<Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props} />)
  );
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    (<p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-[0.8rem] text-muted-foreground", className)}
      {...props} />)
  );
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message) : children

  if (!body) {
    return null
  }

  return (
    (<p
      ref={ref}
      id={formMessageId}
      className={cn("text-[0.8rem] font-medium text-destructive", className)}
      {...props}>
      {body}
    </p>)
  );
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="src/components/ui/hover-card.jsx">
"use client"

import * as React from "react"
import * as HoverCardPrimitive from "@radix-ui/react-hover-card"

import { cn } from "@/lib/utils"

const HoverCard = HoverCardPrimitive.Root

const HoverCardTrigger = HoverCardPrimitive.Trigger

const HoverCardContent = React.forwardRef(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props} />
))
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName

export { HoverCard, HoverCardTrigger, HoverCardContent }
</file>

<file path="src/components/ui/input-otp.jsx">
import * as React from "react"
import { OTPInput, OTPInputContext } from "input-otp"
import { Minus } from "lucide-react"

import { cn } from "@/lib/utils"

const InputOTP = React.forwardRef(({ className, containerClassName, ...props }, ref) => (
  <OTPInput
    ref={ref}
    containerClassName={cn("flex items-center gap-2 has-[:disabled]:opacity-50", containerClassName)}
    className={cn("disabled:cursor-not-allowed", className)}
    {...props} />
))
InputOTP.displayName = "InputOTP"

const InputOTPGroup = React.forwardRef(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center", className)} {...props} />
))
InputOTPGroup.displayName = "InputOTPGroup"

const InputOTPSlot = React.forwardRef(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]

  return (
    (<div
      ref={ref}
      className={cn(
        "relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-1 ring-ring",
        className
      )}
      {...props}>
      {char}
      {hasFakeCaret && (
        <div
          className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
        </div>
      )}
    </div>)
  );
})
InputOTPSlot.displayName = "InputOTPSlot"

const InputOTPSeparator = React.forwardRef(({ ...props }, ref) => (
  <div ref={ref} role="separator" {...props}>
    <Minus />
  </div>
))
InputOTPSeparator.displayName = "InputOTPSeparator"

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }
</file>

<file path="src/components/ui/input.jsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef(({ className, type, ...props }, ref) => {
  return (
    (<input
      type={type}
      className={cn(
        "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props} />)
  );
})
Input.displayName = "Input"

export { Input }
</file>

<file path="src/components/ui/label.jsx">
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva } from "class-variance-authority";

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef(({ className, ...props }, ref) => (
  <LabelPrimitive.Root ref={ref} className={cn(labelVariants(), className)} {...props} />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="src/components/ui/menubar.jsx">
"use client"

import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

function MenubarMenu({
  ...props
}) {
  return <MenubarPrimitive.Menu {...props} />;
}

function MenubarGroup({
  ...props
}) {
  return <MenubarPrimitive.Group {...props} />;
}

function MenubarPortal({
  ...props
}) {
  return <MenubarPrimitive.Portal {...props} />;
}

function MenubarRadioGroup({
  ...props
}) {
  return <MenubarPrimitive.RadioGroup {...props} />;
}

function MenubarSub({
  ...props
}) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />;
}

const Menubar = React.forwardRef(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm",
      className
    )}
    {...props} />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props} />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}>
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props} />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef((
  { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
  ref
) => (
  <MenubarPrimitive.Portal>
    <MenubarPrimitive.Content
      ref={ref}
      align={align}
      alignOffset={alignOffset}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} />
  </MenubarPrimitive.Portal>
))
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props} />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}>
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}>
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-4 w-4 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", inset && "pl-8", className)}
    {...props} />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props} />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}) => {
  return (
    (<span
      className={cn("ml-auto text-xs tracking-widest text-muted-foreground", className)}
      {...props} />)
  );
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}
</file>

<file path="src/components/ui/navigation-menu.jsx">
import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}>
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props} />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50"
)

const NavigationMenuTrigger = React.forwardRef(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}>
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180"
      aria-hidden="true" />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props} />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className
      )}
      ref={ref}
      {...props} />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}>
    <div
      className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}
</file>

<file path="src/components/ui/pagination.jsx">
import * as React from "react"
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button";

const Pagination = ({
  className,
  ...props
}) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props} />
)
Pagination.displayName = "Pagination"

const PaginationContent = React.forwardRef(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    className={cn("flex flex-row items-center gap-1", className)}
    {...props} />
))
PaginationContent.displayName = "PaginationContent"

const PaginationItem = React.forwardRef(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
))
PaginationItem.displayName = "PaginationItem"

const PaginationLink = ({
  className,
  isActive,
  size = "icon",
  ...props
}) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(buttonVariants({
      variant: isActive ? "outline" : "ghost",
      size,
    }), className)}
    {...props} />
)
PaginationLink.displayName = "PaginationLink"

const PaginationPrevious = ({
  className,
  ...props
}) => (
  <PaginationLink
    aria-label="Go to previous page"
    size="default"
    className={cn("gap-1 pl-2.5", className)}
    {...props}>
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
)
PaginationPrevious.displayName = "PaginationPrevious"

const PaginationNext = ({
  className,
  ...props
}) => (
  <PaginationLink
    aria-label="Go to next page"
    size="default"
    className={cn("gap-1 pr-2.5", className)}
    {...props}>
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
)
PaginationNext.displayName = "PaginationNext"

const PaginationEllipsis = ({
  className,
  ...props
}) => (
  <span
    aria-hidden
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}>
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
)
PaginationEllipsis.displayName = "PaginationEllipsis"

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
}
</file>

<file path="src/components/ui/popover.jsx">
import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverAnchor = PopoverPrimitive.Anchor

const PopoverContent = React.forwardRef(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }
</file>

<file path="src/components/ui/progress.jsx">
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-2 w-full overflow-hidden rounded-full bg-primary/20",
      className
    )}
    {...props}>
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }} />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="src/components/ui/radio-group.jsx">
import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef(({ className, ...props }, ref) => {
  return (<RadioGroupPrimitive.Root className={cn("grid gap-2", className)} {...props} ref={ref} />);
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}>
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-3.5 w-3.5 fill-primary" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>)
  );
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }
</file>

<file path="src/components/ui/resizable.jsx">
"use client"

import { GripVertical } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props} />
)

const ResizablePanel = ResizablePrimitive.Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}>
    {withHandle && (
      <div
        className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
</file>

<file path="src/components/ui/scroll-area.jsx">
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}>
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}>
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
</file>

<file path="src/components/ui/select.jsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}>
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}>
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn("flex cursor-default items-center justify-center py-1", className)}
    {...props}>
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}>
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn("p-1", position === "popper" &&
          "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]")}>
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props} />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}>
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props} />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="src/components/ui/separator.jsx">
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef((
  { className, orientation = "horizontal", decorative = true, ...props },
  ref
) => (
  <SeparatorPrimitive.Root
    ref={ref}
    decorative={decorative}
    orientation={orientation}
    className={cn(
      "shrink-0 bg-border",
      orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
      className
    )}
    {...props} />
))
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }
</file>

<file path="src/components/ui/sheet.jsx">
"use client";
import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva } from "class-variance-authority";
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref} />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

const SheetContent = React.forwardRef(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content ref={ref} className={cn(sheetVariants({ side }), className)} {...props}>
      <SheetPrimitive.Close
        className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
      {children}
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}) => (
  <div
    className={cn("flex flex-col space-y-2 text-center sm:text-left", className)}
    {...props} />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}) => (
  <div
    className={cn("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2", className)}
    {...props} />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props} />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props} />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="src/components/ui/sidebar.jsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva } from "class-variance-authority";
import { PanelLeft } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import { Sheet, SheetContent } from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

const SidebarContext = React.createContext(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

const SidebarProvider = React.forwardRef((
  {
    defaultOpen = true,
    open: openProp,
    onOpenChange: setOpenProp,
    className,
    style,
    children,
    ...props
  },
  ref
) => {
  const isMobile = useIsMobile()
  const [openMobile, setOpenMobile] = React.useState(false)

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen)
  const open = openProp ?? _open
  const setOpen = React.useCallback((value) => {
    const openState = typeof value === "function" ? value(open) : value
    if (setOpenProp) {
      setOpenProp(openState)
    } else {
      _setOpen(openState)
    }

    // This sets the cookie to keep the sidebar state.
    document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
  }, [setOpenProp, open])

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile
      ? setOpenMobile((open) => !open)
      : setOpen((open) => !open);
  }, [isMobile, setOpen, setOpenMobile])

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault()
        toggleSidebar()
      }
    }

    window.addEventListener("keydown", handleKeyDown)
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [toggleSidebar])

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed"

  const contextValue = React.useMemo(() => ({
    state,
    open,
    setOpen,
    isMobile,
    openMobile,
    setOpenMobile,
    toggleSidebar,
  }), [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar])

  return (
    (<SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style
            }
          }
          className={cn(
            "group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",
            className
          )}
          ref={ref}
          {...props}>
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>)
  );
})
SidebarProvider.displayName = "SidebarProvider"

const Sidebar = React.forwardRef((
  {
    side = "left",
    variant = "sidebar",
    collapsible = "offcanvas",
    className,
    children,
    ...props
  },
  ref
) => {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

  if (collapsible === "none") {
    return (
      (<div
        className={cn(
          "flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",
          className
        )}
        ref={ref}
        {...props}>
        {children}
      </div>)
    );
  }

  if (isMobile) {
    return (
      (<Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-mobile="true"
          className="w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE
            }
          }
          side={side}>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>)
    );
  }

  return (
    (<div
      ref={ref}
      className="group peer hidden text-sidebar-foreground md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}>
      {/* This is what handles the sidebar gap on desktop */}
      <div
        className={cn(
          "relative h-svh w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]"
            : "group-data-[collapsible=icon]:w-[--sidebar-width-icon]"
        )} />
      <div
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]"
            : "group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className
        )}
        {...props}>
        <div
          data-sidebar="sidebar"
          className="flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow">
          {children}
        </div>
      </div>
    </div>)
  );
})
Sidebar.displayName = "Sidebar"

const SidebarTrigger = React.forwardRef(({ className, onClick, asChild = false, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    (<Button
      ref={ref}
      data-sidebar="trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      asChild={asChild}
      {...props}>
      {asChild ? (
        <PanelLeft />
      ) : (
        <>
          <PanelLeft />
          <span className="sr-only">Toggle Sidebar</span>
        </>
      )}
    </Button>)
  );
})
SidebarTrigger.displayName = "SidebarTrigger"

const SidebarRail = React.forwardRef(({ className, ...props }, ref) => {
  const { toggleSidebar } = useSidebar()

  return (
    (<button
      ref={ref}
      data-sidebar="rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex",
        "[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props} />)
  );
})
SidebarRail.displayName = "SidebarRail"

const SidebarInset = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<main
      ref={ref}
      className={cn(
        "relative flex min-h-svh flex-1 flex-col bg-background",
        "peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",
        className
      )}
      {...props} />)
  );
})
SidebarInset.displayName = "SidebarInset"

const SidebarInput = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<Input
      ref={ref}
      data-sidebar="input"
      className={cn(
        "h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",
        className
      )}
      {...props} />)
  );
})
SidebarInput.displayName = "SidebarInput"

const SidebarHeader = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<div
      ref={ref}
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props} />)
  );
})
SidebarHeader.displayName = "SidebarHeader"

const SidebarFooter = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<div
      ref={ref}
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props} />)
  );
})
SidebarFooter.displayName = "SidebarFooter"

const SidebarSeparator = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<Separator
      ref={ref}
      data-sidebar="separator"
      className={cn("mx-2 w-auto bg-sidebar-border", className)}
      {...props} />)
  );
})
SidebarSeparator.displayName = "SidebarSeparator"

const SidebarContent = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<div
      ref={ref}
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props} />)
  );
})
SidebarContent.displayName = "SidebarContent"

const SidebarGroup = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<div
      ref={ref}
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props} />)
  );
})
SidebarGroup.displayName = "SidebarGroup"

const SidebarGroupLabel = React.forwardRef(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "div"

  return (
    (<Comp
      ref={ref}
      data-sidebar="group-label"
      className={cn(
        "flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props} />)
  );
})
SidebarGroupLabel.displayName = "SidebarGroupLabel"

const SidebarGroupAction = React.forwardRef(({ className, asChild = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    (<Comp
      ref={ref}
      data-sidebar="group-action"
      className={cn(
        "absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props} />)
  );
})
SidebarGroupAction.displayName = "SidebarGroupAction"

const SidebarGroupContent = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="group-content"
    className={cn("w-full text-sm", className)}
    {...props} />
))
SidebarGroupContent.displayName = "SidebarGroupContent"

const SidebarMenu = React.forwardRef(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu"
    className={cn("flex w-full min-w-0 flex-col gap-1", className)}
    {...props} />
))
SidebarMenu.displayName = "SidebarMenu"

const SidebarMenuItem = React.forwardRef(({ className, ...props }, ref) => (
  <li
    ref={ref}
    data-sidebar="menu-item"
    className={cn("group/menu-item relative", className)}
    {...props} />
))
SidebarMenuItem.displayName = "SidebarMenuItem"

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:!p-0",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const SidebarMenuButton = React.forwardRef((
  {
    asChild = false,
    isActive = false,
    variant = "default",
    size = "default",
    tooltip,
    className,
    ...props
  },
  ref
) => {
  const Comp = asChild ? Slot : "button"
  const { isMobile, state } = useSidebar()

  const button = (
    <Comp
      ref={ref}
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props} />
  )

  if (!tooltip) {
    return button
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    }
  }

  return (
    (<Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== "collapsed" || isMobile}
        {...tooltip} />
    </Tooltip>)
  );
})
SidebarMenuButton.displayName = "SidebarMenuButton"

const SidebarMenuAction = React.forwardRef(({ className, asChild = false, showOnHover = false, ...props }, ref) => {
  const Comp = asChild ? Slot : "button"

  return (
    (<Comp
      ref={ref}
      data-sidebar="menu-action"
      className={cn(
        "absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 after:md:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
        "group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",
        className
      )}
      {...props} />)
  );
})
SidebarMenuAction.displayName = "SidebarMenuAction"

const SidebarMenuBadge = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    data-sidebar="menu-badge"
    className={cn(
      "pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground",
      "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
      "peer-data-[size=sm]/menu-button:top-1",
      "peer-data-[size=default]/menu-button:top-1.5",
      "peer-data-[size=lg]/menu-button:top-2.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props} />
))
SidebarMenuBadge.displayName = "SidebarMenuBadge"

const SidebarMenuSkeleton = React.forwardRef(({ className, showIcon = false, ...props }, ref) => {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`;
  }, [])

  return (
    (<div
      ref={ref}
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}>
      {showIcon && (
        <Skeleton className="size-4 rounded-md" data-sidebar="menu-skeleton-icon" />
      )}
      <Skeleton
        className="h-4 max-w-[--skeleton-width] flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width
          }
        } />
    </div>)
  );
})
SidebarMenuSkeleton.displayName = "SidebarMenuSkeleton"

const SidebarMenuSub = React.forwardRef(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    data-sidebar="menu-sub"
    className={cn(
      "mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5",
      "group-data-[collapsible=icon]:hidden",
      className
    )}
    {...props} />
))
SidebarMenuSub.displayName = "SidebarMenuSub"

const SidebarMenuSubItem = React.forwardRef(({ ...props }, ref) => <li ref={ref} {...props} />)
SidebarMenuSubItem.displayName = "SidebarMenuSubItem"

const SidebarMenuSubButton = React.forwardRef(
  ({ asChild = false, size = "md", isActive, className, ...props }, ref) => {
    const Comp = asChild ? Slot : "a"

    return (
      (<Comp
        ref={ref}
        data-sidebar="menu-sub-button"
        data-size={size}
        data-active={isActive}
        className={cn(
          "flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground",
          "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
          size === "sm" && "text-xs",
          size === "md" && "text-sm",
          "group-data-[collapsible=icon]:hidden",
          className
        )}
        {...props} />)
    );
  }
)
SidebarMenuSubButton.displayName = "SidebarMenuSubButton"

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}
</file>

<file path="src/components/ui/skeleton.jsx">
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}) {
  return (
    (<div
      className={cn("animate-pulse rounded-md bg-primary/10", className)}
      {...props} />)
  );
}

export { Skeleton }
</file>

<file path="src/components/ui/slider.jsx">
import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn("relative flex w-full touch-none select-none items-center", className)}
    {...props}>
    <SliderPrimitive.Track
      className="relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb
      className="block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }
</file>

<file path="src/components/ui/sonner.jsx">
"use client";
import { useTheme } from "next-themes"
import { Toaster as Sonner } from "sonner"

const Toaster = ({
  ...props
}) => {
  const { theme = "system" } = useTheme()

  return (
    (<Sonner
      theme={theme}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props} />)
  );
}

export { Toaster }
</file>

<file path="src/components/ui/switch.jsx">
import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}>
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )} />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }
</file>

<file path="src/components/ui/table.jsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props} />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props} />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0", className)}
    {...props} />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props} />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
      className
    )}
    {...props} />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn(
      "p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
      className
    )}
    {...props} />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props} />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="src/components/ui/tabs.jsx">
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props} />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",
      className
    )}
    {...props} />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props} />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/textarea.jsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef(({ className, ...props }, ref) => {
  return (
    (<textarea
      className={cn(
        "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props} />)
  );
})
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="src/components/ui/toast.jsx">
import * as React from "react";
import { cva } from "class-variance-authority";
import { X } from "lucide-react";
import { cn } from "@/lib/utils";

const ToastProvider = React.forwardRef(({ ...props }, ref) => (
  <div
    ref={ref}
    className="fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]"
    {...props}
  />
));
ToastProvider.displayName = "ToastProvider";

const ToastViewport = React.forwardRef(({ ...props }, ref) => (
  <div
    ref={ref}
    className="fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]"
    {...props}
  />
));
ToastViewport.displayName = "ToastViewport";

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

const Toast = React.forwardRef(({ className, variant, ...props }, ref) => {
  return (
    <div
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  );
});
Toast.displayName = "Toast";

const ToastAction = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
));
ToastAction.displayName = "ToastAction";

const ToastClose = React.forwardRef(({ className, ...props }, ref) => (
  <button
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </button>
));
ToastClose.displayName = "ToastClose";

const ToastTitle = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
));
ToastTitle.displayName = "ToastTitle";

const ToastDescription = React.forwardRef(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
));
ToastDescription.displayName = "ToastDescription";

export {
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
};
</file>

<file path="src/components/ui/toaster.jsx">
import { useToast } from "@/components/ui/use-toast";
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast";

export function Toaster() {
  const { toasts } = useToast();

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        );
      })}
      <ToastViewport />
    </ToastProvider>
  );
}
</file>

<file path="src/components/ui/toggle-group.jsx">
"use client";
import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}>
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    (<ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(toggleVariants({
        variant: context.variant || variant,
        size: context.size || size,
      }), className)}
      {...props}>
      {children}
    </ToggleGroupPrimitive.Item>)
  );
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }
</file>

<file path="src/components/ui/toggle.jsx">
import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva } from "class-variance-authority";

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props} />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }
</file>

<file path="src/components/ui/tooltip.jsx">
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props} />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="src/components/ui/use-toast.jsx">
// Inspired by react-hot-toast library
import { useState, useEffect } from "react";

const TOAST_LIMIT = 20;
const TOAST_REMOVE_DELAY = 1000000;

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
};

let count = 0;

function genId() {
  count = (count + 1) % Number.MAX_VALUE;
  return count.toString();
}

const toastTimeouts = new Map();

const addToRemoveQueue = (toastId) => {
  if (toastTimeouts.has(toastId)) {
    return;
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId);
    dispatch({
      type: actionTypes.REMOVE_TOAST,
      toastId,
    });
  }, TOAST_REMOVE_DELAY);

  toastTimeouts.set(toastId, timeout);
};

const _clearFromRemoveQueue = (toastId) => {
  const timeout = toastTimeouts.get(toastId);
  if (timeout) {
    clearTimeout(timeout);
    toastTimeouts.delete(toastId);
  }
};

export const reducer = (state, action) => {
  switch (action.type) {
    case actionTypes.ADD_TOAST:
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      };

    case actionTypes.UPDATE_TOAST:
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      };

    case actionTypes.DISMISS_TOAST: {
      const { toastId } = action;

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId);
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id);
        });
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      };
    }
    case actionTypes.REMOVE_TOAST:
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        };
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      };
  }
};

const listeners = [];

let memoryState = { toasts: [] };

function dispatch(action) {
  memoryState = reducer(memoryState, action);
  listeners.forEach((listener) => {
    listener(memoryState);
  });
}

function toast({ ...props }) {
  const id = genId();

  const update = (props) =>
    dispatch({
      type: actionTypes.UPDATE_TOAST,
      toast: { ...props, id },
    });

  const dismiss = () =>
    dispatch({ type: actionTypes.DISMISS_TOAST, toastId: id });

  dispatch({
    type: actionTypes.ADD_TOAST,
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss();
      },
    },
  });

  return {
    id,
    dismiss,
    update,
  };
}

function useToast() {
  const [state, setState] = useState(memoryState);

  useEffect(() => {
    listeners.push(setState);
    return () => {
      const index = listeners.indexOf(setState);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    };
  }, [state]);

  return {
    ...state,
    toast,
    dismiss: (toastId) => dispatch({ type: actionTypes.DISMISS_TOAST, toastId }),
  };
}

export { useToast, toast };
</file>

<file path="src/components/UserNotRegisteredError.jsx">
import React from 'react';

const UserNotRegisteredError = () => {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-white to-slate-50">
      <div className="max-w-md w-full p-8 bg-white rounded-lg shadow-lg border border-slate-100">
        <div className="text-center">
          <div className="inline-flex items-center justify-center w-16 h-16 mb-6 rounded-full bg-orange-100">
            <svg className="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h1 className="text-3xl font-bold text-slate-900 mb-4">Access Restricted</h1>
          <p className="text-slate-600 mb-8">
            You are not registered to use this application. Please contact the app administrator to request access.
          </p>
          <div className="p-4 bg-slate-50 rounded-md text-sm text-slate-600">
            <p>If you believe this is an error, you can:</p>
            <ul className="list-disc list-inside mt-2 space-y-1">
              <li>Verify you are logged in with the correct account</li>
              <li>Contact the app administrator for access</li>
              <li>Try logging out and back in again</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
};

export default UserNotRegisteredError;
</file>

<file path="src/components/utils/correccionRetroactivaEnvases.jsx">
/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * CORRECCI√ìN RETROACTIVA v4 - ENVASES (DEVOLUCIONES NO SUMAN)
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * L√ìGICA REAL DEL NEGOCIO:
 * 
 * INGRESO DE FRUTA (Proveedor):
 * - INGRESO (Devoluci√≥n): NO suma a stock (mis envases devueltos)
 * - SALIDA (Entrega): Resta de Stock Vac√≠os
 * 
 * SALIDA DE FRUTA (Cliente):
 * - SALIDA (Entrega): Resta de Stock Vac√≠os
 * - INGRESO (Devoluci√≥n): S√ç suma (envases del cliente)
 * 
 * Stock Vac√≠os = Compra inicial - Entregas + Devoluciones de clientes
 */

import { toFixed2 } from './precisionDecimal';

/**
 * Ejecuta correcci√≥n retroactiva √∫nica de todos los stocks de envases
 * eliminando aplicaciones err√≥neas de l√≥gica en registros hist√≥ricos
 * 
 * IMPORTANTE: Esta funci√≥n es idempotente - puede ejecutarse m√∫ltiples veces
 * sin causar problemas, siempre recalcula desde cero bas√°ndose en todos los movimientos
 */
export async function correccionRetroactivaEnvases(base44) {
  try {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  üîß CORRECCI√ìN RETROACTIVA ABSOLUTA - ENVASES OCUPADOS/VAC√çOS   ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    // Obtener todos los datos necesarios
    const [envases, movimientos, salidas] = await Promise.all([
      base44.entities.Envase.list(),
      base44.entities.Movimiento.list(),
      base44.entities.SalidaFruta.list()
    ]);

    const correcciones = [];
    let totalEnvasesAjustados = 0;

    for (const envase of envases) {
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PASO 1: Calcular stocks CORRECTOS desde cero (M√âTODO AT√ìMICO)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      let stockOcupadosCorrecto = 0;
      let stockVaciosCorrecto = 0;
      const detalleMovimientos = [];

      // Procesar TODOS los movimientos (Ingreso de Fruta y Mov. Envases)
      movimientos.forEach(mov => {
        if (mov.movimiento_envases && Array.isArray(mov.movimiento_envases)) {
          mov.movimiento_envases.forEach(me => {
            if (me.envase_id === envase.id) {
              const ingreso = parseInt(me.cantidad_ingreso) || 0;
              const salida = parseInt(me.cantidad_salida) || 0;
              
              const esIngresoFruta = mov.tipo_movimiento === 'Ingreso de Fruta';
              
              // INGRESO - Solo suma si NO es devoluci√≥n de proveedor
              if (ingreso > 0 && !esIngresoFruta) {
                stockVaciosCorrecto += ingreso;
                detalleMovimientos.push({
                  id: mov.id,
                  tipo: mov.tipo_movimiento,
                  operacion: `Ingreso +${ingreso} VAC√çOS`,
                  ocupados: stockOcupadosCorrecto,
                  vacios: stockVaciosCorrecto
                });
              } else if (ingreso > 0 && esIngresoFruta) {
                detalleMovimientos.push({
                  id: mov.id,
                  tipo: mov.tipo_movimiento,
                  operacion: `Devoluci√≥n ${ingreso} (NO suma - proveedor)`,
                  ocupados: stockOcupadosCorrecto,
                  vacios: stockVaciosCorrecto
                });
              }
              
              // SALIDA - SIEMPRE resta de Stock Vac√≠os
              if (salida > 0) {
                stockVaciosCorrecto -= salida;
                detalleMovimientos.push({
                  id: mov.id,
                  tipo: mov.tipo_movimiento,
                  operacion: `Salida -${salida} VAC√çOS`,
                  ocupados: stockOcupadosCorrecto,
                  vacios: stockVaciosCorrecto
                });
              }
            }
          });
        }
      });

      // Procesar TODAS las salidas de fruta
      salidas.forEach(sal => {
        if (sal.movimiento_envases && Array.isArray(sal.movimiento_envases)) {
          sal.movimiento_envases.forEach(me => {
            if (me.envase_id === envase.id) {
              const ingreso = parseInt(me.cantidad_ingreso) || 0;
              const salida = parseInt(me.cantidad_salida) || 0;
              const ingresoConFruta = me.ingreso_con_fruta === true;
              
              // INGRESO en Salida de Fruta - S√ç suma (devoluci√≥n de cliente)
              if (ingreso > 0) {
                if (ingresoConFruta) {
                  stockOcupadosCorrecto += ingreso;
                  detalleMovimientos.push({
                    id: sal.id,
                    tipo: 'Salida de Fruta',
                    operacion: `Ingreso +${ingreso} OCUPADOS (cliente)`,
                    ocupados: stockOcupadosCorrecto,
                    vacios: stockVaciosCorrecto
                  });
                } else {
                  stockVaciosCorrecto += ingreso;
                  detalleMovimientos.push({
                    id: sal.id,
                    tipo: 'Salida de Fruta',
                    operacion: `Ingreso +${ingreso} VAC√çOS (cliente)`,
                    ocupados: stockOcupadosCorrecto,
                    vacios: stockVaciosCorrecto
                  });
                }
              }
              
              // SALIDA - SIEMPRE resta de Stock Vac√≠os
              if (salida > 0) {
                stockVaciosCorrecto -= salida;
                detalleMovimientos.push({
                  id: sal.id,
                  tipo: 'Salida de Fruta',
                  operacion: `Salida -${salida} VAC√çOS`,
                  ocupados: stockOcupadosCorrecto,
                  vacios: stockVaciosCorrecto
                });
              }
            }
          });
        }
      });

      // Permitir negativos para detectar d√©ficits reales
      const deficitOcupados = stockOcupadosCorrecto < 0;
      const deficitVacios = stockVaciosCorrecto < 0;
      
      if (deficitOcupados) {
        console.warn(`‚ö†Ô∏è  D√âFICIT DETECTADO: ${envase.tipo} - Ocupados: ${stockOcupadosCorrecto} (ajustando a 0)`);
      }
      if (deficitVacios) {
        console.warn(`‚ö†Ô∏è  D√âFICIT DETECTADO: ${envase.tipo} - Vac√≠os: ${stockVaciosCorrecto} (ajustando a 0)`);
      }
      
      stockOcupadosCorrecto = Math.max(0, stockOcupadosCorrecto);
      stockVaciosCorrecto = Math.max(0, stockVaciosCorrecto);

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PASO 2: Detectar discrepancia y corregir
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      const ocupadosActual = parseInt(envase.stock_ocupados) || 0;
      const vaciosActual = parseInt(envase.stock_vacios) || 0;
      
      const diferenciaOcupados = ocupadosActual - stockOcupadosCorrecto;
      const diferenciaVacios = vaciosActual - stockVaciosCorrecto;
      
      if (Math.abs(diferenciaOcupados) > 0 || Math.abs(diferenciaVacios) > 0) {
        correcciones.push({
          envaseId: envase.id,
          envaseTipo: envase.tipo,
          ocupadosAnterior: ocupadosActual,
          ocupadosCorrecto: stockOcupadosCorrecto,
          diferenciaOcupados: diferenciaOcupados,
          vaciosAnterior: vaciosActual,
          vaciosCorrecto: stockVaciosCorrecto,
          diferenciaVacios: diferenciaVacios,
          movimientosAplicados: detalleMovimientos.length
        });
        
        // Actualizar stock en base de datos
        await base44.entities.Envase.update(envase.id, {
          stock_ocupados: stockOcupadosCorrecto,
          stock_vacios: stockVaciosCorrecto
        });
        
        totalEnvasesAjustados += Math.abs(diferenciaOcupados) + Math.abs(diferenciaVacios);
        
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`üîß CORRECCI√ìN APLICADA - Envase: ${envase.tipo}`);
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`   üì¶ OCUPADOS (CON FRUTA):`);
        console.log(`      Anterior: ${ocupadosActual} unidades`);
        console.log(`      Correcto: ${stockOcupadosCorrecto} unidades`);
        console.log(`      Diferencia: ${diferenciaOcupados} unidades`);
        console.log(`   `);
        console.log(`   üì¶ VAC√çOS (SIN FRUTA):`);
        console.log(`      Anterior: ${vaciosActual} unidades`);
        console.log(`      Correcto: ${stockVaciosCorrecto} unidades`);
        console.log(`      Diferencia: ${diferenciaVacios} unidades`);
        console.log(`   `);
        console.log(`   üìä MOVIMIENTOS PROCESADOS: ${detalleMovimientos.length}`);
        if (detalleMovimientos.length > 0 && detalleMovimientos.length <= 10) {
          console.log(`   üìã DETALLE:`);
          detalleMovimientos.forEach((mov, idx) => {
            console.log(`      ${idx + 1}. ${mov.tipo} - ${mov.operacion} (O:${mov.ocupados}, V:${mov.vacios})`);
          });
        } else if (detalleMovimientos.length > 10) {
          console.log(`   üìã (Mostrando √∫ltimos 5 de ${detalleMovimientos.length}):`);
          detalleMovimientos.slice(-5).forEach((mov, idx) => {
            console.log(`      ${detalleMovimientos.length - 4 + idx}. ${mov.tipo} - ${mov.operacion} (O:${mov.ocupados}, V:${mov.vacios})`);
          });
        }
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RESUMEN DE CORRECCI√ìN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  ‚úÖ CORRECCI√ìN RETROACTIVA DE ENVASES COMPLETADA                ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log(`   Envases Corregidos: ${correcciones.length}`);
    console.log(`   Unidades Ajustadas (total): ${totalEnvasesAjustados}`);
    console.log(`   `);
    console.log(`   üîê GARANT√çA DE CORRECCI√ìN v4:`);
    console.log(`      ‚Ä¢ Stocks recalculados con L√ìGICA REAL DEL NEGOCIO`);
    console.log(`      ‚Ä¢ Devoluciones de proveedores NO suman a stock`);
    console.log(`      ‚Ä¢ Entregas SIEMPRE restan de Stock Vac√≠os`);
    console.log(`      ‚Ä¢ Devoluciones de clientes S√ç suman a stock`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    return {
      corregidos: correcciones.length,
      detalles: correcciones,
      unidadesAjustadas: totalEnvasesAjustados
    };
    
  } catch (error) {
    console.error('\n‚ùå ERROR EN CORRECCI√ìN RETROACTIVA DE ENVASES:', error);
    throw error;
  }
}

/**
 * Valida que los stocks de envases sean coherentes
 */
export function validarStocksEnvases(envase, cantidadOperacion, esOcupado, esSalida) {
  const stockDisponible = esOcupado ? (envase.stock_ocupados || 0) : (envase.stock_vacios || 0);
  
  if (esSalida && cantidadOperacion > stockDisponible) {
    console.warn(`‚ö†Ô∏è  Stock insuficiente: ${envase.tipo} - Requiere ${cantidadOperacion} ${esOcupado ? 'ocupados' : 'vac√≠os'}, disponible: ${stockDisponible}`);
    return false;
  }
  
  return true;
}
</file>

<file path="src/components/utils/correccionRetroactivaPerdidas.jsx">
/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * CORRECCI√ìN RETROACTIVA ABSOLUTA - P√âRDIDAS IRREVERSIBLES
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Este m√≥dulo corrige los stocks actuales eliminando cualquier suma
 * err√≥nea de p√©rdidas al inventario de registros hist√≥ricos previos.
 * 
 * L√ìGICA INQUEBRANTABLE:
 * - P√©rdidas por b√°scula (Originales - Reales) son DEFINITIVAS
 * - P√©rdidas por calidad (Descuentos) son DEFINITIVAS  
 * - NUNCA se suman de vuelta al stock disponible
 * - Recalcula stock desde CERO basado en todos los movimientos
 */

import { toFixed2, restaExacta, sumaExacta } from './precisionDecimal';

/**
 * Ejecuta correcci√≥n retroactiva √∫nica de todos los stocks de productos
 * eliminando sumas err√≥neas de p√©rdidas que no debieron impactar positivamente
 * 
 * IMPORTANTE: Esta funci√≥n es idempotente - puede ejecutarse m√∫ltiples veces
 * sin causar problemas, siempre recalcula desde cero bas√°ndose en todos los movimientos
 */
export async function correccionRetroactivaPerdidas(base44) {
  try {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  üîß CORRECCI√ìN RETROACTIVA ABSOLUTA - P√âRDIDAS IRREVERSIBLES     ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    
    // Obtener todos los datos necesarios
    const [productos, movimientos, salidas] = await Promise.all([
      base44.entities.Producto.list(),
      base44.entities.Movimiento.list(),
      base44.entities.SalidaFruta.list()
    ]);

    const correcciones = [];
    let totalPerdidaGlobal = 0;
    let totalKgAjustados = 0;

    for (const producto of productos) {
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PASO 1: Calcular stock CORRECTO desde cero (M√âTODO AT√ìMICO)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      let stockCorrecto = 0;
      let totalIngresado = 0;
      
      // Sumar TODOS los ingresos netos (pesajes de movimientos)
      movimientos.forEach(mov => {
        if (mov.pesajes && Array.isArray(mov.pesajes)) {
          mov.pesajes.forEach(pesaje => {
            if (pesaje.producto_id === producto.id && pesaje.peso_neto) {
              const ingreso = toFixed2(pesaje.peso_neto);
              stockCorrecto = sumaExacta(stockCorrecto, ingreso);
              totalIngresado = sumaExacta(totalIngresado, ingreso);
            }
          });
        }
      });

      // Restar TODAS las salidas originales (todo lo que sali√≥ = permanente)
      let totalSalidoOriginal = 0;
      let totalPerdidasProducto = 0;
      let salidasDetalle = [];
      
      salidas.forEach(salida => {
        if (salida.detalles && Array.isArray(salida.detalles)) {
          salida.detalles.forEach(detalle => {
            if (detalle.producto_id === producto.id) {
              const kilosOriginales = toFixed2(detalle.kilos_salida);
              totalSalidoOriginal = sumaExacta(totalSalidoOriginal, kilosOriginales);
              
              // Si est√° confirmada, calcular p√©rdidas definitivas (NO retornan)
              if (salida.estado === 'Confirmada') {
                const kilosReales = toFixed2(detalle.kilos_reales || kilosOriginales);
                const descuentoKg = toFixed2(detalle.descuento_kg || 0);
                
                const perdidaBascula = restaExacta(kilosOriginales, kilosReales);
                const perdidaTotal = sumaExacta(perdidaBascula, descuentoKg);
                totalPerdidasProducto = sumaExacta(totalPerdidasProducto, perdidaTotal);
                
                salidasDetalle.push({
                  id: salida.id,
                  numero: salida.numero_remito,
                  originales: kilosOriginales,
                  reales: kilosReales,
                  descuento: descuentoKg,
                  perdida: perdidaTotal
                });
              } else {
                // Pendientes: se restaron originales, sin p√©rdidas a√∫n
                salidasDetalle.push({
                  id: salida.id,
                  numero: salida.numero_remito,
                  originales: kilosOriginales,
                  estado: 'Pendiente'
                });
              }
            }
          });
        }
      });
      
      // Stock correcto = Ingresos - Salidas Originales Totales
      // (P√©rdidas incluidas en salidas originales, NO se suman de vuelta)
      stockCorrecto = restaExacta(stockCorrecto, totalSalidoOriginal);
      
      // Permitir negativos para detectar d√©ficits reales
      const permitirNegativo = stockCorrecto < 0;
      if (permitirNegativo) {
        console.warn(`‚ö†Ô∏è  D√âFICIT DETECTADO: ${producto.producto_completo || producto.fruta}: ${stockCorrecto.toFixed(2)} kg (ingresado: ${totalIngresado.toFixed(2)} kg, salido: ${totalSalidoOriginal.toFixed(2)} kg)`);
      }
      stockCorrecto = Math.max(0, stockCorrecto); // Ajustar a 0 si negativo

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PASO 2: Detectar discrepancia y corregir
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      
      const stockActual = toFixed2(producto.stock || 0);
      const diferencia = restaExacta(stockActual, stockCorrecto);
      
      if (Math.abs(diferencia) > 0.01) { // Tolerancia de 0.01 kg
        correcciones.push({
          productoId: producto.id,
          productoNombre: producto.producto_completo || `${producto.fruta} - ${producto.variedad}`,
          stockAnterior: stockActual,
          stockCorrecto: stockCorrecto,
          diferencia: diferencia,
          perdidasAcumuladas: totalPerdidasProducto,
          totalIngresado: totalIngresado,
          totalSalido: totalSalidoOriginal,
          salidasDetalle: salidasDetalle
        });
        
        // Actualizar stock en base de datos
        await base44.entities.Producto.update(producto.id, {
          stock: stockCorrecto
        });
        
        totalKgAjustados = sumaExacta(totalKgAjustados, Math.abs(diferencia));
        
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`üîß CORRECCI√ìN APLICADA - Salida ID: N/A (Retroactivo)`);
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log(`   Producto: ${producto.producto_completo || `${producto.fruta} - ${producto.variedad}`}`);
        console.log(`   Stock Anterior (CON ERROR): ${stockActual.toFixed(2)} kg`);
        console.log(`   Stock Correcto (RECALCULADO): ${stockCorrecto.toFixed(2)} kg`);
        console.log(`   Diferencia Eliminada: ${diferencia.toFixed(2)} kg`);
        console.log(`   `);
        console.log(`   üìä C√ÅLCULO AT√ìMICO:`);
        console.log(`      Total Ingresado: ${totalIngresado.toFixed(2)} kg`);
        console.log(`      Total Salido (Originales): ${totalSalidoOriginal.toFixed(2)} kg`);
        console.log(`      P√©rdidas Acumuladas: ${totalPerdidasProducto.toFixed(2)} kg`);
        console.log(`      ‚îî‚îÄ Incluidas en Salidas, NO retornadas al stock`);
        console.log(`   `);
        if (salidasDetalle.length > 0) {
          console.log(`   üì¶ DETALLE DE SALIDAS:`);
          salidasDetalle.forEach(s => {
            if (s.estado === 'Pendiente') {
              console.log(`      ‚Ä¢ ${s.numero}: ${s.originales.toFixed(2)} kg (Pendiente)`);
            } else {
              console.log(`      ‚Ä¢ ${s.numero}: Orig=${s.originales.toFixed(2)} kg, Reales=${s.reales.toFixed(2)} kg, Desc=${s.descuento.toFixed(2)} kg, P√©rdida=${s.perdida.toFixed(2)} kg`);
            }
          });
        }
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
        
        totalPerdidaGlobal = sumaExacta(totalPerdidaGlobal, totalPerdidasProducto);
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RESUMEN DE CORRECCI√ìN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë  ‚úÖ CORRECCI√ìN RETROACTIVA COMPLETADA                            ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log(`   Productos Corregidos: ${correcciones.length}`);
    console.log(`   Kilos Ajustados (total absoluto): ${totalKgAjustados.toFixed(2)} kg`);
    console.log(`   P√©rdidas Totales Definitivas: ${totalPerdidaGlobal.toFixed(2)} kg`);
    console.log(`   ‚îî‚îÄ NO sumadas de vuelta al stock (eliminadas correctamente)`);
    console.log(`   `);
    console.log(`   üîê GARANT√çA DE CORRECCI√ìN:`);
    console.log(`      ‚Ä¢ Todos los stocks recalculados desde CERO`);
    console.log(`      ‚Ä¢ P√©rdidas tratadas como definitivas e irreversibles`);
    console.log(`      ‚Ä¢ Registros hist√≥ricos ajustados sin recreaci√≥n`);
    console.log(`      ‚Ä¢ Operaci√≥n idempotente y at√≥mica`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    return {
      corregidos: correcciones.length,
      detalles: correcciones,
      perdidasTotales: totalPerdidaGlobal,
      kgAjustados: totalKgAjustados
    };
    
  } catch (error) {
    console.error('\n‚ùå ERROR EN CORRECCI√ìN RETROACTIVA:', error);
    throw error;
  }
}

/**
 * Valida que las p√©rdidas no se est√©n sumando err√≥neamente al stock
 * Debe ejecutarse antes de confirmar una salida
 */
export function validarPerdidasNoRetornan(producto, perdidasPorAgregar) {
  if (perdidasPorAgregar > 0) {
    console.log('‚ö†Ô∏è  VALIDACI√ìN: Verificando que p√©rdidas NO vuelvan al stock...');
    console.log(`   Producto: ${producto.producto_completo}`);
    console.log(`   P√©rdidas a registrar: ${perdidasPorAgregar.toFixed(2)} kg`);
    console.log(`   Stock actual: ${(producto.stock || 0).toFixed(2)} kg`);
    console.log(`   ‚úì P√©rdidas se registran como DEFINITIVAS (no impactan stock positivamente)`);
    return true;
  }
  return true;
}

/**
 * Calcula el stock te√≥rico correcto de un producto sin considerar p√©rdidas
 * como retornos al inventario
 */
export function calcularStockTeoricoSinPerdidas(producto, movimientos, salidas) {
  let stock = 0;
  
  // Sumar todos los ingresos netos
  movimientos.forEach(mov => {
    if (mov.pesajes && Array.isArray(mov.pesajes)) {
      mov.pesajes.forEach(pesaje => {
        if (pesaje.producto_id === producto.id && pesaje.peso_neto) {
          stock = sumaExacta(stock, pesaje.peso_neto);
        }
      });
    }
  });
  
  // Restar todas las salidas originales (incluyendo p√©rdidas como parte de la salida)
  salidas.forEach(salida => {
    if (salida.detalles && Array.isArray(salida.detalles)) {
      salida.detalles.forEach(detalle => {
        if (detalle.producto_id === producto.id) {
          stock = restaExacta(stock, detalle.kilos_salida);
        }
      });
    }
  });
  
  return Math.max(0, stock);
}
</file>

<file path="src/components/utils/precisionDecimal.jsx">
/**
 * Utilidades para operaciones decimales con precisi√≥n exacta
 * Evita errores de punto flotante en c√°lculos de kilos
 */

/**
 * Redondea un n√∫mero a 2 decimales con precisi√≥n exacta
 * @param {number} num - N√∫mero a redondear
 * @returns {number} - N√∫mero redondeado a 2 decimales
 */
export function toFixed2(num) {
  return Math.round((num + Number.EPSILON) * 100) / 100;
}

/**
 * Suma n√∫meros con precisi√≥n decimal exacta
 * @param {...number} nums - N√∫meros a sumar
 * @returns {number} - Suma exacta redondeada a 2 decimales
 */
export function sumaExacta(...nums) {
  const suma = nums.reduce((acc, num) => acc + (num || 0), 0);
  return toFixed2(suma);
}

/**
 * Resta n√∫meros con precisi√≥n decimal exacta
 * @param {number} a - Minuendo
 * @param {number} b - Sustraendo
 * @returns {number} - Diferencia exacta redondeada a 2 decimales
 */
export function restaExacta(a, b) {
  return toFixed2((a || 0) - (b || 0));
}

/**
 * Multiplica n√∫meros con precisi√≥n decimal exacta
 * @param {number} a - Factor 1
 * @param {number} b - Factor 2
 * @returns {number} - Producto exacto redondeado a 2 decimales
 */
export function multiplicaExacta(a, b) {
  return toFixed2((a || 0) * (b || 0));
}

/**
 * Calcula peso neto con precisi√≥n exacta
 * @param {number} pesoBruto - Peso bruto en kg
 * @param {number} tara - Tara total en kg
 * @returns {number} - Peso neto exacto (m√°ximo 0)
 */
export function calcularPesoNeto(pesoBruto, tara) {
  const neto = restaExacta(pesoBruto, tara);
  return Math.max(0, neto);
}

/**
 * Agrupa y suma kilos por producto con precisi√≥n exacta
 * @param {Array} items - Array de items con producto_id y kilos
 * @param {string} kilosField - Nombre del campo de kilos
 * @returns {Object} - Objeto con producto_id como clave y suma exacta como valor
 */
export function agruparKilosPorProducto(items, kilosField = 'peso_neto') {
  const grupos = {};
  items.forEach(item => {
    if (item.producto_id && item[kilosField] != null) {
      if (!grupos[item.producto_id]) {
        grupos[item.producto_id] = 0;
      }
      grupos[item.producto_id] = sumaExacta(grupos[item.producto_id], item[kilosField]);
    }
  });
  return grupos;
}

/**
 * Recalcula stock de un producto basado en todos sus movimientos
 * @param {string} productoId - ID del producto
 * @param {Array} movimientos - Array de movimientos con pesajes
 * @param {Array} salidas - Array de salidas con detalles
 * @returns {number} - Stock exacto calculado
 */
export function recalcularStockExacto(productoId, movimientos, salidas) {
  let stockCalculado = 0;
  
  // Sumar ingresos de movimientos
  movimientos.forEach(mov => {
    if (mov.pesajes) {
      mov.pesajes.forEach(pesaje => {
        if (pesaje.producto_id === productoId && pesaje.peso_neto) {
          stockCalculado = sumaExacta(stockCalculado, pesaje.peso_neto);
        }
      });
    }
  });
  
  // Restar salidas - L√ìGICA CORREGIDA: SIEMPRE restar ORIGINALES (p√©rdidas NO vuelven)
  salidas.forEach(salida => {
    if (salida.detalles) {
      salida.detalles.forEach(detalle => {
        if (detalle.producto_id === productoId) {
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // CORRECCI√ìN CR√çTICA: Las P√âRDIDAS son IRREVERSIBLES
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // - Stock se reduce SIEMPRE por kilos_salida ORIGINALES (lo que sali√≥ del acopio)
          // - Las p√©rdidas (b√°scula + calidad) NO vuelven al inventario
          // - NUNCA restar "kilos efectivos" (esto DEVUELVE las p√©rdidas al stock - ERROR)
          // 
          // Ejemplo: 2637 kg originales, 2632 kg reales, 78.96 kg descuento
          //   ‚Üí Stock se reduce por 2637 kg (los originales que salieron)
          //   ‚Üí P√©rdidas (5 + 78.96 = 83.96 kg) son definitivas, NO vuelven
          //   ‚Üí Cliente paga por 2553.04 kg efectivos
          //   ‚Üí Stock NUNCA debe aumentar por las p√©rdidas
          
          const kilosOriginalesSalidos = detalle.kilos_salida;
          stockCalculado = restaExacta(stockCalculado, kilosOriginalesSalidos);
        }
      });
    }
  });
  
  return Math.max(0, stockCalculado);
}
</file>

<file path="src/components/ValidadorCambioPrecios.jsx">
import { useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { toast } from 'sonner';

// Hook que alerta sobre cambios de precios que afecten liquidaciones
export function useValidadorCambioPrecios() {
  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios_validador'],
    queryFn: () => base44.entities.PeriodoPrecio.list('-fecha_desde'),
    staleTime: 5 * 60 * 1000,
  });

  const { data: liquidacionesSueldo = [] } = useQuery({
    queryKey: ['liquidaciones_validador'],
    queryFn: () => base44.entities.LiquidacionSueldo.list('-fecha_liquidacion'),
    staleTime: 5 * 60 * 1000,
  });

  const { data: liquidacionesFleteros = [] } = useQuery({
    queryKey: ['liquidacionesfleteros_validador'],
    queryFn: () => base44.entities.LiquidacionFletero.list('-fecha_liquidacion'),
    staleTime: 5 * 60 * 1000,
  });

  useEffect(() => {
    // Verificar si hay cambios de precios recientes que afecten liquidaciones pendientes
    const liquidacionesPendientes = [
      ...liquidacionesSueldo.filter(l => l.estado === 'Pendiente'),
      ...liquidacionesFleteros.filter(l => l.estado === 'Pendiente')
    ];

    if (liquidacionesPendientes.length > 0) {
      const preciosCambiados = periodosPrecios.filter(p => {
        const fechaDesde = new Date(p.fecha_desde);
        const hoy = new Date();
        const diasDesdeUltimoCambio = (hoy - fechaDesde) / (1000 * 60 * 60 * 24);
        return diasDesdeUltimoCambio < 7; // Cambios en √∫ltimos 7 d√≠as
      });

      if (preciosCambiados.length > 0) {
        toast.warning(
          `‚ö†Ô∏è Hay ${liquidacionesPendientes.length} liquidaci√≥n(es) pendiente(s) y precios fueron actualizados recientemente. Verifique que los c√°lculos sean correctos.`,
          { duration: 10000 }
        );
      }
    }
  }, [periodosPrecios, liquidacionesSueldo, liquidacionesFleteros]);

  return { periodosPrecios, liquidacionesSueldo, liquidacionesFleteros };
}
</file>

<file path="src/hooks/use-mobile.jsx">
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange);
  }, [])

  return !!isMobile
}
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
    --sidebar-background: 0 0% 98%;
    --sidebar-foreground: 240 5.3% 26.1%;
    --sidebar-primary: 240 5.9% 10%;
    --sidebar-primary-foreground: 0 0% 98%;
    --sidebar-accent: 240 4.8% 95.9%;
    --sidebar-accent-foreground: 240 5.9% 10%;
    --sidebar-border: 220 13% 91%;
    --sidebar-ring: 217.2 91.2% 59.8%;
  }

  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
    --sidebar-background: 240 5.9% 10%;
    --sidebar-foreground: 240 4.8% 95.9%;
    --sidebar-primary: 224.3 76.3% 48%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 240 3.7% 15.9%;
    --sidebar-accent-foreground: 240 4.8% 95.9%;
    --sidebar-border: 240 3.7% 15.9%;
    --sidebar-ring: 217.2 91.2% 59.8%;
  }
}



@layer base {
  * {
    @apply border-border outline-ring/50;
  }

  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="src/Layout.jsx">
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet";
import { 
  Apple, 
  ArrowLeftRight, 
  History, 
  FileText, 
  Package, 
  Menu,
  Home,
  ShoppingCart,
  Settings,
  CheckCircle,
  Sliders,
  TrendingDown,
  TrendingUp,
  ChevronLeft,
  ChevronRight,
  Users,
  Wallet,
  Banknote,
  Receipt,
  CreditCard,
  Landmark,
  HandCoins,
  PiggyBank,
  Scale
} from "lucide-react";
import { useCorreccionAutoRetroactiva } from '@/components/hooks/useCorreccionAutoRetroactiva';
import { useCorreccionEnvasesRetroactiva } from '@/components/hooks/useCorreccionEnvasesRetroactiva';
import { useCorreccionSegregacionEnvases } from '@/components/hooks/useCorreccionSegregacionEnvases';
import { useCorreccionCuentaCorriente } from '@/components/hooks/useCorreccionCuentaCorriente';
import { useCorreccionPreciosSalidas } from '@/components/hooks/useCorreccionPreciosSalidas';

const navItems = [
  { name: 'Inicio', icon: Home, page: 'Home' },
  { name: 'Movimiento de Fruta', icon: Apple, page: 'MovimientoFruta' },
  { name: 'Inventario', icon: Package, page: 'Inventario' },
  { name: 'Historial', icon: History, page: 'Historial' },
  { name: 'P√©rdidas', icon: Apple, page: 'Perdidas' },
  { name: 'Saldos', icon: Package, page: 'SaldosEnvases' },
  { name: 'Egresos', icon: TrendingDown, page: 'Egresos' },
  { name: 'Ingresos Varios', icon: TrendingUp, page: 'IngresosVarios' },
  {
    name: 'Tesorer√≠a',
    icon: Wallet,
    page: 'Tesoreria',
    subItems: [
      { name: 'Panel Principal', icon: PiggyBank, page: 'Tesoreria' },
      { name: 'Cuentas Corrientes', icon: Scale, page: 'CuentaCorriente' },
      { name: 'Pagos', icon: HandCoins, page: 'Pagos' },
      { name: 'Cobros', icon: Receipt, page: 'Cobros' },
      { name: 'Cajas', icon: Landmark, page: 'Cajas' },
      { name: 'Bancos', icon: Banknote, page: 'Bancos' },
      { name: 'Cheques', icon: CreditCard, page: 'Cheques' },
      { name: 'Movimientos Internos', icon: ArrowLeftRight, page: 'MovimientosTesoreria' }
    ]
  },
  { name: 'Informes Contables', icon: FileText, page: 'InformesContables' },
  { name: 'Empleados', icon: Users, page: 'Empleados' },
  { name: 'Configuraci√≥n', icon: Sliders, page: 'ConfiguracionUnificada' },
];

export default function Layout({ children, currentPageName }) {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [expandedMenus, setExpandedMenus] = useState({ 'Tesoreria': true });
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CORRECCIONES RETROACTIVAS - SE EJECUTAN UNA SOLA VEZ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Estas correcciones solo se ejecutan la primera vez que se carga la app
  // y se guardan en localStorage para evitar re-ejecuciones
  // useCorreccionAutoRetroactiva();
  // useCorreccionEnvasesRetroactiva();
  // useCorreccionSegregacionEnvases();
  // useCorreccionCuentaCorriente();
  // useCorreccionPreciosSalidas();

  const toggleMenu = (itemName) => {
    setExpandedMenus(prev => ({ ...prev, [itemName]: !prev[itemName] }));
  };

  const NavLink = ({ item, mobile = false, collapsed = false }) => {
    const isActive = currentPageName === item.page;
    const hasSubItems = item.subItems && item.subItems.length > 0;
    const isExpanded = expandedMenus[item.page];
    const isSubPageActive = hasSubItems && item.subItems.some(sub => currentPageName === sub.page);

    if (hasSubItems) {
      return (
        <div>
          <button
            onClick={() => {
              if (collapsed) {
                setSidebarOpen(true);
              }
              toggleMenu(item.page);
              if (mobile) setMobileMenuOpen(false);
            }}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
              isActive || isSubPageActive
                ? 'bg-green-100 text-green-700 font-medium' 
                : 'text-slate-600 hover:bg-slate-100'
            } ${collapsed ? 'justify-center' : ''}`}
            title={collapsed ? item.name : ''}
          >
            <item.icon className={`h-5 w-5 ${isActive || isSubPageActive ? 'text-green-600' : 'text-slate-400'} shrink-0`} />
            {!collapsed && (
              <>
                <span className="flex-1 text-left">{item.name}</span>
                <ChevronRight className={`h-4 w-4 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
              </>
            )}
          </button>
          {!collapsed && isExpanded && (
            <div className="ml-4 mt-1 space-y-1">
              {item.subItems.map(subItem => (
                <Link
                  key={subItem.page}
                  to={createPageUrl(subItem.page)}
                  onClick={() => mobile && setMobileMenuOpen(false)}
                  className={`flex items-center gap-3 px-4 py-2 rounded-lg transition-all ${
                    currentPageName === subItem.page
                      ? 'bg-green-100 text-green-700 font-medium' 
                      : 'text-slate-600 hover:bg-slate-100'
                  }`}
                >
                  <subItem.icon className={`h-4 w-4 ${currentPageName === subItem.page ? 'text-green-600' : 'text-slate-400'}`} />
                  <span className="text-sm">{subItem.name}</span>
                </Link>
              ))}
            </div>
          )}
        </div>
      );
    }

    return (
      <Link
        to={createPageUrl(item.page)}
        onClick={() => mobile && setMobileMenuOpen(false)}
        className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
          isActive 
            ? 'bg-green-100 text-green-700 font-medium' 
            : 'text-slate-600 hover:bg-slate-100'
        } ${collapsed ? 'justify-center' : ''}`}
        title={collapsed ? item.name : ''}
      >
        <item.icon className={`h-5 w-5 ${isActive ? 'text-green-600' : 'text-slate-400'} shrink-0`} />
        {!collapsed && <span>{item.name}</span>}
      </Link>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Desktop Sidebar */}
      <aside 
        className={`hidden lg:fixed lg:inset-y-0 lg:left-0 lg:flex lg:flex-col transition-all duration-300 ease-in-out ${sidebarOpen ? 'lg:w-64' : 'lg:w-20'}`}
      >
        <div className="flex flex-col flex-grow bg-white border-r border-slate-200 pt-5 overflow-y-auto overflow-x-hidden relative">
          {/* Logo and Toggle */}
          <div className={`flex items-center pb-6 px-4 ${sidebarOpen ? 'justify-between' : 'flex-col gap-4'}`}>
            {sidebarOpen ? (
              <>
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl flex items-center justify-center overflow-hidden shrink-0">
                    <img 
                      src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/694c069ad9a3c71a10fee653/2db155312_imagenesdeperfilISO_Mesadetrabajo1.jpg"
                      alt="Logo Acopio"
                      className="w-full h-full object-contain"
                    />
                  </div>
                  <div>
                    <h1 className="font-bold text-slate-800">Acopio</h1>
                    <p className="text-xs text-slate-500">Gesti√≥n de Frutas</p>
                  </div>
                </div>
                <button
                  onClick={() => setSidebarOpen(false)}
                  className="p-2 rounded-lg hover:bg-slate-100 transition-colors shrink-0"
                  title="Contraer men√∫"
                >
                  <ChevronLeft className="h-5 w-5 text-slate-600" />
                </button>
              </>
            ) : (
              <>
                <div className="w-10 h-10 rounded-xl flex items-center justify-center overflow-hidden">
                  <img 
                    src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/694c069ad9a3c71a10fee653/2db155312_imagenesdeperfilISO_Mesadetrabajo1.jpg"
                    alt="Logo Acopio"
                    className="w-full h-full object-contain"
                  />
                </div>
                <button
                  onClick={() => setSidebarOpen(true)}
                  className="p-2 rounded-lg hover:bg-slate-100 transition-colors w-full"
                  title="Expandir men√∫"
                >
                  <ChevronRight className="h-5 w-5 text-slate-600 mx-auto" />
                </button>
              </>
            )}
          </div>

          {/* Navigation */}
          <nav className="flex-1 px-3 space-y-1">
            {navItems.map((item) => (
              <NavLink key={item.page} item={item} collapsed={!sidebarOpen} />
            ))}
          </nav>

          {/* Footer */}
          <div className="p-4 border-t border-slate-100">
            <Button
              variant="ghost"
              onClick={() => base44.auth.logout()}
              className={`w-full text-red-600 hover:text-red-700 hover:bg-red-50 ${sidebarOpen ? 'justify-start' : 'justify-center p-2'}`}
              title="Cerrar Sesi√≥n"
            >
              <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              {sidebarOpen && <span className="ml-2">Cerrar Sesi√≥n</span>}
            </Button>
            {sidebarOpen && (
              <p className="text-xs text-slate-400 text-center mt-2">
                Sistema de Acopio v1.0
              </p>
            )}
          </div>
        </div>
      </aside>

      {/* Mobile Header */}
      <header className="lg:hidden sticky top-0 z-40 bg-white border-b border-slate-200">
        <div className="flex items-center justify-between px-4 py-3">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 rounded-lg flex items-center justify-center overflow-hidden">
              <img 
                src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/694c069ad9a3c71a10fee653/2db155312_imagenesdeperfilISO_Mesadetrabajo1.jpg"
                alt="Logo Acopio"
                className="w-full h-full object-contain"
              />
            </div>
            <span className="font-bold text-slate-800">Acopio</span>
          </div>
          
          <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>
            <SheetTrigger asChild>
              <Button variant="ghost" size="icon">
                <Menu className="h-6 w-6" />
              </Button>
            </SheetTrigger>
            <SheetContent side="right" className="w-72 p-0">
              <div className="flex flex-col h-full">
                <div className="flex items-center justify-between p-4 border-b">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 rounded-lg flex items-center justify-center overflow-hidden">
                      <img 
                        src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/694c069ad9a3c71a10fee653/2db155312_imagenesdeperfilISO_Mesadetrabajo1.jpg"
                        alt="Logo Acopio"
                        className="w-full h-full object-contain"
                      />
                    </div>
                    <span className="font-bold text-slate-800">Men√∫</span>
                  </div>
                </div>
                <nav className="flex-1 p-3 space-y-1 overflow-y-auto">
                  {navItems.map((item) => (
                    <NavLink key={item.page} item={item} mobile />
                  ))}
                </nav>
                <div className="p-3 border-t border-slate-200">
                  <Button
                    variant="ghost"
                    onClick={() => base44.auth.logout()}
                    className="w-full justify-start text-red-600 hover:text-red-700 hover:bg-red-50"
                  >
                    <svg className="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Cerrar Sesi√≥n
                  </Button>
                </div>
                </div>
            </SheetContent>
          </Sheet>
        </div>
      </header>

      {/* Main Content */}
      <main className={`transition-all duration-300 ease-in-out ${sidebarOpen ? 'lg:pl-64' : 'lg:pl-20'}`}>
        {children}
      </main>

      {/* Mobile Bottom Navigation */}
      <nav className="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 z-40 safe-area-bottom">
        <div className="flex items-center justify-around py-2 overflow-x-auto">
          {navItems.slice(0, 6).map((item) => {
            const isActive = currentPageName === item.page;
            return (
              <Link
                key={item.page}
                to={createPageUrl(item.page)}
                className={`flex flex-col items-center gap-1 px-3 py-2 rounded-lg transition-colors ${
                  isActive ? 'text-green-600' : 'text-slate-500'
                }`}
              >
                <item.icon className={`h-5 w-5 ${isActive ? 'text-green-600' : 'text-slate-400'}`} />
                <span className="text-[10px] font-medium">{item.name.split(' ')[0]}</span>
              </Link>
            );
          })}
        </div>
      </nav>

      {/* Padding for bottom nav on mobile */}
      <div className="lg:hidden h-16" />
    </div>
  );
}
</file>

<file path="src/lib/app-params.js">
const isNode = typeof window === 'undefined';
const windowObj = isNode ? { localStorage: new Map() } : window;
const storage = windowObj.localStorage;

const toSnakeCase = (str) => {
	return str.replace(/([A-Z])/g, '_$1').toLowerCase();
}

const getAppParamValue = (paramName, { defaultValue = undefined, removeFromUrl = false } = {}) => {
	if (isNode) {
		return defaultValue;
	}
	const storageKey = `base44_${toSnakeCase(paramName)}`;
	const urlParams = new URLSearchParams(window.location.search);
	const searchParam = urlParams.get(paramName);
	if (removeFromUrl) {
		urlParams.delete(paramName);
		const newUrl = `${window.location.pathname}${urlParams.toString() ? `?${urlParams.toString()}` : ""
			}${window.location.hash}`;
		window.history.replaceState({}, document.title, newUrl);
	}
	if (searchParam) {
		storage.setItem(storageKey, searchParam);
		return searchParam;
	}
	if (defaultValue) {
		storage.setItem(storageKey, defaultValue);
		return defaultValue;
	}
	const storedValue = storage.getItem(storageKey);
	if (storedValue) {
		return storedValue;
	}
	return null;
}

const getAppParams = () => {
	if (getAppParamValue("clear_access_token") === 'true') {
		storage.removeItem('base44_access_token');
		storage.removeItem('token');
	}
	return {
		appId: getAppParamValue("app_id", { defaultValue: import.meta.env.VITE_BASE44_APP_ID }),
		token: getAppParamValue("access_token", { removeFromUrl: true }),
		fromUrl: getAppParamValue("from_url", { defaultValue: window.location.href }),
		functionsVersion: getAppParamValue("functions_version", { defaultValue: import.meta.env.VITE_BASE44_FUNCTIONS_VERSION }),
	}
}


export const appParams = {
	...getAppParams()
}
</file>

<file path="src/lib/AuthContext.jsx">
import React, { createContext, useState, useContext, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { appParams } from '@/lib/app-params';
import { createAxiosClient } from '@base44/sdk/dist/utils/axios-client';

const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoadingAuth, setIsLoadingAuth] = useState(true);
  const [isLoadingPublicSettings, setIsLoadingPublicSettings] = useState(true);
  const [authError, setAuthError] = useState(null);
  const [appPublicSettings, setAppPublicSettings] = useState(null); // Contains only { id, public_settings }

  useEffect(() => {
    checkAppState();
  }, []);

  const checkAppState = async () => {
    try {
      setIsLoadingPublicSettings(true);
      setAuthError(null);
      
      // First, check app public settings (with token if available)
      // This will tell us if auth is required, user not registered, etc.
      const appClient = createAxiosClient({
        baseURL: `/api/apps/public`,
        headers: {
          'X-App-Id': appParams.appId
        },
        token: appParams.token, // Include token if available
        interceptResponses: true
      });
      
      try {
        const publicSettings = await appClient.get(`/prod/public-settings/by-id/${appParams.appId}`);
        setAppPublicSettings(publicSettings);
        
        // If we got the app public settings successfully, check if user is authenticated
        if (appParams.token) {
          await checkUserAuth();
        } else {
          setIsLoadingAuth(false);
          setIsAuthenticated(false);
        }
        setIsLoadingPublicSettings(false);
      } catch (appError) {
        console.error('App state check failed:', appError);
        
        // Handle app-level errors
        if (appError.status === 403 && appError.data?.extra_data?.reason) {
          const reason = appError.data.extra_data.reason;
          if (reason === 'auth_required') {
            setAuthError({
              type: 'auth_required',
              message: 'Authentication required'
            });
          } else if (reason === 'user_not_registered') {
            setAuthError({
              type: 'user_not_registered',
              message: 'User not registered for this app'
            });
          } else {
            setAuthError({
              type: reason,
              message: appError.message
            });
          }
        } else {
          setAuthError({
            type: 'unknown',
            message: appError.message || 'Failed to load app'
          });
        }
        setIsLoadingPublicSettings(false);
        setIsLoadingAuth(false);
      }
    } catch (error) {
      console.error('Unexpected error:', error);
      setAuthError({
        type: 'unknown',
        message: error.message || 'An unexpected error occurred'
      });
      setIsLoadingPublicSettings(false);
      setIsLoadingAuth(false);
    }
  };

  const checkUserAuth = async () => {
    try {
      // Now check if the user is authenticated
      setIsLoadingAuth(true);
      const currentUser = await base44.auth.me();
      setUser(currentUser);
      setIsAuthenticated(true);
      setIsLoadingAuth(false);
    } catch (error) {
      console.error('User auth check failed:', error);
      setIsLoadingAuth(false);
      setIsAuthenticated(false);
      
      // If user auth fails, it might be an expired token
      if (error.status === 401 || error.status === 403) {
        setAuthError({
          type: 'auth_required',
          message: 'Authentication required'
        });
      }
    }
  };

  const logout = (shouldRedirect = true) => {
    setUser(null);
    setIsAuthenticated(false);
    
    if (shouldRedirect) {
      // Use the SDK's logout method which handles token cleanup and redirect
      base44.auth.logout(window.location.href);
    } else {
      // Just remove the token without redirect
      base44.auth.logout();
    }
  };

  const navigateToLogin = () => {
    // Use the SDK's redirectToLogin method
    base44.auth.redirectToLogin(window.location.href);
  };

  return (
    <AuthContext.Provider value={{ 
      user, 
      isAuthenticated, 
      isLoadingAuth,
      isLoadingPublicSettings,
      authError,
      appPublicSettings,
      logout,
      navigateToLogin,
      checkAppState
    }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
</file>

<file path="src/lib/NavigationTracker.jsx">
import { useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { useAuth } from './AuthContext';
import { base44 } from '@/api/base44Client';
import { pagesConfig } from '@/pages.config';

export default function NavigationTracker() {
    const location = useLocation();
    const { isAuthenticated } = useAuth();
    const { Pages, mainPage } = pagesConfig;
    const mainPageKey = mainPage ?? Object.keys(Pages)[0];

    // Log user activity when navigating to a page
    useEffect(() => {
        // Extract page name from pathname
        const pathname = location.pathname;
        let pageName;

        if (pathname === '/' || pathname === '') {
            pageName = mainPageKey;
        } else {
            // Remove leading slash and get the first segment
            const pathSegment = pathname.replace(/^\//, '').split('/')[0];

            // Try case-insensitive lookup in Pages config
            const pageKeys = Object.keys(Pages);
            const matchedKey = pageKeys.find(
                key => key.toLowerCase() === pathSegment.toLowerCase()
            );

            pageName = matchedKey || null;
        }

        if (isAuthenticated && pageName) {
            base44.appLogs.logUserInApp(pageName).catch(() => {
                // Silently fail - logging shouldn't break the app
            });
        }
    }, [location, isAuthenticated, Pages, mainPageKey]);

    return null;
}
</file>

<file path="src/lib/PageNotFound.jsx">
import { useLocation } from 'react-router-dom';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';


export default function PageNotFound({}) {
    const location = useLocation();
    const pageName = location.pathname.substring(1);

    const { data: authData, isFetched } = useQuery({
        queryKey: ['user'],
        queryFn: async () => {
            try {
                const user = await base44.auth.me();
                return { user, isAuthenticated: true };
            } catch (error) {
                return { user: null, isAuthenticated: false };
            }
        }
    });
    
    return (
        <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50">
            <div className="max-w-md w-full">
                <div className="text-center space-y-6">
                    {/* 404 Error Code */}
                    <div className="space-y-2">
                        <h1 className="text-7xl font-light text-slate-300">404</h1>
                        <div className="h-0.5 w-16 bg-slate-200 mx-auto"></div>
                    </div>
                    
                    {/* Main Message */}
                    <div className="space-y-3">
                        <h2 className="text-2xl font-medium text-slate-800">
                            Page Not Found
                        </h2>
                        <p className="text-slate-600 leading-relaxed">
                            The page <span className="font-medium text-slate-700">"{pageName}"</span> could not be found in this application.
                        </p>
                    </div>
                    
                    {/* Admin Note */}
                    {isFetched && authData.isAuthenticated && authData.user?.role === 'admin' && (
                        <div className="mt-8 p-4 bg-slate-100 rounded-lg border border-slate-200">
                            <div className="flex items-start space-x-3">
                                <div className="flex-shrink-0 w-5 h-5 rounded-full bg-orange-100 flex items-center justify-center mt-0.5">
                                    <div className="w-2 h-2 rounded-full bg-orange-400"></div>
                                </div>
                                <div className="text-left space-y-1">
                                    <p className="text-sm font-medium text-slate-700">Admin Note</p>
                                    <p className="text-sm text-slate-600 leading-relaxed">
                                        This could mean that the AI hasn't implemented this page yet. Ask it to implement it in the chat.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Action Button */}
                    <div className="pt-6">
                        <button 
                            onClick={() => window.location.href = '/'} 
                            className="inline-flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500"
                        >
                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                            Go Home
                        </button>
                    </div>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="src/lib/query-client.js">
import { QueryClient } from '@tanstack/react-query';


export const queryClientInstance = new QueryClient({
	defaultOptions: {
		queries: {
			refetchOnWindowFocus: false,
			retry: 1,
		},
	},
});
</file>

<file path="src/lib/utils.js">
import { clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs) {
  return twMerge(clsx(inputs))
} 


export const isIframe = window.self !== window.top;

/** Escapa caracteres especiales de regex para usar en b√∫squedas Base44 ($regex). */
export function escapeRegex(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</file>

<file path="src/main.jsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from '@/App.jsx'
import '@/index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <App />
)
</file>

<file path="src/pages.config.js">
/**
 * pages.config.js - Page routing configuration
 * 
 * This file is AUTO-GENERATED. Do not add imports or modify PAGES manually.
 * Pages are auto-registered when you create files in the ./pages/ folder.
 * 
 * THE ONLY EDITABLE VALUE: mainPage
 * This controls which page is the landing page (shown when users visit the app).
 * 
 * Example file structure:
 * 
 *   import HomePage from './pages/HomePage';
 *   import Dashboard from './pages/Dashboard';
 *   import Settings from './pages/Settings';
 *   
 *   export const PAGES = {
 *       "HomePage": HomePage,
 *       "Dashboard": Dashboard,
 *       "Settings": Settings,
 *   }
 *   
 *   export const pagesConfig = {
 *       mainPage: "HomePage",
 *       Pages: PAGES,
 *   };
 * 
 * Example with Layout (wraps all pages):
 *
 *   import Home from './pages/Home';
 *   import Settings from './pages/Settings';
 *   import __Layout from './Layout.jsx';
 *
 *   export const PAGES = {
 *       "Home": Home,
 *       "Settings": Settings,
 *   }
 *
 *   export const pagesConfig = {
 *       mainPage: "Home",
 *       Pages: PAGES,
 *       Layout: __Layout,
 *   };
 *
 * To change the main page from HomePage to Dashboard, use find_replace:
 *   Old: mainPage: "HomePage",
 *   New: mainPage: "Dashboard",
 *
 * The mainPage value must match a key in the PAGES object exactly.
 */
import Bancos from './pages/Bancos';
import Cajas from './pages/Cajas';
import Cheques from './pages/Cheques';
import Cobros from './pages/Cobros';
import ConfiguracionUnificada from './pages/ConfiguracionUnificada';
import ConfirmarSalida from './pages/ConfirmarSalida';
import CuentaCorriente from './pages/CuentaCorriente';
import Egresos from './pages/Egresos';
import Empleados from './pages/Empleados';
import Historial from './pages/Historial';
import Home from './pages/Home';
import Informes from './pages/Informes';
import InformesContables from './pages/InformesContables';
import IngresoFruta from './pages/IngresoFruta';
import IngresosVarios from './pages/IngresosVarios';
import Inventario from './pages/Inventario';
import MovimientoEnvases from './pages/MovimientoEnvases';
import MovimientoFruta from './pages/MovimientoFruta';
import MovimientosTesoreria from './pages/MovimientosTesoreria';
import Pagos from './pages/Pagos';
import Perdidas from './pages/Perdidas';
import SaldosEnvases from './pages/SaldosEnvases';
import SalidaFruta from './pages/SalidaFruta';
import Tesoreria from './pages/Tesoreria';


export const PAGES = {
    "Bancos": Bancos,
    "Cajas": Cajas,
    "Cheques": Cheques,
    "Cobros": Cobros,
    "ConfiguracionUnificada": ConfiguracionUnificada,
    "ConfirmarSalida": ConfirmarSalida,
    "CuentaCorriente": CuentaCorriente,
    "Egresos": Egresos,
    "Empleados": Empleados,
    "Historial": Historial,
    "Home": Home,
    "Informes": Informes,
    "InformesContables": InformesContables,
    "IngresoFruta": IngresoFruta,
    "IngresosVarios": IngresosVarios,
    "Inventario": Inventario,
    "MovimientoEnvases": MovimientoEnvases,
    "MovimientoFruta": MovimientoFruta,
    "MovimientosTesoreria": MovimientosTesoreria,
    "Pagos": Pagos,
    "Perdidas": Perdidas,
    "SaldosEnvases": SaldosEnvases,
    "SalidaFruta": SalidaFruta,
    "Tesoreria": Tesoreria,
}

export const pagesConfig = {
    mainPage: "IngresoFruta",
    Pages: PAGES,
    Layout: null,
};
</file>

<file path="src/pages/Bancos.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Banknote, Plus, Pencil, Trash2, Loader2, DollarSign, CreditCard, AlertTriangle } from 'lucide-react';
import { toast } from 'sonner';

export default function Bancos() {
  const queryClient = useQueryClient();
  const [modalOpen, setModalOpen] = useState(false);
  const [editingBanco, setEditingBanco] = useState(null);
  const [formData, setFormData] = useState({
    nombre: '',
    numero_cuenta: '',
    tipo_cuenta: 'Cuenta Corriente',
    saldo: 0,
    saldo_minimo: 0,
    activa: true
  });

  const { data: bancos = [], isLoading } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Banco.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      toast.success('Banco creado exitosamente');
      closeModal();
    },
    onError: () => toast.error('Error al crear banco')
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Banco.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      toast.success('Banco actualizado exitosamente');
      closeModal();
    },
    onError: () => toast.error('Error al actualizar banco')
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Banco.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      toast.success('Banco eliminado exitosamente');
    },
    onError: () => toast.error('Error al eliminar banco')
  });

  const openModal = (banco = null) => {
    if (banco) {
      setEditingBanco(banco);
      setFormData({
        nombre: banco.nombre,
        numero_cuenta: banco.numero_cuenta,
        tipo_cuenta: banco.tipo_cuenta || 'Cuenta Corriente',
        saldo: banco.saldo || 0,
        saldo_minimo: banco.saldo_minimo || 0,
        activa: banco.activa !== false
      });
    } else {
      setEditingBanco(null);
      setFormData({
        nombre: '',
        numero_cuenta: '',
        tipo_cuenta: 'Cuenta Corriente',
        saldo: 0,
        saldo_minimo: 0,
        activa: true
      });
    }
    setModalOpen(true);
  };

  const closeModal = () => {
    setModalOpen(false);
    setEditingBanco(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingBanco) {
      updateMutation.mutate({ id: editingBanco.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const handleDelete = (id) => {
    if (confirm('¬øEst√° seguro de eliminar este banco?')) {
      deleteMutation.mutate(id);
    }
  };

  const totalSaldo = bancos.reduce((sum, b) => sum + (b.saldo || 0), 0);
  const bancosActivos = bancos.filter(b => b.activa !== false);
  const bancosConAlerta = bancos.filter(b => (b.saldo || 0) < (b.saldo_minimo || 0));

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <Banknote className="h-8 w-8 text-indigo-600" />
              Gesti√≥n de Bancos
            </h1>
            <p className="text-slate-500 mt-1">Administra las cuentas bancarias de la empresa</p>
          </div>
          <Button onClick={() => openModal()} className="bg-indigo-600 hover:bg-indigo-700">
            <Plus className="h-4 w-4 mr-2" />
            Nueva Cuenta
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total en Bancos</p>
                  <p className="text-2xl font-bold text-green-600">
                    ${totalSaldo.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <DollarSign className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Cuentas Activas</p>
                  <p className="text-2xl font-bold text-indigo-600">{bancosActivos.length}</p>
                </div>
                <Banknote className="h-10 w-10 text-indigo-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Cuentas</p>
                  <p className="text-2xl font-bold text-slate-600">{bancos.length}</p>
                </div>
                <CreditCard className="h-10 w-10 text-slate-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card className={bancosConAlerta.length > 0 ? 'border-amber-300 bg-amber-50' : ''}>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Con Alerta</p>
                  <p className={`text-2xl font-bold ${bancosConAlerta.length > 0 ? 'text-amber-600' : 'text-slate-600'}`}>
                    {bancosConAlerta.length}
                  </p>
                </div>
                <AlertTriangle className={`h-10 w-10 opacity-20 ${bancosConAlerta.length > 0 ? 'text-amber-600' : 'text-slate-600'}`} />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Bancos */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-indigo-600" />
          </div>
        ) : bancos.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <Banknote className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay cuentas bancarias registradas</p>
              <Button onClick={() => openModal()} variant="outline" className="mt-4">
                <Plus className="h-4 w-4 mr-2" />
                Crear Primera Cuenta
              </Button>
            </CardContent>
          </Card>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {bancos.map(banco => {
              const saldoBajoMinimo = (banco.saldo || 0) < (banco.saldo_minimo || 0);
              return (
                <Card key={banco.id} className={`${!banco.activa ? 'opacity-60' : ''} ${saldoBajoMinimo ? 'border-amber-300' : ''}`}>
                  <CardHeader>
                    <CardTitle className="flex items-center justify-between">
                      <span className="flex items-center gap-2">
                        <Banknote className="h-5 w-5 text-indigo-600" />
                        {banco.nombre}
                      </span>
                      <div className="flex gap-2">
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => openModal(banco)}
                          className="h-8 w-8"
                        >
                          <Pencil className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => handleDelete(banco.id)}
                          className="h-8 w-8 text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-3">
                      <div>
                        <p className="text-xs text-slate-500">Tipo de Cuenta</p>
                        <p className="text-sm font-medium text-slate-700">{banco.tipo_cuenta}</p>
                      </div>
                      <div>
                        <p className="text-xs text-slate-500">N√∫mero de Cuenta</p>
                        <p className="text-sm font-medium text-slate-700">{banco.numero_cuenta}</p>
                      </div>
                      <div className="pt-3 border-t">
                        <p className="text-sm text-slate-500">Saldo Actual</p>
                        <p className={`text-xl font-bold ${(banco.saldo || 0) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          ${(banco.saldo || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                        </p>
                      </div>
                      {saldoBajoMinimo && (
                        <div className="bg-amber-50 border border-amber-200 rounded-md p-2">
                          <div className="flex items-center gap-2">
                            <AlertTriangle className="h-4 w-4 text-amber-600" />
                            <p className="text-xs text-amber-700">
                              Saldo por debajo del m√≠nimo (${(banco.saldo_minimo || 0).toLocaleString('es-AR')})
                            </p>
                          </div>
                        </div>
                      )}
                      {!banco.activa && (
                        <div className="bg-red-50 border border-red-200 rounded-md p-2 text-center">
                          <p className="text-xs text-red-600 font-medium">INACTIVA</p>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        )}

        {/* Modal */}
        <Dialog open={modalOpen} onOpenChange={setModalOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>
                {editingBanco ? 'Editar Cuenta Bancaria' : 'Nueva Cuenta Bancaria'}
              </DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit}>
              <div className="space-y-4 py-4">
                <div>
                  <Label>Nombre del Banco *</Label>
                  <Input
                    value={formData.nombre}
                    onChange={(e) => setFormData({ ...formData, nombre: e.target.value })}
                    placeholder="Ej: Banco Naci√≥n"
                    required
                  />
                </div>
                <div>
                  <Label>N√∫mero de Cuenta *</Label>
                  <Input
                    value={formData.numero_cuenta}
                    onChange={(e) => setFormData({ ...formData, numero_cuenta: e.target.value })}
                    placeholder="Ej: 1234567890"
                    required
                  />
                </div>
                <div>
                  <Label>Tipo de Cuenta *</Label>
                  <select
                    value={formData.tipo_cuenta}
                    onChange={(e) => setFormData({ ...formData, tipo_cuenta: e.target.value })}
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                  >
                    <option value="Cuenta Corriente">Cuenta Corriente</option>
                    <option value="Caja de Ahorro">Caja de Ahorro</option>
                  </select>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Saldo Inicial</Label>
                    <Input
                      type="number"
                      step="0.01"
                      value={formData.saldo}
                      onChange={(e) => setFormData({ ...formData, saldo: parseFloat(e.target.value) || 0 })}
                    />
                  </div>
                  <div>
                    <Label>Saldo M√≠nimo</Label>
                    <Input
                      type="number"
                      step="0.01"
                      value={formData.saldo_minimo}
                      onChange={(e) => setFormData({ ...formData, saldo_minimo: parseFloat(e.target.value) || 0 })}
                    />
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="activa"
                    checked={formData.activa}
                    onChange={(e) => setFormData({ ...formData, activa: e.target.checked })}
                    className="h-4 w-4"
                  />
                  <Label htmlFor="activa" className="cursor-pointer">Cuenta Activa</Label>
                </div>
              </div>
              <DialogFooter>
                <Button type="button" variant="outline" onClick={closeModal}>
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={createMutation.isPending || updateMutation.isPending}
                  className="bg-indigo-600 hover:bg-indigo-700"
                >
                  {(createMutation.isPending || updateMutation.isPending) && (
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  )}
                  {editingBanco ? 'Actualizar' : 'Crear'}
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Cajas.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Landmark, Plus, Pencil, Trash2, Loader2, DollarSign, MapPin, User } from 'lucide-react';
import { toast } from 'sonner';

export default function Cajas() {
  const queryClient = useQueryClient();
  const [modalOpen, setModalOpen] = useState(false);
  const [editingCaja, setEditingCaja] = useState(null);
  const [formData, setFormData] = useState({
    nombre: '',
    ubicacion: '',
    saldo: 0,
    responsable: '',
    activa: true
  });

  const { data: cajas = [], isLoading } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Caja.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      toast.success('Caja creada exitosamente');
      closeModal();
    },
    onError: () => toast.error('Error al crear caja')
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Caja.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      toast.success('Caja actualizada exitosamente');
      closeModal();
    },
    onError: () => toast.error('Error al actualizar caja')
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Caja.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      toast.success('Caja eliminada exitosamente');
    },
    onError: () => toast.error('Error al eliminar caja')
  });

  const openModal = (caja = null) => {
    if (caja) {
      setEditingCaja(caja);
      setFormData({
        nombre: caja.nombre,
        ubicacion: caja.ubicacion || '',
        saldo: caja.saldo || 0,
        responsable: caja.responsable || '',
        activa: caja.activa !== false
      });
    } else {
      setEditingCaja(null);
      setFormData({
        nombre: '',
        ubicacion: '',
        saldo: 0,
        responsable: '',
        activa: true
      });
    }
    setModalOpen(true);
  };

  const closeModal = () => {
    setModalOpen(false);
    setEditingCaja(null);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (editingCaja) {
      updateMutation.mutate({ id: editingCaja.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const handleDelete = (id) => {
    if (confirm('¬øEst√° seguro de eliminar esta caja?')) {
      deleteMutation.mutate(id);
    }
  };

  const totalSaldo = cajas.reduce((sum, c) => sum + (c.saldo || 0), 0);
  const cajasActivas = cajas.filter(c => c.activa !== false);

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <Landmark className="h-8 w-8 text-blue-600" />
              Gesti√≥n de Cajas
            </h1>
            <p className="text-slate-500 mt-1">Administra las cajas de efectivo</p>
          </div>
          <Button onClick={() => openModal()} className="bg-blue-600 hover:bg-blue-700">
            <Plus className="h-4 w-4 mr-2" />
            Nueva Caja
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total en Cajas</p>
                  <p className="text-2xl font-bold text-green-600">
                    ${totalSaldo.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <DollarSign className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Cajas Activas</p>
                  <p className="text-2xl font-bold text-blue-600">{cajasActivas.length}</p>
                </div>
                <Landmark className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Cajas</p>
                  <p className="text-2xl font-bold text-slate-600">{cajas.length}</p>
                </div>
                <Landmark className="h-10 w-10 text-slate-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Cajas */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
          </div>
        ) : cajas.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <Landmark className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay cajas registradas</p>
              <Button onClick={() => openModal()} variant="outline" className="mt-4">
                <Plus className="h-4 w-4 mr-2" />
                Crear Primera Caja
              </Button>
            </CardContent>
          </Card>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {cajas.map(caja => (
              <Card key={caja.id} className={!caja.activa ? 'opacity-60' : ''}>
                <CardHeader>
                  <CardTitle className="flex items-center justify-between">
                    <span className="flex items-center gap-2">
                      <Landmark className="h-5 w-5 text-blue-600" />
                      {caja.nombre}
                    </span>
                    <div className="flex gap-2">
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => openModal(caja)}
                        className="h-8 w-8"
                      >
                        <Pencil className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => handleDelete(caja.id)}
                        className="h-8 w-8 text-red-600 hover:text-red-700"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center gap-2 text-sm text-slate-600">
                      <MapPin className="h-4 w-4" />
                      <span>{caja.ubicacion || 'Sin ubicaci√≥n'}</span>
                    </div>
                    <div className="flex items-center gap-2 text-sm text-slate-600">
                      <User className="h-4 w-4" />
                      <span>{caja.responsable || 'Sin responsable'}</span>
                    </div>
                    <div className="pt-3 border-t">
                      <p className="text-sm text-slate-500">Saldo Actual</p>
                      <p className={`text-xl font-bold ${(caja.saldo || 0) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        ${(caja.saldo || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                      </p>
                    </div>
                    {!caja.activa && (
                      <div className="bg-red-50 border border-red-200 rounded-md p-2 text-center">
                        <p className="text-xs text-red-600 font-medium">INACTIVA</p>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}

        {/* Modal */}
        <Dialog open={modalOpen} onOpenChange={setModalOpen}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>
                {editingCaja ? 'Editar Caja' : 'Nueva Caja'}
              </DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit}>
              <div className="space-y-4 py-4">
                <div>
                  <Label>Nombre *</Label>
                  <Input
                    value={formData.nombre}
                    onChange={(e) => setFormData({ ...formData, nombre: e.target.value })}
                    placeholder="Ej: Caja Principal"
                    required
                  />
                </div>
                <div>
                  <Label>Ubicaci√≥n</Label>
                  <Input
                    value={formData.ubicacion}
                    onChange={(e) => setFormData({ ...formData, ubicacion: e.target.value })}
                    placeholder="Ej: Oficina Central"
                  />
                </div>
                <div>
                  <Label>Responsable</Label>
                  <Input
                    value={formData.responsable}
                    onChange={(e) => setFormData({ ...formData, responsable: e.target.value })}
                    placeholder="Nombre del responsable"
                  />
                </div>
                <div>
                  <Label>Saldo Inicial</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={formData.saldo}
                    onChange={(e) => setFormData({ ...formData, saldo: parseFloat(e.target.value) || 0 })}
                  />
                </div>
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    id="activa"
                    checked={formData.activa}
                    onChange={(e) => setFormData({ ...formData, activa: e.target.checked })}
                    className="h-4 w-4"
                  />
                  <Label htmlFor="activa" className="cursor-pointer">Caja Activa</Label>
                </div>
              </div>
              <DialogFooter>
                <Button type="button" variant="outline" onClick={closeModal}>
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={createMutation.isPending || updateMutation.isPending}
                  className="bg-blue-600 hover:bg-blue-700"
                >
                  {(createMutation.isPending || updateMutation.isPending) && (
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  )}
                  {editingCaja ? 'Actualizar' : 'Crear'}
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Cheques.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import SearchableSelect from '@/components/SearchableSelect';
import { CreditCard, Plus, FileText, Loader2, Calendar, DollarSign, Building } from 'lucide-react';
import { toast } from 'sonner';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import CambiarEstadoChequeModal from '@/components/tesoreria/CambiarEstadoChequeModal';

export default function Cheques() {
  const queryClient = useQueryClient();
  const [modalOpen, setModalOpen] = useState(false);
  const [estadoModalOpen, setEstadoModalOpen] = useState(false);
  const [chequeSeleccionado, setChequeSeleccionado] = useState(null);
  const [filtros, setFiltros] = useState({
    estado: 'Todos',
    tipo: 'Todos'
  });
  const [formData, setFormData] = useState({
    numero_cheque: '',
    tipo: 'Terceros',
    banco_id: '',
    cuit_emisor: '',
    fecha_emision: format(new Date(), 'yyyy-MM-dd'),
    fecha_pago: format(new Date(), 'yyyy-MM-dd'),
    monto: 0,
    emisor: '',
    beneficiario: '',
    titular: '',
    notas: ''
  });

  const { data: cheques = [], isLoading } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_pago'),
  });

  const { data: bancosSistema = [] } = useQuery({
    queryKey: ['bancossistema'],
    queryFn: () => base44.entities.BancoSistema.list(),
  });

  const { data: bancosPropios = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Cheque.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cheques'] });
      toast.success('Cheque registrado exitosamente');
      closeModal();
    },
    onError: () => toast.error('Error al registrar cheque')
  });

  const openModal = () => {
    setFormData({
      numero_cheque: '',
      tipo: 'Terceros',
      banco_id: '',
      cuit_emisor: '',
      fecha_emision: format(new Date(), 'yyyy-MM-dd'),
      fecha_pago: format(new Date(), 'yyyy-MM-dd'),
      monto: 0,
      emisor: '',
      beneficiario: '',
      titular: '',
      notas: ''
    });
    setModalOpen(true);
  };

  const closeModal = () => {
    setModalOpen(false);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    const bancoNombre = formData.tipo === 'Propio' 
      ? bancosPropios.find(b => b.id === formData.banco_id)?.nombre 
      : bancosSistema.find(b => b.id === formData.banco_id)?.nombre;

    createMutation.mutate({
      ...formData,
      banco_nombre: bancoNombre,
      estado: 'En Cartera',
      fecha_emision: new Date(formData.fecha_emision).toISOString(),
      fecha_pago: new Date(formData.fecha_pago).toISOString()
    });
  };

  const abrirCambioEstado = (cheque) => {
    setChequeSeleccionado(cheque);
    setEstadoModalOpen(true);
  };

  const chequesFiltrados = cheques.filter(ch => {
    if (filtros.estado !== 'Todos' && ch.estado !== filtros.estado) return false;
    if (filtros.tipo !== 'Todos' && ch.tipo !== filtros.tipo) return false;
    return true;
  });

  const estadoBadgeColor = (estado) => {
    switch (estado) {
      case 'En Cartera': return 'bg-blue-100 text-blue-800';
      case 'Depositado': return 'bg-green-100 text-green-800';
      case 'Endosado': return 'bg-purple-100 text-purple-800';
      case 'Entregado': return 'bg-orange-100 text-orange-800';
      case 'Rechazado': return 'bg-red-100 text-red-800';
      default: return 'bg-slate-100 text-slate-800';
    }
  };

  const totalEnCartera = cheques.filter(ch => ch.estado === 'En Cartera').reduce((sum, ch) => sum + (ch.monto || 0), 0);
  const chequesProxVencer = cheques.filter(ch => {
    const diasRestantes = Math.floor((new Date(ch.fecha_pago) - new Date()) / (1000 * 60 * 60 * 24));
    return ch.estado === 'En Cartera' && diasRestantes <= 7 && diasRestantes >= 0;
  }).length;

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <CreditCard className="h-8 w-8 text-purple-600" />
              Gesti√≥n de Cheques
            </h1>
            <p className="text-slate-500 mt-1">Administra cheques propios y de terceros</p>
          </div>
          <Button onClick={openModal} className="bg-purple-600 hover:bg-purple-700">
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Cheque
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">En Cartera</p>
                  <p className="text-2xl font-bold text-blue-600">
                    ${totalEnCartera.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <DollarSign className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Cheques</p>
                  <p className="text-2xl font-bold text-purple-600">{cheques.length}</p>
                </div>
                <CreditCard className="h-10 w-10 text-purple-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Pr√≥x. a Vencer</p>
                  <p className="text-2xl font-bold text-orange-600">{chequesProxVencer}</p>
                </div>
                <Calendar className="h-10 w-10 text-orange-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">De Terceros</p>
                  <p className="text-2xl font-bold text-slate-600">
                    {cheques.filter(ch => ch.tipo === 'Terceros').length}
                  </p>
                </div>
                <FileText className="h-10 w-10 text-slate-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card className="mb-6">
          <CardContent className="p-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label>Estado</Label>
                <select
                  value={filtros.estado}
                  onChange={(e) => setFiltros({ ...filtros, estado: e.target.value })}
                  className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                >
                  <option value="Todos">Todos los estados</option>
                  <option value="En Cartera">En Cartera</option>
                  <option value="Depositado">Depositado</option>
                  <option value="Endosado">Endosado</option>
                  <option value="Entregado">Entregado</option>
                  <option value="Rechazado">Rechazado</option>
                </select>
              </div>
              <div>
                <Label>Tipo</Label>
                <select
                  value={filtros.tipo}
                  onChange={(e) => setFiltros({ ...filtros, tipo: e.target.value })}
                  className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                >
                  <option value="Todos">Todos los tipos</option>
                  <option value="Propio">Propios</option>
                  <option value="Terceros">De Terceros</option>
                </select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Lista de Cheques */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-purple-600" />
          </div>
        ) : chequesFiltrados.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <CreditCard className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay cheques registrados</p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-3">
            {chequesFiltrados.map(cheque => (
              <Card key={cheque.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between">
                    <div className="flex-1 space-y-3">
                      <div className="flex items-center gap-3">
                        <CreditCard className="h-5 w-5 text-purple-600" />
                        <span className="font-bold text-lg">Cheque N¬∞ {cheque.numero_cheque}</span>
                        <Badge className={estadoBadgeColor(cheque.estado)}>
                          {cheque.estado}
                        </Badge>
                        <Badge variant="outline">
                          {cheque.tipo}
                        </Badge>
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                          <p className="text-slate-500">Banco</p>
                          <p className="font-medium flex items-center gap-1">
                            <Building className="h-4 w-4" />
                            {cheque.banco_nombre}
                          </p>
                        </div>
                        <div>
                          <p className="text-slate-500">Emisor</p>
                          <p className="font-medium">{cheque.emisor || '-'}</p>
                        </div>
                        <div>
                          <p className="text-slate-500">Fecha Emisi√≥n</p>
                          <p className="font-medium">
                            {cheque.fecha_emision ? format(new Date(cheque.fecha_emision), 'dd/MM/yyyy', { locale: es }) : '-'}
                          </p>
                        </div>
                        <div>
                          <p className="text-slate-500">Fecha Pago</p>
                          <p className="font-medium">
                            {cheque.fecha_pago ? format(new Date(cheque.fecha_pago), 'dd/MM/yyyy', { locale: es }) : '-'}
                          </p>
                        </div>
                      </div>

                      {cheque.notas && (
                        <div className="bg-slate-50 rounded-md p-3 text-sm">
                          <p className="text-slate-600">{cheque.notas}</p>
                        </div>
                      )}
                    </div>

                    <div className="text-right ml-6">
                      <p className="text-sm text-slate-500 mb-1">Monto</p>
                      <p className="text-2xl font-bold text-green-600">
                        ${(cheque.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                      </p>
                      <Button
                        onClick={() => abrirCambioEstado(cheque)}
                        variant="outline"
                        size="sm"
                        className="mt-3"
                      >
                        Cambiar Estado
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}

        {/* Modal Crear Cheque */}
        <Dialog open={modalOpen} onOpenChange={setModalOpen}>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle>Registrar Nuevo Cheque</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit}>
              <div className="space-y-4 py-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Tipo *</Label>
                    <select
                      value={formData.tipo}
                      onChange={(e) => setFormData({ ...formData, tipo: e.target.value, banco_id: '' })}
                      className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                      <option value="Terceros">De Terceros</option>
                      <option value="Propio">Propio</option>
                    </select>
                  </div>
                  <div>
                    <Label>N√∫mero de Cheque *</Label>
                    <Input
                      value={formData.numero_cheque}
                      onChange={(e) => setFormData({ ...formData, numero_cheque: e.target.value })}
                      placeholder="N√∫mero"
                      required
                    />
                  </div>
                </div>

                <div>
                  <Label>Banco *</Label>
                  <SearchableSelect
                    options={formData.tipo === 'Propio' ? bancosPropios : bancosSistema}
                    value={formData.banco_id}
                    onChange={(id) => setFormData({ ...formData, banco_id: id })}
                    displayKey="nombre"
                    placeholder="Seleccionar banco..."
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>CUIT Emisor</Label>
                    <Input
                      value={formData.cuit_emisor}
                      onChange={(e) => setFormData({ ...formData, cuit_emisor: e.target.value })}
                      placeholder="XX-XXXXXXXX-X"
                    />
                  </div>
                  <div>
                    <Label>Titular</Label>
                    <Input
                      value={formData.titular}
                      onChange={(e) => setFormData({ ...formData, titular: e.target.value })}
                      placeholder="Titular de la cuenta"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Emisor *</Label>
                    <Input
                      value={formData.emisor}
                      onChange={(e) => setFormData({ ...formData, emisor: e.target.value })}
                      placeholder="Quien emite"
                      required
                    />
                  </div>
                  <div>
                    <Label>Beneficiario</Label>
                    <Input
                      value={formData.beneficiario}
                      onChange={(e) => setFormData({ ...formData, beneficiario: e.target.value })}
                      placeholder="A la orden de"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div>
                    <Label>Fecha Emisi√≥n *</Label>
                    <Input
                      type="date"
                      value={formData.fecha_emision}
                      onChange={(e) => setFormData({ ...formData, fecha_emision: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label>Fecha Pago *</Label>
                    <Input
                      type="date"
                      value={formData.fecha_pago}
                      onChange={(e) => setFormData({ ...formData, fecha_pago: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label>Monto *</Label>
                    <Input
                      type="number"
                      step="0.01"
                      value={formData.monto}
                      onChange={(e) => setFormData({ ...formData, monto: parseFloat(e.target.value) || 0 })}
                      required
                    />
                  </div>
                </div>

                <div>
                  <Label>Notas</Label>
                  <textarea
                    value={formData.notas}
                    onChange={(e) => setFormData({ ...formData, notas: e.target.value })}
                    className="flex w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm min-h-20"
                    placeholder="Notas adicionales..."
                  />
                </div>
              </div>
              <DialogFooter>
                <Button type="button" variant="outline" onClick={closeModal}>
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={createMutation.isPending}
                  className="bg-purple-600 hover:bg-purple-700"
                >
                  {createMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                  Registrar Cheque
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>

        {/* Modal Cambiar Estado */}
        <CambiarEstadoChequeModal
          open={estadoModalOpen && chequeSeleccionado !== null}
          cheque={chequeSeleccionado || {}}
          bancos={bancosPropios}
          onClose={() => {
            setEstadoModalOpen(false);
            setChequeSeleccionado(null);
          }}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Cobros.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient, useInfiniteQuery } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Receipt, Plus, Loader2, Calendar, Users, DollarSign, FileText, Trash2, Search, ChevronLeft, ChevronRight } from 'lucide-react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { toast } from 'sonner';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import CobroConSalidasModal from '@/components/tesoreria/CobroConSalidasModal';
import { escapeRegex } from '@/lib/utils';
import { invalidarTodoElSistema } from '@/utils/queryHelpers';
import { recalcularSaldosEntidad, actualizarSaldoEntidad } from '@/utils/contabilidad';

export default function Cobros() {
  const queryClient = useQueryClient();
  const [modalCobroOpen, setModalCobroOpen] = useState(false);
  const [deleteDialog, setDeleteDialog] = useState({ open: false, cobro: null });
  const [filtroCliente, setFiltroCliente] = useState('');
  const [paginaActual, setPaginaActual] = useState(1);
  const registrosPorPagina = 20;

  const PAGE_SIZE = 20;

  const queryCobros = React.useMemo(() => {
    const trimmed = filtroCliente?.trim();
    if (!trimmed) return {};
    return { cliente_nombre: { $regex: escapeRegex(trimmed), $options: 'i' } };
  }, [filtroCliente]);

  const {
    data: cobrosData,
    fetchNextPage: fetchMoreCobros,
    hasNextPage: hasMoreCobros,
    isFetchingNextPage: loadingMoreCobros,
    isLoading
  } = useInfiniteQuery({
    queryKey: ['cobros-infinite', filtroCliente],
    queryFn: ({ pageParam = 0 }) => {
      if (Object.keys(queryCobros).length === 0) {
        return base44.entities.Cobro.list('-fecha', PAGE_SIZE, pageParam);
      }
      return base44.entities.Cobro.filter(queryCobros, '-fecha', PAGE_SIZE, pageParam);
    },
    getNextPageParam: (lastPage, allPages) =>
      (lastPage?.length ?? 0) === PAGE_SIZE ? allPages.length * PAGE_SIZE : undefined,
    initialPageParam: 0,
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const cobros = React.useMemo(() => cobrosData?.pages?.flat() ?? [], [cobrosData]);

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list('nombre', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list('nombre', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cheques = [] } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_pago', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancosSistema = [] } = useQuery({
    queryKey: ['bancossistema'],
    queryFn: () => base44.entities.BancoSistema.list('nombre', 50),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria'],
    queryFn: () => base44.entities.MovimientoTesoreria.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const deleteCobroMutation = useMutation({
    mutationFn: async (cobro) => {
      // Buscar TODOS los MovimientoTesoreria vinculados a este cobro
      const movimientosVinculados = movimientosTesoreria.filter(m => 
        m.referencia_origen_id === cobro.id && m.referencia_origen_tipo === 'Cobro'
      );

      // Revertir saldos de todos los medios de cobro
      for (const mov of movimientosVinculados) {
        if (mov.destino_id && mov.destino_tipo) {
          if (mov.destino_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === mov.destino_id);
            if (caja) {
              await base44.entities.Caja.update(mov.destino_id, {
                saldo: (caja.saldo || 0) - mov.monto
              });
            }
          } else if (mov.destino_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === mov.destino_id);
            if (banco) {
              await base44.entities.Banco.update(mov.destino_id, {
                saldo: (banco.saldo || 0) - mov.monto
              });
            }
          }
        }
      }

      // Revertir estados de salidas aplicadas
      if (cobro.salidas_aplicadas && cobro.salidas_aplicadas.length > 0) {
        for (const aplicado of cobro.salidas_aplicadas) {
          const salida = salidas.find(s => s.id === aplicado.salida_id);
          if (salida) {
            const nuevoMontoCobrado = (salida.monto_cobrado || 0) - aplicado.monto_aplicado;
            let nuevoEstado = 'Pendiente';
            if (nuevoMontoCobrado >= (salida.deuda_total || 0)) {
              nuevoEstado = 'Cobrado';
            } else if (nuevoMontoCobrado > 0) {
              nuevoEstado = 'Pago Parcial';
            }
            await base44.entities.SalidaFruta.update(aplicado.salida_id, {
              monto_cobrado: nuevoMontoCobrado,
              estado_cobro: nuevoEstado
            });
          }
        }
      }

      // Eliminar movimientos de cuenta corriente relacionados (revertir saldo_actual antes)
      const movimientosCC = await base44.entities.CuentaCorriente.list();
      const movsCCCobro = movimientosCC.filter(m => 
        m.comprobante_id === cobro.id && (m.comprobante_tipo === 'Cobro' || m.comprobante_tipo === 'Retencion')
      );
      for (const movCC of movsCCCobro) {
        await actualizarSaldoEntidad(base44, 'Cliente', cobro.cliente_id, movCC.monto || 0);
        await base44.entities.CuentaCorriente.delete(movCC.id);
      }

      // Eliminar IngresoVario del Estado de Resultados si existe
      const ingresosVarios = await base44.entities.IngresoVario.list();
      const ingresosRelacionados = ingresosVarios.filter(iv => 
        iv.notas && iv.notas.includes(`ID: ${cobro.id}`)
      );
      for (const ingreso of ingresosRelacionados) {
        await base44.entities.IngresoVario.delete(ingreso.id);
      }

      // Eliminar todos los movimientos de tesorer√≠a vinculados
      for (const mov of movimientosVinculados) {
        await base44.entities.MovimientoTesoreria.delete(mov.id);
      }

      // Eliminar el cobro
      await base44.entities.Cobro.delete(cobro.id);
      
      // Recalcular saldos de cuenta corriente del cliente usando funci√≥n centralizada
      if (cobro.cliente_id) {
        await recalcularSaldosEntidad(base44, cobro.cliente_id, 'Cliente');
      }
      
      return cobro;
    },
    onSuccess: () => {
      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);
      
      toast.success('Cobro eliminado completamente');
      setDeleteDialog({ open: false, cobro: null });
    },
    onError: (error) => {
      console.error('Error al eliminar cobro:', error);
      toast.error('Error al eliminar el cobro');
    }
  });

  const guardarCobroMutation = useMutation({
    mutationFn: async (cobroData) => {
      // 1. Crear el cobro
      const cobro = await base44.entities.Cobro.create(cobroData);

      // 1.5. Registrar en IngresoVario para Estado de Resultados
      if (cobroData.cuenta_contable_id) {
        await base44.entities.IngresoVario.create({
          fecha: cobroData.fecha,
          tipo: 'Ingreso',
          cuenta_id: cobroData.cuenta_contable_id,
          cuenta_codigo: cobroData.cuenta_contable_codigo || '',
          cuenta_nombre: cobroData.cuenta_contable_nombre,
          concepto: cobroData.concepto || `Cobro de ${cobroData.cliente_nombre}`,
          monto: cobroData.monto_total,
          forma_ingreso: 'Transferencia',
          destino_tipo: 'Banco',
          destino_id: '',
          destino_nombre: '',
          cliente_id: cobroData.cliente_id,
          cliente_nombre: cobroData.cliente_nombre,
          comprobante: cobroData.comprobante || '',
          notas: `Cobro registrado autom√°ticamente desde tesorer√≠a - ID: ${cobro.id}`
        });
      }

      // 2. Actualizar saldos de destino seg√∫n medios de cobro
      for (const medio of cobroData.medios_cobro_detalles) {
        if (medio.destino_tipo === 'Caja') {
          const caja = cajas.find(c => c.id === medio.destino_id);
          if (caja) {
            await base44.entities.Caja.update(medio.destino_id, {
              saldo: (caja.saldo || 0) + medio.monto
            });
          }
        } else if (medio.destino_tipo === 'Banco') {
          const banco = bancos.find(b => b.id === medio.destino_id);
          if (banco) {
            await base44.entities.Banco.update(medio.destino_id, {
              saldo: (banco.saldo || 0) + medio.monto
            });
          }
        }

        // Crear movimiento de tesorer√≠a
        await base44.entities.MovimientoTesoreria.create({
          fecha: cobroData.fecha,
          tipo_movimiento: 'Ingreso Manual',
          destino_tipo: medio.destino_tipo,
          destino_id: medio.destino_id,
          destino_nombre: medio.destino_nombre,
          monto: medio.monto,
          concepto: `Cobro de ${cobroData.cliente_nombre} - ${cobroData.concepto}`,
          comprobante: cobroData.comprobante,
          referencia_origen_id: cobro.id,
          referencia_origen_tipo: 'Cobro'
        });

        // Si es cheque de terceros, actualizar el estado
        if (medio.tipo === 'Cheque' && medio.cheque_id) {
          await base44.entities.Cheque.update(medio.cheque_id, {
            estado: 'En Cartera',
            origen_movimiento_id: cobro.id,
            origen_movimiento_tipo: 'Cobro'
          });
        }
      }

      // 3. Actualizar salidas aplicadas y crear movimientos en cuenta corriente
      if (cobroData.tipo_cobro === 'Aplicado' && cobroData.salidas_aplicadas) {
        for (const aplicado of cobroData.salidas_aplicadas) {
          const salida = salidas.find(s => s.id === aplicado.salida_id);
          if (salida) {
            const nuevoMontoCobrado = (salida.monto_cobrado || 0) + aplicado.monto_aplicado;
            const deudaTotal = salida.deuda_total || 0;
            
            let nuevoEstado = 'Pendiente';
            if (nuevoMontoCobrado >= deudaTotal) {
              nuevoEstado = 'Cobrado';
            } else if (nuevoMontoCobrado > 0) {
              nuevoEstado = 'Pago Parcial';
            }

            await base44.entities.SalidaFruta.update(aplicado.salida_id, {
              monto_cobrado: nuevoMontoCobrado,
              estado_cobro: nuevoEstado
            });

            // Crear movimiento en cuenta corriente (Debe = disminuye deuda del cliente)
            await base44.entities.CuentaCorriente.create({
              fecha: cobroData.fecha,
              tipo_movimiento: 'Debe',
              entidad_tipo: 'Cliente',
              entidad_id: cobroData.cliente_id,
              entidad_nombre: cobroData.cliente_nombre,
              monto: aplicado.monto_aplicado,
              saldo_resultante: 0,
              concepto: `Cobro aplicado a salida ${salida.numero_remito}`,
              comprobante_id: cobro.id,
              comprobante_tipo: 'Cobro'
            });
            await actualizarSaldoEntidad(base44, 'Cliente', cobroData.cliente_id, -aplicado.monto_aplicado);
          }
        }

        // Recalcular saldos resultantes en filas de CC
        await recalcularSaldosEntidad(base44, cobroData.cliente_id, 'Cliente');
      } else if (cobroData.tipo_cobro === 'A Cuenta') {
        // Crear movimiento en cuenta corriente para cobro a cuenta
        await base44.entities.CuentaCorriente.create({
          fecha: cobroData.fecha,
          tipo_movimiento: 'Debe',
          entidad_tipo: 'Cliente',
          entidad_id: cobroData.cliente_id,
          entidad_nombre: cobroData.cliente_nombre,
          monto: cobroData.monto_total,
          saldo_resultante: 0,
          concepto: `Cobro a cuenta - ${cobroData.concepto}`,
          comprobante_id: cobro.id,
          comprobante_tipo: 'Cobro'
        });
        await actualizarSaldoEntidad(base44, 'Cliente', cobroData.cliente_id, -cobroData.monto_total);

        // Recalcular saldos resultantes en filas de CC
        await recalcularSaldosEntidad(base44, cobroData.cliente_id, 'Cliente');
      }

      // 4. Procesar retenciones si existen
      if (cobroData.retenciones && cobroData.retenciones.length > 0) {
        for (const retencion of cobroData.retenciones) {
          // Crear movimiento en cuenta corriente por retenci√≥n
          await base44.entities.CuentaCorriente.create({
            fecha: cobroData.fecha,
            tipo_movimiento: 'Debe',
            entidad_tipo: 'Cliente',
            entidad_id: cobroData.cliente_id,
            entidad_nombre: cobroData.cliente_nombre,
            monto: retencion.monto,
            saldo_resultante: 0,
            concepto: `Retenci√≥n: ${retencion.tipo_retencion}`,
            comprobante_id: cobro.id,
            comprobante_tipo: 'Retencion'
          });
          await actualizarSaldoEntidad(base44, 'Cliente', cobroData.cliente_id, -retencion.monto);
        }

        // Recalcular saldos resultantes en filas de CC
        await recalcularSaldosEntidad(base44, cobroData.cliente_id, 'Cliente');
      }

      return cobro;
    },
    onSuccess: async (cobro) => {
      // Recalcular saldos de cuenta corriente del cliente (ya se hizo en mutationFn, pero por seguridad)
      if (cobro.cliente_id) {
        await recalcularSaldosEntidad(base44, cobro.cliente_id, 'Cliente');
      }
      
      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);
      
      toast.success('Cobro registrado exitosamente');
      setModalCobroOpen(false);
    },
    onError: (error) => {
      console.error('Error al guardar cobro:', error);
      toast.error('Error al registrar el cobro');
    }
  });

  // Filtrar cobros que tienen movimientos de tesorer√≠a vinculados y por nombre de cliente
  const cobrosValidos = cobros.filter(cobro => {
    const tieneMovimientos = movimientosTesoreria.some(m => 
      m.referencia_origen_id === cobro.id && m.referencia_origen_tipo === 'Cobro'
    );
    const cumpleFiltro = !filtroCliente || 
      (cobro.cliente_nombre && cobro.cliente_nombre.toLowerCase().includes(filtroCliente.toLowerCase()));
    return tieneMovimientos && cumpleFiltro;
  });

  const totalCobros = cobrosValidos.reduce((sum, c) => sum + (c.monto_total || 0), 0);
  const cobrosAplicados = cobrosValidos.filter(c => c.tipo_cobro === 'Aplicado').length;
  const cobrosACuenta = cobrosValidos.filter(c => c.tipo_cobro === 'A Cuenta').length;

  // Paginaci√≥n
  const totalPaginas = Math.ceil(cobrosValidos.length / registrosPorPagina);
  const cobrosPaginados = cobrosValidos.slice(
    (paginaActual - 1) * registrosPorPagina,
    paginaActual * registrosPorPagina
  );

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <Receipt className="h-8 w-8 text-purple-600" />
              Cobros a Clientes
            </h1>
            <p className="text-slate-500 mt-1">Registra y gestiona cobros</p>
          </div>
          <Button onClick={() => setModalCobroOpen(true)} className="bg-purple-600 hover:bg-purple-700">
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Cobro
          </Button>
        </div>

        {/* Filtro */}
        <div className="mb-6">
          <div className="relative max-w-md">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400" />
            <Input
              type="text"
              placeholder="Buscar por nombre de cliente..."
              value={filtroCliente}
              onChange={(e) => setFiltroCliente(e.target.value)}
              className="pl-10"
            />
          </div>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Cobrado</p>
                  <p className="text-2xl font-bold text-purple-600">
                    ${totalCobros.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <DollarSign className="h-10 w-10 text-purple-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Cobros</p>
                  <p className="text-2xl font-bold text-slate-600">{cobrosValidos.length}</p>
                </div>
                <FileText className="h-10 w-10 text-slate-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Cobros Aplicados</p>
                  <p className="text-2xl font-bold text-green-600">{cobrosAplicados}</p>
                </div>
                <FileText className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">A Cuenta</p>
                  <p className="text-2xl font-bold text-blue-600">{cobrosACuenta}</p>
                </div>
                <FileText className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Cobros */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-purple-600" />
          </div>
        ) : cobrosValidos.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <Receipt className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay cobros registrados</p>
            </CardContent>
          </Card>
        ) : (
          <>
            <div className="space-y-2">
              {cobrosPaginados.map(cobro => (
                <Card key={cobro.id} className="hover:shadow-sm transition-shadow border-l-4 border-l-purple-500">
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4 flex-1">
                        <div className="text-sm text-slate-500 min-w-[90px]">
                          {cobro.fecha ? format(new Date(cobro.fecha), "dd/MM/yyyy", { locale: es }) : '-'}
                        </div>
                        
                        <Badge variant="outline" className={cobro.tipo_cobro === 'Aplicado' ? 'text-green-700 border-green-300' : 'text-blue-700 border-blue-300'}>
                          {cobro.tipo_cobro}
                        </Badge>

                        <div className="flex-1">
                          <div className="font-semibold text-slate-900">{cobro.cliente_nombre}</div>
                          <div className="text-sm text-slate-600">{cobro.concepto}</div>
                        </div>
                      </div>

                      <div className="flex items-center gap-4">
                        <div className="text-right">
                          <div className="text-xl font-bold text-purple-600">
                            ${(cobro.monto_total || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                          </div>
                          {cobro.tipo_cobro === 'A Cuenta' && cobro.monto_disponible > 0 && (
                            <div className="text-xs text-blue-600">
                              Disp: ${cobro.monto_disponible.toLocaleString('es-AR')}
                            </div>
                          )}
                        </div>
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => setDeleteDialog({ open: true, cobro })}
                          className="text-red-600 hover:text-red-700 hover:bg-red-50"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>

            {hasMoreCobros && (
              <div className="flex justify-center mt-4">
                <Button
                  variant="outline"
                  onClick={() => fetchMoreCobros()}
                  disabled={loadingMoreCobros}
                >
                  {loadingMoreCobros ? 'Cargando...' : 'Cargar m√°s cobros'}
                </Button>
              </div>
            )}

            {totalPaginas > 1 && (
              <div className="flex items-center justify-between mt-6">
                <p className="text-sm text-slate-600">
                  Mostrando {((paginaActual - 1) * registrosPorPagina) + 1} - {Math.min(paginaActual * registrosPorPagina, cobrosValidos.length)} de {cobrosValidos.length} cobros
                </p>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPaginaActual(p => Math.max(1, p - 1))}
                    disabled={paginaActual === 1}
                  >
                    <ChevronLeft className="h-4 w-4 mr-1" />
                    Anterior
                  </Button>
                  <div className="flex items-center gap-1">
                    {Array.from({ length: Math.min(5, totalPaginas) }, (_, i) => {
                      let pageNum;
                      if (totalPaginas <= 5) {
                        pageNum = i + 1;
                      } else if (paginaActual <= 3) {
                        pageNum = i + 1;
                      } else if (paginaActual >= totalPaginas - 2) {
                        pageNum = totalPaginas - 4 + i;
                      } else {
                        pageNum = paginaActual - 2 + i;
                      }
                      return (
                        <Button
                          key={pageNum}
                          variant={paginaActual === pageNum ? "default" : "outline"}
                          size="sm"
                          onClick={() => setPaginaActual(pageNum)}
                          className="w-8 h-8 p-0"
                        >
                          {pageNum}
                        </Button>
                      );
                    })}
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPaginaActual(p => Math.min(totalPaginas, p + 1))}
                    disabled={paginaActual >= totalPaginas}
                  >
                    Siguiente
                    <ChevronRight className="h-4 w-4 ml-1" />
                  </Button>
                </div>
              </div>
            )}
          </>
        )}

        {/* Alert Dialog para eliminar */}
        <AlertDialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open, cobro: deleteDialog.cobro })}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>¬øEliminar este cobro?</AlertDialogTitle>
              <AlertDialogDescription className="space-y-2">
                <p>Esta acci√≥n eliminar√° el cobro y revertir√° todos los cambios asociados:</p>
                {deleteDialog.cobro && (
                  <div className="bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                    <p className="font-semibold text-amber-900 mb-2">Cliente: {deleteDialog.cobro.cliente_nombre}</p>
                    <p className="text-slate-700">Concepto: {deleteDialog.cobro.concepto}</p>
                    <p className="text-slate-700">Monto: <strong>${(deleteDialog.cobro.monto_total || 0).toLocaleString('es-AR')}</strong></p>
                    <p className="text-slate-700 mt-2">Se revertir√°n saldos de cajas/bancos, estados de salidas y cuenta corriente.</p>
                  </div>
                )}
                <p className="text-xs text-slate-500 mt-2">Esta acci√≥n no se puede deshacer.</p>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel disabled={deleteCobroMutation.isPending}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={() => deleteDialog.cobro && deleteCobroMutation.mutate(deleteDialog.cobro)}
                disabled={deleteCobroMutation.isPending}
                className="bg-red-600 hover:bg-red-700"
              >
                {deleteCobroMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Eliminando...
                  </>
                ) : (
                  'S√≠, Eliminar Cobro'
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Modal Nuevo Cobro */}
        <CobroConSalidasModal
          open={modalCobroOpen}
          onClose={() => setModalCobroOpen(false)}
          onSave={(cobroData) => guardarCobroMutation.mutate(cobroData)}
          isLoading={guardarCobroMutation.isPending}
          clientes={[]}
          salidas={salidas}
          cajas={cajas}
          bancos={bancos}
          cheques={cheques}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/pages/ConfiguracionUnificada.jsx">
import React, { useState, useMemo } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient, useInfiniteQuery } from '@tanstack/react-query';
import { Settings, BookOpen, DollarSign, Database, Users, Shield, Wrench, Lock } from "lucide-react";
import { toast } from "sonner";
import { Loader2 } from "lucide-react";
import { escapeRegex } from '@/lib/utils';
import { parseCSVLine } from '@/utils/parseCSV';
import { extraerMensajeError } from '@/utils/extraerMensajeError';
import { ejecutarCorreccionManual } from '@/utils/ejecutarCorreccionManual';
import { sincronizarSaldosEntidades } from '@/utils/contabilidad';

// Componentes de contenido
import ABMContent from '@/components/configuracion/ABMContent';
import PlanCuentasContent from '@/components/configuracion/PlanCuentasContent';
import PreciosContent from '@/components/configuracion/PreciosContent';
import MantenimientoContent from '@/components/configuracion/MantenimientoContent';
import SeguridadContent from '@/components/configuracion/SeguridadContent';
import CategoriasEmpleadoContent from '@/components/configuracion/CategoriasEmpleadoContent';
import ImportesConfigContent from '@/components/configuracion/ImportesConfigContent';
import UsuariosContent from '@/components/configuracion/UsuariosContent';
import PermisosContent from '@/components/configuracion/PermisosContent';

// Modales
import ABMModal from '@/components/configuracion/modals/ABMModal';
import CuentaModal from '@/components/configuracion/modals/CuentaModal';
import PrecioModal from '@/components/configuracion/modals/PrecioModal';
import ImporteModal from '@/components/configuracion/modals/ImporteModal';
import EmpleadoModal from '@/components/configuracion/modals/EmpleadoModal';
import PermisosModal from '@/components/configuracion/modals/PermisosModal';
import DeleteConfirmModal from '@/components/configuracion/modals/DeleteConfirmModal';
import CategoriaEmpleadoModal from '@/components/configuracion/modals/CategoriaEmpleadoModal';
import ImportModal from '@/components/configuracion/modals/ImportModal';
import InvitarUsuarioModal from '@/components/configuracion/modals/InvitarUsuarioModal';
import ImportBancosModal from '@/components/configuracion/modals/ImportBancosModal';

export default function ConfiguracionUnificada() {
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState('abm');
  const [currentUser, setCurrentUser] = useState(null);
  const [loading, setLoading] = useState(true);

  // Estados para PIN
  const [pinActual, setPinActual] = useState('');
  const [nuevoPin, setNuevoPin] = useState('');
  const [confirmarPin, setConfirmarPin] = useState('');

  // Estados para ABM (paginaci√≥n y b√∫squeda en servidor)
  const [editModal, setEditModal] = useState({ open: false, type: null, item: null });
  const [deleteConfirm, setDeleteConfirm] = useState({ open: false, type: null, item: null });
  const [abmSubTab, setAbmSubTab] = useState('proveedores');
  const [abmSearchTerm, setAbmSearchTerm] = useState('');
  const ABM_PAGE_SIZE = 20;

  const abmEntityConfig = useMemo(() => ({
    proveedores: { entity: 'Proveedor', order: 'nombre', searchField: 'nombre', displayKey: 'nombre' },
    clientes: { entity: 'Cliente', order: 'nombre', searchField: 'nombre', displayKey: 'nombre' },
    envases: { entity: 'Envase', order: 'tipo', searchField: 'tipo', displayKey: 'tipo' },
    productos: { entity: 'Producto', order: 'fruta', searchField: 'fruta', displayKey: 'nombre' },
    fleteros: { entity: 'Fletero', order: 'nombre', searchField: 'nombre', displayKey: 'nombre' },
    bancos: { entity: 'BancoSistema', order: 'nombre', searchField: 'nombre', displayKey: 'nombre' }
  }), []);

  const {
    data: abmDataRaw,
    fetchNextPage: fetchMoreAbm,
    hasNextPage: hasMoreAbm,
    isFetchingNextPage: loadingMoreAbm,
    isLoading: loadingAbm
  } = useInfiniteQuery({
    queryKey: ['abm', abmSubTab, abmSearchTerm],
    queryFn: async ({ pageParam = 0 }) => {
      const config = abmEntityConfig[abmSubTab];
      if (!config) return [];
      const trimmed = abmSearchTerm.trim();
      const query = trimmed
        ? { [config.searchField]: { $regex: escapeRegex(trimmed), $options: 'i' } }
        : {};
      const raw = await base44.entities[config.entity].filter(query, config.order, ABM_PAGE_SIZE, pageParam);
      const list = Array.isArray(raw) ? raw : [];
      if (abmSubTab === 'productos') {
        return list.map(p => ({ ...p, nombre: `${p.fruta || ''} - ${p.variedad || ''}`.replace(/^ - | - $/g, '').trim() }));
      }
      return list;
    },
    getNextPageParam: (lastPage, allPages) =>
      (lastPage?.length ?? 0) === ABM_PAGE_SIZE ? allPages.length * ABM_PAGE_SIZE : undefined,
    initialPageParam: 0,
    enabled: activeTab === 'abm',
    staleTime: 2 * 60 * 1000
  });

  const abmData = useMemo(() => abmDataRaw?.pages?.flat() ?? [], [abmDataRaw]);

  React.useEffect(() => {
    setAbmSearchTerm('');
  }, [abmSubTab]);

  // Estados para Plan de Cuentas
  const [cuentaModal, setCuentaModal] = useState({ open: false, item: null });
  const [importModal, setImportModal] = useState(false);

  // Estados para Per√≠odos de Precio
  const [precioModal, setPrecioModal] = useState({ open: false, item: null });

  // Estados para Empleados
  const [empleadoModal, setEmpleadoModal] = useState({ open: false, item: null });
  const [permisosModal, setPermisosModal] = useState({ open: false, item: null });
  const [invitarUsuarioModal, setInvitarUsuarioModal] = useState(false);
  const [emailInvitar, setEmailInvitar] = useState('');
  const [rolInvitar, setRolInvitar] = useState('user');

  const [categoriaModal, setCategoriaModal] = useState({ open: false, item: null });
  const [importeModal, setImporteModal] = useState({ open: false, item: null });
  const [importBancosModal, setImportBancosModal] = useState(false);
  const [ejecutandoCorreccion, setEjecutandoCorreccion] = useState(null);
  const [progresoSincronizacion, setProgresoSincronizacion] = useState('');

  // Cargar usuario actual
  React.useEffect(() => {
    const checkUser = async () => {
      try {
        const user = await base44.auth.me();
        setCurrentUser(user);
      } catch (error) {
        console.error('Error al obtener usuario:', error);
      } finally {
        setLoading(false);
      }
    };
    checkUser();
  }, []);

  // Queries
  const { data: configuraciones = [] } = useQuery({
    queryKey: ['configuraciones'],
    queryFn: () => base44.entities.Configuracion.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: envases = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list('tipo', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list('fruta', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: fleteros = [] } = useQuery({
    queryKey: ['fleteros'],
    queryFn: () => base44.entities.Fletero.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cuentas = [] } = useQuery({
    queryKey: ['plancuentas'],
    queryFn: () => base44.entities.PlanDeCuentas.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios'],
    queryFn: () => base44.entities.PeriodoPrecio.list('-fecha_desde'),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: empleados = [] } = useQuery({
    queryKey: ['empleados'],
    queryFn: () => base44.entities.Empleado.list('nombre'),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: categoriasEmpleado = [] } = useQuery({
    queryKey: ['categoriasempleado'],
    queryFn: () => base44.entities.CategoriaEmpleado.list('nombre'),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancosSistema = [] } = useQuery({
    queryKey: ['bancossistema'],
    queryFn: () => base44.entities.BancoSistema.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: importesConfig = [] } = useQuery({
    queryKey: ['importesconfig'],
    queryFn: () => base44.entities.ConfiguracionImportes.list()
  });

  const configuracionPIN = configuraciones.find(c => c.clave === 'pin_seguridad');
  const esAdmin = currentUser?.role === 'admin';

  const { data: usuarios = [] } = useQuery({
    queryKey: ['usuarios'],
    queryFn: () => base44.entities.User.list('-created_date'),
    enabled: esAdmin
  });

  // Mutations para PIN
  const guardarPINMutation = useMutation({
    mutationFn: async ({ pinActual, nuevoPin }) => {
      console.log('=== GUARDANDO PIN ===');
      console.log('PIN Actual ingresado:', pinActual);
      console.log('Nuevo PIN:', nuevoPin);
      
      const pinGuardado = configuracionPIN?.valor || '0000';
      console.log('PIN almacenado en BD:', pinGuardado);
      
      if (pinActual !== pinGuardado) {
        console.error('PIN actual incorrecto');
        throw new Error('PIN actual incorrecto');
      }
      if (nuevoPin.length < 4 || nuevoPin.length > 6) {
        throw new Error('El PIN debe tener entre 4 y 6 d√≠gitos');
      }
      if (!/^\d+$/.test(nuevoPin)) {
        throw new Error('El PIN debe contener solo n√∫meros');
      }
      
      console.log('Validaciones OK, actualizando en BD...');
      
      if (configuracionPIN) {
        await base44.entities.Configuracion.update(configuracionPIN.id, { valor: nuevoPin });
        console.log('PIN actualizado');
      } else {
        await base44.entities.Configuracion.create({
          clave: 'pin_seguridad',
          valor: nuevoPin,
          descripcion: 'PIN de seguridad para ediciones'
        });
        console.log('PIN creado');
      }
    },
    onSuccess: () => {
      console.log('=== PIN GUARDADO EXITOSAMENTE ===');
      queryClient.invalidateQueries(['configuraciones']);
      setPinActual('');
      setNuevoPin('');
      setConfirmarPin('');
      toast.success('‚úÖ PIN modificado exitosamente');
    },
    onError: (error) => {
      console.error('Error al guardar PIN:', error);
      toast.error(error.message || 'Error al actualizar PIN');
    }
  });

  // Mutations para ABM
  const guardarABMMutation = useMutation({
    mutationFn: async ({ type, item, isNew }) => {
      const entityMap = {
        proveedor: 'Proveedor',
        cliente: 'Cliente',
        envase: 'Envase',
        producto: 'Producto',
        fletero: 'Fletero',
        banco: 'BancoSistema'
      };
      const entityName = entityMap[type];
      
      if (type === 'producto' && item.fruta && item.variedad) {
        item.producto_completo = `${item.fruta} - ${item.variedad}`;
      }

      if (isNew) {
        return base44.entities[entityName].create(item);
      } else {
        const { id, ...data } = item;
        return base44.entities[entityName].update(id, data);
      }
    },
    onSuccess: (_, variables) => {
      const queryKey = variables.type === 'proveedor' ? 'proveedores' : 
                       variables.type === 'banco' ? 'bancossistema' : 
                       `${variables.type}s`;
      queryClient.invalidateQueries({ queryKey: [queryKey] });
      queryClient.invalidateQueries({ queryKey: ['abm'] });
      setEditModal({ open: false, type: null, item: null });
      toast.success(`${variables.isNew ? 'Creado' : 'Actualizado'} exitosamente`);
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'guardar');
      toast.error(mensaje);
    }
  });

  const eliminarABMMutation = useMutation({
    mutationFn: async ({ type, id, nombre }) => {
      const entityMap = {
        proveedor: 'Proveedor',
        cliente: 'Cliente',
        envase: 'Envase',
        producto: 'Producto',
        fletero: 'Fletero',
        banco: 'BancoSistema'
      };
      
      // Validar antes de eliminar Clientes o Proveedores
      if (type === 'cliente' || type === 'proveedor') {
        const [movimientos, cuentaCorriente] = await Promise.all([
          base44.entities.Movimiento.list(),
          base44.entities.CuentaCorriente.list()
        ]);
        
        const tieneMovimientos = movimientos.some(m => {
          if (type === 'cliente') {
            return m.cliente_id === id || (m.tipo_movimiento === 'Salida de Fruta' && m.cliente_id === id);
          } else {
            return m.proveedor_id === id || (m.tipo_movimiento === 'Ingreso de Fruta' && m.proveedor_id === id);
          }
        });
        
        const tieneCuentaCorriente = cuentaCorriente.some(cc => {
          const entidadTipo = type === 'cliente' ? 'Cliente' : 'Proveedor';
          return cc.entidad_tipo === entidadTipo && cc.entidad_id === id;
        });
        
        if (tieneMovimientos || tieneCuentaCorriente) {
          throw new Error(`No se puede eliminar: este ${type === 'cliente' ? 'cliente' : 'proveedor'} tiene historial contable`);
        }
      }
      
      return base44.entities[entityMap[type]].delete(id);
    },
    onSuccess: (_, variables) => {
      const queryKey = variables.type === 'proveedor' ? 'proveedores' : 
                       variables.type === 'banco' ? 'bancossistema' : 
                       `${variables.type}s`;
      queryClient.invalidateQueries({ queryKey: [queryKey] });
      queryClient.invalidateQueries({ queryKey: ['abm'] });
      setDeleteConfirm({ open: false, type: null, item: null });
      toast.success('Eliminado exitosamente');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar');
      toast.error(mensaje);
    }
  });

  // Mutations para Plan de Cuentas
  const guardarCuentaMutation = useMutation({
    mutationFn: async (item) => {
      if (item.id) {
        const { id, ...data } = item;
        return base44.entities.PlanDeCuentas.update(id, data);
      }
      return base44.entities.PlanDeCuentas.create(item);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['plancuentas']);
      setCuentaModal({ open: false, item: null });
      toast.success('Cuenta guardada exitosamente');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'guardar cuenta');
      toast.error(mensaje);
    }
  });

  const eliminarCuentaMutation = useMutation({
    mutationFn: (id) => base44.entities.PlanDeCuentas.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['plancuentas']);
      toast.success('Cuenta eliminada');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar cuenta');
      toast.error(mensaje);
    }
  });

  const eliminarCuentasMultipleMutation = useMutation({
    mutationFn: async (ids) => {
      await Promise.all(ids.map(id => base44.entities.PlanDeCuentas.delete(id)));
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['plancuentas']);
      toast.success('Cuentas eliminadas exitosamente');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar cuentas');
      toast.error(mensaje);
    }
  });

  // Mutations para Per√≠odos de Precio
  const guardarPrecioMutation = useMutation({
    mutationFn: async (item) => {
      const producto = productos.find(p => p.id === item.producto_id);
      const itemConNombre = {
        ...item,
        producto_nombre: producto ? `${producto.fruta} - ${producto.variedad}` : ''
      };

      if (item.id) {
        const { id, ...data } = itemConNombre;
        return base44.entities.PeriodoPrecio.update(id, data);
      }
      return base44.entities.PeriodoPrecio.create(itemConNombre);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['periodosprecios']);
      setPrecioModal({ open: false, item: null });
      toast.success('Per√≠odo de precio guardado');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'guardar per√≠odo de precio');
      toast.error(mensaje);
    }
  });

  const eliminarPrecioMutation = useMutation({
    mutationFn: (id) => base44.entities.PeriodoPrecio.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['periodosprecios']);
      toast.success('Per√≠odo eliminado');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar per√≠odo');
      toast.error(mensaje);
    }
  });

  // Mutations para Categor√≠as de Empleado
  const guardarCategoriaMutation = useMutation({
    mutationFn: async (item) => {
      if (item.id) {
        const { id, ...data } = item;
        return base44.entities.CategoriaEmpleado.update(id, data);
      }
      return base44.entities.CategoriaEmpleado.create(item);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['categoriasempleado']);
      setCategoriaModal({ open: false, item: null });
      toast.success('Categor√≠a guardada');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'guardar categor√≠a');
      toast.error(mensaje);
    }
  });

  const eliminarCategoriaMutation = useMutation({
    mutationFn: (id) => base44.entities.CategoriaEmpleado.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['categoriasempleado']);
      toast.success('Categor√≠a eliminada');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar categor√≠a');
      toast.error(mensaje);
    }
  });

  const guardarImporteMutation = useMutation({
    mutationFn: async (item) => {
      if (item.id) {
        const { id, ...data } = item;
        return base44.entities.ConfiguracionImportes.update(id, data);
      }
      return base44.entities.ConfiguracionImportes.create(item);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['importesconfig']);
      setImporteModal({ open: false, item: null });
      toast.success('Importe guardado');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'guardar importe');
      toast.error(mensaje);
    }
  });

  const eliminarImporteMutation = useMutation({
    mutationFn: (id) => base44.entities.ConfiguracionImportes.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['importesconfig']);
      toast.success('Importe eliminado');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar importe');
      toast.error(mensaje);
    }
  });

  // Mutations para Empleados
  const guardarEmpleadoMutation = useMutation({
    mutationFn: async (item) => {
      // Si es nuevo empleado, inicializar permisos con valores por defecto
      if (!item.id && !item.permisos) {
        item.permisos = {
          Home: { acceso: true, ver: true }
        };
      }

      if (item.id) {
        const { id, ...data } = item;
        return base44.entities.Empleado.update(id, data);
      }
      return base44.entities.Empleado.create(item);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['empleados']);
      setEmpleadoModal({ open: false, item: null });
      toast.success('Empleado guardado');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'guardar empleado');
      toast.error(mensaje);
    }
  });

  const eliminarEmpleadoMutation = useMutation({
    mutationFn: (id) => base44.entities.Empleado.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['empleados']);
      toast.success('Empleado eliminado');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'eliminar empleado');
      toast.error(mensaje);
    }
  });

  const guardarPermisosMutation = useMutation({
    mutationFn: async ({ id, permisos }) => {
      return base44.entities.Empleado.update(id, { permisos });
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['empleados']);
      setPermisosModal({ open: false, item: null });
      toast.success('Permisos actualizados');
    },
    onError: (error) => {
      const mensaje = extraerMensajeError(error, 'actualizar permisos');
      toast.error(mensaje);
    }
  });

  const invitarUsuarioMutation = useMutation({
    mutationFn: async ({ email, role }) => {
      return await base44.users.inviteUser(email, role);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['usuarios']);
      setInvitarUsuarioModal(false);
      setEmailInvitar('');
      setRolInvitar('user');
      toast.success('Invitaci√≥n enviada exitosamente al correo electr√≥nico');
    },
    onError: (error) => toast.error(error.message || 'Error al invitar usuario')
  });

  // Handlers para importar Plan de Cuentas
  const handleImportarCSV = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      const text = typeof event.target?.result === 'string' ? event.target.result : '';
      if (!text) {
        toast.error('Error al leer el archivo CSV');
        return;
      }
      const lines = text.split('\n');
      const cuentasImportadas = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const campos = parseCSVLine(line);
        const [codigo, nombre, tipo, categoria, nivel, cuenta_padre, imputable, activa] = campos;
        if (codigo && nombre && tipo) {
          cuentasImportadas.push({
            codigo: codigo.trim(),
            nombre: nombre.trim(),
            tipo: tipo.trim(),
            categoria: categoria?.trim() || '',
            nivel: parseInt(nivel) || 1,
            cuenta_padre: cuenta_padre?.trim() || '',
            imputable: imputable?.trim().toLowerCase() !== 'false',
            activa: activa?.trim().toLowerCase() !== 'false'
          });
        }
      }

      try {
        await base44.entities.PlanDeCuentas.bulkCreate(cuentasImportadas);
        queryClient.invalidateQueries(['plancuentas']);
        toast.success(`${cuentasImportadas.length} cuentas importadas exitosamente`);
        setImportModal(false);
      } catch (error) {
        const mensaje = extraerMensajeError(error, 'importar cuentas');
        toast.error(mensaje);
      }
    };
    reader.readAsText(file);
  };

  // Handler para importar Bancos
  const handleImportarBancosCSV = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      const text = typeof event.target?.result === 'string' ? event.target.result : '';
      if (!text) {
        toast.error('Error al leer el archivo CSV');
        return;
      }
      const lines = text.split('\n');
      const bancosImportados = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const campos = parseCSVLine(line);
        const [nombre, codigo, activo] = campos;
        if (nombre) {
          bancosImportados.push({
            nombre: nombre.trim(),
            codigo: codigo?.trim() || '',
            activo: activo?.trim().toLowerCase() !== 'false'
          });
        }
      }

      try {
        await base44.entities.BancoSistema.bulkCreate(bancosImportados);
        queryClient.invalidateQueries(['bancossistema']);
        toast.success(`${bancosImportados.length} bancos importados exitosamente`);
        setImportBancosModal(false);
      } catch (error) {
        const mensaje = extraerMensajeError(error, 'importar bancos');
        toast.error(mensaje);
      }
    };
    reader.readAsText(file);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
        <div className="max-w-6xl mx-auto text-center py-12">
          <Loader2 className="h-8 w-8 animate-spin mx-auto text-slate-500" />
          <p className="text-slate-600 mt-2">Cargando...</p>
        </div>
      </div>
    );
  }

  const sections = [
    { key: 'abm', label: 'ABM', icon: Database },
    { key: 'plancuentas', label: 'Cuentas', icon: BookOpen },
    { key: 'precios', label: 'Precios', icon: DollarSign },
    { key: 'categorias', label: 'Categor√≠as', icon: Users },
    { key: 'importes', label: 'Importes', icon: DollarSign },
    ...(esAdmin ? [
      { key: 'usuarios', label: 'Usuarios', icon: Users },
      { key: 'permisos', label: 'Permisos', icon: Shield }
    ] : []),
    { key: 'mantenimiento', label: 'Mantenimiento', icon: Wrench },
    { key: 'seguridad', label: 'PIN', icon: Lock }
  ];

  return (
    <div className="min-h-screen bg-slate-50">
      <div className="flex h-screen">
        {/* Sidebar */}
        <aside className="w-64 bg-white border-r border-slate-200 flex flex-col">
          {/* Header */}
          <div className="p-6 border-b border-slate-200">
            <div className="flex items-center gap-2">
              <Settings className="h-6 w-6 text-slate-600 shrink-0" />
              <div>
                <h1 className="text-xl font-bold text-slate-800">Configuraci√≥n</h1>
                <p className="text-sm text-slate-600">Gesti√≥n del sistema</p>
              </div>
            </div>
          </div>

          {/* Navigation */}
          <nav className="flex-1 p-3 overflow-y-auto">
            <div className="space-y-1">
              {sections.map(section => {
                const Icon = section.icon;
                return (
                  <button
                    key={section.key}
                    onClick={() => setActiveTab(section.key)}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${
                      activeTab === section.key
                        ? 'bg-blue-600 text-white shadow-md'
                        : 'text-slate-700 hover:bg-slate-100'
                    }`}
                  >
                    <Icon className="h-5 w-5 shrink-0" />
                    <span className="font-medium">{section.label}</span>
                  </button>
                );
              })}
            </div>
          </nav>
        </aside>

        {/* Main Content */}
        <main className="flex-1 overflow-y-auto">
          <div className="p-6 md:p-8">
            {activeTab === 'abm' && (
              <ABMContent
                subTab={abmSubTab}
                setSubTab={setAbmSubTab}
                searchTerm={abmSearchTerm}
                setSearchTerm={setAbmSearchTerm}
                data={abmData}
                hasMore={hasMoreAbm}
                onLoadMore={() => fetchMoreAbm()}
                isLoading={loadingAbm}
                isFetchingMore={loadingMoreAbm}
                displayKey={abmEntityConfig[abmSubTab]?.displayKey ?? 'nombre'}
                onEdit={(type, item) => setEditModal({ open: true, type, item })}
                onDelete={(type, item) => setDeleteConfirm({ open: true, type, item })}
                onImportarBancos={() => setImportBancosModal(true)}
              />
            )}

            {activeTab === 'plancuentas' && (
              <PlanCuentasContent
                cuentas={cuentas}
                onEdit={(item) => setCuentaModal({ open: true, item })}
                onDelete={(id) => eliminarCuentaMutation.mutate(id)}
                onDeleteMultiple={(ids) => eliminarCuentasMultipleMutation.mutate(ids)}
                onImportar={() => setImportModal(true)}
                esAdmin={esAdmin}
              />
            )}

            {activeTab === 'precios' && (
              <PreciosContent
                periodosPrecios={periodosPrecios}
                onEdit={(item) => setPrecioModal({ open: true, item })}
                onDelete={(id) => eliminarPrecioMutation.mutate(id)}
              />
            )}

            {activeTab === 'categorias' && (
              <CategoriasEmpleadoContent
                categorias={categoriasEmpleado}
                onEdit={(item) => setCategoriaModal({ open: true, item })}
                onDelete={(id) => eliminarCategoriaMutation.mutate(id)}
              />
            )}

            {activeTab === 'importes' && (
              <ImportesConfigContent
                importes={importesConfig}
                onEdit={(item) => setImporteModal({ open: true, item })}
                onDelete={(id) => eliminarImporteMutation.mutate(id)}
              />
            )}

            {activeTab === 'usuarios' && esAdmin && (
              <UsuariosContent
                currentUser={currentUser}
                usuarios={usuarios}
                onInvitar={() => setInvitarUsuarioModal(true)}
              />
            )}

            {activeTab === 'permisos' && esAdmin && (
              <PermisosContent
                empleados={empleados}
                onEditPermisos={(item) => setPermisosModal({ open: true, item })}
              />
            )}

            {activeTab === 'mantenimiento' && (
              <MantenimientoContent
                ejecutandoCorreccion={ejecutandoCorreccion}
                progresoSincronizacion={progresoSincronizacion}
                onEjecutarCorreccion={async (tipo) => {
                  setEjecutandoCorreccion(tipo);
                  setProgresoSincronizacion('');
                  try {
                    if (tipo === 'sincronizarSaldos') {
                      const result = await sincronizarSaldosEntidades(base44, (msg) => setProgresoSincronizacion(msg));
                      queryClient.invalidateQueries({ queryKey: ['proveedores'] });
                      queryClient.invalidateQueries({ queryKey: ['clientes'] });
                      queryClient.invalidateQueries({ queryKey: ['cuentacorriente'] });
                      toast.success(`Sincronizaci√≥n completada: ${result.proveedoresActualizados} proveedores, ${result.clientesActualizados} clientes.`);
                    } else {
                      await ejecutarCorreccionManual(tipo, base44, queryClient);
                      toast.success(`Correcci√≥n "${tipo}" completada exitosamente`);
                    }
                  } catch (error) {
                    console.error(`Error en correcci√≥n ${tipo}:`, error);
                    toast.error(`Error al ejecutar: ${error.message}`);
                  } finally {
                    setEjecutandoCorreccion(null);
                    setProgresoSincronizacion('');
                  }
                }}
              />
            )}

            {activeTab === 'seguridad' && (
              <SeguridadContent
                esAdmin={esAdmin}
                pinActual={pinActual}
                setPinActual={setPinActual}
                nuevoPin={nuevoPin}
                setNuevoPin={setNuevoPin}
                confirmarPin={confirmarPin}
                setConfirmarPin={setConfirmarPin}
                onGuardar={() => {
                  console.log('=== BOT√ìN ACTUALIZAR PIN PRESIONADO ===');
                  console.log('PIN Actual:', pinActual);
                  console.log('Nuevo PIN:', nuevoPin);
                  console.log('Confirmar PIN:', confirmarPin);
                  
                  if (nuevoPin !== confirmarPin) {
                    toast.error('Los PINs no coinciden');
                    return;
                  }
                  
                  console.log('Iniciando mutaci√≥n...');
                  guardarPINMutation.mutate({ pinActual, nuevoPin });
                }}
                isLoading={guardarPINMutation.isPending}
              />
            )}
          </div>
        </main>
      </div>

      {/* Modales */}
      <ABMModal
        modal={editModal}
        onClose={() => setEditModal({ open: false, type: null, item: null })}
        onSave={(data) => guardarABMMutation.mutate(data)}
        isLoading={guardarABMMutation.isPending}
      />

      <DeleteConfirmModal
        modal={deleteConfirm}
        onClose={() => setDeleteConfirm({ open: false, type: null, item: null })}
        onConfirm={() => eliminarABMMutation.mutate({ 
          type: deleteConfirm.type, 
          id: deleteConfirm.item.id,
          nombre: deleteConfirm.item.nombre || deleteConfirm.item.tipo || deleteConfirm.item[deleteConfirm.type === 'envase' ? 'tipo' : 'nombre']
        })}
        isLoading={eliminarABMMutation.isPending}
      />

      <CuentaModal
        modal={cuentaModal}
        onClose={() => setCuentaModal({ open: false, item: null })}
        onSave={(data) => guardarCuentaMutation.mutate(data)}
        isLoading={guardarCuentaMutation.isPending}
        cuentas={cuentas}
      />

      <PrecioModal
        modal={precioModal}
        onClose={() => setPrecioModal({ open: false, item: null })}
        onSave={(data) => guardarPrecioMutation.mutate(data)}
        isLoading={guardarPrecioMutation.isPending}
        productos={productos}
      />

      <ImportModal
        open={importModal}
        onClose={() => setImportModal(false)}
        onImport={handleImportarCSV}
      />

      <EmpleadoModal
        modal={empleadoModal}
        onClose={() => setEmpleadoModal({ open: false, item: null })}
        onSave={(data) => guardarEmpleadoMutation.mutate(data)}
        isLoading={guardarEmpleadoMutation.isPending}
      />

      <PermisosModal
        modal={permisosModal}
        onClose={() => setPermisosModal({ open: false, item: null })}
        onSave={(data) => guardarPermisosMutation.mutate(data)}
        isLoading={guardarPermisosMutation.isPending}
      />

      <CategoriaEmpleadoModal
        modal={categoriaModal}
        onClose={() => setCategoriaModal({ open: false, item: null })}
        onSave={(data) => guardarCategoriaMutation.mutate(data)}
        isLoading={guardarCategoriaMutation.isPending}
      />

      <ImporteModal
        modal={importeModal}
        onClose={() => setImporteModal({ open: false, item: null })}
        onSave={(data) => guardarImporteMutation.mutate(data)}
        isLoading={guardarImporteMutation.isPending}
      />

      <InvitarUsuarioModal
        open={invitarUsuarioModal}
        onClose={() => {
          setInvitarUsuarioModal(false);
          setEmailInvitar('');
          setRolInvitar('user');
        }}
        email={emailInvitar}
        setEmail={setEmailInvitar}
        rol={rolInvitar}
        setRol={setRolInvitar}
        onInvitar={() => invitarUsuarioMutation.mutate({ email: emailInvitar, role: rolInvitar })}
        isLoading={invitarUsuarioMutation.isPending}
      />

      <ImportBancosModal
        open={importBancosModal}
        onClose={() => setImportBancosModal(false)}
        onImport={handleImportarBancosCSV}
      />
    </div>
  );
}
</file>

<file path="src/pages/ConfirmarSalida.jsx">
import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { CheckCircle2, AlertCircle, FileText, Package, Loader2 } from "lucide-react";
import { format } from "date-fns";
import { es } from 'date-fns/locale';
import { toast } from "sonner";
import { generateSalidaPDF, downloadSalidaPDF, shareSalidaWhatsApp } from "@/components/SalidaPDFGenerator";
import { toFixed2, restaExacta } from "../components/utils/precisionDecimal";
import { validarPerdidasNoRetornan } from "../components/utils/correccionRetroactivaPerdidas";
import { actualizarSaldoEntidad } from '@/utils/contabilidad';

export default function ConfirmarSalida({ embedded = false }) {
  const queryClient = useQueryClient();
  const [salidaSeleccionada, setSalidaSeleccionada] = useState(null);
  const [comprobanteCliente, setComprobanteCliente] = useState('');
  const [ajustes, setAjustes] = useState([]);

  const { data: salidas = [], isLoading } = useQuery({
    queryKey: ['salidas-pendientes-confirmacion'],
    queryFn: () =>
      base44.entities.SalidaFruta.filter(
        { estado: 'Pendiente de Confirmaci√≥n' },
        '-created_date',
        100
      ),
    staleTime: 2 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list('nombre', 100),
    staleTime: 10 * 60 * 1000
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list('fruta', 100),
    staleTime: 10 * 60 * 1000
  });

  const salidasPendientes = salidas;

  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios'],
    queryFn: () => base44.entities.PeriodoPrecio.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const confirmarSalidaMutation = useMutation({
    mutationFn: async ({ salida, comprobante, ajustes }) => {
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // OBTENER PRECIO DE VENTA VIGENTE PARA CADA PRODUCTO
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const obtenerPrecioVigente = (productoId, fecha) => {
        const preciosOrdenados = periodosPrecios
          .filter(pp => pp.producto_id === productoId && pp.activo)
          .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
        
        const fechaSalida = new Date(fecha);
        const precioVigente = preciosOrdenados.find(pp => {
          const desde = new Date(pp.fecha_desde);
          const hasta = pp.fecha_hasta ? new Date(pp.fecha_hasta) : new Date('2099-12-31');
          return fechaSalida >= desde && fechaSalida <= hasta;
        });
        
        return precioVigente?.precio_venta_kg || 0;
      };

      // Calcular deuda total con precios vigentes
      let deudaTotal = 0;
      const detallesActualizados = salida.detalles.map((d, index) => {
        const ajuste = ajustes[index];
        const kilosEfectivos = (ajuste.kilos_reales || d.kilos_salida) - (ajuste.descuento_kg || 0);
        
        // OBTENER PRECIO VIGENTE DEL PERIODO
        const precioVigente = obtenerPrecioVigente(d.producto_id, salida.fecha);
        const deuda = kilosEfectivos * precioVigente;
        deudaTotal += deuda;
        
        console.log(`üí∞ ${d.producto_nombre}: ${kilosEfectivos.toFixed(2)} kg √ó $${precioVigente.toFixed(2)}/kg = $${deuda.toFixed(2)}`);
        
        return {
          ...d,
          kilos_reales: ajuste.kilos_reales || d.kilos_salida,
          descuento_kg: ajuste.descuento_kg || 0,
          motivo_ajuste: ajuste.motivo_ajuste || '',
          precio_kg: precioVigente // GUARDAR EL PRECIO VIGENTE
        };
      });

      // Actualizar salida
      const salidaActualizada = await base44.entities.SalidaFruta.update(salida.id, {
        estado: 'Confirmada',
        estado_cobro: 'Pendiente',
        monto_cobrado: 0,
        comprobante_cliente: comprobante,
        detalles: detallesActualizados,
        deuda_total: deudaTotal
      });

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CREAR MOVIMIENTO EN CUENTA CORRIENTE DEL CLIENTE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      if (salida.cliente_id && deudaTotal > 0) {
        // Verificar si ya existe un movimiento de CC para esta salida
        const movimientosCC = await base44.entities.CuentaCorriente.filter({
          comprobante_tipo: 'SalidaFruta',
          comprobante_id: salida.id
        });

        if (movimientosCC.length === 0) {
          // Obtener el √∫ltimo saldo del cliente para calcular saldo resultante
          const ultimosMovs = await base44.entities.CuentaCorriente.filter(
            { entidad_id: salida.cliente_id, entidad_tipo: 'Cliente' },
            '-fecha',
            1
          );
          
          const saldoAnterior = ultimosMovs.length > 0 ? (ultimosMovs[0].saldo_resultante || 0) : 0;
          const nuevoSaldo = saldoAnterior + deudaTotal;

          await base44.entities.CuentaCorriente.create({
            fecha: salida.fecha,
            tipo_movimiento: 'Haber',
            entidad_tipo: 'Cliente',
            entidad_id: salida.cliente_id,
            entidad_nombre: salida.cliente_nombre,
            monto: deudaTotal,
            saldo_resultante: nuevoSaldo,
            concepto: `Salida de fruta - ${salida.numero_remito}`,
            comprobante_id: salida.id,
            comprobante_tipo: 'SalidaFruta'
          });
          await actualizarSaldoEntidad(base44, 'Cliente', salida.cliente_id, deudaTotal);

          console.log(`‚úÖ Cuenta Corriente actualizada: ${salida.cliente_nombre} - $${deudaTotal.toFixed(2)}`);
        } else {
          // Ya existe, actualizar el monto si cambi√≥
          if (movimientosCC[0].monto !== deudaTotal) {
            const diferencia = deudaTotal - movimientosCC[0].monto;
            await base44.entities.CuentaCorriente.update(movimientosCC[0].id, {
              monto: deudaTotal,
              saldo_resultante: (movimientosCC[0].saldo_resultante || 0) + diferencia
            });
            await actualizarSaldoEntidad(base44, 'Cliente', salida.cliente_id, diferencia);
            console.log(`‚úÖ Cuenta Corriente actualizada (reconfirmaci√≥n): ${salida.cliente_nombre} - $${deudaTotal.toFixed(2)}`);
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CORRECCI√ìN ABSOLUTA: P√âRDIDAS IRREVERSIBLES - NUNCA VUELVEN AL STOCK
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // 
      // L√ìGICA INQUEBRANTABLE RETROACTIVA:
      // 1. Al crear la salida en SalidaFruta.jsx: Stock fue RESTADO por kilos_salida originales
      // 2. En confirmaci√≥n (AQU√ç): Las p√©rdidas son DEFINITIVAS, NO se revierten
      // 3. Stock NO se modifica en confirmaci√≥n - todo lo que sali√≥ YA est√° fuera permanentemente
      // 4. RETROACTIVAMENTE: Correcci√≥n elimina sumas err√≥neas de p√©rdidas en registros viejos
      //
      // FLUJO DE P√âRDIDAS:
      // - Kilos Salida Original (ej: 2637.00 kg) ‚Üí YA RESTADOS DEL STOCK en SalidaFruta
      // - Kilos Reales Recibidos (ej: 2632.00 kg) ‚Üí lo que lleg√≥ al cliente
      // - P√âRDIDA B√ÅSCULA = Originales - Reales (ej: 2637.00 - 2632.00 = 5.00 kg)
      // - P√âRDIDA CALIDAD = Descuento en Kilos (ej: 78.96 kg por clasificaci√≥n/calidad)
      // - P√âRDIDA TOTAL = B√°scula + Calidad (ej: 5.00 + 78.96 = 83.96 kg DEFINITIVOS)
      // - Kilos Efectivos a Cobrar = Reales - Descuento (ej: 2632.00 - 78.96 = 2553.04 kg)
      //
      // VALIDACI√ìN Y REGISTRO DE P√âRDIDAS (sin impacto en stock):
      
      let perdidaTotalGlobal = 0;
      
      for (let i = 0; i < salida.detalles.length; i++) {
        const detalle = salida.detalles[i];
        const ajuste = ajustes[i];
        
        if (detalle.producto_id) {
          const kilosOriginales = detalle.kilos_salida;
          const kilosReales = ajuste.kilos_reales || kilosOriginales;
          const descuentoKg = ajuste.descuento_kg || 0;
          const kilosEfectivos = kilosReales - descuentoKg;
          
          // C√°lculo de AJUSTES DE B√ÅSCULA (p√©rdida o ganancia) + DESCUENTO DE CALIDAD
          const ajusteBascula = toFixed2(kilosReales - kilosOriginales); // positivo = ganancia, negativo = p√©rdida
          const perdidaCalidad = descuentoKg;
          const ajusteTotal = toFixed2(ajusteBascula - perdidaCalidad); // ganancia neta o p√©rdida neta
          
          // Solo registrar en p√©rdidas globales si hay p√©rdida neta
          if (ajusteTotal < 0) {
            perdidaTotalGlobal += Math.abs(ajusteTotal);
          }
          
          // VALIDACI√ìN: Si hay p√©rdida neta, verificar que NO vuelva al stock
          if (ajusteTotal < 0) {
            const producto = await base44.entities.Producto.filter({ id: detalle.producto_id });
            if (producto && producto.length > 0) {
              validarPerdidasNoRetornan(producto[0], Math.abs(ajusteTotal));
            }
          }
          
          console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
          console.log(ajusteTotal < 0 ? `üî¥ P√âRDIDA NETA REGISTRADA` : ajusteTotal > 0 ? `üü¢ GANANCIA NETA REGISTRADA` : `‚ö™ SIN AJUSTE NETO`);
          console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
          console.log(`   Producto: ${detalle.producto_nombre}`);
          console.log(`   Kilos Originales Salidos: ${kilosOriginales.toFixed(2)} kg`);
          console.log(`   ‚îî‚îÄ YA RESTADOS del stock en salida inicial`);
          console.log(`   `);
          console.log(`   Kilos Reales Recibidos (B√°scula Cliente): ${kilosReales.toFixed(2)} kg`);
          console.log(`   ${ajusteBascula >= 0 ? 'üü¢' : 'üî¥'} AJUSTE DE B√ÅSCULA: ${ajusteBascula >= 0 ? '+' : ''}${ajusteBascula.toFixed(2)} kg ${ajusteBascula > 0 ? '(GANANCIA)' : ajusteBascula < 0 ? '(P√âRDIDA)' : '(SIN CAMBIO)'}`);
          console.log(`   `);
          console.log(`   Descuento por Calidad: ${descuentoKg.toFixed(2)} kg`);
          console.log(`   üî¥ P√âRDIDA POR CALIDAD: ${perdidaCalidad.toFixed(2)} kg (NO vuelve)`);
          console.log(`   `);
          console.log(`   Kilos Efectivos a Cobrar: ${kilosEfectivos.toFixed(2)} kg`);
          console.log(`   ${ajusteTotal >= 0 ? 'üü¢' : 'üî¥'} AJUSTE TOTAL NETO: ${ajusteTotal >= 0 ? '+' : ''}${ajusteTotal.toFixed(2)} kg`);
          console.log(`   `);
          if (ajusteTotal < 0) {
            console.log(`   ‚ö†Ô∏è  P√©rdida neta NO vuelve al stock (DEFINITIVA)`);
            console.log(`   ‚úÖ Validaci√≥n pasada: P√©rdida NO retorna al inventario`);
          } else if (ajusteTotal > 0) {
            console.log(`   ‚ÑπÔ∏è  Ganancia neta registrada (m√°s kilos cobrados)`);
          } else {
            console.log(`   ‚ÑπÔ∏è  Sin ajuste neto (equilibrio perfecto)`);
          }
          console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
        }
      }
      
      console.log(`\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
      console.log(`‚úÖ CONFIRMACI√ìN COMPLETADA - STOCK NO MODIFICADO`);
      console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
      if (perdidaTotalGlobal > 0) {
        console.log(`   P√âRDIDA NETA GLOBAL: ${perdidaTotalGlobal.toFixed(2)} kg`);
        console.log(`   ‚îî‚îÄ Registradas como DEFINITIVAS en p√©rdidas acumuladas`);
        console.log(`   ‚îî‚îÄ NO impactan el stock positivamente (no vuelven al inventario)`);
      } else {
        console.log(`   Sin p√©rdidas netas globales (ganancias compensan o superan p√©rdidas)`);
      }
      console.log(`   `);
      console.log(`   Stock de productos: INTACTO (ya fue reducido en salida original)`);
      console.log(`   Deuda calculada: Basada en kilos efectivos cobrados`);
      console.log(`   Nota: Sistema ahora admite ganancias de b√°scula del cliente`);
      console.log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`);

      return salidaActualizada;
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['salidas'] });
      queryClient.invalidateQueries({ queryKey: ['productos'] });
      queryClient.invalidateQueries({ queryKey: ['envases'] });
      queryClient.invalidateQueries({ queryKey: ['cuentascorrientes'] });
      
      const cliente = clientes.find(c => c.id === data.cliente_id);
      
      toast.success('Salida confirmada exitosamente', {
        action: {
          label: 'Ver PDF',
          onClick: () => {
            const html = generateSalidaPDF(data);
            downloadSalidaPDF(html, data.numero_remito);
          },
        },
      });

      // Opci√≥n para compartir por WhatsApp
      if (cliente?.whatsapp) {
        setTimeout(() => {
          toast.info('¬øCompartir por WhatsApp?', {
            action: {
              label: 'Compartir',
              onClick: () => shareSalidaWhatsApp(data, cliente.whatsapp),
            },
          });
        }, 1000);
      }

      setSalidaSeleccionada(null);
      setComprobanteCliente('');
      setAjustes([]);
    },
  });

  const handleSeleccionarSalida = (salida) => {
    setSalidaSeleccionada(salida);
    setComprobanteCliente('');
    setAjustes(salida.detalles.map(d => ({
      kilos_reales: d.kilos_salida,
      descuento_kg: 0,
      motivo_ajuste: ''
    })));
  };

  const handleAjusteChange = (index, field, value) => {
    const nuevosAjustes = [...ajustes];
    nuevosAjustes[index] = {
      ...nuevosAjustes[index],
      [field]: field === 'motivo_ajuste' ? value : parseFloat(value) || 0
    };
    setAjustes(nuevosAjustes);
  };

  const handleConfirmar = () => {
    if (!comprobanteCliente.trim()) {
      alert('Por favor ingrese el comprobante del cliente');
      return;
    }

    // VALIDACIONES FLEXIBLES - P√âRDIDAS Y GANANCIAS DE B√ÅSCULA
    for (let i = 0; i < ajustes.length; i++) {
      const ajuste = ajustes[i];
      const original = salidaSeleccionada.detalles[i].kilos_salida;
      const nombreProducto = salidaSeleccionada.detalles[i].producto_nombre;
      
      // Validar que descuento no exceda reales
      if (ajuste.descuento_kg > ajuste.kilos_reales) {
        alert(`‚ùå ERROR - ${nombreProducto}: El descuento por calidad (${ajuste.descuento_kg.toFixed(2)} kg) no puede exceder los kilos reales recibidos (${ajuste.kilos_reales.toFixed(2)} kg).`);
        return;
      }
      
      // Validar que no haya valores negativos
      if (ajuste.kilos_reales < 0 || ajuste.descuento_kg < 0) {
        alert(`‚ùå ERROR - ${nombreProducto}: Los valores no pueden ser negativos.`);
        return;
      }
    }

    confirmarSalidaMutation.mutate({
      salida: salidaSeleccionada,
      comprobante: comprobanteCliente,
      ajustes: ajustes
    });
  };

  return (
    <div className={embedded ? "" : "min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8"}>
      <div className={embedded ? "" : "max-w-6xl mx-auto space-y-6"}>
        {!embedded && (
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
              <CheckCircle2 className="h-8 w-8 text-green-600" />
              Confirmar Salidas de Fruta
            </h1>
            <p className="text-slate-600 mt-1">Registrar comprobante del cliente y ajustar kilos reales recibidos</p>
          </div>
        )}

        {isLoading ? (
          <div className="text-center py-12 text-slate-500">Cargando salidas...</div>
        ) : salidasPendientes.length === 0 ? (
          <Card className="border-0 shadow-lg">
            <CardContent className="p-12 text-center">
              <CheckCircle2 className="h-16 w-16 text-green-500 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-slate-800 mb-2">
                No hay salidas pendientes
              </h3>
              <p className="text-slate-500">Todas las salidas est√°n confirmadas</p>
            </CardContent>
          </Card>
        ) : !salidaSeleccionada ? (
          <div className="space-y-4">
            <h2 className="text-lg font-semibold text-slate-700">Salidas Pendientes ({salidasPendientes.length})</h2>
            {salidasPendientes.map((salida) => (
              <Card key={salida.id} className="border-0 shadow-lg hover:shadow-xl transition-shadow cursor-pointer" onClick={() => handleSeleccionarSalida(salida)}>
                <CardHeader className="pb-3">
                  <div className="flex items-start justify-between">
                    <div>
                      <CardTitle className="text-lg flex items-center gap-2">
                        <FileText className="h-5 w-5 text-purple-600" />
                        {salida.numero_remito}
                      </CardTitle>
                      <p className="text-sm text-slate-600 mt-1">
                        {format(new Date(salida.fecha), "dd/MM/yyyy HH:mm", { locale: es })}
                      </p>
                    </div>
                    <Badge className="bg-amber-500">Pendiente</Badge>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                      <p className="text-xs text-slate-500">Cliente</p>
                      <p className="font-semibold text-slate-800">{salida.cliente_nombre}</p>
                    </div>
                    {salida.fletero_nombre && (
                      <div>
                        <p className="text-xs text-slate-500">Fletero</p>
                        <p className="font-semibold text-slate-800">{salida.fletero_nombre}</p>
                      </div>
                    )}
                  </div>
                  <div>
                    <p className="text-xs text-slate-500 mb-2">Productos</p>
                    <div className="flex flex-wrap gap-2">
                      {salida.detalles?.map((d, i) => (
                        <Badge key={i} variant="outline" className="bg-purple-50">
                          {d.producto_nombre}: {d.kilos_salida.toFixed(2)} kg
                        </Badge>
                      ))}
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        ) : (
          <div className="space-y-6">
            <Card className="border-0 shadow-lg">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle className="text-xl">Confirmaci√≥n de {salidaSeleccionada.numero_remito}</CardTitle>
                  <Button variant="outline" onClick={() => setSalidaSeleccionada(null)}>
                    Volver a lista
                  </Button>
                </div>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-100 rounded-lg">
                  <div>
                    <p className="text-xs text-slate-500">Cliente</p>
                    <p className="font-semibold">{salidaSeleccionada.cliente_nombre}</p>
                  </div>
                  <div>
                    <p className="text-xs text-slate-500">Fecha Original</p>
                    <p className="font-semibold">{format(new Date(salidaSeleccionada.fecha), "dd/MM/yyyy HH:mm", { locale: es })}</p>
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">
                    Comprobante del Cliente *
                  </label>
                  <Input
                    placeholder="Ej: FAC-A-00001234"
                    value={comprobanteCliente}
                    onChange={(e) => setComprobanteCliente(e.target.value)}
                  />
                  <p className="text-xs text-slate-500 mt-1">N√∫mero de factura, remito u otro documento del cliente</p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <AlertCircle className="h-5 w-5 text-amber-600" />
                    Ajuste de Kilos y Clasificaci√≥n
                  </h3>
                  
                  <div className="space-y-4">
                    {salidaSeleccionada.detalles?.map((detalle, index) => {
                      const ajuste = ajustes[index];
                      const kilosEfectivos = (ajuste?.kilos_reales || detalle.kilos_salida) - (ajuste?.descuento_kg || 0);
                      const deuda = kilosEfectivos * (detalle.precio_kg || 0);
                      
                      return (
                        <Card key={index} className="bg-amber-50 border-amber-200">
                          <CardContent className="pt-4 space-y-4">
                            <div>
                              <h4 className="font-semibold text-slate-800 mb-1">{detalle.producto_nombre}</h4>
                              <p className="text-sm text-slate-600">
                                Precio: {detalle.precio_kg > 0 ? `$${detalle.precio_kg.toFixed(2)}/kg` : 'No configurado'}
                              </p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                              <div>
                                <label className="text-xs font-medium text-slate-600 mb-1 block">
                                  Kilos Salida Original
                                </label>
                                <Input
                                  type="number"
                                  value={detalle.kilos_salida.toFixed(2)}
                                  disabled
                                  className="bg-slate-200 text-slate-700 font-semibold"
                                />
                              </div>

                              <div>
                                <label className="text-xs font-medium text-slate-600 mb-1 block">
                                  Kilos Reales Recibidos (B√°scula Cliente) *
                                </label>
                                <Input
                                  type="number"
                                  step="0.01"
                                  min="0"
                                  value={ajuste?.kilos_reales ?? detalle.kilos_salida}
                                  placeholder={detalle.kilos_salida.toFixed(2)}
                                  onChange={(e) => handleAjusteChange(index, 'kilos_reales', e.target.value)}
                                  onFocus={(e) => e.target.select()}
                                  className={`font-semibold ${(ajuste?.kilos_reales || detalle.kilos_salida) > detalle.kilos_salida ? 'text-green-700' : (ajuste?.kilos_reales || detalle.kilos_salida) < detalle.kilos_salida ? 'text-red-600' : ''}`}
                                  inputMode="decimal"
                                />
                                {ajuste?.kilos_reales && ajuste.kilos_reales !== detalle.kilos_salida && (
                                  <p className={`text-xs mt-1 font-medium ${ajuste.kilos_reales > detalle.kilos_salida ? 'text-green-700' : 'text-red-600'}`}>
                                    {ajuste.kilos_reales > detalle.kilos_salida ? '‚ñ≤' : '‚ñº'} {Math.abs(ajuste.kilos_reales - detalle.kilos_salida).toFixed(2)} kg {ajuste.kilos_reales > detalle.kilos_salida ? '(Ganancia b√°scula)' : '(P√©rdida b√°scula)'}
                                  </p>
                                )}
                              </div>

                              <div>
                                <label className="text-xs font-medium text-slate-600 mb-1 block">
                                  Descuento por Calidad (kg)
                                </label>
                                <Input
                                  type="number"
                                  step="0.01"
                                  min="0"
                                  value={ajuste?.descuento_kg ?? ''}
                                  placeholder="0.00"
                                  onChange={(e) => handleAjusteChange(index, 'descuento_kg', e.target.value)}
                                  onFocus={(e) => e.target.select()}
                                  className="text-red-600 font-semibold"
                                  inputMode="decimal"
                                />
                                <p className="text-xs text-slate-500 mt-1">Clasificaci√≥n, calidad, etc.</p>
                              </div>
                            </div>

                            <div>
                              <label className="text-xs font-medium text-slate-600 mb-1 block">
                                Motivo de Ajuste (Opcional)
                              </label>
                              <Textarea
                                placeholder="Ej: Clasificaci√≥n por calidad, producto en mal estado..."
                                value={ajuste?.motivo_ajuste || ''}
                                onChange={(e) => handleAjusteChange(index, 'motivo_ajuste', e.target.value)}
                                rows={2}
                              />
                            </div>

                            <div className="p-3 bg-white rounded-lg border-2 border-green-200">
                              <div className="flex justify-between items-center mb-1">
                                <span className="text-sm font-medium text-slate-600">Kilos Efectivos a Cobrar:</span>
                                <span className="text-lg font-bold text-green-700">
                                  {kilosEfectivos.toFixed(2)} kg
                                </span>
                              </div>
                              {detalle.precio_kg > 0 && (
                                <div className="flex justify-between items-center">
                                  <span className="text-sm font-medium text-slate-600">Deuda del Cliente:</span>
                                  <span className="text-xl font-bold text-green-800">
                                    ${deuda.toFixed(2)}
                                  </span>
                                </div>
                              )}
                            </div>
                          </CardContent>
                        </Card>
                      );
                    })}
                  </div>

                  <div className="mt-6 p-4 bg-green-100 rounded-lg border-2 border-green-300">
                    <div className="flex justify-between items-center">
                      <span className="text-lg font-semibold text-green-900">TOTAL KILOS EFECTIVOS:</span>
                      <span className="text-2xl font-bold text-green-900">
                        {ajustes.reduce((sum, aj, i) => {
                          const kilosEfectivos = (aj.kilos_reales || salidaSeleccionada.detalles[i].kilos_salida) - (aj.descuento_kg || 0);
                          return sum + kilosEfectivos;
                        }, 0).toFixed(2)} kg
                      </span>
                    </div>
                    {salidaSeleccionada.detalles?.some(d => d.precio_kg > 0) && (
                      <div className="flex justify-between items-center mt-2 pt-2 border-t border-green-300">
                        <span className="text-lg font-semibold text-green-900">DEUDA TOTAL CLIENTE:</span>
                        <span className="text-3xl font-bold text-green-900">
                          ${ajustes.reduce((sum, aj, i) => {
                            const detalle = salidaSeleccionada.detalles[i];
                            const kilosEfectivos = (aj.kilos_reales || detalle.kilos_salida) - (aj.descuento_kg || 0);
                            return sum + (kilosEfectivos * (detalle.precio_kg || 0));
                          }, 0).toFixed(2)}
                        </span>
                      </div>
                    )}
                  </div>
                </div>

                <div className="flex justify-end gap-3 pt-4">
                  <Button
                    variant="outline"
                    onClick={() => setSalidaSeleccionada(null)}
                  >
                    Cancelar
                  </Button>
                  <Button
                    onClick={handleConfirmar}
                    disabled={confirmarSalidaMutation.isPending}
                    className="bg-green-600 hover:bg-green-700"
                    size="lg"
                  >
                    {confirmarSalidaMutation.isPending ? (
                      <>
                        <Loader2 className="h-5 w-5 mr-2 animate-spin" />
                        Confirmando...
                      </>
                    ) : (
                      <>
                        <CheckCircle2 className="h-5 w-5 mr-2" />
                        Confirmar Salida
                      </>
                    )}
                  </Button>
                </div>
              </CardContent>
            </Card>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/CuentaCorriente.jsx">
import React, { useState, useMemo, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Scale, Loader2, TrendingUp, TrendingDown, Search, FileText, DollarSign, Download, FileDown, ChevronLeft, ChevronRight, ChevronDown } from 'lucide-react';
import { Switch } from "@/components/ui/switch";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { usePreciosCache } from '@/components/hooks/usePreciosCache';
import { exportarExcel } from '@/components/ExportarExcel';
import { escapeRegex } from '@/lib/utils';
import { toast } from 'sonner';

export default function CuentaCorriente() {
  const [filtros, setFiltros] = useState({
    entidad_tipo: 'Todos',
    busqueda: '',
    fecha_desde: '',
    fecha_hasta: '',
    proveedor_id: 'todos'
  });
  const [entidadSeleccionada, setEntidadSeleccionada] = useState(null);
  const [movimientoExpandido, setMovimientoExpandido] = useState(null);
  const [mostrarSaldosCero, setMostrarSaldosCero] = useState(false);
  const [paginaActual, setPaginaActual] = useState(1);
  const ITEMS_POR_PAGINA = 25;

  // Paginaci√≥n de datos del servidor (p√°gina actual para Cliente, Proveedor, Cobro, Pago, MT)
  const [paginaDatos, setPaginaDatos] = useState(1);
  const ITEMS_POR_PAGINA_API = 20;

  // B√∫squeda en servidor (debounced desde filtros.busqueda)
  const [busquedaServidor, setBusquedaServidor] = useState('');
  useEffect(() => {
    const t = setTimeout(() => setBusquedaServidor(filtros.busqueda.trim()), 400);
    return () => clearTimeout(t);
  }, [filtros.busqueda]);
  useEffect(() => {
    setPaginaDatos(1);
  }, [busquedaServidor]);

  // Hook centralizado para cach√© de precios
  const { obtenerPrecioVigente } = usePreciosCache();

  // Estado para controlar cu√°ntos registros cargar
  const [limiteMovimientosCC, setLimiteMovimientosCC] = useState(50);

  const queryMovimientosCC = useMemo(() => {
    const q = {};
    if (filtros.fecha_desde) {
      q.fecha = q.fecha || {};
      q.fecha.$gte = new Date(filtros.fecha_desde).toISOString();
    }
    if (filtros.fecha_hasta) {
      q.fecha = q.fecha || {};
      q.fecha.$lte = new Date(filtros.fecha_hasta + 'T23:59:59').toISOString();
    }
    if (filtros.proveedor_id && filtros.proveedor_id !== 'todos') {
      q.entidad_tipo = 'Proveedor';
      q.entidad_id = filtros.proveedor_id;
    }
    return q;
  }, [filtros.fecha_desde, filtros.fecha_hasta, filtros.proveedor_id]);

  const { data: movimientosCC = [], isLoading } = useQuery({
    queryKey: ['cuentacorriente', limiteMovimientosCC, filtros.fecha_desde, filtros.fecha_hasta, filtros.proveedor_id],
    queryFn: () => {
      if (Object.keys(queryMovimientosCC).length === 0) {
        return base44.entities.CuentaCorriente.list('-fecha', limiteMovimientosCC);
      }
      return base44.entities.CuentaCorriente.filter(queryMovimientosCC, '-fecha', limiteMovimientosCC, 0);
    },
    staleTime: 2 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  const skipCobros = (paginaDatos - 1) * ITEMS_POR_PAGINA_API;
  const { data: cobros = [] } = useQuery({
    queryKey: ['cobros', paginaDatos],
    queryFn: () => base44.entities.Cobro.list('-fecha', ITEMS_POR_PAGINA_API, skipCobros),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  const skipPagos = (paginaDatos - 1) * ITEMS_POR_PAGINA_API;
  const { data: pagos = [] } = useQuery({
    queryKey: ['pagos', paginaDatos],
    queryFn: () => base44.entities.Pago.list('-fecha', ITEMS_POR_PAGINA_API, skipPagos),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  const skipMT = (paginaDatos - 1) * ITEMS_POR_PAGINA_API;
  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria', paginaDatos],
    queryFn: () => base44.entities.MovimientoTesoreria.list('-fecha', ITEMS_POR_PAGINA_API, skipMT),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  const queryCliente = useMemo(() => {
    if (!busquedaServidor) return {};
    return { nombre: { $regex: escapeRegex(busquedaServidor), $options: 'i' } };
  }, [busquedaServidor]);
  const skipClientes = (paginaDatos - 1) * ITEMS_POR_PAGINA_API;
  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes', paginaDatos, busquedaServidor],
    queryFn: () => base44.entities.Cliente.filter(queryCliente, 'nombre', ITEMS_POR_PAGINA_API, skipClientes),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  const queryProveedor = useMemo(() => {
    if (!busquedaServidor) return {};
    return { nombre: { $regex: escapeRegex(busquedaServidor), $options: 'i' } };
  }, [busquedaServidor]);
  const skipProveedores = (paginaDatos - 1) * ITEMS_POR_PAGINA_API;
  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores', paginaDatos, busquedaServidor],
    queryFn: () => base44.entities.Proveedor.filter(queryProveedor, 'nombre', ITEMS_POR_PAGINA_API, skipProveedores),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-fecha', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false,
  });

  // Filtrar movimientos de CC v√°lidos (solo los que tienen cobros/pagos con movimientos de tesorer√≠a)
  const movimientosCCValidos = movimientosCC.filter(movCC => {
    // Si no tiene comprobante asociado, es v√°lido (movimientos manuales o de fruta)
    if (!movCC.comprobante_id || !movCC.comprobante_tipo) return true;
    
    // Si es un Cobro, verificar que el cobro existe y tiene movimientos de tesorer√≠a
    if (movCC.comprobante_tipo === 'Cobro' || movCC.comprobante_tipo === 'Retencion') {
      const cobro = cobros.find(c => c.id === movCC.comprobante_id);
      if (!cobro) return false;
      
      const tieneMovimientos = movimientosTesoreria.some(m => 
        m.referencia_origen_id === cobro.id && m.referencia_origen_tipo === 'Cobro'
      );
      return tieneMovimientos;
    }
    
    // Si es un Pago, verificar que el pago existe y tiene movimientos de tesorer√≠a
    if (movCC.comprobante_tipo === 'Pago') {
      const pago = pagos.find(p => p.id === movCC.comprobante_id);
      if (!pago) return false;
      
      const tieneMovimientos = movimientosTesoreria.some(m => 
        m.referencia_origen_id === pago.id && m.referencia_origen_tipo === 'Pago'
      );
      return tieneMovimientos;
    }
    
    // Otros tipos de comprobantes son v√°lidos
    return true;
  });

  // CLIENTES: Cobros realizados (movimientos tipo "Debe") - usando movimientos v√°lidos
  const cobrosPorCliente = {};
  movimientosCCValidos
    .filter(m => m.entidad_tipo === 'Cliente' && m.tipo_movimiento === 'Debe')
    .forEach(m => {
      if (!cobrosPorCliente[m.entidad_id]) {
        cobrosPorCliente[m.entidad_id] = 0;
      }
      cobrosPorCliente[m.entidad_id] += m.monto || 0;
    });

  // PROVEEDORES: Pagos realizados (movimientos tipo "Debe") - usando movimientos v√°lidos
  const pagosPorProveedor = {};
  movimientosCCValidos
    .filter(m => m.entidad_tipo === 'Proveedor' && m.tipo_movimiento === 'Debe')
    .forEach(m => {
      if (!pagosPorProveedor[m.entidad_id]) {
        pagosPorProveedor[m.entidad_id] = 0;
      }
      pagosPorProveedor[m.entidad_id] += m.monto || 0;
    });

  // Agrupar movimientos por entidad; deuda_real = saldo_actual de la entidad (saldo vivo)
  const movimientosPorEntidad = movimientosCCValidos.reduce((acc, mov) => {
    const key = `${mov.entidad_tipo}_${mov.entidad_id}`;
    if (!acc[key]) {
      acc[key] = {
        entidad_tipo: mov.entidad_tipo,
        entidad_id: mov.entidad_id,
        entidad_nombre: mov.entidad_nombre,
        movimientos: [],
        saldo: 0,
        deuda_real: 0
      };
    }
    acc[key].movimientos.push(mov);
    acc[key].saldo = mov.saldo_resultante || 0;
    return acc;
  }, {});

  // Asignar deuda_real desde saldo_actual de Cliente/Proveedor
  Object.keys(movimientosPorEntidad).forEach(key => {
    const entidad = movimientosPorEntidad[key];
    if (entidad.entidad_tipo === 'Cliente') {
      const cliente = clientes.find(c => c.id === entidad.entidad_id);
      entidad.deuda_real = Number(cliente?.saldo_actual) || 0;
    } else if (entidad.entidad_tipo === 'Proveedor') {
      const proveedor = proveedores.find(p => p.id === entidad.entidad_id);
      entidad.deuda_real = Number(proveedor?.saldo_actual) || 0;
    }
  });

  // Incluir clientes/proveedores con saldo_actual distinto de cero que no tengan movimientos CC cargados
  clientes.forEach(cliente => {
    const key = `Cliente_${cliente.id}`;
    const saldo = Number(cliente.saldo_actual) || 0;
    if (!movimientosPorEntidad[key] && saldo !== 0) {
      movimientosPorEntidad[key] = {
        entidad_tipo: 'Cliente',
        entidad_id: cliente.id,
        entidad_nombre: cliente.nombre,
        movimientos: [],
        saldo: 0,
        deuda_real: saldo
      };
    }
  });

  proveedores.forEach(proveedor => {
    const key = `Proveedor_${proveedor.id}`;
    const saldo = Number(proveedor.saldo_actual) || 0;
    if (!movimientosPorEntidad[key] && saldo !== 0) {
      movimientosPorEntidad[key] = {
        entidad_tipo: 'Proveedor',
        entidad_id: proveedor.id,
        entidad_nombre: proveedor.nombre,
        movimientos: [],
        saldo: 0,
        deuda_real: saldo
      };
    }
  });

  const entidadesConSaldo = Object.values(movimientosPorEntidad)
    .filter(e => {
      if (filtros.entidad_tipo !== 'Todos' && e.entidad_tipo !== filtros.entidad_tipo) return false;
      
      const coincideBusqueda = !filtros.busqueda || e.entidad_nombre.toLowerCase().includes(filtros.busqueda.toLowerCase());
      if (!coincideBusqueda) return false;
      
      // Filtrar por fecha de movimientos
      if (filtros.fecha_desde || filtros.fecha_hasta) {
        const movimientosFiltrados = e.movimientos.filter(m => {
          const fechaMov = new Date(m.fecha);
          if (filtros.fecha_desde && fechaMov < new Date(filtros.fecha_desde)) return false;
          if (filtros.fecha_hasta && fechaMov > new Date(filtros.fecha_hasta + 'T23:59:59')) return false;
          return true;
        });
        if (movimientosFiltrados.length === 0) return false;
      }
      
      // Ocultar saldos en cero SOLO si:
      // - No hay b√∫squeda activa
      // - El toggle est√° desactivado
      const tieneSaldo = e.deuda_real > 0 || e.movimientos.length > 0;
      const deudaEsCero = Math.abs(e.deuda_real) < 0.01;
      
      if (deudaEsCero && !mostrarSaldosCero && !filtros.busqueda) {
        return false;
      }
      
      return tieneSaldo;
    })
    .sort((a, b) => {
      // Ordenar: saldos != 0 primero (mayor a menor), luego saldos = 0
      const saldoA = Math.abs(a.deuda_real) < 0.01 ? 0 : a.deuda_real;
      const saldoB = Math.abs(b.deuda_real) < 0.01 ? 0 : b.deuda_real;
      
      if (saldoA === 0 && saldoB !== 0) return 1;
      if (saldoA !== 0 && saldoB === 0) return -1;
      if (saldoA !== 0 && saldoB !== 0) return saldoB - saldoA;
      return 0;
    });

  // Paginaci√≥n
  const totalPaginas = Math.ceil(entidadesConSaldo.length / ITEMS_POR_PAGINA);
  const indicePrimerItem = (paginaActual - 1) * ITEMS_POR_PAGINA;
  const entidadesPaginadas = entidadesConSaldo.slice(indicePrimerItem, indicePrimerItem + ITEMS_POR_PAGINA);

  // Resetear p√°gina de la tabla al cambiar filtros
  React.useEffect(() => {
    setPaginaActual(1);
  }, [filtros.entidad_tipo, filtros.busqueda, filtros.fecha_desde, filtros.fecha_hasta, mostrarSaldosCero]);

  // Si hay b√∫squeda activa, el input ya filtra en servidor; el placeholder lo indica
  const tieneMasDatos = (clientes.length === ITEMS_POR_PAGINA_API || proveedores.length === ITEMS_POR_PAGINA_API);

  // Totales para KPIs (saldo vivo desde entidades; cobros/pagos desde movimientos CC)
  const totalCobrosClientes = Object.values(cobrosPorCliente).reduce((sum, d) => sum + d, 0);
  const totalPagosProveedores = Object.values(pagosPorProveedor).reduce((sum, d) => sum + d, 0);
  const totalDeudaClientes = clientes.reduce((sum, c) => sum + (Number(c.saldo_actual) || 0), 0);
  const totalDeudaProveedores = proveedores.reduce((sum, p) => sum + (Number(p.saldo_actual) || 0), 0);

  const verDetalle = (entidad) => {
    setEntidadSeleccionada(entidad);
  };

  const comprobanteBadge = (tipo) => {
    switch (tipo) {
      case 'IngresoFruta': return 'bg-green-100 text-green-800';
      case 'SalidaFruta': return 'bg-blue-100 text-blue-800';
      case 'Pago': return 'bg-orange-100 text-orange-800';
      case 'Cobro': return 'bg-purple-100 text-purple-800';
      case 'Cheque': return 'bg-pink-100 text-pink-800';
      case 'Retencion': return 'bg-amber-100 text-amber-800';
      default: return 'bg-slate-100 text-slate-800';
    }
  };

  const obtenerDetalleIngreso = (movimiento) => {
    if (!movimiento.comprobante_id || movimiento.comprobante_tipo !== 'IngresoFruta') return null;
    const movimientoIngreso = movimientos.find(m => m.id === movimiento.comprobante_id);
    return movimientoIngreso;
  };

  const exportarEstadoCuentaPDF = (entidad, movimientos, filtros) => {
    if (!movimientos || movimientos.length === 0) {
      toast.error('No hay movimientos para exportar en el per√≠odo seleccionado');
      return;
    }

    const nombreEntidad = entidad.entidad_nombre;
    const tipoEntidad = entidad.entidad_tipo;
    const montoTotal = entidad.deuda_real || 0;

    // Calcular totales de ingresos y pagos
    const totalDeudas = movimientos
      .filter(m => m.tipo_movimiento === 'Haber')
      .reduce((sum, m) => sum + (m.monto || 0), 0);
    
    const totalPagos = movimientos
      .filter(m => m.tipo_movimiento === 'Debe')
      .reduce((sum, m) => sum + (m.monto || 0), 0);

    const periodoTexto = filtros.fecha_desde && filtros.fecha_hasta
      ? `${format(new Date(filtros.fecha_desde), 'dd/MM/yyyy', { locale: es })} al ${format(new Date(filtros.fecha_hasta), 'dd/MM/yyyy', { locale: es })}`
      : 'Todo el per√≠odo';

    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Estado de Cuenta - ${nombreEntidad}</title>
        <style>
          body { 
            font-family: Arial, sans-serif; 
            font-size: 10px; 
            padding: 20px;
            color: #1e293b;
          }
          .header { 
            text-align: center; 
            margin-bottom: 25px; 
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 15px;
          }
          .empresa { 
            font-size: 14px; 
            font-weight: bold; 
            color: #3b82f6;
            margin-bottom: 5px;
          }
          .title { 
            font-size: 20px; 
            font-weight: bold; 
            color: #1e293b;
            margin-bottom: 10px;
          }
          .entidad-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
          }
          .entidad-nombre {
            font-size: 16px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
          }
          .entidad-tipo {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            background: ${tipoEntidad === 'Cliente' ? '#dbeafe' : '#fef3c7'};
            color: ${tipoEntidad === 'Cliente' ? '#1e40af' : '#92400e'};
            margin-bottom: 10px;
          }
          .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
          }
          .resumen {
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 20px;
          }
          .resumen-title {
            font-size: 12px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 10px;
          }
          .monto-principal {
            font-size: 24px;
            font-weight: bold;
            color: ${montoTotal > 0 ? '#dc2626' : '#16a34a'};
            margin-top: 5px;
          }
          table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 15px 0;
          }
          th { 
            background: #f1f5f9; 
            font-weight: 600; 
            text-align: left;
            padding: 10px 8px;
            border-bottom: 2px solid #cbd5e1;
            font-size: 9px;
            text-transform: uppercase;
            color: #475569;
          }
          td { 
            border-bottom: 1px solid #e2e8f0; 
            padding: 8px;
            vertical-align: top;
            font-size: 9px;
          }
          .text-right { text-align: right; }
          .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 8px;
            font-weight: 600;
          }
          .badge-deuda { background: #fef3c7; color: #92400e; }
          .badge-pago { background: #d1fae5; color: #065f46; }
          .monto-positivo { color: #16a34a; font-weight: 600; }
          .monto-negativo { color: #dc2626; font-weight: 600; }
          .saldo-cell { font-weight: bold; color: #1e293b; }
          .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            color: #64748b;
            font-size: 8px;
          }
          .periodo {
            font-size: 10px;
            color: #64748b;
            margin-bottom: 3px;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="empresa">Sistema de Gesti√≥n de Acopio</div>
          <div class="title">ESTADO DE CUENTA</div>
          <div class="periodo">Per√≠odo: ${periodoTexto}</div>
          <div class="periodo">Fecha de emisi√≥n: ${format(new Date(), 'dd/MM/yyyy HH:mm', { locale: es })}</div>
        </div>
        
        <div class="entidad-info">
          <div class="entidad-nombre">${nombreEntidad}</div>
          <span class="entidad-tipo">${tipoEntidad}</span>
          <div style="margin-top: 10px;">
            <div class="info-row">
              <span style="color: #64748b;">Total de movimientos:</span>
              <span style="font-weight: 600;">${movimientos.length}</span>
            </div>
          </div>
        </div>

        <div class="resumen">
          <div class="resumen-title">Resumen del Estado de Cuenta</div>
          <div class="info-row">
            <span>Total Deudas Generadas:</span>
            <span style="font-weight: 600;">$${totalDeudas.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
          </div>
          <div class="info-row">
            <span>Total ${tipoEntidad === 'Cliente' ? 'Cobros' : 'Pagos'} Realizados:</span>
            <span style="font-weight: 600;">$${totalPagos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
          </div>
          <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #cbd5e1;">
            <div class="info-row">
              <span style="font-weight: bold;">${tipoEntidad === 'Cliente' ? 'Monto Adeudado:' : 'Monto a Pagar:'}</span>
              <span class="monto-principal">$${montoTotal.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width: 12%">Fecha</th>
              <th style="width: 30%">Descripci√≥n</th>
              <th style="width: 15%">Tipo</th>
              <th style="width: 18%" class="text-right">Movimiento</th>
              <th style="width: 18%" class="text-right">Saldo Acum.</th>
            </tr>
          </thead>
          <tbody>
            ${movimientos.map(mov => {
              const detalleIngreso = obtenerDetalleIngreso(mov);
              let montoMostrado = mov.monto;
              
              if (detalleIngreso && detalleIngreso.pesajes) {
                const montoCalculado = detalleIngreso.pesajes.reduce((total, pesaje) => {
                  const precioCompra = obtenerPrecioVigente(pesaje.producto_id, detalleIngreso.fecha, 'compra');
                  return total + (pesaje.peso_neto * precioCompra);
                }, 0);
                if (montoCalculado > 0) montoMostrado = montoCalculado;
              }
              
              const saldoMostrado = mov.tipo_movimiento === 'Haber' ? montoMostrado : (mov.saldo_resultante || 0);
              const esDeuda = mov.tipo_movimiento === 'Haber';
              
              return `
                <tr>
                  <td>${mov.fecha ? format(new Date(mov.fecha), "dd/MM/yyyy", { locale: es }) : '-'}</td>
                  <td>
                    <strong>${mov.concepto}</strong><br>
                    <span class="badge" style="background: #e0e7ff; color: #3730a3; margin-top: 2px; display: inline-block;">${mov.comprobante_tipo || 'N/A'}</span>
                  </td>
                  <td>
                    <span class="badge ${esDeuda ? 'badge-deuda' : 'badge-pago'}">
                      ${esDeuda ? 'Deuda' : (tipoEntidad === 'Cliente' ? 'Cobro' : 'Pago')}
                    </span>
                  </td>
                  <td class="text-right ${esDeuda ? 'monto-positivo' : 'monto-negativo'}">
                    ${esDeuda ? '+' : '-'} $${montoMostrado.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </td>
                  <td class="text-right saldo-cell">
                    $${saldoMostrado.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>

        <div class="footer">
          <p><strong>Documento generado autom√°ticamente</strong></p>
          <p>Sistema de Gesti√≥n de Acopio ‚Ä¢ ${format(new Date(), 'dd/MM/yyyy HH:mm', { locale: es })}</p>
        </div>
      </body>
      </html>
    `;

    const ventana = window.open('', '_blank');
    ventana.document.write(html);
    ventana.document.close();
    ventana.onload = () => ventana.print();
  };

  if (entidadSeleccionada) {
    let movimientosFiltrados = entidadSeleccionada.movimientos;
    
    if (filtros.fecha_desde) {
      movimientosFiltrados = movimientosFiltrados.filter(m => 
        new Date(m.fecha) >= new Date(filtros.fecha_desde)
      );
    }
    if (filtros.fecha_hasta) {
      movimientosFiltrados = movimientosFiltrados.filter(m => 
        new Date(m.fecha) <= new Date(filtros.fecha_hasta)
      );
    }

    return (
      <div className="min-h-screen bg-white p-6">
        <div className="max-w-6xl mx-auto">
          <Button 
            onClick={() => setEntidadSeleccionada(null)} 
            variant="outline" 
            className="mb-6"
          >
            ‚Üê Volver
          </Button>

          {/* Encabezado Profesional */}
          <div className="mb-6 pb-6 border-b border-slate-200">
            <div className="flex items-start justify-between">
              <div>
                <h1 className="text-3xl font-bold text-slate-900">
                  {entidadSeleccionada.entidad_nombre}
                </h1>
                <p className="text-slate-600 mt-1">
                  {entidadSeleccionada.entidad_tipo === 'Cliente' ? 'Cliente' : 'Proveedor'} ‚Ä¢ Estado de Cuenta
                </p>
              </div>
              <div className="text-right">
                <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                  {entidadSeleccionada.entidad_tipo === 'Cliente' ? 'Monto Adeudado' : 'Monto a Pagar'}
                </p>
                <p className="text-4xl font-bold text-slate-900">
                  ${(entidadSeleccionada.deuda_real || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                </p>
                <Button
                  onClick={() => exportarEstadoCuentaPDF(entidadSeleccionada, movimientosFiltrados, filtros)}
                  className="mt-4 bg-blue-600 hover:bg-blue-700"
                  size="sm"
                >
                  <FileDown className="h-4 w-4 mr-2" />
                  Exportar PDF
                </Button>
              </div>
            </div>
          </div>

          {/* Filtros */}
          <div className="grid grid-cols-2 gap-4 mb-6">
            <div>
              <Label className="text-xs text-slate-500">Fecha Desde</Label>
              <Input
                type="date"
                value={filtros.fecha_desde}
                onChange={(e) => setFiltros({ ...filtros, fecha_desde: e.target.value })}
                className="mt-1"
              />
            </div>
            <div>
              <Label className="text-xs text-slate-500">Fecha Hasta</Label>
              <Input
                type="date"
                value={filtros.fecha_hasta}
                onChange={(e) => setFiltros({ ...filtros, fecha_hasta: e.target.value })}
                className="mt-1"
              />
            </div>
          </div>

          {/* Tabla de Movimientos - Estilo Estado de Cuenta */}
          {movimientosFiltrados.length === 0 ? (
            <div className="text-center py-12 text-slate-500">
              <p>No hay movimientos para este per√≠odo</p>
            </div>
          ) : (
            <div className="overflow-x-auto border border-slate-200 rounded-lg">
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-slate-100 border-b border-slate-200">
                    <th className="px-6 py-3 text-left font-semibold text-slate-700">Fecha</th>
                    <th className="px-6 py-3 text-left font-semibold text-slate-700">Descripci√≥n</th>
                    <th className="px-6 py-3 text-left font-semibold text-slate-700">Tipo</th>
                    <th className="px-6 py-3 text-right font-semibold text-slate-700">Movimiento</th>
                    <th className="px-6 py-3 text-right font-semibold text-slate-700">Saldo</th>
                  </tr>
                </thead>
                <tbody>
                  {movimientosFiltrados.map((mov, idx) => {
                    const detalleIngreso = obtenerDetalleIngreso(mov);
                    const expandido = movimientoExpandido === mov.id;
                    
                    let montoMostrado = mov.monto;
                    
                    if (detalleIngreso && detalleIngreso.pesajes) {
                      const montoCalculado = detalleIngreso.pesajes.reduce((total, pesaje) => {
                        const precioCompra = obtenerPrecioVigente(pesaje.producto_id, detalleIngreso.fecha, 'compra');
                        return total + (pesaje.peso_neto * precioCompra);
                      }, 0);
                      if (montoCalculado > 0) montoMostrado = montoCalculado;
                    }
                    
                    // Para movimientos de deuda (Haber), mostrar el monto del movimiento en lugar del saldo acumulado
                    const saldoMostrado = mov.tipo_movimiento === 'Haber' ? montoMostrado : (mov.saldo_resultante || 0);
                    
                    return (
                      <React.Fragment key={mov.id}>
                        <tr className={`border-b border-slate-100 hover:bg-slate-50 ${expandido ? 'bg-slate-50' : ''}`}>
                          <td className="px-6 py-4 text-slate-700 font-medium">
                            {mov.fecha ? format(new Date(mov.fecha), "dd/MM/yyyy", { locale: es }) : '-'}
                          </td>
                          <td className="px-6 py-4">
                            <div className="flex items-center gap-2">
                              {detalleIngreso && (
                                <button
                                  onClick={() => setMovimientoExpandido(expandido ? null : mov.id)}
                                  className="text-slate-400 hover:text-slate-600"
                                >
                                  {expandido ? '‚ñº' : '‚ñ∂'}
                                </button>
                              )}
                              <div>
                                <p className="text-slate-900 font-medium">{mov.concepto}</p>
                                <p className="text-xs text-slate-500 mt-0.5">
                                  <Badge variant="outline" className="mr-2 text-xs h-5">
                                    {mov.comprobante_tipo}
                                  </Badge>
                                </p>
                              </div>
                            </div>
                          </td>
                          <td className="px-6 py-4">
                            <Badge variant={mov.tipo_movimiento === 'Debe' ? 'outline' : 'secondary'} className="text-xs">
                              {mov.tipo_movimiento === 'Debe' ? 'Pago/Cobro' : 'Deuda'}
                            </Badge>
                          </td>
                          <td className="px-6 py-4 text-right font-semibold text-slate-900">
                            {mov.tipo_movimiento === 'Debe' ? '-' : '+'} ${montoMostrado.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                          </td>
                          <td className="px-6 py-4 text-right font-bold text-slate-900">
                            ${saldoMostrado.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                          </td>
                        </tr>
                        {expandido && detalleIngreso && (
                          <tr className="bg-slate-50 border-b border-slate-100">
                            <td colSpan="5" className="px-6 py-4">
                              <div className="text-sm">
                                <p className="font-semibold text-slate-700 mb-3">Productos Ingresados</p>
                                <div className="space-y-2">
                                  {detalleIngreso.pesajes && detalleIngreso.pesajes.length > 0 ? (
                                    detalleIngreso.pesajes.map((pesaje, pidx) => {
                                      const precioCompra = obtenerPrecioVigente(pesaje.producto_id, detalleIngreso.fecha, 'compra');
                                      const montoProducto = pesaje.peso_neto * precioCompra;
                                      return (
                                        <div key={pidx} className="flex justify-between text-slate-700">
                                          <span>{pesaje.producto_nombre}: {pesaje.peso_neto.toFixed(2)} kg @ ${precioCompra.toFixed(2)}/kg</span>
                                          <span className="font-semibold">${montoProducto.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                                        </div>
                                      );
                                    })
                                  ) : (
                                    <p className="text-slate-500">Sin detalles</p>
                                  )}
                                </div>
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-white p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6 pb-6 border-b border-slate-200">
          <h1 className="text-3xl font-bold text-slate-900">Cuentas Corrientes</h1>
          <p className="text-slate-600 mt-1">Estados de cuenta de clientes y proveedores</p>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
          <Card className="border-slate-100 shadow-sm">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-slate-500 mb-1">Deuda Total Clientes</p>
                  <p className="text-lg font-semibold text-rose-500">
                    ${totalDeudaClientes.toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                  </p>
                  <p className="text-[10px] text-slate-400 mt-0.5">A cobrar</p>
                </div>
                <TrendingUp className="h-8 w-8 text-rose-500 opacity-10" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-slate-100 shadow-sm">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-slate-500 mb-1">Cobros Realizados</p>
                  <p className="text-lg font-semibold text-emerald-500">
                    ${totalCobrosClientes.toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                  </p>
                  <p className="text-[10px] text-slate-400 mt-0.5">Ya cobrado</p>
                </div>
                <DollarSign className="h-8 w-8 text-emerald-500 opacity-10" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-slate-100 shadow-sm">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-slate-500 mb-1">Deuda Total Proveedores</p>
                  <p className="text-lg font-semibold text-amber-500">
                    ${totalDeudaProveedores.toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                  </p>
                  <p className="text-[10px] text-slate-400 mt-0.5">A pagar</p>
                </div>
                <TrendingDown className="h-8 w-8 text-amber-500 opacity-10" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-slate-100 shadow-sm">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-slate-500 mb-1">Pagos Realizados</p>
                  <p className="text-lg font-semibold text-sky-500">
                    ${totalPagosProveedores.toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                  </p>
                  <p className="text-[10px] text-slate-400 mt-0.5">Ya pagado</p>
                </div>
                <DollarSign className="h-8 w-8 text-sky-500 opacity-10" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Filtros */}
        <Card className="mb-6 border-slate-100 shadow-sm">
          <CardContent className="p-4">
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <Label className="text-xs">Tipo de Entidad</Label>
                  <select
                    value={filtros.entidad_tipo}
                    onChange={(e) => setFiltros({ ...filtros, entidad_tipo: e.target.value })}
                    className="flex h-9 w-full rounded-md border border-slate-200 bg-white px-3 py-1 text-sm mt-1"
                  >
                    <option value="Todos">Todas las entidades</option>
                    <option value="Cliente">Clientes</option>
                    <option value="Proveedor">Proveedores</option>
                  </select>
                </div>
                <div>
                  <Label className="text-xs">Buscar (filtra en servidor)</Label>
                  <div className="relative mt-1">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400" />
                    <Input
                      value={filtros.busqueda}
                      onChange={(e) => setFiltros({ ...filtros, busqueda: e.target.value })}
                      placeholder="Nombre de cliente o proveedor..."
                      className="pl-10 h-9"
                    />
                  </div>
                </div>
                <div>
                  <Label className="text-xs">Fecha Desde</Label>
                  <Input
                    type="date"
                    value={filtros.fecha_desde}
                    onChange={(e) => setFiltros({ ...filtros, fecha_desde: e.target.value })}
                    className="h-9 mt-1"
                  />
                </div>
                <div>
                  <Label className="text-xs">Fecha Hasta</Label>
                  <Input
                    type="date"
                    value={filtros.fecha_hasta}
                    onChange={(e) => setFiltros({ ...filtros, fecha_hasta: e.target.value })}
                    className="h-9 mt-1"
                  />
                </div>
              </div>
              
              <div className="flex items-center gap-2 pt-2 border-t border-slate-100">
                <Switch 
                  checked={mostrarSaldosCero} 
                  onCheckedChange={setMostrarSaldosCero}
                  id="saldos-cero"
                />
                <Label htmlFor="saldos-cero" className="text-xs text-slate-600 cursor-pointer">
                  Mostrar entidades con saldo en cero
                </Label>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Paginaci√≥n de datos del servidor (cargar m√°s entidades) */}
        <div className="mb-4 flex flex-wrap items-center justify-between gap-2 rounded-lg border border-slate-100 bg-slate-50/50 px-4 py-2">
          <span className="text-xs text-slate-600">
            Datos cargados: p√°gina {paginaDatos} ¬∑ {clientes.length} clientes, {proveedores.length} proveedores
            {busquedaServidor && ` ¬∑ b√∫squeda: "${busquedaServidor}"`}
          </span>
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setPaginaDatos(p => Math.max(1, p - 1))}
              disabled={paginaDatos === 1}
              className="h-8 text-xs"
            >
              <ChevronLeft className="h-3 w-3 mr-1" />
              Anterior
            </Button>
            <span className="text-xs text-slate-600">P√°gina {paginaDatos}</span>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setPaginaDatos(p => p + 1)}
              disabled={!tieneMasDatos}
              className="h-8 text-xs"
            >
              Siguiente
              <ChevronRight className="h-3 w-3 ml-1" />
            </Button>
          </div>
        </div>

        {/* Lista de Entidades */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-indigo-600" />
          </div>
        ) : entidadesConSaldo.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <Scale className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay movimientos en cuenta corriente</p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-4">
            <div className="flex justify-end gap-2">
                <Button
                  onClick={() => {
                    const datosFormato = entidadesPaginadas.map(e => ({
                      'Entidad': e.entidad_nombre,
                      'Tipo': e.entidad_tipo,
                      'Movimientos': e.movimientos.length,
                      'Monto Adeudado': e.deuda_real
                    }));
                    exportarExcel(datosFormato, 'cuentas_corrientes');
                  }}
                  size="sm"
                  variant="outline"
                  className="gap-2"
                >
                  <Download className="h-4 w-4" />
                  Excel
                </Button>
                <Button
                  onClick={() => {
                    const html = `
                      <!DOCTYPE html>
                      <html><head><meta charset="UTF-8"><title>Cuentas Corrientes</title>
                      <style>body{font-family:Arial;font-size:10px;padding:20px}h1{text-align:center;margin-bottom:20px}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background:#3b82f6;color:white;font-weight:bold}</style></head><body>
                      <h1>Cuentas Corrientes</h1>
                      <table><thead><tr><th>Entidad</th><th>Tipo</th><th>Movimientos</th><th>Monto Adeudado</th></tr></thead><tbody>
                      ${entidadesPaginadas.map(e => `<tr><td>${e.entidad_nombre}</td><td>${e.entidad_tipo}</td><td>${e.movimientos.length}</td><td>$${e.deuda_real.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td></tr>`).join('')}
                      </tbody></table>
                      <p style="margin-top:20px;text-align:right;font-size:9px">Generado: ${format(new Date(), 'dd/MM/yyyy HH:mm')}</p></body></html>`;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(html);
                    printWindow.document.close();
                    printWindow.onload = () => printWindow.print();
                  }}
                  size="sm"
                  variant="outline"
                  className="gap-2"
                >
                  <FileText className="h-4 w-4" />
                  PDF
                </Button>
            </div>
            <div className="overflow-x-auto border border-slate-100 rounded-lg shadow-sm">
              <table className="w-full">
                <thead>
                  <tr className="bg-slate-50 border-b border-slate-200">
                    <th className="px-4 py-2.5 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Entidad</th>
                    <th className="px-4 py-2.5 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tipo</th>
                    <th className="px-4 py-2.5 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Movs.</th>
                    <th className="px-4 py-2.5 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Saldo</th>
                  </tr>
                </thead>
                <tbody>
                  {entidadesPaginadas.map(entidad => {
                    const saldoCero = Math.abs(entidad.deuda_real) < 0.01;
                    const saldoColor = saldoCero ? 'text-slate-400' : (entidad.deuda_real > 0 ? 'text-rose-600' : 'text-emerald-600');
                    
                    return (
                      <tr 
                        key={`${entidad.entidad_tipo}_${entidad.entidad_id}`}
                        className="border-b border-slate-50 hover:bg-slate-50 cursor-pointer transition-colors"
                        onClick={() => verDetalle(entidad)}
                      >
                        <td className="px-4 py-2.5">
                          <p className="text-sm font-medium text-slate-900">{entidad.entidad_nombre}</p>
                        </td>
                        <td className="px-4 py-2.5">
                          <Badge 
                            variant="outline" 
                            className={`text-[11px] ${entidad.entidad_tipo === 'Cliente' ? 'border-blue-200 text-blue-700 bg-blue-50' : 'border-amber-200 text-amber-700 bg-amber-50'}`}
                          >
                            {entidad.entidad_tipo}
                          </Badge>
                        </td>
                        <td className="px-4 py-2.5 text-center">
                          <p className="text-sm text-slate-600">{entidad.movimientos.length}</p>
                        </td>
                        <td className="px-4 py-2.5 text-right">
                          <p className={`text-base font-semibold ${saldoColor}`}>
                            ${(entidad.deuda_real || 0).toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                          </p>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Paginaci√≥n */}
            {totalPaginas > 1 && (
              <div className="mt-4 flex items-center justify-between border-t border-slate-100 pt-4">
                <div className="text-xs text-slate-500">
                  Mostrando {indicePrimerItem + 1} - {Math.min(indicePrimerItem + ITEMS_POR_PAGINA, entidadesConSaldo.length)} de {entidadesConSaldo.length} entidades
                </div>
                <div className="flex items-center gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPaginaActual(p => Math.max(1, p - 1))}
                    disabled={paginaActual === 1}
                    className="h-8 text-xs"
                  >
                    <ChevronLeft className="h-3 w-3 mr-1" />
                    Anterior
                  </Button>
                  <span className="text-xs text-slate-600 px-3">
                    P√°gina {paginaActual} de {totalPaginas}
                  </span>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPaginaActual(p => Math.min(totalPaginas, p + 1))}
                    disabled={paginaActual === totalPaginas}
                    className="h-8 text-xs"
                  >
                    Siguiente
                    <ChevronRight className="h-3 w-3 ml-1" />
                  </Button>
                </div>
              </div>
            )}

            {/* Bot√≥n Ver m√°s */}
            {!isLoading && entidadesConSaldo.length > 0 && (
              <Card className="border-0 shadow-md mt-4">
                <CardContent className="p-4 text-center">
                  <Button
                    variant="outline"
                    onClick={() => setLimiteMovimientosCC(prev => prev + 50)}
                    className="w-full sm:w-auto"
                  >
                    <ChevronDown className="h-4 w-4 mr-2" />
                    Ver m√°s registros (50 m√°s)
                  </Button>
                  <p className="text-xs text-slate-500 mt-2">
                    Mostrando {Math.min(limiteMovimientosCC, movimientosCC.length)} de {movimientosCC.length} movimientos de cuenta corriente
                  </p>
                </CardContent>
              </Card>
            )}
                </div>
                )}
                </div>
                </div>
                );
                }
</file>

<file path="src/pages/Egresos.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { DollarSign, TrendingDown, Calendar, FileText, Trash2, Edit, Plus, Loader2 } from "lucide-react";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import SearchableSelect from '@/components/SearchableSelect';
import { toast } from 'sonner';

export default function Egresos() {
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState('costos');
  const [showForm, setShowForm] = useState(false);
  const [deleteDialog, setDeleteDialog] = useState({ open: false, egreso: null });

  const [formData, setFormData] = useState({
    fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
    tipo: 'Costo',
    clasificacion: 'Fijo',
    cuenta_id: '',
    concepto: '',
    monto: 0,
    forma_pago: 'Efectivo',
    origen_tipo: 'Caja',
    origen_id: '',
    cheque_id: '',
    proveedor_id: '',
    comprobante: '',
    notas: ''
  });

  const { data: egresos = [] } = useQuery({
    queryKey: ['egresos'],
    queryFn: () => base44.entities.Egreso.list('-fecha')
  });

  const { data: cuentas = [] } = useQuery({
    queryKey: ['plandecuentas'],
    queryFn: () => base44.entities.PlanDeCuentas.filter({ activa: true, imputable: true }, 'codigo')
  });

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list()
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list('nombre')
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list('nombre')
  });

  const { data: cheques = [] } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_pago')
  });

  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria'],
    queryFn: () => base44.entities.MovimientoTesoreria.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const crearMutation = useMutation({
    mutationFn: async (data) => {
      // 1. Crear el egreso
      const egreso = await base44.entities.Egreso.create(data);

      // 2. Actualizar saldo del origen si existe
      if (data.origen_id) {
        if (data.origen_tipo === 'Caja') {
          const caja = cajas.find(c => c.id === data.origen_id);
          if (caja) {
            await base44.entities.Caja.update(data.origen_id, {
              saldo: (caja.saldo || 0) - data.monto
            });
          }
        } else if (data.origen_tipo === 'Banco') {
          const banco = bancos.find(b => b.id === data.origen_id);
          if (banco) {
            await base44.entities.Banco.update(data.origen_id, {
              saldo: (banco.saldo || 0) - data.monto
            });
          }
        }

        // 3. Crear movimiento de tesorer√≠a
        await base44.entities.MovimientoTesoreria.create({
          fecha: data.fecha,
          tipo_movimiento: 'Egreso Manual',
          origen_tipo: data.origen_tipo,
          origen_id: data.origen_id,
          origen_nombre: data.origen_nombre,
          monto: data.monto,
          concepto: `${data.tipo}: ${data.concepto}`,
          comprobante: data.comprobante,
          referencia_origen_id: egreso.id,
          referencia_origen_tipo: 'Egreso'
        });
      }

      return egreso;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['egresos']);
      queryClient.invalidateQueries(['cajas']);
      queryClient.invalidateQueries(['bancos']);
      queryClient.invalidateQueries(['movimientostesoreria']);
      toast.success('Egreso registrado exitosamente');
      resetForm();
    }
  });

  const eliminarMutation = useMutation({
    mutationFn: async (egreso) => {
      // Buscar movimientos de tesorer√≠a vinculados
      const movimientosVinculados = movimientosTesoreria.filter(m => 
        m.referencia_origen_id === egreso.id && m.referencia_origen_tipo === 'Egreso'
      );

      // Revertir saldos de origen
      for (const mov of movimientosVinculados) {
        if (mov.origen_id && mov.origen_tipo) {
          if (mov.origen_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === mov.origen_id);
            if (caja) {
              await base44.entities.Caja.update(mov.origen_id, {
                saldo: (caja.saldo || 0) + mov.monto
              });
            }
          } else if (mov.origen_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === mov.origen_id);
            if (banco) {
              await base44.entities.Banco.update(mov.origen_id, {
                saldo: (banco.saldo || 0) + mov.monto
              });
            }
          }
        }

        // Eliminar movimiento de tesorer√≠a
        await base44.entities.MovimientoTesoreria.delete(mov.id);
      }

      // Eliminar el egreso
      await base44.entities.Egreso.delete(egreso.id);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['egresos']);
      queryClient.invalidateQueries(['cajas']);
      queryClient.invalidateQueries(['bancos']);
      queryClient.invalidateQueries(['movimientostesoreria']);
      toast.success('Egreso eliminado completamente');
      setDeleteDialog({ open: false, egreso: null });
    },
    onError: (error) => {
      console.error('Error al eliminar egreso:', error);
      toast.error('Error al eliminar el egreso');
    }
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    
    if (!formData.cuenta_id) {
      toast.error('Por favor seleccione una cuenta contable');
      return;
    }
    if (!formData.concepto || formData.monto <= 0) {
      toast.error('Complete todos los campos requeridos');
      return;
    }

    const cuenta = cuentas.find(c => c.id === formData.cuenta_id);
    const proveedor = proveedores.find(p => p.id === formData.proveedor_id);
    
    let origen;
    if (formData.origen_id) {
      if (formData.origen_tipo === 'Banco') {
        origen = bancos.find(b => b.id === formData.origen_id);
      } else {
        origen = cajas.find(c => c.id === formData.origen_id);
      }
    }

    crearMutation.mutate({
      ...formData,
      fecha: new Date(formData.fecha).toISOString(),
      tipo: activeTab === 'costos' ? 'Costo' : 'Gasto',
      cuenta_codigo: cuenta?.codigo,
      cuenta_nombre: cuenta?.nombre,
      proveedor_nombre: proveedor?.nombre || '',
      origen_nombre: origen?.nombre || ''
    });
  };

  const resetForm = () => {
    setFormData({
      fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
      tipo: activeTab === 'costos' ? 'Costo' : 'Gasto',
      clasificacion: 'Fijo',
      cuenta_id: '',
      concepto: '',
      monto: 0,
      forma_pago: 'Efectivo',
      origen_tipo: 'Caja',
      origen_id: '',
      cheque_id: '',
      proveedor_id: '',
      comprobante: '',
      notas: ''
    });
    setShowForm(false);
  };

  // Filtrar egresos que tienen movimientos de tesorer√≠a vinculados
  const egresosValidos = egresos.filter(egreso => {
    const tieneMovimientos = movimientosTesoreria.some(m => 
      m.referencia_origen_id === egreso.id && m.referencia_origen_tipo === 'Egreso'
    );
    return tieneMovimientos;
  });

  const egresosFiltrados = egresosValidos.filter(e => e.tipo === (activeTab === 'costos' ? 'Costo' : 'Gasto'));
  const totalFiltrado = egresosFiltrados.reduce((sum, e) => sum + (e.monto || 0), 0);

  const totalFijos = egresosFiltrados.filter(e => e.clasificacion === 'Fijo').reduce((sum, e) => sum + (e.monto || 0), 0);
  const totalVariables = egresosFiltrados.filter(e => e.clasificacion === 'Variable').reduce((sum, e) => sum + (e.monto || 0), 0);

  const cuentasFiltradas = cuentas.filter(c => c.activa !== false && c.imputable !== false);

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-6xl mx-auto">
        <div className="mb-4 md:mb-6">
          <h1 className="text-xl md:text-2xl lg:text-3xl font-bold text-slate-800 flex items-center gap-2 md:gap-3">
            <TrendingDown className="h-6 w-6 md:h-8 md:w-8 text-red-600" />
            Egresos
          </h1>
          <p className="text-sm md:text-base text-slate-600 mt-1">Gesti√≥n de costos y gastos</p>
        </div>

        <Tabs value={activeTab} onValueChange={(val) => {
          setActiveTab(val);
          setShowForm(false);
        }}>
          <TabsList className="grid w-full grid-cols-2 mb-6">
            <TabsTrigger value="costos">Costos</TabsTrigger>
            <TabsTrigger value="gastos">Gastos</TabsTrigger>
          </TabsList>

          <div className="mb-4 md:mb-6">
              <Card className="border-0 shadow-lg">
                <CardContent className="p-4 md:p-6">
                  <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                  <div className="flex items-center gap-3 md:gap-4">
                    <div className="w-10 h-10 md:w-12 md:h-12 bg-red-100 rounded-full flex items-center justify-center shrink-0">
                      <DollarSign className="h-5 w-5 md:h-6 md:w-6 text-red-600" />
                    </div>
                    <div>
                      <p className="text-xs md:text-sm text-slate-500">Total {activeTab === 'costos' ? 'Costos' : 'Gastos'}</p>
                      <p className="text-2xl md:text-3xl font-bold text-red-600">${totalFiltrado.toFixed(2)}</p>
                      <div className="flex flex-wrap gap-2 md:gap-3 text-xs text-slate-400 mt-1">
                        <span>Fijos: ${totalFijos.toFixed(2)}</span>
                        <span>‚Ä¢</span>
                        <span>Var: ${totalVariables.toFixed(2)}</span>
                      </div>
                    </div>
                  </div>
                  <Button onClick={() => setShowForm(!showForm)} className="bg-red-600 hover:bg-red-700 w-full sm:w-auto text-sm md:text-base">
                    <Plus className="h-4 w-4 mr-2" />
                    <span className="hidden sm:inline">Nuevo {activeTab === 'costos' ? 'Costo' : 'Gasto'}</span>
                    <span className="sm:hidden">Nuevo</span>
                  </Button>
                </div>
              </CardContent>
            </Card>
          </div>

          {showForm && (
            <Card className="border-0 shadow-lg mb-6">
              <CardHeader>
                <CardTitle>Registrar {activeTab === 'costos' ? 'Costo' : 'Gasto'}</CardTitle>
              </CardHeader>
              <CardContent>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha *</label>
                      <Input
                        type="datetime-local"
                        value={formData.fecha}
                        onChange={(e) => setFormData({...formData, fecha: e.target.value})}
                        required
                      />
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Clasificaci√≥n *</label>
                      <select
                        value={formData.clasificacion}
                        onChange={(e) => setFormData({...formData, clasificacion: e.target.value})}
                        className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                        required
                      >
                        <option value="Fijo">Fijo</option>
                        <option value="Variable">Variable</option>
                      </select>
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Cuenta Contable *</label>
                      <SearchableSelect
                        options={cuentasFiltradas}
                        value={formData.cuenta_id}
                        onChange={(id, cuenta) => {
                          setFormData({
                            ...formData,
                            cuenta_id: id,
                            cuenta_codigo: cuenta?.codigo || '',
                            cuenta_nombre: cuenta?.nombre || ''
                          });
                        }}
                        displayKey="nombre"
                        placeholder="Seleccionar cuenta..."
                      />
                      {formData.cuenta_id && cuentasFiltradas.find(c => c.id === formData.cuenta_id) && (
                        <p className="text-xs text-slate-500 mt-1">
                          C√≥digo: {cuentasFiltradas.find(c => c.id === formData.cuenta_id)?.codigo}
                        </p>
                      )}
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Concepto *</label>
                      <Input
                        value={formData.concepto}
                        onChange={(e) => setFormData({...formData, concepto: e.target.value})}
                        placeholder="Descripci√≥n del egreso"
                        required
                      />
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Monto *</label>
                      <Input
                        type="number"
                        step="0.01"
                        value={formData.monto}
                        onChange={(e) => setFormData({...formData, monto: parseFloat(e.target.value)})}
                        required
                      />
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Forma de Pago</label>
                      <select
                        value={formData.forma_pago}
                        onChange={(e) => setFormData({...formData, forma_pago: e.target.value, cheque_id: ''})}
                        className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                      >
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Tarjeta">Tarjeta</option>
                      </select>
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Tipo Origen</label>
                      <select
                        value={formData.origen_tipo}
                        onChange={(e) => setFormData({...formData, origen_tipo: e.target.value, origen_id: ''})}
                        className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                      >
                        <option value="Banco">Banco</option>
                        <option value="Caja">Caja</option>
                      </select>
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Origen (Banco/Caja)</label>
                      <SearchableSelect
                        options={formData.origen_tipo === 'Banco' ? bancos : cajas}
                        value={formData.origen_id}
                        onChange={(id) => setFormData({...formData, origen_id: id})}
                        displayKey="nombre"
                        placeholder={`Seleccionar ${formData.origen_tipo.toLowerCase()}...`}
                      />
                    </div>

                    {formData.forma_pago === 'Cheque' && (
                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-1 block">Cheque</label>
                        <SearchableSelect
                          options={cheques.filter(ch => ch.estado === 'Pendiente')}
                          value={formData.cheque_id}
                          onChange={(id) => setFormData({...formData, cheque_id: id})}
                          displayKey="numero_cheque"
                          placeholder="Seleccionar cheque (opcional)..."
                        />
                      </div>
                    )}

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Proveedor (Opcional)</label>
                      <SearchableSelect
                        options={proveedores}
                        value={formData.proveedor_id}
                        onChange={(id) => setFormData({...formData, proveedor_id: id})}
                        displayKey="nombre"
                        placeholder="Seleccionar proveedor..."
                      />
                    </div>

                    <div>
                      <label className="text-sm font-medium text-slate-700 mb-1 block">Comprobante</label>
                      <Input
                        value={formData.comprobante}
                        onChange={(e) => setFormData({...formData, comprobante: e.target.value})}
                        placeholder="N√∫mero de factura/recibo"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm font-medium text-slate-700 mb-1 block">Notas</label>
                    <Textarea
                      value={formData.notas}
                      onChange={(e) => setFormData({...formData, notas: e.target.value})}
                      placeholder="Notas adicionales..."
                      rows={3}
                    />
                  </div>

                  <div className="flex justify-end gap-2">
                    <Button type="button" variant="outline" onClick={resetForm}>
                      Cancelar
                    </Button>
                    <Button type="submit" className="bg-red-600 hover:bg-red-700">
                      Guardar
                    </Button>
                  </div>
                </form>
              </CardContent>
            </Card>
          )}

          <TabsContent value="costos" className="mt-0">
            <EgresosLista 
              egresos={egresosFiltrados}
              onEliminar={(egreso) => setDeleteDialog({ open: true, egreso })}
              tipo="Costo"
            />
          </TabsContent>

          <TabsContent value="gastos" className="mt-0">
            <EgresosLista 
              egresos={egresosFiltrados}
              onEliminar={(egreso) => setDeleteDialog({ open: true, egreso })}
              tipo="Gasto"
            />
          </TabsContent>
        </Tabs>

        {/* Alert Dialog para eliminar */}
        <AlertDialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open, egreso: deleteDialog.egreso })}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>¬øEliminar este egreso?</AlertDialogTitle>
              <AlertDialogDescription className="space-y-2">
                <p>Esta acci√≥n eliminar√° el egreso y revertir√° todos los cambios asociados:</p>
                {deleteDialog.egreso && (
                  <div className="bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                    <p className="font-semibold text-amber-900 mb-2">{deleteDialog.egreso.tipo}: {deleteDialog.egreso.concepto}</p>
                    <p className="text-slate-700">Cuenta: {deleteDialog.egreso.cuenta_nombre}</p>
                    <p className="text-slate-700">Monto: <strong>${(deleteDialog.egreso.monto || 0).toLocaleString('es-AR')}</strong></p>
                    <p className="text-slate-700 mt-2">Se revertir√°n saldos de cajas/bancos y movimientos de tesorer√≠a.</p>
                  </div>
                )}
                <p className="text-xs text-slate-500 mt-2">Esta acci√≥n no se puede deshacer.</p>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel disabled={eliminarMutation.isPending}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={() => deleteDialog.egreso && eliminarMutation.mutate(deleteDialog.egreso)}
                disabled={eliminarMutation.isPending}
                className="bg-red-600 hover:bg-red-700"
              >
                {eliminarMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Eliminando...
                  </>
                ) : (
                  'S√≠, Eliminar Egreso'
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </div>
  );
}

function EgresosLista({ egresos, onEliminar, tipo }) {
  if (egresos.length === 0) {
    return (
      <Card className="border-0 shadow-lg">
        <CardContent className="p-12 text-center">
          <FileText className="h-12 w-12 text-slate-300 mx-auto mb-4" />
          <p className="text-slate-500">No hay {tipo.toLowerCase()}s registrados</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-3">
      {egresos.map(egreso => (
        <Card key={egreso.id} className="border-0 shadow-md hover:shadow-lg transition-shadow">
          <CardContent className="p-4">
            <div className="flex flex-col sm:flex-row items-start justify-between gap-3">
              <div className="flex-1 min-w-0">
                <div className="flex flex-wrap items-center gap-2 mb-2">
                  <Badge variant="outline" className="bg-red-50 text-red-700 text-xs">
                    {egreso.cuenta_codigo}
                  </Badge>
                  <Badge variant={egreso.clasificacion === 'Fijo' ? 'default' : 'secondary'} className="text-xs">
                    {egreso.clasificacion}
                  </Badge>
                  <span className="font-semibold text-sm md:text-base text-slate-800 break-words">{egreso.concepto}</span>
                </div>
                <p className="text-sm text-slate-600 mb-1">{egreso.cuenta_nombre}</p>
                <div className="flex flex-wrap gap-3 text-xs text-slate-500">
                  <span className="flex items-center gap-1">
                    <Calendar className="h-3 w-3" />
                    {format(new Date(egreso.fecha), 'dd/MM/yyyy HH:mm', { locale: es })}
                  </span>
                  {egreso.proveedor_nombre && (
                    <span>Proveedor: {egreso.proveedor_nombre}</span>
                  )}
                  {egreso.comprobante && (
                    <span>Comp: {egreso.comprobante}</span>
                  )}
                </div>
                {egreso.notas && (
                  <p className="text-xs text-slate-500 mt-2">{egreso.notas}</p>
                )}
              </div>
              <div className="flex items-center gap-2 sm:ml-4 shrink-0">
                <div className="text-right">
                  <p className="text-xl md:text-2xl font-bold text-red-600 whitespace-nowrap">${egreso.monto.toFixed(2)}</p>
                </div>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => onEliminar(egreso)}
                  className="text-red-500 hover:text-red-700 shrink-0"
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
</file>

<file path="src/pages/Empleados.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Users, Plus, DollarSign, FileText, Calendar, TrendingUp, AlertCircle, Edit, Trash2, MessageCircle, Loader2, Truck } from "lucide-react";
import { toast } from "sonner";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import LegajoEmpleadoModal from '@/components/empleados/LegajoEmpleadoModal';
import LiquidacionSueldoModal from '@/components/empleados/LiquidacionSueldoModal';
import LiquidacionFleteroModal from '@/components/empleados/LiquidacionFleteroModal';
import FleteroModal from '@/components/empleados/FleteroModal';
import { descargarPDFLiquidacion, compartirWhatsAppLiquidacion } from '@/components/LiquidacionPDFGenerator';

export default function Empleados() {
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState('empleados');
  const [legajoModal, setLegajoModal] = useState({ open: false, item: null });
  const [liquidacionModal, setLiquidacionModal] = useState(false);
  const [fleteroModal, setFleteroModal] = useState({ open: false, item: null });
  const [selectedFletero, setSelectedFletero] = useState(null);
  const [liquidacionFleteroModal, setLiquidacionFleteroModal] = useState(false);
  const [deleteModal, setDeleteModal] = useState({ open: false, item: null, type: 'empleado' });
  const [whatsappModal, setWhatsappModal] = useState({ open: false, liquidacion: null, empleado: null });
  const [ajusteMontoModal, setAjusteMontoModal] = useState({ open: false, item: null });

  const { data: empleados = [] } = useQuery({
    queryKey: ['empleadosacopio'],
    queryFn: () => base44.entities.EmpleadoAcopio.list('-fecha_alta')
  });

  const { data: categorias = [] } = useQuery({
    queryKey: ['categoriasempleado'],
    queryFn: () => base44.entities.CategoriaEmpleado.list('nombre')
  });

  const { data: liquidaciones = [] } = useQuery({
    queryKey: ['liquidaciones'],
    queryFn: () => base44.entities.LiquidacionSueldo.list('-fecha_liquidacion')
  });

  const { data: fleteros = [] } = useQuery({
    queryKey: ['fleteros'],
    queryFn: () => base44.entities.Fletero.list('nombre')
  });

  const { data: historialPrecios = [] } = useQuery({
    queryKey: ['historialpreciofletero'],
    queryFn: () => base44.entities.HistorialPrecioFletero.list('-fecha_desde')
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-created_date')
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-created_date')
  });

  const { data: liquidacionesFleteros = [] } = useQuery({
    queryKey: ['liquidacionesfleteros'],
    queryFn: () => base44.entities.LiquidacionFletero.list('-fecha_liquidacion')
  });

  const guardarEmpleadoMutation = useMutation({
    mutationFn: async (data) => {
      const categoria = categorias.find(c => c.id === data.categoria_empleado_id);
      const empleadoData = {
        ...data,
        categoria_empleado_nombre: categoria?.nombre || ''
      };

      if (data.id) {
        const { id, ...rest } = empleadoData;
        return base44.entities.EmpleadoAcopio.update(id, rest);
      }
      return base44.entities.EmpleadoAcopio.create(empleadoData);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['empleadosacopio']);
      setLegajoModal({ open: false, item: null });
      toast.success('Empleado guardado exitosamente');
    },
    onError: () => toast.error('Error al guardar empleado')
  });

  const eliminarEmpleadoMutation = useMutation({
    mutationFn: (id) => base44.entities.EmpleadoAcopio.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['empleadosacopio']);
      setDeleteModal({ open: false, item: null, type: 'empleado' });
      toast.success('Empleado eliminado');
    },
    onError: () => toast.error('Error al eliminar. Puede tener liquidaciones asociadas.')
  });

  const guardarFleteroMutation = useMutation({
    mutationFn: async (data) => {
      let result;
      if (data.id) {
        const { id, ...rest } = data;
        
        // Verificar si cambi√≥ el precio para crear historial
        const fleteroAnterior = fleteros.find(f => f.id === id);
        if (fleteroAnterior && (
          fleteroAnterior.precio_kg !== data.precio_kg || 
          fleteroAnterior.precio_por_viaje !== data.precio_por_viaje
        )) {
          // Crear registro de historial de precio
          await base44.entities.HistorialPrecioFletero.create({
            fletero_id: id,
            fletero_nombre: data.nombre,
            fecha_desde: new Date().toISOString(),
            precio_kg: data.precio_kg || 0,
            precio_por_viaje: data.precio_por_viaje || 0,
            notas: 'Actualizaci√≥n de precios'
          });
        }
        
        result = await base44.entities.Fletero.update(id, rest);
      } else {
        result = await base44.entities.Fletero.create(data);
        
        // Crear primer registro de historial
        await base44.entities.HistorialPrecioFletero.create({
          fletero_id: result.id,
          fletero_nombre: data.nombre,
          fecha_desde: new Date().toISOString(),
          precio_kg: data.precio_kg || 0,
          precio_por_viaje: data.precio_por_viaje || 0,
          notas: 'Precio inicial'
        });
      }
      return result;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['fleteros']);
      queryClient.invalidateQueries(['historialpreciofletero']);
      setFleteroModal({ open: false, item: null });
      setSelectedFletero(null);
      toast.success('Fletero guardado exitosamente');
    },
    onError: () => toast.error('Error al guardar fletero')
  });

  const ajustarMontoMutation = useMutation({
    mutationFn: async ({ item, nuevoMonto }) => {
      if (item.tipo === 'Salida de Fruta') {
        return base44.entities.SalidaFruta.update(item.salidaId, {
          monto_flete_ajustado: nuevoMonto
        });
      }
      // Para movimientos de envases no se ajusta monto por ahora
      return Promise.resolve();
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['salidas']);
      setAjusteMontoModal({ open: false, item: null });
      toast.success('Monto ajustado correctamente');
    },
    onError: () => toast.error('Error al ajustar monto')
  });

  const recalcularMontosMutation = useMutation({
    mutationFn: async (fleteroId) => {
      // Obtener todas las salidas del fletero sin ajuste manual
      const salidasFletero = salidas.filter(s => 
        s.fletero_id === fleteroId && 
        (s.monto_flete_ajustado === undefined || s.monto_flete_ajustado === null)
      );

      // Recalcular cada salida con el precio vigente de su fecha
      for (const salida of salidasFletero) {
        const kilosSalida = (salida.detalles || []).reduce((total, d) => 
          total + (d.kilos_reales || d.kilos_salida || 0), 0
        );
        const precioKgVigente = obtenerPrecioVigente(fleteroId, salida.fecha, 'kg');
        const nuevoMonto = kilosSalida * precioKgVigente;
        
        // Actualizar con el nuevo monto calculado
        await base44.entities.SalidaFruta.update(salida.id, {
          monto_flete_ajustado: nuevoMonto
        });
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['salidas']);
      toast.success('Montos recalculados seg√∫n precios hist√≥ricos');
    },
    onError: () => toast.error('Error al recalcular montos')
  });

  const eliminarFleteroMutation = useMutation({
    mutationFn: (id) => base44.entities.Fletero.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['fleteros']);
      setDeleteModal({ open: false, item: null, type: 'fletero' });
      setSelectedFletero(null);
      toast.success('Fletero eliminado');
    },
    onError: () => toast.error('Error al eliminar. Puede tener movimientos asociados.')
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list('nombre')
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list('nombre')
  });

  const { data: cheques = [] } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_emision')
  });

  const guardarLiquidacionMutation = useMutation({
    mutationFn: async (data) => {
      const { _pagarAhora, ...liquidacionData } = data;
      
      // Crear la liquidaci√≥n
      const liquidacionCreada = await base44.entities.LiquidacionSueldo.create(liquidacionData);
      
      // Si se paga ahora, crear registro en Pagos y actualizar saldos
      if (_pagarAhora) {
        // Crear pago en tesorer√≠a
        const pagoData = {
          fecha: new Date(liquidacionData.fecha_liquidacion).toISOString(),
          tipo_pago: 'Aplicado',
          monto_disponible: 0,
          concepto: `Liquidaci√≥n Sueldo - ${liquidacionData.periodo} - ${liquidacionData.empleado_nombre}`,
          monto: liquidacionData.total_liquidacion,
          forma_pago: liquidacionData.forma_pago,
          origen_tipo: liquidacionData.origen_tipo,
          origen_id: liquidacionData.origen_id,
          origen_nombre: liquidacionData.origen_nombre,
          cheque_id: liquidacionData.cheque_id || null,
          notas: `Pago de liquidaci√≥n de sueldo. Per√≠odo: ${liquidacionData.periodo}`,
          liquidacion_sueldo_id: liquidacionCreada.id,
          empleado_id: liquidacionData.empleado_id,
          empleado_nombre: liquidacionData.empleado_nombre
        };
        
        const pagoCreado = await base44.entities.Pago.create(pagoData);
        
        // Actualizar liquidaci√≥n con ID del pago
        await base44.entities.LiquidacionSueldo.update(liquidacionCreada.id, {
          pago_id: pagoCreado.id
        });
        
        // Actualizar saldo de banco/caja
        if (liquidacionData.origen_tipo === 'Banco') {
          const banco = bancos.find(b => b.id === liquidacionData.origen_id);
          if (banco) {
            await base44.entities.Banco.update(banco.id, {
              saldo: (banco.saldo || 0) - liquidacionData.total_liquidacion
            });
          }
        } else {
          const caja = cajas.find(c => c.id === liquidacionData.origen_id);
          if (caja) {
            await base44.entities.Caja.update(caja.id, {
              saldo: (caja.saldo || 0) - liquidacionData.total_liquidacion
            });
          }
        }
        
        // Si es cheque, actualizar estado
        if (liquidacionData.forma_pago === 'Cheque' && liquidacionData.cheque_id) {
          await base44.entities.Cheque.update(liquidacionData.cheque_id, {
            estado: 'Cobrado'
          });
        }
      }
      
      return liquidacionCreada;
    },
    onSuccess: (result) => {
      queryClient.invalidateQueries(['liquidaciones']);
      queryClient.invalidateQueries(['pagos']);
      queryClient.invalidateQueries(['bancos']);
      queryClient.invalidateQueries(['cajas']);
      queryClient.invalidateQueries(['cheques']);
      setLiquidacionModal(false);
      const empleado = empleados.find(e => e.id === result.empleado_id);
      setWhatsappModal({ open: true, liquidacion: result, empleado });
      toast.success('Liquidaci√≥n guardada exitosamente');
    },
    onError: () => toast.error('Error al guardar liquidaci√≥n')
  });

  const guardarLiquidacionFleteroMutation = useMutation({
    mutationFn: async (data) => {
      const { _pagarAhora, ...liquidacionData } = data;
      
      // Crear la liquidaci√≥n
      const liquidacionCreada = await base44.entities.LiquidacionFletero.create(liquidacionData);
      
      // Si se paga ahora, crear registro en Pagos y actualizar saldos
      if (_pagarAhora) {
        const pagoData = {
          fecha: new Date(liquidacionData.fecha_liquidacion).toISOString(),
          tipo_pago: 'Aplicado',
          monto_disponible: 0,
          concepto: `Liquidaci√≥n Fletero - ${liquidacionData.periodo} - ${liquidacionData.fletero_nombre}`,
          monto: liquidacionData.total_liquidacion,
          forma_pago: liquidacionData.forma_pago,
          origen_tipo: liquidacionData.origen_tipo,
          origen_id: liquidacionData.origen_id,
          origen_nombre: liquidacionData.origen_nombre,
          cheque_id: liquidacionData.cheque_id || null,
          notas: `Pago de liquidaci√≥n de fletero. Per√≠odo: ${liquidacionData.periodo}`,
          proveedor_id: liquidacionData.fletero_id,
          proveedor_nombre: liquidacionData.fletero_nombre
        };
        
        const pagoCreado = await base44.entities.Pago.create(pagoData);
        
        // Actualizar liquidaci√≥n con ID del pago
        await base44.entities.LiquidacionFletero.update(liquidacionCreada.id, {
          pago_id: pagoCreado.id
        });
        
        // Actualizar saldo de banco/caja
        if (liquidacionData.origen_tipo === 'Banco') {
          const banco = bancos.find(b => b.id === liquidacionData.origen_id);
          if (banco) {
            await base44.entities.Banco.update(banco.id, {
              saldo: (banco.saldo || 0) - liquidacionData.total_liquidacion
            });
          }
        } else {
          const caja = cajas.find(c => c.id === liquidacionData.origen_id);
          if (caja) {
            await base44.entities.Caja.update(caja.id, {
              saldo: (caja.saldo || 0) - liquidacionData.total_liquidacion
            });
          }
        }
        
        // Si es cheque, actualizar estado
        if (liquidacionData.forma_pago === 'Cheque' && liquidacionData.cheque_id) {
          await base44.entities.Cheque.update(liquidacionData.cheque_id, {
            estado: 'Cobrado'
          });
        }
      }
      
      return liquidacionCreada;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['liquidacionesfleteros']);
      queryClient.invalidateQueries(['pagos']);
      queryClient.invalidateQueries(['bancos']);
      queryClient.invalidateQueries(['cajas']);
      queryClient.invalidateQueries(['cheques']);
      setLiquidacionFleteroModal(false);
      toast.success('‚úÖ Liquidaci√≥n de fletero guardada exitosamente');
    },
    onError: () => toast.error('Error al guardar liquidaci√≥n de fletero')
  });

  // Funci√≥n auxiliar para obtener precio vigente seg√∫n fecha
  const obtenerPrecioVigente = (fleteroId, fecha, tipoPrecio = 'kg') => {
    const preciosOrdenados = historialPrecios
      .filter(hp => hp.fletero_id === fleteroId)
      .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
    
    const fechaMovimiento = new Date(fecha);
    const precioVigente = preciosOrdenados.find(hp => new Date(hp.fecha_desde) <= fechaMovimiento);
    
    if (precioVigente) {
      return tipoPrecio === 'kg' ? precioVigente.precio_kg : precioVigente.precio_por_viaje;
    }
    
    // Fallback al precio actual del fletero
    const fletero = fleteros.find(f => f.id === fleteroId);
    return tipoPrecio === 'kg' ? (fletero?.precio_kg || 0) : (fletero?.precio_por_viaje || 0);
  };

  // Funci√≥n para calcular datos econ√≥micos e hist√≥ricos del fletero
  const calcularDatosFletero = (fleteroId) => {
    if (!fleteroId) return { 
      viajesEnvases: 0, 
      salidasFruta: 0, 
      totalKilosTransportados: 0,
      montoAPagar: 0,
      historial: []
    };
    
    const fletero = fleteros.find(f => f.id === fleteroId);
    
    // Contar l√≠neas de movimiento_envases contabilizadas
    let viajesEnvases = 0;
    const movimientosEnvases = movimientos
      .filter(m => m.fletero_id === fleteroId && m.tipo_movimiento === 'Movimiento de Envases');
    
    movimientosEnvases.forEach(m => {
      if (m.movimiento_envases) {
        viajesEnvases += m.movimiento_envases.filter(env => env.contabilizar_viaje === true).length;
      }
    });
    
    // Contar salidas de fruta y kilos transportados
    const salidasFletero = salidas.filter(s => s.fletero_id === fleteroId);
    const totalKilosTransportados = salidasFletero.reduce((sum, s) => {
      const kilosSalida = (s.detalles || []).reduce((total, d) => 
        total + (d.kilos_reales || d.kilos_salida || 0), 0
      );
      return sum + kilosSalida;
    }, 0);
    
    // Calcular monto a pagar considerando ajustes manuales
    let montoAPagar = 0;
    salidasFletero.forEach(s => {
      if (s.monto_flete_ajustado !== undefined && s.monto_flete_ajustado !== null) {
        montoAPagar += s.monto_flete_ajustado;
      } else {
        const kilosSalida = (s.detalles || []).reduce((total, d) => 
          total + (d.kilos_reales || d.kilos_salida || 0), 0
        );
        const precioKgVigente = obtenerPrecioVigente(fleteroId, s.fecha, 'kg');
        montoAPagar += kilosSalida * precioKgVigente;
      }
    });
    
    // Agregar montos de viajes de envases contabilizados
    movimientosEnvases.forEach(m => {
      if (m.movimiento_envases) {
        const viajesContabilizados = m.movimiento_envases.filter(env => env.contabilizar_viaje === true);
        viajesContabilizados.forEach(() => {
          const precioViajeVigente = obtenerPrecioVigente(fleteroId, m.fecha, 'viaje');
          montoAPagar += precioViajeVigente;
        });
      }
    });
    
    // Generar historial combinado
    const historial = [];
    
    // Agregar salidas de fruta
    salidasFletero.forEach(s => {
      const kilosSalida = (s.detalles || []).reduce((total, d) => 
        total + (d.kilos_reales || d.kilos_salida || 0), 0
      );
      const precioKgVigente = obtenerPrecioVigente(fleteroId, s.fecha, 'kg');
      const montoCalculado = kilosSalida * precioKgVigente;
      const montoFinal = s.monto_flete_ajustado !== undefined && s.monto_flete_ajustado !== null
        ? s.monto_flete_ajustado
        : montoCalculado;
      
      historial.push({
        id: s.id,
        salidaId: s.id,
        fecha: s.fecha,
        tipo: 'Salida de Fruta',
        descripcion: `${s.cliente_nombre} - ${s.numero_remito}`,
        kilos: kilosSalida,
        monto: montoFinal,
        montoCalculado: montoCalculado,
        precioKgVigente: precioKgVigente,
        esAjusteManual: s.monto_flete_ajustado !== undefined && s.monto_flete_ajustado !== null,
        editable: true
      });
    });
    
    // Agregar movimientos de envases contabilizados
    movimientosEnvases.forEach(m => {
      if (m.movimiento_envases) {
        m.movimiento_envases
          .filter(env => env.contabilizar_viaje === true)
          .forEach(env => {
            const precioViajeVigente = obtenerPrecioVigente(fleteroId, m.fecha, 'viaje');
            historial.push({
              id: m.id,
              movimientoId: m.id,
              fecha: m.fecha,
              tipo: 'Mov. Envases',
              descripcion: `${m.proveedor_nombre || m.cliente_nombre} - ${env.envase_tipo}`,
              cantidad_envases: (env.cantidad_ingreso || 0) + (env.cantidad_salida || 0),
              kilos: 0,
              monto: precioViajeVigente,
              precioViajeVigente: precioViajeVigente,
              contabilizado: true
            });
          });
      }
    });
    
    // Ordenar por fecha descendente
    historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    return {
      viajesEnvases,
      salidasFruta: salidasFletero.length,
      totalKilosTransportados,
      montoAPagar,
      historial
    };
  };

  // KPIs - UNIFICADOS (Empleados + Fleteros)
  const empleadosActivos = empleados.filter(e => e.activo);
  const fleterosActivos = fleteros.filter(f => f.activo);
  const totalPersonalActivo = empleadosActivos.length + fleterosActivos.length;
  const totalPersonalGeneral = empleados.length + fleteros.length;
  const totalSueldosPagados = liquidaciones.filter(l => l.estado === 'Pagada').reduce((sum, l) => sum + (l.total_liquidacion || 0), 0);
  const totalSueldosPendientes = liquidaciones.filter(l => l.estado === 'Pendiente').reduce((sum, l) => sum + (l.total_liquidacion || 0), 0);
  const liquidacionesMesActual = liquidaciones.filter(l => {
    const fecha = new Date(l.fecha_liquidacion);
    const hoy = new Date();
    return fecha.getMonth() === hoy.getMonth() && fecha.getFullYear() === hoy.getFullYear();
  }).length;

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div>
          <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
            <Users className="h-8 w-8 text-purple-600" />
            Gesti√≥n de Empleados
          </h1>
          <p className="text-slate-600 mt-1">Administraci√≥n de personal, legajos y liquidaci√≥n de sueldos</p>
        </div>

        {/* KPIs Dashboard */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <Card className="border-0 shadow-md bg-gradient-to-br from-purple-50 to-purple-100">
            <CardContent className="p-5">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-purple-700 uppercase tracking-wide mb-1">Empleados Activos</p>
                  <p className="text-3xl font-bold text-purple-800">{totalPersonalActivo}</p>
                  <p className="text-xs text-purple-600 mt-1">de {totalPersonalGeneral} totales</p>
                </div>
                <Users className="h-12 w-12 text-purple-500 opacity-40" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-md bg-gradient-to-br from-green-50 to-green-100">
            <CardContent className="p-5">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-green-700 uppercase tracking-wide mb-1">Sueldos Pagados</p>
                  <p className="text-3xl font-bold text-green-800">${(totalSueldosPagados / 1000).toFixed(0)}K</p>
                  <p className="text-xs text-green-600 mt-1">Total hist√≥rico</p>
                </div>
                <DollarSign className="h-12 w-12 text-green-500 opacity-40" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-md bg-gradient-to-br from-amber-50 to-amber-100">
            <CardContent className="p-5">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-amber-700 uppercase tracking-wide mb-1">Sueldos Pendientes</p>
                  <p className="text-3xl font-bold text-amber-800">${(totalSueldosPendientes / 1000).toFixed(0)}K</p>
                  <p className="text-xs text-amber-600 mt-1">Por pagar</p>
                </div>
                <AlertCircle className="h-12 w-12 text-amber-500 opacity-40" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-md bg-gradient-to-br from-blue-50 to-blue-100">
            <CardContent className="p-5">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-blue-700 uppercase tracking-wide mb-1">Liquidaciones Mes</p>
                  <p className="text-3xl font-bold text-blue-800">{liquidacionesMesActual}</p>
                  <p className="text-xs text-blue-600 mt-1">{format(new Date(), 'MMMM yyyy', { locale: es })}</p>
                </div>
                <Calendar className="h-12 w-12 text-blue-500 opacity-40" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Tabs para Empleados y Fleteros */}
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="mb-4">
            <TabsTrigger value="empleados" className="gap-2">
              <Users className="h-4 w-4" />
              Empleados
            </TabsTrigger>
            <TabsTrigger value="fleteros" className="gap-2">
              <Truck className="h-4 w-4" />
              Fleteros
            </TabsTrigger>
          </TabsList>

          {/* TAB EMPLEADOS */}
          <TabsContent value="empleados" className="space-y-6">
            {/* Acciones Principales */}
            <div className="flex gap-3">
              <Button onClick={() => setLegajoModal({ open: true, item: null })} className="bg-purple-600 hover:bg-purple-700">
                <Plus className="h-4 w-4 mr-2" />
                Cargar Nuevo Empleado
              </Button>
              <Button onClick={() => setLiquidacionModal(true)} className="bg-green-600 hover:bg-green-700">
                <DollarSign className="h-4 w-4 mr-2" />
                Liquidar Sueldos
              </Button>
            </div>

            {/* Lista de Empleados */}
            <Card className="border-0 shadow-lg">
          <CardContent className="p-6">
            <h3 className="text-lg font-semibold mb-4">Personal Registrado</h3>
            {empleados.length === 0 ? (
              <div className="text-center py-16">
                <Users className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                <p className="text-slate-500 mb-4">No hay empleados registrados</p>
                <Button onClick={() => setLegajoModal({ open: true, item: null })} variant="outline">
                  <Plus className="h-4 w-4 mr-2" />
                  Cargar Primer Empleado
                </Button>
              </div>
            ) : (
              <div className="space-y-3">
                {empleados.map(emp => (
                  <Card key={emp.id} className="border hover:shadow-md transition-all">
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-2 flex-wrap">
                            <h4 className="font-semibold text-slate-800 text-lg">{emp.nombre}</h4>
                            <Badge variant={emp.activo ? 'default' : 'secondary'}>
                              {emp.activo ? 'Activo' : 'Inactivo'}
                            </Badge>
                            <Badge variant="outline" className="bg-blue-50">
                              {emp.categoria_empleado_nombre}
                            </Badge>
                          </div>
                          
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm text-slate-600">
                            {emp.cuit_dni && (
                              <div>
                                <span className="text-xs text-slate-500">CUIL/DNI:</span>
                                <p className="font-medium">{emp.cuit_dni}</p>
                              </div>
                            )}
                            {emp.whatsapp && (
                              <div>
                                <span className="text-xs text-slate-500">WhatsApp:</span>
                                <p className="font-medium">{emp.whatsapp}</p>
                              </div>
                            )}
                            <div>
                              <span className="text-xs text-slate-500">Fecha Alta:</span>
                              <p className="font-medium">{format(new Date(emp.fecha_alta), 'dd/MM/yyyy', { locale: es })}</p>
                            </div>
                            {emp.sueldo_base > 0 && (
                              <div>
                                <span className="text-xs text-slate-500">Sueldo Base:</span>
                                <p className="font-semibold text-green-600">${emp.sueldo_base.toLocaleString('es-AR')}</p>
                              </div>
                            )}
                          </div>

                          {emp.direccion && (
                            <p className="text-sm text-slate-600 mt-2">üìç {emp.direccion}</p>
                          )}
                        </div>

                        <div className="flex gap-2 shrink-0">
                          <Button variant="outline" size="sm" onClick={() => setLegajoModal({ open: true, item: emp })}>
                            <Edit className="h-4 w-4 mr-1" />
                            Editar
                          </Button>
                          <Button variant="ghost" size="icon" onClick={() => setDeleteModal({ open: true, item: emp })} className="text-red-500">
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
                </div>
                )}
                </CardContent>
                </Card>

                {/* Historial de Liquidaciones */}
                <Card className="border-0 shadow-lg">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">Historial de Liquidaciones</h3>
            </div>

            {liquidaciones.length === 0 ? (
              <div className="text-center py-12">
                <FileText className="h-12 w-12 text-slate-300 mx-auto mb-4" />
                <p className="text-slate-500">No hay liquidaciones registradas</p>
              </div>
            ) : (
              <div className="space-y-3">
                {liquidaciones.map(liq => (
                  <Card key={liq.id} className="border">
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2 flex-wrap">
                            <h4 className="font-semibold text-slate-800">{liq.empleado_nombre}</h4>
                            <Badge variant={liq.estado === 'Pagada' ? 'default' : 'secondary'}>
                              {liq.estado}
                            </Badge>
                          </div>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div>
                              <span className="text-xs text-slate-500">Per√≠odo:</span>
                              <p className="font-medium">{liq.periodo}</p>
                            </div>
                            <div>
                              <span className="text-xs text-slate-500">Fecha Pago:</span>
                              <p className="font-medium">{format(new Date(liq.fecha_pago), 'dd/MM/yyyy', { locale: es })}</p>
                            </div>
                            <div>
                              <span className="text-xs text-slate-500">Total:</span>
                              <p className="font-bold text-green-600">${liq.total_liquidacion.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</p>
                            </div>
                          </div>
                        </div>
                        <div className="flex gap-2 shrink-0">
                          <Button 
                            variant="outline" 
                            size="sm" 
                            onClick={() => {
                              const emp = empleados.find(e => e.id === liq.empleado_id);
                              descargarPDFLiquidacion(liq, emp);
                            }}
                          >
                            <FileText className="h-4 w-4 mr-1" />
                            PDF
                          </Button>
                          <Button 
                            variant="outline" 
                            size="sm" 
                            className="text-green-600"
                            onClick={() => {
                              const emp = empleados.find(e => e.id === liq.empleado_id);
                              setWhatsappModal({ open: true, liquidacion: liq, empleado: emp });
                            }}
                          >
                            <MessageCircle className="h-4 w-4 mr-1" />
                            Enviar
                          </Button>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
              )}
              </CardContent>
              </Card>
              </TabsContent>

              {/* TAB FLETEROS */}
              <TabsContent value="fleteros" className="space-y-6">
              <div className="flex gap-3">
                <Button onClick={() => setFleteroModal({ open: true, item: null })} className="bg-orange-600 hover:bg-orange-700">
                  <Plus className="h-4 w-4 mr-2" />
                  Nuevo Fletero
                </Button>
                {selectedFletero && (
                  <Button onClick={() => setLiquidacionFleteroModal(true)} className="bg-green-600 hover:bg-green-700">
                    <DollarSign className="h-4 w-4 mr-2" />
                    Liquidar Sueldo
                  </Button>
                )}
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Lista de Fleteros */}
              <Card className="lg:col-span-1 border-0 shadow-lg">
                <CardContent className="p-4">
                  <h3 className="font-semibold mb-4 flex items-center gap-2">
                    <Truck className="h-5 w-5 text-orange-600" />
                    Fleteros Registrados
                  </h3>
                  {fleteros.length === 0 ? (
                    <div className="text-center py-8">
                      <Truck className="h-12 w-12 text-slate-300 mx-auto mb-3" />
                      <p className="text-slate-500 text-sm">No hay fleteros registrados</p>
                    </div>
                  ) : (
                    <div className="space-y-2 max-h-[600px] overflow-y-auto">
                      {fleteros.map(fletero => (
                        <button
                          key={fletero.id}
                          onClick={() => setSelectedFletero(fletero)}
                          className={`w-full text-left p-3 rounded-lg border transition-all ${
                            selectedFletero?.id === fletero.id 
                              ? 'bg-orange-50 border-orange-300 shadow-sm' 
                              : 'bg-white border-slate-200 hover:border-slate-300'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-1">
                            <p className="font-semibold text-slate-800 text-sm">{fletero.nombre}</p>
                            <Badge variant={fletero.activo ? 'default' : 'secondary'} className="text-xs">
                              {fletero.activo ? 'Activo' : 'Inactivo'}
                            </Badge>
                          </div>
                          {fletero.whatsapp && (
                            <p className="text-xs text-slate-600">üì± {fletero.whatsapp}</p>
                          )}
                          {fletero.precio_kg > 0 && (
                            <p className="text-xs text-green-600 font-semibold mt-1">
                              ${fletero.precio_kg}/kg
                            </p>
                          )}
                        </button>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Panel de Informaci√≥n del Fletero */}
              <Card className="lg:col-span-2 border-0 shadow-lg">
                <CardContent className="p-6">
                  {!selectedFletero ? (
                    <div className="text-center py-16">
                      <Truck className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                      <p className="text-slate-500">Seleccione un fletero para ver su informaci√≥n</p>
                    </div>
                  ) : (
                    <div className="space-y-6">
                      {/* Header con acciones */}
                      <div className="flex items-start justify-between pb-4 border-b">
                        <div>
                          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <Truck className="h-6 w-6 text-orange-600" />
                            {selectedFletero.nombre}
                          </h2>
                          <Badge variant={selectedFletero.activo ? 'default' : 'secondary'} className="mt-2">
                            {selectedFletero.activo ? 'Activo' : 'Inactivo'}
                          </Badge>
                        </div>
                        <div className="flex gap-2">
                          <Button 
                            variant="outline" 
                            size="sm" 
                            onClick={() => setFleteroModal({ open: true, item: selectedFletero })}
                          >
                            <Edit className="h-4 w-4 mr-1" />
                            Editar
                          </Button>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => setDeleteModal({ open: true, item: selectedFletero, type: 'fletero' })} 
                            className="text-red-500"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>

                      {/* Informaci√≥n de Contacto */}
                      <div className="grid grid-cols-2 gap-4">
                        <Card className="bg-slate-50">
                          <CardContent className="p-4">
                            <p className="text-xs text-slate-500 mb-1">Direcci√≥n</p>
                            <p className="font-medium text-slate-800">
                              {selectedFletero.direccion || 'No especificada'}
                            </p>
                          </CardContent>
                        </Card>
                        <Card className="bg-slate-50">
                          <CardContent className="p-4">
                            <p className="text-xs text-slate-500 mb-1">WhatsApp</p>
                            <p className="font-medium text-slate-800">
                              {selectedFletero.whatsapp || 'No especificado'}
                            </p>
                          </CardContent>
                        </Card>
                      </div>

                      {/* Resumen Econ√≥mico */}
                      <div>
                        <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                          <TrendingUp className="h-5 w-5 text-green-600" />
                          Resumen Econ√≥mico
                        </h3>
                        {(() => {
                          const datos = calcularDatosFletero(selectedFletero.id);
                          return (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                              <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                                <CardContent className="p-4">
                                  <p className="text-xs text-blue-700 mb-1">Salidas de Fruta</p>
                                  <p className="text-2xl font-bold text-blue-700">
                                    {datos.salidasFruta}
                                  </p>
                                  <p className="text-xs text-blue-600 mt-1">
                                    Total transportado
                                  </p>
                                </CardContent>
                              </Card>
                              <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                                <CardContent className="p-4">
                                  <p className="text-xs text-purple-700 mb-1">Kilos Totales</p>
                                  <p className="text-2xl font-bold text-purple-700">
                                    {datos.totalKilosTransportados.toFixed(0)}
                                  </p>
                                  <p className="text-xs text-purple-600 mt-1">
                                    kg transportados
                                  </p>
                                </CardContent>
                              </Card>
                              <Card className="bg-gradient-to-br from-amber-50 to-amber-100 border-amber-200">
                                <CardContent className="p-4">
                                  <p className="text-xs text-amber-700 mb-1">Viajes Envases</p>
                                  <p className="text-2xl font-bold text-amber-700">
                                    {datos.viajesEnvases}
                                  </p>
                                  <p className="text-xs text-amber-600 mt-1">
                                    Contabilizados
                                  </p>
                                </CardContent>
                              </Card>
                              <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                                <CardContent className="p-4">
                                  <p className="text-xs text-green-700 mb-1">Monto a Pagar</p>
                                  <p className="text-2xl font-bold text-green-700">
                                    ${((datos.totalKilosTransportados * (selectedFletero.precio_kg || 0)) + (datos.viajesEnvases * (selectedFletero.precio_por_viaje || 0))).toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                  </p>
                                  <p className="text-xs text-green-600 mt-1">
                                    Pendiente
                                  </p>
                                </CardContent>
                              </Card>
                            </div>
                          );
                        })()}
                      </div>

                      {/* Configuraci√≥n de Pagos */}
                      <div>
                        <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                          <DollarSign className="h-5 w-5 text-slate-600" />
                          Configuraci√≥n de Pagos
                        </h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                            <CardContent className="p-4">
                              <p className="text-xs text-green-700 mb-1">Precio por Kilogramo</p>
                              <p className="text-2xl font-bold text-green-700">
                                ${selectedFletero.precio_kg?.toFixed(2) || '0.00'}
                              </p>
                              <p className="text-xs text-green-600 mt-1">
                                Para salidas de fruta
                              </p>
                            </CardContent>
                          </Card>
                          <Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
                            <CardContent className="p-4">
                              <p className="text-xs text-orange-700 mb-1">Precio por Viaje</p>
                              <p className="text-2xl font-bold text-orange-700">
                                ${selectedFletero.precio_por_viaje?.toFixed(2) || '0.00'}
                              </p>
                              <p className="text-xs text-orange-600 mt-1">
                                Para movimientos de envases
                              </p>
                            </CardContent>
                          </Card>
                          <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                            <CardContent className="p-4">
                              <p className="text-xs text-blue-700 mb-1">Frecuencia de Pago</p>
                              <p className="text-lg font-bold text-blue-700">
                                {selectedFletero.frecuencia_pago || 'No especificada'}
                              </p>
                            </CardContent>
                          </Card>
                          <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                            <CardContent className="p-4">
                              <p className="text-xs text-purple-700 mb-1">D√≠a de Vencimiento</p>
                              <p className="text-lg font-bold text-purple-700">
                                {selectedFletero.dia_vencimiento ? `D√≠a ${selectedFletero.dia_vencimiento}` : 'No especificado'}
                              </p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* Historial de Movimientos */}
                      <div>
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                            <FileText className="h-5 w-5 text-slate-600" />
                            Historial de Transportes
                          </h3>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => recalcularMontosMutation.mutate(selectedFletero.id)}
                            disabled={recalcularMontosMutation.isPending}
                          >
                            {recalcularMontosMutation.isPending ? (
                              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                            ) : (
                              <TrendingUp className="h-4 w-4 mr-2" />
                            )}
                            Recalcular Montos
                          </Button>
                        </div>
                        {(() => {
                          const datos = calcularDatosFletero(selectedFletero.id);
                          return datos.historial.length === 0 ? (
                            <Card className="bg-slate-50">
                              <CardContent className="p-8 text-center">
                                <Truck className="h-12 w-12 text-slate-300 mx-auto mb-3" />
                                <p className="text-slate-500">No hay transportes registrados para este fletero</p>
                              </CardContent>
                            </Card>
                          ) : (
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                              {datos.historial.map((item, idx) => (
                                <Card key={`${item.id}-${idx}`} className="border hover:shadow-sm transition-shadow">
                                  <CardContent className="p-3">
                                    <div className="flex items-start justify-between gap-3">
                                      <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 mb-1 flex-wrap">
                                          <Badge variant={item.tipo === 'Salida de Fruta' ? 'default' : 'outline'} className="text-xs">
                                            {item.tipo}
                                          </Badge>
                                          {item.contabilizado && (
                                            <Badge className="bg-amber-200 text-amber-900 text-xs">
                                              ‚úì Contabilizado
                                            </Badge>
                                          )}
                                          {item.esAjusteManual && (
                                            <Badge className="bg-orange-200 text-orange-900 text-xs">
                                              ‚öôÔ∏è Ajuste Manual
                                            </Badge>
                                          )}
                                        </div>
                                        <p className="text-sm font-medium text-slate-800 truncate">{item.descripcion}</p>
                                        <p className="text-xs text-slate-500 mt-1">
                                          {format(new Date(item.fecha), 'dd/MM/yyyy HH:mm', { locale: es })}
                                        </p>
                                        {item.esAjusteManual && (
                                          <p className="text-xs text-orange-600 mt-1">
                                            Original: ${item.montoCalculado.toLocaleString('es-AR', { minimumFractionDigits: 0 })} 
                                            {' '} (Dif: ${(item.monto - item.montoCalculado).toLocaleString('es-AR', { minimumFractionDigits: 0, signDisplay: 'always' })})
                                          </p>
                                        )}
                                      </div>
                                      <div className="text-right shrink-0">
                                        {item.kilos > 0 && (
                                          <>
                                            <p className="text-sm font-semibold text-purple-600">
                                              {item.kilos.toFixed(0)} kg
                                            </p>
                                            <div className="flex items-center gap-2">
                                              <p className="text-lg font-bold text-green-600">
                                                ${(item.kilos * (selectedFletero.precio_kg || 0)).toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                                              </p>
                                              {item.editable && (
                                                <Button 
                                                  variant="ghost" 
                                                  size="icon" 
                                                  className="h-6 w-6"
                                                  onClick={() => setAjusteMontoModal({ open: true, item })}
                                                >
                                                  <Edit className="h-3 w-3" />
                                                </Button>
                                              )}
                                            </div>
                                            <p className="text-xs text-slate-500">
                                              Precio: ${(selectedFletero.precio_kg || 0).toFixed(2)}/kg
                                            </p>
                                          </>
                                        )}
                                        {item.cantidad_envases > 0 && (
                                          <>
                                            <p className="text-sm text-slate-600">
                                              {item.cantidad_envases} envases
                                            </p>
                                            <p className="text-lg font-bold text-orange-600">
                                              ${(selectedFletero.precio_por_viaje || 0).toLocaleString('es-AR', { minimumFractionDigits: 0 })}
                                            </p>
                                            <p className="text-xs text-slate-500">
                                              Precio: ${(selectedFletero.precio_por_viaje || 0).toFixed(2)}/viaje
                                            </p>
                                          </>
                                        )}
                                      </div>
                                    </div>
                                  </CardContent>
                                </Card>
                              ))}
                            </div>
                          );
                        })()}
                      </div>

                      {/* Liquidaciones del Fletero */}
                      <div>
                        <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                          <DollarSign className="h-5 w-5 text-green-600" />
                          Historial de Liquidaciones
                        </h3>
                        {(() => {
                          const liquidacionesFletero = liquidacionesFleteros.filter(
                            liq => liq.fletero_id === selectedFletero.id
                          );
                          
                          return liquidacionesFletero.length === 0 ? (
                            <Card className="bg-slate-50">
                              <CardContent className="p-8 text-center">
                                <FileText className="h-12 w-12 text-slate-300 mx-auto mb-3" />
                                <p className="text-slate-500">No hay liquidaciones registradas para este fletero</p>
                              </CardContent>
                            </Card>
                          ) : (
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                              {liquidacionesFletero.map(liq => (
                                <Card key={liq.id} className="border hover:shadow-sm transition-shadow">
                                  <CardContent className="p-4">
                                    <div className="flex items-start justify-between gap-4">
                                      <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-2 flex-wrap">
                                          <Badge variant={liq.estado === 'Pagada' ? 'default' : 'secondary'} className="bg-green-100 text-green-800">
                                            {liq.estado}
                                          </Badge>
                                          <span className="text-sm font-semibold text-slate-800">{liq.periodo}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 text-sm">
                                          <div>
                                            <span className="text-xs text-slate-500">Salidas de fruta:</span>
                                            <p className="font-medium text-slate-700">
                                              {liq.salidas_fruta?.length || 0} salidas ‚Ä¢ ${(liq.total_salidas_fruta || 0).toLocaleString('es-AR')}
                                            </p>
                                          </div>
                                          <div>
                                            <span className="text-xs text-slate-500">Viajes de envases:</span>
                                            <p className="font-medium text-slate-700">
                                              {liq.viajes_envases?.length || 0} viajes ‚Ä¢ ${(liq.total_viajes_envases || 0).toLocaleString('es-AR')}
                                            </p>
                                          </div>
                                          <div>
                                            <span className="text-xs text-slate-500">Fecha Pago:</span>
                                            <p className="font-medium text-slate-700">
                                              {format(new Date(liq.fecha_pago), 'dd/MM/yyyy', { locale: es })}
                                            </p>
                                          </div>
                                          {liq.forma_pago && (
                                            <div>
                                              <span className="text-xs text-slate-500">Forma de Pago:</span>
                                              <p className="font-medium text-slate-700">{liq.forma_pago}</p>
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                      <div className="text-right shrink-0">
                                        <p className="text-xs text-slate-500 mb-1">Total</p>
                                        <p className="text-2xl font-bold text-green-600">
                                          ${liq.total_liquidacion.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                        </p>
                                        {liq.estado === 'Pago Parcial' && (
                                          <p className="text-xs text-amber-600 mt-1">
                                            Pagado: ${(liq.monto_pagado || 0).toLocaleString('es-AR')}
                                          </p>
                                        )}
                                      </div>
                                    </div>
                                  </CardContent>
                                </Card>
                              ))}
                            </div>
                          );
                        })()}
                      </div>

                      {/* Notas */}
                      {selectedFletero.notas && (
                        <div>
                          <h3 className="font-semibold text-slate-800 mb-2">Notas Adicionales</h3>
                          <Card className="bg-amber-50 border-amber-200">
                            <CardContent className="p-4">
                              <p className="text-sm text-slate-700 whitespace-pre-wrap">
                                {selectedFletero.notas}
                              </p>
                            </CardContent>
                          </Card>
                        </div>
                      )}
                    </div>
                  )}
                </CardContent>
              </Card>
              </div>
              </TabsContent>
              </Tabs>
              </div>

              {/* Modales */}
              <LegajoEmpleadoModal
        open={legajoModal.open}
        empleado={legajoModal.item}
        categorias={categorias}
        onClose={() => setLegajoModal({ open: false, item: null })}
        onSave={(data) => guardarEmpleadoMutation.mutate(data)}
        isLoading={guardarEmpleadoMutation.isPending}
      />

      <LiquidacionSueldoModal
        open={liquidacionModal}
        empleados={empleados.filter(e => e.activo)}
        categorias={categorias}
        onClose={() => setLiquidacionModal(false)}
        onSave={(data) => guardarLiquidacionMutation.mutate(data)}
        isLoading={guardarLiquidacionMutation.isPending}
      />

      <WhatsAppModal
        open={whatsappModal.open}
        liquidacion={whatsappModal.liquidacion}
        empleado={whatsappModal.empleado}
        onClose={() => setWhatsappModal({ open: false, liquidacion: null, empleado: null })}
      />

      <FleteroModal
        open={fleteroModal.open}
        fletero={fleteroModal.item}
        onClose={() => setFleteroModal({ open: false, item: null })}
        onSave={(data) => guardarFleteroMutation.mutate(data)}
        isLoading={guardarFleteroMutation.isPending}
      />

      <DeleteConfirmModal
        open={deleteModal.open}
        item={deleteModal.item}
        type={deleteModal.type}
        onClose={() => setDeleteModal({ open: false, item: null, type: 'empleado' })}
        onConfirm={() => {
          if (deleteModal.type === 'fletero') {
            eliminarFleteroMutation.mutate(deleteModal.item?.id);
          } else {
            eliminarEmpleadoMutation.mutate(deleteModal.item?.id);
          }
        }}
        isLoading={eliminarEmpleadoMutation.isPending || eliminarFleteroMutation.isPending}
      />

      <AjusteMontoModal
        open={ajusteMontoModal.open}
        item={ajusteMontoModal.item}
        onClose={() => setAjusteMontoModal({ open: false, item: null })}
        onSave={(nuevoMonto) => ajustarMontoMutation.mutate({ 
          item: ajusteMontoModal.item, 
          nuevoMonto 
        })}
        isLoading={ajustarMontoMutation.isPending}
      />

      <LiquidacionFleteroModal
        open={liquidacionFleteroModal}
        fleteros={fleteros.filter(f => f.activo)}
        historialPrecios={historialPrecios}
        movimientos={movimientos}
        salidas={salidas}
        bancos={bancos}
        cajas={cajas}
        cheques={cheques}
        onClose={() => setLiquidacionFleteroModal(false)}
        onSave={(data) => guardarLiquidacionFleteroMutation.mutate(data)}
        isLoading={guardarLiquidacionFleteroMutation.isPending}
      />
    </div>
  );
}

function AjusteMontoModal({ open, item, onClose, onSave, isLoading }) {
  const [nuevoMonto, setNuevoMonto] = useState(0);

  React.useEffect(() => {
    if (item) {
      setNuevoMonto(item.monto || 0);
    }
  }, [item]);

  if (!item) return null;

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Ajustar Monto de Transporte</DialogTitle>
        </DialogHeader>
        <div className="py-4 space-y-4">
          <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p className="text-sm font-semibold text-blue-900 mb-2">{item.descripcion}</p>
            <div className="grid grid-cols-2 gap-3 text-sm">
              <div>
                <span className="text-xs text-blue-700">Fecha:</span>
                <p className="font-medium text-blue-900">
                  {format(new Date(item.fecha), 'dd/MM/yyyy HH:mm', { locale: es })}
                </p>
              </div>
              <div>
                <span className="text-xs text-blue-700">Kilos:</span>
                <p className="font-medium text-blue-900">{item.kilos?.toFixed(0)} kg</p>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <Card className="bg-slate-50">
              <CardContent className="p-3">
                <p className="text-xs text-slate-500 mb-1">Monto Calculado</p>
                <p className="text-lg font-bold text-slate-700">
                  ${item.montoCalculado?.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                </p>
                <p className="text-xs text-slate-500 mt-1">
                  {item.kilos?.toFixed(0)} kg √ó ${(item.montoCalculado / item.kilos)?.toFixed(2)}/kg
                </p>
              </CardContent>
            </Card>
            <Card className="bg-green-50 border-green-200">
              <CardContent className="p-3">
                <p className="text-xs text-green-700 mb-1">Nuevo Monto</p>
                <Input
                  type="number"
                  step="0.01"
                  value={nuevoMonto}
                  onChange={(e) => setNuevoMonto(parseFloat(e.target.value) || 0)}
                  className="text-lg font-bold h-auto py-1"
                />
              </CardContent>
            </Card>
          </div>

          {nuevoMonto !== item.montoCalculado && (
            <div className={`p-3 rounded-lg border ${
              nuevoMonto > item.montoCalculado 
                ? 'bg-green-50 border-green-200' 
                : 'bg-red-50 border-red-200'
            }`}>
              <p className={`text-sm font-semibold ${
                nuevoMonto > item.montoCalculado ? 'text-green-900' : 'text-red-900'
              }`}>
                Diferencia: ${(nuevoMonto - item.montoCalculado).toLocaleString('es-AR', { minimumFractionDigits: 2, signDisplay: 'always' })}
              </p>
            </div>
          )}
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button onClick={() => onSave(nuevoMonto)} disabled={isLoading}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Guardar Ajuste
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

function WhatsAppModal({ open, liquidacion, empleado, onClose }) {
  const [numero, setNumero] = useState('');

  React.useEffect(() => {
    if (empleado?.whatsapp) {
      setNumero(empleado.whatsapp);
    }
  }, [empleado]);

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Compartir Liquidaci√≥n por WhatsApp</DialogTitle>
        </DialogHeader>
        <div className="py-4 space-y-4">
          <div>
            <Label>N√∫mero de WhatsApp</Label>
            <Input
              type="tel"
              value={numero}
              onChange={(e) => setNumero(e.target.value)}
              placeholder="+54 9 11 1234-5678"
              className="mt-1"
            />
          </div>
          <div className="flex gap-2">
            <Button 
              onClick={() => liquidacion && descargarPDFLiquidacion(liquidacion, empleado)}
              variant="outline"
              className="flex-1"
            >
              <FileText className="h-4 w-4 mr-2" />
              Ver PDF
            </Button>
            <Button 
              onClick={() => {
                if (numero && liquidacion) {
                  compartirWhatsAppLiquidacion(liquidacion, empleado, numero);
                  onClose();
                }
              }}
              disabled={!numero}
              className="flex-1 bg-green-600 hover:bg-green-700"
            >
              <MessageCircle className="h-4 w-4 mr-2" />
              Enviar WhatsApp
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}

function DeleteConfirmModal({ open, item, type, onClose, onConfirm, isLoading }) {
  const nombre = item?.nombre;
  const tipoTexto = type === 'fletero' ? 'fletero' : 'empleado';
  const mensajeAdicional = type === 'fletero' 
    ? 'Si el fletero tiene movimientos asociados, no se eliminar√°.'
    : 'Si el empleado tiene liquidaciones asociadas, no se eliminar√°.';

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Confirmar Eliminaci√≥n</DialogTitle>
        </DialogHeader>
        <div className="py-4">
          <p className="text-slate-700 mb-3">
            ¬øEst√° seguro de eliminar {tipoTexto === 'fletero' ? 'al fletero' : 'el legajo de'} <strong>{nombre}</strong>?
          </p>
          <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-sm text-red-800 font-medium">‚ö†Ô∏è Advertencia</p>
            <p className="text-xs text-red-700 mt-1">
              Esta acci√≥n no se puede deshacer. {mensajeAdicional}
            </p>
          </div>
        </div>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Cancelar</Button>
          <Button variant="destructive" onClick={onConfirm} disabled={isLoading}>
            {isLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Eliminar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/pages/Historial.jsx">
import React, { useState, useMemo } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useQueryClient, useInfiniteQuery } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { History, Search, Trash2, FileDown, MessageCircle, ChevronDown, ChevronUp, Apple, Package, Filter, ShoppingCart, Edit, ChevronRight } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { toast } from 'sonner';
import { generateMovimientoPDF, downloadPDF, shareWhatsApp } from '@/components/PDFGenerator';
import { generateSalidaPDF, downloadSalidaPDF, shareSalidaWhatsApp } from '@/components/SalidaPDFGenerator';
import { descargarPDFMovimientoEnvases, compartirWhatsAppMovimientoEnvases } from '@/components/MovimientoEnvasesPDFGenerator';
import EditarMovimientoModal from '@/components/EditarMovimientoModal';
import PINModal from '@/components/PINModal';
import { invalidarTodoElSistema } from '@/utils/queryHelpers';
import { recalcularSaldosEntidad } from '@/utils/contabilidad';
import { ajustarStockProducto, ajustarStockEnvase } from '@/services/StockService';

export default function Historial() {
  const queryClient = useQueryClient();
  const [search, setSearch] = useState('');
  const [tipoFilter, setTipoFilter] = useState('todos');
  const [expandedId, setExpandedId] = useState(null);
  const [deleteDialog, setDeleteDialog] = useState({ open: false, id: null });
  const [isDeleting, setIsDeleting] = useState(false);
  const [editDialog, setEditDialog] = useState({ open: false, movimiento: null });
  const [pinModal, setPinModal] = useState({ open: false, action: null, data: null });
  const [isProcessing, setIsProcessing] = useState(false);
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGINACI√ìN - Mostrar TODO el historial sin cortar registros viejos
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const [paginaActual, setPaginaActual] = useState(1);
  const registrosPorPagina = 10; // Configurable: 10-20 registros por p√°gina

  const PAGE_SIZE = 20;

  // Filtro servidor: por tipo de movimiento (evita traer todos y filtrar en cliente)
  const queryMovimientos = useMemo(() => {
    if (tipoFilter === 'Ingreso de Fruta' || tipoFilter === 'Movimiento de Envases') {
      return { tipo_movimiento: tipoFilter };
    }
    return {};
  }, [tipoFilter]);

  const {
    data: movimientosData,
    fetchNextPage: fetchMoreMovimientos,
    hasNextPage: hasMoreMovimientos,
    isFetchingNextPage: loadingMoreMovimientos,
    isLoading: loadingMov
  } = useInfiniteQuery({
    queryKey: ['movimientos-infinite', tipoFilter],
    queryFn: ({ pageParam = 0 }) => {
      if (tipoFilter === 'Salida de Fruta') return Promise.resolve([]);
      if (Object.keys(queryMovimientos).length === 0) {
        return base44.entities.Movimiento.list('-created_date', PAGE_SIZE, pageParam);
      }
      return base44.entities.Movimiento.filter(queryMovimientos, '-created_date', PAGE_SIZE, pageParam);
    },
    getNextPageParam: (lastPage, allPages) =>
      (lastPage?.length ?? 0) === PAGE_SIZE ? allPages.length * PAGE_SIZE : undefined,
    initialPageParam: 0,
    enabled: tipoFilter !== 'Salida de Fruta',
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const {
    data: salidasData,
    fetchNextPage: fetchMoreSalidas,
    hasNextPage: hasMoreSalidas,
    isFetchingNextPage: loadingMoreSalidas,
    isLoading: loadingSal
  } = useInfiniteQuery({
    queryKey: ['salidas-infinite', tipoFilter],
    queryFn: ({ pageParam = 0 }) =>
      base44.entities.SalidaFruta.list('-created_date', PAGE_SIZE, pageParam),
    getNextPageParam: (lastPage, allPages) =>
      (lastPage?.length ?? 0) === PAGE_SIZE ? allPages.length * PAGE_SIZE : undefined,
    initialPageParam: 0,
    enabled: tipoFilter === 'todos' || tipoFilter === 'Salida de Fruta',
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const movimientos = useMemo(
    () => movimientosData?.pages?.flat() ?? [],
    [movimientosData]
  );
  const salidas = useMemo(
    () => salidasData?.pages?.flat() ?? [],
    [salidasData]
  );
  const hasMore = hasMoreMovimientos || hasMoreSalidas;
  const loadingMore = loadingMoreMovimientos || loadingMoreSalidas;

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list('fruta', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: envases = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list('tipo', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: configuraciones = [] } = useQuery({
    queryKey: ['configuraciones'],
    queryFn: () => base44.entities.Configuracion.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: fleteros = [] } = useQuery({
    queryKey: ['fleteros'],
    queryFn: () => base44.entities.Fletero.list('nombre', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const isLoading = loadingMov || loadingSal;

  const calcularSaldos = useMemo(() => {
    return (provId) => {
      if (!provId) return [];
      const saldosPorEnvase = {};
      
      // Movimientos de envases vac√≠os
      movimientos
        .filter(m => m.proveedor_id === provId)
        .forEach(m => {
          m.movimiento_envases?.forEach(e => {
            if (!saldosPorEnvase[e.envase_tipo]) {
              saldosPorEnvase[e.envase_tipo] = 0;
            }
            saldosPorEnvase[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
          });
        });

      // Restar envases llenos devueltos en Ingreso de Fruta
      movimientos
        .filter(m => m.proveedor_id === provId && m.tipo_movimiento === 'Ingreso de Fruta' && m.envases_llenos)
        .forEach(m => {
          m.envases_llenos.forEach(e => {
            if (!saldosPorEnvase[e.envase_tipo]) {
              saldosPorEnvase[e.envase_tipo] = 0;
            }
            saldosPorEnvase[e.envase_tipo] -= (e.cantidad || 0);
          });
        });

      return Object.entries(saldosPorEnvase).map(([tipo, saldo]) => ({
        envase_tipo: tipo,
        saldo: Math.max(0, saldo)
      }));
    };
  }, [movimientos]);

  const todosLosRegistros = useMemo(() => {
    const registros = [];
    
    // Agregar movimientos (ingresos y envases)
    movimientos.forEach(m => {
      // Determinar si es con cliente o proveedor
      const esConCliente = m.cliente_id && m.cliente_nombre;
      const esConProveedor = m.proveedor_id && m.proveedor_nombre;
      
      registros.push({
        ...m,
        tipo: m.tipo_movimiento,
        origen: 'movimiento',
        entidad_nombre: esConCliente ? m.cliente_nombre : (esConProveedor ? m.proveedor_nombre : '-'),
        entidad_tipo: esConCliente ? 'Cliente' : (esConProveedor ? 'Proveedor' : '-')
      });
    });
    
    // Agregar salidas
    salidas.forEach(s => {
      registros.push({
        ...s,
        tipo: 'Salida de Fruta',
        origen: 'salida',
        entidad_nombre: s.cliente_nombre,
        entidad_tipo: 'Cliente'
      });
    });
    
    // Ordenar por fecha descendente
    return registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  }, [movimientos, salidas]);

  // Filtro por b√∫squeda en cliente (tipo ya aplicado en servidor)
  const filteredMovimientos = useMemo(() => {
    if (!search?.trim()) return todosLosRegistros;
    const term = search.trim().toLowerCase();
    return todosLosRegistros.filter(m =>
      m.entidad_nombre?.toLowerCase().includes(term) ||
      m.fletero_nombre?.toLowerCase().includes(term) ||
      m.numero_remito?.toLowerCase().includes(term) ||
      m.comprobante_cliente?.toLowerCase().includes(term)
    );
  }, [todosLosRegistros, search]);
  
  // Reset p√°gina cuando cambien los filtros (evita loop infinito)
  React.useEffect(() => {
    setPaginaActual(1);
  }, [search, tipoFilter]);
  
  // Calcular paginaci√≥n
  const totalPaginas = Math.ceil(filteredMovimientos.length / registrosPorPagina);
  const indiceInicio = (paginaActual - 1) * registrosPorPagina;
  const indiceFin = indiceInicio + registrosPorPagina;
  const registrosPaginados = filteredMovimientos.slice(indiceInicio, indiceFin);
  
  // Generar n√∫meros de p√°ginas para mostrar
  const generarNumerosPaginas = () => {
    const paginas = [];
    const maxPaginasVisibles = 5;
    
    if (totalPaginas <= maxPaginasVisibles) {
      for (let i = 1; i <= totalPaginas; i++) {
        paginas.push(i);
      }
    } else {
      if (paginaActual <= 3) {
        paginas.push(1, 2, 3, 4, '...', totalPaginas);
      } else if (paginaActual >= totalPaginas - 2) {
        paginas.push(1, '...', totalPaginas - 3, totalPaginas - 2, totalPaginas - 1, totalPaginas);
      } else {
        paginas.push(1, '...', paginaActual - 1, paginaActual, paginaActual + 1, '...', totalPaginas);
      }
    }
    
    return paginas;
  };

  const handleDelete = async () => {
    if (!deleteDialog.id || !deleteDialog.tipo || !deleteDialog.registro) return;
    setIsDeleting(true);
    try {
      const registro = deleteDialog.registro;

      if (deleteDialog.tipo === 'movimiento') {
        // REVERSI√ìN INTELIGENTE DE INGRESO DE FRUTA
        if (registro.tipo_movimiento === 'Ingreso de Fruta' && registro.pesajes?.length > 0) {
          // Agrupar kilos netos por producto
          const stockPorProducto = {};
          registro.pesajes.forEach(pesaje => {
            if (pesaje.producto_id && pesaje.peso_neto) {
              if (!stockPorProducto[pesaje.producto_id]) {
                stockPorProducto[pesaje.producto_id] = 0;
              }
              stockPorProducto[pesaje.producto_id] += pesaje.peso_neto;
            }
          });

          // Restar stock de cada producto (actualizaci√≥n incremental)
          for (const [productoId, totalNeto] of Object.entries(stockPorProducto)) {
            await ajustarStockProducto(base44, productoId, -totalNeto);
          }
        }

        // REVERSI√ìN DE MOVIMIENTOS DE ENVASES (tanto ingreso como movimiento puro)
        if (registro.movimiento_envases?.length > 0) {
          // Agrupar ajustes por envase y tipo (vac√≠o/ocupado)
          const ajustePorEnvase = {};
          registro.movimiento_envases.forEach(movEnv => {
            if (movEnv.envase_id) {
              if (!ajustePorEnvase[movEnv.envase_id]) {
                ajustePorEnvase[movEnv.envase_id] = { 
                  ingresoVacios: 0, 
                  ingresoOcupados: 0, 
                  salidaVacios: 0, 
                  salidaOcupados: 0 
                };
              }
              // Determinar si son vac√≠os u ocupados (con_fruta)
              const conFruta = movEnv.con_fruta !== undefined ? movEnv.con_fruta : true;
              
              if (conFruta) {
                ajustePorEnvase[movEnv.envase_id].ingresoOcupados += (movEnv.cantidad_ingreso || 0);
                ajustePorEnvase[movEnv.envase_id].salidaOcupados += (movEnv.cantidad_salida || 0);
              } else {
                ajustePorEnvase[movEnv.envase_id].ingresoVacios += (movEnv.cantidad_ingreso || 0);
                ajustePorEnvase[movEnv.envase_id].salidaVacios += (movEnv.cantidad_salida || 0);
              }
            }
          });

          // Revertir stocks de envases (actualizaci√≥n incremental)
          for (const [envaseId, ajustes] of Object.entries(ajustePorEnvase)) {
            const deltaOcupados = -ajustes.ingresoOcupados + ajustes.salidaOcupados;
            const deltaVacios = -ajustes.ingresoVacios + ajustes.salidaVacios;
            await ajustarStockEnvase(base44, envaseId, deltaOcupados, deltaVacios);
          }
        }

        // Eliminar el movimiento
        await base44.entities.Movimiento.delete(deleteDialog.id);
        
        // Recalcular saldos de cuenta corriente si el movimiento afectaba una entidad
        if (registro.proveedor_id) {
          await recalcularSaldosEntidad(base44, registro.proveedor_id, 'Proveedor');
        } else if (registro.cliente_id) {
          await recalcularSaldosEntidad(base44, registro.cliente_id, 'Cliente');
        }
        
        // Invalidar todas las queries del sistema
        invalidarTodoElSistema(queryClient);

      } else if (deleteDialog.tipo === 'salida') {
        // REVERSI√ìN DE SALIDA DE FRUTA
        if (registro.detalles?.length > 0) {
          // Agrupar kilos por producto (usar kilos efectivos si est√° confirmada)
          const stockPorProducto = {};
          registro.detalles.forEach(detalle => {
            if (detalle.producto_id) {
              if (!stockPorProducto[detalle.producto_id]) {
                stockPorProducto[detalle.producto_id] = 0;
              }
              // Si est√° confirmada, usar kilos efectivos, sino usar kilos_salida
              const kilosEfectivos = registro.estado === 'Confirmada'
                ? ((detalle.kilos_reales || detalle.kilos_salida) + (detalle.descuento_kg || 0))
                : detalle.kilos_salida;
              
              stockPorProducto[detalle.producto_id] += kilosEfectivos;
            }
          });

          // Devolver stock a cada producto (actualizaci√≥n incremental)
          for (const [productoId, totalKilos] of Object.entries(stockPorProducto)) {
            await ajustarStockProducto(base44, productoId, totalKilos);
          }
        }

        // REVERSI√ìN DE MOVIMIENTOS DE ENVASES DE LA SALIDA
        if (registro.movimiento_envases?.length > 0) {
          const ajustePorEnvase = {};
          registro.movimiento_envases.forEach(movEnv => {
            if (movEnv.envase_id) {
              if (!ajustePorEnvase[movEnv.envase_id]) {
                ajustePorEnvase[movEnv.envase_id] = { 
                  ingresoVacios: 0, 
                  ingresoOcupados: 0, 
                  salidaVacios: 0, 
                  salidaOcupados: 0 
                };
              }
              const conFruta = movEnv.con_fruta !== undefined ? movEnv.con_fruta : false;
              
              if (conFruta) {
                ajustePorEnvase[movEnv.envase_id].ingresoOcupados += (movEnv.cantidad_ingreso || 0);
                ajustePorEnvase[movEnv.envase_id].salidaOcupados += (movEnv.cantidad_salida || 0);
              } else {
                ajustePorEnvase[movEnv.envase_id].ingresoVacios += (movEnv.cantidad_ingreso || 0);
                ajustePorEnvase[movEnv.envase_id].salidaVacios += (movEnv.cantidad_salida || 0);
              }
            }
          });

          for (const [envaseId, ajustes] of Object.entries(ajustePorEnvase)) {
            const deltaOcupados = -ajustes.ingresoOcupados + ajustes.salidaOcupados;
            const deltaVacios = -ajustes.ingresoVacios + ajustes.salidaVacios;
            await ajustarStockEnvase(base44, envaseId, deltaOcupados, deltaVacios);
          }
        }

        await base44.entities.SalidaFruta.delete(deleteDialog.id);
        
        // Recalcular saldos de cuenta corriente si la salida afectaba un cliente
        if (registro.cliente_id) {
          await recalcularSaldosEntidad(base44, registro.cliente_id, 'Cliente');
        }
        
        // Invalidar todas las queries del sistema
        invalidarTodoElSistema(queryClient);
      }

      setDeleteDialog({ open: false, id: null, tipo: null, registro: null });
    } catch (error) {
      console.error('Error al eliminar:', error);
      alert('Error al eliminar el registro. Por favor, intente nuevamente.');
    } finally {
      setIsDeleting(false);
    }
  };

  const handleDownloadPDF = (registro) => {
    if (registro.origen === 'movimiento') {
      let saldos = [];
      let entidadData = null;
      
      if (registro.proveedor_id) {
        saldos = calcularSaldos(registro.proveedor_id);
        entidadData = proveedores.find(p => p.id === registro.proveedor_id);
      } else if (registro.cliente_id) {
        // Calcular saldos para cliente
        const saldosPorEnvase = {};
        movimientos
          .filter(m => m.cliente_id === registro.cliente_id)
          .forEach(m => {
            m.movimiento_envases?.forEach(e => {
              if (!saldosPorEnvase[e.envase_tipo]) {
                saldosPorEnvase[e.envase_tipo] = 0;
              }
              saldosPorEnvase[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
            });
          });
        salidas
          .filter(s => s.cliente_id === registro.cliente_id)
          .forEach(s => {
            s.movimiento_envases?.forEach(e => {
              if (!saldosPorEnvase[e.envase_tipo]) {
                saldosPorEnvase[e.envase_tipo] = 0;
              }
              saldosPorEnvase[e.envase_tipo] += (e.cantidad_ingreso || 0) - (e.cantidad_salida || 0);
            });
            // Envases llenos que salieron (reducen deuda)
            s.envases_llenos?.forEach(e => {
              if (!saldosPorEnvase[e.envase_tipo]) {
                saldosPorEnvase[e.envase_tipo] = 0;
              }
              saldosPorEnvase[e.envase_tipo] -= (e.cantidad || 0);
            });
          });
        saldos = Object.entries(saldosPorEnvase).map(([tipo, saldo]) => ({
          envase_tipo: tipo,
          saldo: Math.max(0, saldo)
        }));
        entidadData = clientes.find(c => c.id === registro.cliente_id);
      }
      
      const fleteroData = fleteros.find(f => f.id === registro.fletero_id);
      
      // USAR SIEMPRE EL MISMO GENERADOR UNIFICADO
      const html = generateMovimientoPDF(registro, saldos);
      downloadPDF(html, `movimiento_${registro.id}.pdf`);
    } else {
      const html = generateSalidaPDF(registro);
      downloadSalidaPDF(html, registro.numero_remito);
    }
  };

  const handleShareWhatsApp = async (registro) => {
    if (registro.origen === 'movimiento') {
      let saldos = [];
      let entidadData = null;
      
      if (registro.proveedor_id) {
        saldos = calcularSaldos(registro.proveedor_id);
        entidadData = proveedores.find(p => p.id === registro.proveedor_id);
      } else if (registro.cliente_id) {
        // Calcular saldos para cliente
        const saldosPorEnvase = {};
        movimientos
          .filter(m => m.cliente_id === registro.cliente_id)
          .forEach(m => {
            m.movimiento_envases?.forEach(e => {
              if (!saldosPorEnvase[e.envase_tipo]) {
                saldosPorEnvase[e.envase_tipo] = 0;
              }
              saldosPorEnvase[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
            });
          });
        salidas
          .filter(s => s.cliente_id === registro.cliente_id)
          .forEach(s => {
            s.movimiento_envases?.forEach(e => {
              if (!saldosPorEnvase[e.envase_tipo]) {
                saldosPorEnvase[e.envase_tipo] = 0;
              }
              saldosPorEnvase[e.envase_tipo] += (e.cantidad_ingreso || 0) - (e.cantidad_salida || 0);
            });
            // Envases llenos que salieron (reducen deuda)
            s.envases_llenos?.forEach(e => {
              if (!saldosPorEnvase[e.envase_tipo]) {
                saldosPorEnvase[e.envase_tipo] = 0;
              }
              saldosPorEnvase[e.envase_tipo] -= (e.cantidad || 0);
            });
          });
        saldos = Object.entries(saldosPorEnvase).map(([tipo, saldo]) => ({
          envase_tipo: tipo,
          saldo: Math.max(0, saldo)
        }));
        entidadData = clientes.find(c => c.id === registro.cliente_id);
      }
      
      // USAR SIEMPRE EL MISMO GENERADOR UNIFICADO
      await shareWhatsApp(registro, saldos, entidadData?.whatsapp);
    } else {
      const cliente = clientes.find(c => c.id === registro.cliente_id);
      await shareSalidaWhatsApp(registro, cliente?.whatsapp);
    }
  };

  const toggleExpand = (id) => {
    setExpandedId(expandedId === id ? null : id);
  };

  const verificarPIN = async (pinIngresado) => {
    const configPIN = configuraciones.find(c => c.clave === 'pin_seguridad');
    const pinGuardado = configPIN?.valor || '0000';
    return pinIngresado === pinGuardado;
  };

  const handleEditarMovimiento = (registro) => {
    setEditDialog({ open: true, movimiento: registro });
  };

  const handleSaveEdicion = async (formData) => {
    setPinModal({ 
      open: true, 
      action: 'editar', 
      data: { ...editDialog.movimiento, ...formData }
    });
  };

  const confirmarConPIN = async (pin) => {
    const esValido = await verificarPIN(pin);
    if (!esValido) return false;

    setIsProcessing(true);
    try {
      const { action, data } = pinModal;
      
      if (action === 'editar') {
        const movimientoOriginal = editDialog.movimiento;
        
        // Preparar datos de actualizaci√≥n
        const updateData = {
          fecha: new Date(data.fecha).toISOString(),
          notas: data.notas
        };

        // Agregar campos espec√≠ficos seg√∫n tipo
        if (movimientoOriginal.origen === 'movimiento') {
          if (data.proveedor_id) {
            const prov = proveedores.find(p => p.id === data.proveedor_id);
            updateData.proveedor_id = data.proveedor_id;
            updateData.proveedor_nombre = prov?.nombre;
          }
          if (data.cliente_id) {
            const cli = clientes.find(c => c.id === data.cliente_id);
            updateData.cliente_id = data.cliente_id;
            updateData.cliente_nombre = cli?.nombre;
          }
          if (data.fletero_id) {
            const flet = fleteros.find(f => f.id === data.fletero_id);
            updateData.fletero_id = data.fletero_id;
            updateData.fletero_nombre = flet?.nombre;
          }
          
          // Si hay cambios en movimiento_envases (checkboxes de contabilizar)
          if (data.movimiento_envases) {
            updateData.movimiento_envases = data.movimiento_envases;
          }
          
          await base44.entities.Movimiento.update(movimientoOriginal.id, updateData);
        } else {
          // Salida de fruta
          if (data.cliente_id) {
            const cli = clientes.find(c => c.id === data.cliente_id);
            updateData.cliente_id = data.cliente_id;
            updateData.cliente_nombre = cli?.nombre;
          }
          if (data.fletero_id) {
            const flet = fleteros.find(f => f.id === data.fletero_id);
            updateData.fletero_id = data.fletero_id;
            updateData.fletero_nombre = flet?.nombre;
          }
          if (data.numero_remito) {
            updateData.numero_remito = data.numero_remito;
          }
          if (data.comprobante_cliente !== undefined) {
            updateData.comprobante_cliente = data.comprobante_cliente;
          }
          
          await base44.entities.SalidaFruta.update(movimientoOriginal.id, updateData);
        }

        // Invalidar todas las queries del sistema
        invalidarTodoElSistema(queryClient);
        
        toast.success('Movimiento actualizado correctamente');
        
        setEditDialog({ open: false, movimiento: null });
        setPinModal({ open: false, action: null, data: null });
      }
      
      return true;
    } catch (error) {
      console.error('Error al guardar edici√≥n:', error);
      toast.error('Error al guardar los cambios');
      return false;
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-gray-50">
      <div className="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <div className="flex items-center gap-2 md:gap-3 mb-4 md:mb-8">
          <div className="w-10 h-10 md:w-12 md:h-12 bg-slate-100 rounded-xl flex items-center justify-center shrink-0">
            <History className="h-5 w-5 md:h-6 md:w-6 text-slate-600" />
          </div>
          <div className="min-w-0">
            <h1 className="text-xl md:text-2xl lg:text-3xl font-bold text-slate-800 break-words">Historial de Movimientos</h1>
            <p className="text-slate-500 text-xs md:text-sm">Consulta y gestiona todos los registros</p>
          </div>
        </div>

        {/* Filtros */}
        <Card className="border-0 shadow-lg shadow-slate-200/50 mb-6">
          <CardContent className="p-4">
            <div className="flex flex-col sm:flex-row gap-4">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                <Input
                  placeholder="Buscar por entidad, fletero, remito..."
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  className="pl-10"
                />
              </div>
              <div className="flex items-center gap-2 w-full sm:w-auto">
                <Filter className="h-4 w-4 text-slate-400 shrink-0" />
                <Select value={tipoFilter} onValueChange={setTipoFilter}>
                  <SelectTrigger className="w-full sm:w-48">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos</SelectItem>
                    <SelectItem value="Ingreso de Fruta">Ingreso</SelectItem>
                    <SelectItem value="Salida de Fruta">Salida</SelectItem>
                    <SelectItem value="Movimiento de Envases">Envases</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Informaci√≥n de paginaci√≥n */}
        {!isLoading && filteredMovimientos.length > 0 && (
          <div className="flex items-center justify-between px-4 py-2 bg-slate-50 rounded-lg mb-4">
            <p className="text-sm text-slate-600">
              Mostrando <strong>{indiceInicio + 1}</strong> a <strong>{Math.min(indiceFin, filteredMovimientos.length)}</strong> de <strong>{filteredMovimientos.length}</strong> registros
            </p>
            <p className="text-sm text-slate-500">
              P√°gina {paginaActual} de {totalPaginas}
            </p>
          </div>
        )}

        {/* Lista de Movimientos */}
        <div className="space-y-4">
          {isLoading ? (
            <div className="text-center py-12 text-slate-500">Cargando...</div>
          ) : filteredMovimientos.length === 0 ? (
            <div className="text-center py-12 text-slate-500">
              No se encontraron movimientos
            </div>
          ) : (
            registrosPaginados.map((mov) => (
              <Card key={mov.id} className="border-0 shadow-md hover:shadow-lg transition-shadow">
                <CardHeader className="p-4 pb-0">
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex items-center gap-3 flex-1 min-w-0">
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center shrink-0 ${
                        mov.tipo === 'Ingreso de Fruta' 
                          ? 'bg-green-100' 
                          : mov.tipo === 'Salida de Fruta'
                          ? 'bg-purple-100'
                          : 'bg-amber-100'
                      }`}>
                        {mov.tipo === 'Ingreso de Fruta' 
                          ? <Apple className="h-5 w-5 text-green-600" />
                          : mov.tipo === 'Salida de Fruta'
                          ? <ShoppingCart className="h-5 w-5 text-purple-600" />
                          : <Package className="h-5 w-5 text-amber-600" />
                        }
                      </div>
                      <div className="min-w-0">
                        <div className="flex items-center gap-1 md:gap-2 flex-wrap">
                          <h3 className="font-semibold text-sm md:text-base text-slate-800 truncate">
                            {mov.entidad_nombre}
                          </h3>
                          <Badge variant="outline" className="text-xs shrink-0">
                            {mov.entidad_tipo}
                          </Badge>
                          <Badge variant="outline" className={`text-xs shrink-0 ${
                            mov.tipo === 'Ingreso de Fruta'
                              ? 'bg-green-50 text-green-700 border-green-200'
                              : mov.tipo === 'Salida de Fruta'
                              ? 'bg-purple-50 text-purple-700 border-purple-200'
                              : 'bg-amber-50 text-amber-700 border-amber-200'
                          }`}>
                            <span className="hidden sm:inline">{mov.tipo}</span>
                            <span className="sm:hidden">{mov.tipo === 'Ingreso de Fruta' ? 'Ing.' : mov.tipo === 'Salida de Fruta' ? 'Sal.' : 'Env.'}</span>
                          </Badge>
                          {mov.origen === 'salida' && (
                            <Badge className={mov.estado === 'Confirmada' ? 'bg-green-600' : 'bg-amber-500'}>
                              {mov.estado}
                            </Badge>
                          )}
                        </div>
                        <p className="text-sm text-slate-500">
                          {format(new Date(mov.fecha), "dd 'de' MMMM yyyy, HH:mm", { locale: es })}
                          {mov.fletero_nombre && ` ‚Ä¢ Fletero: ${mov.fletero_nombre}`}
                          {mov.numero_remito && ` ‚Ä¢ Remito: ${mov.numero_remito}`}
                        </p>
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => toggleExpand(mov.id)}
                      className="shrink-0"
                    >
                      {expandedId === mov.id ? (
                        <ChevronUp className="h-5 w-5" />
                      ) : (
                        <ChevronDown className="h-5 w-5" />
                      )}
                    </Button>
                  </div>
                </CardHeader>

                {/* Resumen compacto */}
                <CardContent className="p-4 pt-2">
                  <div className="flex flex-wrap gap-2 text-sm">
                    {mov.origen === 'movimiento' && mov.pesajes?.length > 0 && (
                      <span className="text-slate-600">
                        {mov.pesajes.length} pesaje(s) ‚Ä¢ 
                        <span className="font-medium text-green-700 ml-1">
                          {mov.pesajes.reduce((s, p) => s + (p.peso_neto || 0), 0).toFixed(2)} kg netos
                        </span>
                      </span>
                    )}
                    {mov.origen === 'salida' && mov.detalles?.length > 0 && (
                      <span className="text-slate-600">
                        {mov.detalles.length} producto(s) ‚Ä¢ 
                        <span className="font-medium text-purple-700 ml-1">
                          {mov.detalles.reduce((s, d) => s + ((d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0)), 0).toFixed(2)} kg efectivos
                        </span>
                      </span>
                    )}
                    {mov.envases_llenos?.length > 0 && (
                      <span className="text-slate-600">
                        {mov.envases_llenos.reduce((sum, e) => sum + (e.cantidad || 0), 0)} envases llenos
                      </span>
                    )}
                    {mov.movimiento_envases?.filter(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0).length > 0 && (
                      <span className="text-slate-600">
                        {mov.movimiento_envases.filter(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0).length} tipo(s) envase vac√≠o
                      </span>
                    )}
                  </div>
                </CardContent>

                {/* Detalle expandido */}
                {expandedId === mov.id && (
                  <CardContent className="pt-0 pb-4 px-4 border-t border-slate-100">
                    <div className="space-y-4 mt-4">
                      {/* Informaci√≥n adicional de salida */}
                      {mov.origen === 'salida' && (
                        <div className="p-3 bg-slate-50 rounded-lg space-y-2">
                          {mov.comprobante_cliente && (
                            <p className="text-sm"><span className="font-medium">Comprobante Cliente:</span> {mov.comprobante_cliente}</p>
                          )}
                          {mov.deuda_total > 0 && (
                            <p className="text-sm"><span className="font-medium">Deuda Total:</span> <span className="text-green-700 font-bold">${mov.deuda_total.toFixed(2)}</span></p>
                          )}
                        </div>
                      )}

                      {/* Detalles de salida */}
                      {mov.origen === 'salida' && mov.detalles?.length > 0 && (
                       <div>
                         <h4 className="font-medium text-slate-700 mb-2 text-sm md:text-base">Productos</h4>
                         <div className="overflow-x-auto -mx-4 md:mx-0">
                           <div className="inline-block min-w-full align-middle px-4 md:px-0">
                             <table className="w-full text-xs md:text-sm">
                               <thead className="bg-slate-50">
                                 <tr>
                                   <th className="text-left p-2 whitespace-nowrap">Producto</th>
                                   <th className="text-right p-2 whitespace-nowrap">Orig.</th>
                                   {mov.estado === 'Confirmada' && (
                                     <>
                                       <th className="text-right p-2 whitespace-nowrap">Reales</th>
                                       <th className="text-right p-2 whitespace-nowrap">Desc.</th>
                                     </>
                                   )}
                                   <th className="text-right p-2 whitespace-nowrap">Efect.</th>
                                 </tr>
                               </thead>
                               <tbody>
                                 {mov.detalles.map((d, i) => {
                                   const kilosReales = d.kilos_reales || d.kilos_salida;
                                   const descuento = d.descuento_kg || 0;
                                   const efectivos = kilosReales - descuento;
                                   return (
                                     <tr key={i} className="border-b border-slate-100">
                                       <td className="p-2">{d.producto_nombre}</td>
                                       <td className="p-2 text-right">{d.kilos_salida.toFixed(2)}</td>
                                       {mov.estado === 'Confirmada' && (
                                         <>
                                           <td className="p-2 text-right">{kilosReales.toFixed(2)}</td>
                                           <td className="p-2 text-right text-red-600">{descuento > 0 ? `-${descuento.toFixed(2)}` : '-'}</td>
                                         </>
                                       )}
                                       <td className="p-2 text-right font-medium text-purple-700">{efectivos.toFixed(2)}</td>
                                     </tr>
                                   );
                                 })}
                               </tbody>
                             </table>
                           </div>
                         </div>
                       </div>
                      )}

                      {/* Pesajes */}
                      {mov.origen === 'movimiento' && mov.pesajes?.length > 0 && (
                       <div>
                         <h4 className="font-medium text-slate-700 mb-2 text-sm md:text-base">Pesajes</h4>
                         <div className="overflow-x-auto -mx-4 md:mx-0">
                           <div className="inline-block min-w-full align-middle px-4 md:px-0">
                             <table className="w-full text-xs md:text-sm">
                               <thead className="bg-slate-50">
                                 <tr>
                                   <th className="text-left p-2 whitespace-nowrap">Producto</th>
                                   <th className="text-left p-2 whitespace-nowrap">Envase</th>
                                   <th className="text-right p-2 whitespace-nowrap">Cant.</th>
                                   <th className="text-right p-2 whitespace-nowrap">Bruto</th>
                                   <th className="text-right p-2 whitespace-nowrap">Tara</th>
                                   <th className="text-right p-2 whitespace-nowrap">Neto</th>
                                 </tr>
                               </thead>
                               <tbody>
                                 {mov.pesajes.map((p, i) => (
                                   <tr key={i} className="border-b border-slate-100">
                                     <td className="p-2">{p.producto_nombre || '-'}</td>
                                     <td className="p-2">{p.envase_tipo || '-'}</td>
                                     <td className="p-2 text-right">{p.cantidad || 1}</td>
                                     <td className="p-2 text-right">{(p.peso_bruto || 0).toFixed(2)}</td>
                                     <td className="p-2 text-right">
                                       {p.modo === 'libre' 
                                         ? (p.tara_manual || 0).toFixed(2)
                                         : ((p.tara_unitaria || 0) * (p.cantidad || 1)).toFixed(2)
                                       }
                                     </td>
                                     <td className="p-2 text-right font-medium text-green-700">
                                       {(p.peso_neto || 0).toFixed(2)}
                                     </td>
                                   </tr>
                                 ))}
                               </tbody>
                             </table>
                           </div>
                         </div>
                       </div>
                      )}

                      {/* Envases Llenos (solo en Ingreso de Fruta) */}
                      {mov.origen === 'movimiento' && mov.tipo === 'Ingreso de Fruta' && mov.envases_llenos?.length > 0 && (
                        <div>
                          <h4 className="font-medium text-slate-700 mb-2 text-sm md:text-base">Envases Llenos con Fruta</h4>
                          <div className="p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                            <div className="space-y-1">
                              {mov.envases_llenos.map((e, i) => (
                                <div key={i} className="flex justify-between items-center">
                                  <span className="text-sm font-medium text-slate-700">{e.envase_tipo}</span>
                                  <span className="text-sm font-bold text-green-700">{e.cantidad} unidades</span>
                                </div>
                              ))}
                            </div>
                            <p className="text-xs text-slate-600 mt-2">Envases que ingresaron ocupados con fruta del proveedor</p>
                          </div>
                        </div>
                      )}

                      {/* Envases Llenos (solo en Salida de Fruta) */}
                      {mov.origen === 'salida' && mov.envases_llenos?.length > 0 && (
                        <div>
                          <h4 className="font-medium text-slate-700 mb-2">Envases Llenos con Fruta</h4>
                          <div className="p-3 bg-amber-50 rounded-lg border-l-4 border-amber-500">
                            <div className="space-y-1">
                              {mov.envases_llenos.map((e, i) => (
                                <div key={i} className="flex justify-between items-center">
                                  <span className="text-sm font-medium text-slate-700">{e.envase_tipo}</span>
                                  <span className="text-sm font-bold text-amber-700">{e.cantidad} unidades</span>
                                </div>
                              ))}
                            </div>
                            <p className="text-xs text-slate-600 mt-2">Envases que salieron ocupados con fruta</p>
                          </div>
                        </div>
                      )}

                      {/* Envases Vac√≠os */}
                      {mov.movimiento_envases?.filter(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0).length > 0 && (
                       <div>
                         <h4 className="font-medium text-slate-700 mb-2 text-sm md:text-base">Movimiento de Envases Vac√≠os</h4>
                         <div className="overflow-x-auto -mx-4 md:mx-0">
                           <div className="inline-block min-w-full align-middle px-4 md:px-0">
                             <table className="w-full text-xs md:text-sm">
                               <thead className="bg-slate-50">
                                 <tr>
                                   <th className="text-left p-2 whitespace-nowrap">Tipo</th>
                                   <th className="text-center p-2 whitespace-nowrap">Ingreso</th>
                                   <th className="text-center p-2 whitespace-nowrap">Salida</th>
                                 </tr>
                               </thead>
                               <tbody>
                                 {mov.movimiento_envases
                                   .filter(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0)
                                   .map((e, i) => (
                                     <tr key={i} className="border-b border-slate-100">
                                       <td className="p-2">{e.envase_tipo}</td>
                                       <td className="p-2 text-center text-green-600 font-medium">
                                         {e.cantidad_ingreso > 0 ? `+${e.cantidad_ingreso}` : '-'}
                                       </td>
                                       <td className="p-2 text-center text-red-600 font-medium">
                                         {e.cantidad_salida > 0 ? `-${e.cantidad_salida}` : '-'}
                                       </td>
                                     </tr>
                                   ))}
                               </tbody>
                             </table>
                           </div>
                         </div>
                       </div>
                      )}

                      {/* Acciones */}
                      <div className="grid grid-cols-2 md:flex md:flex-wrap gap-2 pt-4 border-t border-slate-100">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDownloadPDF(mov)}
                          className="text-xs md:text-sm w-full md:w-auto"
                        >
                          <FileDown className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                          <span className="hidden sm:inline">Descargar PDF</span>
                          <span className="sm:hidden">PDF</span>
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleShareWhatsApp(mov)}
                          className="text-green-600 hover:text-green-700 text-xs md:text-sm w-full md:w-auto"
                        >
                          <MessageCircle className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                          <span className="hidden sm:inline">WhatsApp</span>
                          <span className="sm:hidden">Enviar</span>
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleEditarMovimiento(mov)}
                          className="text-blue-600 hover:text-blue-700 text-xs md:text-sm w-full md:w-auto"
                        >
                          <Edit className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                          Editar
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => setDeleteDialog({ open: true, id: mov.id, tipo: mov.origen, registro: mov })}
                          className="text-red-600 hover:text-red-700 text-xs md:text-sm w-full md:w-auto"
                        >
                          <Trash2 className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                          Eliminar
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                )}
              </Card>
            ))
          )}

          {/* Cargar m√°s (paginaci√≥n en servidor) */}
          {!isLoading && filteredMovimientos.length > 0 && hasMore && (
            <Card className="border-0 shadow-md mt-4">
              <CardContent className="p-4 text-center">
                <Button
                  variant="outline"
                  disabled={loadingMore}
                  onClick={() => {
                    if (hasMoreMovimientos) fetchMoreMovimientos();
                    if (hasMoreSalidas) fetchMoreSalidas();
                  }}
                  className="w-full sm:w-auto"
                >
                  {loadingMore ? (
                    <>Cargando...</>
                  ) : (
                    <>
                      <ChevronRight className="h-4 w-4 mr-2" />
                      Cargar m√°s (20 movimientos + 20 salidas)
                    </>
                  )}
                </Button>
                <p className="text-xs text-slate-500 mt-2">
                  {movimientos.length} movimientos, {salidas.length} salidas cargados
                </p>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Controles de paginaci√≥n */}
        {!isLoading && filteredMovimientos.length > 0 && totalPaginas > 1 && (
          <Card className="border-0 shadow-lg shadow-slate-200/50 mt-6">
            <CardContent className="p-4">
              <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                {/* Bot√≥n Anterior */}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setPaginaActual(p => Math.max(1, p - 1))}
                  disabled={paginaActual === 1}
                  className="w-full sm:w-auto"
                >
                  ‚Üê Anterior
                </Button>

                {/* N√∫meros de p√°gina */}
                <div className="flex flex-wrap items-center justify-center gap-1">
                  {generarNumerosPaginas().map((pagina, idx) => (
                    pagina === '...' ? (
                      <span key={`ellipsis-${idx}`} className="px-2 py-1 text-slate-400">...</span>
                    ) : (
                      <Button
                        key={pagina}
                        variant={paginaActual === pagina ? "default" : "outline"}
                        size="sm"
                        onClick={() => setPaginaActual(pagina)}
                        className={`min-w-[2.5rem] ${
                          paginaActual === pagina 
                            ? 'bg-slate-800 hover:bg-slate-700' 
                            : 'hover:bg-slate-100'
                        }`}
                      >
                        {pagina}
                      </Button>
                    )
                  ))}
                </div>

                {/* Bot√≥n Siguiente */}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setPaginaActual(p => Math.min(totalPaginas, p + 1))}
                  disabled={paginaActual === totalPaginas}
                  className="w-full sm:w-auto"
                >
                  Siguiente ‚Üí
                </Button>
              </div>

              {/* Selector de p√°gina directa (m√≥vil friendly) */}
              <div className="flex items-center justify-center gap-2 mt-4 pt-4 border-t border-slate-100">
                <label className="text-sm text-slate-600">Ir a p√°gina:</label>
                <Select
                  value={paginaActual.toString()}
                  onValueChange={(val) => setPaginaActual(parseInt(val))}
                >
                  <SelectTrigger className="w-20">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {Array.from({ length: totalPaginas }, (_, i) => i + 1).map(p => (
                      <SelectItem key={p} value={p.toString()}>{p}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </CardContent>
          </Card>
        )}
      </div>

      <AlertDialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open, id: deleteDialog.id, tipo: deleteDialog.tipo, registro: deleteDialog.registro })}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>¬øEst√° seguro de eliminar este {deleteDialog.registro?.tipo === 'Ingreso de Fruta' ? 'ingreso' : deleteDialog.registro?.tipo === 'Salida de Fruta' ? 'salida' : 'movimiento'}?</AlertDialogTitle>
            <AlertDialogDescription className="space-y-2">
              <p className="font-semibold text-amber-600">Esta acci√≥n actualizar√° stocks y saldos autom√°ticamente:</p>
              <ul className="text-sm space-y-1 list-disc list-inside">
                {deleteDialog.registro?.tipo === 'Ingreso de Fruta' && deleteDialog.registro?.pesajes?.length > 0 && (
                  <>
                    <li>Se restar√°n <strong>{deleteDialog.registro.pesajes.reduce((s, p) => s + (p.peso_neto || 0), 0).toFixed(2)} kg netos</strong> del stock de productos</li>
                    {deleteDialog.registro.movimiento_envases?.some(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0) && (
                      <li>Se revertir√°n los movimientos de envases asociados</li>
                    )}
                  </>
                )}
                {deleteDialog.registro?.tipo === 'Salida de Fruta' && deleteDialog.registro?.detalles?.length > 0 && (
                  <>
                    <li>Se devolver√°n <strong>{deleteDialog.registro.detalles.reduce((s, d) => s + ((d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0)), 0).toFixed(2)} kg</strong> al stock de productos</li>
                    {deleteDialog.registro.movimiento_envases?.some(e => e.cantidad_ingreso > 0 || e.cantidad_salida > 0) && (
                      <li>Se revertir√°n los movimientos de envases asociados</li>
                    )}
                  </>
                )}
                {deleteDialog.registro?.tipo === 'Movimiento de Envases' && deleteDialog.registro?.movimiento_envases?.length > 0 && (
                  <li>Se revertir√°n los movimientos de envases y saldos por entidad</li>
                )}
              </ul>
              <p className="text-xs text-slate-500 mt-2">Esta acci√≥n no se puede deshacer.</p>
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={isDeleting}
              className="bg-red-600 hover:bg-red-700"
            >
              {isDeleting ? 'Eliminando y actualizando...' : 'S√≠, Eliminar y Actualizar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      <EditarMovimientoModal
        open={editDialog.open}
        onClose={() => setEditDialog({ open: false, movimiento: null })}
        movimiento={editDialog.movimiento}
        onSave={handleSaveEdicion}
        isLoading={isProcessing}
        proveedores={proveedores}
        clientes={clientes}
        fleteros={fleteros}
      />

      <PINModal
        open={pinModal.open}
        onClose={() => setPinModal({ open: false, action: null, data: null })}
        onConfirm={confirmarConPIN}
        isLoading={isProcessing}
        title="Confirmar Edici√≥n"
      />
    </div>
  );
}
</file>

<file path="src/pages/Home.jsx">
import React from 'react';
import { Link } from 'react-router-dom';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { createPageUrl } from '@/utils';
import { Apple, ArrowLeftRight, History, FileText, Package, Scale, Users, Boxes, ShoppingCart, Box } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function Home() {
  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-created_date', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-created_date', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: envases = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });





  // M√≥dulos principales
  const modulosPrincipales = [
    { nombre: 'Movimiento de Fruta', icon: Apple, page: 'MovimientoFruta', color: 'bg-green-100 text-green-700' },
    { nombre: 'Inventario', icon: Package, page: 'Inventario', color: 'bg-teal-100 text-teal-700' },
    { nombre: 'Log√≠stica', icon: ShoppingCart, page: 'Logistica', color: 'bg-purple-100 text-purple-700' },
    { nombre: 'Tesorer√≠a', icon: Scale, page: 'Tesoreria', color: 'bg-indigo-100 text-indigo-700' },
    { nombre: 'Informes Contables', icon: FileText, page: 'InformesContables', color: 'bg-blue-100 text-blue-700' },
    { nombre: 'Historial', icon: History, page: 'Historial', color: 'bg-slate-100 text-slate-700' }
  ];

  const ultimosMovimientos = React.useMemo(() => {
    const todos = [];
    
    movimientos.forEach(m => {
      todos.push({
        ...m,
        tipo: m.tipo_movimiento,
        origen: 'movimiento',
        entidad_nombre: m.proveedor_nombre || m.cliente_nombre
      });
    });
    
    salidas.forEach(s => {
      todos.push({
        ...s,
        tipo: 'Salida de Fruta',
        origen: 'salida',
        entidad_nombre: s.cliente_nombre
      });
    });
    
    return todos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 15);
  }, [movimientos, salidas]);

  return (
    <div className="min-h-screen bg-slate-50">
      <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-20 h-20 rounded-2xl mb-4 overflow-hidden">
            <img 
              src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/694c069ad9a3c71a10fee653/2db155312_imagenesdeperfilISO_Mesadetrabajo1.jpg"
              alt="Logo Acopio"
              className="w-full h-full object-contain"
            />
          </div>
          <h1 className="text-3xl sm:text-4xl font-bold text-slate-800 mb-2">
            Gesti√≥n de Acopio
          </h1>
          <p className="text-slate-500 text-lg">
            Sistema de control de frutas y envases
          </p>
        </div>

        {/* M√≥dulos Principales */}
        <div className="mb-8">
          <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <Boxes className="h-6 w-6 text-indigo-600" />
            Acceso R√°pido a M√≥dulos
          </h2>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            {modulosPrincipales.map((modulo) => (
              <Link key={modulo.page} to={createPageUrl(modulo.page)}>
                <Card className="border-0 shadow-md hover:shadow-lg transition-all cursor-pointer h-full">
                  <CardContent className="p-6 flex flex-col items-center text-center">
                    <div className={`w-16 h-16 rounded-2xl flex items-center justify-center mb-3 ${modulo.color}`}>
                      <modulo.icon className="h-8 w-8" />
                    </div>
                    <p className="text-sm font-medium text-slate-700">{modulo.nombre}</p>
                  </CardContent>
                </Card>
              </Link>
            ))}
          </div>
        </div>

        {/* √öltimos Movimientos */}
        <Card className="border-0 shadow-lg">
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2">
              <History className="h-5 w-5 text-slate-400" />
              √öltimos Movimientos
            </CardTitle>
          </CardHeader>
          <CardContent>
            {ultimosMovimientos.length === 0 ? (
              <p className="text-center text-slate-500 py-8">
                No hay movimientos registrados
              </p>
            ) : (
              <div className="space-y-2">
                {ultimosMovimientos.map((mov, idx) => (
                  <div
                    key={`${mov.origen}-${mov.id}-${idx}`}
                    className="flex items-center gap-4 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors"
                  >
                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center shrink-0 ${
                      mov.tipo === 'Ingreso de Fruta' 
                        ? 'bg-green-100' 
                        : mov.tipo === 'Salida de Fruta'
                        ? 'bg-purple-100'
                        : 'bg-amber-100'
                    }`}>
                      {mov.tipo === 'Ingreso de Fruta' 
                        ? <Apple className="h-5 w-5 text-green-600" />
                        : mov.tipo === 'Salida de Fruta'
                        ? <ShoppingCart className="h-5 w-5 text-purple-600" />
                        : <ArrowLeftRight className="h-5 w-5 text-amber-600" />
                      }
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-slate-800 truncate">
                        {mov.entidad_nombre}
                      </p>
                      <p className="text-sm text-slate-500">
                        {format(new Date(mov.fecha), "dd/MM/yyyy HH:mm", { locale: es })}
                      </p>
                    </div>
                    <div className="text-right">
                      {mov.origen === 'movimiento' && mov.pesajes?.length > 0 && (
                        <p className="font-semibold text-green-700">
                          {mov.pesajes.reduce((s, p) => s + (p.peso_neto || 0), 0).toFixed(0)} kg
                        </p>
                      )}
                      {mov.origen === 'salida' && mov.detalles?.length > 0 && (
                        <p className="font-semibold text-purple-700">
                          {mov.detalles.reduce((s, d) => s + d.kilos_salida, 0).toFixed(0)} kg
                        </p>
                      )}
                      <Badge variant="outline" className="text-xs">
                        {mov.tipo === 'Ingreso de Fruta' ? 'Ingreso' : mov.tipo === 'Salida de Fruta' ? 'Salida' : 'Envases'}
                      </Badge>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Informes.jsx">
import React, { useState, useMemo } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { FileText, Download, FileDown, MessageCircle } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import SearchableSelect from "@/components/SearchableSelect";

export default function Informes() {
  const [tipoInforme, setTipoInforme] = useState('proveedor');
  const [proveedoresSeleccionados, setProveedoresSeleccionados] = useState([]);
  const [clientesSeleccionados, setClientesSeleccionados] = useState([]);
  const [fechaDesde, setFechaDesde] = useState('');
  const [fechaHasta, setFechaHasta] = useState('');
  const [productosSeleccionados, setProductosSeleccionados] = useState([]);
  
  // Campos seleccionables para el informe
  const [camposSeleccionados, setCamposSeleccionados] = useState({
    fecha: true,
    tipo: true,
    fletero: true,
    remito: true,
    comprobante: true,
    productos: true,
    pesajes_detallados: false,
    envases: true,
    totales: true,
    saldos: false
  });

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list('nombre'),
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list('nombre'),
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-created_date'),
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-created_date'),
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list(),
  });

  const movimientosFiltrados = useMemo(() => {
    if (tipoInforme === 'proveedor') {
      if (proveedoresSeleccionados.length === 0) return [];
      
      return movimientos.filter(m => {
        if (!proveedoresSeleccionados.includes(m.proveedor_id)) return false;
        
        const fechaMov = new Date(m.fecha);
        if (fechaDesde && fechaMov < new Date(fechaDesde)) return false;
        if (fechaHasta && fechaMov > new Date(fechaHasta + 'T23:59:59')) return false;
        
        return true;
      });
    } else {
      if (clientesSeleccionados.length === 0) return [];
      
      const movCliente = movimientos.filter(m => {
        if (!clientesSeleccionados.includes(m.cliente_id)) return false;
        const fechaMov = new Date(m.fecha);
        if (fechaDesde && fechaMov < new Date(fechaDesde)) return false;
        if (fechaHasta && fechaMov > new Date(fechaHasta + 'T23:59:59')) return false;
        return true;
      });

      const salidasCliente = salidas.filter(s => {
        if (!clientesSeleccionados.includes(s.cliente_id)) return false;
        const fechaSal = new Date(s.fecha);
        if (fechaDesde && fechaSal < new Date(fechaDesde)) return false;
        if (fechaHasta && fechaSal > new Date(fechaHasta + 'T23:59:59')) return false;
        return true;
      });

      return [...movCliente, ...salidasCliente].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    }
  }, [movimientos, salidas, tipoInforme, proveedoresSeleccionados, clientesSeleccionados, fechaDesde, fechaHasta]);

  const totales = useMemo(() => {
    const totalesProductos = {};
    const totalesEnvases = {};
    let totalDescuentos = 0;

    if (tipoInforme === 'proveedor') {
      movimientosFiltrados.forEach(m => {
        if (m.tipo_movimiento === 'Ingreso de Fruta' && m.pesajes) {
          m.pesajes.forEach(p => {
            if (!productosSeleccionados.length || productosSeleccionados.includes(p.producto_id)) {
              if (!totalesProductos[p.producto_nombre]) {
                totalesProductos[p.producto_nombre] = 0;
              }
              totalesProductos[p.producto_nombre] += p.peso_neto || 0;
            }
          });
        }

        if (m.movimiento_envases) {
          m.movimiento_envases.forEach(e => {
            if (!totalesEnvases[e.envase_tipo]) {
              totalesEnvases[e.envase_tipo] = { ingreso: 0, salida: 0 };
            }
            totalesEnvases[e.envase_tipo].ingreso += e.cantidad_ingreso || 0;
            totalesEnvases[e.envase_tipo].salida += e.cantidad_salida || 0;
          });
        }
      });
    } else {
      movimientosFiltrados.forEach(item => {
        if (item.detalles) {
          item.detalles.forEach(d => {
            if (!productosSeleccionados.length || productosSeleccionados.includes(d.producto_id)) {
              const kilosReales = d.kilos_reales || d.kilos_salida;
              const descuento = d.descuento_kg || 0;
              const efectivos = kilosReales - descuento;
              
              if (!totalesProductos[d.producto_nombre]) {
                totalesProductos[d.producto_nombre] = { originales: 0, efectivos: 0, descuentos: 0 };
              }
              totalesProductos[d.producto_nombre].originales += d.kilos_salida;
              totalesProductos[d.producto_nombre].efectivos += efectivos;
              totalesProductos[d.producto_nombre].descuentos += descuento;
              totalDescuentos += descuento;
            }
          });
        }

        if (item.movimiento_envases) {
          item.movimiento_envases.forEach(e => {
            if (!totalesEnvases[e.envase_tipo]) {
              totalesEnvases[e.envase_tipo] = { ingreso: 0, salida: 0 };
            }
            totalesEnvases[e.envase_tipo].ingreso += e.cantidad_ingreso || 0;
            totalesEnvases[e.envase_tipo].salida += e.cantidad_salida || 0;
          });
        }
      });
    }

    return { totalesProductos, totalesEnvases, totalDescuentos };
  }, [movimientosFiltrados, productosSeleccionados, tipoInforme]);

  const entidadesSeleccionadas = tipoInforme === 'proveedor'
    ? proveedores.filter(p => proveedoresSeleccionados.includes(p.id))
    : clientes.filter(c => clientesSeleccionados.includes(c.id));
  
  const nombreEntidades = entidadesSeleccionadas.length === 0 
    ? 'Ninguno' 
    : entidadesSeleccionadas.length === 1 
      ? entidadesSeleccionadas[0].nombre 
      : `${entidadesSeleccionadas.length} ${tipoInforme === 'proveedor' ? 'proveedores' : 'clientes'}`;

  const exportarPDF = () => {
    const periodoText = `${fechaDesde ? format(new Date(fechaDesde), 'dd/MM/yyyy') : 'Inicio'} - ${fechaHasta ? format(new Date(fechaHasta), 'dd/MM/yyyy') : 'Hoy'}`;
    
    // Construir encabezados din√°micos
    let headers = [];
    if (camposSeleccionados.fecha) headers.push('<th>Fecha</th>');
    if (camposSeleccionados.tipo) headers.push('<th>Tipo</th>');
    if (entidadesSeleccionadas.length > 1) {
      headers.push(`<th>${tipoInforme === 'proveedor' ? 'Proveedor' : 'Cliente'}</th>`);
    }
    if (tipoInforme === 'cliente') {
      if (camposSeleccionados.remito) headers.push('<th>Remito R</th>');
      if (camposSeleccionados.comprobante) headers.push('<th>Comp. Cliente</th>');
    } else {
      if (camposSeleccionados.fletero) headers.push('<th>Fletero</th>');
    }
    if (camposSeleccionados.productos) headers.push('<th>Productos</th>');
    if (camposSeleccionados.envases) headers.push('<th>Envases</th>');
    
    let movimientosHTML = '';
    if (tipoInforme === 'proveedor') {
      movimientosHTML = movimientosFiltrados.map(m => {
        let cells = [];
        if (camposSeleccionados.fecha) cells.push(`<td>${format(new Date(m.fecha), 'dd/MM/yyyy HH:mm')}</td>`);
        if (camposSeleccionados.tipo) cells.push(`<td>${m.tipo_movimiento}</td>`);
        if (entidadesSeleccionadas.length > 1) cells.push(`<td>${m.proveedor_nombre}</td>`);
        if (camposSeleccionados.fletero) cells.push(`<td>${m.fletero_nombre || '-'}</td>`);
        if (camposSeleccionados.productos) {
          const productosHTML = camposSeleccionados.pesajes_detallados && m.pesajes
            ? m.pesajes.map(p => `${p.producto_nombre}: Cant=${p.cantidad||1}, Bruto=${(p.peso_bruto||0).toFixed(2)}kg, Neto=${(p.peso_neto||0).toFixed(2)}kg`).join('<br>')
            : (m.pesajes?.map(p => `${p.producto_nombre}: ${(p.peso_neto || 0).toFixed(2)} kg`).join('<br>') || '-');
          cells.push(`<td>${productosHTML}</td>`);
        }
        if (camposSeleccionados.envases) {
          cells.push(`<td>${m.movimiento_envases?.map(e => `${e.envase_tipo}: +${e.cantidad_ingreso || 0}/-${e.cantidad_salida || 0}`).join('<br>') || '-'}</td>`);
        }
        return `<tr>${cells.join('')}</tr>`;
      }).join('');
    } else {
      movimientosHTML = movimientosFiltrados.map(item => {
        let cells = [];
        if (camposSeleccionados.fecha) cells.push(`<td>${format(new Date(item.fecha), 'dd/MM/yyyy HH:mm')}</td>`);
        if (camposSeleccionados.tipo) cells.push(`<td>${item.detalles ? 'Salida de Fruta' : 'Movimiento de Envases'}</td>`);
        if (entidadesSeleccionadas.length > 1) cells.push(`<td>${item.cliente_nombre}</td>`);
        if (camposSeleccionados.remito) cells.push(`<td>${item.numero_remito || '-'}</td>`);
        if (camposSeleccionados.comprobante) cells.push(`<td>${item.comprobante_cliente || '-'}</td>`);
        if (camposSeleccionados.productos) {
          const productosText = item.detalles?.map(d => {
            const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
            return `${d.producto_nombre}: ${efectivos.toFixed(2)} kg`;
          }).join('<br>') || '-';
          cells.push(`<td>${productosText}</td>`);
        }
        if (camposSeleccionados.envases) {
          cells.push(`<td>${item.movimiento_envases?.map(e => `${e.envase_tipo}: +${e.cantidad_ingreso || 0}/-${e.cantidad_salida || 0}`).join('<br>') || '-'}</td>`);
        }
        return `<tr>${cells.join('')}</tr>`;
      }).join('');
    }

    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Informe - ${entidadSeleccionada?.nombre}</title>
        <style>
          body { font-family: Arial, sans-serif; font-size: 11px; padding: 20px; }
          .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; }
          .title { font-size: 20px; font-weight: bold; color: #1e40af; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #eff6ff; font-weight: 600; }
          .totales { background: #dbeafe; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="title">INFORME ${tipoInforme === 'proveedor' ? 'DE PROVEEDOR(ES)' : 'DE CLIENTE(S)'}</div>
          <p>${nombreEntidades}</p>
          <p>Per√≠odo: ${periodoText}</p>
        </div>
        
        ${headers.length > 0 ? `
        <h3>Detalle de Movimientos</h3>
        <table>
          <thead>
            <tr>
              ${headers.join('')}
            </tr>
          </thead>
          <tbody>
            ${movimientosHTML}
          </tbody>
        </table>` : ''}

        ${camposSeleccionados.totales ? '<h3>Totales del Per√≠odo</h3>' : ''}
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Total Peso Neto</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(totales.totalesProductos).map(([prod, datos]) => `
              <tr>
                <td>${prod}</td>
                <td>${tipoInforme === 'proveedor' ? datos.toFixed(2) : datos.efectivos.toFixed(2)} kg</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <p>Generado: ${format(new Date(), 'dd/MM/yyyy HH:mm')}</p>
      </body>
      </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
  };

  const exportarCSV = () => {
    let csv = `Informe ${tipoInforme === 'proveedor' ? 'de Proveedor(es)' : 'de Cliente(s)'} - ${nombreEntidades}\n`;
    csv += `Per√≠odo: ${fechaDesde || 'Inicio'} - ${fechaHasta || 'Actual'}\n\n`;

    // Encabezados din√°micos basados en campos seleccionados
    let headers = [];
    if (camposSeleccionados.fecha) headers.push('Fecha');
    if (camposSeleccionados.tipo) headers.push('Tipo');
    if (entidadesSeleccionadas.length > 1) headers.push(tipoInforme === 'proveedor' ? 'Proveedor' : 'Cliente');
    if (tipoInforme === 'proveedor' && camposSeleccionados.fletero) headers.push('Fletero');
    if (tipoInforme === 'cliente') {
      if (camposSeleccionados.remito) headers.push('Remito R');
      if (camposSeleccionados.comprobante) headers.push('Comp. Cliente');
    }
    if (camposSeleccionados.productos) headers.push('Productos');
    if (camposSeleccionados.envases) headers.push('Envases');
    
    csv += headers.join(',') + '\n';

    if (tipoInforme === 'proveedor') {
      movimientosFiltrados.forEach(m => {
        let row = [];
        if (camposSeleccionados.fecha) row.push(`"${format(new Date(m.fecha), 'dd/MM/yyyy HH:mm')}"`);
        if (camposSeleccionados.tipo) row.push(`"${m.tipo_movimiento}"`);
        if (entidadesSeleccionadas.length > 1) row.push(`"${m.proveedor_nombre}"`);
        if (camposSeleccionados.fletero) row.push(`"${m.fletero_nombre || ''}"`);
        if (camposSeleccionados.productos) {
          const productos = m.pesajes?.map(p => `${p.producto_nombre}:${p.peso_neto}kg`).join(';') || '';
          row.push(`"${productos}"`);
        }
        if (camposSeleccionados.envases) {
          const envases = m.movimiento_envases?.map(e => `${e.envase_tipo}:+${e.cantidad_ingreso}/-${e.cantidad_salida}`).join(';') || '';
          row.push(`"${envases}"`);
        }
        csv += row.join(',') + '\n';
      });
    } else {
      movimientosFiltrados.forEach(item => {
        let row = [];
        if (camposSeleccionados.fecha) row.push(`"${format(new Date(item.fecha), 'dd/MM/yyyy HH:mm')}"`);
        if (camposSeleccionados.tipo) row.push(`"${item.detalles ? 'Salida de Fruta' : 'Movimiento de Envases'}"`);
        if (entidadesSeleccionadas.length > 1) row.push(`"${item.cliente_nombre}"`);
        if (camposSeleccionados.remito) row.push(`"${item.numero_remito || ''}"`);
        if (camposSeleccionados.comprobante) row.push(`"${item.comprobante_cliente || ''}"`);
        if (camposSeleccionados.productos) {
          const productos = item.detalles?.map(d => {
            const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
            return `${d.producto_nombre}:${efectivos.toFixed(2)}kg`;
          }).join(';') || '';
          row.push(`"${productos}"`);
        }
        if (camposSeleccionados.envases) {
          const envases = item.movimiento_envases?.map(e => `${e.envase_tipo}:+${e.cantidad_ingreso}/-${e.cantidad_salida}`).join(';') || '';
          row.push(`"${envases}"`);
        }
        csv += row.join(',') + '\n';
      });
    }

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const nombreArchivo = entidadesSeleccionadas.length === 1 
      ? entidadesSeleccionadas[0].nombre.replace(/\s+/g, '_')
      : `${entidadesSeleccionadas.length}_${tipoInforme}s`;
    link.download = `informe_${nombreArchivo}_${format(new Date(), 'yyyyMMdd')}.csv`;
    link.click();
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto space-y-6">
        <div>
          <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
            <FileText className="h-8 w-8 text-blue-600" />
            Informes
          </h1>
          <p className="text-slate-600 mt-1">Generar reportes detallados de proveedores y clientes</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <div className="lg:col-span-1 space-y-4">
            <Card className="border-0 shadow-lg">
              <CardHeader>
                <CardTitle className="text-lg">Filtros</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Tipo de Entidad *</label>
                  <Select value={tipoInforme} onValueChange={(val) => {
                    setTipoInforme(val);
                    setProveedoresSeleccionados([]);
                    setClientesSeleccionados([]);
                  }}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="proveedor">Proveedor</SelectItem>
                      <SelectItem value="cliente">Cliente</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {tipoInforme === 'proveedor' ? (
                  <div>
                    <label className="text-sm font-medium text-slate-700 mb-2 flex items-center justify-between">
                      <span>Proveedores *</span>
                      <button
                        onClick={() => {
                          if (proveedoresSeleccionados.length === proveedores.length) {
                            setProveedoresSeleccionados([]);
                          } else {
                            setProveedoresSeleccionados(proveedores.map(p => p.id));
                          }
                        }}
                        className="text-xs text-blue-600 hover:text-blue-700"
                      >
                        {proveedoresSeleccionados.length === proveedores.length ? 'Desmarcar todos' : 'Marcar todos'}
                      </button>
                    </label>
                    <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                      {proveedores.length === 0 ? (
                        <p className="text-sm text-slate-500 text-center">No hay proveedores</p>
                      ) : (
                        proveedores.map(p => (
                          <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-2 rounded">
                            <input
                              type="checkbox"
                              checked={proveedoresSeleccionados.includes(p.id)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setProveedoresSeleccionados([...proveedoresSeleccionados, p.id]);
                                } else {
                                  setProveedoresSeleccionados(proveedoresSeleccionados.filter(id => id !== p.id));
                                }
                              }}
                              className="rounded"
                            />
                            <span className="text-sm">{p.nombre}</span>
                          </label>
                        ))
                      )}
                    </div>
                    {proveedoresSeleccionados.length > 0 && (
                      <p className="text-xs text-slate-600 mt-2">
                        {proveedoresSeleccionados.length} seleccionado(s)
                      </p>
                    )}
                  </div>
                ) : (
                  <div>
                    <label className="text-sm font-medium text-slate-700 mb-2 flex items-center justify-between">
                      <span>Clientes *</span>
                      <button
                        onClick={() => {
                          if (clientesSeleccionados.length === clientes.length) {
                            setClientesSeleccionados([]);
                          } else {
                            setClientesSeleccionados(clientes.map(c => c.id));
                          }
                        }}
                        className="text-xs text-blue-600 hover:text-blue-700"
                      >
                        {clientesSeleccionados.length === clientes.length ? 'Desmarcar todos' : 'Marcar todos'}
                      </button>
                    </label>
                    <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                      {clientes.length === 0 ? (
                        <p className="text-sm text-slate-500 text-center">No hay clientes</p>
                      ) : (
                        clientes.map(c => (
                          <label key={c.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-2 rounded">
                            <input
                              type="checkbox"
                              checked={clientesSeleccionados.includes(c.id)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setClientesSeleccionados([...clientesSeleccionados, c.id]);
                                } else {
                                  setClientesSeleccionados(clientesSeleccionados.filter(id => id !== c.id));
                                }
                              }}
                              className="rounded"
                            />
                            <span className="text-sm">{c.nombre}</span>
                          </label>
                        ))
                      )}
                    </div>
                    {clientesSeleccionados.length > 0 && (
                      <p className="text-xs text-slate-600 mt-2">
                        {clientesSeleccionados.length} seleccionado(s)
                      </p>
                    )}
                  </div>
                )}

                <div>
                  <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha Desde</label>
                  <Input
                    type="date"
                    value={fechaDesde}
                    onChange={(e) => setFechaDesde(e.target.value)}
                  />
                </div>

                <div>
                  <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha Hasta</label>
                  <Input
                    type="date"
                    value={fechaHasta}
                    onChange={(e) => setFechaHasta(e.target.value)}
                  />
                </div>

                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Productos</label>
                  <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                    {productos.length === 0 ? (
                      <p className="text-sm text-slate-500 text-center">No hay productos</p>
                    ) : (
                      productos.map(p => (
                        <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-1 rounded">
                          <input
                            type="checkbox"
                            checked={productosSeleccionados.includes(p.id)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setProductosSeleccionados([...productosSeleccionados, p.id]);
                              } else {
                                setProductosSeleccionados(productosSeleccionados.filter(id => id !== p.id));
                              }
                            }}
                            className="rounded"
                          />
                          <span className="text-sm">{p.producto_completo || `${p.fruta} - ${p.variedad}`}</span>
                        </label>
                      ))
                    )}
                  </div>
                  {productosSeleccionados.length > 0 && (
                    <button
                      onClick={() => setProductosSeleccionados([])}
                      className="text-xs text-blue-600 hover:text-blue-700 mt-2"
                    >
                      Limpiar selecci√≥n ({productosSeleccionados.length})
                    </button>
                  )}
                </div>
              </CardContent>
            </Card>

            <Card className="border-0 shadow-lg">
              <CardHeader>
                <CardTitle className="text-lg">Campos a Incluir</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                    <input
                      type="checkbox"
                      checked={camposSeleccionados.fecha}
                      onChange={(e) => setCamposSeleccionados({...camposSeleccionados, fecha: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-sm">Fecha</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                    <input
                      type="checkbox"
                      checked={camposSeleccionados.tipo}
                      onChange={(e) => setCamposSeleccionados({...camposSeleccionados, tipo: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-sm">Tipo de Movimiento</span>
                  </label>
                  {tipoInforme === 'proveedor' && (
                    <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                      <input
                        type="checkbox"
                        checked={camposSeleccionados.fletero}
                        onChange={(e) => setCamposSeleccionados({...camposSeleccionados, fletero: e.target.checked})}
                        className="rounded"
                      />
                      <span className="text-sm">Fletero</span>
                    </label>
                  )}
                  {tipoInforme === 'cliente' && (
                    <>
                      <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                        <input
                          type="checkbox"
                          checked={camposSeleccionados.remito}
                          onChange={(e) => setCamposSeleccionados({...camposSeleccionados, remito: e.target.checked})}
                          className="rounded"
                        />
                        <span className="text-sm">Remito R</span>
                      </label>
                      <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                        <input
                          type="checkbox"
                          checked={camposSeleccionados.comprobante}
                          onChange={(e) => setCamposSeleccionados({...camposSeleccionados, comprobante: e.target.checked})}
                          className="rounded"
                        />
                        <span className="text-sm">Comprobante Cliente</span>
                      </label>
                    </>
                  )}
                  <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                    <input
                      type="checkbox"
                      checked={camposSeleccionados.productos}
                      onChange={(e) => setCamposSeleccionados({...camposSeleccionados, productos: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-sm">Productos</span>
                  </label>
                  {tipoInforme === 'proveedor' && (
                    <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded ml-4">
                      <input
                        type="checkbox"
                        checked={camposSeleccionados.pesajes_detallados}
                        onChange={(e) => setCamposSeleccionados({...camposSeleccionados, pesajes_detallados: e.target.checked})}
                        className="rounded"
                        disabled={!camposSeleccionados.productos}
                      />
                      <span className="text-sm text-slate-600">Pesajes Detallados</span>
                    </label>
                  )}
                  <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                    <input
                      type="checkbox"
                      checked={camposSeleccionados.envases}
                      onChange={(e) => setCamposSeleccionados({...camposSeleccionados, envases: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-sm">Movimiento de Envases</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-2 rounded">
                    <input
                      type="checkbox"
                      checked={camposSeleccionados.totales}
                      onChange={(e) => setCamposSeleccionados({...camposSeleccionados, totales: e.target.checked})}
                      className="rounded"
                    />
                    <span className="text-sm">Totales del Per√≠odo</span>
                  </label>
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  className="w-full mt-3"
                  onClick={() => setCamposSeleccionados({
                    fecha: true,
                    tipo: true,
                    fletero: true,
                    remito: true,
                    comprobante: true,
                    productos: true,
                    pesajes_detallados: false,
                    envases: true,
                    totales: true,
                    saldos: false
                  })}
                >
                  Seleccionar Todos
                </Button>
              </CardContent>
            </Card>

            {(proveedoresSeleccionados.length > 0 || clientesSeleccionados.length > 0) && movimientosFiltrados.length > 0 && (
              <Card className="border-0 shadow-lg">
                <CardHeader>
                  <CardTitle className="text-lg">Exportar</CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <Button onClick={exportarPDF} className="w-full" variant="default">
                    <FileDown className="h-4 w-4 mr-2" />
                    Exportar a PDF
                  </Button>
                  <Button onClick={exportarCSV} className="w-full" variant="outline">
                    <Download className="h-4 w-4 mr-2" />
                    Exportar a CSV
                  </Button>
                </CardContent>
              </Card>
            )}
          </div>

          <div className="lg:col-span-3">
            {(tipoInforme === 'proveedor' ? proveedoresSeleccionados.length === 0 : clientesSeleccionados.length === 0) ? (
              <Card className="border-0 shadow-lg">
                <CardContent className="p-12 text-center">
                  <FileText className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-slate-700 mb-2">
                    Seleccione {tipoInforme === 'proveedor' ? 'proveedores' : 'clientes'}
                  </h3>
                  <p className="text-slate-500">
                    Marque uno o m√°s {tipoInforme === 'proveedor' ? 'proveedores' : 'clientes'} en el panel de filtros para generar el informe
                  </p>
                </CardContent>
              </Card>
            ) : movimientosFiltrados.length === 0 ? (
              <Card className="border-0 shadow-lg">
                <CardContent className="p-12 text-center">
                  <FileText className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-slate-700 mb-2">Sin movimientos</h3>
                  <p className="text-slate-500">No hay datos para el per√≠odo seleccionado</p>
                </CardContent>
              </Card>
            ) : (
              <div className="space-y-6">
                <Card className="border-0 shadow-lg">
                  <CardHeader>
                    <CardTitle className="flex items-center justify-between">
                      <span>Informe - {nombreEntidades}</span>
                      <Badge variant="outline">
                        {movimientosFiltrados.length} movimiento(s)
                      </Badge>
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-slate-100">
                          <tr>
                            {camposSeleccionados.fecha && <th className="text-left p-3 font-semibold">Fecha</th>}
                            {camposSeleccionados.tipo && <th className="text-left p-3 font-semibold">Tipo</th>}
                            {entidadesSeleccionadas.length > 1 && <th className="text-left p-3 font-semibold">{tipoInforme === 'proveedor' ? 'Proveedor' : 'Cliente'}</th>}
                            {tipoInforme === 'cliente' && (
                              <>
                                {camposSeleccionados.remito && <th className="text-left p-3 font-semibold">Remito R</th>}
                                {camposSeleccionados.comprobante && <th className="text-left p-3 font-semibold">Comp. Cliente</th>}
                              </>
                            )}
                            {tipoInforme === 'proveedor' && camposSeleccionados.fletero && <th className="text-left p-3 font-semibold">Fletero</th>}
                            {camposSeleccionados.productos && <th className="text-left p-3 font-semibold">Productos</th>}
                            {camposSeleccionados.envases && <th className="text-left p-3 font-semibold">Envases</th>}
                          </tr>
                        </thead>
                        <tbody>
                          {movimientosFiltrados.map((item, idx) => {
                            const esMovimiento = item.tipo_movimiento !== undefined;
                            const esSalida = item.detalles !== undefined;
                            
                            return (
                              <tr key={idx} className="border-b hover:bg-slate-50">
                                {camposSeleccionados.fecha && <td className="p-3">{format(new Date(item.fecha), 'dd/MM/yyyy HH:mm')}</td>}
                                {camposSeleccionados.tipo && (
                                  <td className="p-3">
                                    <Badge variant="outline">
                                      {esMovimiento ? item.tipo_movimiento : 'Salida de Fruta'}
                                    </Badge>
                                  </td>
                                )}
                                {entidadesSeleccionadas.length > 1 && (
                                  <td className="p-3 text-sm font-medium">
                                    {tipoInforme === 'proveedor' ? item.proveedor_nombre : item.cliente_nombre}
                                  </td>
                                )}
                                {tipoInforme === 'cliente' && (
                                  <>
                                    {camposSeleccionados.remito && <td className="p-3 font-mono text-xs">{item.numero_remito || '-'}</td>}
                                    {camposSeleccionados.comprobante && <td className="p-3 text-xs">{item.comprobante_cliente || '-'}</td>}
                                  </>
                                )}
                                {tipoInforme === 'proveedor' && camposSeleccionados.fletero && <td className="p-3">{item.fletero_nombre || '-'}</td>}
                                {camposSeleccionados.productos && (
                                  <td className="p-3">
                                    {item.pesajes?.map((p, i) => (
                                      <div key={i} className="text-xs">
                                        {p.producto_nombre}: <span className="font-semibold text-green-700">{(p.peso_neto || 0).toFixed(2)} kg</span>
                                      </div>
                                    ))}
                                    {item.detalles?.map((d, i) => {
                                      const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
                                      return (
                                        <div key={i} className="text-xs">
                                          {d.producto_nombre}: <span className="font-semibold text-purple-700">{efectivos.toFixed(2)} kg</span>
                                          {d.descuento_kg > 0 && <span className="text-red-600"> (-{d.descuento_kg.toFixed(2)})</span>}
                                        </div>
                                      );
                                    })}
                                    {!item.pesajes && !item.detalles && '-'}
                                  </td>
                                )}
                                {camposSeleccionados.envases && (
                                  <td className="p-3">
                                    {item.movimiento_envases?.map((e, i) => (
                                      <div key={i} className="text-xs">
                                        {e.envase_tipo}: 
                                        {e.cantidad_ingreso > 0 && <span className="text-green-600"> +{e.cantidad_ingreso}</span>}
                                        {e.cantidad_salida > 0 && <span className="text-red-600"> -{e.cantidad_salida}</span>}
                                      </div>
                                    )) || '-'}
                                  </td>
                                )}
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </CardContent>
                </Card>

                {camposSeleccionados.totales && (
                <Card className="border-0 shadow-lg">
                  <CardHeader>
                    <CardTitle>Totales del Per√≠odo</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-6">
                    {Object.keys(totales.totalesProductos).length > 0 && (
                      <div>
                        <h4 className="font-semibold text-slate-700 mb-3">Total por Producto</h4>
                        <div className="space-y-2">
                          {Object.entries(totales.totalesProductos).map(([prod, datos]) => (
                            <div key={prod} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                              <span className="font-medium">{prod}</span>
                              <span className="text-lg font-bold text-blue-700">
                                {tipoInforme === 'proveedor' 
                                  ? `${datos.toFixed(2)} kg` 
                                  : `${datos.efectivos.toFixed(2)} kg efectivos`
                                }
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {Object.keys(totales.totalesEnvases).length > 0 && (
                      <div>
                        <h4 className="font-semibold text-slate-700 mb-3">Total Movimiento de Envases</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead className="bg-slate-50">
                              <tr>
                                <th className="text-left p-2">Tipo</th>
                                <th className="text-right p-2">Ingresos</th>
                                <th className="text-right p-2">Salidas</th>
                                <th className="text-right p-2">Saldo Per√≠odo</th>
                              </tr>
                            </thead>
                            <tbody>
                              {Object.entries(totales.totalesEnvases).map(([tipo, datos]) => {
                                const saldo = datos.salida - datos.ingreso;
                                return (
                                  <tr key={tipo} className="border-b">
                                    <td className="p-2">{tipo}</td>
                                    <td className="p-2 text-right text-green-600 font-semibold">+{datos.ingreso}</td>
                                    <td className="p-2 text-right text-red-600 font-semibold">-{datos.salida}</td>
                                    <td className={`p-2 text-right font-bold ${saldo > 0 ? 'text-red-600' : saldo < 0 ? 'text-green-600' : 'text-slate-600'}`}>
                                      {saldo > 0 ? '+' : ''}{saldo}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/InformesContables.jsx">
import React, { useState, useMemo } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { FileText, TrendingUp, TrendingDown, DollarSign, Calendar, Download, FileDown, Scale, Apple, Package, AlertTriangle, Users, Box, CheckCircle, ChevronLeft, ChevronRight } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import SearchableSelect from "@/components/SearchableSelect";
import { format, parseISO, isWithinInterval } from 'date-fns';
import { es } from 'date-fns/locale';
import { usePreciosCache } from '@/components/hooks/usePreciosCache';
import { exportarExcel } from '@/components/ExportarExcel';

export default function InformesContables() {
  const [activeTab, setActiveTab] = useState('situacion');
  const [fechaDesde, setFechaDesde] = useState(format(new Date(new Date().getFullYear(), 0, 1), "yyyy-MM-dd"));
  const [fechaHasta, setFechaHasta] = useState(format(new Date(), "yyyy-MM-dd"));
  const [productoSeleccionadoIndex, setProductoSeleccionadoIndex] = React.useState(0);
  
  // Estados para Informe de Proveedores
  const [proveedoresInforme, setProveedoresInforme] = useState([]);
  const [fechaDesdeProveedores, setFechaDesdeProveedores] = useState('');
  const [fechaHastaProveedores, setFechaHastaProveedores] = useState('');
  const [productosFiltroProveedores, setProductosFiltroProveedores] = useState([]);
  

  
  // Hook centralizado para cach√© de precios
  const { obtenerPrecioVigente: obtenerPrecioVigenteCache } = usePreciosCache();

  // Estados para Informes Operativos
  const [tipoInforme, setTipoInforme] = useState('proveedor');
  const [proveedoresSeleccionados, setProveedoresSeleccionados] = useState([]);
  const [clientesSeleccionados, setClientesSeleccionados] = useState([]);
  const [fechaDesdeOp, setFechaDesdeOp] = useState('');
  const [fechaHastaOp, setFechaHastaOp] = useState('');
  const [productosSeleccionados, setProductosSeleccionados] = useState([]);
  const [busquedaProveedor, setBusquedaProveedor] = useState('');
  const [busquedaCliente, setBusquedaCliente] = useState('');
  const [paginaActual, setPaginaActual] = useState(1);
  const registrosPorPagina = 20;
  const [camposSeleccionados, setCamposSeleccionados] = useState({
    fecha: true,
    tipo: true,
    fletero: true,
    remito: true,
    comprobante: true,
    productos: true,
    pesajes_detallados: false,
    envases: true,
    totales: true,
    saldos: false
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: egresos = [] } = useQuery({
    queryKey: ['egresos'],
    queryFn: () => base44.entities.Egreso.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: ingresosvarios = [] } = useQuery({
    queryKey: ['ingresosvarios'],
    queryFn: () => base44.entities.IngresoVario.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: pagos = [] } = useQuery({
    queryKey: ['pagos'],
    queryFn: () => base44.entities.Pago.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: cobros = [] } = useQuery({
    queryKey: ['cobros'],
    queryFn: () => base44.entities.Cobro.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria'],
    queryFn: () => base44.entities.MovimientoTesoreria.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list(),
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list('nombre'),
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list('nombre'),
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: envases = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list(),
    staleTime: 30 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  const { data: ajustesManuales = [] } = useQuery({
    queryKey: ['ajustes-manuales'],
    queryFn: () => base44.entities.AjusteManualEnvase.list(),
    staleTime: 15 * 60 * 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DASHBOARD SITUACI√ìN ACTUAL DEL ACOPIO
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const perdidasEfectivas = useMemo(() => {
    const salidasConfirmadas = salidas.filter(s => s.estado === 'Confirmada');
    let perdidaBascula = 0;
    let perdidaCalidad = 0;
    
    salidasConfirmadas.forEach(s => {
      s.detalles?.forEach(d => {
        const original = d.kilos_salida || 0;
        const reales = d.kilos_reales || original;
        const descuento = d.descuento_kg || 0;
        
        perdidaBascula += (original - reales);
        perdidaCalidad += descuento;
      });
    });
    
    const total = perdidaBascula + perdidaCalidad;
    return { bascula: perdidaBascula, calidad: perdidaCalidad, total };
  }, [salidas]);

  const ingresosTotalesPorProducto = useMemo(() => {
    const ingresosMap = {};
    
    movimientos.forEach(m => {
      if (m.tipo_movimiento === 'Ingreso de Fruta' && m.pesajes) {
        m.pesajes.forEach(p => {
          if (p.producto_id && p.peso_neto > 0) {
            if (!ingresosMap[p.producto_id]) {
              ingresosMap[p.producto_id] = {
                id: p.producto_id,
                nombre: p.producto_nombre || 'Producto sin nombre',
                kilosAcumulados: 0
              };
            }
            ingresosMap[p.producto_id].kilosAcumulados += p.peso_neto;
          }
        });
      }
    });
    
    return Object.values(ingresosMap)
      .filter(p => p.kilosAcumulados > 0)
      .sort((a, b) => b.kilosAcumulados - a.kilosAcumulados);
  }, [movimientos]);

  const totalIngresosAcumulados = useMemo(() => {
    return ingresosTotalesPorProducto.reduce((sum, p) => sum + p.kilosAcumulados, 0);
  }, [ingresosTotalesPorProducto]);

  const frutaRealACobrar = useMemo(() => {
    return totalIngresosAcumulados - perdidasEfectivas.total;
  }, [totalIngresosAcumulados, perdidasEfectivas]);

  const perdidasPorProducto = useMemo(() => {
    const perdidasMap = {};
    
    salidas.forEach(s => {
      if (s.estado === 'Confirmada' && s.detalles) {
        s.detalles.forEach(d => {
          if (d.producto_id) {
            if (!perdidasMap[d.producto_id]) {
              perdidasMap[d.producto_id] = 0;
            }
            const original = d.kilos_salida || 0;
            const reales = d.kilos_reales || original;
            const descuento = d.descuento_kg || 0;
            const perdidaTotal = (original - reales) + descuento;
            perdidasMap[d.producto_id] += perdidaTotal;
          }
        });
      }
    });
    
    return perdidasMap;
  }, [salidas]);

  const gananciaPotencial = useMemo(() => {
    let totalCompra = 0;
    let totalVenta = 0;
    
    movimientos.forEach(m => {
      if (m.tipo_movimiento === 'Ingreso de Fruta' && m.pesajes) {
        m.pesajes.forEach(p => {
          if (p.producto_id && p.peso_neto > 0) {
            const precioCompra = obtenerPrecioVigenteCache(p.producto_id, m.fecha, 'compra');
            const precioVenta = obtenerPrecioVigenteCache(p.producto_id, m.fecha, 'venta');
            
            const costoCompra = p.peso_neto * precioCompra;
            
            const perdidasProducto = perdidasPorProducto[p.producto_id] || 0;
            const ingresosTotalesProducto = ingresosTotalesPorProducto.find(ing => ing.id === p.producto_id)?.kilosAcumulados || p.peso_neto;
            const proporcionPerdida = ingresosTotalesProducto > 0 ? perdidasProducto / ingresosTotalesProducto : 0;
            const kilosReales = p.peso_neto * (1 - proporcionPerdida);
            const ingresoVenta = kilosReales * precioVenta;
            
            totalCompra += costoCompra;
            totalVenta += ingresoVenta;
          }
        });
      }
    });
    
    const ganancia = totalVenta - totalCompra;
    
    return {
      totalCompra,
      totalVenta,
      ganancia,
      margen: totalCompra > 0 ? (ganancia / totalCompra) * 100 : 0
    };
  }, [movimientos, obtenerPrecioVigenteCache, perdidasPorProducto, ingresosTotalesPorProducto]);

  const statsAcopio = useMemo(() => {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    const movHoy = movimientos.filter(m => new Date(m.fecha) >= hoy);
    const ingresosHoy = movHoy.filter(m => m.tipo_movimiento === 'Ingreso de Fruta');
    
    const pesoNetoHoy = ingresosHoy.reduce((sum, m) => 
      sum + (m.pesajes?.reduce((s, p) => s + (p.peso_neto || 0), 0) || 0), 0
    );

    // Stock de envases: lectura desde entidad (stocks vivos)
    const totalVacios = envases.reduce((sum, e) => sum + (Number(e.stock_vacios) || 0), 0);
    const totalOcupados = envases.reduce((sum, e) => sum + (Number(e.stock_ocupados) || 0), 0);
    const stockTotalKilos = productos.reduce((sum, p) => sum + (p.stock || 0), 0);

    return {
      ingresosHoy: ingresosHoy.length,
      pesoNetoHoy,
      totalVacios,
      totalOcupados,
      stockTotalKilos
    };
  }, [movimientos, salidas, productos, envases]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FIN DASHBOARD SITUACI√ìN ACTUAL
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const estadoResultado = useMemo(() => {
    const desde = parseISO(fechaDesde);
    const hasta = parseISO(fechaHasta);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INGRESOS: Solo ventas cobradas (cobros realizados)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let ingresosPorVentas = 0;
    const cobrosPeriodo = cobros.filter(c => {
      const fechaCobro = parseISO(c.fecha);
      if (!isWithinInterval(fechaCobro, { start: desde, end: hasta })) return false;
      
      // SOLO cobros con MovimientoTesoreria (efectivamente realizados)
      const tieneMovimientos = movimientosTesoreria.some(m => 
        m.referencia_origen_id === c.id && m.referencia_origen_tipo === 'Cobro'
      );
      return tieneMovimientos;
    });
    
    ingresosPorVentas = cobrosPeriodo.reduce((sum, c) => sum + (c.monto_total || 0), 0);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // OTROS INGRESOS: Solo IngresoVario con MovimientoTesoreria
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ingresosPorCuenta = {};
    const ingresosVariosPeriodo = ingresosvarios.filter(iv => {
      const fechaIV = parseISO(iv.fecha);
      if (!isWithinInterval(fechaIV, { start: desde, end: hasta })) return false;
      
      // SOLO ingresos con MovimientoTesoreria (efectivamente realizados)
      const tieneMovimientos = movimientosTesoreria.some(m => 
        m.referencia_origen_id === iv.id && m.referencia_origen_tipo === 'IngresoVario'
      );
      return tieneMovimientos;
    });
    
    ingresosVariosPeriodo.forEach(iv => {
      const cuentaKey = iv.cuenta_nombre || 'Sin categor√≠a';
      if (!ingresosPorCuenta[cuentaKey]) {
        ingresosPorCuenta[cuentaKey] = 0;
      }
      ingresosPorCuenta[cuentaKey] += iv.monto || 0;
    });

    const totalIngresosVarios = Object.values(ingresosPorCuenta).reduce((sum, v) => sum + v, 0);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COSTO DE VENTAS: SOLO costo de compra de fruta (UNA SOLA VEZ)
    // Se calcula: kilos comprados √ó precio de compra vigente
    // NO incluir: pagos, deudas, egresos, ni otros conceptos
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let costoCompraFruta = 0;
    const movimientosPeriodo = movimientos.filter(m => {
      const fechaMov = parseISO(m.fecha);
      return m.tipo_movimiento === 'Ingreso de Fruta' && isWithinInterval(fechaMov, { start: desde, end: hasta });
    });

    movimientosPeriodo.forEach(mov => {
      mov.pesajes?.forEach(pesaje => {
        const pesoNeto = pesaje.peso_neto || 0;
        const precioCompra = obtenerPrecioVigenteCache(pesaje.producto_id, mov.fecha, 'compra');
        costoCompraFruta += pesoNeto * precioCompra;
      });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GASTOS OPERATIVOS: Solo egresos clasificados como "Gasto"
    // NO incluir pagos de deudas comerciales
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const gastosPorCuenta = {};
    const gastosPeriodo = egresos.filter(e => {
      const fechaEgr = parseISO(e.fecha);
      return e.tipo === 'Gasto' && isWithinInterval(fechaEgr, { start: desde, end: hasta });
    });
    
    gastosPeriodo.forEach(e => {
      const cuentaKey = e.cuenta_nombre || 'Sin categor√≠a';
      if (!gastosPorCuenta[cuentaKey]) {
        gastosPorCuenta[cuentaKey] = 0;
      }
      gastosPorCuenta[cuentaKey] += e.monto || 0;
    });

    const totalGastos = Object.values(gastosPorCuenta).reduce((sum, v) => sum + v, 0);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // C√ÅLCULOS FINALES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ingresosTotales = ingresosPorVentas + totalIngresosVarios;
    const costoVentasTotal = costoCompraFruta; // SOLO costo de compra de fruta
    const utilidadBruta = ingresosTotales - costoVentasTotal;
    const resultadoOperativo = utilidadBruta - totalGastos;
    const resultadoNeto = resultadoOperativo;

    return {
      ingresosPorVentas,
      ingresosPorCuenta,
      totalIngresosVarios,
      ingresosTotales,
      costoCompraFruta,
      costoVentasTotal,
      utilidadBruta,
      gastosPorCuenta,
      totalGastos,
      resultadoOperativo,
      resultadoNeto,
      margenBruto: ingresosTotales > 0 ? (utilidadBruta / ingresosTotales * 100) : 0,
      margenNeto: ingresosTotales > 0 ? (resultadoNeto / ingresosTotales * 100) : 0
    };
  }, [movimientos, salidas, egresos, ingresosvarios, pagos, cobros, obtenerPrecioVigenteCache, fechaDesde, fechaHasta, movimientosTesoreria]);

  // Informes Operativos
  const movimientosFiltrados = useMemo(() => {
    if (tipoInforme === 'proveedor') {
      if (proveedoresSeleccionados.length === 0) return [];
      return movimientos.filter(m => {
        // Solo mostrar Ingreso de Fruta, no Movimiento de Envases
        if (m.tipo_movimiento !== 'Ingreso de Fruta') return false;
        if (!proveedoresSeleccionados.includes(m.proveedor_id)) return false;
        const fechaMov = new Date(m.fecha);
        if (fechaDesdeOp && fechaMov < new Date(fechaDesdeOp)) return false;
        if (fechaHastaOp && fechaMov > new Date(fechaHastaOp + 'T23:59:59')) return false;
        return true;
      });
    } else {
      if (clientesSeleccionados.length === 0) return [];
      const movCliente = movimientos.filter(m => {
        if (!clientesSeleccionados.includes(m.cliente_id)) return false;
        const fechaMov = new Date(m.fecha);
        if (fechaDesdeOp && fechaMov < new Date(fechaDesdeOp)) return false;
        if (fechaHastaOp && fechaMov > new Date(fechaHastaOp + 'T23:59:59')) return false;
        return true;
      });

      const salidasCliente = salidas.filter(s => {
        if (!clientesSeleccionados.includes(s.cliente_id)) return false;
        const fechaSal = new Date(s.fecha);
        if (fechaDesdeOp && fechaSal < new Date(fechaDesdeOp)) return false;
        if (fechaHastaOp && fechaSal > new Date(fechaHastaOp + 'T23:59:59')) return false;
        return true;
      });

      return [...movCliente, ...salidasCliente].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    }
  }, [movimientos, salidas, tipoInforme, proveedoresSeleccionados, clientesSeleccionados, fechaDesdeOp, fechaHastaOp]);

  const totalesOperativos = useMemo(() => {
    const totalesProductos = {};
    const todosLosProductos = new Set();

    if (tipoInforme === 'proveedor') {
      movimientosFiltrados.forEach(m => {
        if (m.tipo_movimiento === 'Ingreso de Fruta' && m.pesajes) {
          m.pesajes.forEach(p => {
            if (!productosSeleccionados.length || productosSeleccionados.includes(p.producto_id)) {
              todosLosProductos.add(p.producto_nombre);
              if (!totalesProductos[p.producto_nombre]) totalesProductos[p.producto_nombre] = 0;
              totalesProductos[p.producto_nombre] += p.peso_neto || 0;
            }
          });
        }
      });
    } else {
      movimientosFiltrados.forEach(item => {
        if (item.detalles) {
          item.detalles.forEach(d => {
            if (!productosSeleccionados.length || productosSeleccionados.includes(d.producto_id)) {
              todosLosProductos.add(d.producto_nombre);
              const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
              if (!totalesProductos[d.producto_nombre]) totalesProductos[d.producto_nombre] = { efectivos: 0 };
              totalesProductos[d.producto_nombre].efectivos += efectivos;
            }
          });
        }
      });
    }
    return { totalesProductos, todosLosProductos: Array.from(todosLosProductos).sort() };
  }, [movimientosFiltrados, productosSeleccionados, tipoInforme]);

  const entidadesSeleccionadas = tipoInforme === 'proveedor'
    ? proveedores.filter(p => proveedoresSeleccionados.includes(p.id))
    : clientes.filter(c => clientesSeleccionados.includes(c.id));
  
  const nombreEntidades = entidadesSeleccionadas.length === 0 
    ? 'Ninguno' 
    : entidadesSeleccionadas.length === 1 
      ? entidadesSeleccionadas[0].nombre 
      : `${entidadesSeleccionadas.length} ${tipoInforme === 'proveedor' ? 'proveedores' : 'clientes'}`;



  const exportarPDF = () => {
    const periodoText = `${fechaDesdeOp ? format(new Date(fechaDesdeOp), 'dd/MM/yyyy') : 'Inicio'} - ${fechaHastaOp ? format(new Date(fechaHastaOp), 'dd/MM/yyyy') : 'Hoy'}`;
    let headers = [];
    if (camposSeleccionados.fecha) headers.push('<th>Fecha</th>');
    if (entidadesSeleccionadas.length > 1) {
      headers.push(`<th>${tipoInforme === 'proveedor' ? 'Proveedor' : 'Cliente'}</th>`);
    }
    if (tipoInforme === 'cliente') {
      if (camposSeleccionados.remito) headers.push('<th>Remito R</th>');
      if (camposSeleccionados.comprobante) headers.push('<th>Comp. Cliente</th>');
    } else {
      if (camposSeleccionados.fletero) headers.push('<th>Fletero</th>');
    }
    
    totalesOperativos.todosLosProductos.forEach(prod => {
      headers.push(`<th>${prod} (kg)</th>`);
    });
    headers.push('<th>Total (kg)</th>');
    
    let movimientosHTML = movimientosFiltrados.map(item => {
      let cells = [];
      if (camposSeleccionados.fecha) cells.push(`<td>${format(new Date(item.fecha), 'dd/MM/yyyy HH:mm')}</td>`);
      if (entidadesSeleccionadas.length > 1) {
        cells.push(`<td>${tipoInforme === 'proveedor' ? item.proveedor_nombre : item.cliente_nombre}</td>`);
      }
      if (tipoInforme === 'cliente') {
        if (camposSeleccionados.remito) cells.push(`<td>${item.numero_remito || '-'}</td>`);
        if (camposSeleccionados.comprobante) cells.push(`<td>${item.comprobante_cliente || '-'}</td>`);
      }
      if (tipoInforme === 'proveedor' && camposSeleccionados.fletero) cells.push(`<td>${item.fletero_nombre || '-'}</td>`);
      
      const productosPorIngreso = {};
      let totalIngreso = 0;
      
      if (tipoInforme === 'proveedor' && item.pesajes) {
        item.pesajes.forEach(p => {
          if (!productosSeleccionados.length || productosSeleccionados.includes(p.producto_id)) {
            if (!productosPorIngreso[p.producto_nombre]) productosPorIngreso[p.producto_nombre] = 0;
            productosPorIngreso[p.producto_nombre] += p.peso_neto || 0;
            totalIngreso += p.peso_neto || 0;
          }
        });
      } else if (item.detalles) {
        item.detalles.forEach(d => {
          if (!productosSeleccionados.length || productosSeleccionados.includes(d.producto_id)) {
            const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
            if (!productosPorIngreso[d.producto_nombre]) productosPorIngreso[d.producto_nombre] = 0;
            productosPorIngreso[d.producto_nombre] += efectivos;
            totalIngreso += efectivos;
          }
        });
      }
      
      totalesOperativos.todosLosProductos.forEach(prod => {
        const valor = productosPorIngreso[prod] || 0;
        cells.push(`<td style="text-align:right">${valor > 0 ? valor.toLocaleString('es-AR', { minimumFractionDigits: 2 }) : '-'}</td>`);
      });
      cells.push(`<td style="text-align:right;font-weight:bold">${totalIngreso.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>`);
      
      return `<tr>${cells.join('')}</tr>`;
    }).join('');

    const html = `
      <!DOCTYPE html>
      <html><head><meta charset="UTF-8"><title>Informe - ${nombreEntidades}</title>
      <style>body{font-family:Arial;font-size:10px;padding:20px}.header{text-align:center;margin-bottom:20px;border-bottom:2px solid #3b82f6;padding-bottom:10px}
      .title{font-size:18px;font-weight:bold;color:#1e40af}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:6px;text-align:left}
      th{background:#eff6ff;font-weight:600;font-size:9px}.totales{background:#dbeafe;font-weight:bold}</style></head><body>
      <div class="header"><div class="title">INFORME ${tipoInforme === 'proveedor' ? 'DE PROVEEDOR' : 'DE CLIENTE'}</div>
      <p>${nombreEntidades}</p><p>Per√≠odo: ${periodoText}</p></div>
      ${headers.length > 0 ? `<h3>Detalle de Movimientos</h3><table><thead><tr>${headers.join('')}</tr></thead><tbody>${movimientosHTML}</tbody></table>` : ''}
      ${camposSeleccionados.totales ? '<h3>Totales del Per√≠odo</h3><table><thead><tr><th>Producto</th><th>Total Peso Neto</th></tr></thead><tbody>' + 
        Object.entries(totalesOperativos.totalesProductos).map(([prod, datos]) => 
          `<tr><td>${prod}</td><td>${tipoInforme === 'proveedor' ? datos.toLocaleString('es-AR', { minimumFractionDigits: 2 }) : datos.efectivos.toLocaleString('es-AR', { minimumFractionDigits: 2 })} kg</td></tr>`
        ).join('') + '</tbody></table>' : ''}
      <p>Generado: ${format(new Date(), 'dd/MM/yyyy HH:mm')}</p></body></html>`;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
  };

  const exportarExcelOperativo = () => {
    const datosExportar = movimientosFiltrados.map(item => {
      const fila = {};
      
      if (camposSeleccionados.fecha) {
        fila['Fecha'] = format(new Date(item.fecha), 'dd/MM/yyyy HH:mm');
      }
      if (entidadesSeleccionadas.length > 1) {
        fila[tipoInforme === 'proveedor' ? 'Proveedor' : 'Cliente'] = tipoInforme === 'proveedor' ? item.proveedor_nombre : item.cliente_nombre;
      }
      if (tipoInforme === 'proveedor' && camposSeleccionados.fletero) {
        fila['Fletero'] = item.fletero_nombre || '';
      }
      if (tipoInforme === 'cliente') {
        if (camposSeleccionados.remito) fila['Remito R'] = item.numero_remito || '';
        if (camposSeleccionados.comprobante) fila['Comp. Cliente'] = item.comprobante_cliente || '';
      }
      
      const productosPorIngreso = {};
      let totalIngreso = 0;
      
      if (tipoInforme === 'proveedor' && item.pesajes) {
        item.pesajes.forEach(p => {
          if (!productosSeleccionados.length || productosSeleccionados.includes(p.producto_id)) {
            if (!productosPorIngreso[p.producto_nombre]) productosPorIngreso[p.producto_nombre] = 0;
            productosPorIngreso[p.producto_nombre] += p.peso_neto || 0;
            totalIngreso += p.peso_neto || 0;
          }
        });
      } else if (item.detalles) {
        item.detalles.forEach(d => {
          if (!productosSeleccionados.length || productosSeleccionados.includes(d.producto_id)) {
            const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
            if (!productosPorIngreso[d.producto_nombre]) productosPorIngreso[d.producto_nombre] = 0;
            productosPorIngreso[d.producto_nombre] += efectivos;
            totalIngreso += efectivos;
          }
        });
      }
      
      totalesOperativos.todosLosProductos.forEach(prod => {
        const valor = productosPorIngreso[prod] || 0;
        fila[`${prod} (kg)`] = parseFloat(valor.toFixed(2));
      });
      fila['Total (kg)'] = parseFloat(totalIngreso.toFixed(2));
      
      return fila;
    });

    const nombreArchivo = entidadesSeleccionadas.length === 1 
      ? entidadesSeleccionadas[0].nombre.replace(/\s+/g, '_')
      : `${entidadesSeleccionadas.length}_${tipoInforme}s`;
    exportarExcel(datosExportar, `informe_${nombreArchivo}_${format(new Date(), 'yyyyMMdd')}`);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto">
        <div className="mb-4 md:mb-6">
          <h1 className="text-xl md:text-2xl lg:text-3xl font-bold text-slate-800 flex items-center gap-2 md:gap-3">
            <FileText className="h-6 w-6 md:h-8 md:w-8 text-blue-600" />
            Informes
          </h1>
          <p className="text-sm md:text-base text-slate-600 mt-1">Informes contables y operativos</p>
        </div>

        <Card className="border-0 shadow-lg">
          <CardContent className="pt-6">
            <Tabs value={activeTab} onValueChange={setActiveTab}>
              <TabsList className="grid w-full grid-cols-4 mb-4 md:mb-6">
                <TabsTrigger value="situacion" className="text-xs md:text-sm">
                  <Scale className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                  <span className="hidden sm:inline">Situaci√≥n</span>
                  <span className="sm:hidden">Sit.</span>
                </TabsTrigger>
                <TabsTrigger value="contables" className="text-xs md:text-sm">
                  <DollarSign className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                  <span className="hidden sm:inline">Resultados</span>
                  <span className="sm:hidden">Res.</span>
                </TabsTrigger>
                <TabsTrigger value="operativos" className="text-xs md:text-sm">
                  <FileText className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                  <span className="hidden sm:inline">Operativos</span>
                  <span className="sm:hidden">Op.</span>
                </TabsTrigger>
                <TabsTrigger value="proveedores" className="text-xs md:text-sm">
                  <Users className="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" />
                  <span className="hidden sm:inline">Proveedores</span>
                  <span className="sm:hidden">Prov.</span>
                </TabsTrigger>
              </TabsList>

              {/* TAB SITUACI√ìN ACTUAL */}
              <TabsContent value="situacion">
                <div className="space-y-6">
                  {/* Dashboards principales */}
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Card className="border-0 shadow-lg bg-gradient-to-br from-emerald-50 to-green-100">
                      <CardContent className="p-5">
                        {ingresosTotalesPorProducto.length > 0 ? (
                          <>
                            <div className="flex items-center justify-between mb-3">
                              <button
                                onClick={() => setProductoSeleccionadoIndex(productoSeleccionadoIndex === 0 ? ingresosTotalesPorProducto.length - 1 : productoSeleccionadoIndex - 1)}
                                className="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow hover:shadow-md transition-shadow"
                                disabled={ingresosTotalesPorProducto.length <= 1}
                              >
                                <ChevronLeft className="h-5 w-5 text-green-700" />
                              </button>
                              <div className="text-center flex-1">
                                <p className="text-xs text-green-700 mb-1 font-medium">Ingresos Totales Acumulados</p>
                                <p className="text-sm text-green-600 truncate px-2">
                                  {ingresosTotalesPorProducto[productoSeleccionadoIndex]?.nombre}
                                </p>
                              </div>
                              <button
                                onClick={() => setProductoSeleccionadoIndex(productoSeleccionadoIndex === ingresosTotalesPorProducto.length - 1 ? 0 : productoSeleccionadoIndex + 1)}
                                className="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow hover:shadow-md transition-shadow"
                                disabled={ingresosTotalesPorProducto.length <= 1}
                              >
                                <ChevronRight className="h-5 w-5 text-green-700" />
                              </button>
                            </div>
                            <div className="flex items-center justify-center gap-3">
                              <Scale className="h-10 w-10 text-green-600 opacity-50" />
                              <p className="text-3xl font-bold text-green-800">
                                {ingresosTotalesPorProducto[productoSeleccionadoIndex]?.kilosAcumulados.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg
                              </p>
                            </div>
                            {ingresosTotalesPorProducto.length > 1 && (
                              <p className="text-xs text-green-600 text-center mt-2">
                                {productoSeleccionadoIndex + 1} de {ingresosTotalesPorProducto.length} productos
                              </p>
                            )}
                          </>
                        ) : (
                          <div className="text-center py-4">
                            <Scale className="h-10 w-10 text-green-400 mx-auto mb-2 opacity-50" />
                            <p className="text-xs text-green-700">Sin ingresos registrados</p>
                          </div>
                        )}
                      </CardContent>
                    </Card>

                    <Card className="border-0 shadow-lg bg-gradient-to-br from-blue-50 to-indigo-100">
                      <CardContent className="p-5">
                        <div className="text-center mb-2">
                          <p className="text-xs text-blue-700 mb-1 font-medium">Ganancia Potencial</p>
                          <p className="text-sm text-blue-600">
                            {gananciaPotencial.totalVenta > 0 ? 'Basado en per√≠odos de precio' : 'Configure precios'}
                          </p>
                        </div>
                        <div className="flex items-center justify-center gap-3">
                          <DollarSign className="h-10 w-10 text-blue-600 opacity-50" />
                          <div className="text-center">
                            <p className="text-3xl font-bold text-blue-800">
                              ${gananciaPotencial.ganancia.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </p>
                            {gananciaPotencial.margen > 0 && (
                              <p className="text-xs text-blue-600 mt-1">
                                Margen: {gananciaPotencial.margen.toFixed(1)}%
                              </p>
                            )}
                          </div>
                        </div>
                        {gananciaPotencial.totalVenta > 0 && (
                          <div className="mt-3 pt-3 border-t border-blue-200">
                            <div className="flex justify-between text-xs text-blue-700">
                              <span>Costo compra:</span>
                              <span className="font-semibold">${gananciaPotencial.totalCompra.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                            </div>
                            <div className="flex justify-between text-xs text-blue-700 mt-1">
                              <span>Ingreso venta:</span>
                              <span className="font-semibold">${gananciaPotencial.totalVenta.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</span>
                            </div>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  </div>

                  {/* Stats */}
                  <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
                    <Card className="border-0 shadow-md">
                      <CardContent className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <Scale className="h-5 w-5 text-green-600" />
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Stock Total</p>
                            <p className="text-xl font-bold text-slate-800">{statsAcopio.stockTotalKilos.toFixed(0)} kg</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="border-0 shadow-md">
                      <CardContent className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <TrendingUp className="h-5 w-5 text-blue-600" />
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Ingresos Hoy</p>
                            <p className="text-xl font-bold text-slate-800">{statsAcopio.ingresosHoy}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="border-0 shadow-md">
                      <CardContent className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center">
                            <Package className="h-5 w-5 text-teal-600" />
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Envases Vac√≠os</p>
                            <p className="text-xl font-bold text-teal-600">{statsAcopio.totalVacios}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="border-0 shadow-md">
                      <CardContent className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                            <Box className="h-5 w-5 text-orange-600" />
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Envases Ocupados</p>
                            <p className="text-xl font-bold text-orange-600">{statsAcopio.totalOcupados}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="border-0 shadow-md">
                      <CardContent className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <Users className="h-5 w-5 text-purple-600" />
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Proveedores</p>
                            <p className="text-xl font-bold text-slate-800">{proveedores.length}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Fruta Real a Cobrar y P√©rdidas */}
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <Card className="border-0 shadow-md bg-gradient-to-br from-teal-50 to-teal-100">
                      <CardContent className="p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-teal-700 uppercase tracking-wide mb-1">Fruta Real a Cobrar</p>
                            <p className="text-2xl font-bold text-teal-800">
                              {frutaRealACobrar.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg
                            </p>
                            <p className="text-[10px] text-teal-600 mt-1">Ingresos totales - P√©rdidas</p>
                          </div>
                          <CheckCircle className="h-9 w-9 text-teal-500 opacity-40" />
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="border-0 shadow-md bg-gradient-to-br from-red-50 to-red-100">
                      <CardContent className="p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-xs text-red-700 uppercase tracking-wide mb-1">P√©rdidas Efectivas Totales</p>
                            <p className="text-2xl font-bold text-red-800">
                              {perdidasEfectivas.total.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg
                            </p>
                            <p className="text-[10px] text-red-600 mt-1">B√°scula + Calidad</p>
                          </div>
                          <AlertTriangle className="h-9 w-9 text-red-500 opacity-40" />
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </div>
              </TabsContent>

              {/* TAB CONTABLES */}
              <TabsContent value="contables">
                <Card className="border-0 shadow-md mb-6">
                  <CardHeader>
                    <CardTitle className="text-lg">Seleccionar Per√≠odo</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha Desde</label>
                        <Input type="date" value={fechaDesde} onChange={(e) => setFechaDesde(e.target.value)} />
                      </div>
                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha Hasta</label>
                        <Input type="date" value={fechaHasta} onChange={(e) => setFechaHasta(e.target.value)} />
                      </div>
                    </div>
                  </CardContent>
                </Card>

                <Card className="border-0 shadow-md">
                  <CardHeader className="bg-blue-50 flex flex-row items-start justify-between">
                    <div>
                      <CardTitle className="text-xl text-blue-900">Estado de Resultados</CardTitle>
                      <p className="text-sm text-blue-700 mt-1">
                        Per√≠odo: {format(parseISO(fechaDesde), 'dd/MM/yyyy', { locale: es })} - {format(parseISO(fechaHasta), 'dd/MM/yyyy', { locale: es })}
                      </p>
                    </div>
                    <Button
                      onClick={() => {
                        const datosExportar = [
                          { Concepto: 'Ingresos por Ventas', Monto: estadoResultado.ingresosPorVentas },
                          { Concepto: 'Total Otros Ingresos', Monto: estadoResultado.totalIngresosVarios },
                          { Concepto: 'Total Ingresos', Monto: estadoResultado.ingresosTotales },
                          { Concepto: 'Costo de Compra de Fruta', Monto: estadoResultado.costoCompraFruta },
                          { Concepto: 'Total Costo Ventas', Monto: estadoResultado.costoVentasTotal },
                          { Concepto: 'Utilidad Bruta', Monto: estadoResultado.utilidadBruta },
                          { Concepto: 'Gastos Operativos', Monto: estadoResultado.totalGastos },
                          { Concepto: 'Resultado Neto', Monto: estadoResultado.resultadoNeto }
                        ];
                        exportarExcel(datosExportar, `estado_resultados_${format(new Date(), 'yyyyMMdd')}`);
                      }}
                      size="sm"
                      variant="outline"
                      className="gap-2"
                    >
                      <Download className="h-4 w-4" />
                      Exportar
                    </Button>
                  </CardHeader>
                  <CardContent className="p-6">
            <div className="space-y-6">
              {/* INGRESOS */}
              <div className="border-b pb-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <TrendingUp className="h-5 w-5 text-green-600" />
                    <h3 className="font-bold text-lg text-slate-800">INGRESOS</h3>
                  </div>
                </div>
                <div className="ml-7 space-y-1">
                 <div className="flex justify-between text-slate-700">
                   <span>Ingresos por Ventas (Cobros Realizados)</span>
                   <span className="font-semibold">${estadoResultado.ingresosPorVentas.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                 </div>
                 {Object.entries(estadoResultado.ingresosPorCuenta).map(([cuenta, monto]) => (
                   <div key={cuenta} className="flex justify-between text-slate-600 text-sm pl-4">
                     <span>{cuenta}</span>
                     <span className="font-semibold">${monto.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                   </div>
                 ))}
                 {Object.keys(estadoResultado.ingresosPorCuenta).length > 0 && (
                   <div className="flex justify-between text-slate-700 pt-1">
                     <span className="pl-4">Total Otros Ingresos</span>
                     <span className="font-semibold">${estadoResultado.totalIngresosVarios.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                   </div>
                 )}
                 <div className="flex justify-between font-bold text-green-700 pt-2 border-t mt-2">
                   <span>Total Ingresos</span>
                   <span>${estadoResultado.ingresosTotales.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                 </div>
                </div>
              </div>

              {/* COSTO DE VENTAS */}
              <div className="border-b pb-4">
                <div className="flex items-center gap-2 mb-2">
                  <TrendingDown className="h-5 w-5 text-red-600" />
                  <h3 className="font-bold text-lg text-slate-800">COSTO DE VENTAS</h3>
                </div>
                <div className="ml-7 space-y-1">
                  <div className="flex justify-between font-semibold text-red-600">
                    <span>Costo de Compra de Fruta</span>
                    <span>${estadoResultado.costoCompraFruta.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                  </div>
                  <div className="mt-2 pt-2 border-t border-slate-200">
                    <p className="text-[10px] text-slate-500 italic">
                      ‚ÑπÔ∏è Calculado: kilos comprados √ó precio de compra. NO incluye pagos, deudas ni otros egresos.
                    </p>
                  </div>
                </div>
              </div>

              {/* UTILIDAD BRUTA */}
              <div className="border-b pb-4">
                <div className="flex justify-between items-center">
                  <h3 className="font-bold text-lg text-slate-800">UTILIDAD BRUTA</h3>
                  <div className="text-right">
                    <p className="text-2xl font-bold text-blue-600">${estadoResultado.utilidadBruta.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                    <p className="text-sm text-slate-500">{estadoResultado.margenBruto.toLocaleString('es-AR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}% margen</p>
                  </div>
                </div>
              </div>

              {/* GASTOS OPERATIVOS */}
              <div className="border-b pb-4">
                <div className="flex items-center gap-2 mb-2">
                  <TrendingDown className="h-5 w-5 text-red-600" />
                  <h3 className="font-bold text-lg text-slate-800">GASTOS OPERATIVOS</h3>
                </div>
                <div className="ml-7 space-y-1">
                  {Object.entries(estadoResultado.gastosPorCuenta).map(([cuenta, monto]) => (
                    <div key={cuenta} className="flex justify-between text-slate-600 text-sm">
                      <span>{cuenta}</span>
                      <span className="font-semibold">${monto.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    </div>
                  ))}
                  <div className="flex justify-between font-semibold text-red-600 pt-2 border-t mt-2">
                    <span>Total Gastos</span>
                    <span>${estadoResultado.totalGastos.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                  </div>
                </div>
              </div>

              {/* RESULTADO OPERATIVO */}
              <div className="border-b pb-4">
                <div className="flex justify-between items-center">
                  <h3 className="font-bold text-lg text-slate-800">RESULTADO OPERATIVO</h3>
                  <p className={`text-2xl font-bold ${estadoResultado.resultadoOperativo >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    ${estadoResultado.resultadoOperativo.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </p>
                </div>
              </div>

              {/* RESULTADO NETO */}
              <div className="bg-blue-50 rounded-lg p-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <DollarSign className="h-6 w-6 text-blue-600" />
                    <h3 className="font-bold text-xl text-blue-900">RESULTADO NETO</h3>
                  </div>
                  <div className="text-right">
                    <p className={`text-3xl font-bold ${estadoResultado.resultadoNeto >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                      ${estadoResultado.resultadoNeto.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </p>
                    <p className="text-sm text-slate-600">{estadoResultado.margenNeto.toLocaleString('es-AR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}% margen neto</p>
                  </div>
                </div>
              </div>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            {/* TAB OPERATIVOS */}
            <TabsContent value="operativos">
              <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div className="lg:col-span-1 space-y-4">
                  <Card className="border-0 shadow-md">
                    <CardHeader>
                      <CardTitle className="text-lg">Filtros</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-2 block">Tipo *</label>
                        <select
                          value={tipoInforme}
                          onChange={(e) => {
                            setTipoInforme(e.target.value);
                            setProveedoresSeleccionados([]);
                            setClientesSeleccionados([]);
                          }}
                          className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                        >
                          <option value="proveedor">Proveedor</option>
                          <option value="cliente">Cliente</option>
                        </select>
                      </div>

                      {tipoInforme === 'proveedor' ? (
                        <div>
                          <label className="text-sm font-medium text-slate-700 mb-2 flex items-center justify-between">
                            <span>Proveedores *</span>
                            <button
                              onClick={() => {
                                const proveedoresFiltrados = proveedores.filter(p => 
                                  p.nombre.toLowerCase().includes(busquedaProveedor.toLowerCase())
                                );
                                if (proveedoresSeleccionados.length === proveedoresFiltrados.length) {
                                  setProveedoresSeleccionados(proveedoresSeleccionados.filter(id => 
                                    !proveedoresFiltrados.some(p => p.id === id)
                                  ));
                                } else {
                                  const nuevosIds = proveedoresFiltrados.map(p => p.id).filter(id => 
                                    !proveedoresSeleccionados.includes(id)
                                  );
                                  setProveedoresSeleccionados([...proveedoresSeleccionados, ...nuevosIds]);
                                }
                              }}
                              className="text-xs text-blue-600 hover:text-blue-700"
                            >
                              Marcar todos
                            </button>
                          </label>
                          <Input
                            type="text"
                            placeholder="Buscar proveedor..."
                            value={busquedaProveedor}
                            onChange={(e) => setBusquedaProveedor(e.target.value)}
                            className="mb-2"
                          />
                          <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                            {proveedores.length === 0 ? (
                              <p className="text-sm text-slate-500 text-center">No hay proveedores</p>
                            ) : (
                              proveedores
                                .filter(p => p.nombre.toLowerCase().includes(busquedaProveedor.toLowerCase()))
                                .map(p => (
                                  <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-2 rounded">
                                    <input
                                      type="checkbox"
                                      checked={proveedoresSeleccionados.includes(p.id)}
                                      onChange={(e) => {
                                        if (e.target.checked) {
                                          setProveedoresSeleccionados([...proveedoresSeleccionados, p.id]);
                                        } else {
                                          setProveedoresSeleccionados(proveedoresSeleccionados.filter(id => id !== p.id));
                                        }
                                      }}
                                      className="rounded"
                                    />
                                    <span className="text-sm">{p.nombre}</span>
                                  </label>
                                ))
                            )}
                          </div>
                          {proveedoresSeleccionados.length > 0 && (
                            <p className="text-xs text-slate-600 mt-2">
                              {proveedoresSeleccionados.length} seleccionado(s)
                            </p>
                          )}
                        </div>
                      ) : (
                        <div>
                          <label className="text-sm font-medium text-slate-700 mb-2 flex items-center justify-between">
                            <span>Clientes *</span>
                            <button
                              onClick={() => {
                                const clientesFiltrados = clientes.filter(c => 
                                  c.nombre.toLowerCase().includes(busquedaCliente.toLowerCase())
                                );
                                if (clientesSeleccionados.length === clientesFiltrados.length) {
                                  setClientesSeleccionados(clientesSeleccionados.filter(id => 
                                    !clientesFiltrados.some(c => c.id === id)
                                  ));
                                } else {
                                  const nuevosIds = clientesFiltrados.map(c => c.id).filter(id => 
                                    !clientesSeleccionados.includes(id)
                                  );
                                  setClientesSeleccionados([...clientesSeleccionados, ...nuevosIds]);
                                }
                              }}
                              className="text-xs text-blue-600 hover:text-blue-700"
                            >
                              Marcar todos
                            </button>
                          </label>
                          <Input
                            type="text"
                            placeholder="Buscar cliente..."
                            value={busquedaCliente}
                            onChange={(e) => setBusquedaCliente(e.target.value)}
                            className="mb-2"
                          />
                          <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                            {clientes.length === 0 ? (
                              <p className="text-sm text-slate-500 text-center">No hay clientes</p>
                            ) : (
                              clientes
                                .filter(c => c.nombre.toLowerCase().includes(busquedaCliente.toLowerCase()))
                                .map(c => (
                                  <label key={c.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-2 rounded">
                                    <input
                                      type="checkbox"
                                      checked={clientesSeleccionados.includes(c.id)}
                                      onChange={(e) => {
                                        if (e.target.checked) {
                                          setClientesSeleccionados([...clientesSeleccionados, c.id]);
                                        } else {
                                          setClientesSeleccionados(clientesSeleccionados.filter(id => id !== c.id));
                                        }
                                      }}
                                      className="rounded"
                                    />
                                    <span className="text-sm">{c.nombre}</span>
                                  </label>
                                ))
                            )}
                          </div>
                          {clientesSeleccionados.length > 0 && (
                            <p className="text-xs text-slate-600 mt-2">
                              {clientesSeleccionados.length} seleccionado(s)
                            </p>
                          )}
                        </div>
                      )}

                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha Desde</label>
                        <Input type="date" value={fechaDesdeOp} onChange={(e) => setFechaDesdeOp(e.target.value)} />
                      </div>

                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha Hasta</label>
                        <Input type="date" value={fechaHastaOp} onChange={(e) => setFechaHastaOp(e.target.value)} />
                      </div>

                      <div>
                        <label className="text-sm font-medium text-slate-700 mb-2 block">Productos</label>
                        <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                          {productos.map(p => (
                            <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-1 rounded">
                              <input
                                type="checkbox"
                                checked={productosSeleccionados.includes(p.id)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setProductosSeleccionados([...productosSeleccionados, p.id]);
                                  } else {
                                    setProductosSeleccionados(productosSeleccionados.filter(id => id !== p.id));
                                  }
                                }}
                                className="rounded"
                              />
                              <span className="text-sm">{p.producto_completo || `${p.fruta} - ${p.variedad}`}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {(proveedoresSeleccionados.length > 0 || clientesSeleccionados.length > 0) && movimientosFiltrados.length > 0 && (
                    <Card className="border-0 shadow-md">
                      <CardHeader>
                        <CardTitle className="text-lg">Exportar</CardTitle>
                      </CardHeader>
                      <CardContent className="space-y-2">
                        <Button onClick={exportarPDF} className="w-full text-sm">
                          <FileDown className="h-4 w-4 mr-2" />
                          PDF
                        </Button>
                        <Button onClick={exportarExcelOperativo} className="w-full text-sm" variant="outline">
                          <Download className="h-4 w-4 mr-2" />
                          Excel
                        </Button>
                      </CardContent>
                    </Card>
                  )}
                </div>

                <div className="lg:col-span-3">
                  {(tipoInforme === 'proveedor' ? proveedoresSeleccionados.length === 0 : clientesSeleccionados.length === 0) ? (
                    <Card className="border-0 shadow-md">
                      <CardContent className="p-12 text-center">
                        <FileText className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                        <h3 className="text-lg font-semibold text-slate-700 mb-2">
                          Seleccione {tipoInforme === 'proveedor' ? 'proveedores' : 'clientes'}
                        </h3>
                        <p className="text-slate-500 text-sm">
                          Marque uno o m√°s en los filtros
                        </p>
                      </CardContent>
                    </Card>
                  ) : movimientosFiltrados.length === 0 ? (
                    <Card className="border-0 shadow-md">
                      <CardContent className="p-12 text-center">
                        <FileText className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                        <p className="text-slate-500">No hay datos para el per√≠odo seleccionado</p>
                      </CardContent>
                    </Card>
                  ) : (
                    <>
                      {camposSeleccionados.totales && Object.keys(totalesOperativos.totalesProductos).length > 0 && (
                        <Card className="border-0 shadow-md mb-4">
                          <CardHeader>
                            <CardTitle className="text-base">Totales del Per√≠odo</CardTitle>
                          </CardHeader>
                          <CardContent>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                              {Object.entries(totalesOperativos.totalesProductos).map(([prod, datos]) => (
                                <div key={prod} className="p-3 bg-slate-50 rounded-lg">
                                  <p className="text-xs text-slate-600 mb-1">{prod}</p>
                                  <p className="text-lg font-bold text-blue-700">
                                    {tipoInforme === 'proveedor' 
                                      ? datos.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                      : datos.efectivos.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                    } kg
                                  </p>
                                </div>
                              ))}
                            </div>
                          </CardContent>
                        </Card>
                      )}
                      
                      <Card className="border-0 shadow-md">
                        <CardHeader>
                          <CardTitle className="text-base md:text-lg flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                            <span className="break-words">Informe - {nombreEntidades}</span>
                            <Badge className="shrink-0">{movimientosFiltrados.length} mov.</Badge>
                          </CardTitle>
                        </CardHeader>
                        <CardContent>
                          <div className="overflow-x-auto -mx-4 md:mx-0">
                            <table className="w-full text-xs md:text-sm min-w-full">
                              <thead className="bg-slate-100">
                                <tr>
                                  {camposSeleccionados.fecha && <th className="text-left p-2 md:p-3 whitespace-nowrap sticky left-0 bg-slate-100 z-10">Fecha</th>}
                                  {entidadesSeleccionadas.length > 1 && <th className="text-left p-2 md:p-3 whitespace-nowrap">{tipoInforme === 'proveedor' ? 'Proveedor' : 'Cliente'}</th>}
                                  {tipoInforme === 'cliente' && camposSeleccionados.remito && <th className="text-left p-2 md:p-3 whitespace-nowrap">Remito</th>}
                                  {tipoInforme === 'proveedor' && camposSeleccionados.fletero && <th className="text-left p-2 md:p-3 whitespace-nowrap">Fletero</th>}
                                  {totalesOperativos.todosLosProductos.map(prod => (
                                    <th key={prod} className="text-right p-2 md:p-3 whitespace-nowrap">{prod} (kg)</th>
                                  ))}
                                  <th className="text-right p-2 md:p-3 whitespace-nowrap bg-blue-100 font-bold">Total (kg)</th>
                                </tr>
                              </thead>
                              <tbody>
                                {movimientosFiltrados
                                  .slice((paginaActual - 1) * registrosPorPagina, paginaActual * registrosPorPagina)
                                  .map((item, idx) => {
                                    const productosPorIngreso = {};
                                    let totalIngreso = 0;
                                    
                                    if (tipoInforme === 'proveedor' && item.pesajes) {
                                      item.pesajes.forEach(p => {
                                        if (!productosSeleccionados.length || productosSeleccionados.includes(p.producto_id)) {
                                          if (!productosPorIngreso[p.producto_nombre]) productosPorIngreso[p.producto_nombre] = 0;
                                          productosPorIngreso[p.producto_nombre] += p.peso_neto || 0;
                                          totalIngreso += p.peso_neto || 0;
                                        }
                                      });
                                    } else if (item.detalles) {
                                      item.detalles.forEach(d => {
                                        if (!productosSeleccionados.length || productosSeleccionados.includes(d.producto_id)) {
                                          const efectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
                                          if (!productosPorIngreso[d.producto_nombre]) productosPorIngreso[d.producto_nombre] = 0;
                                          productosPorIngreso[d.producto_nombre] += efectivos;
                                          totalIngreso += efectivos;
                                        }
                                      });
                                    }
                                    
                                    return (
                                      <tr key={idx} className="border-b hover:bg-slate-50">
                                        {camposSeleccionados.fecha && <td className="p-2 md:p-3 whitespace-nowrap text-xs sticky left-0 bg-white">{format(new Date(item.fecha), 'dd/MM/yyyy HH:mm')}</td>}
                                        {entidadesSeleccionadas.length > 1 && (
                                          <td className="p-2 md:p-3 text-xs font-medium">
                                            {tipoInforme === 'proveedor' ? item.proveedor_nombre : item.cliente_nombre}
                                          </td>
                                        )}
                                        {tipoInforme === 'cliente' && camposSeleccionados.remito && <td className="p-2 md:p-3 text-xs">{item.numero_remito || '-'}</td>}
                                        {tipoInforme === 'proveedor' && camposSeleccionados.fletero && <td className="p-2 md:p-3 text-xs truncate max-w-[100px]">{item.fletero_nombre || '-'}</td>}
                                        {totalesOperativos.todosLosProductos.map(prod => {
                                          const valor = productosPorIngreso[prod] || 0;
                                          return (
                                            <td key={prod} className="p-2 md:p-3 text-right text-xs">
                                              {valor > 0 ? valor.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}
                                            </td>
                                          );
                                        })}
                                        <td className="p-2 md:p-3 text-right text-xs font-bold bg-blue-50">
                                          {totalIngreso.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                        </td>
                                      </tr>
                                    );
                                  })}
                              </tbody>
                            </table>
                          </div>

                          {movimientosFiltrados.length > registrosPorPagina && (
                            <div className="flex items-center justify-between mt-4 pt-4 border-t">
                              <p className="text-sm text-slate-600">
                                Mostrando {((paginaActual - 1) * registrosPorPagina) + 1} - {Math.min(paginaActual * registrosPorPagina, movimientosFiltrados.length)} de {movimientosFiltrados.length} registros
                              </p>
                              <div className="flex gap-2">
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() => setPaginaActual(p => Math.max(1, p - 1))}
                                  disabled={paginaActual === 1}
                                >
                                  Anterior
                                </Button>
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() => setPaginaActual(p => Math.min(Math.ceil(movimientosFiltrados.length / registrosPorPagina), p + 1))}
                                  disabled={paginaActual >= Math.ceil(movimientosFiltrados.length / registrosPorPagina)}
                                >
                                  Siguiente
                                </Button>
                              </div>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    </>
                  )}
                </div>
                </div>
                </TabsContent>

                {/* TAB INFORME DE PROVEEDORES */}
                <TabsContent value="proveedores">
                  <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div className="lg:col-span-1 space-y-4">
                      <Card className="border-0 shadow-md">
                        <CardHeader>
                          <CardTitle className="text-lg">Filtros</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                          <div>
                            <label className="text-sm font-medium text-slate-700 mb-2 flex items-center justify-between">
                              <span>Proveedores *</span>
                              <button
                                onClick={() => {
                                  if (proveedoresInforme.length === proveedores.length) {
                                    setProveedoresInforme([]);
                                  } else {
                                    setProveedoresInforme(proveedores.map(p => p.id));
                                  }
                                }}
                                className="text-xs text-blue-600 hover:text-blue-700"
                              >
                                {proveedoresInforme.length === proveedores.length ? 'Desmarcar todos' : 'Todos'}
                              </button>
                            </label>
                            <div className="max-h-48 overflow-y-auto space-y-2 p-3 bg-slate-50 rounded-lg border">
                              {proveedores.map(p => (
                                <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-2 rounded">
                                  <input
                                    type="checkbox"
                                    checked={proveedoresInforme.includes(p.id)}
                                    onChange={(e) => {
                                      if (e.target.checked) {
                                        setProveedoresInforme([...proveedoresInforme, p.id]);
                                      } else {
                                        setProveedoresInforme(proveedoresInforme.filter(id => id !== p.id));
                                      }
                                    }}
                                    className="rounded"
                                  />
                                  <span className="text-sm">{p.nombre}</span>
                                </label>
                              ))}
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="text-sm font-medium text-slate-700 mb-1 block">Desde</label>
                              <Input type="date" value={fechaDesdeProveedores} onChange={(e) => setFechaDesdeProveedores(e.target.value)} />
                            </div>
                            <div>
                              <label className="text-sm font-medium text-slate-700 mb-1 block">Hasta</label>
                              <Input type="date" value={fechaHastaProveedores} onChange={(e) => setFechaHastaProveedores(e.target.value)} />
                            </div>
                          </div>

                          <div>
                            <label className="text-sm font-medium text-slate-700 mb-2 block">Productos (opcional)</label>
                            <div className="max-h-32 overflow-y-auto space-y-1 p-2 bg-slate-50 rounded-lg border">
                              {productos.map(p => (
                                <label key={p.id} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-1 rounded text-xs">
                                  <input
                                    type="checkbox"
                                    checked={productosFiltroProveedores.includes(p.id)}
                                    onChange={(e) => {
                                      if (e.target.checked) {
                                        setProductosFiltroProveedores([...productosFiltroProveedores, p.id]);
                                      } else {
                                        setProductosFiltroProveedores(productosFiltroProveedores.filter(id => id !== p.id));
                                      }
                                    }}
                                    className="rounded"
                                  />
                                  <span>{p.producto_completo || `${p.fruta} - ${p.variedad}`}</span>
                                </label>
                              ))}
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>

                    <div className="lg:col-span-3">
                      {proveedoresInforme.length === 0 ? (
                        <Card className="border-0 shadow-md">
                          <CardContent className="p-12 text-center">
                            <Users className="h-16 w-16 text-slate-300 mx-auto mb-4" />
                            <h3 className="text-lg font-semibold text-slate-700 mb-2">Seleccione proveedores</h3>
                            <p className="text-slate-500 text-sm">Marque uno o m√°s proveedores para generar el informe</p>
                          </CardContent>
                        </Card>
                      ) : (
                        <Card className="border-0 shadow-lg">
                          <CardHeader className="bg-gradient-to-r from-orange-50 to-orange-100 flex flex-row items-center justify-between">
                            <CardTitle className="text-xl text-orange-900">Informe de Proveedores</CardTitle>
                            <div className="flex gap-2">
                              <Button
                                onClick={() => {
                                  const todasVariedades = new Set();
                                  const datosProveedores = [];

                                  proveedoresInforme.forEach(provId => {
                                    const proveedor = proveedores.find(p => p.id === provId);
                                    if (!proveedor) return;

                                    const variedadesKg = {};
                                    let totalKg = 0;

                                    movimientos.forEach(m => {
                                      if (m.tipo_movimiento === 'Ingreso de Fruta' && m.proveedor_id === provId) {
                                        const fechaMov = new Date(m.fecha);
                                        const cumpleFecha = (!fechaDesdeProveedores || fechaMov >= new Date(fechaDesdeProveedores)) &&
                                                          (!fechaHastaProveedores || fechaMov <= new Date(fechaHastaProveedores + 'T23:59:59'));
                                        if (cumpleFecha && m.pesajes) {
                                          m.pesajes.forEach(p => {
                                            if (!productosFiltroProveedores.length || productosFiltroProveedores.includes(p.producto_id)) {
                                              const nombre = p.producto_nombre || 'Sin nombre';
                                              todasVariedades.add(nombre);
                                              if (!variedadesKg[nombre]) {
                                                variedadesKg[nombre] = { kg: 0, producto_id: p.producto_id };
                                              }
                                              variedadesKg[nombre].kg += p.peso_neto || 0;
                                              totalKg += p.peso_neto || 0;
                                            }
                                          });
                                        }
                                      }
                                    });

                                    let totalAPagar = 0;
                                    Object.entries(variedadesKg).forEach(([variedad, data]) => {
                                      const precio = obtenerPrecioVigenteCache(data.producto_id, new Date(), 'compra');
                                      totalAPagar += data.kg * precio;
                                    });

                                    const totalPagadoCalculado = pagos
                                      .filter(p => {
                                        if (p.proveedor_id !== provId) return false;
                                        return movimientosTesoreria.some(m => 
                                          m.referencia_origen_id === p.id && m.referencia_origen_tipo === 'Pago'
                                        );
                                      })
                                      .reduce((sum, p) => sum + (p.monto_total || 0), 0);

                                    const totalPagado = Math.min(totalPagadoCalculado, totalAPagar);
                                    const saldoPendiente = Math.max(0, totalAPagar - totalPagado);

                                    datosProveedores.push({
                                      proveedor: proveedor.nombre,
                                      totalKg,
                                      variedadesKg,
                                      totalAPagar,
                                      totalPagado,
                                      saldoPendiente
                                    });
                                  });

                                  const variedadesArray = Array.from(todasVariedades).sort();
                                  
                                  let variedadesHeaders = variedadesArray.map(v => `<th class="p-2 text-right">Kg ${v}</th>`).join('');
                                  let filasHTML = datosProveedores.map(d => {
                                    let variedadesCells = variedadesArray.map(v => 
                                      `<td class="p-2 text-right">${(d.variedadesKg[v]?.kg || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>`
                                    ).join('');
                                    
                                    return `<tr>
                                      <td class="p-2 font-medium">${d.proveedor}</td>
                                      <td class="p-2 text-right font-semibold" style="background:#f1f5f9">${d.totalKg.toLocaleString('es-AR', { minimumFractionDigits: 2 })} kg</td>
                                      ${variedadesCells}
                                      <td class="p-2 text-right font-semibold" style="background:#fefce8">$${d.totalAPagar.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>
                                      <td class="p-2 text-right font-semibold" style="background:#f0fdf4">$${d.totalPagado.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>
                                      <td class="p-2 text-right font-semibold" style="background:#eff6ff">${d.saldoPendiente > 0 ? `$${d.saldoPendiente.toLocaleString('es-AR', { minimumFractionDigits: 2 })}` : '-'}</td>
                                    </tr>`;
                                  }).join('');

                                  const periodoText = `${fechaDesdeProveedores ? format(new Date(fechaDesdeProveedores), 'dd/MM/yyyy') : 'Inicio'} - ${fechaHastaProveedores ? format(new Date(fechaHastaProveedores), 'dd/MM/yyyy') : 'Actual'}`;

                                  const html = `
                                    <!DOCTYPE html>
                                    <html><head><meta charset="UTF-8"><title>Informe de Proveedores</title>
                                    <style>
                                      body { font-family: Arial; font-size: 10px; padding: 20px; }
                                      .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f97316; padding-bottom: 10px; }
                                      .title { font-size: 18px; font-weight: bold; color: #9a3412; }
                                      table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                      th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                                      th { background: #fff7ed; font-weight: 600; font-size: 9px; }
                                    </style></head><body>
                                    <div class="header">
                                      <div class="title">INFORME DE PROVEEDORES</div>
                                      <p>Per√≠odo: ${periodoText}</p>
                                      <p>Generado: ${format(new Date(), 'dd/MM/yyyy HH:mm')}</p>
                                    </div>
                                    <table>
                                      <thead>
                                        <tr>
                                          <th class="p-2">Proveedor</th>
                                          <th class="p-2 text-right">Kg Totales</th>
                                          ${variedadesHeaders}
                                          <th class="p-2 text-right">Total a Pagar</th>
                                          <th class="p-2 text-right">Total Pagado</th>
                                          <th class="p-2 text-right">Saldo Pendiente</th>
                                        </tr>
                                      </thead>
                                      <tbody>${filasHTML}</tbody>
                                    </table>
                                    </body></html>`;
                                  
                                  const printWindow = window.open('', '_blank');
                                  printWindow.document.write(html);
                                  printWindow.document.close();
                                  printWindow.onload = () => printWindow.print();
                                }}
                                size="sm"
                                variant="outline"
                                className="gap-2"
                              >
                                <FileDown className="h-4 w-4" />
                                PDF
                              </Button>
                              <Button
                                onClick={() => {
                                  const todasVariedades = new Set();
                                  const datosProveedores = [];

                                  proveedoresInforme.forEach(provId => {
                                    const proveedor = proveedores.find(p => p.id === provId);
                                    if (!proveedor) return;

                                    const variedadesKg = {};
                                    let totalKg = 0;

                                    movimientos.forEach(m => {
                                      if (m.tipo_movimiento === 'Ingreso de Fruta' && m.proveedor_id === provId) {
                                        const fechaMov = new Date(m.fecha);
                                        const cumpleFecha = (!fechaDesdeProveedores || fechaMov >= new Date(fechaDesdeProveedores)) &&
                                                          (!fechaHastaProveedores || fechaMov <= new Date(fechaHastaProveedores + 'T23:59:59'));
                                        if (cumpleFecha && m.pesajes) {
                                          m.pesajes.forEach(p => {
                                            if (!productosFiltroProveedores.length || productosFiltroProveedores.includes(p.producto_id)) {
                                              const nombre = p.producto_nombre || 'Sin nombre';
                                              todasVariedades.add(nombre);
                                              if (!variedadesKg[nombre]) {
                                                variedadesKg[nombre] = { kg: 0, producto_id: p.producto_id };
                                              }
                                              variedadesKg[nombre].kg += p.peso_neto || 0;
                                              totalKg += p.peso_neto || 0;
                                            }
                                          });
                                        }
                                      }
                                    });

                                    let totalAPagar = 0;
                                    Object.entries(variedadesKg).forEach(([variedad, data]) => {
                                      const precio = obtenerPrecioVigenteCache(data.producto_id, new Date(), 'compra');
                                      totalAPagar += data.kg * precio;
                                    });

                                    const totalPagadoCalculado = pagos
                                      .filter(p => {
                                        if (p.proveedor_id !== provId) return false;
                                        return movimientosTesoreria.some(m => 
                                          m.referencia_origen_id === p.id && m.referencia_origen_tipo === 'Pago'
                                        );
                                      })
                                      .reduce((sum, p) => sum + (p.monto_total || 0), 0);

                                    const totalPagado = Math.min(totalPagadoCalculado, totalAPagar);
                                    const saldoPendiente = Math.max(0, totalAPagar - totalPagado);

                                    datosProveedores.push({
                                      proveedor: proveedor.nombre,
                                      totalKg,
                                      variedadesKg,
                                      totalAPagar,
                                      totalPagado,
                                      saldoPendiente
                                    });
                                  });

                                  const variedadesArray = Array.from(todasVariedades).sort();
                                  const datosExportar = datosProveedores.map(d => {
                                    const fila = {
                                      'Proveedor': d.proveedor,
                                      'Kg Totales': parseFloat(d.totalKg.toFixed(2))
                                    };

                                    variedadesArray.forEach(v => {
                                      fila[`Kg ${v}`] = parseFloat((d.variedadesKg[v]?.kg || 0).toFixed(2));
                                    });

                                    fila['Total a Pagar'] = parseFloat(d.totalAPagar.toFixed(2));
                                    fila['Total Pagado'] = parseFloat(d.totalPagado.toFixed(2));
                                    fila['Saldo Pendiente'] = parseFloat(d.saldoPendiente.toFixed(2));

                                    return fila;
                                  });

                                  exportarExcel(datosExportar, `informe_proveedores_${format(new Date(), 'yyyyMMdd')}`);
                                }}
                                size="sm"
                                variant="outline"
                                className="gap-2"
                              >
                                <Download className="h-4 w-4" />
                                Excel
                              </Button>
                            </div>
                          </CardHeader>
                          <CardContent className="p-6">
                            <div className="overflow-x-auto">
                              <table className="w-full text-xs">
                                <thead className="bg-slate-100">
                                  <tr>
                                    <th className="text-left p-2 sticky left-0 bg-slate-100 z-10">Proveedor</th>
                                    <th className="text-right p-2 whitespace-nowrap bg-slate-200">Kg Totales</th>
                                    {(() => {
                                      const todasVariedades = new Set();
                                      movimientos.forEach(m => {
                                        if (m.tipo_movimiento === 'Ingreso de Fruta' && proveedoresInforme.includes(m.proveedor_id)) {
                                          const fechaMov = new Date(m.fecha);
                                          const cumpleFecha = (!fechaDesdeProveedores || fechaMov >= new Date(fechaDesdeProveedores)) &&
                                                            (!fechaHastaProveedores || fechaMov <= new Date(fechaHastaProveedores + 'T23:59:59'));
                                          if (cumpleFecha && m.pesajes) {
                                            m.pesajes.forEach(p => {
                                              if (!productosFiltroProveedores.length || productosFiltroProveedores.includes(p.producto_id)) {
                                                todasVariedades.add(p.producto_nombre);
                                              }
                                            });
                                          }
                                        }
                                      });
                                      return Array.from(todasVariedades).sort().map(v => (
                                        <th key={`kg_${v}`} className="text-right p-2 whitespace-nowrap">Kg {v}</th>
                                      ));
                                    })()}
                                    <th className="text-right p-2 whitespace-nowrap bg-yellow-50">Total a Pagar</th>
                                    <th className="text-right p-2 whitespace-nowrap bg-green-50">Total Pagado</th>
                                    <th className="text-right p-2 whitespace-nowrap bg-blue-50">Saldo Pendiente</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {proveedoresInforme.map(provId => {
                                    const proveedor = proveedores.find(p => p.id === provId);
                                    if (!proveedor) return null;

                                    const variedadesKg = {};
                                    let totalKg = 0;

                                    movimientos.forEach(m => {
                                      if (m.tipo_movimiento === 'Ingreso de Fruta' && m.proveedor_id === provId) {
                                        const fechaMov = new Date(m.fecha);
                                        const cumpleFecha = (!fechaDesdeProveedores || fechaMov >= new Date(fechaDesdeProveedores)) &&
                                                          (!fechaHastaProveedores || fechaMov <= new Date(fechaHastaProveedores + 'T23:59:59'));
                                        if (cumpleFecha && m.pesajes) {
                                          m.pesajes.forEach(p => {
                                            if (!productosFiltroProveedores.length || productosFiltroProveedores.includes(p.producto_id)) {
                                              const nombre = p.producto_nombre || 'Sin nombre';
                                              if (!variedadesKg[nombre]) {
                                                variedadesKg[nombre] = { kg: 0, producto_id: p.producto_id };
                                              }
                                              variedadesKg[nombre].kg += p.peso_neto || 0;
                                              totalKg += p.peso_neto || 0;
                                            }
                                          });
                                        }
                                      }
                                    });

                                    let totalAPagar = 0;
                                    Object.entries(variedadesKg).forEach(([variedad, data]) => {
                                      const precio = obtenerPrecioVigenteCache(data.producto_id, new Date(), 'compra');
                                      totalAPagar += data.kg * precio;
                                    });

                                    // Total pagado = SOLO pagos con MovimientoTesoreria (pagos reales efectuados)
                                    const totalPagadoCalculado = pagos
                                      .filter(p => {
                                        if (p.proveedor_id !== provId) return false;
                                        // Verificar que el pago tenga movimientos de tesorer√≠a vinculados (pago real)
                                        return movimientosTesoreria.some(m => 
                                          m.referencia_origen_id === p.id && m.referencia_origen_tipo === 'Pago'
                                        );
                                      })
                                      .reduce((sum, p) => sum + (p.monto_total || 0), 0);

                                    // Aplicar tope contable: nunca mayor al total a pagar
                                    const totalPagado = Math.min(totalPagadoCalculado, totalAPagar);

                                    // Saldo pendiente nunca negativo
                                    const saldoPendiente = Math.max(0, totalAPagar - totalPagado);

                                    const todasVariedades = new Set();
                                    movimientos.forEach(m => {
                                      if (m.tipo_movimiento === 'Ingreso de Fruta' && proveedoresInforme.includes(m.proveedor_id)) {
                                        const fechaMov = new Date(m.fecha);
                                        const cumpleFecha = (!fechaDesdeProveedores || fechaMov >= new Date(fechaDesdeProveedores)) &&
                                                          (!fechaHastaProveedores || fechaMov <= new Date(fechaHastaProveedores + 'T23:59:59'));
                                        if (cumpleFecha && m.pesajes) {
                                          m.pesajes.forEach(p => {
                                            if (!productosFiltroProveedores.length || productosFiltroProveedores.includes(p.producto_id)) {
                                              todasVariedades.add(p.producto_nombre);
                                            }
                                          });
                                        }
                                      }
                                    });

                                    return (
                                      <tr key={provId} className="border-b hover:bg-slate-50">
                                        <td className="p-2 font-medium sticky left-0 bg-white">{proveedor.nombre}</td>
                                        <td className="p-2 text-right font-semibold text-slate-800 bg-slate-100">
                                          {totalKg.toLocaleString('es-AR', { minimumFractionDigits: 2 })} kg
                                        </td>
                                        {Array.from(todasVariedades).sort().map(v => (
                                          <td key={`kg_${provId}_${v}`} className="p-2 text-right text-slate-600">
                                            {(variedadesKg[v]?.kg || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                          </td>
                                        ))}
                                        <td className="p-2 text-right font-semibold text-yellow-700 bg-yellow-50">
                                          ${totalAPagar.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                        </td>
                                        <td className="p-2 text-right font-semibold text-green-700 bg-green-50">
                                          ${totalPagado.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                        </td>
                                        <td className={`p-2 text-right font-semibold bg-blue-50 ${saldoPendiente > 0 ? 'text-red-600' : saldoPendiente < 0 ? 'text-green-600' : 'text-slate-600'}`}>
                                          ${saldoPendiente.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                        </td>
                                      </tr>
                                    );
                                  })}
                                </tbody>
                              </table>
                            </div>
                          </CardContent>
                        </Card>
                      )}
                    </div>
                  </div>
                </TabsContent>

                </Tabs>
                </CardContent>
                </Card>
                </div>
                </div>
                );
                }
</file>

<file path="src/pages/IngresoFruta.jsx">
import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Plus, Loader2, Apple, Truck, Scale, Package, Trash2 } from "lucide-react";
import { format } from 'date-fns';
import SearchableSelect from '@/components/SearchableSelect';
import QuickCreateModal from '@/components/QuickCreateModal';
import PesajeLineItem from '@/components/PesajeLineItem';
import EnvaseLineItemLlenos from '@/components/EnvaseLineItemLlenos';
import GenericSuccessModal from '@/components/GenericSuccessModal';
import ConfirmPesajeModal from '@/components/ConfirmPesajeModal';
import { descargarPDFIngresoFruta, compartirWhatsAppIngresoFruta } from '@/components/PDFGeneratorIngresoFruta';
import { agruparKilosPorProducto } from '@/components/utils/precisionDecimal';
import { invalidarTodoElSistema } from '@/utils/queryHelpers';
import { actualizarSaldoEntidad } from '@/utils/contabilidad';
import { ajustarStockProducto, ajustarStockEnvase } from '@/services/StockService';

export default function IngresoFruta({ embedded = false }) {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [fecha, setFecha] = useState(format(new Date(), "yyyy-MM-dd'T'HH:mm"));
  const [proveedorId, setProveedorId] = useState('');
  const [proveedorData, setProveedorData] = useState(null);
  const [fleteroId, setFleteroId] = useState('');
  const [fleteroData, setFleteroData] = useState(null);
  
  const [pesajes, setPesajes] = useState([]);
  
  const [pesajeActual, setPesajeActual] = useState({
    modo: 'estandar',
    cantidad: 1,
    envase_id: '',
    envase_tipo: '',
    tara_unitaria: 0,
    tara_manual: 0,
    producto_id: '',
    producto_nombre: '',
    peso_bruto: 0,
    peso_neto: 0
  });
  
  const [confirmPesajeModal, setConfirmPesajeModal] = useState({ open: false, pesaje: null });
  
  const [envasesLlenos, setEnvasesLlenos] = useState([]);
  const [envaseActual, setEnvaseActual] = useState({
    envase_id: '',
    envase_tipo: '',
    cantidad: 0
  });

  const [createModal, setCreateModal] = useState({ open: false, type: null });
  const [successModal, setSuccessModal] = useState({ open: false, data: null });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list()
  });

  const { data: fleteros = [] } = useQuery({
    queryKey: ['fleteros'],
    queryFn: () => base44.entities.Fletero.list()
  });

  const { data: envasesList = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list()
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list()
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list()
  });

  const productosConCompleto = useMemo(() => 
    productos.map(p => ({
      ...p,
      producto_completo: p.producto_completo || `${p.fruta} - ${p.variedad}`
    })), [productos]
  );



  const resumenPesajes = useMemo(() => {
    const resumen = {};
    pesajes.forEach(p => {
      if (!p.producto_nombre) return;
      const key = `${p.producto_nombre}_${p.envase_tipo || 'Sin envase'}`;
      if (!resumen[key]) {
        resumen[key] = {
          producto: p.producto_nombre,
          envase: p.envase_tipo || '-',
          cantidad: 0,
          pesoBruto: 0,
          tara: 0,
          pesoNeto: 0
        };
      }
      resumen[key].cantidad += p.cantidad || 1;
      resumen[key].pesoBruto += p.peso_bruto || 0;
      resumen[key].tara += p.modo === 'libre' ? (p.tara_manual || 0) : ((p.tara_unitaria || 0) * (p.cantidad || 1));
      resumen[key].pesoNeto += p.peso_neto || 0;
    });
    return Object.values(resumen);
  }, [pesajes]);

  const handleProveedorSelect = (id, prov) => {
    setProveedorId(id);
    setProveedorData(prov);
  };

  const handleFleteroSelect = (id, flet) => {
    setFleteroId(id);
    setFleteroData(flet);
  };

  const handleAgregarPesaje = () => {
    // Validar que tenga datos m√≠nimos
    if (!pesajeActual.producto_id) {
      alert('Por favor seleccione un producto');
      return;
    }
    if (pesajeActual.modo !== 'libre' && !pesajeActual.envase_id) {
      alert('Por favor seleccione un tipo de envase');
      return;
    }
    if (pesajeActual.peso_bruto <= 0) {
      alert('Por favor ingrese un peso bruto v√°lido');
      return;
    }
    
    // Validar tara no supere bruto
    const taraTotal = pesajeActual.modo === 'libre' 
      ? (pesajeActual.tara_manual || 0)
      : ((pesajeActual.tara_unitaria || 0) * (pesajeActual.cantidad || 1));
    
    if (taraTotal > pesajeActual.peso_bruto) {
      alert('La tara no puede superar el peso bruto');
      return;
    }
    
    // Mostrar modal de confirmaci√≥n
    setConfirmPesajeModal({ open: true, pesaje: pesajeActual });
  };

  const confirmarPesaje = () => {
    setPesajes([...pesajes, confirmPesajeModal.pesaje]);
    setConfirmPesajeModal({ open: false, pesaje: null });
    // Resetear pesaje actual
    setPesajeActual({
      modo: 'estandar',
      cantidad: 1,
      envase_id: '',
      envase_tipo: '',
      tara_unitaria: 0,
      tara_manual: 0,
      producto_id: '',
      producto_nombre: '',
      peso_bruto: 0,
      peso_neto: 0
    });
  };

  const updatePesajeActual = (data) => {
    setPesajeActual(data);
  };

  const removePesaje = (index) => {
    setPesajes(pesajes.filter((_, i) => i !== index));
  };

  const handleCreateSave = async (data) => {
    setIsSubmitting(true);
    try {
      if (createModal.type === 'proveedor') {
        const created = await base44.entities.Proveedor.create(data);
        queryClient.invalidateQueries(['proveedores']);
        setProveedorId(created.id);
        setProveedorData(created);
      } else if (createModal.type === 'fletero') {
        const created = await base44.entities.Fletero.create(data);
        queryClient.invalidateQueries(['fleteros']);
        setFleteroId(created.id);
        setFleteroData(created);
      } else if (createModal.type === 'envase') {
        const created = await base44.entities.Envase.create(data);
        queryClient.invalidateQueries(['envases']);
      } else if (createModal.type === 'producto') {
        const productoData = {
          ...data,
          producto_completo: `${data.fruta} - ${data.variedad}`
        };
        await base44.entities.Producto.create(productoData);
        queryClient.invalidateQueries(['productos']);
      }
      setCreateModal({ open: false, type: null });
    } finally {
      setIsSubmitting(false);
    }
  };

  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios'],
    queryFn: () => base44.entities.PeriodoPrecio.list()
  });

  const handleSubmit = async () => {
    if (!proveedorId) {
      alert('Por favor seleccione un proveedor');
      return;
    }

    if (pesajes.length === 0) {
      alert('Por favor agregue al menos un pesaje');
      return;
    }

    setIsSubmitting(true);
    try {
      // Calcular deuda total del ingreso
      let deudaTotalIngreso = 0;
      pesajes.forEach(p => {
        const periodoVigente = periodosPrecios
          .filter(pp => pp.producto_id === p.producto_id && pp.activo)
          .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde))
          .find(pp => new Date(pp.fecha_desde) <= new Date(fecha));
        const precioCompra = periodoVigente?.precio_compra_kg || 0;
        deudaTotalIngreso += p.peso_neto * precioCompra;
      });

      const movimiento = {
        fecha: new Date(fecha).toISOString(),
        tipo_movimiento: 'Ingreso de Fruta',
        proveedor_id: proveedorId,
        proveedor_nombre: proveedorData?.nombre || '',
        fletero_id: fleteroId || null,
        fletero_nombre: fleteroData?.nombre || '',
        estado_pago: 'Pendiente',
        monto_pagado: 0,
        deuda_total: deudaTotalIngreso,
        pesajes: pesajes.filter(p => p.peso_bruto > 0),
        envases_llenos: envasesLlenos.filter(e => e.cantidad > 0)
      };

      const created = await base44.entities.Movimiento.create(movimiento);
      
      // Actualizar stock vivo de productos (incremental por servicio)
      const stockPorProducto = agruparKilosPorProducto(pesajes, 'peso_neto');
      for (const [productoId, totalNeto] of Object.entries(stockPorProducto)) {
        await ajustarStockProducto(base44, productoId, totalNeto);
      }

      // Actualizar stock vivo de envases ocupados
      for (const envLleno of movimiento.envases_llenos || []) {
        if (envLleno.cantidad > 0 && envLleno.envase_id) {
          await ajustarStockEnvase(base44, envLleno.envase_id, envLleno.cantidad, 0);
        }
      }
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CREAR MOVIMIENTO EN CUENTA CORRIENTE - AUMENTA DEUDA PROVEEDOR
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // Obtener el saldo anterior de este proveedor
      const movimientosProveedor = await base44.entities.CuentaCorriente.filter({
        entidad_tipo: 'Proveedor',
        entidad_id: proveedorId
      }, '-fecha');
      const saldoAnterior = movimientosProveedor.length > 0 ? (movimientosProveedor[0].saldo_resultante || 0) : 0;
      const nuevoSaldo = saldoAnterior + deudaTotalIngreso;

      await base44.entities.CuentaCorriente.create({
        fecha: new Date(fecha).toISOString(),
        tipo_movimiento: 'Haber',
        entidad_tipo: 'Proveedor',
        entidad_id: proveedorId,
        entidad_nombre: proveedorData?.nombre || '',
        monto: deudaTotalIngreso,
        saldo_resultante: nuevoSaldo,
        concepto: `Ingreso de Fruta - ${format(new Date(fecha), 'dd/MM/yyyy')}`,
        comprobante_id: created.id,
        comprobante_tipo: 'IngresoFruta'
      });

      await actualizarSaldoEntidad(base44, 'Proveedor', proveedorId, deudaTotalIngreso);

      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);
      
      setSuccessModal({ 
        open: true, 
        data: { ...movimiento, id: created.id }
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDownloadPDF = () => {
    if (!successModal.data) return;
    descargarPDFIngresoFruta(successModal.data);
  };

  const handleShareWhatsApp = async () => {
    if (!successModal.data) return;
    compartirWhatsAppIngresoFruta(successModal.data, proveedorData?.whatsapp);
  };

  const getCreateFields = () => {
    switch (createModal.type) {
      case 'proveedor':
        return [
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del proveedor' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n' },
          { name: 'cuit', label: 'CUIT', placeholder: 'XX-XXXXXXXX-X' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54 9 11 XXXX-XXXX' }
        ];
      case 'fletero':
        return [
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del fletero' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54 9 11 XXXX-XXXX' }
        ];
      case 'envase':
        return [
          { name: 'tipo', label: 'Tipo de Envase', placeholder: 'Ej: Bin Pl√°stico' },
          { name: 'tara', label: 'Tara (kg)', type: 'number', placeholder: '0.00' }
        ];
      case 'producto':
        return [
          { name: 'fruta', label: 'Fruta', placeholder: 'Ej: Manzana' },
          { name: 'variedad', label: 'Variedad', placeholder: 'Ej: Red Delicious' }
        ];
      default:
        return [];
    }
  };

  const totalPesoNeto = pesajes.reduce((s, p) => s + (p.peso_neto || 0), 0);
  const totalPesoBruto = pesajes.reduce((s, p) => s + (p.peso_bruto || 0), 0);

  return (
    <div className={embedded ? "" : "min-h-screen bg-gradient-to-br from-green-50 via-white to-emerald-50"}>
      <div className={embedded ? "" : "max-w-5xl mx-auto p-4 sm:p-6 lg:p-8"}>
        {!embedded && (
          <div className="flex items-center gap-3 mb-8">
            <div className="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
              <Apple className="h-6 w-6 text-green-600" />
            </div>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-slate-800">Ingreso de Fruta</h1>
              <p className="text-slate-500 text-sm">Registrar nuevo ingreso de frutas al acopio</p>
            </div>
          </div>
        )}

        <div className="space-y-6">
          {/* Datos Generales */}
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold flex items-center gap-2">
                <Truck className="h-5 w-5 text-slate-400" />
                Datos del Ingreso
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Fecha y Hora</label>
                  <Input
                    type="datetime-local"
                    value={fecha}
                    onChange={(e) => setFecha(e.target.value)}
                    className="h-11"
                  />
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Proveedor *</label>
                  <SearchableSelect
                    options={proveedores}
                    value={proveedorId}
                    onChange={handleProveedorSelect}
                    displayKey="nombre"
                    placeholder="Seleccionar proveedor..."
                    onCreateNew={() => setCreateModal({ open: true, type: 'proveedor' })}
                    createNewLabel="Crear nuevo proveedor"
                  />
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Fletero</label>
                  <SearchableSelect
                    options={fleteros}
                    value={fleteroId}
                    onChange={handleFleteroSelect}
                    displayKey="nombre"
                    placeholder="Seleccionar fletero..."
                    onCreateNew={() => setCreateModal({ open: true, type: 'fletero' })}
                    createNewLabel="Crear nuevo fletero"
                  />
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Pesajes */}
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold flex items-center gap-2">
                <Scale className="h-5 w-5 text-slate-400" />
                Nuevo Pesaje
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {/* Formulario de pesaje actual */}
                <PesajeLineItem
                  item={pesajeActual}
                  index={0}
                  envases={envasesList}
                  productos={productosConCompleto}
                  onChange={(_, data) => updatePesajeActual(data)}
                  onRemove={() => {}}
                  onCreateEnvase={() => setCreateModal({ open: true, type: 'envase' })}
                  onCreateProducto={() => setCreateModal({ open: true, type: 'producto' })}
                />
                
                <div className="flex justify-end">
                  <Button 
                    onClick={handleAgregarPesaje}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Agregar a Lista
                  </Button>
                </div>
              </div>
              
              {/* Lista de pesajes agregados */}
              {pesajes.length > 0 && (
                <div className="mt-6 pt-6 border-t">
                  <div className="flex items-center justify-between mb-3">
                    <h4 className="font-semibold text-slate-700">Pesajes Agregados ({pesajes.length})</h4>
                  </div>
                  <div className="space-y-3">
                    {pesajes.map((pesaje, index) => (
                      <div key={index} className="p-3 bg-green-50 rounded-lg border border-green-200">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <p className="font-medium text-slate-800">
                              {pesaje.producto_nombre || 'Producto sin especificar'}
                            </p>
                            <div className="flex flex-wrap gap-3 mt-1 text-sm text-slate-600">
                              {pesaje.modo !== 'libre' && (
                                <>
                                  <span>{pesaje.envase_tipo || 'Sin envase'}</span>
                                  <span>Cantidad: {pesaje.cantidad || 1}</span>
                                </>
                              )}
                              <span>Bruto: {(pesaje.peso_bruto || 0).toFixed(2)} kg</span>
                              <span className="font-semibold text-green-700">
                                Neto: {(pesaje.peso_neto || 0).toFixed(2)} kg
                              </span>
                            </div>
                          </div>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => removePesaje(index)}
                            className="text-red-500 hover:text-red-700 hover:bg-red-50 ml-2"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Resumen */}
              {resumenPesajes.length > 0 && (
                <div className="mt-6 p-4 bg-green-50 rounded-xl">
                  <h4 className="font-semibold text-green-800 mb-3">Resumen por Producto</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-left text-green-700">
                          <th className="pb-2">Producto</th>
                          <th className="pb-2">Envase</th>
                          <th className="pb-2 text-right">Cant.</th>
                          <th className="pb-2 text-right">P. Bruto</th>
                          <th className="pb-2 text-right">Tara</th>
                          <th className="pb-2 text-right">P. Neto</th>
                        </tr>
                      </thead>
                      <tbody>
                        {resumenPesajes.map((r, i) => (
                          <tr key={i} className="border-t border-green-200">
                            <td className="py-2">{r.producto}</td>
                            <td className="py-2">{r.envase}</td>
                            <td className="py-2 text-right">{r.cantidad}</td>
                            <td className="py-2 text-right">{r.pesoBruto.toFixed(2)} kg</td>
                            <td className="py-2 text-right">{r.tara.toFixed(2)} kg</td>
                            <td className="py-2 text-right font-semibold">{r.pesoNeto.toFixed(2)} kg</td>
                          </tr>
                        ))}
                        <tr className="border-t-2 border-green-300 font-bold text-green-900">
                          <td colSpan={3} className="py-2">TOTAL</td>
                          <td className="py-2 text-right">{totalPesoBruto.toFixed(2)} kg</td>
                          <td className="py-2 text-right">{(totalPesoBruto - totalPesoNeto).toFixed(2)} kg</td>
                          <td className="py-2 text-right text-lg">{totalPesoNeto.toFixed(2)} kg</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Envases Llenos (Con Fruta) */}
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold flex items-center gap-2">
                <Package className="h-5 w-5 text-slate-400" />
                Envases Llenos con Fruta
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <EnvaseLineItemLlenos
                  item={envaseActual}
                  index={0}
                  envases={envasesList}
                  onChange={(_, data) => setEnvaseActual(data)}
                  onRemove={() => {}}
                  onCreateEnvase={() => setCreateModal({ open: true, type: 'envase' })}
                  showRemove={false}
                />
                
                <div className="flex justify-end">
                  <Button 
                    onClick={() => {
                      if (!envaseActual.envase_id || envaseActual.cantidad <= 0) {
                        alert('Seleccione un envase y cantidad v√°lida');
                        return;
                      }
                      setEnvasesLlenos([...envasesLlenos, envaseActual]);
                      setEnvaseActual({ envase_id: '', envase_tipo: '', cantidad: 0 });
                    }}
                    className="bg-amber-600 hover:bg-amber-700"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Agregar
                  </Button>
                </div>

                {/* Lista de envases agregados */}
                {envasesLlenos.length > 0 && (
                  <div className="mt-4 pt-4 border-t">
                    <h4 className="font-semibold text-slate-700 mb-3">Envases Llenos Agregados</h4>
                    <div className="space-y-2">
                      {envasesLlenos.map((env, idx) => (
                        <div key={idx} className="p-3 bg-amber-50 rounded-lg border border-amber-200 flex items-center justify-between">
                          <div>
                            <p className="font-medium text-slate-800">{env.envase_tipo}</p>
                            <p className="text-sm text-amber-700">Cantidad: {env.cantidad} llenos</p>
                          </div>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => setEnvasesLlenos(envasesLlenos.filter((_, i) => i !== idx))}
                            className="text-red-500 hover:text-red-700"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="flex items-start gap-2">
                    <Package className="h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0" />
                    <div className="text-xs text-blue-900">
                      <p className="font-semibold mb-1">‚ÑπÔ∏è Nota importante:</p>
                      <p>Los envases vac√≠os se gestionan en "Movimiento de Envases". Aqu√≠ solo registre envases que vienen llenos con fruta ‚Üí impactan Stock Ocupados.</p>
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Bot√≥n Guardar */}
          <div className="flex justify-end">
            <Button
              onClick={handleSubmit}
              disabled={isSubmitting || !proveedorId}
              size="lg"
              className="bg-green-600 hover:bg-green-700 text-white px-8"
            >
              {isSubmitting ? (
                <Loader2 className="h-5 w-5 animate-spin mr-2" />
              ) : (
                <Apple className="h-5 w-5 mr-2" />
              )}
              Registrar Ingreso
            </Button>
          </div>
        </div>
      </div>

      <QuickCreateModal
        open={createModal.open}
        onClose={() => setCreateModal({ open: false, type: null })}
        onSave={handleCreateSave}
        title={
          createModal.type === 'proveedor' ? 'Nuevo Proveedor' :
          createModal.type === 'fletero' ? 'Nuevo Fletero' :
          createModal.type === 'envase' ? 'Nuevo Envase' :
          createModal.type === 'producto' ? 'Nuevo Producto' : ''
        }
        fields={getCreateFields()}
        isLoading={isSubmitting}
      />

      <ConfirmPesajeModal
        open={confirmPesajeModal.open}
        onClose={() => setConfirmPesajeModal({ open: false, pesaje: null })}
        pesaje={confirmPesajeModal.pesaje}
        onConfirm={confirmarPesaje}
        onEdit={() => setConfirmPesajeModal({ open: false, pesaje: null })}
      />

      <GenericSuccessModal
        open={successModal.open}
        onClose={() => {
          setSuccessModal({ open: false, data: null });
          // Resetear todo el formulario
          setFecha(format(new Date(), "yyyy-MM-dd'T'HH:mm"));
          setProveedorId('');
          setProveedorData(null);
          setFleteroId('');
          setFleteroData(null);
          setPesajes([]);
          setPesajeActual({
            modo: 'estandar',
            cantidad: 1,
            envase_id: '',
            envase_tipo: '',
            tara_unitaria: 0,
            tara_manual: 0,
            producto_id: '',
            producto_nombre: '',
            peso_bruto: 0,
            peso_neto: 0
          });
          setEnvasesLlenos([]);
          setEnvaseActual({ envase_id: '', envase_tipo: '', cantidad: 0 });
        }}
        title="¬°Ingreso Registrado!"
        message="El movimiento se ha registrado correctamente"
        onDownloadPDF={handleDownloadPDF}
        onShareWhatsApp={handleShareWhatsApp}
      />
    </div>
  );
}
</file>

<file path="src/pages/IngresosVarios.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { TrendingUp, Plus, Loader2, Calendar, DollarSign, FileText, Trash2 } from 'lucide-react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { toast } from 'sonner';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import SearchableSelect from '@/components/SearchableSelect';

export default function IngresosVarios() {
  const queryClient = useQueryClient();
  const [modalOpen, setModalOpen] = useState(false);
  const [deleteDialog, setDeleteDialog] = useState({ open: false, ingreso: null });
  const [formData, setFormData] = useState({
    fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
    tipo: 'Ingreso',
    cuenta_id: '',
    concepto: '',
    monto: 0,
    forma_ingreso: 'Efectivo',
    destino_tipo: 'Caja',
    destino_id: '',
    cheque_id: '',
    cliente_id: '',
    comprobante: '',
    notas: ''
  });

  const { data: ingresos = [], isLoading } = useQuery({
    queryKey: ['ingresosvarios'],
    queryFn: () => base44.entities.IngresoVario.list('-fecha'),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cuentas = [] } = useQuery({
    queryKey: ['plandecuentas'],
    queryFn: () => base44.entities.PlanDeCuentas.filter({ activa: true, imputable: true }, 'codigo'),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria'],
    queryFn: () => base44.entities.MovimientoTesoreria.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const guardarIngresoMutation = useMutation({
    mutationFn: async (ingresoData) => {
      // Obtener datos de la cuenta
      const cuenta = cuentas.find(c => c.id === ingresoData.cuenta_id);
      if (!cuenta) throw new Error('Cuenta no encontrada');

      // Obtener datos del destino
      const destinos = ingresoData.destino_tipo === 'Banco' ? bancos : cajas;
      const destino = destinos.find(d => d.id === ingresoData.destino_id);
      if (!destino) throw new Error('Destino no encontrado');

      // Cachear datos
      const datosCompletos = {
        ...ingresoData,
        cuenta_codigo: cuenta.codigo,
        cuenta_nombre: cuenta.nombre,
        destino_nombre: destino.nombre
      };

      // Cliente opcional
      if (ingresoData.cliente_id) {
        const cliente = clientes.find(c => c.id === ingresoData.cliente_id);
        if (cliente) {
          datosCompletos.cliente_nombre = cliente.nombre;
        }
      }

      // 1. Crear el ingreso
      const ingreso = await base44.entities.IngresoVario.create(datosCompletos);

      // 2. Actualizar saldo del destino
      if (ingresoData.destino_tipo === 'Caja') {
        await base44.entities.Caja.update(ingresoData.destino_id, {
          saldo: (destino.saldo || 0) + ingresoData.monto
        });
      } else {
        await base44.entities.Banco.update(ingresoData.destino_id, {
          saldo: (destino.saldo || 0) + ingresoData.monto
        });
      }

      // 3. Crear movimiento de tesorer√≠a
      await base44.entities.MovimientoTesoreria.create({
        fecha: ingresoData.fecha,
        tipo_movimiento: 'Ingreso Manual',
        destino_tipo: ingresoData.destino_tipo,
        destino_id: ingresoData.destino_id,
        destino_nombre: destino.nombre,
        monto: ingresoData.monto,
        concepto: `Ingreso Vario: ${ingresoData.concepto}`,
        comprobante: ingresoData.comprobante,
        referencia_origen_id: ingreso.id,
        referencia_origen_tipo: 'IngresoVario'
      });

      return ingreso;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['ingresosvarios'] });
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
      toast.success('Ingreso registrado exitosamente');
      cerrarModal();
    },
    onError: (error) => {
      console.error('Error al guardar ingreso:', error);
      toast.error('Error al registrar el ingreso');
    }
  });

  const abrirModalNuevo = () => {
    setFormData({
      fecha: format(new Date(), "yyyy-MM-dd'T'HH:mm"),
      tipo: 'Ingreso',
      cuenta_id: '',
      cuenta_codigo: '',
      cuenta_nombre: '',
      concepto: '',
      monto: 0,
      forma_ingreso: 'Efectivo',
      destino_tipo: 'Caja',
      destino_id: '',
      cheque_id: '',
      cliente_id: '',
      comprobante: '',
      notas: ''
    });
    setModalOpen(true);
  };

  const cerrarModal = () => {
    setModalOpen(false);
  };

  const handleGuardar = () => {
    if (!formData.cuenta_id) {
      toast.error('Por favor seleccione una cuenta contable');
      return;
    }
    if (!formData.concepto || !formData.destino_id || formData.monto <= 0) {
      toast.error('Complete todos los campos obligatorios');
      return;
    }
    guardarIngresoMutation.mutate(formData);
  };

  const eliminarMutation = useMutation({
    mutationFn: async (ingreso) => {
      // Buscar movimientos de tesorer√≠a vinculados
      const movimientosVinculados = movimientosTesoreria.filter(m => 
        m.referencia_origen_id === ingreso.id && m.referencia_origen_tipo === 'IngresoVario'
      );

      // Revertir saldos de destino
      for (const mov of movimientosVinculados) {
        if (mov.destino_id && mov.destino_tipo) {
          if (mov.destino_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === mov.destino_id);
            if (caja) {
              await base44.entities.Caja.update(mov.destino_id, {
                saldo: (caja.saldo || 0) - mov.monto
              });
            }
          } else if (mov.destino_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === mov.destino_id);
            if (banco) {
              await base44.entities.Banco.update(mov.destino_id, {
                saldo: (banco.saldo || 0) - mov.monto
              });
            }
          }
        }

        // Eliminar movimiento de tesorer√≠a
        await base44.entities.MovimientoTesoreria.delete(mov.id);
      }

      // Eliminar el ingreso
      await base44.entities.IngresoVario.delete(ingreso.id);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['ingresosvarios'] });
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
      toast.success('Ingreso eliminado completamente');
      setDeleteDialog({ open: false, ingreso: null });
    },
    onError: (error) => {
      console.error('Error al eliminar ingreso:', error);
      toast.error('Error al eliminar el ingreso');
    }
  });

  // Filtrar ingresos que tienen movimientos de tesorer√≠a vinculados
  const ingresosValidos = ingresos.filter(ingreso => {
    const tieneMovimientos = movimientosTesoreria.some(m => 
      m.referencia_origen_id === ingreso.id && m.referencia_origen_tipo === 'IngresoVario'
    );
    return tieneMovimientos;
  });

  const cuentasIngresos = cuentas.filter(c => c.activa !== false && c.imputable !== false);
  const destinosDisponibles = formData.destino_tipo === 'Banco' ? bancos : cajas;
  const totalIngresos = ingresosValidos.reduce((sum, i) => sum + (i.monto || 0), 0);

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <TrendingUp className="h-8 w-8 text-green-600" />
              Ingresos Varios
            </h1>
            <p className="text-slate-500 mt-1">Registra ingresos que no provienen de ventas de fruta</p>
          </div>
          <Button onClick={abrirModalNuevo} className="bg-green-600 hover:bg-green-700">
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Ingreso
          </Button>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Ingresos</p>
                  <p className="text-2xl font-bold text-green-600">
                    ${totalIngresos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <DollarSign className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Cantidad</p>
                  <p className="text-2xl font-bold text-slate-600">{ingresosValidos.length}</p>
                </div>
                <FileText className="h-10 w-10 text-slate-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Promedio</p>
                  <p className="text-2xl font-bold text-blue-600">
                    ${ingresosValidos.length > 0 ? (totalIngresos / ingresosValidos.length).toLocaleString('es-AR', { minimumFractionDigits: 2 }) : '0.00'}
                  </p>
                </div>
                <TrendingUp className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Ingresos */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-green-600" />
          </div>
        ) : ingresosValidos.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <TrendingUp className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay ingresos varios registrados</p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-3">
            {ingresosValidos.map(ingreso => (
              <Card key={ingreso.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between">
                    <div className="flex-1 space-y-3">
                      <div className="flex items-center gap-3">
                        <Calendar className="h-5 w-5 text-slate-400" />
                        <span className="font-medium">
                          {ingreso.fecha ? format(new Date(ingreso.fecha), "dd/MM/yyyy HH:mm", { locale: es }) : '-'}
                        </span>
                        <Badge className="bg-green-100 text-green-800">
                          {ingreso.tipo}
                        </Badge>
                      </div>

                      <div className="space-y-1">
                        <p className="font-semibold text-lg text-slate-800">{ingreso.concepto}</p>
                        <div className="flex items-center gap-2 text-sm text-slate-600">
                          <span className="font-mono">{ingreso.cuenta_codigo}</span>
                          <span>‚Ä¢</span>
                          <span>{ingreso.cuenta_nombre}</span>
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2">
                        <Badge variant="outline">
                          {ingreso.forma_ingreso} ‚Üí {ingreso.destino_nombre}
                        </Badge>
                        {ingreso.cliente_nombre && (
                          <Badge variant="outline">Cliente: {ingreso.cliente_nombre}</Badge>
                        )}
                        {ingreso.comprobante && (
                          <Badge variant="outline">Comp: {ingreso.comprobante}</Badge>
                        )}
                      </div>

                      {ingreso.notas && (
                        <div className="bg-slate-50 rounded-md p-3 text-sm">
                          <p className="text-slate-600">{ingreso.notas}</p>
                        </div>
                      )}
                    </div>

                    <div className="flex items-center gap-3 ml-6">
                      <div className="text-right">
                        <p className="text-sm text-slate-500 mb-1">Monto</p>
                        <p className="text-2xl font-bold text-green-600">
                          ${(ingreso.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                        </p>
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setDeleteDialog({ open: true, ingreso })}
                        className="text-red-600 hover:text-red-700 hover:bg-red-50"
                      >
                        <Trash2 className="h-5 w-5" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}

        {/* Alert Dialog para eliminar */}
        <AlertDialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open, ingreso: deleteDialog.ingreso })}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>¬øEliminar este ingreso?</AlertDialogTitle>
              <AlertDialogDescription className="space-y-2">
                <p>Esta acci√≥n eliminar√° el ingreso y revertir√° todos los cambios asociados:</p>
                {deleteDialog.ingreso && (
                  <div className="bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                    <p className="font-semibold text-amber-900 mb-2">{deleteDialog.ingreso.tipo}: {deleteDialog.ingreso.concepto}</p>
                    <p className="text-slate-700">Cuenta: {deleteDialog.ingreso.cuenta_nombre}</p>
                    <p className="text-slate-700">Monto: <strong>${(deleteDialog.ingreso.monto || 0).toLocaleString('es-AR')}</strong></p>
                    <p className="text-slate-700 mt-2">Se revertir√°n saldos de cajas/bancos y movimientos de tesorer√≠a.</p>
                  </div>
                )}
                <p className="text-xs text-slate-500 mt-2">Esta acci√≥n no se puede deshacer.</p>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel disabled={eliminarMutation.isPending}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={() => deleteDialog.ingreso && eliminarMutation.mutate(deleteDialog.ingreso)}
                disabled={eliminarMutation.isPending}
                className="bg-red-600 hover:bg-red-700"
              >
                {eliminarMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Eliminando...
                  </>
                ) : (
                  'S√≠, Eliminar Ingreso'
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Modal Nuevo Ingreso */}
        <Dialog open={modalOpen} onOpenChange={cerrarModal}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Nuevo Ingreso Vario</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Fecha *</Label>
                  <Input
                    type="datetime-local"
                    value={formData.fecha}
                    onChange={(e) => setFormData({...formData, fecha: e.target.value})}
                  />
                </div>
                <div>
                  <Label>Tipo *</Label>
                  <select
                    value={formData.tipo}
                    onChange={(e) => setFormData({...formData, tipo: e.target.value})}
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                  >
                    <option value="Ingreso">Ingreso</option>
                    <option value="Otro Ingreso">Otro Ingreso</option>
                  </select>
                </div>
              </div>

              <div>
                <Label>Cuenta Contable *</Label>
                <SearchableSelect
                  options={cuentasIngresos}
                  value={formData.cuenta_id}
                  onChange={(id, cuenta) => {
                    setFormData({
                      ...formData,
                      cuenta_id: id,
                      cuenta_codigo: cuenta?.codigo || '',
                      cuenta_nombre: cuenta?.nombre || ''
                    });
                  }}
                  displayKey="nombre"
                  placeholder="Seleccionar cuenta de ingresos..."
                />
                {formData.cuenta_id && cuentasIngresos.find(c => c.id === formData.cuenta_id) && (
                  <p className="text-xs text-slate-500 mt-1">
                    C√≥digo: {cuentasIngresos.find(c => c.id === formData.cuenta_id)?.codigo}
                  </p>
                )}
              </div>

              <div>
                <Label>Concepto *</Label>
                <Input
                  value={formData.concepto}
                  onChange={(e) => setFormData({...formData, concepto: e.target.value})}
                  placeholder="Descripci√≥n del ingreso"
                />
              </div>

              <div>
                <Label>Monto *</Label>
                <Input
                  type="number"
                  step="0.01"
                  value={formData.monto}
                  onChange={(e) => setFormData({...formData, monto: parseFloat(e.target.value) || 0})}
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Forma de Ingreso *</Label>
                  <select
                    value={formData.forma_ingreso}
                    onChange={(e) => {
                      const forma = e.target.value;
                      setFormData({
                        ...formData,
                        forma_ingreso: forma,
                        destino_tipo: forma === 'Efectivo' ? 'Caja' : 'Banco',
                        destino_id: ''
                      });
                    }}
                    className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                  >
                    <option value="Efectivo">üíµ Efectivo ‚Üí Caja</option>
                    <option value="Transferencia">üè¶ Transferencia ‚Üí Banco</option>
                    <option value="Cheque">üìÑ Cheque</option>
                  </select>
                </div>
                <div>
                  <Label>Destino *</Label>
                  <SearchableSelect
                    options={destinosDisponibles}
                    value={formData.destino_id}
                    onChange={(id) => setFormData({...formData, destino_id: id})}
                    displayKey="nombre"
                    placeholder={`Seleccionar ${formData.destino_tipo === 'Banco' ? 'banco' : 'caja'}...`}
                  />
                </div>
              </div>

              <div>
                <Label>Cliente (Opcional)</Label>
                <SearchableSelect
                  options={clientes}
                  value={formData.cliente_id}
                  onChange={(id) => setFormData({...formData, cliente_id: id})}
                  displayKey="nombre"
                  placeholder="Seleccionar cliente..."
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Label>Comprobante</Label>
                  <Input
                    value={formData.comprobante}
                    onChange={(e) => setFormData({...formData, comprobante: e.target.value})}
                    placeholder="N√∫mero de comprobante"
                  />
                </div>
              </div>

              <div>
                <Label>Notas</Label>
                <Input
                  value={formData.notas}
                  onChange={(e) => setFormData({...formData, notas: e.target.value})}
                  placeholder="Notas adicionales"
                />
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={cerrarModal}>Cancelar</Button>
              <Button
                onClick={handleGuardar}
                disabled={guardarIngresoMutation.isPending}
                className="bg-green-600 hover:bg-green-700"
              >
                {guardarIngresoMutation.isPending && (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                )}
                Guardar Ingreso
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Inventario.jsx">
import React, { useState, useMemo, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useQueryClient, useMutation } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Package, Search, TrendingUp, TrendingDown, AlertTriangle, AlertCircle, Edit, History } from "lucide-react";
import { format } from "date-fns";
import { es } from "date-fns/locale";
import { recalcularStockExacto, toFixed2, sumaExacta } from "../components/utils/precisionDecimal";
import { toast } from "sonner";
import AjusteManualEnvaseModal from '@/components/inventario/AjusteManualEnvaseModal';
import HistorialAjustesModal from '@/components/inventario/HistorialAjustesModal';

export default function Inventario() {
  const queryClient = useQueryClient();
  const [search, setSearch] = useState('');
  const [selectedProducto, setSelectedProducto] = useState(null);
  const [verificandoStock, setVerificandoStock] = useState(false);
  const [ajusteModal, setAjusteModal] = useState({ open: false, envase: null, tipoAjuste: null, stockActual: 0 });
  const [historialModal, setHistorialModal] = useState(false);
  const umbralBajo = 100; // kg

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list(),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientos = [], error: errorMov } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-fecha', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: salidas = [], error: errorSal } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-fecha', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: envases = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: ajustesManuales = [] } = useQuery({
    queryKey: ['ajustes-manuales'],
    queryFn: () => base44.entities.AjusteManualEnvase.list('-fecha', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  // Verificaci√≥n y correcci√≥n autom√°tica de precisi√≥n de stock
  useEffect(() => {
    const verificarYCorregirTodo = async () => {
      if (!productos.length || !movimientos.length || errorMov || errorSal) return;
      
      setVerificandoStock(true);
      let correccionesProductos = 0;
      
      // Verificar y corregir PRODUCTOS
      for (const producto of productos) {
        const stockCalculado = recalcularStockExacto(producto.id, movimientos, salidas);
        const stockActual = toFixed2(producto.stock || 0);
        const diferencia = Math.abs(stockCalculado - stockActual);
        
        if (diferencia > 0.005) {
          console.warn(`Correcci√≥n precisi√≥n: ${producto.fruta} ${producto.variedad} - Stock actual: ${stockActual} kg -> Correcto: ${stockCalculado} kg`);
          await base44.entities.Producto.update(producto.id, { stock: stockCalculado });
          correccionesProductos++;
        }
      }
      
      if (correccionesProductos > 0) {
        queryClient.invalidateQueries(['productos']);
        toast.success(`Stocks verificados y corregidos`, {
          duration: 5000,
          description: `${correccionesProductos} productos ajustados autom√°ticamente`
        });
      }
      
      setVerificandoStock(false);
    };
    
    verificarYCorregirTodo();
  }, [productos.length, movimientos.length, salidas.length]);

  const productosConStock = useMemo(() => {
    return productos
      .map(p => ({
        ...p,
        producto_completo: `${p.fruta} - ${p.variedad}`,
        stock: p.stock || 0,
        stockBajo: (p.stock || 0) < umbralBajo
      }))
      .sort((a, b) => b.stock - a.stock);
  }, [productos]);

  const productosFiltrados = useMemo(() => {
    if (!search) return productosConStock;
    const searchLower = search.toLowerCase();
    return productosConStock.filter(p => 
      p.producto_completo.toLowerCase().includes(searchLower)
    );
  }, [productosConStock, search]);

  const calcularHistoricoProducto = (productoId) => {
    const historico = [];

    // Ingresos desde movimientos
    movimientos.forEach(mov => {
      if (mov.tipo_movimiento === 'Ingreso de Fruta' && mov.pesajes) {
        mov.pesajes.forEach(p => {
          if (p.producto_id === productoId) {
            historico.push({
              fecha: mov.fecha,
              tipo: 'ingreso',
              cantidad: toFixed2(p.peso_neto || 0),
              referencia: `Ingreso - ${mov.proveedor_nombre}`,
              proveedor: mov.proveedor_nombre
            });
          }
        });
      }
    });

    // Salidas (P√âRDIDAS DEFINITIVAS - NUNCA VUELVEN AL STOCK)
    salidas.forEach(sal => {
      if (sal.detalles) {
        sal.detalles.forEach(d => {
          if (d.producto_id === productoId) {
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // CORRECCI√ìN CR√çTICA: Stock se reduce por ORIGINALES, NO por efectivos
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // - kilos_salida ORIGINALES: Lo que sali√≥ del acopio (RESTA del stock)
            // - P√©rdidas (b√°scula + calidad): NO vuelven al inventario
            // - En historial mostramos los ORIGINALES para reflejar impacto real en stock
            
            const kilosOriginalesSalidos = d.kilos_salida;
            
            historico.push({
              fecha: sal.fecha,
              tipo: 'salida',
              cantidad: kilosOriginalesSalidos, // Mostrar ORIGINALES (impacto real en stock)
              referencia: `${sal.numero_remito} - ${sal.cliente_nombre}`,
              cliente: sal.cliente_nombre,
              estado: sal.estado,
              // Datos adicionales para detalle expandido
              kilosReales: sal.estado === 'Confirmada' ? (d.kilos_reales || d.kilos_salida) : null,
              descuentoKg: sal.estado === 'Confirmada' ? (d.descuento_kg || 0) : null,
              kilosEfectivos: sal.estado === 'Confirmada' ? toFixed2((d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0)) : null,
              perdidaBascula: sal.estado === 'Confirmada' ? toFixed2(d.kilos_salida - (d.kilos_reales || d.kilos_salida)) : 0,
              perdidaCalidad: sal.estado === 'Confirmada' ? toFixed2(d.descuento_kg || 0) : 0
            });
          }
        });
      }
    });

    return historico.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
  };

  const totalStock = toFixed2(sumaExacta(...productosConStock.map(p => p.stock)));
  const productosStockBajo = productosConStock.filter(p => p.stockBajo).length;

  // Stock de envases: lectura desde entidad (stocks vivos actualizados por StockService)
  const envasesConStock = useMemo(() => {
    return envases
      .map(e => ({
        ...e,
        id: e.id,
        tipo: e.tipo,
        stock_vacios: Math.max(0, Number(e.stock_vacios) || 0),
        stock_ocupados: Math.max(0, Number(e.stock_ocupados) || 0),
        total: Math.max(0, (Number(e.stock_vacios) || 0) + (Number(e.stock_ocupados) || 0))
      }))
      .sort((a, b) => b.total - a.total);
  }, [envases]);

  const totalEnvasesVacios = envasesConStock.reduce((sum, e) => sum + e.stock_vacios, 0);
  const totalEnvasesOcupados = envasesConStock.reduce((sum, e) => sum + e.stock_ocupados, 0);

  const handleAjusteSuccess = () => {
    queryClient.invalidateQueries(['envases']);
    queryClient.invalidateQueries(['ajustes-manuales']);
    toast.success('Ajuste manual registrado correctamente');
  };

  const abrirAjuste = (envase, tipoAjuste) => {
    const stockActual = tipoAjuste === 'vacios' ? envase.stock_vacios : envase.stock_ocupados;
    setAjusteModal({ open: true, envase, tipoAjuste, stockActual });
  };

  if (errorMov || errorSal) {
    return (
      <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
        <div className="max-w-7xl mx-auto">
          <Card className="border-red-200 bg-red-50">
            <CardContent className="p-12 text-center">
              <AlertCircle className="h-12 w-12 text-red-600 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-red-900 mb-2">Error al cargar inventario</h3>
              <p className="text-red-700">No se pudieron cargar los datos. Por favor, recarga la p√°gina.</p>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto space-y-6">
        <div>
          <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
            <Package className="h-8 w-8 text-indigo-600" />
            Inventario
          </h1>
          <p className="text-slate-600 mt-1">Control de stock y movimientos de productos / envases</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-3">
                <div className="p-3 bg-indigo-100 rounded-lg">
                  <Package className="h-6 w-6 text-indigo-600" />
                </div>
                <div>
                  <p className="text-sm text-slate-600">Stock Total</p>
                  <p className="text-2xl font-bold text-slate-800">{totalStock.toFixed(0)} kg</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-3">
                <div className="p-3 bg-green-100 rounded-lg">
                  <TrendingUp className="h-6 w-6 text-green-600" />
                </div>
                <div>
                  <p className="text-sm text-slate-600">Productos en Stock</p>
                  <p className="text-2xl font-bold text-slate-800">{productosConStock.length}</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-3">
                <div className="p-3 bg-red-100 rounded-lg">
                  <AlertTriangle className="h-6 w-6 text-red-600" />
                </div>
                <div>
                  <p className="text-sm text-slate-600">Stock Bajo</p>
                  <p className="text-2xl font-bold text-slate-800">{productosStockBajo}</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        <Card className="border-0 shadow-lg">
          <CardHeader>
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <CardTitle>Productos</CardTitle>
              <div className="relative w-full md:w-64">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400" />
                <Input
                  placeholder="Buscar producto..."
                  value={search}
                  onChange={(e) => setSearch(e.target.value)}
                  className="pl-9"
                />
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              {productosFiltrados.map((producto) => (
                <button
                  key={producto.id}
                  onClick={() => setSelectedProducto(selectedProducto?.id === producto.id ? null : producto)}
                  className="w-full text-left"
                >
                  <div className={`p-4 rounded-lg border transition-all ${
                    producto.stockBajo 
                      ? 'border-red-200 bg-red-50 hover:bg-red-100' 
                      : 'border-slate-200 bg-white hover:bg-slate-50'
                  }`}>
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <h3 className="font-semibold text-slate-800">{producto.producto_completo}</h3>
                        <p className="text-sm text-slate-600 mt-1">
                          Stock Disponible (Kilos Netos): <strong className={
                            producto.stock < 0 ? 'text-red-700' : producto.stockBajo ? 'text-red-600' : 'text-green-600'
                          }>
                            {producto.stock.toFixed(2)} kg
                          </strong>
                          {producto.stock < 0 && (
                            <span className="ml-2 text-xs text-red-700 font-semibold">‚ö†Ô∏è Inventario negativo - Revisar ajustes</span>
                          )}
                        </p>
                      </div>
                      {producto.stockBajo && (
                        <div className="flex items-center gap-2 text-red-600">
                          <AlertTriangle className="h-5 w-5" />
                          <span className="text-sm font-medium">Stock Bajo</span>
                        </div>
                      )}
                    </div>

                    {selectedProducto?.id === producto.id && (
                      <div className="mt-4 pt-4 border-t border-slate-200">
                        <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                          <h5 className="text-sm font-semibold text-blue-900 mb-2">Breakdown de Stock (Kilos Netos)</h5>
                          <div className="grid grid-cols-2 gap-2 text-sm">
                            <div>
                              <span className="text-slate-600">Total Ingresado:</span>
                              <span className="ml-2 font-semibold text-green-700">
                               +{toFixed2(sumaExacta(
                                 ...calcularHistoricoProducto(producto.id)
                                   .filter(m => m.tipo === 'ingreso')
                                   .map(m => m.cantidad)
                               ))} kg
                              </span>
                            </div>
                            <div>
                              <span className="text-slate-600">Total Salido:</span>
                              <span className="ml-2 font-semibold text-red-700">
                               -{toFixed2(sumaExacta(
                                 ...calcularHistoricoProducto(producto.id)
                                   .filter(m => m.tipo === 'salida')
                                   .map(m => m.cantidad)
                               ))} kg
                              </span>
                            </div>
                            <div className="col-span-2 pt-2 border-t border-blue-300">
                              <span className="text-slate-700 font-semibold">Stock Disponible:</span>
                              <span className={`ml-2 text-lg font-bold ${
                                producto.stock < 0 ? 'text-red-700' : producto.stockBajo ? 'text-orange-600' : 'text-green-700'
                              }`}>
                                {producto.stock.toFixed(2)} kg
                              </span>
                            </div>
                          </div>
                        </div>
                        <h4 className="font-semibold text-slate-700 mb-3">Historial de Movimientos</h4>
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                          {calcularHistoricoProducto(producto.id).map((mov, idx) => (
                            <div key={idx} className="p-3 bg-slate-50 rounded">
                              <div className="flex items-start justify-between">
                                <div className="flex items-start gap-3">
                                  {mov.tipo === 'ingreso' ? (
                                    <TrendingUp className="h-5 w-5 text-green-600 mt-0.5" />
                                  ) : (
                                    <TrendingDown className="h-5 w-5 text-red-600 mt-0.5" />
                                  )}
                                  <div>
                                    <p className="text-sm font-medium text-slate-800">{mov.referencia}</p>
                                    <p className="text-xs text-slate-500">
                                      {format(new Date(mov.fecha), "dd/MM/yyyy HH:mm", { locale: es })}
                                    </p>
                                    {mov.estado === 'Pendiente de Confirmaci√≥n' && (
                                      <span className="text-xs text-amber-600 font-medium">
                                        (Pendiente confirmaci√≥n)
                                      </span>
                                    )}
                                    {mov.estado === 'Confirmada' && mov.kilosEfectivos != null && (
                                      <div className="text-xs text-slate-600 mt-1 space-y-0.5">
                                        <p>‚îî‚îÄ Efectivos cobrados: <strong className="text-green-700">{mov.kilosEfectivos.toFixed(2)} kg</strong></p>
                                        {(mov.perdidaBascula > 0 || mov.perdidaCalidad > 0) && (
                                          <p className="text-red-600">
                                            ‚îî‚îÄ P√©rdidas irreversibles: <strong>{(mov.perdidaBascula + mov.perdidaCalidad).toFixed(2)} kg</strong> (no vuelven al stock)
                                          </p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <div className="text-right">
                                  <span className={`font-semibold ${
                                    mov.tipo === 'ingreso' ? 'text-green-600' : 'text-red-600'
                                  }`}>
                                    {mov.tipo === 'ingreso' ? '+' : '-'}{mov.cantidad.toFixed(2)} kg
                                  </span>
                                  {mov.tipo === 'salida' && <p className="text-xs text-slate-500 mt-0.5">(Originales salidos)</p>}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </button>
              ))}
            </div>
          </CardContent>
        </Card>

        <Card className="border-0 shadow-lg">
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle>Control de Envases</CardTitle>
              <Button
                variant="outline"
                size="sm"
                onClick={() => setHistorialModal(true)}
                className="flex items-center gap-2"
              >
                <History className="h-4 w-4" />
                Ver Historial de Ajustes
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="p-4 bg-teal-50 rounded-lg border border-teal-200">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-teal-100 rounded-lg">
                    <Package className="h-5 w-5 text-teal-600" />
                  </div>
                  <div>
                    <p className="text-sm text-teal-700">Total Envases Vac√≠os</p>
                    <p className="text-2xl font-bold text-teal-600">{totalEnvasesVacios}</p>
                    <p className="text-xs text-teal-600">Disponibles para entregar</p>
                  </div>
                </div>
              </div>

              <div className="p-4 bg-orange-50 rounded-lg border border-orange-200">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-orange-100 rounded-lg">
                    <Package className="h-5 w-5 text-orange-600" />
                  </div>
                  <div>
                    <p className="text-sm text-orange-700">Total Envases Ocupados</p>
                    <p className="text-2xl font-bold text-orange-600">{totalEnvasesOcupados}</p>
                    <p className="text-xs text-orange-600">Con fruta almacenada</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="text-left p-3 font-semibold">Tipo de Envase</th>
                    <th className="text-right p-3 font-semibold">Vac√≠os</th>
                    <th className="text-right p-3 font-semibold">Ocupados</th>
                    <th className="text-right p-3 font-semibold">Total</th>
                    <th className="text-center p-3 font-semibold">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {envasesConStock.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="p-6 text-center text-slate-500">
                        No hay envases registrados
                      </td>
                    </tr>
                  ) : (
                    envasesConStock.map((envase, idx) => (
                    <tr key={`${envase.tipo}-${idx}`} className="border-b hover:bg-slate-50">
                      <td className="p-3">
                        <div className="flex items-center gap-2">
                          <Package className="h-4 w-4 text-slate-400" />
                          <span className="font-medium">{envase.tipo}</span>
                        </div>
                      </td>
                      <td className="p-3 text-right">
                        <span className="px-2 py-1 bg-teal-100 text-teal-700 rounded font-semibold">
                          {envase.stock_vacios}
                        </span>
                      </td>
                      <td className="p-3 text-right">
                        <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded font-semibold">
                          {envase.stock_ocupados}
                        </span>
                      </td>
                      <td className="p-3 text-right">
                        <span className="font-bold text-slate-800">
                          {envase.total}
                        </span>
                      </td>
                      <td className="p-3">
                        <div className="flex items-center justify-center gap-2">
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => abrirAjuste(envase, 'vacios')}
                            className="text-teal-600 hover:text-teal-700 hover:bg-teal-50"
                            title="Ajustar Vac√≠os"
                          >
                            <Edit className="h-3 w-3 mr-1" />
                            Vac√≠os
                          </Button>
                          <Button
                            size="sm"
                            variant="outline"
                            onClick={() => abrirAjuste(envase, 'ocupados')}
                            className="text-orange-600 hover:text-orange-700 hover:bg-orange-50"
                            title="Ajustar Ocupados"
                          >
                            <Edit className="h-3 w-3 mr-1" />
                            Ocupados
                          </Button>
                        </div>
                      </td>
                    </tr>
                  )))}
                </tbody>
              </table>
            </div>
          </CardContent>
        </Card>
      </div>

      <AjusteManualEnvaseModal
        open={ajusteModal.open}
        onClose={() => setAjusteModal({ open: false, envase: null, tipoAjuste: null, stockActual: 0 })}
        envase={ajusteModal.envase}
        tipoAjuste={ajusteModal.tipoAjuste}
        stockActual={ajusteModal.stockActual}
        onSuccess={handleAjusteSuccess}
      />

      <HistorialAjustesModal
        open={historialModal}
        onClose={() => setHistorialModal(false)}
        ajustes={ajustesManuales}
        onDelete={() => {
          queryClient.invalidateQueries(['ajustes-manuales']);
          queryClient.invalidateQueries(['envases']);
          toast.success('El ajuste ha sido eliminado y el stock recalculado');
        }}
      />
    </div>
  );
}
</file>

<file path="src/pages/MovimientoEnvases.jsx">
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { base44 } from '@/api/base44Client';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Plus, Loader2, Package, ArrowLeftRight, Trash2, X, Home } from "lucide-react";
import { format } from 'date-fns';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import SearchableSelect from '@/components/SearchableSelect';
import QuickCreateModal from '@/components/QuickCreateModal';
import EnvaseLineItemSimple from '@/components/EnvaseLineItemSimple';
import GenericSuccessModal from '@/components/GenericSuccessModal';
import ConfirmEnvaseModal from '@/components/ConfirmEnvaseModal';
import { descargarPDFMovimientoEnvases, compartirWhatsAppMovimientoEnvases } from '@/components/MovimientoEnvasesPDFGenerator';
import { ajustarStockEnvase } from '@/services/StockService';

export default function MovimientoEnvases() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  
  const [fecha, setFecha] = useState(format(new Date(), "yyyy-MM-dd'T'HH:mm"));
  const [tipoEntidad, setTipoEntidad] = useState('Proveedor');
  const [proveedorId, setProveedorId] = useState('');
  const [proveedorData, setProveedorData] = useState(null);
  const [clienteId, setClienteId] = useState('');
  const [clienteData, setClienteData] = useState(null);
  const [fleteroId, setFleteroId] = useState('');
  const [fleteroData, setFleteroData] = useState(null);
  const [contabilizarViaje, setContabilizarViaje] = useState(false);
  
  const [envases, setEnvases] = useState([]);
  
  const [envaseActual, setEnvaseActual] = useState({
    envase_id: '',
    envase_tipo: '',
    cantidad_ingreso: 0,
    cantidad_salida: 0,
    contabilizar_viaje: false
  });
  

  const [showCloseConfirm, setShowCloseConfirm] = useState(false);

  const [createModal, setCreateModal] = useState({ open: false, type: null });
  const [successModal, setSuccessModal] = useState({ open: false, data: null });
  const [confirmEnvaseModal, setConfirmEnvaseModal] = useState({ open: false, envase: null });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const { data: proveedores = [] } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list()
  });

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list()
  });

  const { data: fleteros = [] } = useQuery({
    queryKey: ['fleteros'],
    queryFn: () => base44.entities.Fletero.list()
  });

  const { data: envasesList = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list()
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list()
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list()
  });

  const calcularSaldos = (entidadId, tipo) => {
    if (!entidadId) return [];
    const saldosPorEnvase = {};
    
    // Movimientos de envases vac√≠os directos
    movimientos
      .filter(m => tipo === 'Proveedor' ? m.proveedor_id === entidadId : m.cliente_id === entidadId)
      .forEach(m => {
        m.movimiento_envases?.forEach(e => {
          if (!saldosPorEnvase[e.envase_tipo]) {
            saldosPorEnvase[e.envase_tipo] = 0;
          }
          saldosPorEnvase[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
        });
      });

    // PROVEEDORES: Restar envases llenos devueltos en Ingreso de Fruta
    if (tipo === 'Proveedor') {
      movimientos
        .filter(m => m.proveedor_id === entidadId && m.tipo_movimiento === 'Ingreso de Fruta' && m.envases_llenos)
        .forEach(m => {
          m.envases_llenos.forEach(e => {
            if (!saldosPorEnvase[e.envase_tipo]) {
              saldosPorEnvase[e.envase_tipo] = 0;
            }
            saldosPorEnvase[e.envase_tipo] -= (e.cantidad || 0);
          });
        });
    }

    // Envases en salidas de fruta (solo para clientes)
    if (tipo === 'Cliente') {
      salidas
        .filter(s => s.cliente_id === entidadId)
        .forEach(s => {
          s.movimiento_envases?.forEach(e => {
            if (!saldosPorEnvase[e.envase_tipo]) {
              saldosPorEnvase[e.envase_tipo] = 0;
            }
            saldosPorEnvase[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
          });
        });
    }

    return Object.entries(saldosPorEnvase).map(([tipo, saldo]) => ({
      envase_tipo: tipo,
      saldo: Math.max(0, saldo)
    }));
  };

  const handleProveedorSelect = (id, prov) => {
    setProveedorId(id);
    setProveedorData(prov);
  };

  const handleClienteSelect = (id, cli) => {
    setClienteId(id);
    setClienteData(cli);
  };

  const handleFleteroSelect = (id, flet) => {
    setFleteroId(id);
    setFleteroData(flet);
  };

  const handleAgregarEnvase = () => {
    if (!envaseActual.envase_id) {
      alert('Por favor seleccione un tipo de envase');
      return;
    }
    
    if ((envaseActual.cantidad_ingreso || 0) === 0 && (envaseActual.cantidad_salida || 0) === 0) {
      alert('Por favor ingrese al menos una cantidad (ingreso o salida)');
      return;
    }
    
    // Mostrar modal de confirmaci√≥n
    setConfirmEnvaseModal({ open: true, envase: envaseActual });
  };

  const confirmarEnvase = () => {
    setEnvases([...envases, {...confirmEnvaseModal.envase}]);
    setConfirmEnvaseModal({ open: false, envase: null });
    // Resetear envase actual
    setEnvaseActual({
      envase_id: '',
      envase_tipo: '',
      cantidad_ingreso: 0,
      cantidad_salida: 0,
      contabilizar_viaje: false
    });
  };

  const updateEnvaseActual = (data) => {
    setEnvaseActual(data);
  };

  const removeEnvase = (index) => {
    setEnvases(envases.filter((_, i) => i !== index));
  };

  const handleCreateSave = async (data) => {
    setIsSubmitting(true);
    try {
      if (createModal.type === 'proveedor') {
        const created = await base44.entities.Proveedor.create(data);
        queryClient.invalidateQueries(['proveedores']);
        setProveedorId(created.id);
        setProveedorData(created);
      } else if (createModal.type === 'cliente') {
        const created = await base44.entities.Cliente.create(data);
        queryClient.invalidateQueries(['clientes']);
        setClienteId(created.id);
        setClienteData(created);
      } else if (createModal.type === 'fletero') {
        const created = await base44.entities.Fletero.create(data);
        queryClient.invalidateQueries(['fleteros']);
        setFleteroId(created.id);
        setFleteroData(created);
      } else if (createModal.type === 'envase') {
        await base44.entities.Envase.create(data);
        queryClient.invalidateQueries(['envases']);
      }
      setCreateModal({ open: false, type: null });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSubmit = async () => {
    const entidadId = tipoEntidad === 'Proveedor' ? proveedorId : clienteId;
    const entidadData = tipoEntidad === 'Proveedor' ? proveedorData : clienteData;

    if (!entidadId) {
      alert(`Por favor seleccione un ${tipoEntidad.toLowerCase()}`);
      return;
    }

    if (envases.length === 0) {
      alert('Por favor agregue al menos un movimiento de envases');
      return;
    }

    // Validar stock de envases VAC√çOS antes de guardar
    for (const envase of envases) {
      if (envase.cantidad_salida > 0) {
        const envaseData = envasesList.find(e => e.id === envase.envase_id);
        if (!envaseData) continue;
        
        const stockDisponible = envaseData.stock_vacios || 0;
        
        if (envase.cantidad_salida > stockDisponible) {
          alert(`Error: Envase "${envaseData.tipo}" - Salida (${envase.cantidad_salida}) supera stock vac√≠os disponible (${stockDisponible}). Movimiento de Envases solo maneja envases vac√≠os.`);
          return;
        }
      }
    }

    setIsSubmitting(true);
    try {
      const movimiento = {
        fecha: new Date(fecha).toISOString(),
        tipo_movimiento: 'Movimiento de Envases',
        tipo_entidad: tipoEntidad,
        ...(tipoEntidad === 'Proveedor' ? {
          proveedor_id: proveedorId,
          proveedor_nombre: proveedorData?.nombre || ''
        } : {
          cliente_id: clienteId,
          cliente_nombre: clienteData?.nombre || ''
        }),
        fletero_id: fleteroId || null,
        fletero_nombre: fleteroData?.nombre || '',
        movimiento_envases: envases.map(e => ({
          ...e,
          cantidad_ingreso: parseInt(e.cantidad_ingreso) || 0,
          cantidad_salida: parseInt(e.cantidad_salida) || 0,
          contabilizar_viaje: fleteroId ? (e.contabilizar_viaje || false) : false
        }))
      };

      const created = await base44.entities.Movimiento.create(movimiento);
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ACTUALIZAR STOCK ENVASES VAC√çOS (Movimiento de Envases solo maneja vac√≠os)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      console.log('üîÑ MOVIMIENTO DE ENVASES - Actualizando stocks VAC√çOS...\n');
      
      for (const envase of movimiento.movimiento_envases) {
        const envaseData = envasesList.find(e => e.id === envase.envase_id);
        if (envaseData) {
          const ingreso = parseInt(envase.cantidad_ingreso) || 0;
          const salida = parseInt(envase.cantidad_salida) || 0;
          const deltaVacios = ingreso - salida;
          if (deltaVacios !== 0) {
            await ajustarStockEnvase(base44, envaseData.id, 0, deltaVacios);
          }
        }
      }
      
      // Refrescar datos ANTES de mostrar el modal de √©xito
      await queryClient.invalidateQueries(['movimientos']);
      await queryClient.invalidateQueries(['envases']);
      await queryClient.refetchQueries(['movimientos']);
      await queryClient.refetchQueries(['envases']);
      
      setSuccessModal({ 
        open: true, 
        data: { ...movimiento, id: created.id, entidad_whatsapp: entidadData?.whatsapp }
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDownloadPDF = () => {
    if (!successModal.data) return;
    const entidadId = successModal.data.proveedor_id || successModal.data.cliente_id;
    const tipo = successModal.data.tipo_entidad || 'Proveedor';
    const entidadData = tipo === 'Proveedor' ? proveedorData : clienteData;
    const fleteroData = fleteros.find(f => f.id === successModal.data.fletero_id);
    
    // Calcular saldos actualizados INCLUYENDO el movimiento actual
    const saldosActualizados = calcularSaldosConMovimiento(entidadId, tipo, successModal.data.movimiento_envases);
    
    descargarPDFMovimientoEnvases(successModal.data, entidadData, fleteroData, saldosActualizados);
  };

  const handleShareWhatsApp = async () => {
    if (!successModal.data) return;
    const entidadId = successModal.data.proveedor_id || successModal.data.cliente_id;
    const tipo = successModal.data.tipo_entidad || 'Proveedor';
    const entidadData = tipo === 'Proveedor' ? proveedorData : clienteData;
    
    // Calcular saldos actualizados INCLUYENDO el movimiento actual
    const saldosActualizados = calcularSaldosConMovimiento(entidadId, tipo, successModal.data.movimiento_envases);
    
    compartirWhatsAppMovimientoEnvases(successModal.data, entidadData, successModal.data.entidad_whatsapp, saldosActualizados);
  };

  const calcularSaldosConMovimiento = (entidadId, tipo, movimientoEnvases) => {
    // Calcular saldos hist√≥ricos primero
    const saldos = calcularSaldos(entidadId, tipo);
    
    // Convertir a objeto para facilitar actualizaci√≥n
    const saldosPorTipo = {};
    saldos.forEach(s => {
      saldosPorTipo[s.envase_tipo] = s.saldo;
    });
    
    // Aplicar el movimiento actual
    movimientoEnvases.forEach(e => {
      if (!saldosPorTipo[e.envase_tipo]) {
        saldosPorTipo[e.envase_tipo] = 0;
      }
      // Para proveedores y clientes: salida aumenta deuda, ingreso reduce deuda
      saldosPorTipo[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
    });
    
    // Convertir de vuelta a array, incluyendo todos los envases del movimiento
    const tiposEnMovimiento = movimientoEnvases.map(e => e.envase_tipo);
    const todosLosTipos = [...new Set([...Object.keys(saldosPorTipo), ...tiposEnMovimiento])];
    
    return todosLosTipos.map(tipo => ({
      envase_tipo: tipo,
      saldo: saldosPorTipo[tipo] || 0
    })).filter(s => s.saldo !== 0 || tiposEnMovimiento.includes(s.envase_tipo));
  };

  const getCreateFields = () => {
    switch (createModal.type) {
      case 'proveedor':
        return [
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del proveedor' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n' },
          { name: 'cuit', label: 'CUIT', placeholder: 'XX-XXXXXXXX-X' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54 9 11 XXXX-XXXX' }
        ];
      case 'cliente':
        return [
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del cliente' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n' },
          { name: 'cuit', label: 'CUIT', placeholder: 'XX-XXXXXXXX-X' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54 9 11 XXXX-XXXX' }
        ];
      case 'fletero':
        return [
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del fletero' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54 9 11 XXXX-XXXX' }
        ];
      case 'envase':
        return [
          { name: 'tipo', label: 'Tipo de Envase', placeholder: 'Ej: Bin Pl√°stico' },
          { name: 'tara', label: 'Tara (kg)', type: 'number', placeholder: '0.00' }
        ];
      default:
        return [];
    }
  };

  // Calcular saldos actuales de la entidad seleccionada
  const entidadId = tipoEntidad === 'Proveedor' ? proveedorId : clienteId;
  const entidadData = tipoEntidad === 'Proveedor' ? proveedorData : clienteData;
  const saldosActuales = calcularSaldos(entidadId, tipoEntidad);

  const hasChanges = () => {
    return proveedorId || clienteId || fleteroId || envases.length > 0 || 
           envaseActual.envase_id || envaseActual.cantidad_ingreso > 0 || envaseActual.cantidad_salida > 0;
  };

  const handleClose = () => {
    if (hasChanges()) {
      setShowCloseConfirm(true);
    } else {
      navigate('/');
    }
  };

  const confirmClose = () => {
    setShowCloseConfirm(false);
    navigate('/');
  };

  const resetForm = () => {
    setFecha(format(new Date(), "yyyy-MM-dd'T'HH:mm"));
    setTipoEntidad('Proveedor');
    setProveedorId('');
    setProveedorData(null);
    setClienteId('');
    setClienteData(null);
    setFleteroId('');
    setFleteroData(null);
    setContabilizarViaje(false);
    setEnvases([]);
    setEnvaseActual({
      envase_id: '',
      envase_tipo: '',
      cantidad_ingreso: 0,
      cantidad_salida: 0,
      contabilizar_viaje: false
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-white to-orange-50">
      <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
              <ArrowLeftRight className="h-6 w-6 text-amber-600" />
            </div>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-slate-800">Movimiento de Envases</h1>
              <p className="text-slate-500 text-sm">Registrar entrada o salida de envases</p>
            </div>
          </div>
          <Button
            variant="outline"
            onClick={handleClose}
            className="flex items-center gap-2"
          >
            <X className="h-4 w-4" />
            Cerrar
          </Button>
        </div>

        <div className="space-y-6">
          {/* Datos Generales */}
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold">Datos del Movimiento</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Fecha y Hora</label>
                  <Input
                    type="datetime-local"
                    value={fecha}
                    onChange={(e) => setFecha(e.target.value)}
                    className="h-11"
                  />
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Tipo de Entidad *</label>
                  <Select value={tipoEntidad} onValueChange={(val) => {
                    setTipoEntidad(val);
                    setProveedorId('');
                    setClienteId('');
                    setProveedorData(null);
                    setClienteData(null);
                  }}>
                    <SelectTrigger className="h-11">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Proveedor">Proveedor</SelectItem>
                      <SelectItem value="Cliente">Cliente</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">{tipoEntidad} *</label>
                  {tipoEntidad === 'Proveedor' ? (
                    <SearchableSelect
                      options={proveedores}
                      value={proveedorId}
                      onChange={handleProveedorSelect}
                      displayKey="nombre"
                      placeholder="Seleccionar proveedor..."
                      onCreateNew={() => setCreateModal({ open: true, type: 'proveedor' })}
                      createNewLabel="Crear nuevo proveedor"
                    />
                  ) : (
                    <SearchableSelect
                      options={clientes}
                      value={clienteId}
                      onChange={handleClienteSelect}
                      displayKey="nombre"
                      placeholder="Seleccionar cliente..."
                      onCreateNew={() => setCreateModal({ open: true, type: 'cliente' })}
                      createNewLabel="Crear nuevo cliente"
                    />
                  )}
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-2 block">Fletero (Opcional)</label>
                  <SearchableSelect
                    options={fleteros}
                    value={fleteroId}
                    onChange={handleFleteroSelect}
                    displayKey="nombre"
                    placeholder="Seleccionar fletero..."
                    onCreateNew={() => setCreateModal({ open: true, type: 'fletero' })}
                    createNewLabel="Crear nuevo fletero"
                  />
                </div>
              </div>


            </CardContent>
          </Card>

          {/* Saldos Actuales */}
          {entidadId && saldosActuales.length > 0 && (
            <Card className="border-0 shadow-lg shadow-amber-100/50 bg-amber-50">
              <CardHeader className="pb-3">
                <CardTitle className="text-base font-semibold text-amber-800">
                  Saldo Actual de Envases - {entidadData?.nombre}
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-3">
                  {saldosActuales.map((s, i) => (
                    <div 
                      key={i}
                      className={`px-4 py-2 rounded-lg ${
                        s.saldo > 0 
                          ? 'bg-red-100 text-red-800' 
                          : 'bg-green-100 text-green-800'
                      }`}
                    >
                      <span className="font-medium">{s.envase_tipo}:</span>
                      <span className="ml-2">
                        {s.saldo > 0 ? `Adeuda ${s.saldo}` : 'Sin deuda'}
                      </span>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Movimiento de Envases */}
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold flex items-center gap-2">
                <Package className="h-5 w-5 text-slate-400" />
                Nuevo Movimiento de Envase
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {/* Formulario envase actual */}
                <EnvaseLineItemSimple
                  item={envaseActual}
                  index={0}
                  envases={envasesList}
                  onChange={(_, data) => updateEnvaseActual(data)}
                  onCreateEnvase={() => setCreateModal({ open: true, type: 'envase' })}
                  mostrarContabilizar={!!fleteroId}
                  fleteroData={fleteroData}
                />
                
                <div className="flex justify-end">
                  <Button 
                    onClick={handleAgregarEnvase}
                    className="bg-amber-600 hover:bg-amber-700"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Agregar a Lista
                  </Button>
                </div>
              </div>

              {/* Lista de envases agregados */}
              {envases.length > 0 && (
                <div className="mt-6 pt-6 border-t">
                  <div className="flex items-center justify-between mb-3">
                    <h4 className="font-semibold text-slate-700">Envases Agregados ({envases.length})</h4>
                  </div>
                  <div className="space-y-3">
                    {envases.map((envase, index) => (
                     <div key={index} className="p-3 bg-amber-50 rounded-lg border border-amber-200">
                       <div className="flex items-start justify-between">
                         <div className="flex-1">
                           <p className="font-medium text-slate-800">{envase.envase_tipo}</p>
                           <div className="flex flex-wrap gap-3 mt-1 text-sm">
                             {envase.cantidad_ingreso > 0 && (
                               <span className="text-green-600">
                                 Ingreso: +{envase.cantidad_ingreso}
                               </span>
                             )}
                             {envase.cantidad_salida > 0 && (
                               <span className="text-red-600">
                                 Salida: -{envase.cantidad_salida}
                               </span>
                             )}
                             {fleteroId && envase.contabilizar_viaje && (
                               <span className="px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold">
                                 ‚úì Contabilizado
                               </span>
                             )}
                           </div>
                         </div>
                         <Button
                           variant="ghost"
                           size="icon"
                           onClick={() => removeEnvase(index)}
                           className="text-red-500 hover:text-red-700 hover:bg-red-50 ml-2"
                         >
                           <Trash2 className="h-4 w-4" />
                         </Button>
                       </div>
                     </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="mt-4 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                <div className="flex items-start gap-2">
                  <Package className="h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0" />
                  <div className="text-xs text-blue-900">
                    <p className="font-semibold mb-1">‚ÑπÔ∏è Movimiento de Envases Vac√≠os</p>
                    <p className="mb-1"><strong>Ingreso:</strong> {tipoEntidad === 'Proveedor' ? 'El proveedor devuelve' : 'El cliente devuelve'} envases vac√≠os al acopio (suma a Stock Vac√≠os)</p>
                    <p><strong>Salida:</strong> El acopio entrega envases vac√≠os al {tipoEntidad.toLowerCase()} (resta de Stock Vac√≠os)</p>
                    <p className="mt-2 text-blue-700 font-medium">Los envases llenos (con fruta) se gestionan en Ingreso/Salida de Fruta.</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Bot√≥n Guardar */}
          <div className="flex justify-end">
            <Button
              onClick={handleSubmit}
              disabled={isSubmitting || !entidadId}
              size="lg"
              className="bg-amber-600 hover:bg-amber-700 text-white px-8"
            >
              {isSubmitting ? (
                <Loader2 className="h-5 w-5 animate-spin mr-2" />
              ) : (
                <Package className="h-5 w-5 mr-2" />
              )}
              Registrar Movimiento
            </Button>
          </div>
        </div>
      </div>

      <QuickCreateModal
        open={createModal.open}
        onClose={() => setCreateModal({ open: false, type: null })}
        onSave={handleCreateSave}
        title={
          createModal.type === 'proveedor' ? 'Nuevo Proveedor' :
          createModal.type === 'cliente' ? 'Nuevo Cliente' :
          createModal.type === 'fletero' ? 'Nuevo Fletero' :
          'Nuevo Envase'
        }
        fields={getCreateFields()}
        isLoading={isSubmitting}
      />

      <ConfirmEnvaseModal
        open={confirmEnvaseModal.open}
        onClose={() => setConfirmEnvaseModal({ open: false, envase: null })}
        envase={confirmEnvaseModal.envase}
        onConfirm={confirmarEnvase}
        onEdit={() => setConfirmEnvaseModal({ open: false, envase: null })}
      />

      <GenericSuccessModal
        open={successModal.open}
        onClose={() => {
          setSuccessModal({ open: false, data: null });
          resetForm();
        }}
        title="¬°Movimiento Registrado!"
        message="El movimiento se ha registrado correctamente"
        onDownloadPDF={handleDownloadPDF}
        onShareWhatsApp={handleShareWhatsApp}
      />

      <AlertDialog open={showCloseConfirm} onOpenChange={setShowCloseConfirm}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>¬øCerrar sin guardar?</AlertDialogTitle>
            <AlertDialogDescription>
              Hay cambios sin guardar en el formulario. Si cierra ahora, se perder√°n todos los datos ingresados.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>No, Continuar Editando</AlertDialogCancel>
            <AlertDialogAction onClick={confirmClose} className="bg-red-600 hover:bg-red-700">
              <Home className="h-4 w-4 mr-2" />
              S√≠, Volver al Inicio
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
</file>

<file path="src/pages/MovimientoFruta.jsx">
import React, { useState } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent } from "@/components/ui/card";
import { Apple, ShoppingCart, CheckCircle } from "lucide-react";
import IngresoFruta from './IngresoFruta';
import SalidaFruta from './SalidaFruta';
import ConfirmarSalida from './ConfirmarSalida';

export default function MovimientoFruta() {
  const [activeTab, setActiveTab] = useState('ingreso');

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-6xl mx-auto">
        <div className="mb-4 md:mb-6">
          <h1 className="text-xl md:text-2xl lg:text-3xl font-bold text-slate-800 flex items-center gap-2 md:gap-3">
            <Apple className="h-6 w-6 md:h-8 md:w-8 text-green-600" />
            <span className="break-words">Movimiento de Fruta</span>
          </h1>
          <p className="text-sm md:text-base text-slate-600 mt-1">Gesti√≥n completa de ingresos y salidas de fruta</p>
        </div>

        <Card className="border-0 shadow-lg">
          <CardContent className="p-6">
            <Tabs value={activeTab} onValueChange={setActiveTab}>
              <TabsList className="grid w-full grid-cols-3 mb-4 md:mb-6 h-auto">
                <TabsTrigger value="ingreso" className="text-xs md:text-sm py-2 flex items-center gap-1 md:gap-2">
                  <Apple className="h-3 w-3 md:h-4 md:w-4" />
                  <span className="hidden sm:inline">Ingreso de Fruta</span>
                  <span className="sm:hidden">Ingreso</span>
                </TabsTrigger>
                <TabsTrigger value="salida" className="text-xs md:text-sm py-2 flex items-center gap-1 md:gap-2">
                  <ShoppingCart className="h-3 w-3 md:h-4 md:w-4" />
                  <span className="hidden sm:inline">Salida de Fruta</span>
                  <span className="sm:hidden">Salida</span>
                </TabsTrigger>
                <TabsTrigger value="confirmar" className="text-xs md:text-sm py-2 flex items-center gap-1 md:gap-2">
                  <CheckCircle className="h-3 w-3 md:h-4 md:w-4" />
                  <span className="hidden sm:inline">Confirmar Salidas</span>
                  <span className="sm:hidden">Confirmar</span>
                </TabsTrigger>
              </TabsList>

              <TabsContent value="ingreso" className="mt-0">
                <IngresoFruta embedded={true} />
              </TabsContent>

              <TabsContent value="salida" className="mt-0">
                <SalidaFruta embedded={true} />
              </TabsContent>

              <TabsContent value="confirmar" className="mt-0">
                <ConfirmarSalida embedded={true} />
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/MovimientosTesoreria.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import SearchableSelect from '@/components/SearchableSelect';
import ExportarMovimientosModal from '@/components/tesoreria/ExportarMovimientosModal';
import ExportarMovimientosPDFModal from '@/components/tesoreria/ExportarMovimientosPDFModal';
import EditarFechaMovimientoModal from '@/components/tesoreria/EditarFechaMovimientoModal';
import { ArrowLeftRight, Plus, Loader2, Calendar, DollarSign, TrendingUp, TrendingDown, Trash2, FileDown, FileText, Filter, ChevronLeft, ChevronRight, Edit } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from 'sonner';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { actualizarSaldoEntidad } from '@/utils/contabilidad';

export default function MovimientosTesoreria() {
  const queryClient = useQueryClient();
  const [modalOpen, setModalOpen] = useState(false);
  const [exportModalOpen, setExportModalOpen] = useState(false);
  const [pdfModalOpen, setPdfModalOpen] = useState(false);
  const [editarFechaModal, setEditarFechaModal] = useState({ open: false, movimiento: null });
  const [deleteDialog, setDeleteDialog] = useState({ open: false, movimiento: null });
  
  // Estados de paginaci√≥n y filtros
  const [pagina, setPagina] = useState(1);
  const [filtroTipo, setFiltroTipo] = useState('todos');
  const [filtroOrigen, setFiltroOrigen] = useState('todos');
  const ITEMS_POR_PAGINA = 20;
  const [formData, setFormData] = useState({
    fecha: format(new Date(), 'yyyy-MM-dd'),
    tipo_movimiento: 'Transferencia Interna',
    origen_tipo: 'Caja',
    origen_id: '',
    destino_tipo: 'Banco',
    destino_id: '',
    monto: 0,
    concepto: '',
    comprobante: ''
  });

  // Consulta paginada con filtros
  const { data: movimientos = [], isLoading } = useQuery({
    queryKey: ['movimientostesoreria', pagina, filtroTipo, filtroOrigen],
    queryFn: async () => {
      let query = {};
      
      // Aplicar filtros
      if (filtroTipo !== 'todos') {
        if (filtroTipo === 'ingresos') {
          query.tipo_movimiento = { $in: ['Ingreso Manual', 'Cr√©dito Bancario'] };
        } else if (filtroTipo === 'egresos') {
          query.tipo_movimiento = { $in: ['Egreso Manual', 'D√©bito Bancario'] };
        } else if (filtroTipo === 'transferencias') {
          query.tipo_movimiento = 'Transferencia Interna';
        }
      }
      
      if (filtroOrigen !== 'todos') {
        if (filtroOrigen === 'cobros') {
          query.referencia_origen_tipo = 'Cobro';
        } else if (filtroOrigen === 'pagos') {
          query.referencia_origen_tipo = 'Pago';
        } else if (filtroOrigen === 'ingresos_varios') {
          query.referencia_origen_tipo = 'IngresoVario';
        } else if (filtroOrigen === 'egresos_varios') {
          query.referencia_origen_tipo = 'Egreso';
        }
      }
      
      const skip = (pagina - 1) * ITEMS_POR_PAGINA;
      return base44.entities.MovimientoTesoreria.filter(query, '-fecha', ITEMS_POR_PAGINA, skip);
    },
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  // Consulta para contar total de movimientos (para paginaci√≥n)
  const { data: totalMovimientos = 0 } = useQuery({
    queryKey: ['movimientostesoreria-count', filtroTipo, filtroOrigen],
    queryFn: async () => {
      let query = {};
      
      if (filtroTipo !== 'todos') {
        if (filtroTipo === 'ingresos') {
          query.tipo_movimiento = { $in: ['Ingreso Manual', 'Cr√©dito Bancario'] };
        } else if (filtroTipo === 'egresos') {
          query.tipo_movimiento = { $in: ['Egreso Manual', 'D√©bito Bancario'] };
        } else if (filtroTipo === 'transferencias') {
          query.tipo_movimiento = 'Transferencia Interna';
        }
      }
      
      if (filtroOrigen !== 'todos') {
        if (filtroOrigen === 'cobros') {
          query.referencia_origen_tipo = 'Cobro';
        } else if (filtroOrigen === 'pagos') {
          query.referencia_origen_tipo = 'Pago';
        } else if (filtroOrigen === 'ingresos_varios') {
          query.referencia_origen_tipo = 'IngresoVario';
        } else if (filtroOrigen === 'egresos_varios') {
          query.referencia_origen_tipo = 'Egreso';
        }
      }
      
      const todos = await base44.entities.MovimientoTesoreria.filter(query);
      return todos.length;
    },
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list('nombre', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list('nombre', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: configuracion = [] } = useQuery({
    queryKey: ['configuracion'],
    queryFn: () => base44.entities.Configuracion.list(undefined, 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cobros = [] } = useQuery({
    queryKey: ['cobros'],
    queryFn: () => base44.entities.Cobro.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: pagos = [] } = useQuery({
    queryKey: ['pagos'],
    queryFn: () => base44.entities.Pago.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: ingresosVarios = [] } = useQuery({
    queryKey: ['ingresosvarios'],
    queryFn: () => base44.entities.IngresoVario.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: egresosVarios = [] } = useQuery({
    queryKey: ['egresos'],
    queryFn: () => base44.entities.Egreso.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientosIngresos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const deleteMutation = useMutation({
    mutationFn: async (movimiento) => {
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ELIMINACI√ìN COMPLETA EN CASCADA DE COBROS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      if (movimiento.referencia_origen_id && movimiento.referencia_origen_tipo) {
        if (movimiento.referencia_origen_tipo === 'Cobro') {
          const cobro = cobros.find(c => c.id === movimiento.referencia_origen_id);
          if (!cobro) {
            console.warn('Cobro no encontrado, solo eliminando MovimientoTesoreria');
            await base44.entities.MovimientoTesoreria.delete(movimiento.id);
            return;
          }

          console.log('üóëÔ∏è INICIANDO ELIMINACI√ìN TOTAL DEL COBRO:', cobro.id);

          // PASO 1: Buscar TODOS los MovimientoTesoreria vinculados
          const movimientosVinculados = movimientos.filter(m => 
            m.referencia_origen_id === cobro.id && m.referencia_origen_tipo === 'Cobro'
          );
          console.log('üìã Movimientos vinculados a eliminar:', movimientosVinculados.length);

          // PASO 2: Revertir saldos de cajas/bancos (deshacer ingresos)
          for (const mov of movimientosVinculados) {
            if (mov.destino_id && mov.destino_tipo) {
              console.log(`üí∞ Revirtiendo saldo en ${mov.destino_tipo}: ${mov.destino_nombre}`);
              
              if (mov.destino_tipo === 'Caja') {
                const caja = cajas.find(c => c.id === mov.destino_id);
                if (caja) {
                  const nuevoSaldo = (caja.saldo || 0) - mov.monto;
                  await base44.entities.Caja.update(mov.destino_id, { saldo: nuevoSaldo });
                  console.log(`  ‚úì Caja ${caja.nombre}: $${caja.saldo} ‚Üí $${nuevoSaldo}`);
                }
              } else if (mov.destino_tipo === 'Banco') {
                const banco = bancos.find(b => b.id === mov.destino_id);
                if (banco) {
                  const nuevoSaldo = (banco.saldo || 0) - mov.monto;
                  await base44.entities.Banco.update(mov.destino_id, { saldo: nuevoSaldo });
                  console.log(`  ‚úì Banco ${banco.nombre}: $${banco.saldo} ‚Üí $${nuevoSaldo}`);
                }
              }
            }
          }

          // PASO 3: Revertir estados de SalidaFruta (volver deudas)
          if (cobro.salidas_aplicadas && cobro.salidas_aplicadas.length > 0) {
            console.log('üì¶ Revirtiendo estados de salidas aplicadas:', cobro.salidas_aplicadas.length);
            
            for (const aplicado of cobro.salidas_aplicadas) {
              const salida = salidas.find(s => s.id === aplicado.salida_id);
              if (salida) {
                const montoOriginal = salida.monto_cobrado || 0;
                const nuevoMontoCobrado = montoOriginal - aplicado.monto_aplicado;
                
                let nuevoEstado = 'Pendiente';
                if (nuevoMontoCobrado >= (salida.deuda_total || 0)) {
                  nuevoEstado = 'Cobrado';
                } else if (nuevoMontoCobrado > 0) {
                  nuevoEstado = 'Pago Parcial';
                }
                
                await base44.entities.SalidaFruta.update(aplicado.salida_id, {
                  monto_cobrado: nuevoMontoCobrado,
                  estado_cobro: nuevoEstado
                });
                console.log(`  ‚úì Salida ${salida.numero_remito}: cobrado $${montoOriginal} ‚Üí $${nuevoMontoCobrado}, estado: ${nuevoEstado}`);
              }
            }
          }

          // PASO 4: Revertir saldo_actual y eliminar registros de CuentaCorriente vinculados al cobro
          console.log('üßæ Eliminando movimientos de Cuenta Corriente del cobro...');
          const todosMovimientosCC = await base44.entities.CuentaCorriente.list();
          const movsCCCobro = todosMovimientosCC.filter(m => 
            m.comprobante_id === cobro.id && m.comprobante_tipo === 'Cobro'
          );
          
          for (const movCC of movsCCCobro) {
            await actualizarSaldoEntidad(base44, 'Cliente', cobro.cliente_id, movCC.monto || 0);
            await base44.entities.CuentaCorriente.delete(movCC.id);
            console.log(`  ‚úì Eliminado movimiento CC: ${movCC.concepto} ($${movCC.monto})`);
          }

          // PASO 5: Recalcular TODOS los saldos de cuenta corriente del cliente
          console.log('üîÑ Recalculando saldos de Cuenta Corriente del cliente...');
          const movsCCCliente = todosMovimientosCC
            .filter(m => 
              m.entidad_id === cobro.cliente_id && 
              m.entidad_tipo === 'Cliente' && 
              !movsCCCobro.some(mcc => mcc.id === m.id) // Excluir los que acabamos de eliminar
            )
            .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

          let saldoAcumulado = 0;
          for (const m of movsCCCliente) {
            if (m.tipo_movimiento === 'Haber') {
              saldoAcumulado += m.monto;
            } else {
              saldoAcumulado -= m.monto;
            }
            await base44.entities.CuentaCorriente.update(m.id, {
              saldo_resultante: saldoAcumulado
            });
          }
          console.log(`  ‚úì Saldo final recalculado del cliente: $${saldoAcumulado}`);

          // PASO 6: Eliminar IngresoVario del Estado de Resultados
          console.log('üìä Eliminando registros del Estado de Resultados...');
          const ingresosRelacionados = ingresosVarios.filter(iv => 
            (iv.notas && iv.notas.includes(`ID: ${cobro.id}`)) ||
            (iv.concepto && iv.concepto.includes(cobro.concepto || ''))
          );
          
          for (const ingreso of ingresosRelacionados) {
            await base44.entities.IngresoVario.delete(ingreso.id);
            console.log(`  ‚úì Eliminado IngresoVario: ${ingreso.concepto}`);
          }

          // PASO 7: Eliminar TODOS los MovimientoTesoreria vinculados
          console.log('üí∏ Eliminando movimientos de tesorer√≠a vinculados...');
          for (const mov of movimientosVinculados) {
            await base44.entities.MovimientoTesoreria.delete(mov.id);
            console.log(`  ‚úì Eliminado MovimientoTesoreria: ${mov.concepto}`);
          }

          // PASO 8: Eliminar el COBRO definitivamente
          console.log('üî• Eliminando el Cobro del sistema...');
          await base44.entities.Cobro.delete(cobro.id);
          console.log('‚úÖ COBRO ELIMINADO COMPLETAMENTE DEL SISTEMA');
          
          return; // Finalizar sin ejecutar l√≥gica adicional
        } else if (movimiento.referencia_origen_tipo === 'Pago') {
          const pago = pagos.find(p => p.id === movimiento.referencia_origen_id);
          if (pago) {
            // Buscar TODOS los MovimientoTesoreria vinculados a este pago
            const movimientosVinculados = movimientos.filter(m => 
              m.referencia_origen_id === pago.id && m.referencia_origen_tipo === 'Pago'
            );

            // Revertir saldos de todos los medios de pago
            for (const mov of movimientosVinculados) {
              if (mov.origen_id && mov.origen_tipo) {
                if (mov.origen_tipo === 'Caja') {
                  const caja = cajas.find(c => c.id === mov.origen_id);
                  if (caja) {
                    await base44.entities.Caja.update(mov.origen_id, {
                      saldo: (caja.saldo || 0) + mov.monto
                    });
                  }
                } else if (mov.origen_tipo === 'Banco') {
                  const banco = bancos.find(b => b.id === mov.origen_id);
                  if (banco) {
                    await base44.entities.Banco.update(mov.origen_id, {
                      saldo: (banco.saldo || 0) + mov.monto
                    });
                  }
                }
              }
            }

            // Revertir estados de ingresos aplicados
            if (pago.ingresos_aplicados && pago.ingresos_aplicados.length > 0) {
              for (const aplicado of pago.ingresos_aplicados) {
                const movimientoIngreso = movimientosIngresos.find(m => m.id === aplicado.movimiento_id);
                if (movimientoIngreso) {
                  const nuevoMontoPagado = (movimientoIngreso.monto_pagado || 0) - aplicado.monto_aplicado;
                  let nuevoEstado = 'Pendiente';
                  if (nuevoMontoPagado >= (movimientoIngreso.deuda_total || 0)) {
                    nuevoEstado = 'Pagado';
                  } else if (nuevoMontoPagado > 0) {
                    nuevoEstado = 'Pago Parcial';
                  }
                  await base44.entities.Movimiento.update(aplicado.movimiento_id, {
                    monto_pagado: nuevoMontoPagado,
                    estado_pago: nuevoEstado
                  });
                }
              }
            }

            // Revertir saldo_actual y eliminar movimientos de cuenta corriente relacionados
            const movimientosCC = await base44.entities.CuentaCorriente.list();
            const movsCCPago = movimientosCC.filter(m => 
              m.comprobante_id === pago.id && m.comprobante_tipo === 'Pago'
            );
            for (const movCC of movsCCPago) {
              await actualizarSaldoEntidad(base44, 'Proveedor', pago.proveedor_id, movCC.monto || 0);
              await base44.entities.CuentaCorriente.delete(movCC.id);
            }

            // Recalcular saldos resultantes en filas de CC del proveedor
            const movsCCProveedor = movimientosCC
              .filter(m => m.entidad_id === pago.proveedor_id && m.entidad_tipo === 'Proveedor' && m.comprobante_id !== pago.id)
              .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            let saldoAcumulado = 0;
            for (const m of movsCCProveedor) {
              if (m.tipo_movimiento === 'Haber') {
                saldoAcumulado += m.monto;
              } else {
                saldoAcumulado -= m.monto;
              }
              await base44.entities.CuentaCorriente.update(m.id, {
                saldo_resultante: saldoAcumulado
              });
            }

            // Eliminar Egreso del Estado de Resultados si existe
            const egresosRelacionados = egresosVarios.filter(eg => 
              eg.notas && eg.notas.includes(`ID: ${pago.id}`)
            );
            for (const egreso of egresosRelacionados) {
              await base44.entities.Egreso.delete(egreso.id);
            }

            // Eliminar todos los movimientos de tesorer√≠a vinculados
            for (const mov of movimientosVinculados) {
              await base44.entities.MovimientoTesoreria.delete(mov.id);
            }

            // Eliminar el pago
            await base44.entities.Pago.delete(pago.id);
          }
          return; // Salir sin ejecutar la l√≥gica de abajo
        } else if (movimiento.referencia_origen_tipo === 'IngresoVario') {
          const ingreso = ingresosVarios.find(i => i.id === movimiento.referencia_origen_id);
          if (ingreso) {
            // Buscar movimientos de tesorer√≠a vinculados
            const movimientosVinculados = movimientos.filter(m => 
              m.referencia_origen_id === ingreso.id && m.referencia_origen_tipo === 'IngresoVario'
            );

            // Revertir saldos de destino
            for (const mov of movimientosVinculados) {
              if (mov.destino_id && mov.destino_tipo) {
                if (mov.destino_tipo === 'Caja') {
                  const caja = cajas.find(c => c.id === mov.destino_id);
                  if (caja) {
                    await base44.entities.Caja.update(mov.destino_id, {
                      saldo: (caja.saldo || 0) - mov.monto
                    });
                  }
                } else if (mov.destino_tipo === 'Banco') {
                  const banco = bancos.find(b => b.id === mov.destino_id);
                  if (banco) {
                    await base44.entities.Banco.update(mov.destino_id, {
                      saldo: (banco.saldo || 0) - mov.monto
                    });
                  }
                }
              }

              // Eliminar movimiento de tesorer√≠a
              await base44.entities.MovimientoTesoreria.delete(mov.id);
            }

            // Eliminar el ingreso
            await base44.entities.IngresoVario.delete(ingreso.id);
          }
          return;
        } else if (movimiento.referencia_origen_tipo === 'Egreso') {
          const egreso = egresosVarios.find(e => e.id === movimiento.referencia_origen_id);
          if (egreso) {
            // Buscar movimientos de tesorer√≠a vinculados
            const movimientosVinculados = movimientos.filter(m => 
              m.referencia_origen_id === egreso.id && m.referencia_origen_tipo === 'Egreso'
            );

            // Revertir saldos de origen
            for (const mov of movimientosVinculados) {
              if (mov.origen_id && mov.origen_tipo) {
                if (mov.origen_tipo === 'Caja') {
                  const caja = cajas.find(c => c.id === mov.origen_id);
                  if (caja) {
                    await base44.entities.Caja.update(mov.origen_id, {
                      saldo: (caja.saldo || 0) + mov.monto
                    });
                  }
                } else if (mov.origen_tipo === 'Banco') {
                  const banco = bancos.find(b => b.id === mov.origen_id);
                  if (banco) {
                    await base44.entities.Banco.update(mov.origen_id, {
                      saldo: (banco.saldo || 0) + mov.monto
                    });
                  }
                }
              }

              // Eliminar movimiento de tesorer√≠a
              await base44.entities.MovimientoTesoreria.delete(mov.id);
            }

            // Eliminar el egreso
            await base44.entities.Egreso.delete(egreso.id);
          }
          return;
        }
      }

      // Revertir saldos seg√∫n tipo de movimiento
      if (movimiento.tipo_movimiento === 'Transferencia Interna') {
        // Revertir origen: devolver el dinero que sali√≥
        if (movimiento.origen_id && movimiento.origen_tipo) {
          if (movimiento.origen_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === movimiento.origen_id);
            if (caja) {
              await base44.entities.Caja.update(movimiento.origen_id, {
                saldo: (caja.saldo || 0) + movimiento.monto
              });
            }
          } else if (movimiento.origen_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === movimiento.origen_id);
            if (banco) {
              await base44.entities.Banco.update(movimiento.origen_id, {
                saldo: (banco.saldo || 0) + movimiento.monto
              });
            }
          }
        }

        // Revertir destino: restar el dinero que entr√≥
        if (movimiento.destino_id && movimiento.destino_tipo) {
          if (movimiento.destino_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === movimiento.destino_id);
            if (caja) {
              await base44.entities.Caja.update(movimiento.destino_id, {
                saldo: (caja.saldo || 0) - movimiento.monto
              });
            }
          } else if (movimiento.destino_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === movimiento.destino_id);
            if (banco) {
              await base44.entities.Banco.update(movimiento.destino_id, {
                saldo: (banco.saldo || 0) - movimiento.monto
              });
            }
          }
        }
      } else if (movimiento.tipo_movimiento === 'Ingreso Manual' || movimiento.tipo_movimiento === 'Cr√©dito Bancario') {
        // Revertir ingreso: restar del destino
        if (movimiento.destino_id && movimiento.destino_tipo) {
          if (movimiento.destino_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === movimiento.destino_id);
            if (caja) {
              await base44.entities.Caja.update(movimiento.destino_id, {
                saldo: (caja.saldo || 0) - movimiento.monto
              });
            }
          } else if (movimiento.destino_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === movimiento.destino_id);
            if (banco) {
              await base44.entities.Banco.update(movimiento.destino_id, {
                saldo: (banco.saldo || 0) - movimiento.monto
              });
            }
          }
        }
      } else if (movimiento.tipo_movimiento === 'Egreso Manual' || movimiento.tipo_movimiento === 'D√©bito Bancario') {
        // Revertir egreso: devolver al origen
        if (movimiento.origen_id && movimiento.origen_tipo) {
          if (movimiento.origen_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === movimiento.origen_id);
            if (caja) {
              await base44.entities.Caja.update(movimiento.origen_id, {
                saldo: (caja.saldo || 0) + movimiento.monto
              });
            }
          } else if (movimiento.origen_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === movimiento.origen_id);
            if (banco) {
              await base44.entities.Banco.update(movimiento.origen_id, {
                saldo: (banco.saldo || 0) + movimiento.monto
              });
            }
          }
        }
      }

      // Eliminar el registro
      await base44.entities.MovimientoTesoreria.delete(movimiento.id);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      queryClient.invalidateQueries({ queryKey: ['cobros'] });
      queryClient.invalidateQueries({ queryKey: ['pagos'] });
      queryClient.invalidateQueries({ queryKey: ['ingresosvarios'] });
      queryClient.invalidateQueries({ queryKey: ['egresos'] });
      queryClient.invalidateQueries({ queryKey: ['cuentacorriente'] });
      queryClient.invalidateQueries({ queryKey: ['salidas'] });
      queryClient.invalidateQueries({ queryKey: ['movimientos'] });
      toast.success('Movimiento eliminado completamente');
      setDeleteDialog({ open: false, movimiento: null });
    },
    onError: (error) => {
      console.error('Error al eliminar:', error);
      toast.error('Error al eliminar el movimiento');
    }
  });

  const createMutation = useMutation({
    mutationFn: async (data) => {
      // Obtener nombres de origen y destino
      let origenNombre = '';
      let destinoNombre = '';

      if (data.origen_id) {
        if (data.origen_tipo === 'Caja') {
          const caja = cajas.find(c => c.id === data.origen_id);
          origenNombre = caja?.nombre || '';
          // Actualizar saldo de caja origen
          if (caja) {
            await base44.entities.Caja.update(data.origen_id, {
              saldo: (caja.saldo || 0) - data.monto
            });
          }
        } else if (data.origen_tipo === 'Banco') {
          const banco = bancos.find(b => b.id === data.origen_id);
          origenNombre = banco?.nombre || '';
          // Actualizar saldo de banco origen
          if (banco) {
            await base44.entities.Banco.update(data.origen_id, {
              saldo: (banco.saldo || 0) - data.monto
            });
          }
        }
      }

      if (data.destino_id) {
        if (data.destino_tipo === 'Caja') {
          const caja = cajas.find(c => c.id === data.destino_id);
          destinoNombre = caja?.nombre || '';
          // Actualizar saldo de caja destino
          if (caja) {
            await base44.entities.Caja.update(data.destino_id, {
              saldo: (caja.saldo || 0) + data.monto
            });
          }
        } else if (data.destino_tipo === 'Banco') {
          const banco = bancos.find(b => b.id === data.destino_id);
          destinoNombre = banco?.nombre || '';
          // Actualizar saldo de banco destino
          if (banco) {
            await base44.entities.Banco.update(data.destino_id, {
              saldo: (banco.saldo || 0) + data.monto
            });
          }
        }
      }

      // Crear movimiento de tesorer√≠a
      return base44.entities.MovimientoTesoreria.create({
        ...data,
        origen_nombre: origenNombre,
        destino_nombre: destinoNombre,
        fecha: new Date(data.fecha).toISOString()
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
      queryClient.invalidateQueries({ queryKey: ['cajas'] });
      queryClient.invalidateQueries({ queryKey: ['bancos'] });
      toast.success('Movimiento registrado exitosamente');
      closeModal();
    },
    onError: () => toast.error('Error al registrar movimiento')
  });

  const openModal = () => {
    setFormData({
      fecha: format(new Date(), 'yyyy-MM-dd'),
      tipo_movimiento: 'Transferencia Interna',
      origen_tipo: 'Caja',
      origen_id: '',
      destino_tipo: 'Banco',
      destino_id: '',
      monto: 0,
      concepto: '',
      comprobante: ''
    });
    setModalOpen(true);
  };

  const closeModal = () => {
    setModalOpen(false);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    createMutation.mutate(formData);
  };

  const getOrigenOptions = () => {
    return formData.origen_tipo === 'Caja' ? cajas : bancos;
  };

  const getDestinoOptions = () => {
    return formData.destino_tipo === 'Caja' ? cajas : bancos;
  };

  const tipoMovimientoBadge = (tipo) => {
    switch (tipo) {
      case 'Transferencia Interna': return 'bg-blue-100 text-blue-800';
      case 'Ingreso Manual': return 'bg-green-100 text-green-800';
      case 'Egreso Manual': return 'bg-red-100 text-red-800';
      case 'D√©bito Bancario': return 'bg-orange-100 text-orange-800';
      case 'Cr√©dito Bancario': return 'bg-purple-100 text-purple-800';
      default: return 'bg-slate-100 text-slate-800';
    }
  };

  // Totales de la p√°gina actual
  const totalIngresos = movimientos
    .filter(m => ['Ingreso Manual', 'Cr√©dito Bancario'].includes(m.tipo_movimiento))
    .reduce((sum, m) => sum + (m.monto || 0), 0);

  const totalEgresos = movimientos
    .filter(m => ['Egreso Manual', 'D√©bito Bancario'].includes(m.tipo_movimiento))
    .reduce((sum, m) => sum + (m.monto || 0), 0);

  const totalPaginas = Math.ceil(totalMovimientos / ITEMS_POR_PAGINA);

  const handleResetFiltros = () => {
    setFiltroTipo('todos');
    setFiltroOrigen('todos');
    setPagina(1);
  };

  const exportarPDF = async (fechaDesde, fechaHasta) => {
    try {
      const desde = new Date(fechaDesde);
      desde.setHours(0, 0, 0, 0);
      const hasta = new Date(fechaHasta);
      hasta.setHours(23, 59, 59, 999);
      const desdeISO = desde.toISOString();
      const hastaISO = hasta.toISOString();

      // Filtro en servidor por rango de fechas
      const movimientosFiltrados = await base44.entities.MovimientoTesoreria.filter(
        { fecha: { $gte: desdeISO, $lte: hastaISO } },
        '-fecha',
        1000
      );

      if (!movimientosFiltrados?.length) {
        toast.error('No hay movimientos en el rango de fechas seleccionado');
        return;
      }

      // Calcular totales
      const totalIng = movimientosFiltrados
        .filter(m => ['Ingreso Manual', 'Cr√©dito Bancario'].includes(m.tipo_movimiento))
        .reduce((sum, m) => sum + (m.monto || 0), 0);

      const totalEgr = movimientosFiltrados
        .filter(m => ['Egreso Manual', 'D√©bito Bancario'].includes(m.tipo_movimiento))
        .reduce((sum, m) => sum + (m.monto || 0), 0);

      const resultadoNeto = totalIng - totalEgr;

      // Generar HTML del PDF
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Informe de Movimientos de Tesorer√≠a</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              font-size: 10px; 
              padding: 20px;
              color: #1e293b;
            }
            .header { 
              text-align: center; 
              margin-bottom: 20px; 
              border-bottom: 2px solid #0d9488;
              padding-bottom: 15px;
            }
            .title { 
              font-size: 18px; 
              font-weight: bold; 
              color: #0d9488;
              margin-bottom: 8px;
            }
            .subtitle {
              font-size: 11px;
              color: #64748b;
            }
            .info-box {
              background: #f8fafc;
              border: 1px solid #e2e8f0;
              padding: 10px;
              margin-bottom: 20px;
              border-radius: 4px;
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 15px 0;
            }
            th { 
              background: #f1f5f9; 
              font-weight: 600; 
              text-align: left;
              padding: 8px;
              border-bottom: 2px solid #cbd5e1;
              font-size: 9px;
              text-transform: uppercase;
            }
            td { 
              border-bottom: 1px solid #e2e8f0; 
              padding: 6px 8px;
              vertical-align: top;
            }
            .monto { 
              text-align: right; 
              font-weight: 600;
            }
            .totales { 
              background: #f8fafc; 
              font-weight: bold;
              margin-top: 20px;
              padding: 15px;
              border: 2px solid #0d9488;
              border-radius: 4px;
            }
            .totales table {
              margin: 0;
            }
            .totales td {
              border: none;
              padding: 5px 10px;
            }
            .ingreso { color: #16a34a; }
            .egreso { color: #dc2626; }
            .resultado { 
              color: ${resultadoNeto >= 0 ? '#16a34a' : '#dc2626'};
              font-size: 12px;
            }
            .tipo-badge {
              display: inline-block;
              padding: 2px 6px;
              border-radius: 3px;
              font-size: 8px;
              font-weight: 600;
            }
            .tipo-ingreso { background: #dcfce7; color: #166534; }
            .tipo-egreso { background: #fee2e2; color: #991b1b; }
            .tipo-transferencia { background: #dbeafe; color: #1e40af; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="title">INFORME DE MOVIMIENTOS DE TESORER√çA</div>
            <div class="subtitle">Sistema de Gesti√≥n de Acopio</div>
          </div>
          
          <div class="info-box">
            <strong>Per√≠odo:</strong> ${format(desde, 'dd/MM/yyyy', { locale: es })} al ${format(hasta, 'dd/MM/yyyy', { locale: es })}<br>
            <strong>Fecha de generaci√≥n:</strong> ${format(new Date(), 'dd/MM/yyyy HH:mm', { locale: es })}<br>
            <strong>Total de movimientos:</strong> ${movimientosFiltrados.length}
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 12%">Fecha</th>
                <th style="width: 15%">Tipo</th>
                <th style="width: 28%">Descripci√≥n</th>
                <th style="width: 15%">Origen</th>
                <th style="width: 15%">Cuenta</th>
                <th style="width: 15%">Monto</th>
              </tr>
            </thead>
            <tbody>
              ${movimientosFiltrados.map(mov => {
                let tipoBadgeClass = 'tipo-transferencia';
                if (['Ingreso Manual', 'Cr√©dito Bancario'].includes(mov.tipo_movimiento)) {
                  tipoBadgeClass = 'tipo-ingreso';
                } else if (['Egreso Manual', 'D√©bito Bancario'].includes(mov.tipo_movimiento)) {
                  tipoBadgeClass = 'tipo-egreso';
                }
                
                return `
                  <tr>
                    <td>${format(new Date(mov.fecha), 'dd/MM/yyyy HH:mm', { locale: es })}</td>
                    <td><span class="tipo-badge ${tipoBadgeClass}">${mov.tipo_movimiento}</span></td>
                    <td>${mov.concepto || '-'}</td>
                    <td>${mov.origen_nombre || mov.referencia_origen_tipo || '-'}</td>
                    <td>${mov.destino_nombre || mov.origen_nombre || '-'}</td>
                    <td class="monto">$${(mov.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>

          <div class="totales">
            <table>
              <tr>
                <td><strong>Total Ingresos:</strong></td>
                <td class="monto ingreso">$${totalIng.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>
              </tr>
              <tr>
                <td><strong>Total Egresos:</strong></td>
                <td class="monto egreso">$${totalEgr.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>
              </tr>
              <tr style="border-top: 2px solid #cbd5e1;">
                <td><strong>Resultado Neto:</strong></td>
                <td class="monto resultado">$${resultadoNeto.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</td>
              </tr>
            </table>
          </div>
        </body>
        </html>
      `;

      // Abrir ventana de impresi√≥n
      const ventana = window.open('', '_blank');
      ventana.document.write(html);
      ventana.document.close();
      ventana.onload = () => ventana.print();

    } catch (error) {
      console.error('Error al generar PDF:', error);
      toast.error('Error al generar el PDF');
      throw error;
    }
  };

  const editarFechaMutation = useMutation({
    mutationFn: async ({ movimiento, nuevaFecha, motivo, pin }) => {
      // Validar PIN
      const pinConfig = configuracion.find(c => c.clave === 'pin_seguridad');
      if (!pinConfig || pinConfig.valor !== pin) {
        throw new Error('PIN incorrecto. No se puede realizar el cambio.');
      }

      // Obtener usuario actual
      const user = await base44.auth.me();

      // Crear registro de auditor√≠a
      await base44.entities.AuditoriaMovimientoTesoreria.create({
        movimiento_tesoreria_id: movimiento.id,
        fecha_original: movimiento.fecha,
        fecha_nueva: new Date(nuevaFecha).toISOString(),
        usuario_email: user.email,
        fecha_cambio: new Date().toISOString(),
        motivo: motivo || 'Sin motivo especificado'
      });

      // Actualizar solo la fecha del movimiento
      await base44.entities.MovimientoTesoreria.update(movimiento.id, {
        fecha: new Date(nuevaFecha).toISOString()
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
      queryClient.invalidateQueries({ queryKey: ['movimientostesoreria-count'] });
      toast.success('Fecha actualizada correctamente', {
        description: 'El cambio ha sido registrado en auditor√≠a'
      });
      setEditarFechaModal({ open: false, movimiento: null });
    },
    onError: (error) => {
      console.error('Error al editar fecha:', error);
      throw error;
    }
  });

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6 flex-wrap gap-4">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <ArrowLeftRight className="h-8 w-8 text-teal-600" />
              Movimientos de Tesorer√≠a
            </h1>
            <p className="text-slate-500 mt-1">Transferencias y movimientos internos</p>
          </div>
          <div className="flex gap-2">
            <Button 
              onClick={() => setExportModalOpen(true)} 
              variant="outline"
              className="border-teal-600 text-teal-600 hover:bg-teal-50"
            >
              <FileDown className="h-4 w-4 mr-2" />
              Excel
            </Button>
            <Button 
              onClick={() => setPdfModalOpen(true)} 
              variant="outline"
              className="border-teal-600 text-teal-600 hover:bg-teal-50"
            >
              <FileText className="h-4 w-4 mr-2" />
              PDF
            </Button>
            <Button onClick={openModal} className="bg-teal-600 hover:bg-teal-700">
              <Plus className="h-4 w-4 mr-2" />
              Nuevo Movimiento
            </Button>
          </div>
        </div>

        {/* Filtros */}
        <Card className="mb-6">
          <CardContent className="p-4">
            <div className="flex items-center gap-4 flex-wrap">
              <div className="flex items-center gap-2">
                <Filter className="h-4 w-4 text-slate-500" />
                <span className="text-sm font-medium text-slate-700">Filtros:</span>
              </div>
              
              <div className="flex-1 min-w-[200px]">
                <Select value={filtroTipo} onValueChange={(v) => { setFiltroTipo(v); setPagina(1); }}>
                  <SelectTrigger className="h-9">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos los tipos</SelectItem>
                    <SelectItem value="ingresos">Solo Ingresos</SelectItem>
                    <SelectItem value="egresos">Solo Egresos</SelectItem>
                    <SelectItem value="transferencias">Solo Transferencias</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="flex-1 min-w-[200px]">
                <Select value={filtroOrigen} onValueChange={(v) => { setFiltroOrigen(v); setPagina(1); }}>
                  <SelectTrigger className="h-9">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="todos">Todos los or√≠genes</SelectItem>
                    <SelectItem value="cobros">Desde Cobros</SelectItem>
                    <SelectItem value="pagos">Desde Pagos</SelectItem>
                    <SelectItem value="ingresos_varios">Desde Ingresos Varios</SelectItem>
                    <SelectItem value="egresos_varios">Desde Egresos</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {(filtroTipo !== 'todos' || filtroOrigen !== 'todos') && (
                <Button 
                  variant="ghost" 
                  size="sm"
                  onClick={handleResetFiltros}
                  className="text-slate-600"
                >
                  Limpiar filtros
                </Button>
              )}
            </div>
          </CardContent>
        </Card>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Movimientos</p>
                  <p className="text-2xl font-bold text-teal-600">{movimientos.length}</p>
                </div>
                <ArrowLeftRight className="h-10 w-10 text-teal-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Ingresos</p>
                  <p className="text-2xl font-bold text-green-600">
                    ${totalIngresos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <TrendingUp className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Egresos</p>
                  <p className="text-2xl font-bold text-red-600">
                    ${totalEgresos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <TrendingDown className="h-10 w-10 text-red-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Movimientos */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-teal-600" />
          </div>
        ) : movimientos.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <ArrowLeftRight className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">
                {filtroTipo !== 'todos' || filtroOrigen !== 'todos' 
                  ? 'No hay movimientos que coincidan con los filtros'
                  : 'No hay movimientos registrados'}
              </p>
            </CardContent>
          </Card>
        ) : (
          <>
            <div className="space-y-3">
              {movimientos.map(mov => (
              <Card key={mov.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between">
                    <div className="flex-1 space-y-3">
                      <div className="flex items-center gap-3">
                        <Calendar className="h-5 w-5 text-slate-400" />
                        <span className="font-medium">
                          {mov.fecha ? format(new Date(mov.fecha), "dd/MM/yyyy HH:mm", { locale: es }) : '-'}
                        </span>
                        <Badge className={tipoMovimientoBadge(mov.tipo_movimiento)}>
                          {mov.tipo_movimiento}
                        </Badge>
                      </div>

                      <p className="text-slate-700">{mov.concepto}</p>

                      <div className="flex items-center gap-4 text-sm">
                        {mov.origen_nombre && (
                          <div>
                            <span className="text-slate-500">Origen: </span>
                            <span className="font-medium">{mov.origen_nombre} ({mov.origen_tipo})</span>
                          </div>
                        )}
                        {mov.origen_nombre && mov.destino_nombre && (
                          <ArrowLeftRight className="h-4 w-4 text-slate-400" />
                        )}
                        {mov.destino_nombre && (
                          <div>
                            <span className="text-slate-500">Destino: </span>
                            <span className="font-medium">{mov.destino_nombre} ({mov.destino_tipo})</span>
                          </div>
                        )}
                      </div>

                      {mov.comprobante && (
                        <div className="text-xs text-slate-500">
                          Comprobante: {mov.comprobante}
                        </div>
                      )}
                    </div>

                    <div className="flex items-center gap-3 ml-6">
                      <div className="text-right">
                        <p className="text-2xl font-bold text-teal-600">
                          ${(mov.monto || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                        </p>
                      </div>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setEditarFechaModal({ open: true, movimiento: mov })}
                        className="text-teal-600 hover:text-teal-700 hover:bg-teal-50"
                        title="Editar fecha"
                      >
                        <Edit className="h-5 w-5" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => setDeleteDialog({ open: true, movimiento: mov })}
                        className="text-red-600 hover:text-red-700 hover:bg-red-50"
                        title="Eliminar"
                      >
                        <Trash2 className="h-5 w-5" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
            </div>

            {/* Paginaci√≥n */}
            {totalPaginas > 1 && (
              <Card className="mt-4">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div className="text-sm text-slate-600">
                      P√°gina {pagina} de {totalPaginas} ‚Ä¢ {totalMovimientos} movimientos totales
                    </div>
                    <div className="flex items-center gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setPagina(p => Math.max(1, p - 1))}
                        disabled={pagina === 1}
                      >
                        <ChevronLeft className="h-4 w-4" />
                        Anterior
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setPagina(p => Math.min(totalPaginas, p + 1))}
                        disabled={pagina === totalPaginas}
                      >
                        Siguiente
                        <ChevronRight className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}
          </>
        )}

        {/* Alert Dialog para eliminar */}
        <AlertDialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open, movimiento: deleteDialog.movimiento })}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>¬øEliminar este movimiento?</AlertDialogTitle>
              <AlertDialogDescription className="space-y-2">
                <p>Esta acci√≥n revertir√° autom√°ticamente los saldos afectados:</p>
                {deleteDialog.movimiento && (
                  <div className="bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                    <p className="font-semibold text-amber-900 mb-2">{deleteDialog.movimiento.tipo_movimiento}</p>
                    <p className="text-slate-700">Concepto: {deleteDialog.movimiento.concepto}</p>
                    <p className="text-slate-700">Monto: <strong>${(deleteDialog.movimiento.monto || 0).toLocaleString('es-AR')}</strong></p>
                    {deleteDialog.movimiento.origen_nombre && (
                      <p className="text-slate-700">Origen: {deleteDialog.movimiento.origen_nombre}</p>
                    )}
                    {deleteDialog.movimiento.destino_nombre && (
                      <p className="text-slate-700">Destino: {deleteDialog.movimiento.destino_nombre}</p>
                    )}
                  </div>
                )}
                <p className="text-xs text-slate-500 mt-2">Esta acci√≥n no se puede deshacer.</p>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel disabled={deleteMutation.isPending}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={() => deleteDialog.movimiento && deleteMutation.mutate(deleteDialog.movimiento)}
                disabled={deleteMutation.isPending}
                className="bg-red-600 hover:bg-red-700"
              >
                {deleteMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Eliminando...
                  </>
                ) : (
                  'S√≠, Eliminar y Revertir'
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Modal */}
        <Dialog open={modalOpen} onOpenChange={setModalOpen}>
          <DialogContent className="max-w-2xl">
            <DialogHeader>
              <DialogTitle>Nuevo Movimiento de Tesorer√≠a</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit}>
              <div className="space-y-4 py-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>Fecha *</Label>
                    <Input
                      type="date"
                      value={formData.fecha}
                      onChange={(e) => setFormData({ ...formData, fecha: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label>Tipo de Movimiento *</Label>
                    <select
                      value={formData.tipo_movimiento}
                      onChange={(e) => setFormData({ ...formData, tipo_movimiento: e.target.value })}
                      className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                    >
                      <option value="Transferencia Interna">Transferencia Interna</option>
                      <option value="Ingreso Manual">Ingreso Manual</option>
                      <option value="Egreso Manual">Egreso Manual</option>
                      <option value="D√©bito Bancario">D√©bito Bancario</option>
                      <option value="Cr√©dito Bancario">Cr√©dito Bancario</option>
                    </select>
                  </div>
                </div>

                {formData.tipo_movimiento === 'Transferencia Interna' && (
                  <>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <Label>Tipo Origen *</Label>
                        <select
                          value={formData.origen_tipo}
                          onChange={(e) => setFormData({ ...formData, origen_tipo: e.target.value, origen_id: '' })}
                          className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                        >
                          <option value="Caja">Caja</option>
                          <option value="Banco">Banco</option>
                        </select>
                      </div>
                      <div>
                        <Label>Origen *</Label>
                        <SearchableSelect
                          options={getOrigenOptions()}
                          value={formData.origen_id}
                          onChange={(id) => setFormData({ ...formData, origen_id: id })}
                          displayKey="nombre"
                          placeholder="Seleccionar origen..."
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <Label>Tipo Destino *</Label>
                        <select
                          value={formData.destino_tipo}
                          onChange={(e) => setFormData({ ...formData, destino_tipo: e.target.value, destino_id: '' })}
                          className="flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm"
                        >
                          <option value="Caja">Caja</option>
                          <option value="Banco">Banco</option>
                        </select>
                      </div>
                      <div>
                        <Label>Destino *</Label>
                        <SearchableSelect
                          options={getDestinoOptions()}
                          value={formData.destino_id}
                          onChange={(id) => setFormData({ ...formData, destino_id: id })}
                          displayKey="nombre"
                          placeholder="Seleccionar destino..."
                        />
                      </div>
                    </div>
                  </>
                )}

                <div>
                  <Label>Monto *</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={formData.monto}
                    onChange={(e) => setFormData({ ...formData, monto: parseFloat(e.target.value) || 0 })}
                    required
                  />
                </div>

                <div>
                  <Label>Concepto *</Label>
                  <Input
                    value={formData.concepto}
                    onChange={(e) => setFormData({ ...formData, concepto: e.target.value })}
                    placeholder="Descripci√≥n del movimiento"
                    required
                  />
                </div>

                <div>
                  <Label>Comprobante</Label>
                  <Input
                    value={formData.comprobante}
                    onChange={(e) => setFormData({ ...formData, comprobante: e.target.value })}
                    placeholder="N√∫mero de comprobante"
                  />
                </div>
              </div>
              <DialogFooter>
                <Button type="button" variant="outline" onClick={closeModal}>
                  Cancelar
                </Button>
                <Button
                  type="submit"
                  disabled={createMutation.isPending}
                  className="bg-teal-600 hover:bg-teal-700"
                >
                  {createMutation.isPending && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
                  Registrar Movimiento
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>

        {/* Modales de Exportaci√≥n */}
        <ExportarMovimientosModal
          open={exportModalOpen}
          onClose={() => setExportModalOpen(false)}
          movimientos={movimientos}
        />
        
        <ExportarMovimientosPDFModal
          open={pdfModalOpen}
          onClose={() => setPdfModalOpen(false)}
          onExportar={exportarPDF}
        />

        <EditarFechaMovimientoModal
          open={editarFechaModal.open}
          onClose={() => setEditarFechaModal({ open: false, movimiento: null })}
          movimiento={editarFechaModal.movimiento}
          onGuardar={(datos) => editarFechaMutation.mutateAsync(datos)}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Pagos.jsx">
import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient, useInfiniteQuery } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { HandCoins, Plus, Loader2, Calendar, Building2, DollarSign, FileText, Trash2, Search, ChevronLeft, ChevronRight, FileCheck, Download } from 'lucide-react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { toast } from 'sonner';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import PagoConIngresosModal from '@/components/tesoreria/PagoConIngresosModal';
import ImputarPagoModal from '@/components/tesoreria/ImputarPagoModal';
import { generarOrdenDePagoPDF } from '@/components/tesoreria/OrdenDePagoPDF';
import { escapeRegex } from '@/lib/utils';
import { invalidarTodoElSistema } from '@/utils/queryHelpers';
import { recalcularSaldosEntidad, actualizarSaldoEntidad } from '@/utils/contabilidad';

export default function Pagos() {
  const queryClient = useQueryClient();
  const [modalPagoOpen, setModalPagoOpen] = useState(false);
  const [deleteDialog, setDeleteDialog] = useState({ open: false, pago: null });
  const [imputarDialog, setImputarDialog] = useState({ open: false, pago: null });
  const [filtroProveedor, setFiltroProveedor] = useState('');
  const [paginaActual, setPaginaActual] = useState(1);
  const registrosPorPagina = 20;

  const PAGE_SIZE = 20;

  const queryPagos = React.useMemo(() => {
    const trimmed = filtroProveedor?.trim();
    if (!trimmed) return {};
    return { proveedor_nombre: { $regex: escapeRegex(trimmed), $options: 'i' } };
  }, [filtroProveedor]);

  const {
    data: pagosData,
    fetchNextPage: fetchMorePagos,
    hasNextPage: hasMorePagos,
    isFetchingNextPage: loadingMorePagos,
    isLoading
  } = useInfiniteQuery({
    queryKey: ['pagos-infinite', filtroProveedor],
    queryFn: ({ pageParam = 0 }) => {
      if (Object.keys(queryPagos).length === 0) {
        return base44.entities.Pago.list('-fecha', PAGE_SIZE, pageParam);
      }
      return base44.entities.Pago.filter(queryPagos, '-fecha', PAGE_SIZE, pageParam);
    },
    getNextPageParam: (lastPage, allPages) =>
      (lastPage?.length ?? 0) === PAGE_SIZE ? allPages.length * PAGE_SIZE : undefined,
    initialPageParam: 0,
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const pagos = React.useMemo(() => pagosData?.pages?.flat() ?? [], [pagosData]);

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cajas = [] } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list('nombre', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancos = [] } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list('nombre', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cheques = [] } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_pago', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria'],
    queryFn: () => base44.entities.MovimientoTesoreria.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const deletePagoMutation = useMutation({
    mutationFn: async (pago) => {
      // Buscar TODOS los MovimientoTesoreria vinculados a este pago
      const movimientosVinculados = movimientosTesoreria.filter(m => 
        m.referencia_origen_id === pago.id && m.referencia_origen_tipo === 'Pago'
      );

      // Revertir saldos de todos los medios de pago
      for (const mov of movimientosVinculados) {
        if (mov.origen_id && mov.origen_tipo) {
          if (mov.origen_tipo === 'Caja') {
            const caja = cajas.find(c => c.id === mov.origen_id);
            if (caja) {
              await base44.entities.Caja.update(mov.origen_id, {
                saldo: (caja.saldo || 0) + mov.monto
              });
            }
          } else if (mov.origen_tipo === 'Banco') {
            const banco = bancos.find(b => b.id === mov.origen_id);
            if (banco) {
              await base44.entities.Banco.update(mov.origen_id, {
                saldo: (banco.saldo || 0) + mov.monto
              });
            }
          }
        }
      }

      // Revertir estados de ingresos aplicados
      if (pago.ingresos_aplicados && pago.ingresos_aplicados.length > 0) {
        for (const aplicado of pago.ingresos_aplicados) {
          const movimientoIngreso = movimientos.find(m => m.id === aplicado.movimiento_id);
          if (movimientoIngreso) {
            const nuevoMontoPagado = (movimientoIngreso.monto_pagado || 0) - aplicado.monto_aplicado;
            let nuevoEstado = 'Pendiente';
            if (nuevoMontoPagado >= (movimientoIngreso.deuda_total || 0)) {
              nuevoEstado = 'Pagado';
            } else if (nuevoMontoPagado > 0) {
              nuevoEstado = 'Pago Parcial';
            }
            await base44.entities.Movimiento.update(aplicado.movimiento_id, {
              monto_pagado: nuevoMontoPagado,
              estado_pago: nuevoEstado
            });
          }
        }
      }

      // Eliminar movimientos de cuenta corriente relacionados (revertir saldo_actual antes)
      const movimientosCC = await base44.entities.CuentaCorriente.list();
      const movsCCPago = movimientosCC.filter(m => 
        m.comprobante_id === pago.id && m.comprobante_tipo === 'Pago'
      );
      for (const movCC of movsCCPago) {
        await actualizarSaldoEntidad(base44, 'Proveedor', pago.proveedor_id, movCC.monto || 0);
        await base44.entities.CuentaCorriente.delete(movCC.id);
      }

      // Recalcular saldos resultantes en filas de CC del proveedor
      await recalcularSaldosEntidad(base44, pago.proveedor_id, 'Proveedor');

      // Eliminar Egreso del Estado de Resultados si existe
      const egresosVarios = await base44.entities.Egreso.list();
      const egresosRelacionados = egresosVarios.filter(eg => 
        eg.notas && eg.notas.includes(`ID: ${pago.id}`)
      );
      for (const egreso of egresosRelacionados) {
        await base44.entities.Egreso.delete(egreso.id);
      }

      // Eliminar todos los movimientos de tesorer√≠a vinculados
      for (const mov of movimientosVinculados) {
        await base44.entities.MovimientoTesoreria.delete(mov.id);
      }

      // Eliminar el pago
      await base44.entities.Pago.delete(pago.id);
      
      return pago;
    },
    onSuccess: () => {
      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);
      
      toast.success('Pago eliminado completamente');
      setDeleteDialog({ open: false, pago: null });
    },
    onError: (error) => {
      console.error('Error al eliminar pago:', error);
      toast.error('Error al eliminar el pago');
    }
  });

  const guardarPagoMutation = useMutation({
    mutationFn: async (pagoData) => {
      // Obtener proveedor
      const proveedor = proveedores.find(p => p.id === pagoData.proveedor_id);
      if (!proveedor) throw new Error('Proveedor no encontrado');

      // Preparar medios de pago detallados
      let mediosPago = [];
      
      if (pagoData._mediosMixtos && pagoData._mediosMixtos.length > 0) {
        mediosPago = pagoData._mediosMixtos;
      } else if (pagoData._chequesSeleccionados && pagoData._chequesSeleccionados.length > 0) {
        // Procesar cheques: crear nuevos si es necesario
        for (const ch of pagoData._chequesSeleccionados) {
          if (ch.tipo === 'nuevo') {
            const nuevoCheque = await base44.entities.Cheque.create({
              numero_cheque: ch.numero_cheque,
              tipo: 'Propio',
              banco_id: ch.banco_id,
              banco_nombre: ch.banco_nombre,
              fecha_emision: ch.fecha_emision || format(new Date(), 'yyyy-MM-dd'),
              fecha_pago: ch.fecha_pago || format(new Date(), 'yyyy-MM-dd'),
              monto: ch.monto,
              beneficiario: ch.beneficiario || proveedor.nombre,
              emisor: 'Empresa',
              estado: 'Entregado'
            });
            
            mediosPago.push({
              tipo: 'Cheque',
              origen_tipo: 'Cheque',
              origen_id: null,
              origen_nombre: 'Cheque',
              cheque_id: nuevoCheque.id,
              monto: ch.monto
            });
          } else if (ch.tipo === 'existente') {
            const chequeData = cheques.find(c => c.id === ch.cheque_id);
            mediosPago.push({
              tipo: 'Cheque',
              origen_tipo: 'Cheque',
              origen_id: null,
              origen_nombre: 'Cheque',
              cheque_id: ch.cheque_id,
              monto: chequeData?.monto || 0
            });
          }
        }
      } else {
        // Efectivo o Transferencia simple
        const origen = pagoData.origen_tipo === 'Banco' 
          ? bancos.find(b => b.id === pagoData.origen_id)
          : cajas.find(c => c.id === pagoData.origen_id);
        
        mediosPago.push({
          tipo: pagoData.forma_pago,
          origen_tipo: pagoData.origen_tipo,
          origen_id: pagoData.origen_id,
          origen_nombre: origen?.nombre || '',
          monto: pagoData.monto_total
        });
      }

      // 1. Crear el pago con medios detallados
      const pago = await base44.entities.Pago.create({
        fecha: pagoData.fecha,
        tipo_pago: pagoData.tipo_pago,
        proveedor_id: pagoData.proveedor_id,
        proveedor_nombre: proveedor.nombre,
        monto_total: pagoData.monto_total,
        concepto: pagoData.concepto,
        comprobante: pagoData.comprobante,
        notas: pagoData.notas,
        medios_pago_detalles: mediosPago,
        ingresos_aplicados: pagoData.ingresos_aplicados || [],
        monto_disponible: pagoData.monto_disponible || 0
      });

      // 1.5. Registrar en Egresos para Estado de Resultados
      if (pagoData.cuenta_contable_id) {
        await base44.entities.Egreso.create({
          fecha: pagoData.fecha,
          tipo: 'Costo',
          clasificacion: 'Variable',
          cuenta_id: pagoData.cuenta_contable_id,
          cuenta_codigo: pagoData.cuenta_contable_codigo || '',
          cuenta_nombre: pagoData.cuenta_contable_nombre,
          concepto: pagoData.concepto || `Pago a ${proveedor.nombre}`,
          monto: pagoData.monto_total,
          forma_pago: 'Transferencia',
          origen_tipo: 'Banco',
          origen_id: '',
          origen_nombre: '',
          proveedor_id: pagoData.proveedor_id,
          proveedor_nombre: proveedor.nombre,
          comprobante: pagoData.comprobante || '',
          notas: `Pago registrado autom√°ticamente desde tesorer√≠a - ID: ${pago.id}`
        });
      }

      // 2. Procesar medios de pago: actualizar saldos y crear movimientos de tesorer√≠a
      for (const medio of mediosPago) {
        if (medio.origen_tipo === 'Caja' && medio.origen_id) {
          const caja = cajas.find(c => c.id === medio.origen_id);
          if (caja) {
            await base44.entities.Caja.update(medio.origen_id, {
              saldo: (caja.saldo || 0) - medio.monto
            });
          }
        } else if (medio.origen_tipo === 'Banco' && medio.origen_id) {
          const banco = bancos.find(b => b.id === medio.origen_id);
          if (banco) {
            await base44.entities.Banco.update(medio.origen_id, {
              saldo: (banco.saldo || 0) - medio.monto
            });
          }
        }

        // Crear movimiento de tesorer√≠a
        await base44.entities.MovimientoTesoreria.create({
          fecha: pagoData.fecha,
          tipo_movimiento: 'Egreso Manual',
          origen_tipo: medio.origen_tipo,
          origen_id: medio.origen_id,
          origen_nombre: medio.origen_nombre,
          monto: medio.monto,
          concepto: `Pago a ${proveedor.nombre} - ${pagoData.concepto}`,
          comprobante: pagoData.comprobante,
          referencia_origen_id: pago.id,
          referencia_origen_tipo: 'Pago'
        });

        // Si es cheque propio, actualizar estado
        if (medio.tipo === 'Cheque' && medio.cheque_id) {
          await base44.entities.Cheque.update(medio.cheque_id, {
            estado: 'Entregado',
            origen_movimiento_id: pago.id,
            origen_movimiento_tipo: 'Pago'
          });
        }
      }

      // 3. Actualizar movimientos aplicados y crear movimientos en cuenta corriente
      if (pagoData.tipo_pago === 'Aplicado' && pagoData.ingresos_aplicados) {
        for (const aplicado of pagoData.ingresos_aplicados) {
          const movimiento = movimientos.find(m => m.id === aplicado.movimiento_id);
          if (movimiento) {
            const nuevoMontoPagado = (movimiento.monto_pagado || 0) + aplicado.monto_aplicado;
            const deudaTotal = movimiento.deuda_total || 0;
            
            let nuevoEstado = 'Pendiente';
            if (nuevoMontoPagado >= deudaTotal) {
              nuevoEstado = 'Pagado';
            } else if (nuevoMontoPagado > 0) {
              nuevoEstado = 'Pago Parcial';
            }

            await base44.entities.Movimiento.update(aplicado.movimiento_id, {
              monto_pagado: nuevoMontoPagado,
              estado_pago: nuevoEstado
            });

            // Crear movimiento en cuenta corriente (Debe = disminuye deuda)
            await base44.entities.CuentaCorriente.create({
              fecha: pagoData.fecha,
              tipo_movimiento: 'Debe',
              entidad_tipo: 'Proveedor',
              entidad_id: pagoData.proveedor_id,
              entidad_nombre: proveedor.nombre,
              monto: aplicado.monto_aplicado,
              saldo_resultante: 0,
              concepto: `Pago aplicado a ingreso de fruta`,
              comprobante_id: pago.id,
              comprobante_tipo: 'Pago'
            });
            await actualizarSaldoEntidad(base44, 'Proveedor', pagoData.proveedor_id, -aplicado.monto_aplicado);
          }
        }

        // Recalcular saldos resultantes en filas de CC
        await recalcularSaldosEntidad(base44, pagoData.proveedor_id, 'Proveedor');
      } else if (pagoData.tipo_pago === 'A Cuenta') {
        // Crear movimiento en cuenta corriente para pago a cuenta
        await base44.entities.CuentaCorriente.create({
          fecha: pagoData.fecha,
          tipo_movimiento: 'Debe',
          entidad_tipo: 'Proveedor',
          entidad_id: pagoData.proveedor_id,
          entidad_nombre: proveedor.nombre,
          monto: pagoData.monto_total,
          saldo_resultante: 0,
          concepto: `Pago a cuenta - ${pagoData.concepto}`,
          comprobante_id: pago.id,
          comprobante_tipo: 'Pago'
        });
        await actualizarSaldoEntidad(base44, 'Proveedor', pagoData.proveedor_id, -pagoData.monto_total);

        // Recalcular saldos resultantes en filas de CC
        await recalcularSaldosEntidad(base44, pagoData.proveedor_id, 'Proveedor');
      }

      return pago;
    },
    onSuccess: async (pago) => {
      // Recalcular saldos de cuenta corriente del proveedor (ya se hizo en mutationFn, pero por seguridad)
      if (pago.proveedor_id) {
        await recalcularSaldosEntidad(base44, pago.proveedor_id, 'Proveedor');
      }
      
      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);
      
      toast.success('Pago registrado exitosamente');
      setModalPagoOpen(false);
    },
    onError: (error) => {
      console.error('Error al guardar pago:', error);
      toast.error('Error al registrar el pago');
    }
  });

  const imputarPagoMutation = useMutation({
    mutationFn: async ({ pago, imputaciones }) => {
      // Actualizar cada movimiento aplicado
      for (const imputacion of imputaciones) {
        const movimiento = movimientos.find(m => m.id === imputacion.movimiento_id);
        if (movimiento) {
          const nuevoMontoPagado = (movimiento.monto_pagado || 0) + imputacion.monto;
          const deudaTotal = movimiento.deuda_total || 0;
          
          let nuevoEstado = 'Pendiente';
          if (nuevoMontoPagado >= deudaTotal) {
            nuevoEstado = 'Pagado';
          } else if (nuevoMontoPagado > 0) {
            nuevoEstado = 'Pago Parcial';
          }

          await base44.entities.Movimiento.update(imputacion.movimiento_id, {
            monto_pagado: nuevoMontoPagado,
            estado_pago: nuevoEstado
          });

          // Crear movimiento en cuenta corriente
          await base44.entities.CuentaCorriente.create({
            fecha: pago.fecha,
            tipo_movimiento: 'Debe',
            entidad_tipo: 'Proveedor',
            entidad_id: pago.proveedor_id,
            entidad_nombre: pago.proveedor_nombre,
            monto: imputacion.monto,
            saldo_resultante: 0,
            concepto: `Pago imputado a ingreso de fruta`,
            comprobante_id: pago.id,
            comprobante_tipo: 'Pago'
          });
          await actualizarSaldoEntidad(base44, 'Proveedor', pago.proveedor_id, -imputacion.monto);
        }
      }

      // Actualizar el pago
      const ingresosPrevios = pago.ingresos_aplicados || [];
      const nuevoMontoDisponible = (pago.monto_disponible || 0) - imputaciones.reduce((sum, i) => sum + i.monto, 0);
      
      // Normalizar imputaciones para que tengan ambos campos (compatibilidad PDF)
      const imputacionesNormalizadas = imputaciones.map(imp => ({
        movimiento_id: imp.movimiento_id,
        monto: imp.monto,
        monto_aplicado: imp.monto  // Para compatibilidad
      }));
      
      await base44.entities.Pago.update(pago.id, {
        ingresos_aplicados: [...ingresosPrevios, ...imputacionesNormalizadas],
        monto_disponible: nuevoMontoDisponible,
        tipo_pago: nuevoMontoDisponible > 0 ? 'A Cuenta' : 'Aplicado'
      });

      // Recalcular saldos de cuenta corriente
      const todosMovCC = await base44.entities.CuentaCorriente.list();
      const movsCCProveedor = todosMovCC
        .filter(m => m.entidad_id === pago.proveedor_id && m.entidad_tipo === 'Proveedor')
        .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

      let saldoAcumulado = 0;
      for (const m of movsCCProveedor) {
        if (m.tipo_movimiento === 'Haber') {
          saldoAcumulado += m.monto;
        } else {
          saldoAcumulado -= m.monto;
        }
        await base44.entities.CuentaCorriente.update(m.id, {
          saldo_resultante: saldoAcumulado
        });
      }
    },
    onSuccess: async (_, variables) => {
      // Recalcular saldos de cuenta corriente del proveedor
      if (variables.pago?.proveedor_id) {
        await recalcularSaldosEntidad(base44, variables.pago.proveedor_id, 'Proveedor');
      }
      
      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);
      
      toast.success('Pago imputado exitosamente');
      setImputarDialog({ open: false, pago: null });
    },
    onError: (error) => {
      console.error('Error al imputar pago:', error);
      toast.error('Error al imputar el pago');
    }
  });

  const handleDescargarOrdenPago = (pago) => {
    const proveedor = proveedores.find(p => p.id === pago.proveedor_id);
    if (!proveedor) {
      toast.error('Proveedor no encontrado');
      return;
    }
    generarOrdenDePagoPDF(pago, proveedor);
    toast.success('Orden de pago descargada');
  };

  // Filtrar pagos que tienen movimientos de tesorer√≠a vinculados y por nombre de proveedor
  const pagosValidos = pagos.filter(pago => {
    const tieneMovimientos = movimientosTesoreria.some(m => 
      m.referencia_origen_id === pago.id && m.referencia_origen_tipo === 'Pago'
    );
    const cumpleFiltro = !filtroProveedor || 
      (pago.proveedor_nombre && pago.proveedor_nombre.toLowerCase().includes(filtroProveedor.toLowerCase()));
    return tieneMovimientos && cumpleFiltro;
  });

  const totalPagos = pagosValidos.reduce((sum, p) => sum + (p.monto_total || 0), 0);
  const pagosAplicados = pagosValidos.filter(p => p.tipo_pago === 'Aplicado').length;
  const pagosACuenta = pagosValidos.filter(p => p.tipo_pago === 'A Cuenta').length;

  // Paginaci√≥n
  const totalPaginas = Math.ceil(pagosValidos.length / registrosPorPagina);
  const pagosPaginados = pagosValidos.slice(
    (paginaActual - 1) * registrosPorPagina,
    paginaActual * registrosPorPagina
  );

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
              <HandCoins className="h-8 w-8 text-orange-600" />
              Pagos a Proveedores
            </h1>
            <p className="text-slate-500 mt-1">Registra y gestiona pagos</p>
          </div>
          <Button onClick={() => setModalPagoOpen(true)} className="bg-orange-600 hover:bg-orange-700">
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Pago
          </Button>
        </div>

        {/* Filtro */}
        <div className="mb-6">
          <div className="relative max-w-md">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400" />
            <Input
              type="text"
              placeholder="Buscar por nombre de proveedor..."
              value={filtroProveedor}
              onChange={(e) => setFiltroProveedor(e.target.value)}
              className="pl-10"
            />
          </div>
        </div>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Pagado</p>
                  <p className="text-2xl font-bold text-orange-600">
                    ${(totalPagos || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <DollarSign className="h-10 w-10 text-orange-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Total Pagos</p>
                  <p className="text-2xl font-bold text-slate-600">{pagosValidos.length}</p>
                </div>
                <FileText className="h-10 w-10 text-slate-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Pagos Aplicados</p>
                  <p className="text-2xl font-bold text-green-600">{pagosAplicados}</p>
                </div>
                <FileText className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">A Cuenta</p>
                  <p className="text-2xl font-bold text-blue-600">{pagosACuenta}</p>
                </div>
                <FileText className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Lista de Pagos */}
        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin text-orange-600" />
          </div>
        ) : pagosValidos.length === 0 ? (
          <Card>
            <CardContent className="p-12 text-center">
              <HandCoins className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-500">No hay pagos registrados</p>
            </CardContent>
          </Card>
        ) : (
          <>
            <div className="space-y-2">
              {pagosPaginados.map(pago => (
                <Card key={pago.id} className="hover:shadow-sm transition-shadow border-l-4 border-l-orange-500">
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4 flex-1">
                        <div className="text-sm text-slate-500 min-w-[90px]">
                          {pago.fecha ? format(new Date(pago.fecha), "dd/MM/yyyy", { locale: es }) : '-'}
                        </div>
                        
                        <Badge variant="outline" className={pago.tipo_pago === 'Aplicado' ? 'text-green-700 border-green-300' : 'text-blue-700 border-blue-300'}>
                          {pago.tipo_pago}
                        </Badge>

                        <div className="flex-1">
                          <div className="font-semibold text-slate-900">{pago.proveedor_nombre}</div>
                          <div className="text-sm text-slate-600">{pago.concepto}</div>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        <div className="text-right">
                          <div className="text-xl font-bold text-orange-600">
                            ${(pago.monto_total || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                          </div>
                          {pago.tipo_pago === 'A Cuenta' && pago.monto_disponible > 0 && (
                            <div className="text-xs text-blue-600">
                              Disp: ${(pago.monto_disponible || 0).toLocaleString('es-AR')}
                            </div>
                          )}
                        </div>
                        
                        {pago.tipo_pago === 'A Cuenta' && pago.monto_disponible > 0 && (
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setImputarDialog({ open: true, pago })}
                            className="text-blue-600 hover:text-blue-700"
                            title="Imputar a comprobantes"
                          >
                            <FileCheck className="h-4 w-4" />
                          </Button>
                        )}
                        
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDescargarOrdenPago(pago)}
                          className="text-green-600 hover:text-green-700"
                          title="Descargar Orden de Pago"
                        >
                          <Download className="h-4 w-4" />
                        </Button>
                        
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => setDeleteDialog({ open: true, pago })}
                          className="text-red-600 hover:text-red-700 hover:bg-red-50"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>

            {hasMorePagos && (
              <div className="flex justify-center mt-4">
                <Button
                  variant="outline"
                  onClick={() => fetchMorePagos()}
                  disabled={loadingMorePagos}
                >
                  {loadingMorePagos ? 'Cargando...' : 'Cargar m√°s pagos'}
                </Button>
              </div>
            )}

            {totalPaginas > 1 && (
              <div className="flex items-center justify-between mt-6">
                <p className="text-sm text-slate-600">
                  Mostrando {((paginaActual - 1) * registrosPorPagina) + 1} - {Math.min(paginaActual * registrosPorPagina, pagosValidos.length)} de {pagosValidos.length} pagos
                </p>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPaginaActual(p => Math.max(1, p - 1))}
                    disabled={paginaActual === 1}
                  >
                    <ChevronLeft className="h-4 w-4 mr-1" />
                    Anterior
                  </Button>
                  <div className="flex items-center gap-1">
                    {Array.from({ length: Math.min(5, totalPaginas) }, (_, i) => {
                      let pageNum;
                      if (totalPaginas <= 5) {
                        pageNum = i + 1;
                      } else if (paginaActual <= 3) {
                        pageNum = i + 1;
                      } else if (paginaActual >= totalPaginas - 2) {
                        pageNum = totalPaginas - 4 + i;
                      } else {
                        pageNum = paginaActual - 2 + i;
                      }
                      return (
                        <Button
                          key={pageNum}
                          variant={paginaActual === pageNum ? "default" : "outline"}
                          size="sm"
                          onClick={() => setPaginaActual(pageNum)}
                          className="w-8 h-8 p-0"
                        >
                          {pageNum}
                        </Button>
                      );
                    })}
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setPaginaActual(p => Math.min(totalPaginas, p + 1))}
                    disabled={paginaActual >= totalPaginas}
                  >
                    Siguiente
                    <ChevronRight className="h-4 w-4 ml-1" />
                  </Button>
                </div>
              </div>
            )}
          </>
        )}

        {/* Alert Dialog para eliminar */}
        <AlertDialog open={deleteDialog.open} onOpenChange={(open) => setDeleteDialog({ open, pago: deleteDialog.pago })}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>¬øEliminar este pago?</AlertDialogTitle>
              <AlertDialogDescription className="space-y-2">
                <p>Esta acci√≥n eliminar√° el pago y revertir√° todos los cambios asociados:</p>
                {deleteDialog.pago && (
                  <div className="bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                    <p className="font-semibold text-amber-900 mb-2">Proveedor: {deleteDialog.pago.proveedor_nombre}</p>
                    <p className="text-slate-700">Concepto: {deleteDialog.pago.concepto}</p>
                    <p className="text-slate-700">Monto: <strong>${(deleteDialog.pago.monto_total || 0).toLocaleString('es-AR')}</strong></p>
                    <p className="text-slate-700 mt-2">Se revertir√°n saldos de cajas/bancos, estados de ingresos y cuenta corriente.</p>
                  </div>
                )}
                <p className="text-xs text-slate-500 mt-2">Esta acci√≥n no se puede deshacer.</p>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel disabled={deletePagoMutation.isPending}>Cancelar</AlertDialogCancel>
              <AlertDialogAction
                onClick={() => deleteDialog.pago && deletePagoMutation.mutate(deleteDialog.pago)}
                disabled={deletePagoMutation.isPending}
                className="bg-red-600 hover:bg-red-700"
              >
                {deletePagoMutation.isPending ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Eliminando...
                  </>
                ) : (
                  'S√≠, Eliminar Pago'
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* Modal Nuevo Pago */}
        <PagoConIngresosModal
          open={modalPagoOpen}
          onClose={() => setModalPagoOpen(false)}
          onSave={(pagoData) => guardarPagoMutation.mutate(pagoData)}
          isLoading={guardarPagoMutation.isPending}
          proveedores={[]}
          movimientos={movimientos}
          cajas={cajas}
          bancos={bancos}
          cheques={cheques}
        />

        {/* Modal Imputar Pago */}
        <ImputarPagoModal
          open={imputarDialog.open}
          pago={imputarDialog.pago}
          movimientos={movimientos}
          onClose={() => setImputarDialog({ open: false, pago: null })}
          onImputar={(imputaciones) => imputarPagoMutation.mutate({ pago: imputarDialog.pago, imputaciones })}
          isLoading={imputarPagoMutation.isPending}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Perdidas.jsx">
import React, { useMemo, useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { AlertTriangle, TrendingDown, Scale, Filter, FileDown, Calendar } from "lucide-react";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function Perdidas() {
  const [fechaDesde, setFechaDesde] = useState('');
  const [fechaHasta, setFechaHasta] = useState('');

  const querySalidasPerdidas = useMemo(() => {
    const q = { estado: 'Confirmada' };
    if (fechaDesde) {
      q.fecha = q.fecha || {};
      q.fecha.$gte = new Date(fechaDesde).toISOString();
    }
    if (fechaHasta) {
      q.fecha = q.fecha || {};
      q.fecha.$lte = new Date(fechaHasta + 'T23:59:59').toISOString();
    }
    return q;
  }, [fechaDesde, fechaHasta]);

  const { data: salidas = [], isLoading, error } = useQuery({
    queryKey: ['salidas-confirmadas-perdidas', fechaDesde, fechaHasta],
    queryFn: () => {
      if (fechaDesde || fechaHasta) {
        return base44.entities.SalidaFruta.filter(
          querySalidasPerdidas,
          '-fecha',
          200
        );
      }
      return base44.entities.SalidaFruta.filter(
        { estado: 'Confirmada' },
        '-fecha',
        200
      );
    },
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list('fruta', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const salidasConfirmadas = salidas;

  const analisisPerdidas = useMemo(() => {
    let totalPerdidasBascula = 0;
    let totalPerdidasCalidad = 0;
    const perdidasPorProducto = {};
    const detallesPerdidas = [];

    salidasConfirmadas.forEach(salida => {
      salida.detalles?.forEach(detalle => {
        const kilosSalidaOriginal = detalle.kilos_salida || 0;
        const kilosReales = detalle.kilos_reales || kilosSalidaOriginal;
        const descuentoKg = detalle.descuento_kg || 0;

        // P√©rdida por diferencia de b√°scula
        const perdidaBascula = kilosSalidaOriginal - kilosReales;
        totalPerdidasBascula += perdidaBascula;

        // P√©rdida por descuento de calidad
        totalPerdidasCalidad += descuentoKg;

        // Agrupar por producto
        if (!perdidasPorProducto[detalle.producto_nombre]) {
          perdidasPorProducto[detalle.producto_nombre] = {
            bascula: 0,
            calidad: 0,
            total: 0,
            salidas: 0
          };
        }
        perdidasPorProducto[detalle.producto_nombre].bascula += perdidaBascula;
        perdidasPorProducto[detalle.producto_nombre].calidad += descuentoKg;
        perdidasPorProducto[detalle.producto_nombre].total += perdidaBascula + descuentoKg;
        perdidasPorProducto[detalle.producto_nombre].salidas += 1;

        // Guardar detalle si hay p√©rdida
        if (perdidaBascula > 0 || descuentoKg > 0) {
          detallesPerdidas.push({
            fecha: salida.fecha,
            remito: salida.numero_remito,
            cliente: salida.cliente_nombre,
            producto: detalle.producto_nombre,
            kilosOriginal: kilosSalidaOriginal,
            kilosReales: kilosReales,
            perdidaBascula: perdidaBascula,
            descuentoCalidad: descuentoKg,
            motivo: detalle.motivo_ajuste || '-'
          });
        }
      });
    });

    return {
      totalPerdidasBascula,
      totalPerdidasCalidad,
      totalGeneral: totalPerdidasBascula + totalPerdidasCalidad,
      perdidasPorProducto,
      detallesPerdidas: detallesPerdidas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
    };
  }, [salidasConfirmadas]);

  const exportarPDF = () => {
    const periodoText = `${fechaDesde ? format(new Date(fechaDesde), 'dd/MM/yyyy') : 'Inicio'} - ${fechaHasta ? format(new Date(fechaHasta), 'dd/MM/yyyy') : 'Hoy'}`;
    
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Informe de P√©rdidas</title>
        <style>
          body { font-family: Arial, sans-serif; font-size: 11px; padding: 20px; }
          .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #dc2626; padding-bottom: 10px; }
          .title { font-size: 20px; font-weight: bold; color: #991b1b; }
          .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
          .summary-card { background: #fee; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #fca; }
          .summary-card .value { font-size: 24px; font-weight: bold; color: #dc2626; }
          .summary-card .label { font-size: 11px; color: #666; margin-top: 5px; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #fee; font-weight: 600; color: #991b1b; }
          .text-right { text-align: right; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="title">INFORME DE P√âRDIDAS</div>
          <p>Per√≠odo: ${periodoText}</p>
          <p>Salidas confirmadas: ${salidasConfirmadas.length}</p>
        </div>

        <div class="summary">
          <div class="summary-card">
            <div class="value">${analisisPerdidas.totalPerdidasBascula.toFixed(2)} kg</div>
            <div class="label">P√©rdida por B√°scula</div>
          </div>
          <div class="summary-card">
            <div class="value">${analisisPerdidas.totalPerdidasCalidad.toFixed(2)} kg</div>
            <div class="label">P√©rdida por Calidad</div>
          </div>
          <div class="summary-card">
            <div class="value">${analisisPerdidas.totalGeneral.toFixed(2)} kg</div>
            <div class="label">P√©rdida Total</div>
          </div>
        </div>

        <h3>P√©rdidas por Producto</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th class="text-right">B√°scula</th>
              <th class="text-right">Calidad</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(analisisPerdidas.perdidasPorProducto).map(([prod, datos]) => `
              <tr>
                <td>${prod}</td>
                <td class="text-right">${datos.bascula.toFixed(2)} kg</td>
                <td class="text-right">${datos.calidad.toFixed(2)} kg</td>
                <td class="text-right"><strong>${datos.total.toFixed(2)} kg</strong></td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <p>Generado: ${format(new Date(), 'dd/MM/yyyy HH:mm')}</p>
      </body>
      </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
  };

  const productosArray = Object.entries(analisisPerdidas.perdidasPorProducto)
    .map(([nombre, datos]) => ({ nombre, ...datos }))
    .sort((a, b) => b.total - a.total);

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50 p-4 md:p-6 lg:p-8">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
              <AlertTriangle className="h-8 w-8 text-red-600" />
              An√°lisis de P√©rdidas
            </h1>
            <p className="text-slate-600 mt-1">Control de p√©rdidas en salidas de fruta confirmadas</p>
          </div>
          {salidasConfirmadas.length > 0 && (
            <Button onClick={exportarPDF} className="bg-red-600 hover:bg-red-700">
              <FileDown className="h-4 w-4 mr-2" />
              Exportar PDF
            </Button>
          )}
        </div>

        {/* Filtros */}
        <Card className="border-0 shadow-lg">
          <CardHeader className="pb-4">
            <CardTitle className="text-lg flex items-center gap-2">
              <Filter className="h-5 w-5" />
              Filtros de Per√≠odo
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="text-sm font-medium text-slate-700 mb-1 block flex items-center gap-2">
                  <Calendar className="h-4 w-4" />
                  Fecha Desde
                </label>
                <Input
                  type="date"
                  value={fechaDesde}
                  onChange={(e) => setFechaDesde(e.target.value)}
                />
              </div>
              <div>
                <label className="text-sm font-medium text-slate-700 mb-1 block flex items-center gap-2">
                  <Calendar className="h-4 w-4" />
                  Fecha Hasta
                </label>
                <Input
                  type="date"
                  value={fechaHasta}
                  onChange={(e) => setFechaHasta(e.target.value)}
                />
              </div>
              <div className="flex items-end">
                {(fechaDesde || fechaHasta) && (
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      setFechaDesde('');
                      setFechaHasta('');
                    }}
                    className="w-full"
                  >
                    Limpiar Filtros
                  </Button>
                )}
              </div>
            </div>
          </CardContent>
        </Card>

        {error ? (
          <Card className="border-0 shadow-lg">
            <CardContent className="p-12 text-center">
              <AlertTriangle className="h-16 w-16 text-red-300 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-slate-700 mb-2">Error al cargar datos</h3>
              <p className="text-slate-500">No se pudieron cargar las salidas. Intenta recargar la p√°gina.</p>
            </CardContent>
          </Card>
        ) : isLoading ? (
          <div className="text-center py-12">Cargando...</div>
        ) : salidasConfirmadas.length === 0 ? (
          <Card className="border-0 shadow-lg">
            <CardContent className="p-12 text-center">
              <TrendingDown className="h-16 w-16 text-slate-300 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-slate-700 mb-2">Sin datos</h3>
              <p className="text-slate-500">No hay salidas confirmadas en el per√≠odo seleccionado</p>
            </CardContent>
          </Card>
        ) : (
          <>
            {/* Resumen General */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <Card className="border-0 shadow-lg bg-gradient-to-br from-red-50 to-red-100">
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-red-700 font-medium mb-1">P√©rdida por B√°scula</p>
                      <p className="text-3xl font-bold text-red-800">
                        {analisisPerdidas.totalPerdidasBascula.toFixed(2)}
                      </p>
                      <p className="text-xs text-red-600 mt-1">kg (diferencia env√≠o-recepci√≥n)</p>
                    </div>
                    <Scale className="h-12 w-12 text-red-600 opacity-50" />
                  </div>
                </CardContent>
              </Card>

              <Card className="border-0 shadow-lg bg-gradient-to-br from-orange-50 to-orange-100">
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-orange-700 font-medium mb-1">Descuentos por Calidad</p>
                      <p className="text-3xl font-bold text-orange-800">
                        {analisisPerdidas.totalPerdidasCalidad.toFixed(2)}
                      </p>
                      <p className="text-xs text-orange-600 mt-1">kg (clasificaci√≥n/estado)</p>
                    </div>
                    <TrendingDown className="h-12 w-12 text-orange-600 opacity-50" />
                  </div>
                </CardContent>
              </Card>

              <Card className="border-0 shadow-lg bg-gradient-to-br from-slate-100 to-slate-200">
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-slate-700 font-medium mb-1">P√©rdida Total</p>
                      <p className="text-3xl font-bold text-slate-800">
                        {analisisPerdidas.totalGeneral.toFixed(2)}
                      </p>
                      <p className="text-xs text-slate-600 mt-1">kg en {salidasConfirmadas.length} salida(s)</p>
                    </div>
                    <AlertTriangle className="h-12 w-12 text-slate-600 opacity-50" />
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* P√©rdidas por Producto */}
            <Card className="border-0 shadow-lg">
              <CardHeader>
                <CardTitle>P√©rdidas por Producto</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="text-left p-3 font-semibold">Producto</th>
                        <th className="text-right p-3 font-semibold">B√°scula</th>
                        <th className="text-right p-3 font-semibold">Calidad</th>
                        <th className="text-right p-3 font-semibold">Total P√©rdida</th>
                        <th className="text-center p-3 font-semibold">Salidas</th>
                      </tr>
                    </thead>
                    <tbody>
                      {productosArray.map((prod, idx) => (
                        <tr key={idx} className="border-b hover:bg-slate-50">
                          <td className="p-3 font-medium">{prod.nombre}</td>
                          <td className="p-3 text-right text-red-600">{prod.bascula.toFixed(2)} kg</td>
                          <td className="p-3 text-right text-orange-600">{prod.calidad.toFixed(2)} kg</td>
                          <td className="p-3 text-right font-bold text-slate-800">{prod.total.toFixed(2)} kg</td>
                          <td className="p-3 text-center">
                            <Badge variant="outline">{prod.salidas}</Badge>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>

            {/* Detalle de P√©rdidas */}
            {analisisPerdidas.detallesPerdidas.length > 0 && (
              <Card className="border-0 shadow-lg">
                <CardHeader>
                  <CardTitle>Historial de P√©rdidas ({analisisPerdidas.detallesPerdidas.length})</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-50">
                        <tr>
                          <th className="text-left p-2 font-semibold">Fecha</th>
                          <th className="text-left p-2 font-semibold">Remito</th>
                          <th className="text-left p-2 font-semibold">Cliente</th>
                          <th className="text-left p-2 font-semibold">Producto</th>
                          <th className="text-right p-2 font-semibold">Kg Orig.</th>
                          <th className="text-right p-2 font-semibold">Kg Reales</th>
                          <th className="text-right p-2 font-semibold">P√©rd. B√°scula</th>
                          <th className="text-right p-2 font-semibold">Desc. Calidad</th>
                          <th className="text-left p-2 font-semibold">Motivo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {analisisPerdidas.detallesPerdidas.map((detalle, idx) => (
                          <tr key={idx} className="border-b hover:bg-slate-50">
                            <td className="p-2 text-xs">{format(new Date(detalle.fecha), 'dd/MM/yy HH:mm')}</td>
                            <td className="p-2 font-mono text-xs">{detalle.remito}</td>
                            <td className="p-2 text-xs">{detalle.cliente}</td>
                            <td className="p-2">{detalle.producto}</td>
                            <td className="p-2 text-right">{detalle.kilosOriginal.toFixed(2)}</td>
                            <td className="p-2 text-right">{detalle.kilosReales.toFixed(2)}</td>
                            <td className="p-2 text-right text-red-600 font-medium">
                              {detalle.perdidaBascula > 0 ? detalle.perdidaBascula.toFixed(2) : '-'}
                            </td>
                            <td className="p-2 text-right text-orange-600 font-medium">
                              {detalle.descuentoCalidad > 0 ? detalle.descuentoCalidad.toFixed(2) : '-'}
                            </td>
                            <td className="p-2 text-xs italic">{detalle.motivo}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            )}
          </>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/SaldosEnvases.jsx">
import React, { useMemo, useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Package, AlertTriangle, CheckCircle, User, Users, ChevronDown, ChevronUp, FileDown, MessageCircle, Search } from "lucide-react";
import { Input } from "@/components/ui/input";
import { downloadResumenSaldosPDF } from '../components/PDFGenerator';
import { Button } from "@/components/ui/button";
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

export default function SaldosEnvases() {
  const [vistaActual, setVistaActual] = useState('saldos'); // 'saldos', 'stock' o 'pagados'
  const [filtroTipo, setFiltroTipo] = useState('Ambos');
  const [expandedEntity, setExpandedEntity] = useState(null);
  const [busqueda, setBusqueda] = useState('');

  const { data: movimientos = [], isLoading: loadingMov, error: errorMov } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list('-fecha', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: proveedores = [], isLoading: loadingProv } = useQuery({
    queryKey: ['proveedores'],
    queryFn: () => base44.entities.Proveedor.list('nombre', 500),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: clientes = [], isLoading: loadingCli } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list('nombre', 500),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: salidas = [], isLoading: loadingSal, error: errorSal } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-fecha', 100),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const todosLosSaldos = useMemo(() => {
    const saldos = {};
    
    // Procesar movimientos de proveedores (envases vac√≠os)
    movimientos.forEach(m => {
      if (m.proveedor_id && m.movimiento_envases) {
        const key = `proveedor_${m.proveedor_id}`;
        if (!saldos[key]) {
          const prov = proveedores.find(p => p.id === m.proveedor_id);
          saldos[key] = {
            id: m.proveedor_id,
            nombre: m.proveedor_nombre || prov?.nombre || 'Desconocido',
            tipo: 'Proveedor',
            whatsapp: prov?.whatsapp,
            envases: {},
            historial: []
          };
        }
        
        m.movimiento_envases.forEach(e => {
          if (!e.envase_tipo) return;
          if (!saldos[key].envases[e.envase_tipo]) {
            saldos[key].envases[e.envase_tipo] = 0;
          }
          saldos[key].envases[e.envase_tipo] += (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
        });
        
        // Agregar al historial
        saldos[key].historial.push({
          fecha: m.fecha,
          tipo: m.tipo_movimiento,
          envases: m.movimiento_envases
        });
      }
    });

    // Procesar ENVASES LLENOS en Ingreso de Fruta (devoluci√≥n del proveedor)
    movimientos.forEach(m => {
      if (m.proveedor_id && m.tipo_movimiento === 'Ingreso de Fruta' && m.envases_llenos) {
        const key = `proveedor_${m.proveedor_id}`;
        if (!saldos[key]) {
          const prov = proveedores.find(p => p.id === m.proveedor_id);
          saldos[key] = {
            id: m.proveedor_id,
            nombre: m.proveedor_nombre || prov?.nombre || 'Desconocido',
            tipo: 'Proveedor',
            whatsapp: prov?.whatsapp,
            envases: {},
            historial: []
          };
        }
        
        // Los envases llenos que entrega el proveedor REDUCEN su deuda
        m.envases_llenos.forEach(e => {
          if (!e.envase_tipo) return;
          if (!saldos[key].envases[e.envase_tipo]) {
            saldos[key].envases[e.envase_tipo] = 0;
          }
          saldos[key].envases[e.envase_tipo] -= (e.cantidad || 0);
        });
        
        // Agregar al historial
        if (m.envases_llenos.length > 0) {
          saldos[key].historial.push({
            fecha: m.fecha,
            tipo: 'Ingreso de Fruta (Envases Llenos)',
            envases: m.envases_llenos.map(e => ({
              envase_tipo: e.envase_tipo,
              cantidad_ingreso: e.cantidad,
              cantidad_salida: 0
            }))
          });
        }
      }
    });

    // Procesar movimientos de clientes (DEUDA DEL ACOPIO HACIA CLIENTES)
    // Cuando cliente INGRESA envases ‚Üí acopio le debe al cliente
    // Cuando acopio DEVUELVE (salida) ‚Üí reduce deuda del acopio
    movimientos.forEach(m => {
      if (m.cliente_id && m.movimiento_envases) {
        const key = `cliente_${m.cliente_id}`;
        if (!saldos[key]) {
          const cli = clientes.find(c => c.id === m.cliente_id);
          saldos[key] = {
            id: m.cliente_id,
            nombre: m.cliente_nombre || cli?.nombre || 'Desconocido',
            tipo: 'Cliente',
            whatsapp: cli?.whatsapp,
            envases: {},
            historial: []
          };
        }
        
        m.movimiento_envases.forEach(e => {
          if (!e.envase_tipo) return;
          if (!saldos[key].envases[e.envase_tipo]) {
            saldos[key].envases[e.envase_tipo] = 0;
          }
          // INVERTIDO: ingreso suma (acopio debe), salida resta (acopio devuelve)
          saldos[key].envases[e.envase_tipo] += (e.cantidad_ingreso || 0) - (e.cantidad_salida || 0);
        });
        
        saldos[key].historial.push({
          fecha: m.fecha,
          tipo: m.tipo_movimiento,
          envases: m.movimiento_envases
        });
      }
    });
    
    // Procesar envases LLENOS en salidas de fruta (REDUCEN la deuda hacia cliente)
    salidas.forEach(s => {
      if (s.cliente_id && s.envases_llenos?.length > 0) {
        const key = `cliente_${s.cliente_id}`;
        if (!saldos[key]) {
          const cli = clientes.find(c => c.id === s.cliente_id);
          saldos[key] = {
            id: s.cliente_id,
            nombre: s.cliente_nombre || cli?.nombre || 'Desconocido',
            tipo: 'Cliente',
            whatsapp: cli?.whatsapp,
            envases: {},
            historial: []
          };
        }
        
        s.envases_llenos.forEach(e => {
          if (!e.envase_tipo) return;
          if (!saldos[key].envases[e.envase_tipo]) {
            saldos[key].envases[e.envase_tipo] = 0;
          }
          // RESTAR: cuando le mandas envases llenos al cliente, reduces lo que le debes
          saldos[key].envases[e.envase_tipo] -= (e.cantidad || 0);
        });
        
        // Agregar al historial
        saldos[key].historial.push({
          fecha: s.fecha,
          tipo: 'Salida de Fruta',
          remito: s.numero_remito,
          envases_llenos: s.envases_llenos
        });
      }
    });

    // Procesar envases vac√≠os en salidas de fruta (DEUDA DEL ACOPIO HACIA CLIENTES)
    salidas.forEach(s => {
      if (s.cliente_id && s.movimiento_envases) {
        const key = `cliente_${s.cliente_id}`;
        if (!saldos[key]) {
          const cli = clientes.find(c => c.id === s.cliente_id);
          saldos[key] = {
            id: s.cliente_id,
            nombre: s.cliente_nombre || cli?.nombre || 'Desconocido',
            tipo: 'Cliente',
            whatsapp: cli?.whatsapp,
            envases: {},
            historial: []
          };
        }
        
        s.movimiento_envases.forEach(e => {
          if (!e.envase_tipo) return;
          if (!saldos[key].envases[e.envase_tipo]) {
            saldos[key].envases[e.envase_tipo] = 0;
          }
          // INVERTIDO: ingreso suma (acopio debe), salida resta (acopio devuelve)
          saldos[key].envases[e.envase_tipo] += (e.cantidad_ingreso || 0) - (e.cantidad_salida || 0);
        });
      }
    });

    // Convertir a array y calcular totales (incluir TODOS, incluso los pagados)
    return Object.values(saldos)
      .map(s => {
        const envasesArray = Object.entries(s.envases)
          .map(([tipo, saldo]) => ({ tipo, saldo: Math.max(0, saldo) }));

        const totalAdeudado = envasesArray.reduce((sum, e) => sum + e.saldo, 0);

        return {
          ...s,
          envases: envasesArray,
          totalAdeudado,
          historial: s.historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
        };
      })
      .filter(s => s.historial.length > 0) // Solo los que tienen historial
      .sort((a, b) => b.totalAdeudado - a.totalAdeudado);
    }, [movimientos, salidas, proveedores, clientes]);

  const generarPDFSaldo = (entidad) => {
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Saldo de Envases - ${entidad.nombre}</title>
        <style>
          body { font-family: Arial, sans-serif; font-size: 11px; padding: 20px; }
          .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #dc2626; padding-bottom: 10px; }
          .title { font-size: 20px; font-weight: bold; color: #991b1b; }
          table { width: 100%; border-collapse: collapse; margin: 15px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #fee; font-weight: 600; }
          .total { background: #fca; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="title">SALDO DE ENVASES</div>
          <p>${entidad.tipo}: ${entidad.nombre}</p>
          <p>Fecha: ${format(new Date(), 'dd/MM/yyyy HH:mm')}</p>
        </div>
        
        <h3>Historial de Movimientos</h3>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            ${entidad.historial.map(h => `
              <tr>
                <td>${format(new Date(h.fecha), 'dd/MM/yyyy HH:mm')}</td>
                <td>${h.tipo}</td>
                <td>${(h.envases || []).map(e => `${e.envase_tipo}: +${e.cantidad_ingreso||0}/-${e.cantidad_salida||0}`).join(', ')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <h3>Saldo Actual</h3>
        <table>
          <thead>
            <tr>
              <th>Tipo de Envase</th>
              <th>Cantidad Adeudada</th>
            </tr>
          </thead>
          <tbody>
            ${entidad.envases.map(e => `
              <tr>
                <td>${e.tipo}</td>
                <td style="color: #dc2626; font-weight: bold;">${e.saldo}</td>
              </tr>
            `).join('')}
            <tr class="total">
              <td>TOTAL</td>
              <td>${entidad.totalAdeudado}</td>
            </tr>
          </tbody>
        </table>
      </body>
      </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.onload = () => printWindow.print();
  };

  const compartirWhatsAppSaldo = async (entidad) => {
    if (!entidad.whatsapp) {
      alert('No hay n√∫mero de WhatsApp registrado para esta entidad');
      return;
    }
    
    const mensaje = `üî¥ *SALDO DE ENVASES*\n\n` +
      `${entidad.tipo}: ${entidad.nombre}\n\n` +
      `üì¶ *Envases Adeudados:*\n` +
      entidad.envases.map(e => `‚Ä¢ ${e.tipo}: ${e.saldo} unidades`).join('\n') +
      `\n\nüíº *Total: ${entidad.totalAdeudado} envases*`;
    
    const cleanNumber = entidad.whatsapp.replace(/\D/g, '');
    const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(mensaje)}`;
    window.open(whatsappUrl, '_blank');
  };

  const saldosFiltrados = useMemo(() => {
    let conDeuda = todosLosSaldos.filter(s => s.totalAdeudado > 0);
    if (filtroTipo !== 'Ambos') {
      conDeuda = conDeuda.filter(s => s.tipo === filtroTipo);
    }
    if (busqueda) {
      conDeuda = conDeuda.filter(s => 
        s.nombre.toLowerCase().includes(busqueda.toLowerCase())
      );
    }
    return conDeuda;
  }, [todosLosSaldos, filtroTipo, busqueda]);

  const saldosPagados = useMemo(() => {
    let pagados = todosLosSaldos.filter(s => s.totalAdeudado === 0);
    if (filtroTipo !== 'Ambos') {
      pagados = pagados.filter(s => s.tipo === filtroTipo);
    }
    if (busqueda) {
      pagados = pagados.filter(s => 
        s.nombre.toLowerCase().includes(busqueda.toLowerCase())
      );
    }
    return pagados;
  }, [todosLosSaldos, filtroTipo, busqueda]);

  const saldosPorProveedor = saldosFiltrados.filter(s => s.tipo === 'Proveedor');
  const saldosPorCliente = saldosFiltrados.filter(s => s.tipo === 'Cliente');

  const totalGeneral = saldosFiltrados.reduce((sum, s) => sum + s.totalAdeudado, 0);
  const totalProveedores = saldosPorProveedor.reduce((sum, p) => sum + p.totalAdeudado, 0);
  const totalClientes = saldosPorCliente.reduce((sum, c) => sum + c.totalAdeudado, 0);

  // Calcular stock disponible de envases (ingresos desde clientes - salidas a proveedores)
  const stockDisponible = useMemo(() => {
    const stock = {};
    
    // Ingresos/salidas desde movimientos con clientes
    movimientos.forEach(m => {
      if (m.cliente_id && m.movimiento_envases) {
        m.movimiento_envases.forEach(e => {
          if (!e.envase_tipo) return;
          if (!stock[e.envase_tipo]) stock[e.envase_tipo] = 0;
          stock[e.envase_tipo] += (e.cantidad_ingreso || 0) - (e.cantidad_salida || 0);
        });
      }
    });
    
    // Ingresos/salidas en salidas de fruta (a clientes)
    salidas.forEach(s => {
      if (s.movimiento_envases) {
        s.movimiento_envases.forEach(e => {
          if (!e.envase_tipo) return;
          if (!stock[e.envase_tipo]) stock[e.envase_tipo] = 0;
          stock[e.envase_tipo] += (e.cantidad_ingreso || 0) - (e.cantidad_salida || 0);
        });
      }
    });
    
    // Salidas a proveedores
    movimientos.forEach(m => {
      if (m.proveedor_id && m.movimiento_envases) {
        m.movimiento_envases.forEach(e => {
          if (!e.envase_tipo) return;
          if (!stock[e.envase_tipo]) stock[e.envase_tipo] = 0;
          stock[e.envase_tipo] -= (e.cantidad_salida || 0) - (e.cantidad_ingreso || 0);
        });
      }
    });
    
    return Object.entries(stock)
      .map(([tipo, cantidad]) => ({ tipo, stock: cantidad }))
      .sort((a, b) => b.stock - a.stock);
  }, [movimientos, salidas]);

  const totalStockDisponible = stockDisponible.reduce((sum, e) => sum + Math.max(0, e.stock), 0);

  const isLoading = loadingMov || loadingProv || loadingCli || loadingSal;
  const hasError = errorMov || errorSal;

  if (hasError) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50">
        <div className="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
          <Card className="border-red-200 bg-red-50 shadow-lg">
            <CardContent className="p-12 text-center">
              <AlertTriangle className="h-16 w-16 text-red-600 mx-auto mb-4" />
              <h3 className="text-lg font-semibold text-red-900 mb-2">Error al cargar datos</h3>
              <p className="text-red-700">No se pudieron cargar los movimientos. Intenta recargar la p√°gina.</p>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50">
      <div className="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <div className="mb-8">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
              <Package className="h-6 w-6 text-red-600" />
            </div>
            <div className="flex-1">
              <h1 className="text-2xl sm:text-3xl font-bold text-slate-800">Saldos de Envases</h1>
              <p className="text-slate-500 text-sm">Stock disponible y envases adeudados</p>
            </div>
          </div>
          
          {/* Selector de vista */}
          <div className="flex gap-2 flex-wrap">
            <Button
              variant={vistaActual === 'stock' ? 'default' : 'outline'}
              onClick={() => setVistaActual('stock')}
              className={vistaActual === 'stock' ? 'bg-teal-600 hover:bg-teal-700' : ''}
            >
              Stock Disponible
            </Button>
            <Button
              variant={vistaActual === 'saldos' ? 'default' : 'outline'}
              onClick={() => setVistaActual('saldos')}
              className={vistaActual === 'saldos' ? 'bg-red-600 hover:bg-red-700' : ''}
            >
              Saldos por Entidad
            </Button>
            <Button
              variant={vistaActual === 'pagados' ? 'default' : 'outline'}
              onClick={() => setVistaActual('pagados')}
              className={vistaActual === 'pagados' ? 'bg-green-600 hover:bg-green-700' : ''}
            >
              Saldos Pagados
            </Button>

            {vistaActual === 'saldos' && saldosFiltrados.length > 0 && (
              <Button
                variant="outline"
                onClick={() => downloadResumenSaldosPDF(saldosFiltrados, filtroTipo)}
                className="ml-auto"
              >
                <FileDown className="h-4 w-4 mr-1" />
                Descargar Resumen PDF
              </Button>
            )}

            {(vistaActual === 'saldos' || vistaActual === 'pagados') && (
              <>
                <div className="relative flex-1 min-w-[200px]">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400" />
                  <Input
                    value={busqueda}
                    onChange={(e) => setBusqueda(e.target.value)}
                    placeholder="Buscar cliente o proveedor..."
                    className="pl-10"
                  />
                </div>
                <div className="w-full sm:w-64">
                  <Select value={filtroTipo} onValueChange={setFiltroTipo}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Ambos">Ambos</SelectItem>
                      <SelectItem value="Proveedor">Solo Proveedores</SelectItem>
                      <SelectItem value="Cliente">Solo Clientes</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Resumen General - Stock Disponible */}
        {vistaActual === 'stock' && (
          <div className="grid grid-cols-1 md:grid-cols-1 gap-4 mb-6">
            <Card className="border-0 shadow-lg shadow-slate-200/50">
              <CardContent className="p-6">
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center">
                    <Package className="h-8 w-8 text-teal-600" />
                  </div>
                  <div>
                    <p className="text-sm text-slate-500">Total Stock Disponible en Acopio</p>
                    <p className="text-3xl font-bold text-teal-600">{totalStockDisponible} envases</p>
                    <p className="text-xs text-slate-500 mt-1">Listos para entregar a proveedores</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Resumen General - Saldos por Entidad */}
        {vistaActual === 'saldos' && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardContent className="p-6">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                  <AlertTriangle className="h-6 w-6 text-red-600" />
                </div>
                <div>
                  <p className="text-xs text-slate-500">Proveedores con Deuda</p>
                  <p className="text-2xl font-bold text-red-600">{saldosPorProveedor.length}</p>
                  <p className="text-xs text-slate-400">{totalProveedores} envases totales</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardContent className="p-6">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                  <Users className="h-6 w-6 text-blue-600" />
                </div>
                <div>
                  <p className="text-xs text-slate-500">Proveedores</p>
                  <p className="text-2xl font-bold text-blue-600">{totalProveedores}</p>
                  <p className="text-xs text-slate-500">{saldosPorProveedor.length} con deuda</p>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardContent className="p-6">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                  <User className="h-6 w-6 text-purple-600" />
                </div>
                <div>
                  <p className="text-xs text-slate-500">Clientes (Acopio Debe)</p>
                  <p className="text-2xl font-bold text-purple-600">{totalClientes}</p>
                  <p className="text-xs text-slate-500">{saldosPorCliente.length} pendientes</p>
                </div>
              </div>
            </CardContent>
          </Card>
          </div>
        )}

        {/* Vista Stock Disponible */}
        {vistaActual === 'stock' && (
          isLoading ? (
            <div className="text-center py-12 text-slate-500">Cargando...</div>
          ) : stockDisponible.length === 0 ? (
            <Card className="border-0 shadow-lg shadow-slate-200/50">
              <CardContent className="p-12 text-center">
                <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Package className="h-8 w-8 text-slate-400" />
                </div>
                <h3 className="text-lg font-semibold text-slate-800 mb-2">
                  Sin stock de envases
                </h3>
                <p className="text-slate-500">
                  No hay envases disponibles en el acopio
                </p>
              </CardContent>
            </Card>
          ) : (
            <Card className="border-0 shadow-lg shadow-slate-200/50">
              <CardHeader>
                <CardTitle>Stock de Envases por Tipo</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b">
                        <th className="text-left p-4 font-semibold text-slate-700">Tipo de Envase</th>
                        <th className="text-right p-4 font-semibold text-slate-700">Stock Disponible</th>
                        <th className="text-right p-4 font-semibold text-slate-700">Estado</th>
                      </tr>
                    </thead>
                    <tbody>
                      {stockDisponible.map((item, i) => (
                        <tr key={i} className="border-b hover:bg-slate-50 transition-colors">
                          <td className="p-4">
                            <div className="flex items-center gap-2">
                              <Package className="h-5 w-5 text-slate-400" />
                              <span className="font-medium text-slate-800">{item.tipo}</span>
                            </div>
                          </td>
                          <td className="p-4 text-right">
                            <span className={`text-2xl font-bold ${item.stock >= 0 ? 'text-teal-600' : 'text-red-600'}`}>
                              {item.stock}
                            </span>
                          </td>
                          <td className="p-4 text-right">
                            {item.stock > 0 ? (
                              <Badge className="bg-teal-100 text-teal-700 border-teal-300">
                                Disponible
                              </Badge>
                            ) : item.stock < 0 ? (
                              <Badge variant="destructive">
                                D√©ficit
                              </Badge>
                            ) : (
                              <Badge variant="outline">
                                Agotado
                              </Badge>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
          )
        )}

        {/* Lista de Entidades - Saldos CON Deuda */}
        {vistaActual === 'saldos' && (isLoading ? (
          <div className="text-center py-12 text-slate-500">Cargando...</div>
        ) : saldosFiltrados.length === 0 ? (
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardContent className="p-12 text-center">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <CheckCircle className="h-8 w-8 text-green-600" />
              </div>
              <h3 className="text-lg font-semibold text-slate-800 mb-2">
                ¬°Sin deudas de envases!
              </h3>
              <p className="text-slate-500">
                {filtroTipo === 'Ambos' 
                  ? 'Todos los proveedores y clientes tienen sus envases al d√≠a'
                  : `Todos los ${filtroTipo === 'Proveedor' ? 'proveedores' : 'clientes'} tienen sus envases al d√≠a`}
              </p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-4">
            {saldosFiltrados.map((entidad) => {
              const isExpanded = expandedEntity === `${entidad.tipo}_${entidad.id}`;
              return (
              <Card key={`${entidad.tipo}_${entidad.id}`} className="border-0 shadow-md hover:shadow-lg transition-shadow">
                <CardHeader className="pb-2">
                  <div className="flex items-center justify-between flex-wrap gap-2">
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className={entidad.tipo === 'Proveedor' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-purple-50 text-purple-700 border-purple-200'}>
                        {entidad.tipo === 'Proveedor' ? 'Proveedor (Me debe)' : 'Cliente (Le debo)'}
                      </Badge>
                      <CardTitle className="text-lg font-semibold">
                        {entidad.nombre}
                      </CardTitle>
                    </div>
                    <Badge variant="destructive" className="text-base px-3 py-1">
                      {entidad.totalAdeudado} envases
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="flex flex-wrap gap-3 mb-3">
                    {entidad.envases.filter(e => e.saldo > 0).map((env, i) => (
                      <div
                        key={i}
                        className="flex items-center gap-2 px-4 py-2 bg-red-50 border border-red-200 rounded-lg"
                      >
                        <Package className="h-4 w-4 text-red-500" />
                        <span className="font-medium text-red-800">{env.tipo}:</span>
                        <span className="font-bold text-red-600">{env.saldo}</span>
                      </div>
                    ))}
                  </div>
                  
                  <div className="flex flex-wrap gap-2 pt-3 border-t">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setExpandedEntity(isExpanded ? null : `${entidad.tipo}_${entidad.id}`)}
                    >
                      {isExpanded ? <ChevronUp className="h-4 w-4 mr-1" /> : <ChevronDown className="h-4 w-4 mr-1" />}
                      Ver Historial
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => generarPDFSaldo(entidad)}
                    >
                      <FileDown className="h-4 w-4 mr-1" />
                      PDF
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => compartirWhatsAppSaldo(entidad)}
                      className="text-green-600"
                    >
                      <MessageCircle className="h-4 w-4 mr-1" />
                      WhatsApp
                    </Button>
                  </div>

                  {isExpanded && (
                    <div className="mt-4 pt-4 border-t">
                      <h4 className="font-semibold text-sm mb-3">Historial de Movimientos</h4>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-slate-50">
                            <tr>
                              <th className="text-left p-2">Fecha</th>
                              <th className="text-left p-2">Tipo</th>
                              <th className="text-left p-2">Envases</th>
                            </tr>
                          </thead>
                          <tbody>
                           {entidad.historial.map((h, idx) => (
                             <tr key={idx} className="border-b">
                               <td className="p-2">{format(new Date(h.fecha), 'dd/MM/yy HH:mm', { locale: es })}</td>
                               <td className="p-2">
                                 <div className="flex flex-col">
                                   <span>{h.tipo}</span>
                                   {h.remito && <span className="text-xs text-slate-500">{h.remito}</span>}
                                 </div>
                               </td>
                               <td className="p-2 text-xs">
                                 {h.envases?.map((e, i) => (
                                   <div key={i}>
                                     {e.envase_tipo}: 
                                     {e.cantidad_ingreso > 0 && <span className="text-green-600"> +{e.cantidad_ingreso}</span>}
                                     {e.cantidad_salida > 0 && <span className="text-red-600"> -{e.cantidad_salida}</span>}
                                   </div>
                                 ))}
                                 {h.envases_llenos?.map((e, i) => (
                                   <div key={i} className="text-purple-600 font-medium">
                                     {e.envase_tipo}: -{e.cantidad} llenos
                                   </div>
                                 ))}
                               </td>
                             </tr>
                           ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            )})}
          </div>
          ))}

          {/* Lista de Entidades - Saldos PAGADOS (sin deuda) */}
          {vistaActual === 'pagados' && (isLoading ? (
          <div className="text-center py-12 text-slate-500">Cargando...</div>
          ) : saldosPagados.length === 0 ? (
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardContent className="p-12 text-center">
              <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Package className="h-8 w-8 text-slate-400" />
              </div>
              <h3 className="text-lg font-semibold text-slate-800 mb-2">
                Sin saldos pagados
              </h3>
              <p className="text-slate-500">
                A√∫n no hay {filtroTipo === 'Ambos' ? 'proveedores o clientes' : filtroTipo === 'Proveedor' ? 'proveedores' : 'clientes'} que hayan devuelto todos sus envases
              </p>
            </CardContent>
          </Card>
          ) : (
          <div className="space-y-4">
            {saldosPagados.map((entidad) => {
              const isExpanded = expandedEntity === `${entidad.tipo}_${entidad.id}`;
              return (
              <Card key={`${entidad.tipo}_${entidad.id}`} className="border-0 shadow-md hover:shadow-lg transition-shadow">
                <CardHeader className="pb-2">
                  <div className="flex items-center justify-between flex-wrap gap-2">
                    <div className="flex items-center gap-2">
                      <Badge variant="outline" className={entidad.tipo === 'Proveedor' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-purple-50 text-purple-700 border-purple-200'}>
                        {entidad.tipo}
                      </Badge>
                      <CardTitle className="text-lg font-semibold">
                        {entidad.nombre}
                      </CardTitle>
                    </div>
                    <Badge className="bg-green-100 text-green-700 border-green-300 text-base px-3 py-1">
                      ‚úì Al d√≠a
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="flex items-center gap-2 px-4 py-3 bg-green-50 border border-green-200 rounded-lg mb-3">
                    <CheckCircle className="h-5 w-5 text-green-600" />
                    <span className="text-sm text-green-800 font-medium">
                      Todos los envases han sido devueltos
                    </span>
                  </div>

                  <div className="flex flex-wrap gap-2 pt-3 border-t">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setExpandedEntity(isExpanded ? null : `${entidad.tipo}_${entidad.id}`)}
                    >
                      {isExpanded ? <ChevronUp className="h-4 w-4 mr-1" /> : <ChevronDown className="h-4 w-4 mr-1" />}
                      Ver Historial
                    </Button>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => generarPDFSaldo(entidad)}
                    >
                      <FileDown className="h-4 w-4 mr-1" />
                      PDF
                    </Button>
                  </div>

                  {isExpanded && (
                    <div className="mt-4 pt-4 border-t">
                      <h4 className="font-semibold text-sm mb-3">Historial de Movimientos</h4>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-slate-50">
                            <tr>
                              <th className="text-left p-2">Fecha</th>
                              <th className="text-left p-2">Tipo</th>
                              <th className="text-left p-2">Envases</th>
                            </tr>
                          </thead>
                          <tbody>
                           {entidad.historial.map((h, idx) => (
                             <tr key={idx} className="border-b">
                               <td className="p-2">{format(new Date(h.fecha), 'dd/MM/yy HH:mm', { locale: es })}</td>
                               <td className="p-2">
                                 <div className="flex flex-col">
                                   <span>{h.tipo}</span>
                                   {h.remito && <span className="text-xs text-slate-500">{h.remito}</span>}
                                 </div>
                               </td>
                               <td className="p-2 text-xs">
                                 {h.envases?.map((e, i) => (
                                   <div key={i}>
                                     {e.envase_tipo}: 
                                     {e.cantidad_ingreso > 0 && <span className="text-green-600"> +{e.cantidad_ingreso}</span>}
                                     {e.cantidad_salida > 0 && <span className="text-red-600"> -{e.cantidad_salida}</span>}
                                   </div>
                                 ))}
                                 {h.envases_llenos?.map((e, i) => (
                                   <div key={i} className="text-purple-600 font-medium">
                                     {e.envase_tipo}: -{e.cantidad} llenos
                                   </div>
                                 ))}
                               </td>
                             </tr>
                           ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            )})}
          </div>
          ))}
          </div>
          </div>
          );
          }
</file>

<file path="src/pages/SalidaFruta.jsx">
import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Plus, Loader2, ShoppingCart, Truck, Trash2, Package } from "lucide-react";
import { format } from "date-fns";
import SearchableSelect from "@/components/SearchableSelect";
import DetalleLineItem from "@/components/DetalleLineItem";
import EnvaseLineItemLlenos from "@/components/EnvaseLineItemLlenos";
import ConfirmDetalleModal from "@/components/ConfirmDetalleModal";
import ConfirmEnvaseModal from "@/components/ConfirmEnvaseModal";
import QuickCreateModal from "@/components/QuickCreateModal";
import GenericSuccessModal from "@/components/GenericSuccessModal";
import { toast } from "sonner";
import { toFixed2 } from "@/components/utils/precisionDecimal";
import { invalidarTodoElSistema } from '@/utils/queryHelpers';
import { actualizarSaldoEntidad } from '@/utils/contabilidad';
import { ajustarStockProducto, ajustarStockEnvase } from '@/services/StockService';

export default function SalidaFruta({ embedded = false }) {
  const queryClient = useQueryClient();
  
  const [fecha, setFecha] = useState(format(new Date(), "yyyy-MM-dd'T'HH:mm"));
  const [numeroRemito, setNumeroRemito] = useState('');
  const [clienteId, setClienteId] = useState('');
  const [fleteroId, setFleteroId] = useState('');
  const [notas, setNotas] = useState('');
  const [detalles, setDetalles] = useState([]);
  const [envasesLlenos, setEnvasesLlenos] = useState([]);
  const [envaseActual, setEnvaseActual] = useState({
    envase_id: '',
    envase_tipo: '',
    cantidad: 0
  });
  
  const [detalleActual, setDetalleActual] = useState({
    producto_id: '',
    producto_nombre: '',
    kilos_salida: 0,
    stock_disponible: 0
  });

  const [confirmDetalleModal, setConfirmDetalleModal] = useState({ open: false, detalle: null });
  const [createModal, setCreateModal] = useState({ open: false, type: null });
  const [successModal, setSuccessModal] = useState({ open: false, data: null });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const { data: clientes = [] } = useQuery({
    queryKey: ['clientes'],
    queryFn: () => base44.entities.Cliente.list(),
  });

  const { data: fleteros = [] } = useQuery({
    queryKey: ['fleteros'],
    queryFn: () => base44.entities.Fletero.list(),
  });

  const { data: productos = [] } = useQuery({
    queryKey: ['productos'],
    queryFn: () => base44.entities.Producto.list(),
  });

  const { data: envasesList = [] } = useQuery({
    queryKey: ['envases'],
    queryFn: () => base44.entities.Envase.list(),
  });

  const { data: salidas = [] } = useQuery({
    queryKey: ['salidas'],
    queryFn: () => base44.entities.SalidaFruta.list('-created_date'),
  });

  const { data: movimientos = [] } = useQuery({
    queryKey: ['movimientos'],
    queryFn: () => base44.entities.Movimiento.list(),
  });

  const { data: periodosPrecios = [] } = useQuery({
    queryKey: ['periodosprecios'],
    queryFn: () => base44.entities.PeriodoPrecio.list()
  });

  // Autogenerar remito al inicio
  React.useEffect(() => {
    if (!numeroRemito) {
      setNumeroRemito(generarNumeroRemito());
    }
  }, [salidas]);

  const productosConCompleto = productos.map(p => ({
    ...p,
    producto_completo: `${p.fruta} - ${p.variedad}`
  }));

  // Calcular stock REAL de envases ocupados desde movimientos
  const stockEnvasesOcupados = React.useMemo(() => {
    const stockPorTipo = {};
    
    // Procesar ENVASES LLENOS en Ingreso de Fruta
    movimientos.forEach(m => {
      if (m.tipo_movimiento === 'Ingreso de Fruta' && m.envases_llenos) {
        m.envases_llenos.forEach(e => {
          if (!stockPorTipo[e.envase_id]) {
            stockPorTipo[e.envase_id] = { tipo: e.envase_tipo, ocupados: 0 };
          }
          stockPorTipo[e.envase_id].ocupados += (e.cantidad || 0);
        });
      }
    });
    
    // Procesar ENVASES LLENOS en Salida de Fruta
    salidas.forEach(s => {
      if (s.envases_llenos) {
        s.envases_llenos.forEach(e => {
          if (!stockPorTipo[e.envase_id]) {
            stockPorTipo[e.envase_id] = { tipo: e.envase_tipo, ocupados: 0 };
          }
          stockPorTipo[e.envase_id].ocupados -= (e.cantidad || 0);
        });
      }
    });
    
    return stockPorTipo;
  }, [movimientos, salidas]);

  const crearClienteMutation = useMutation({
    mutationFn: (data) => base44.entities.Cliente.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['clientes'] });
      setCreateModal({ open: false, type: null });
      toast.success('Cliente creado exitosamente');
    },
  });

  const crearFleteroMutation = useMutation({
    mutationFn: (data) => base44.entities.Fletero.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['fleteros'] });
      setCreateModal({ open: false, type: null });
      toast.success('Fletero creado exitosamente');
    },
  });

  const crearProductoMutation = useMutation({
    mutationFn: async (data) => {
      const nuevoProducto = {
        ...data,
        producto_completo: `${data.fruta} - ${data.variedad}`,
        stock: 0
      };
      return base44.entities.Producto.create(nuevoProducto);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['productos'] });
      setCreateModal({ open: false, type: null });
      toast.success('Producto creado exitosamente');
    },
  });

  const crearEnvaseMutation = useMutation({
    mutationFn: (data) => base44.entities.Envase.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['envases'] });
      setCreateModal({ open: false, type: null });
      toast.success('Envase creado exitosamente');
    },
  });

  const handleAgregarDetalle = () => {
    if (!detalleActual.producto_id) {
      alert('Por favor seleccione un producto');
      return;
    }
    if (detalleActual.kilos_salida <= 0) {
      alert('Por favor ingrese kilos v√°lidos');
      return;
    }
    if (detalleActual.kilos_salida > detalleActual.stock_disponible) {
      alert(`Stock insuficiente. Disponible: ${detalleActual.stock_disponible.toFixed(2)} kg | Solicitado: ${detalleActual.kilos_salida.toFixed(2)} kg | Faltante: ${(detalleActual.kilos_salida - detalleActual.stock_disponible).toFixed(2)} kg`);
      return;
    }
    
    setConfirmDetalleModal({ open: true, detalle: detalleActual });
  };

  const confirmarDetalle = () => {
    setDetalles([...detalles, {
      ...confirmDetalleModal.detalle,
      kilos_reales: confirmDetalleModal.detalle.kilos_salida,
      descuento_kg: 0
    }]);
    setConfirmDetalleModal({ open: false, detalle: null });
    setDetalleActual({
      producto_id: '',
      producto_nombre: '',
      kilos_salida: 0,
      stock_disponible: 0
    });
  };

  const updateDetalleActual = (data) => {
    setDetalleActual(data);
  };

  const removeDetalle = (index) => {
    setDetalles(detalles.filter((_, i) => i !== index));
  };

  const generarNumeroRemito = () => {
    const ultimaSalida = salidas[0];
    if (!ultimaSalida?.numero_remito) {
      return 'R00001-00000001';
    }
    
    const [parte1, parte2] = ultimaSalida.numero_remito.split('-');
    const numero = parseInt(parte2) + 1;
    return `R00001-${numero.toString().padStart(8, '0')}`;
  };

  const handleSubmit = async () => {
    if (!clienteId) {
      alert('Por favor seleccione un cliente');
      return;
    }

    if (detalles.length === 0) {
      alert('Por favor agregue al menos un producto');
      return;
    }

    if (!numeroRemito.trim()) {
      alert('Por favor ingrese un n√∫mero de remito');
      return;
    }

    // Validar que no exista duplicado
    const existeRemito = salidas.find(s => s.numero_remito === numeroRemito.trim());
    if (existeRemito) {
      alert(`El remito "${numeroRemito}" ya existe. Por favor use un n√∫mero diferente.`);
      return;
    }

    // Validar stock de productos
    for (const detalle of detalles) {
      const producto = productos.find(p => p.id === detalle.producto_id);
      if (producto && detalle.kilos_salida > (producto.stock || 0)) {
        alert(`Error: Producto "${detalle.producto_nombre}" - Stock insuficiente. Disponible: ${producto.stock.toFixed(2)} kg, Solicitado: ${detalle.kilos_salida.toFixed(2)} kg`);
        return;
      }
    }

    // Validar stock de envases llenos por tipo (usar stock REAL calculado)
    for (const envLleno of envasesLlenos) {
      if (envLleno.cantidad > 0) {
        const stockReal = stockEnvasesOcupados[envLleno.envase_id];
        const disponible = Math.max(0, stockReal?.ocupados || 0);
        if (envLleno.cantidad > disponible) {
          alert(`Error: Stock de "${envLleno.envase_tipo}" ocupados insuficiente. Disponible: ${disponible}, Solicitado: ${envLleno.cantidad}`);
          return;
        }
      }
    }

    setIsSubmitting(true);

    try {
      const cliente = clientes.find(c => c.id === clienteId);
      const fletero = fleteros.find(f => f.id === fleteroId);

      // Obtener precios vigentes para cada producto
      const obtenerPrecioVigente = (productoId, fecha) => {
        const preciosOrdenados = periodosPrecios
          .filter(pp => pp.producto_id === productoId && pp.activo)
          .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
        
        const fechaMovimiento = new Date(fecha);
        const precioVigente = preciosOrdenados.find(pp => new Date(pp.fecha_desde) <= fechaMovimiento);
        
        if (precioVigente) {
          return precioVigente.precio_venta_kg;
        }
        
        const precioMasReciente = preciosOrdenados[0];
        return precioMasReciente?.precio_venta_kg || 0;
      };

      // Agregar precio_kg a cada detalle (precio de venta)
      const detallesConPrecio = detalles.map(d => {
        const precioVenta = obtenerPrecioVigente(d.producto_id, fecha);
        return {
          ...d,
          precio_kg: precioVenta,
          kilos_reales: d.kilos_salida,
          descuento_kg: 0,
          motivo_ajuste: ''
        };
      });

      // Calcular deuda total de la salida
      const deudaTotalSalida = detallesConPrecio.reduce((sum, d) => {
        return sum + (d.kilos_salida * d.precio_kg);
      }, 0);

      const salidaData = {
        numero_remito: numeroRemito.trim(),
        fecha: new Date(fecha).toISOString(),
        cliente_id: clienteId,
        cliente_nombre: cliente?.nombre || '',
        fletero_id: fleteroId || null,
        fletero_nombre: fletero?.nombre || '',
        estado: 'Pendiente de Confirmaci√≥n',
        detalles: detallesConPrecio,
        envases_llenos: envasesLlenos.filter(e => e.cantidad > 0),
        deuda_total: deudaTotalSalida,
        estado_cobro: 'Pendiente',
        monto_cobrado: 0,
        notas: notas
      };

      const nuevaSalida = await base44.entities.SalidaFruta.create(salidaData);

      // Agrupar detalles por producto y sumar kilos a restar
      const stockAPorProducto = {};
      detalles.forEach(detalle => {
        if (detalle.producto_id && detalle.kilos_salida) {
          if (!stockAPorProducto[detalle.producto_id]) {
            stockAPorProducto[detalle.producto_id] = 0;
          }
          stockAPorProducto[detalle.producto_id] += detalle.kilos_salida;
        }
      });
      
      // Ajustar stock vivo de productos (incremental, negativo = salida)
      for (const [productoId, totalSalida] of Object.entries(stockAPorProducto)) {
        await ajustarStockProducto(base44, productoId, -totalSalida);
      }

      // Ajustar stock vivo de envases ocupados (restar)
      for (const envLleno of nuevaSalida.envases_llenos || []) {
        if (envLleno.cantidad > 0 && envLleno.envase_id) {
          await ajustarStockEnvase(base44, envLleno.envase_id, -envLleno.cantidad, 0);
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CREAR MOVIMIENTO EN CUENTA CORRIENTE - AUMENTA DEUDA CLIENTE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      if (deudaTotalSalida > 0) {
        // Obtener el saldo anterior de este cliente
        const movimientosCliente = await base44.entities.CuentaCorriente.filter({
          entidad_tipo: 'Cliente',
          entidad_id: clienteId
        }, '-fecha');
        const saldoAnterior = movimientosCliente.length > 0 ? (movimientosCliente[0].saldo_resultante || 0) : 0;
        const nuevoSaldo = saldoAnterior + deudaTotalSalida;

        await base44.entities.CuentaCorriente.create({
          fecha: new Date(fecha).toISOString(),
          tipo_movimiento: 'Haber',
          entidad_tipo: 'Cliente',
          entidad_id: clienteId,
          entidad_nombre: cliente?.nombre || '',
          monto: deudaTotalSalida,
          saldo_resultante: nuevoSaldo,
          concepto: `Salida de Fruta - ${numeroRemito.trim()}`,
          comprobante_id: nuevaSalida.id,
          comprobante_tipo: 'SalidaFruta'
        });
        await actualizarSaldoEntidad(base44, 'Cliente', clienteId, deudaTotalSalida);
      }

      // Invalidar todas las queries del sistema
      invalidarTodoElSistema(queryClient);

      setSuccessModal({ open: true, data: { ...nuevaSalida, cliente_whatsapp: cliente?.whatsapp } });
      
    } catch (error) {
      console.error('Error al registrar salida:', error);
      alert('Error al registrar la salida');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDownloadPDF = () => {
    import('@/components/SalidaPDFGenerator').then(({ generateSalidaPDF, downloadSalidaPDF }) => {
      const html = generateSalidaPDF(successModal.data);
      downloadSalidaPDF(html, successModal.data.numero_remito);
    });
  };

  const handleShareWhatsApp = async () => {
    const cliente = clientes.find(c => c.id === clienteId);
    const { shareSalidaWhatsApp } = await import('@/components/SalidaPDFGenerator');
    await shareSalidaWhatsApp(successModal.data, cliente?.whatsapp);
  };

  const resetForm = () => {
    setFecha(format(new Date(), "yyyy-MM-dd'T'HH:mm"));
    setNumeroRemito(generarNumeroRemito());
    setClienteId('');
    setFleteroId('');
    setNotas('');
    setDetalles([]);
    setEnvasesLlenos([]);
    setEnvaseActual({ envase_id: '', envase_tipo: '', cantidad: 0 });
    setDetalleActual({
      producto_id: '',
      producto_nombre: '',
      kilos_salida: 0,
      stock_disponible: 0
    });
  };

  return (
    <div className={embedded ? "" : "min-h-screen bg-slate-50 p-4 md:p-6 lg:p-8"}>
      <div className={embedded ? "" : "max-w-5xl mx-auto space-y-6"}>
        {!embedded && (
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
              <ShoppingCart className="h-8 w-8 text-purple-600" />
              Salida de Fruta
            </h1>
            <p className="text-slate-600 mt-1">Registrar salida de productos a clientes</p>
          </div>
        )}

        <form onSubmit={(e) => { e.preventDefault(); handleSubmit(); }} className="space-y-6">
          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold">Informaci√≥n General</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-1 block">Comprobante Asociado (Remito R) *</label>
                  <Input
                    type="text"
                    value={numeroRemito}
                    onChange={(e) => setNumeroRemito(e.target.value)}
                    className="font-mono"
                    placeholder="R00001-00000001"
                    required
                  />
                  <p className="text-xs text-slate-500 mt-1">N√∫mero completo editable</p>
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-1 block">Fecha y Hora</label>
                  <Input
                    type="datetime-local"
                    value={fecha}
                    onChange={(e) => setFecha(e.target.value)}
                  />
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-1 block">Cliente *</label>
                  <SearchableSelect
                    options={clientes}
                    value={clienteId}
                    onChange={(id) => setClienteId(id)}
                    displayKey="nombre"
                    placeholder="Seleccionar cliente..."
                    onCreateNew={() => setCreateModal({ open: true, type: 'cliente' })}
                    createNewLabel="Crear nuevo cliente"
                  />
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 mb-1 block">Fletero (Opcional)</label>
                  <SearchableSelect
                    options={fleteros}
                    value={fleteroId}
                    onChange={(id) => setFleteroId(id)}
                    displayKey="nombre"
                    placeholder="Seleccionar fletero..."
                    onCreateNew={() => setCreateModal({ open: true, type: 'fletero' })}
                    createNewLabel="Crear nuevo fletero"
                  />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold flex items-center gap-2">
                <ShoppingCart className="h-5 w-5 text-slate-400" />
                Nuevo Detalle de Salida
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <DetalleLineItem
                  item={detalleActual}
                  index={0}
                  productos={productosConCompleto}
                  onChange={(_, data) => updateDetalleActual(data)}
                  onCreateProducto={() => setCreateModal({ open: true, type: 'producto' })}
                />
                
                <div className="flex justify-end">
                  <Button 
                    type="button"
                    onClick={handleAgregarDetalle}
                    className="bg-purple-600 hover:bg-purple-700"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Agregar a Lista
                  </Button>
                </div>
              </div>

              {detalles.length > 0 && (
                <div className="mt-6 pt-6 border-t">
                  <div className="flex items-center justify-between mb-3">
                    <h4 className="font-semibold text-slate-700">Productos Agregados ({detalles.length})</h4>
                    <span className="text-sm text-slate-600">
                      Total: <strong>{detalles.reduce((s, d) => s + d.kilos_salida, 0).toFixed(2)} kg</strong>
                    </span>
                  </div>
                  <div className="space-y-3">
                    {detalles.map((detalle, index) => (
                      <div key={index} className="p-3 bg-purple-50 rounded-lg border border-purple-200">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <p className="font-medium text-slate-800">{detalle.producto_nombre}</p>
                            <p className="text-sm text-slate-600 mt-1">
                              Kilos: <strong className="text-purple-700">{detalle.kilos_salida.toFixed(2)} kg</strong>
                            </p>
                          </div>
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            onClick={() => removeDetalle(index)}
                            className="text-red-500 hover:text-red-700 hover:bg-red-50 ml-2"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>

          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardHeader className="pb-4">
              <CardTitle className="text-lg font-semibold flex items-center gap-2">
                <Package className="h-5 w-5 text-slate-400" />
                Envases Llenos con Fruta
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <EnvaseLineItemLlenos
                  item={envaseActual}
                  index={0}
                  envases={envasesList}
                  onChange={(_, data) => setEnvaseActual(data)}
                  onRemove={() => {}}
                  onCreateEnvase={() => setCreateModal({ open: true, type: 'envase' })}
                  showRemove={false}
                />
                
                <div className="flex justify-end">
                  <Button 
                    type="button"
                    onClick={() => {
                      if (!envaseActual.envase_id || envaseActual.cantidad <= 0) {
                        alert('Seleccione un envase y cantidad v√°lida');
                        return;
                      }
                      setEnvasesLlenos([...envasesLlenos, envaseActual]);
                      setEnvaseActual({ envase_id: '', envase_tipo: '', cantidad: 0 });
                    }}
                    className="bg-amber-600 hover:bg-amber-700"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Agregar
                  </Button>
                </div>

                {/* Lista de envases agregados */}
                {envasesLlenos.length > 0 && (
                  <div className="mt-4 pt-4 border-t">
                    <h4 className="font-semibold text-slate-700 mb-3">Envases Llenos Agregados</h4>
                    <div className="space-y-2">
                      {envasesLlenos.map((env, idx) => (
                        <div key={idx} className="p-3 bg-amber-50 rounded-lg border border-amber-200 flex items-center justify-between">
                          <div>
                            <p className="font-medium text-slate-800">{env.envase_tipo}</p>
                            <p className="text-sm text-amber-700">Cantidad: {env.cantidad} llenos</p>
                          </div>
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            onClick={() => setEnvasesLlenos(envasesLlenos.filter((_, i) => i !== idx))}
                            className="text-red-500 hover:text-red-700"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="flex items-start gap-2">
                    <Package className="h-4 w-4 text-blue-600 mt-0.5 flex-shrink-0" />
                    <div className="text-xs text-blue-900">
                      <p className="font-semibold mb-1">‚ÑπÔ∏è Nota importante:</p>
                      <p>Los envases vac√≠os se gestionan en "Movimiento de Envases". Aqu√≠ solo registre envases que salen llenos con fruta ‚Üí se restan de Stock Ocupados.</p>
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card className="border-0 shadow-lg shadow-slate-200/50">
            <CardContent className="pt-6">
              <label className="text-sm font-medium text-slate-700 mb-1 block">Notas Adicionales</label>
              <Textarea
                value={notas}
                onChange={(e) => setNotas(e.target.value)}
                placeholder="Observaciones adicionales..."
                rows={3}
              />
            </CardContent>
          </Card>

          <div className="flex justify-end gap-3">
            <Button 
              type="submit" 
              size="lg" 
              disabled={isSubmitting}
              className="bg-purple-600 hover:bg-purple-700"
            >
              {isSubmitting ? (
                <>
                  <Loader2 className="h-5 w-5 mr-2 animate-spin" />
                  Registrando...
                </>
              ) : (
                <>
                  <ShoppingCart className="h-5 w-5 mr-2" />
                  Registrar Salida
                </>
              )}
            </Button>
          </div>
        </form>
      </div>

      <ConfirmDetalleModal
        open={confirmDetalleModal.open}
        onClose={() => setConfirmDetalleModal({ open: false, detalle: null })}
        detalle={confirmDetalleModal.detalle}
        onConfirm={confirmarDetalle}
        onEdit={() => setConfirmDetalleModal({ open: false, detalle: null })}
      />

      <QuickCreateModal
        open={createModal.open && createModal.type === 'cliente'}
        onClose={() => setCreateModal({ open: false, type: null })}
        onSave={(data) => crearClienteMutation.mutate(data)}
        title="Crear Nuevo Cliente"
        fields={[
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del cliente', type: 'text' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n', type: 'text' },
          { name: 'cuit', label: 'CUIT', placeholder: 'CUIT', type: 'text' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54...', type: 'text' }
        ]}
        isLoading={crearClienteMutation.isPending}
      />

      <QuickCreateModal
        open={createModal.open && createModal.type === 'fletero'}
        onClose={() => setCreateModal({ open: false, type: null })}
        onSave={(data) => crearFleteroMutation.mutate(data)}
        title="Crear Nuevo Fletero"
        fields={[
          { name: 'nombre', label: 'Nombre', placeholder: 'Nombre del fletero', type: 'text' },
          { name: 'direccion', label: 'Direcci√≥n', placeholder: 'Direcci√≥n', type: 'text' },
          { name: 'whatsapp', label: 'WhatsApp', placeholder: '+54...', type: 'text' }
        ]}
        isLoading={crearFleteroMutation.isPending}
      />

      <QuickCreateModal
        open={createModal.open && createModal.type === 'producto'}
        onClose={() => setCreateModal({ open: false, type: null })}
        onSave={(data) => crearProductoMutation.mutate(data)}
        title="Crear Nuevo Producto"
        fields={[
          { name: 'fruta', label: 'Fruta', placeholder: 'Ej: Manzana', type: 'text' },
          { name: 'variedad', label: 'Variedad', placeholder: 'Ej: Red Delicious', type: 'text' }
        ]}
        isLoading={crearProductoMutation.isPending}
      />

      <QuickCreateModal
        open={createModal.open && createModal.type === 'envase'}
        onClose={() => setCreateModal({ open: false, type: null })}
        onSave={(data) => crearEnvaseMutation.mutate(data)}
        title="Crear Nuevo Envase"
        fields={[
          { name: 'tipo', label: 'Tipo de Envase', placeholder: 'Ej: Bin Pl√°stico', type: 'text' },
          { name: 'tara', label: 'Tara (kg)', placeholder: '0.00', type: 'number' }
        ]}
        isLoading={crearEnvaseMutation.isPending}
      />

      <GenericSuccessModal
        open={successModal.open}
        onClose={() => {
          setSuccessModal({ open: false, data: null });
          resetForm();
        }}
        title="¬°Salida Registrada!"
        message="El movimiento se ha registrado correctamente"
        onDownloadPDF={handleDownloadPDF}
        onShareWhatsApp={handleShareWhatsApp}
      />
    </div>
  );
}
</file>

<file path="src/pages/Tesoreria.jsx">
import React, { useMemo } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { 
  Wallet, 
  Landmark, 
  PiggyBank, 
  CreditCard, 
  TrendingUp, 
  TrendingDown, 
  AlertTriangle,
  Users,
  Building2,
  Loader2,
  ArrowRight,
  DollarSign
} from 'lucide-react';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function Tesoreria() {
  const { data: cajas = [], isLoading: loadingCajas } = useQuery({
    queryKey: ['cajas'],
    queryFn: () => base44.entities.Caja.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: bancos = [], isLoading: loadingBancos } = useQuery({
    queryKey: ['bancos'],
    queryFn: () => base44.entities.Banco.list(),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cheques = [], isLoading: loadingCheques } = useQuery({
    queryKey: ['cheques'],
    queryFn: () => base44.entities.Cheque.list('-fecha_pago', 100),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientosCC = [], error: errorCC } = useQuery({
    queryKey: ['cuentacorriente'],
    queryFn: () => base44.entities.CuentaCorriente.list('-fecha', 50),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: movimientosTesoreria = [] } = useQuery({
    queryKey: ['movimientostesoreria'],
    queryFn: () => base44.entities.MovimientoTesoreria.list('-fecha', 50),
    staleTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: cobros = [] } = useQuery({
    queryKey: ['cobros'],
    queryFn: () => base44.entities.Cobro.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const { data: pagos = [] } = useQuery({
    queryKey: ['pagos'],
    queryFn: () => base44.entities.Pago.list('-fecha', 50),
    staleTime: 5 * 60 * 1000,
    refetchOnWindowFocus: false
  });

  const isLoading = loadingCajas || loadingBancos || loadingCheques;
  const hasError = errorCC;

  if (hasError) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
        <Card className="border-red-200 bg-red-50 max-w-md">
          <CardContent className="p-8 text-center">
            <AlertTriangle className="h-12 w-12 text-red-600 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-red-900 mb-2">Error al cargar tesorer√≠a</h3>
            <p className="text-red-700">No se pudieron cargar los datos financieros. Recarga la p√°gina.</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // KPIs principales - Memoizados para evitar rec√°lculos innecesarios
  const totalCajas = useMemo(() => 
    cajas.reduce((sum, c) => sum + (c.saldo || 0), 0), 
    [cajas]
  );
  
  const totalBancos = useMemo(() => 
    bancos.reduce((sum, b) => sum + (b.saldo || 0), 0), 
    [bancos]
  );
  
  const totalLiquido = useMemo(() => totalCajas + totalBancos, [totalCajas, totalBancos]);

  const chequesEnCartera = useMemo(() => 
    cheques.filter(ch => ch.estado === 'En Cartera'), 
    [cheques]
  );
  
  const totalChequesCartera = useMemo(() => 
    chequesEnCartera.reduce((sum, ch) => sum + (ch.monto || 0), 0), 
    [chequesEnCartera]
  );

  // Alertas - Memoizadas
  const bancosConSaldoBajo = useMemo(() => 
    bancos.filter(b => b.activa && b.saldo < b.saldo_minimo), 
    [bancos]
  );
  
  const chequesProxVencer = useMemo(() => {
    const hoy = new Date();
    return cheques.filter(ch => {
      if (ch.estado !== 'En Cartera' || !ch.fecha_pago) return false;
      const diasRestantes = Math.floor((new Date(ch.fecha_pago) - hoy) / (1000 * 60 * 60 * 24));
      return diasRestantes <= 7 && diasRestantes >= 0;
    });
  }, [cheques]);

  // Deudas de cuenta corriente - obtener el saldo m√°s reciente por entidad - Memoizado
  const saldosPorEntidad = useMemo(() => {
    return movimientosCC.reduce((acc, mov) => {
      const key = `${mov.entidad_tipo}_${mov.entidad_id}`;
      if (!acc[key] || new Date(mov.fecha) > new Date(acc[key].fecha)) {
        acc[key] = {
          entidad_tipo: mov.entidad_tipo,
          saldo_resultante: mov.saldo_resultante || 0,
          fecha: mov.fecha
        };
      }
      return acc;
    }, {});
  }, [movimientosCC]);

  // CLIENTES: Deuda total (lo que nos deben) - Memoizado
  const deudaClientes = useMemo(() => 
    Object.values(saldosPorEntidad)
      .filter(e => e.entidad_tipo === 'Cliente' && e.saldo_resultante > 0)
      .reduce((sum, e) => sum + e.saldo_resultante, 0),
    [saldosPorEntidad]
  );

  // PROVEEDORES: Deuda total (lo que les debemos) - Memoizado
  const deudaProveedores = useMemo(() => 
    Object.values(saldosPorEntidad)
      .filter(e => e.entidad_tipo === 'Proveedor' && e.saldo_resultante > 0)
      .reduce((sum, e) => sum + e.saldo_resultante, 0),
    [saldosPorEntidad]
  );

  // Crear Map para b√∫squedas r√°pidas - Memoizado
  const cobrosMap = useMemo(() => 
    new Map(cobros.map(c => [c.id, c])), 
    [cobros]
  );
  
  const pagosMap = useMemo(() => 
    new Map(pagos.map(p => [p.id, p])), 
    [pagos]
  );
  
  const movimientosTesoreriaMap = useMemo(() => {
    const map = new Map();
    movimientosTesoreria.forEach(m => {
      const key = `${m.referencia_origen_tipo}_${m.referencia_origen_id}`;
      if (!map.has(key)) {
        map.set(key, true);
      }
    });
    return map;
  }, [movimientosTesoreria]);

  // Filtrar movimientos de CC v√°lidos - Optimizado con Maps - Memoizado
  const movimientosCCValidos = useMemo(() => {
    return movimientosCC.filter(movCC => {
      if (!movCC.comprobante_id || !movCC.comprobante_tipo) return true;
      
      if (movCC.comprobante_tipo === 'Cobro' || movCC.comprobante_tipo === 'Retencion') {
        if (!cobrosMap.has(movCC.comprobante_id)) return false;
        const key = `Cobro_${movCC.comprobante_id}`;
        return movimientosTesoreriaMap.has(key);
      }
      
      if (movCC.comprobante_tipo === 'Pago') {
        if (!pagosMap.has(movCC.comprobante_id)) return false;
        const key = `Pago_${movCC.comprobante_id}`;
        return movimientosTesoreriaMap.has(key);
      }
      
      return true;
    });
  }, [movimientosCC, cobrosMap, pagosMap, movimientosTesoreriaMap]);

  // CLIENTES: Cobros realizados (usando movimientos v√°lidos) - Memoizado
  const cobrosRealizados = useMemo(() => 
    movimientosCCValidos
      .filter(cc => cc.entidad_tipo === 'Cliente' && cc.tipo_movimiento === 'Debe')
      .reduce((sum, cc) => sum + (cc.monto || 0), 0),
    [movimientosCCValidos]
  );

  // PROVEEDORES: Pagos realizados (usando movimientos v√°lidos) - Memoizado
  const pagosRealizados = useMemo(() => 
    movimientosCCValidos
      .filter(cc => cc.entidad_tipo === 'Proveedor' && cc.tipo_movimiento === 'Debe')
      .reduce((sum, cc) => sum + (cc.monto || 0), 0),
    [movimientosCCValidos]
  );

  // Movimientos recientes (√∫ltimos 5) - Memoizado
  const movimientosRecientes = useMemo(() => 
    movimientosTesoreria.slice(0, 5),
    [movimientosTesoreria]
  );

  if (isLoading) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <Loader2 className="h-12 w-12 animate-spin text-indigo-600" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-3">
            <Wallet className="h-8 w-8 text-indigo-600" />
            Tesorer√≠a Estrat√©gica
          </h1>
          <p className="text-slate-500 mt-1">Panel de control financiero</p>
        </div>

        {/* Alertas */}
        {(bancosConSaldoBajo.length > 0 || chequesProxVencer.length > 0) && (
          <Card className="mb-6 border-amber-200 bg-amber-50">
            <CardContent className="p-4">
              <div className="flex items-start gap-3">
                <AlertTriangle className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />
                <div className="space-y-1">
                  <p className="font-medium text-amber-900">Alertas de Tesorer√≠a</p>
                  {bancosConSaldoBajo.length > 0 && (
                    <p className="text-sm text-amber-700">
                      ‚Ä¢ {bancosConSaldoBajo.length} banco(s) con saldo por debajo del m√≠nimo
                    </p>
                  )}
                  {chequesProxVencer.length > 0 && (
                    <p className="text-sm text-amber-700">
                      ‚Ä¢ {chequesProxVencer.length} cheque(s) pr√≥ximo(s) a vencer en los pr√≥ximos 7 d√≠as
                    </p>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        {/* KPIs Principales */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Liquidez Total</p>
                  <p className="text-2xl font-bold text-indigo-600">
                    ${totalLiquido.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <Wallet className="h-10 w-10 text-indigo-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">En Cajas</p>
                  <p className="text-2xl font-bold text-green-600">
                    ${totalCajas.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <PiggyBank className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">En Bancos</p>
                  <p className="text-2xl font-bold text-blue-600">
                    ${totalBancos.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <Landmark className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Cheques en Cartera</p>
                  <p className="text-2xl font-bold text-purple-600">
                    ${totalChequesCartera.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                </div>
                <CreditCard className="h-10 w-10 text-purple-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Cuentas Corrientes */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Deuda Total Clientes</p>
                  <p className="text-2xl font-bold text-red-600">
                    ${deudaClientes.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                  <p className="text-xs text-slate-500 mt-1">A cobrar</p>
                </div>
                <TrendingUp className="h-10 w-10 text-red-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Cobros Realizados</p>
                  <p className="text-2xl font-bold text-green-600">
                    ${cobrosRealizados.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                  <p className="text-xs text-slate-500 mt-1">Ya cobrado</p>
                </div>
                <DollarSign className="h-10 w-10 text-green-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Deuda Total Proveedores</p>
                  <p className="text-2xl font-bold text-orange-600">
                    ${deudaProveedores.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                  <p className="text-xs text-slate-500 mt-1">A pagar</p>
                </div>
                <TrendingDown className="h-10 w-10 text-orange-600 opacity-20" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Pagos Realizados</p>
                  <p className="text-2xl font-bold text-blue-600">
                    ${pagosRealizados.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                  </p>
                  <p className="text-xs text-slate-500 mt-1">Ya pagado</p>
                </div>
                <DollarSign className="h-10 w-10 text-blue-600 opacity-20" />
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Distribuci√≥n de Fondos */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {/* Cajas */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center gap-2">
                  <PiggyBank className="h-5 w-5 text-green-600" />
                  Cajas
                </span>
                <Link to={createPageUrl('Cajas')}>
                  <Button variant="ghost" size="sm">
                    Ver todas <ArrowRight className="h-4 w-4 ml-1" />
                  </Button>
                </Link>
              </CardTitle>
            </CardHeader>
            <CardContent>
              {cajas.length === 0 ? (
                <p className="text-center text-slate-500 py-4">No hay cajas registradas</p>
              ) : (
                <div className="space-y-3">
                  {cajas.slice(0, 5).map(caja => (
                    <div key={caja.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <p className="font-medium">{caja.nombre}</p>
                        {caja.ubicacion && (
                          <p className="text-sm text-slate-500">{caja.ubicacion}</p>
                        )}
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-green-600">
                          ${(caja.saldo || 0).toLocaleString('es-AR')}
                        </p>
                        {!caja.activa && (
                          <Badge variant="outline" className="mt-1">Inactiva</Badge>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Bancos */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center gap-2">
                  <Landmark className="h-5 w-5 text-blue-600" />
                  Bancos
                </span>
                <Link to={createPageUrl('Bancos')}>
                  <Button variant="ghost" size="sm">
                    Ver todas <ArrowRight className="h-4 w-4 ml-1" />
                  </Button>
                </Link>
              </CardTitle>
            </CardHeader>
            <CardContent>
              {bancos.length === 0 ? (
                <p className="text-center text-slate-500 py-4">No hay cuentas bancarias registradas</p>
              ) : (
                <div className="space-y-3">
                  {bancos.slice(0, 5).map(banco => (
                    <div key={banco.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <p className="font-medium">{banco.nombre}</p>
                        <p className="text-sm text-slate-500">{banco.numero_cuenta}</p>
                      </div>
                      <div className="text-right">
                        <p className={`font-bold ${banco.saldo < banco.saldo_minimo ? 'text-red-600' : 'text-blue-600'}`}>
                          ${(banco.saldo || 0).toLocaleString('es-AR')}
                        </p>
                        {banco.saldo < banco.saldo_minimo && (
                          <Badge variant="destructive" className="mt-1">Bajo m√≠nimo</Badge>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Cheques y Movimientos Recientes */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Cheques en Cartera */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center gap-2">
                  <CreditCard className="h-5 w-5 text-purple-600" />
                  Cheques en Cartera
                </span>
                <Link to={createPageUrl('Cheques')}>
                  <Button variant="ghost" size="sm">
                    Ver todos <ArrowRight className="h-4 w-4 ml-1" />
                  </Button>
                </Link>
              </CardTitle>
            </CardHeader>
            <CardContent>
              {chequesEnCartera.length === 0 ? (
                <p className="text-center text-slate-500 py-4">No hay cheques en cartera</p>
              ) : (
                <div className="space-y-3">
                  {chequesEnCartera.slice(0, 5).map(cheque => (
                    <div key={cheque.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <p className="font-medium">N¬∞ {cheque.numero_cheque}</p>
                        <p className="text-sm text-slate-500">
                          Vence: {cheque.fecha_pago ? format(new Date(cheque.fecha_pago), 'dd/MM/yyyy', { locale: es }) : '-'}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-purple-600">
                          ${(cheque.monto || 0).toLocaleString('es-AR')}
                        </p>
                        <Badge variant="outline" className="mt-1">{cheque.tipo}</Badge>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Movimientos Recientes */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center gap-2">
                  <TrendingUp className="h-5 w-5 text-teal-600" />
                  Movimientos Recientes
                </span>
                <Link to={createPageUrl('MovimientosTesoreria')}>
                  <Button variant="ghost" size="sm">
                    Ver todos <ArrowRight className="h-4 w-4 ml-1" />
                  </Button>
                </Link>
              </CardTitle>
            </CardHeader>
            <CardContent>
              {movimientosRecientes.length === 0 ? (
                <p className="text-center text-slate-500 py-4">No hay movimientos recientes</p>
              ) : (
                <div className="space-y-3">
                  {movimientosRecientes.map(mov => (
                    <div key={mov.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                      <div>
                        <p className="font-medium text-sm">{mov.concepto}</p>
                        <p className="text-xs text-slate-500">
                          {mov.fecha ? format(new Date(mov.fecha), 'dd/MM HH:mm', { locale: es }) : '-'}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="font-bold text-teal-600">
                          ${(mov.monto || 0).toLocaleString('es-AR')}
                        </p>
                        <Badge variant="outline" className="text-xs mt-1">
                          {mov.tipo_movimiento}
                        </Badge>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/services/CuentaCorrienteService.js">
/**
 * Servicio de Cuenta Corriente: actualizaci√≥n incremental de saldo_actual.
 * Proveedor y Cliente deben tener campo num√©rico saldo_actual.
 * Haber = aumenta deuda (delta > 0), Debe = disminuye (delta < 0).
 */

import { actualizarSaldoEntidad } from '@/utils/contabilidad';

/**
 * Ajusta el saldo vivo de una entidad en un monto delta.
 * @param {Object} base44 - Cliente base44
 * @param {string} entidadTipo - 'Cliente' | 'Proveedor'
 * @param {string} entidadId - ID de la entidad
 * @param {number} montoDelta - Monto a sumar al saldo (positivo = m√°s deuda, negativo = pago/cobro)
 */
export async function ajustarSaldo(base44, entidadTipo, entidadId, montoDelta) {
  await actualizarSaldoEntidad(base44, entidadTipo, entidadId, montoDelta);
}
</file>

<file path="src/services/StockService.js">
/**
 * Servicio de Stock: actualizaci√≥n incremental de stock (Producto y Envase).
 * Producto: campo stock (o stock_actual si el backend lo expone).
 * Envase: campos stock_ocupados y stock_vacios.
 * Una sola lectura + un solo .update() por entidad.
 */

/**
 * Ajusta el stock de un producto en cantidadDelta (positivo = ingreso, negativo = salida).
 * @param {Object} base44 - Cliente base44
 * @param {string} productoId - ID del producto
 * @param {number} cantidadDelta - Kilos a sumar (positivo) o restar (negativo)
 * @returns {Promise<void>}
 */
export async function ajustarStockProducto(base44, productoId, cantidadDelta) {
  if (!productoId || cantidadDelta === 0) return;
  const delta = Number(cantidadDelta);
  if (Number.isNaN(delta)) return;

  const list = await base44.entities.Producto.filter({ id: productoId });
  const producto = Array.isArray(list) ? list[0] : list;
  if (!producto) return;

  const stockActual = Number(producto.stock ?? producto.stock_actual ?? 0);
  const nuevoStock = Math.max(0, Math.round((stockActual + delta) * 100) / 100);

  await base44.entities.Producto.update(productoId, { stock: nuevoStock });
}

/**
 * Ajusta stock de envase: ocupados y/o vac√≠os.
 * @param {Object} base44 - Cliente base44
 * @param {string} envaseId - ID del envase
 * @param {number} deltaOcupados - Delta para stock_ocupados (default 0)
 * @param {number} deltaVacios - Delta para stock_vacios (default 0)
 */
export async function ajustarStockEnvase(base44, envaseId, deltaOcupados = 0, deltaVacios = 0) {
  if (!envaseId || (deltaOcupados === 0 && deltaVacios === 0)) return;

  const list = await base44.entities.Envase.filter({ id: envaseId });
  const envase = Array.isArray(list) ? list[0] : list;
  if (!envase) return;

  const ocupados = Math.max(0, (Number(envase.stock_ocupados) || 0) + Number(deltaOcupados));
  const vacios = Math.max(0, (Number(envase.stock_vacios) || 0) + Number(deltaVacios));

  await base44.entities.Envase.update(envaseId, {
    stock_ocupados: ocupados,
    stock_vacios: vacios
  });
}
</file>

<file path="src/utils/contabilidad.js">
/**
 * Utilidades para c√°lculos contables y de cuenta corriente
 */

/**
 * Actualiza el saldo vivo (saldo_actual) de una entidad Cliente o Proveedor.
 * Haber = aumenta deuda ‚Üí delta positivo. Debe = disminuye deuda ‚Üí delta negativo.
 * @param {Object} base44 - Instancia del cliente base44
 * @param {string} entidadTipo - 'Cliente' o 'Proveedor'
 * @param {string} entidadId - ID de la entidad
 * @param {number} delta - Monto a sumar al saldo_actual (positivo = m√°s deuda, negativo = menos deuda)
 * @returns {Promise<void>}
 */
export async function actualizarSaldoEntidad(base44, entidadTipo, entidadId, delta) {
  if (!entidadId || delta === 0) return;
  const numDelta = Number(delta);
  if (Number.isNaN(numDelta)) return;

  const list = entidadTipo === 'Cliente'
    ? await base44.entities.Cliente.filter({ id: entidadId })
    : await base44.entities.Proveedor.filter({ id: entidadId });
  const entity = Array.isArray(list) ? list[0] : list;

  if (!entity) return;
  const saldoActual = Number(entity.saldo_actual) || 0;
  const nuevoSaldo = Math.round((saldoActual + numDelta) * 100) / 100;

  if (entidadTipo === 'Cliente') {
    await base44.entities.Cliente.update(entidadId, { saldo_actual: nuevoSaldo });
  } else {
    await base44.entities.Proveedor.update(entidadId, { saldo_actual: nuevoSaldo });
  }
}

/**
 * Calcula los saldos acumulados (saldo_resultante) para una lista de movimientos de cuenta corriente
 * @param {Array} movimientos - Array de movimientos de CuentaCorriente ordenados por fecha
 * @returns {Array} - Array de movimientos con saldo_resultante calculado
 */
export function calcularSaldosAcumulados(movimientos) {
  if (!movimientos || movimientos.length === 0) return [];
  
  // Ordenar por fecha si no est√°n ordenados
  const movimientosOrdenados = [...movimientos].sort((a, b) => {
    const fechaA = new Date(a.fecha || 0);
    const fechaB = new Date(b.fecha || 0);
    return fechaA.getTime() - fechaB.getTime();
  });
  
  let saldoAcumulado = 0;
  const movimientosConSaldo = movimientosOrdenados.map(mov => {
    const monto = Number(mov.monto) || 0;
    
    // Haber = aumenta saldo (deuda), Debe = disminuye saldo (pago/cobro)
    if (mov.tipo_movimiento === 'Haber') {
      saldoAcumulado += monto;
    } else {
      saldoAcumulado -= monto;
    }
    
    return {
      ...mov,
      saldo_resultante: saldoAcumulado
    };
  });
  
  return movimientosConSaldo;
}

/**
 * Calcula el saldo resultante para un nuevo movimiento basado en el √∫ltimo saldo de la entidad
 * @param {number} saldoAnterior - Saldo anterior de la entidad
 * @param {number} monto - Monto del nuevo movimiento
 * @param {string} tipoMovimiento - 'Haber' o 'Debe'
 * @returns {number} - Nuevo saldo resultante
 */
export function calcularNuevoSaldo(saldoAnterior, monto, tipoMovimiento) {
  const montoNum = Number(monto) || 0;
  const saldoAnteriorNum = Number(saldoAnterior) || 0;
  
  if (tipoMovimiento === 'Haber') {
    return saldoAnteriorNum + montoNum;
  } else {
    return saldoAnteriorNum - montoNum;
  }
}

/**
 * Recalcula y actualiza los saldos resultantes para todos los movimientos de una entidad
 * √ötil para correcciones despu√©s de cambios en movimientos existentes
 * @param {Object} base44 - Instancia de base44 client
 * @param {string} entidadId - ID de la entidad (cliente o proveedor)
 * @param {string} entidadTipo - 'Cliente' o 'Proveedor'
 * @returns {Promise<number>} - Saldo final calculado
 */
export async function recalcularSaldosEntidad(base44, entidadId, entidadTipo) {
  const todosMovCC = await base44.entities.CuentaCorriente.list();
  const movsEntidad = todosMovCC
    .filter(m => m.entidad_id === entidadId && m.entidad_tipo === entidadTipo)
    .sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());
  
  const movimientosConSaldo = calcularSaldosAcumulados(movsEntidad);
  
  // Actualizar en base de datos
  for (const mov of movimientosConSaldo) {
    await base44.entities.CuentaCorriente.update(mov.id, {
      saldo_resultante: mov.saldo_resultante
    });
  }
  
  // Retornar el saldo final
  return movimientosConSaldo.length > 0 
    ? movimientosConSaldo[movimientosConSaldo.length - 1].saldo_resultante 
    : 0;
}

const DELAY_ENTRE_ENTIDADES_MS = 200;
const DELAY_ENTRE_LOTES_MS = 150;
const LOTE_MOVIMIENTOS = 100;
const LOTE_ENTIDADES = 100;

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/**
 * Obtiene todos los registros de una entidad paginando (evita 429).
 * @param {Function} fetchPage - (skip) => Promise<Array>
 * @param {string} nombreEntidad - Para mensajes de progreso
 * @param {Function} onProgress - (message) => void
 * @returns {Promise<Array>}
 */
async function obtenerTodosPaginado(fetchPage, nombreEntidad, onProgress) {
  const todos = [];
  let skip = 0;
  let loteNum = 0;
  while (true) {
    loteNum++;
    onProgress(`Descargando lote ${loteNum} de ${nombreEntidad}...`);
    const pagina = await fetchPage(skip);
    if (!pagina || pagina.length === 0) break;
    todos.push(...pagina);
    if (pagina.length < LOTE_ENTIDADES) break;
    skip += LOTE_ENTIDADES;
    await delay(DELAY_ENTRE_LOTES_MS);
  }
  return todos;
}

/**
 * Obtiene todos los movimientos de CuentaCorriente de una entidad en lotes.
 * @param {Object} base44
 * @param {string} entidadTipo - 'Proveedor' | 'Cliente'
 * @param {string} entidadId
 * @param {string} nombreEntidad - Para mensajes
 * @param {Function} onProgress - (message) => void
 * @returns {Promise<Array>}
 */
async function obtenerMovimientosEntidadPaginado(base44, entidadTipo, entidadId, nombreEntidad, onProgress) {
  const todos = [];
  let skip = 0;
  let loteNum = 0;
  while (true) {
    loteNum++;
    onProgress(`Descargando lote ${loteNum} de movimientos para ${nombreEntidad}...`);
    const pagina = await base44.entities.CuentaCorriente.filter(
      { entidad_tipo: entidadTipo, entidad_id: entidadId },
      'fecha',
      LOTE_MOVIMIENTOS,
      skip
    );
    if (!pagina || pagina.length === 0) break;
    todos.push(...pagina);
    if (pagina.length < LOTE_MOVIMIENTOS) break;
    skip += LOTE_MOVIMIENTOS;
    await delay(DELAY_ENTRE_LOTES_MS);
  }
  return todos;
}

/**
 * Calcula el saldo real a partir de movimientos de CC (Haber aumenta deuda, Debe la disminuye).
 * Saldo = suma(Haber) - suma(Debe).
 */
function calcularSaldoDesdeMovimientos(movimientos) {
  const ordenados = [...(movimientos || [])].sort(
    (a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime()
  );
  let saldo = 0;
  for (const mov of ordenados) {
    const monto = Number(mov.monto) || 0;
    if (mov.tipo_movimiento === 'Haber') saldo += monto;
    else saldo -= monto;
  }
  return Math.round(saldo * 100) / 100;
}

/**
 * Sincroniza saldo_actual de todos los Proveedores y Clientes desde el historial de CuentaCorriente.
 * Procesa en lotes y de forma secuencial para evitar 429.
 * Solo se ejecuta al llamar expl√≠citamente (ej. bot√≥n "Sincronizar Saldos").
 * @param {Object} base44 - Cliente base44
 * @param {Function} onProgress - (message: string) => void - Callback para actualizar UI
 * @returns {Promise<{ proveedoresActualizados: number, clientesActualizados: number }>}
 */
export async function sincronizarSaldosEntidades(base44, onProgress = () => {}) {
  onProgress('Iniciando sincronizaci√≥n de saldos...');

  const fetchProveedores = (skip) =>
    base44.entities.Proveedor.list('nombre', LOTE_ENTIDADES, skip);
  const fetchClientes = (skip) =>
    base44.entities.Cliente.list('nombre', LOTE_ENTIDADES, skip);

  const proveedores = await obtenerTodosPaginado(fetchProveedores, 'proveedores', onProgress);
  onProgress(`Se obtuvieron ${proveedores.length} proveedores. Procesando uno por uno...`);
  await delay(DELAY_ENTRE_LOTES_MS);

  let proveedoresActualizados = 0;
  let index = 0;
  for (const proveedor of proveedores) {
    index++;
    onProgress(`Procesando Proveedor ${index} de ${proveedores.length}: ${proveedor.nombre || proveedor.id}...`);
    const movimientos = await obtenerMovimientosEntidadPaginado(
      base44,
      'Proveedor',
      proveedor.id,
      proveedor.nombre || proveedor.id,
      onProgress
    );
    const saldoReal = calcularSaldoDesdeMovimientos(movimientos);
    await base44.entities.Proveedor.update(proveedor.id, { saldo_actual: saldoReal });
    proveedoresActualizados++;
    await delay(DELAY_ENTRE_ENTIDADES_MS);
  }

  onProgress(`Proveedores listos. Obteniendo clientes...`);
  const clientes = await obtenerTodosPaginado(fetchClientes, 'clientes', onProgress);
  onProgress(`Se obtuvieron ${clientes.length} clientes. Procesando uno por uno...`);
  await delay(DELAY_ENTRE_LOTES_MS);

  let clientesActualizados = 0;
  index = 0;
  for (const cliente of clientes) {
    index++;
    onProgress(`Procesando Cliente ${index} de ${clientes.length}: ${cliente.nombre || cliente.id}...`);
    const movimientos = await obtenerMovimientosEntidadPaginado(
      base44,
      'Cliente',
      cliente.id,
      cliente.nombre || cliente.id,
      onProgress
    );
    const saldoReal = calcularSaldoDesdeMovimientos(movimientos);
    await base44.entities.Cliente.update(cliente.id, { saldo_actual: saldoReal });
    clientesActualizados++;
    await delay(DELAY_ENTRE_ENTIDADES_MS);
  }

  onProgress('¬°Sincronizaci√≥n completada con √©xito!');
  return { proveedoresActualizados, clientesActualizados };
}
</file>

<file path="src/utils/ejecutarCorreccionManual.js">
import { correccionRetroactivaPerdidas } from '@/components/utils/correccionRetroactivaPerdidas';
import { correccionRetroactivaEnvases } from '@/components/utils/correccionRetroactivaEnvases';
import { obtenerPrecioVigente } from '@/utils/precioVigente';

// Funci√≥n para ejecutar correcciones manualmente
export async function ejecutarCorreccionManual(tipo, base44, queryClient) {
  // Resetear flags de localStorage para permitir re-ejecuci√≥n
  const resetFlags = () => {
    switch(tipo) {
      case 'autoRetroactiva':
        localStorage.removeItem('acopio_correccion_perdidas_v1_ejecutada');
        localStorage.removeItem('acopio_correccion_perdidas_v1_ejecutada_fecha');
        localStorage.removeItem('acopio_correccion_perdidas_v1_ejecutada_resultado');
        break;
      case 'envasesRetroactiva':
        localStorage.removeItem('correccion_envases_retroactiva_v4');
        break;
      case 'segregacionEnvases':
        localStorage.removeItem('correccion_segregacion_envases_ejecutada_v1');
        break;
      case 'cuentaCorriente':
        localStorage.removeItem('correccion_cuenta_corriente_completa_v2');
        break;
      case 'preciosSalidas':
        localStorage.removeItem('correccion_precios_salidas_v1');
        break;
    }
  };

  resetFlags();

  switch(tipo) {
    case 'autoRetroactiva': {
      const [resultadoPerdidas, resultadoEnvases] = await Promise.all([
        correccionRetroactivaPerdidas(base44),
        correccionRetroactivaEnvases(base44)
      ]);
      queryClient.invalidateQueries({ queryKey: ['productos'] });
      queryClient.invalidateQueries({ queryKey: ['movimientos'] });
      queryClient.invalidateQueries({ queryKey: ['salidas'] });
      queryClient.invalidateQueries({ queryKey: ['envases'] });
      return { resultadoPerdidas, resultadoEnvases };
    }
    case 'envasesRetroactiva': {
      const resultado = await correccionRetroactivaEnvases(base44);
      queryClient.invalidateQueries({ queryKey: ['envases'] });
      queryClient.invalidateQueries({ queryKey: ['movimientos'] });
      queryClient.invalidateQueries({ queryKey: ['salidas'] });
      return resultado;
    }
    case 'segregacionEnvases': {
      // Esta correcci√≥n requiere ejecutar la l√≥gica del hook manualmente
      const [envases, movimientos, salidas] = await Promise.all([
        base44.entities.Envase.list(),
        base44.entities.Movimiento.list(),
        base44.entities.SalidaFruta.list()
      ]);

      const stocksRecalculados = {};
      envases.forEach(env => {
        stocksRecalculados[env.id] = { tipo: env.tipo, ocupados: 0, vacios: 0 };
      });

      const todosLosRegistros = [
        ...movimientos.map(m => ({ ...m, tipo_registro: 'movimiento', fecha: new Date(m.fecha) })),
        ...salidas.map(s => ({ ...s, tipo_registro: 'salida', fecha: new Date(s.fecha) }))
      ].sort((a, b) => a.fecha - b.fecha);

      todosLosRegistros.forEach((registro) => {
        if (registro.tipo_registro === 'movimiento') {
          if (registro.tipo_movimiento === 'Ingreso de Fruta') {
            const cantLlenos = parseInt(registro.cantidad_envases_llenos) || 0;
            if (cantLlenos > 0) {
              const envasesUsados = {};
              registro.pesajes?.forEach(p => {
                if (p.envase_id) {
                  envasesUsados[p.envase_id] = (envasesUsados[p.envase_id] || 0) + (p.cantidad || 1);
                }
              });
              const totalUnidades = Object.values(envasesUsados).reduce((sum, cant) => sum + cant, 0);
              if (totalUnidades > 0) {
                Object.entries(envasesUsados).forEach(([envaseId, unidades]) => {
                  if (stocksRecalculados[envaseId]) {
                    const proporcion = unidades / totalUnidades;
                    const asignados = Math.round(cantLlenos * proporcion);
                    stocksRecalculados[envaseId].ocupados += asignados;
                  }
                });
              }
            }
          } else if (registro.tipo_movimiento === 'Movimiento de Envases') {
            registro.movimiento_envases?.forEach(mv => {
              if (stocksRecalculados[mv.envase_id]) {
                const ingreso = parseInt(mv.cantidad_ingreso) || 0;
                const salida = parseInt(mv.cantidad_salida) || 0;
                stocksRecalculados[mv.envase_id].vacios += ingreso - salida;
              }
            });
          }
        } else if (registro.tipo_registro === 'salida') {
          const cantLlenos = parseInt(registro.cantidad_envases_llenos) || 0;
          if (cantLlenos > 0 && envases[0] && stocksRecalculados[envases[0].id]) {
            stocksRecalculados[envases[0].id].ocupados -= cantLlenos;
          }
        }
      });

      let corregidos = 0;
      for (const envase of envases) {
        const recalculado = stocksRecalculados[envase.id];
        const stockOcupadosActual = parseInt(envase.stock_ocupados) || 0;
        const stockVaciosActual = parseInt(envase.stock_vacios) || 0;
        const nuevoOcupados = Math.max(0, recalculado.ocupados);
        const nuevoVacios = Math.max(0, recalculado.vacios);

        if (stockOcupadosActual !== nuevoOcupados || stockVaciosActual !== nuevoVacios) {
          await base44.entities.Envase.update(envase.id, {
            stock_ocupados: nuevoOcupados,
            stock_vacios: nuevoVacios
          });
          corregidos++;
        }
      }

      queryClient.invalidateQueries(['envases']);
      queryClient.invalidateQueries(['movimientos']);
      queryClient.invalidateQueries(['salidas']);
      return { corregidos, total: envases.length };
    }
    case 'cuentaCorriente': {
      const [movimientos, salidas, periodosPrecios] = await Promise.all([
        base44.entities.Movimiento.list('-created_date', 1000),
        base44.entities.SalidaFruta.list('-created_date', 1000),
        base44.entities.PeriodoPrecio.list('-created_date', 100)
      ]);

      // Usar funci√≥n utilitaria centralizada
      const obtenerPrecio = (productoId, fecha, tipoPrecio) => 
        obtenerPrecioVigente(periodosPrecios, productoId, fecha, tipoPrecio);

      let ingresosActualizados = 0;
      let salidasActualizadas = 0;

      // Procesar ingresos
      for (const movimiento of movimientos) {
        if (movimiento.tipo_movimiento === 'Ingreso de Fruta' && movimiento.pesajes && movimiento.pesajes.length > 0) {
          if (movimiento.deuda_total && movimiento.deuda_total > 0) continue;

          let deudaTotal = 0;
          movimiento.pesajes.forEach(pesaje => {
            const precioCompra = obtenerPrecio(pesaje.producto_id, movimiento.fecha, 'compra');
            deudaTotal += pesaje.peso_neto * precioCompra;
          });

          await base44.entities.Movimiento.update(movimiento.id, {
            deuda_total: deudaTotal,
            estado_pago: movimiento.estado_pago || 'Pendiente',
            monto_pagado: movimiento.monto_pagado || 0
          });
          ingresosActualizados++;
        }
      }

      // Procesar salidas
      for (const salida of salidas) {
        if (salida.estado === 'Confirmada' && salida.detalles && salida.detalles.length > 0) {
          if (salida.deuda_total && salida.deuda_total > 0) continue;

          let deudaTotal = 0;
          salida.detalles.forEach(detalle => {
            const kilosEfectivos = (detalle.kilos_reales || detalle.kilos_salida || 0) - (detalle.descuento_kg || 0);
            const precioVenta = detalle.precio_kg || obtenerPrecio(detalle.producto_id, salida.fecha, 'venta');
            deudaTotal += kilosEfectivos * precioVenta;
          });

          await base44.entities.SalidaFruta.update(salida.id, {
            deuda_total: deudaTotal,
            estado_cobro: salida.estado_cobro || 'Pendiente',
            monto_cobrado: salida.monto_cobrado || 0
          });
          salidasActualizadas++;
        }
      }

      // Crear movimientos de cuenta corriente
      const movimientosCC = await base44.entities.CuentaCorriente.list();
      let movimientosCCCreados = 0;

      for (const movimiento of movimientos.filter(m => m.tipo_movimiento === 'Ingreso de Fruta')) {
        if (!movimiento.proveedor_id || !movimiento.deuda_total || movimiento.deuda_total <= 0) continue;
        const yaExiste = movimientosCC.some(cc => cc.comprobante_tipo === 'IngresoFruta' && cc.comprobante_id === movimiento.id);
        if (!yaExiste) {
          await base44.entities.CuentaCorriente.create({
            fecha: movimiento.fecha,
            tipo_movimiento: 'Haber',
            entidad_tipo: 'Proveedor',
            entidad_id: movimiento.proveedor_id,
            entidad_nombre: movimiento.proveedor_nombre,
            monto: movimiento.deuda_total,
            saldo_resultante: 0,
            concepto: `Ingreso de fruta - ${new Date(movimiento.fecha).toLocaleDateString('es-AR')}`,
            comprobante_id: movimiento.id,
            comprobante_tipo: 'IngresoFruta'
          });
          movimientosCCCreados++;
        }
      }

      for (const salida of salidas) {
        if (!salida.cliente_id || !salida.deuda_total || salida.deuda_total <= 0) continue;
        const yaExiste = movimientosCC.some(cc => cc.comprobante_tipo === 'SalidaFruta' && cc.comprobante_id === salida.id);
        if (!yaExiste) {
          await base44.entities.CuentaCorriente.create({
            fecha: salida.fecha,
            tipo_movimiento: 'Haber',
            entidad_tipo: 'Cliente',
            entidad_id: salida.cliente_id,
            entidad_nombre: salida.cliente_nombre,
            monto: salida.deuda_total,
            saldo_resultante: 0,
            concepto: `Salida de fruta - ${salida.numero_remito}`,
            comprobante_id: salida.id,
            comprobante_tipo: 'SalidaFruta'
          });
          movimientosCCCreados++;
        }
      }

      // Recalcular saldos
      const todosLosMovCC = await base44.entities.CuentaCorriente.list();
      const porEntidad = {};
      todosLosMovCC.forEach(mov => {
        const key = `${mov.entidad_tipo}-${mov.entidad_id}`;
        if (!porEntidad[key]) porEntidad[key] = [];
        porEntidad[key].push(mov);
      });

      for (const [key, movs] of Object.entries(porEntidad)) {
        const movsOrdenados = movs.sort((a, b) => new Date(a.fecha).getTime() - new Date(b.fecha).getTime());
        let saldoAcumulado = 0;
        for (const mov of movsOrdenados) {
          const monto = Number(mov.monto) || 0;
          saldoAcumulado += mov.tipo_movimiento === 'Haber' ? monto : -monto;
          await base44.entities.CuentaCorriente.update(mov.id, { saldo_resultante: saldoAcumulado });
        }
      }

      queryClient.invalidateQueries(['movimientos']);
      queryClient.invalidateQueries(['salidas']);
      queryClient.invalidateQueries(['cuentacorriente']);
      return { ingresosActualizados, salidasActualizadas, movimientosCCCreados };
    }
    case 'preciosSalidas': {
      const [salidas, periodosPrecios] = await Promise.all([
        base44.entities.SalidaFruta.list('-created_date', 1000),
        base44.entities.PeriodoPrecio.list('-created_date', 100)
      ]);

      // Usar funci√≥n utilitaria centralizada
      const obtenerPrecio = (productoId, fecha) => 
        obtenerPrecioVigente(periodosPrecios, productoId, fecha, 'venta');

      let salidasActualizadas = 0;
      let movimientosCCActualizados = 0;

      const salidasConfirmadas = salidas.filter(s => s.estado === 'Confirmada');

      for (const salida of salidasConfirmadas) {
        if (!salida.detalles || salida.detalles.length === 0) continue;

        let deudaTotalNueva = 0;
        let necesitaActualizacion = false;
        
        const detallesActualizados = salida.detalles.map(d => {
          const precioVigente = obtenerPrecio(d.producto_id, salida.fecha);
          const kilosEfectivos = (d.kilos_reales || d.kilos_salida) - (d.descuento_kg || 0);
          const deuda = kilosEfectivos * precioVigente;
          deudaTotalNueva += deuda;

          if (d.precio_kg !== precioVigente) {
            necesitaActualizacion = true;
          }

          return { ...d, precio_kg: precioVigente };
        });

        if (necesitaActualizacion || salida.deuda_total !== deudaTotalNueva) {
          await base44.entities.SalidaFruta.update(salida.id, {
            detalles: detallesActualizados,
            deuda_total: deudaTotalNueva
          });
          salidasActualizadas++;

          const movimientosCC = await base44.entities.CuentaCorriente.filter({
            comprobante_tipo: 'SalidaFruta',
            comprobante_id: salida.id
          });

          if (movimientosCC.length > 0) {
            const movCC = movimientosCC[0];
            const diferencia = deudaTotalNueva - (movCC.monto || 0);
            
            if (Math.abs(diferencia) > 0.01) {
              await base44.entities.CuentaCorriente.update(movCC.id, {
                monto: deudaTotalNueva,
                saldo_resultante: (movCC.saldo_resultante || 0) + diferencia
              });
              movimientosCCActualizados++;
            }
          }
        }
      }

      queryClient.invalidateQueries(['salidas']);
      queryClient.invalidateQueries(['cuentacorriente']);
      return { salidasActualizadas, movimientosCCActualizados };
    }
    default:
      throw new Error(`Tipo de correcci√≥n desconocido: ${tipo}`);
  }
}
</file>

<file path="src/utils/extraerMensajeError.js">
// Funci√≥n helper para extraer mensajes de error descriptivos
export function extraerMensajeError(error, tipoOperacion = 'operaci√≥n') {
  if (!error) return `Error al realizar ${tipoOperacion}`;
  
  const mensaje = error.message || error.toString() || '';
  
  // Errores comunes de base44
  if (mensaje.includes('duplicate') || mensaje.includes('unique') || mensaje.includes('ya existe')) {
    if (mensaje.includes('cuit') || mensaje.includes('CUIT')) {
      return 'El CUIT ya existe en el sistema';
    }
    if (mensaje.includes('nombre') || mensaje.includes('name')) {
      return 'Ya existe un registro con ese nombre';
    }
    if (mensaje.includes('email')) {
      return 'El email ya est√° registrado';
    }
    return 'Ya existe un registro con estos datos';
  }
  
  if (mensaje.includes('required') || mensaje.includes('obligatorio') || mensaje.includes('faltan')) {
    return 'Faltan campos obligatorios. Verifique que todos los campos requeridos est√©n completos';
  }
  
  if (mensaje.includes('foreign key') || mensaje.includes('constraint') || mensaje.includes('asociado')) {
    return 'No se puede eliminar: este registro tiene movimientos o datos asociados';
  }
  
  if (mensaje.includes('stock') || mensaje.includes('insuficiente')) {
    return 'Stock insuficiente para realizar esta operaci√≥n';
  }
  
  if (mensaje.includes('validation') || mensaje.includes('validaci√≥n')) {
    return 'Los datos ingresados no son v√°lidos. Verifique el formato';
  }
  
  // Si el mensaje es descriptivo, usarlo directamente
  if (mensaje.length > 0 && mensaje.length < 200) {
    return mensaje;
  }
  
  return `Error al realizar ${tipoOperacion}. Intente nuevamente`;
}
</file>

<file path="src/utils/index.js">
export function createPageUrl(pageName) {
    return '/' + pageName.replace(/ /g, '-');
}
</file>

<file path="src/utils/index.ts">
export function createPageUrl(pageName: string) {
    return '/' + pageName.replace(/ /g, '-');
}
</file>

<file path="src/utils/parseCSV.js">
/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * UTILIDAD: PARSER DE CSV ROBUSTO
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Parsea l√≠neas CSV soportando comas dentro de celdas entre comillas.
 * Maneja correctamente:
 * - Comas dentro de celdas entre comillas dobles
 * - Comillas escapadas dentro de celdas
 * - Celdas sin comillas
 * 
 * @param {string} line - L√≠nea CSV a parsear
 * @returns {Array<string>} - Array de valores parseados
 */
export function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];
    
    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        // Comilla escapada dentro de comillas
        current += '"';
        i++; // Saltar la siguiente comilla
      } else {
        // Toggle de estado de comillas
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      // Coma fuera de comillas = separador de campo
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  // Agregar el √∫ltimo campo
  result.push(current.trim());
  
  return result;
}
</file>

<file path="src/utils/pdfStyles.js">
/**
 * Estilos comunes y configuraci√≥n para los generadores de PDF
 */

// URL del logo de la empresa
export const LOGO_URL = "https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/694c069ad9a3c71a10fee653/2db155312_imagenesdeperfilISO_Mesadetrabajo1.jpg";

// HTML del logo
export const getLogoHTML = (size = 80) => `
  <div class="logo">
    <img src="${LOGO_URL}" 
         alt="Logo" 
         style="width: ${size}px; height: ${size}px; object-fit: contain; margin: 0 auto;">
  </div>
`;

// Estilos base comunes
export const getBaseStyles = () => `
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Arial, sans-serif; 
    font-size: 12px; 
    color: #333;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }
`;

// Estilos de header com√∫n
export const getHeaderStyles = (primaryColor = '#22c55e', titleColor = '#166534') => `
  .header { 
    text-align: center; 
    padding: 20px 0; 
    border-bottom: 3px solid ${primaryColor};
    margin-bottom: 20px;
  }
  .logo { 
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
  }
  .title { 
    font-size: 24px; 
    font-weight: bold; 
    color: ${titleColor};
    margin-bottom: 5px;
  }
  .subtitle { 
    font-size: 16px; 
    color: #666;
  }
`;

// Estilos de info-grid com√∫n
export const getInfoGridStyles = (bgColor = '#f0fdf4', textColor = '#166534') => `
  .info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: ${bgColor};
    border-radius: 8px;
  }
  .info-item label {
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
  }
  .info-item p {
    font-size: 14px;
    font-weight: 600;
    color: ${textColor};
  }
`;

// Estilos de secci√≥n com√∫n
export const getSectionStyles = (borderColor = '#bbf7d0', titleColor = '#166534') => `
  .section { margin-bottom: 20px; }
  .section h3 { 
    font-size: 14px; 
    color: ${titleColor}; 
    border-bottom: 2px solid ${borderColor};
    padding-bottom: 5px;
    margin-bottom: 10px;
  }
`;

// Estilos de tabla com√∫n
export const getTableStyles = (headerBg = '#f0fdf4', headerColor = '#166534') => `
  table { 
    width: 100%; 
    border-collapse: collapse;
    font-size: 11px;
  }
  th, td { 
    padding: 8px 10px; 
    text-align: left; 
    border-bottom: 1px solid #e5e7eb;
  }
  th { 
    background: ${headerBg}; 
    font-weight: 600;
    color: ${headerColor};
  }
  .text-right { text-align: right; }
  .total-row { 
    background: #dcfce7; 
    font-weight: bold;
  }
`;

// Estilos de colores comunes
export const getColorStyles = () => `
  .ingreso { color: #16a34a; font-weight: 600; }
  .salida { color: #dc2626; font-weight: 600; }
  .ocupado { color: #f59e0b; font-weight: 600; }
  .vacio { color: #3b82f6; font-weight: 600; }
  .adeuda { color: #dc2626; font-weight: bold; }
  .ok { color: #16a34a; }
`;

// Estilos de footer com√∫n
export const getFooterStyles = () => `
  .footer {
    margin-top: 30px;
    padding-top: 15px;
    border-top: 1px solid #e5e7eb;
    text-align: center;
    font-size: 10px;
    color: #666;
  }
`;

// Estilos de impresi√≥n com√∫n
export const getPrintStyles = () => `
  @media print {
    body { padding: 10px; }
    .section { page-break-inside: avoid; }
  }
`;

// Funci√≥n para obtener estilos completos con tema personalizado
export const getCompleteStyles = (theme = {}) => {
  const {
    primaryColor = '#22c55e',
    titleColor = '#166534',
    bgColor = '#f0fdf4',
    borderColor = '#bbf7d0',
    headerBg = '#f0fdf4',
    headerColor = '#166534'
  } = theme;

  return `
    ${getBaseStyles()}
    ${getHeaderStyles(primaryColor, titleColor)}
    ${getInfoGridStyles(bgColor, titleColor)}
    ${getSectionStyles(borderColor, titleColor)}
    ${getTableStyles(headerBg, headerColor)}
    ${getColorStyles()}
    ${getFooterStyles()}
    ${getPrintStyles()}
  `;
};

// Temas predefinidos
export const themes = {
  default: {
    primaryColor: '#22c55e',
    titleColor: '#166534',
    bgColor: '#f0fdf4',
    borderColor: '#bbf7d0',
    headerBg: '#f0fdf4',
    headerColor: '#166534'
  },
  purple: {
    primaryColor: '#9333ea',
    titleColor: '#6b21a8',
    bgColor: '#faf5ff',
    borderColor: '#e9d5ff',
    headerBg: '#faf5ff',
    headerColor: '#6b21a8'
  },
  blue: {
    primaryColor: '#6366f1',
    titleColor: '#4338ca',
    bgColor: '#f0f9ff',
    borderColor: '#bfdbfe',
    headerBg: '#dbeafe',
    headerColor: '#1e40af'
  }
};

// Estilos comunes como string (tema por defecto) para uso directo en <style>
export const commonPdfStyles = getCompleteStyles(themes.default);
</file>

<file path="src/utils/precioVigente.js">
/**
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * UTILIDAD: OBTENER PRECIO VIGENTE SEG√öN FECHA
 * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 * 
 * Funci√≥n centralizada para calcular el precio vigente de un producto
 * en una fecha espec√≠fica, evitando duplicaci√≥n de l√≥gica.
 * 
 * @param {Array} periodosPrecios - Array de per√≠odos de precios
 * @param {string} productoId - ID del producto
 * @param {string|Date} fecha - Fecha para la cual obtener el precio
 * @param {string} tipoPrecio - 'compra' o 'venta' (default: 'compra')
 * @returns {number} - Precio vigente o 0 si no se encuentra
 */
export function obtenerPrecioVigente(periodosPrecios, productoId, fecha, tipoPrecio = 'compra') {
  if (!productoId || !fecha || !periodosPrecios || periodosPrecios.length === 0) {
    return 0;
  }

  // Filtrar precios activos del producto y ordenar por fecha descendente
  const preciosOrdenados = periodosPrecios
    .filter(pp => pp.producto_id === productoId && pp.activo)
    .sort((a, b) => new Date(b.fecha_desde) - new Date(a.fecha_desde));
  
  if (preciosOrdenados.length === 0) {
    return 0;
  }

  const fechaConsulta = new Date(fecha);
  
  // Buscar precio vigente (fecha_desde <= fecha consulta)
  const precioVigente = preciosOrdenados.find(pp => {
    const fechaDesde = new Date(pp.fecha_desde);
    
    // Si tiene fecha_hasta, verificar que la fecha est√© en el rango
    if (pp.fecha_hasta) {
      const fechaHasta = new Date(pp.fecha_hasta);
      return fechaConsulta >= fechaDesde && fechaConsulta <= fechaHasta;
    }
    
    // Si no tiene fecha_hasta, solo verificar que fecha_desde <= fecha consulta
    return fechaConsulta >= fechaDesde;
  });
  
  // Si se encontr√≥ precio vigente, retornarlo
  if (precioVigente) {
    return tipoPrecio === 'compra' 
      ? (precioVigente.precio_compra_kg || 0)
      : (precioVigente.precio_venta_kg || 0);
  }
  
  // Si no hay precio vigente, usar el m√°s reciente disponible
  const precioMasReciente = preciosOrdenados[0];
  if (precioMasReciente) {
    return tipoPrecio === 'compra'
      ? (precioMasReciente.precio_compra_kg || 0)
      : (precioMasReciente.precio_venta_kg || 0);
  }
  
  return 0;
}
</file>

<file path="src/utils/queryHelpers.js">
/**
 * Utilidades para gesti√≥n de queries y cache de React Query
 */

/**
 * Invalida todas las queries cr√≠ticas del sistema para asegurar consistencia de datos
 * √ötil despu√©s de operaciones de creaci√≥n, edici√≥n o borrado que afectan m√∫ltiples entidades
 * 
 * @param {Object} queryClient - Instancia de QueryClient de React Query
 */
export function invalidarTodoElSistema(queryClient) {
  if (!queryClient) {
    console.warn('invalidarTodoElSistema: queryClient no proporcionado');
    return;
  }

  // Invalidar queries cr√≠ticas del sistema
  queryClient.invalidateQueries({ queryKey: ['movimientos'] });
  queryClient.invalidateQueries({ queryKey: ['movimientos-infinite'] });
  queryClient.invalidateQueries({ queryKey: ['salidas'] });
  queryClient.invalidateQueries({ queryKey: ['salidas-infinite'] });
  queryClient.invalidateQueries({ queryKey: ['cuentacorriente'] });
  queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
  queryClient.invalidateQueries({ queryKey: ['productos'] });
  queryClient.invalidateQueries({ queryKey: ['envases'] });
  queryClient.invalidateQueries({ queryKey: ['cobros'] });
  queryClient.invalidateQueries({ queryKey: ['cobros-infinite'] });
  queryClient.invalidateQueries({ queryKey: ['pagos'] });
  queryClient.invalidateQueries({ queryKey: ['pagos-infinite'] });
  queryClient.invalidateQueries({ queryKey: ['proveedores'] });
  queryClient.invalidateQueries({ queryKey: ['clientes'] });
  queryClient.invalidateQueries({ queryKey: ['fleteros'] });
  queryClient.invalidateQueries({ queryKey: ['cajas'] });
  queryClient.invalidateQueries({ queryKey: ['bancos'] });
  queryClient.invalidateQueries({ queryKey: ['cheques'] });
}

/**
 * Invalida queries relacionadas con movimientos y salidas
 * √ötil despu√©s de operaciones que afectan el historial
 * 
 * @param {Object} queryClient - Instancia de QueryClient de React Query
 */
export function invalidarMovimientos(queryClient) {
  if (!queryClient) return;
  
  queryClient.invalidateQueries({ queryKey: ['movimientos'] });
  queryClient.invalidateQueries({ queryKey: ['movimientos-infinite'] });
  queryClient.invalidateQueries({ queryKey: ['salidas'] });
  queryClient.invalidateQueries({ queryKey: ['salidas-infinite'] });
  queryClient.invalidateQueries({ queryKey: ['productos'] });
  queryClient.invalidateQueries({ queryKey: ['envases'] });
  queryClient.invalidateQueries({ queryKey: ['cuentacorriente'] });
}

/**
 * Invalida queries relacionadas con tesorer√≠a
 * √ötil despu√©s de operaciones financieras
 * 
 * @param {Object} queryClient - Instancia de QueryClient de React Query
 */
export function invalidarTesoreria(queryClient) {
  if (!queryClient) return;
  
  queryClient.invalidateQueries({ queryKey: ['cobros'] });
  queryClient.invalidateQueries({ queryKey: ['pagos'] });
  queryClient.invalidateQueries({ queryKey: ['movimientostesoreria'] });
  queryClient.invalidateQueries({ queryKey: ['cuentacorriente'] });
  queryClient.invalidateQueries({ queryKey: ['cajas'] });
  queryClient.invalidateQueries({ queryKey: ['bancos'] });
  queryClient.invalidateQueries({ queryKey: ['cheques'] });
}
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
    darkMode: ["class"],
    content: ["./index.html", "./src/**/*.{ts,tsx,js,jsx}"],
  theme: {
  	extend: {
  		borderRadius: {
  			lg: 'var(--radius)',
  			md: 'calc(var(--radius) - 2px)',
  			sm: 'calc(var(--radius) - 4px)'
  		},
  		colors: {
  			background: 'hsl(var(--background))',
  			foreground: 'hsl(var(--foreground))',
  			card: {
  				DEFAULT: 'hsl(var(--card))',
  				foreground: 'hsl(var(--card-foreground))'
  			},
  			popover: {
  				DEFAULT: 'hsl(var(--popover))',
  				foreground: 'hsl(var(--popover-foreground))'
  			},
  			primary: {
  				DEFAULT: 'hsl(var(--primary))',
  				foreground: 'hsl(var(--primary-foreground))'
  			},
  			secondary: {
  				DEFAULT: 'hsl(var(--secondary))',
  				foreground: 'hsl(var(--secondary-foreground))'
  			},
  			muted: {
  				DEFAULT: 'hsl(var(--muted))',
  				foreground: 'hsl(var(--muted-foreground))'
  			},
  			accent: {
  				DEFAULT: 'hsl(var(--accent))',
  				foreground: 'hsl(var(--accent-foreground))'
  			},
  			destructive: {
  				DEFAULT: 'hsl(var(--destructive))',
  				foreground: 'hsl(var(--destructive-foreground))'
  			},
  			border: 'hsl(var(--border))',
  			input: 'hsl(var(--input))',
  			ring: 'hsl(var(--ring))',
  			chart: {
  				'1': 'hsl(var(--chart-1))',
  				'2': 'hsl(var(--chart-2))',
  				'3': 'hsl(var(--chart-3))',
  				'4': 'hsl(var(--chart-4))',
  				'5': 'hsl(var(--chart-5))'
  			},
  			sidebar: {
  				DEFAULT: 'hsl(var(--sidebar-background))',
  				foreground: 'hsl(var(--sidebar-foreground))',
  				primary: 'hsl(var(--sidebar-primary))',
  				'primary-foreground': 'hsl(var(--sidebar-primary-foreground))',
  				accent: 'hsl(var(--sidebar-accent))',
  				'accent-foreground': 'hsl(var(--sidebar-accent-foreground))',
  				border: 'hsl(var(--sidebar-border))',
  				ring: 'hsl(var(--sidebar-ring))'
  			}
  		},
  		keyframes: {
  			'accordion-down': {
  				from: {
  					height: '0'
  				},
  				to: {
  					height: 'var(--radix-accordion-content-height)'
  				}
  			},
  			'accordion-up': {
  				from: {
  					height: 'var(--radix-accordion-content-height)'
  				},
  				to: {
  					height: '0'
  				}
  			}
  		},
  		animation: {
  			'accordion-down': 'accordion-down 0.2s ease-out',
  			'accordion-up': 'accordion-up 0.2s ease-out'
  		}
  	}
  },
  plugins: [require("tailwindcss-animate")],
}
</file>

<file path="vite.config.js">
import base44 from "@base44/vite-plugin"
import react from '@vitejs/plugin-react'
import { defineConfig } from 'vite'

// https://vite.dev/config/
export default defineConfig({
  base: './', // Resuelve 404 de assets en producci√≥n (rutas relativas)
  logLevel: 'error', // Suppress warnings, only show errors
  plugins: [
    base44({
      // Support for legacy code that imports the base44 SDK with @/integrations, @/entities, etc.
      // can be removed if the code has been updated to use the new SDK imports from @base44/sdk
      legacySDKImports: process.env.BASE44_LEGACY_SDK_IMPORTS === 'true',
      hmrNotifier: true,
      navigationNotifier: true,
      visualEditAgent: true
    }),
    react(),
  ]
});
</file>

</files>
